import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{r as I}from"./index-BH53Isel.js";import"./EditorLayout-B4bUL1bb.js";import"./thumbnailGenerator-B4goYG9Y.js";import"./EditorMain-_pvTHO57.js";import{M as U}from"./PaymentModal-Bxx5p2o_.js";import{H as se,E as K}from"./jspdf.es.min-DsE6j1uk.js";import{G as O}from"./Global-ErywZRdd.js";import{X as Y}from"./x-DBMwyD6F.js";import{C as le}from"./chevron-left-B2s3ZsB7.js";import{C as ce}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./preload-helper-BfFHrpNk.js";import"./typeof-QjJsDpFa.js";import"./createLucideIcon-Cy5Ya80P.js";const Q={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},de=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;U.setAppElement("#app");const Ae=({isOpen:x,onRequestClose:k,pages:f,pageThumbnails:w={},addAlbumToCart:$,workspaceDimensions:C={width:800,height:600},layouts:z=[],presetData:R=null,projectData:me=null,itemData:y=null})=>{const[M,q]=I.useState(0),[S,W]=I.useState(!1),[J,F]=I.useState({}),[D,Z]=I.useState(!1),A=I.useRef();function ee(e,a,c,o,u,l){const r=a.width,n=a.height,s=u/l,d=r/n;let g=0,b=0,m=r,i=n;s>d?(i=r/s,b=(n-i)/2):(m=n*s,g=(r-m)/2),e.drawImage(a,g,b,m,i,c,o,u,l)}function te(e){const a=e.match(/grid-cols-(\d+)/),c=e.match(/grid-rows-(\d+)/),o=e.match(/gap-(\d+)/);return{cols:a?parseInt(a[1],10):1,rows:c?parseInt(c[1],10):1,gap:o?parseInt(o[1],10)*4:0}}function X(e,a,c=1){const o=e&&e.match(new RegExp(`${a}-span-(\\d+)`));return o?parseInt(o[1],10):c}function re(e,a,c){const{cols:o,rows:u,gap:l}=te(e.template),r=e.style&&e.style.padding?parseInt(e.style.padding):0,n=a.width-2*r,s=a.height-2*r,d=(n-l*(o-1))/o,g=(s-l*(u-1))/u,b=Array.from({length:u},()=>Array(o).fill(!1)),m={};for(let i=0;i<e.cells;i++){const v=e.cellStyles&&e.cellStyles[i]?e.cellStyles[i]:"",j=X(v,"col",1),h=X(v,"row",1);let P=!1;for(let p=0;p<=u-h&&!P;p++)for(let E=0;E<=o-j&&!P;E++){let V=!0;for(let N=p;N<p+h;N++){for(let _=E;_<E+j;_++)if(b[N][_]){V=!1;break}if(!V)break}if(V){for(let _=p;_<p+h;_++)for(let G=E;G<E+j;G++)b[_][G]=!0;const N=c&&c[i]?c[i].id:i;m[N]={x:r+E*(d+l),y:r+p*(g+l),width:d*j+l*(j-1),height:g*h+l*(h-1)},console.log(`[GRID-PLACEMENT] cellId:${N} col-span:${j} row-span:${h} => x:${m[N].x} y:${m[N].y} w:${m[N].width} h:${m[N].height}`),P=!0}}if(!P){const p=c&&c[i]?c[i].id:i;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${p}`),m[p]={x:0,y:0,width:d,height:g}}}return m}const oe=I.useCallback(async()=>{if(!f||f.length===0||!x)return;console.log("ðŸš€ Iniciando generaciÃ³n de thumbnails para BookPreview..."),Z(!0),F({});const e={},a=4,c=(r,n,s,d)=>{if(!n||!n.image)return;const g=new Image;g.src=n.image,g.onload=()=>{const b=s.x+n.x*d,m=s.y+n.y*d,i=n.width*d,v=n.height*d;ee(r,g,b,m,i,v)}},o=async(r,n)=>{const s=document.createElement("canvas"),d=s.getContext("2d");if(s.width=C.width*a,s.height=C.height*a,R&&R.final_layer_image){const i=new Image;i.src=R.final_layer_image,i.onload=()=>{d.drawImage(i,0,0,s.width,s.height)}}const g=z.find(i=>i.id===r.layoutId);if(!g)return;const b=re(g,C,r.cells);r.cells.forEach(i=>{const v=b[i.id];v&&i.elements.forEach(j=>{c(d,j,v,a)})});const m=s.toDataURL("image/jpeg",.9);return{[n]:m}},u=f.map((r,n)=>o(r,n));(await Promise.all(u)).forEach(r=>{Object.assign(e,r)}),F(e),Z(!1)},[f,x,C,z,R]);I.useEffect(()=>{x&&(Object.keys(w).length===0?oe():F(w))},[x,w]),I.useEffect(()=>{x||F({})},[x]);const B=Object.keys(w).length>0?w:J;if(!f||!Array.isArray(f)||f.length===0)return t.jsx(U,{isOpen:x,onRequestClose:k,style:Q,contentLabel:"Vista previa del Ã¡lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:t.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del Ã¡lbum"}),t.jsx("button",{onClick:k,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:t.jsx(Y,{size:24})})]}),t.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay pÃ¡ginas disponibles para mostrar."})]})});const ae=()=>{A.current&&A.current.pageFlip().flipPrev()},ne=()=>{A.current&&A.current.pageFlip().flipNext()},ie=C.width/C.height,T=600,L=Math.round(T*ie),H=(()=>{const e=[],a=[...f.filter(o=>o.type==="cover"),...f.filter(o=>o.type==="content"),...f.filter(o=>o.type==="final")];a.length>0&&(e.push(a[0]),e.push({...a[0],isBack:!0}));for(let o=1;o<a.length-1;o++)e.push(a[o]),o+1<a.length-1?(e.push(a[o+1]),o++):e.push({...a[o],isBack:!0,isEmpty:!0});const c=a.find(o=>o.type==="final");return c&&(e.push({...c,isBack:!0,isEmpty:!0}),e.push(c)),e})();return t.jsxs(U,{isOpen:x,onRequestClose:k,style:Q,contentLabel:"Vista previa del Ã¡lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[t.jsx("style",{dangerouslySetInnerHTML:{__html:de}}),D&&t.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),t.jsx("p",{className:"text-gray-700",children:"Generando vistas previas de alta calidad..."}),t.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})}),t.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[t.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del Ã¡lbum"}),t.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las pÃ¡ginas de su Ã¡lbum usando los controles de navegaciÃ³n o teclado. Puede cerrar esta ventana presionando Escape o el botÃ³n de cerrar."}),t.jsx("button",{onClick:k,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del Ã¡lbum",children:t.jsx(Y,{className:"h-6 w-6"})}),t.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[t.jsx("button",{onClick:ae,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"PÃ¡gina anterior",children:t.jsx(le,{className:"h-6 w-6"})}),t.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const e=H[M];return e?e.isBack&&e.isEmpty?"Reverso":e.isBack?"Reverso de la pÃ¡gina":e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`PÃ¡gina ${e.pageNumber||Math.ceil((M+1)/2)}`:"Cargando..."})(),t.jsx("span",{className:"mx-2 text-gray-400",children:"â€¢"}),Math.ceil((M+1)/2)," / ",Math.ceil(H.length/2)," hojas"]}),t.jsx("button",{onClick:ne,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"PÃ¡gina siguiente",children:t.jsx(ce,{className:"h-6 w-6"})})]}),t.jsx("div",{className:"flex items-center justify-center",children:t.jsx(se,{ref:A,width:L,height:T,size:"stretch",minWidth:L*.7,maxWidth:L*1.3,minHeight:T*.7,maxHeight:T*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:e=>q(e.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:H.map((e,a)=>t.jsx("div",{id:`page-${e.id}`,className:"page-container",style:{width:L,height:T,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:t.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:e.isEmpty||e.isBack?t.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:e.isBack?"Reverso":""}):B[e.id]?t.jsx("img",{src:B[e.id],alt:`${e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`PÃ¡gina ${e.pageNumber||a+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):t.jsx(ge,{page:e,pageIdx:a})})},`page-${a}`))})})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-md mx-auto",children:[t.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${S?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var e,a,c,o;if(!S){W(!0);try{if(console.log("ðŸš€ Iniciando proceso de compra con generaciÃ³n de PDF..."),typeof $!="function"){console.error("âŒ addAlbumToCart no es una funciÃ³n"),console.log("addAlbumToCart type:",typeof $),console.log("addAlbumToCart value:",$),alert("Error: FunciÃ³n de carrito no disponible. IntÃ©ntelo nuevamente.");return}console.log("ï¿½ Agregando Ã¡lbum al carrito...");const u=$();if(console.log("ï¿½ Resultado de addAlbumToCart:",u),u){console.log("âœ… Ãlbum agregado al carrito exitosamente");let l=null;try{const r=`${((e=window.Global)==null?void 0:e.APP_CORRELATIVE)||"bananalab"}_cart`,s=JSON.parse(localStorage.getItem(r)||"[]").filter(d=>d.type==="custom_album").sort((d,g)=>{const b=parseInt(d.id.split("_").pop());return parseInt(g.id.split("_").pop())-b})[0];s&&s.project_id?(l=s.project_id,console.log("ðŸ†” Project ID obtenido del carrito:",l)):console.warn("âš ï¸ No se encontrÃ³ project_id en el carrito")}catch(r){console.error("âŒ Error al obtener project_id del carrito:",r)}l||(l=window.currentProjectId||window.albumProjectId||`project_${Date.now()}`,console.log("ðŸ†” Project ID de fallback:",l)),console.log("ðŸ“„ Generando PDF del Ã¡lbum usando thumbnails...");try{if(!K)throw new Error("jsPDF no estÃ¡ disponible");const r=C.width*.264583*10,n=C.height*.264583*10,s=new K({orientation:r>n?"landscape":"portrait",unit:"mm",format:[r,n],scale:2,hotfixes:["px_scaling"]}),d=f.filter(h=>!h.isBack&&!h.isEmpty);console.log("ðŸ“„ PÃ¡ginas a incluir en PDF:",d.length);const g=Object.keys(B).length>0?B:J;if(Object.keys(g).length===0)throw new Error("No hay thumbnails disponibles para generar el PDF");console.log("ðŸ“„ Usando thumbnails:",Object.keys(g));for(let h=0;h<d.length;h++){const P=d[h],p=g[P.id];p?(h>0&&s.addPage([r,n]),s.addImage(p,"PNG",0,0,r,n,void 0,"FAST"),console.log(`ðŸ“„ PÃ¡gina ${h+1} agregada al PDF:`,P.type)):console.warn(`âš ï¸ No se encontrÃ³ thumbnail para pÃ¡gina ${P.id}`)}const b=s.output("blob");console.log("ðŸ“„ PDF generado exitosamente usando thumbnails:",b.size,"bytes"),console.log("ðŸ’¾ Guardando PDF en el servidor...");const m=await new Promise((h,P)=>{const p=new FileReader;p.onload=()=>{const E=p.result.split(",")[1];h(E)},p.onerror=P,p.readAsDataURL(b)}),i={item_id:y==null?void 0:y.id,preset_id:R==null?void 0:R.id,title:(y==null?void 0:y.name)||(y==null?void 0:y.title)||"Ãlbum Personalizado",user_id:y==null?void 0:y.user_id};console.log("ðŸ“„ Enviando PDF al servidor:",{projectId:l,itemDataToSend:i,pdfSize:m.length});const v=await fetch(`/api/projects/${l}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||""},body:JSON.stringify({pdf_blob:m,item_data:i})});if(!v.ok){const h=await v.json();throw new Error(h.message||"Error al guardar el PDF en el servidor")}const j=await v.json();console.log("ðŸ’¾ PDF guardado en servidor:",j)}catch(r){console.error("âŒ Error generando/guardando PDF:",r),console.log("âš ï¸ Continuando sin PDF...")}try{await new Promise(s=>setTimeout(s,300));const r=JSON.parse(localStorage.getItem(`${((c=window.Global)==null?void 0:c.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");console.log("ðŸ” VerificaciÃ³n final del carrito:",r),console.log("ðŸ” Longitud del carrito:",r.length),r.length===0&&console.error("âŒ ADVERTENCIA: El carrito parece vacÃ­o despuÃ©s de agregar");const n=`${O.APP_URL}/cart`;console.log("ðŸ”„ Redirigiendo al carrito..."),console.log("ðŸ”„ URL del carrito:",n),window.location.href=n}catch(r){console.error("âš ï¸ Error durante verificaciÃ³n o redirecciÃ³n:",r),console.log("ðŸ”„ Intentando redirecciÃ³n directa...");const n=`${O.APP_URL}/cart`;console.log("ðŸ”„ Redirigiendo al carrito..."),console.log("ðŸ”„ URL del carrito:",n),window.location.href=n}}else console.error("âŒ No se pudo agregar al carrito"),alert("Error al agregar el Ã¡lbum al carrito. Revise la consola para mÃ¡s detalles.")}catch(u){console.error("âŒ === ERROR DURANTE PROCESO DE COMPRA ==="),console.error("Tipo de error:",u.name),console.error("Mensaje:",u.message),console.error("Stack trace:",u.stack),console.error("Error completo:",u);try{const l=JSON.parse(localStorage.getItem(`${((o=O)==null?void 0:o.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");if(console.log("ðŸ” Verificando carrito despuÃ©s del error:",l.length>0?"HAY ITEMS":"VACÃO"),l.length>0){console.log("âœ… El carrito tiene items, redirigiendo de todas formas...");const r=`${O.APP_URL}/cart`;console.log("ðŸ”„ Redirigiendo al carrito..."),console.log("ðŸ”„ URL del carrito:",r),window.location.href=r;return}}catch(l){console.error("âŒ Error durante intento de recuperaciÃ³n:",l)}alert(`Error durante el proceso: ${u.message}. Si el Ã¡lbum se agregÃ³ al carrito, puede ir manualmente a la pÃ¡gina del carrito.`)}finally{W(!1)}}},disabled:S,children:S?t.jsxs(t.Fragment,{children:[t.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):"Comprar ahora"}),t.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:k,disabled:S,children:"Continuar editando"})]}),"        "]})},ge=({page:x,pageIdx:k})=>{let f="",w="";switch(x.type){case"cover":f="Portada",w="ðŸ“š";break;case"final":f="Contraportada",w="ðŸ“–";break;case"content":f=`PÃ¡gina ${x.pageNumber||k+1}`,w="ðŸ“„";break;default:f=`PÃ¡gina ${k+1}`,w="ðŸ“„"}return t.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[t.jsx("div",{className:"text-6xl mb-4",children:w}),t.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:f}),t.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),x.layout&&t.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",x.layout.name||"Personalizado"]})]})};export{Ae as B};
