import{j as t}from"./AboutSimple-Cf8x2fCZ.js";import{r as w}from"./index-BH53Isel.js";import"./EditorLayout-CkCvwqGw.js";import"./thumbnailGenerator-B4goYG9Y.js";import"./index-BZYhE2TF.js";import"./TextElement-_pvTHO57.js";import{M as H}from"./PaymentModal-Bxx5p2o_.js";import{H as ce}from"./jspdf.es.min-D3plwuQr.js";import{G as z}from"./Global-ErywZRdd.js";import{X as K}from"./x-DBMwyD6F.js";import{C as de}from"./chevron-left-B2s3ZsB7.js";import{C as me}from"./chevron-right-Ckt5D2ka.js";import{D as ge}from"./download-Dh5rRDOT.js";import"./index-yBjzXJbu.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./preload-helper-BfFHrpNk.js";import"./typeof-QjJsDpFa.js";import"./createLucideIcon-Cy5Ya80P.js";const Q={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},he=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;H.setAppElement("#app");const Me=({isOpen:h,onRequestClose:v,pages:m,pageThumbnails:p={},addAlbumToCart:_,workspaceDimensions:C={width:800,height:600},layouts:W=[],presetData:$=null,projectData:T=null,itemData:ue=null})=>{const[D,Y]=w.useState(0),[I,R]=w.useState(!1),[j,U]=w.useState(!1),[q,B]=w.useState({}),[ee,J]=w.useState(!1),A=w.useRef();function te(e,a,s,n,u,d){const r=a.width,i=a.height,o=u/d,c=r/i;let f=0,y=0,g=r,l=i;o>c?(l=r/o,y=(i-l)/2):(g=i*o,f=(r-g)/2),e.drawImage(a,f,y,g,l,s,n,u,d)}function re(e){const a=e.match(/grid-cols-(\d+)/),s=e.match(/grid-rows-(\d+)/),n=e.match(/gap-(\d+)/);return{cols:a?parseInt(a[1],10):1,rows:s?parseInt(s[1],10):1,gap:n?parseInt(n[1],10)*4:0}}function Z(e,a,s=1){const n=e&&e.match(new RegExp(`${a}-span-(\\d+)`));return n?parseInt(n[1],10):s}function ae(e,a,s){const{cols:n,rows:u,gap:d}=re(e.template),r=e.style&&e.style.padding?parseInt(e.style.padding):0,i=a.width-2*r,o=a.height-2*r,c=(i-d*(n-1))/n,f=(o-d*(u-1))/u,y=Array.from({length:u},()=>Array(n).fill(!1)),g={};for(let l=0;l<e.cells;l++){const N=e.cellStyles&&e.cellStyles[l]?e.cellStyles[l]:"",P=Z(N,"col",1),S=Z(N,"row",1);let M=!1;for(let b=0;b<=u-S&&!M;b++)for(let E=0;E<=n-P&&!M;E++){let L=!0;for(let x=b;x<b+S;x++){for(let k=E;k<E+P;k++)if(y[x][k]){L=!1;break}if(!L)break}if(L){for(let k=b;k<b+S;k++)for(let V=E;V<E+P;V++)y[k][V]=!0;const x=s&&s[l]?s[l].id:l;g[x]={x:r+E*(c+d),y:r+b*(f+d),width:c*P+d*(P-1),height:f*S+d*(S-1)},console.log(`[GRID-PLACEMENT] cellId:${x} col-span:${P} row-span:${S} => x:${g[x].x} y:${g[x].y} w:${g[x].width} h:${g[x].height}`),M=!0}}if(!M){const b=s&&s[l]?s[l].id:l;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${b}`),g[b]={x:0,y:0,width:c,height:f}}}return g}const oe=w.useCallback(async()=>{if(!m||m.length===0||!h)return;console.log("🚀 Iniciando generación de thumbnails para BookPreview..."),J(!0),B({});const e={},a=4,s=(r,i,o,c)=>{if(!i||!i.image)return;const f=new Image;f.src=i.image,f.onload=()=>{const y=o.x+i.x*c,g=o.y+i.y*c,l=i.width*c,N=i.height*c;te(r,f,y,g,l,N)}},n=async(r,i)=>{const o=document.createElement("canvas"),c=o.getContext("2d");if(o.width=C.width*a,o.height=C.height*a,$&&$.final_layer_image){const l=new Image;l.src=$.final_layer_image,l.onload=()=>{c.drawImage(l,0,0,o.width,o.height)}}const f=W.find(l=>l.id===r.layoutId);if(!f)return;const y=ae(f,C,r.cells);r.cells.forEach(l=>{const N=y[l.id];N&&l.elements.forEach(P=>{s(c,P,N,a)})});const g=o.toDataURL("image/jpeg",.9);return{[i]:g}},u=m.map((r,i)=>n(r,i));(await Promise.all(u)).forEach(r=>{Object.assign(e,r)}),B(e),J(!1)},[m,h,C,W,$]),ne=async()=>{var e;if(!(T!=null&&T.id)){alert("No se ha cargado ningún proyecto.");return}U(!0);try{const a=await fetch(`/api/projects/${T.id}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.content)||""}});if(a.ok){const s=await a.blob();if(s.type==="application/pdf")saveAs(s,`proyecto-${T.id}.pdf`),alert("PDF generado y descargado exitosamente.");else{const n=await a.json();alert(n.message||"Error al generar el PDF.")}}else{const s=await a.json();alert(s.message||"No se pudo generar el PDF.")}}catch(a){console.error("Error al exportar el PDF:",a),alert("Ocurrió un error de red al generar el PDF.")}finally{U(!1)}};w.useEffect(()=>{h&&(Object.keys(p).length===0?oe():B(p))},[h,p]),w.useEffect(()=>{h||B({})},[h]);const X=Object.keys(p).length>0?p:q;if(!m||!Array.isArray(m)||m.length===0)return t.jsx(H,{isOpen:h,onRequestClose:v,style:Q,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:t.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del álbum"}),t.jsx("button",{onClick:v,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:t.jsx(K,{size:24})})]}),t.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay páginas disponibles para mostrar."})]})});const ie=()=>{A.current&&A.current.pageFlip().flipPrev()},se=()=>{A.current&&A.current.pageFlip().flipNext()},le=C.width/C.height,F=600,O=Math.round(F*le),G=(()=>{const e=[],a=[...m.filter(n=>n.type==="cover"),...m.filter(n=>n.type==="content"),...m.filter(n=>n.type==="final")];a.length>0&&(e.push(a[0]),e.push({...a[0],isBack:!0}));for(let n=1;n<a.length-1;n++)e.push(a[n]),n+1<a.length-1?(e.push(a[n+1]),n++):e.push({...a[n],isBack:!0,isEmpty:!0});const s=a.find(n=>n.type==="final");return s&&(e.push({...s,isBack:!0,isEmpty:!0}),e.push(s)),e})();return t.jsxs(H,{isOpen:h,onRequestClose:v,style:Q,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[t.jsx("style",{dangerouslySetInnerHTML:{__html:he}}),(ee||j)&&t.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),t.jsx("p",{className:"text-gray-700",children:j?"Generando PDF de alta calidad...":"Generando vistas previas de alta calidad..."}),t.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})}),t.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[t.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del álbum"}),t.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las páginas de su álbum usando los controles de navegación o teclado. Puede cerrar esta ventana presionando Escape o el botón de cerrar."}),t.jsx("button",{onClick:v,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del álbum",children:t.jsx(K,{className:"h-6 w-6"})}),t.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[t.jsx("button",{onClick:ie,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página anterior",children:t.jsx(de,{className:"h-6 w-6"})}),t.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const e=G[D];return e?e.isBack&&e.isEmpty?"Reverso":e.isBack?"Reverso de la página":e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`Página ${e.pageNumber||Math.ceil((D+1)/2)}`:"Cargando..."})(),t.jsx("span",{className:"mx-2 text-gray-400",children:"•"}),Math.ceil((D+1)/2)," / ",Math.ceil(G.length/2)," hojas"]}),t.jsx("button",{onClick:se,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página siguiente",children:t.jsx(me,{className:"h-6 w-6"})})]}),t.jsx("div",{className:"flex items-center justify-center",children:t.jsx(ce,{ref:A,width:O,height:F,size:"stretch",minWidth:O*.7,maxWidth:O*1.3,minHeight:F*.7,maxHeight:F*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:e=>Y(e.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:G.map((e,a)=>t.jsx("div",{id:`page-${e.id}`,className:"page-container",style:{width:O,height:F,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:t.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:e.isEmpty||e.isBack?t.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:e.isBack?"Reverso":""}):X[e.id]?t.jsx("img",{src:X[e.id],alt:`${e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`Página ${e.pageNumber||a+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):t.jsx(fe,{page:e,pageIdx:a})})},`page-${a}`))})})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-2xl mx-auto",children:[t.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${j?"bg-blue-400 text-white cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,onClick:ne,disabled:j||I,children:j?t.jsxs(t.Fragment,{children:[t.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Generando PDF..."]}):t.jsxs(t.Fragment,{children:[t.jsx(ge,{className:"h-5 w-5 mr-2"}),"Descargar PDF"]})}),t.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${I?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var e,a,s,n,u;if(!I){R(!0),console.log("🚀 === INICIO PROCESO COMPRA (SIN PDF FRONTEND) ===");try{if(console.log("🔍 Verificando función addAlbumToCart..."),console.log("addAlbumToCart type:",typeof _),console.log("addAlbumToCart value:",_),typeof _!="function"){console.error("❌ addAlbumToCart no es una función"),alert("Error: Función de carrito no disponible. Inténtelo nuevamente."),R(!1);return}console.log("🛒 Agregando álbum al carrito y preparando para PDF backend...");let d;try{const r=_();r&&typeof r.then=="function"?d=await r:d=r,console.log("✅ Resultado de addAlbumToCart:",d)}catch(r){console.error("❌ Error en addAlbumToCart:",r),alert("Error al agregar al carrito: "+r.message),R(!1);return}if(!d){console.error("❌ No se pudo agregar al carrito"),alert("Error al agregar el álbum al carrito. Revise la consola para más detalles."),R(!1);return}console.log("✅ Álbum agregado al carrito exitosamente"),console.log("📄 El PDF se generará automáticamente en el backend con dimensiones exactas de BD");try{const r=`${((e=window.Global)==null?void 0:e.APP_CORRELATIVE)||"bananalab"}_cart`,o=JSON.parse(localStorage.getItem(r)||"[]").find(c=>c.type==="custom_album"&&c.project_id&&c.pdf_data);o?console.log("📄 Datos para PDF backend confirmados:",{project_id:o.project_id,has_pdf_data:!!o.pdf_data,dimensions:(a=o.pdf_data)==null?void 0:a.dimensions}):console.warn("⚠️ No se encontraron datos de PDF en el carrito")}catch(r){console.warn("⚠️ Error verificando datos de PDF:",r)}console.log("🔄 Iniciando redirección al carrito...");try{console.log("⏱️ Esperando 1 segundo para asegurar persistencia..."),await new Promise(o=>setTimeout(o,1e3));let r=[];for(let o=0;o<3&&(r=JSON.parse(localStorage.getItem(`${((s=window.Global)==null?void 0:s.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]"),console.log(`🔍 Verificación ${o+1}/3 del carrito:`,r.length,"items"),!(r.length>0));o++)o<2&&(console.log("⏱️ Esperando 500ms más..."),await new Promise(c=>setTimeout(c,500)));if(r.length===0){console.warn("⚠️ Carrito sigue vacío, intentando forzar adición...");try{const o=_();o&&typeof o.then=="function"&&await o,await new Promise(c=>setTimeout(c,500)),r=JSON.parse(localStorage.getItem(`${((n=window.Global)==null?void 0:n.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]"),console.log("🔍 Verificación después de adición forzada:",r.length,"items")}catch(o){console.error("❌ Error en adición forzada:",o)}}const i=`${z.APP_URL}/cart`;console.log("🔄 Redirigiendo a:",i),console.log("🔄 Estado final del carrito:",r.length,"items");try{window.location.href=i}catch(o){console.error("❌ Error con window.location.href:",o);try{window.location.replace(i)}catch(c){console.error("❌ Error con window.location.replace:",c),window.open(i,"_self")}}}catch(r){console.error("❌ Error durante redirección:",r);const i=`${z.APP_URL}/cart`;console.log("🔄 Redirección de emergencia a:",i),setTimeout(()=>{try{window.location.href=i}catch{window.location=i}},100)}}catch(d){console.error("❌ === ERROR GENERAL ==="),console.error("Tipo:",d.name),console.error("Mensaje:",d.message),console.error("Stack:",d.stack);try{if(JSON.parse(localStorage.getItem(`${((u=window.Global)==null?void 0:u.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]").length>0){console.log("✅ Hay items en carrito, redirigiendo..."),window.location.href=`${z.APP_URL}/cart`;return}}catch(r){console.error("❌ Error en recuperación:",r)}alert(`Error: ${d.message}. Si el álbum se agregó, puede ir manualmente al carrito.`)}finally{console.log("🔄 Desbloqueando botón..."),R(!1),setTimeout(()=>{console.log("🔄 Timeout: Desbloqueando botón (respaldo)..."),R(!1)},2e3)}}},disabled:I||j,children:I?t.jsxs(t.Fragment,{children:[t.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):"Comprar ahora"}),t.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:v,disabled:I||j,children:"Continuar editando"})]}),"        "]})},fe=({page:h,pageIdx:v})=>{let m="",p="";switch(h.type){case"cover":m="Portada",p="📚";break;case"final":m="Contraportada",p="📖";break;case"content":m=`Página ${h.pageNumber||v+1}`,p="📄";break;default:m=`Página ${v+1}`,p="📄"}return t.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[t.jsx("div",{className:"text-6xl mb-4",children:p}),t.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:m}),t.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),h.layout&&t.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",h.layout.name||"Personalizado"]})]})};export{Me as B};
