const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as gn}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as d,R as bt}from"./index-BH53Isel.js";import{T as _s,l as le,i as Ls,a as mn,D as hn,H as fn,U as pn,R as xn,B as Je,F as bn,E as ks}from"./EditableCell-B3uFPs_m.js";import{h as As}from"./thumbnailGenerator-B4goYG9Y.js";import{L as Ze}from"./layers-6oegOx-p.js";import{C as yn}from"./chevron-down-DS-mdh9v.js";import{C as vn}from"./chevron-right-Ckt5D2ka.js";import{E as wn}from"./eye-CKCH9ORv.js";import{c as me}from"./createLucideIcon-Cy5Ya80P.js";import{T as yt}from"./trash-2-DK1wnsDn.js";import{S as jn}from"./star-wPQTHY_n.js";import{I as Ie}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as X,T as En}from"./index-BZYhE2TF.js";import{m as Ts}from"./main-6DCdASTx.js";import{B as Nn}from"./V1Edit-CNtDxOEt.js";import{G as Is}from"./Global-ErywZRdd.js";import{S as Rs,F as Sn}from"./save-BfW-kI1U.js";import{C as Cn}from"./clock-BTrEpQej.js";import{C as zs}from"./check-DQ7QoS0v.js";import{L as kn}from"./loader-circle-CrvBvIt1.js";import{B as Ye}from"./dom-to-image-more.min-Cey65QPP.js";import{C as An}from"./chevron-left-B2s3ZsB7.js";import{U as Tn}from"./user-BvYmyGTY.js";import{F as Ps}from"./filter-Ci9tsc_e.js";import{P as Xe}from"./plus-Bot15Khs.js";import{C as In}from"./copy-6OEekgvq.js";import{C as Pn}from"./circle-check-big-D6DM3vPb.js";import{u as Mn}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-Bxx5p2o_.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./download-Dh5rRDOT.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const On=me("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $n=me("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Un=me("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _n=me("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ln=me("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rn=me("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=me("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zn=me("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fn=me("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=me("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ms=me("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vn=me("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Gn=({pages:n,currentPage:h,selectedCell:g,selectedElement:k,onSelectCell:i,onSelectElement:b,onUpdateElement:w,onDeleteElement:N,onMoveElement:$})=>{var B;if(!n||!n[h])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ze,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const x=n[h],V=((B=x==null?void 0:x.cells)==null?void 0:B.filter(T=>T.elements&&T.elements.length>0))||[],[R,P]=d.useState(()=>{const T={};return V.forEach(z=>{T[z.id]=!0}),T}),O=T=>{P(z=>({...z,[T]:!z[T]}))},E=T=>{switch(T){case"image":return e.jsx(Ie,{className:"h-4 w-4"});case"text":return e.jsx(_s,{className:"h-4 w-4"});case"shape":return e.jsx(Fn,{className:"h-4 w-4"});case"sticker":return e.jsx(jn,{className:"h-4 w-4"});default:return e.jsx(_n,{className:"h-4 w-4"})}},_=(T,z)=>{switch(T.type){case"text":return T.content?T.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${z+1}`;case"shape":return T.shape||"Shape";case"sticker":return`Sticker ${z+1}`;default:return`Element ${z+1}`}},F=(T,z,te)=>{w(T,z,{visible:te})},q=(T,z)=>{i(T),b(z)};return e.jsx("div",{className:"space-y-2",children:V.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ze,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):V.map(T=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${g===T.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{O(T.id),i(T.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:R[T.id]?e.jsx(yn,{className:"h-4 w-4"}):e.jsx(vn,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",T.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[T.elements.length," element",T.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[T.x,", ",T.y]})]}),R[T.id]&&e.jsx("div",{className:"border-t border-gray-100",children:T.elements.map((z,te)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${k===z.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>q(T.id,z.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:E(z.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:_(z,te)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[z.type," • Layer ",te+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:D=>{D.stopPropagation(),F(T.id,z.id,!z.visible)},className:"p-1 hover:bg-gray-200 rounded",title:z.visible?"Hide element":"Show element",children:z.visible!==!1?e.jsx(wn,{className:"h-3 w-3 text-gray-500"}):e.jsx(Rn,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),$(T.id,z.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:te===T.elements.length-1,children:e.jsx($n,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),$(T.id,z.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:te===0,children:e.jsx(On,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),N(T.id,z.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(yt,{className:"h-3 w-3"})})]})]},z.id))})]},T.id))})};function Bn({currentLayoutId:n,onLayoutChange:h}){const[g,k]=d.useState("all"),i={all:{name:"Todos",layouts:le},hero:{name:"Hero",layouts:le.filter(b=>b.category==="hero")},editorial:{name:"Editorial",layouts:le.filter(b=>b.category==="editorial")},storytelling:{name:"Historia",layouts:le.filter(b=>b.category==="storytelling")},minimal:{name:"Minimal",layouts:le.filter(b=>b.category==="minimal")},creative:{name:"Creativo",layouts:le.filter(b=>b.category==="creative")},classic:{name:"Clásico",layouts:le.filter(b=>b.category==="classic")}};return Object.keys(i).filter(b=>b==="all"||i[b].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:i[g].layouts.map(b=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>h(b.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${b.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:b.cells}).map((w,N)=>{var $,x;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(x=($=b.cellStyles)==null?void 0:$[N])!=null&&x.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},N)})}),n===b.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:b.name}),b.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:b.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[b.cells," ",b.cells===1?"celda":"celdas"]})})]})]},b.id))}),i[g].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categoría."})})]})}const Hn=({selectedMask:n,onSelect:h,availableMasks:g=[],selectedImage:k})=>{var N,$;const[i,b]=d.useState("Básicas"),w={};return Ls.forEach(x=>{w[x.category]||(w[x.category]=[]),(g.includes(x.id)||x.id==="none")&&w[x.category].push(x)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(w).slice(0,2).map(x=>w[x].length>0&&e.jsx("button",{onClick:()=>b(x),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${i===x?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:x},x))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(N=w[i])==null?void 0:N.slice(0,6).map(x=>e.jsxs("div",{onClick:()=>h(x.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${n===x.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:k!=null&&k.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:k.content,alt:x.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:x.name})]},x.id))}),(($=w[i])==null?void 0:$.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver más máscaras (",w[i].length-6," más)"]})]})},Ee=new Map,Pe=new Map;async function Vs(n){return Ee.has(n)?Ee.get(n):new Promise((h,g)=>{const k=new Image;k.crossOrigin="anonymous",k.onload=()=>{Ee.set(n,k),h(k)},k.onerror=()=>{console.warn(`⚠️ No se pudo cargar imagen: ${n}`),h(null)},setTimeout(()=>{Ee.has(n)||(console.warn(`⏰ Timeout cargando imagen: ${n}`),h(null))},3e3),k.src=n})}function Gs(n,h,g){var O,E,_,F;const{x:k,y:i,width:b,height:w}=g,N=((O=h.position)==null?void 0:O.x)||0,$=((E=h.position)==null?void 0:E.y)||0,x=k+(N<=1?N*b:N),V=i+($<=1?$*w:$),R=(_=h.size)!=null&&_.width?h.size.width<=1?h.size.width*b:h.size.width:b,P=(F=h.size)!=null&&F.height?h.size.height<=1?h.size.height*w:h.size.height:w;if(h.type==="image"&&h.content){const q=Ee.get(h.content);if(q){if(n.save(),h.filters){const{brightness:r=100,contrast:oe=100,saturation:c=100,opacity:ee=100}=h.filters;(r!==100||oe!==100||c!==100||ee!==100)&&(n.filter=`brightness(${r/100}) contrast(${oe/100}) saturate(${c/100}) opacity(${ee/100})`)}const B=q.width/q.height,T=R/P;let z=0,te=0,D=q.width,he=q.height;B>T?(D=q.height*T,z=(q.width-D)/2):(he=q.width/T,te=(q.height-he)/2),n.drawImage(q,z,te,D,he,x,V,R,P),n.restore()}}else if(h.type==="text"&&h.content){n.save();const q=h.style||{},B=Math.max(8,parseInt(q.fontSize)||16),T=q.color||"#000000";n.font=`${B}px Arial, sans-serif`,n.fillStyle=T,n.textBaseline="top";let z=h.content.split(`
`)[0]||"";z.length>50&&(z=z.substring(0,50)+"..."),n.fillText(z,x+4,V+4),n.restore()}}async function Wn({page:n,workspaceDimensions:h,onProgress:g=null}){console.log(`⚡ Generando thumbnail para página: ${n.id}`);const i=(b,w,N="")=>{const $=Math.round(b/w*100);console.log(`📊 Progreso página ${n.id}: ${b}/${w} (${$}%) ${N}`),g&&g({current:b,total:w,percentage:$,message:N,pageId:n.id})};try{const b=300/Math.max(h.width,h.height),w=Math.round(h.width*b),N=Math.round(h.height*b),$=`${n.id}-${w}x${N}`;if(Pe.has($))return console.log(`📦 Thumbnail encontrado en cache: ${n.id}`),i(4,4,"Cargado desde cache"),Pe.get($);i(1,4,"Iniciando generación...");const x=new Set;n.backgroundImage&&x.add(n.backgroundImage),n.cells&&n.cells.forEach(E=>{E.elements&&E.elements.forEach(_=>{_.type==="image"&&_.content&&x.add(_.content)})}),i(2,4,"Cargando imágenes...");const V=Array.from(x).map(async E=>{try{const _=new Promise((q,B)=>setTimeout(()=>B(new Error("Timeout")),3e3)),F=Vs(E);await Promise.race([F,_])}catch{console.warn(`⚠️ Error/timeout cargando imagen: ${E}`)}});await Promise.all(V),i(3,4,"Renderizando thumbnail...");const R=document.createElement("canvas"),P=R.getContext("2d",{alpha:!1,willReadFrequently:!1});if(R.width=w,R.height=N,P.fillStyle=n.backgroundColor||"#ffffff",P.fillRect(0,0,R.width,R.height),n.backgroundImage){const E=Ee.get(n.backgroundImage);E&&P.drawImage(E,0,0,R.width,R.height)}if(n.cells&&n.cells.length>0){const E=Math.ceil(Math.sqrt(Math.min(n.cells.length,9))),_=R.width/E,F=R.height/Math.ceil(Math.min(n.cells.length,9)/E);n.cells.slice(0,9).forEach((q,B)=>{const T=B%E,z=Math.floor(B/E),te=T*_,D=z*F;q.elements&&q.elements.filter(r=>r.type==="image"||r.type==="text").slice(0,3).forEach(r=>{Gs(P,r,{x:te,y:D,width:_,height:F})})})}i(4,4,"Guardando thumbnail...");const O=R.toDataURL("image/jpeg",.7);return Pe.set($,O),console.log(`✅ Thumbnail generado para página: ${n.id}`),O}catch(b){return console.error(`❌ Error generando thumbnail para página ${n.id}:`,b),i(4,4,"Error en generación"),null}}async function Os({pages:n,workspaceDimensions:h,onProgress:g=null}){const k={};console.log(`⚡ Generando ${n.length} thumbnails rápidos...`);const b=(P,O,E="")=>{const _=Math.round(P/O*100);console.log(`📊 Progreso: ${P}/${O} (${_}%) ${E}`),g&&g({current:P,total:O,percentage:_,message:E})},w=new Set;n.forEach(P=>{P.backgroundImage&&w.add(P.backgroundImage),P.cells&&P.cells.forEach(O=>{O.elements&&O.elements.forEach(E=>{E.type==="image"&&E.content&&w.add(E.content)})})});const N=Array.from(w),$=5;b(0,N.length,"Cargando imágenes...");for(let P=0;P<N.length;P+=$){const O=N.slice(P,P+$);await Promise.all(O.map(Vs)),b(Math.min(P+$,N.length),N.length,"Cargando imágenes...")}console.log(`📸 Imágenes cargadas: ${Ee.size}`);const x=300/Math.max(h.width,h.height),V=Math.round(h.width*x),R=Math.round(h.height*x);b(0,n.length,"Generando thumbnails...");for(let P=0;P<n.length;P++){const O=n[P];try{const E=`${O.id}-${V}x${R}`;if(Pe.has(E)){k[O.id]=Pe.get(E),b(P+1,n.length,`Thumbnail ${O.id} (cached)`);continue}const _=document.createElement("canvas"),F=_.getContext("2d",{alpha:!1,willReadFrequently:!1});if(_.width=V,_.height=R,F.fillStyle=O.backgroundColor||"#ffffff",F.fillRect(0,0,_.width,_.height),O.backgroundImage){const B=Ee.get(O.backgroundImage);B&&F.drawImage(B,0,0,_.width,_.height)}if(O.cells&&O.cells.length>0){const B=Math.ceil(Math.sqrt(O.cells.length)),T=_.width/B,z=_.height/Math.ceil(O.cells.length/B);O.cells.forEach((te,D)=>{if(D>=9)return;const he=D%B,r=Math.floor(D/B),oe=he*T,c=r*z;te.elements&&te.elements.filter(de=>de.type==="image"||de.type==="text").slice(0,3).forEach(de=>{Gs(F,de,{x:oe,y:c,width:T,height:z})})})}const q=_.toDataURL("image/jpeg",.7);k[O.id]=q,Pe.set(E,q),b(P+1,n.length,`Thumbnail ${O.id} generado`)}catch(E){console.error(`❌ Error generando thumbnail rápido para ${O.id}:`,E),k[O.id]=null,b(P+1,n.length,`Error en ${O.id}`)}}return console.log(`⚡ ¡${Object.keys(k).length} thumbnails generados en modo rápido!`),k}function $s(){Ee.clear(),Pe.clear(),console.log("🧹 Caches de thumbnails limpiados")}const qn=async(n,h,g)=>{var k;try{console.log("📤 [SAVE] Subiendo imagen al backend:",h);const[i,b]=n.split(","),w=((k=i.match(/data:image\/(\w+)/))==null?void 0:k[1])||"png",N=new FormData,$=atob(b),x=new Array($.length);for(let E=0;E<$.length;E++)x[E]=$.charCodeAt(E);const V=new Uint8Array(x),R=new Blob([V],{type:`image/${w}`});N.append("image",R,`element_${h}.${w}`),N.append("project_id",g),N.append("element_id",h);const P=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:N});if(!P.ok)throw new Error("Error al subir imagen al servidor");const O=await P.json();return console.log("✅ [SAVE] Imagen subida exitosamente:",O.url),O.url}catch(i){throw console.error("❌ [SAVE] Error subiendo imagen:",i),i}},Qn=async(n,h)=>{var b,w;console.log("🔄 [SAVE] Procesando imágenes para guardado...");const g=[];let k=0,i=0;for(const N of n)for(const $ of N.cells||[])for(const x of $.elements||[])x.type==="image"&&((b=x.content)!=null&&b.startsWith("data:image/"))&&k++;console.log(`📊 [SAVE] Total de imágenes base64 a procesar: ${k}`);for(const N of n){const $={...N};$.cells=[];for(const x of N.cells||[]){const V={...x};V.elements=[];for(const R of x.elements||[]){const P={...R};if(R.type==="image"&&((w=R.content)!=null&&w.startsWith("data:image/")))try{const O=await qn(R.content,R.id,h);P.content=O,P.isUploaded=!0,i++,console.log(`✅ [SAVE] Imagen ${i}/${k} procesada`)}catch(O){console.error("❌ [SAVE] Error procesando imagen:",R.id,O),P.uploadError=O.message}V.elements.push(P)}$.cells.push(V)}g.push($)}return console.log(`✅ [SAVE] Procesamiento completado: ${i}/${k} imágenes subidas`),g},Jn=async(n,h)=>{var g;try{console.log("🔍 [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:n,thumbnailsCount:Object.keys(h).length});const k=[];for(const[w,N]of Object.entries(h))console.log(`🔍 [DEBUG] Procesando thumbnail para página ${w}:`,{hasData:!!N,isBase64:N&&N.startsWith("data:image/"),dataLength:N?N.length:0}),N&&N.startsWith("data:image/")&&k.push({page_id:w,thumbnail_data:N});if(k.length===0){console.log("ℹ️ [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`🖼️ [THUMBNAILS] Guardando ${k.length} thumbnails como archivos...`),console.log(`🔍 [DEBUG] URL del endpoint: /api/thumbnails/${n}/save-as-files`);const i=await fetch(`/api/thumbnails/${n}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((g=document.querySelector('meta[name="csrf-token"]'))==null?void 0:g.content)||""},credentials:"include",body:JSON.stringify({thumbnails:k})});if(console.log("🔍 [DEBUG] Respuesta del servidor:",{status:i.status,statusText:i.statusText,ok:i.ok}),!i.ok){const w=await i.text();throw console.error("❌ [THUMBNAILS] Error respuesta del servidor:",w),new Error(`Error al guardar thumbnails: ${i.status} ${i.statusText}`)}const b=await i.json();return console.log("✅ [THUMBNAILS] Thumbnails guardados como archivos:",b),b}catch(k){throw console.error("❌ [THUMBNAILS] Error guardando thumbnails:",k),k}},Us=async(n,h,g,k,i,b,w=!1)=>{try{if(!(h!=null&&h.id))throw new Error("No se encontró el ID del proyecto");console.log(`💾 [SAVE] Iniciando ${w?"auto-guardado":"guardado manual"}...`);let N=n;w||(N=await Qn(n,h.id));const $={pages:N,projectInfo:{id:h.id,item_id:g==null?void 0:g.id,title:g==null?void 0:g.title,preset_id:k==null?void 0:k.id},workspace:{width:i.width,height:i.height,scale:i.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:w,totalPages:n.length}},x=w?"save-progress":"save",V=await fetch(`/api/canvas/projects/${h.id}/${x}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:$,thumbnails:b})});if(!V.ok){const P=await V.json().catch(()=>({}));throw new Error(P.message||"Error al guardar el proyecto")}const R=await V.json();if(console.log(`✅ [SAVE] ${w?"Auto-guardado":"Guardado"} exitoso:`,R),!w&&b&&Object.keys(b).length>0){console.log("🖼️ [SAVE] Guardando thumbnails como archivos...");try{await Jn(h.id,b),console.log("✅ [SAVE] Thumbnails guardados como archivos")}catch(P){console.warn("⚠️ [SAVE] Error guardando thumbnails como archivos:",P)}}return{success:!0,data:R}}catch(N){return console.error(`❌ [SAVE] Error en ${w?"auto-guardado":"guardado"}:`,N),{success:!1,error:N.message}}},Kn=(n,h,g,k,i,b)=>{const[w,N]=d.useState("saved"),[$,x]=d.useState(null),[V,R]=d.useState(null),[P,O]=d.useState(null),[E,_]=d.useState(!1),[F,q]=d.useState(navigator.onLine),B=d.useRef(null),T=d.useRef(null),z=d.useRef(null),te=d.useRef(!1),D=d.useRef(null),he=15e3,r=2e3,oe=5e3,c=d.useCallback((A,K)=>{try{const L={pages:A.map(se=>{var De;return{id:se.id,layout:se.layout,cells:((De=se.cells)==null?void 0:De.map(et=>{var fe;return{id:et.id,elements:((fe=et.elements)==null?void 0:fe.map(re=>{var ue;return{id:re.id,type:re.type,content:re.type==="image"&&((ue=re.content)!=null&&ue.startsWith("data:image/"))?`[IMAGE_${re.content.length}]`:re.content,position:re.position,size:re.size,style:re.style,filters:re.filters,rotation:re.rotation}}))||[]}}))||[]}})||[],workspace:{width:K==null?void 0:K.width,height:K==null?void 0:K.height}};return btoa(JSON.stringify(L)).substring(0,32)}catch(L){return console.warn("⚠️ [AUTO-SAVE] Error generando hash:",L),Date.now().toString()}},[]),ee=d.useCallback(()=>`album_editor_autosave_${(h==null?void 0:h.id)||"draft"}`,[h==null?void 0:h.id]),de=d.useCallback(A=>{try{const K=ee(),L={...A,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(K,JSON.stringify(L)),console.log("💾 [AUTO-SAVE] Guardado en localStorage"),!0}catch(K){return console.error("❌ [AUTO-SAVE] Error guardando en localStorage:",K),!1}},[ee]),Fe=d.useCallback(()=>{var A;try{const K=ee(),L=localStorage.getItem(K);if(L){const se=JSON.parse(L);return console.log("📂 [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(A=se.pages)==null?void 0:A.length,savedAt:new Date(se.savedAt).toLocaleString()}),se}}catch(K){console.error("❌ [AUTO-SAVE] Error cargando desde localStorage:",K)}return null},[ee]),H=d.useCallback(async(A=!1)=>{if(te.current&&!A){console.log("⏳ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(h!=null&&h.id)||!n||n.length===0){console.log("⚠️ [AUTO-SAVE] Datos insuficientes para guardar");return}const K=c(n,i);if(!A&&K===z.current){console.log("📊 [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{te.current=!0,N("saving"),O(null);const L={pages:n,projectInfo:{id:h.id,item_id:g==null?void 0:g.id,title:g==null?void 0:g.title,preset_id:k==null?void 0:k.id},workspace:i,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:K}};if(de(L),F){const se=await Us(n,h,g,k,i,b,!0);if(se.success)z.current=K,R(new Date),N("saved"),_(!1),console.log("✅ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(se.error)}else console.log("� [AUTO-SAVE] Sin conexión, solo guardado en localStorage"),N("pending"),_(!0)}catch(L){console.error("❌ [AUTO-SAVE] Error:",L),O(L.message),N("error"),F&&(D.current=setTimeout(()=>{console.log("🔄 [AUTO-SAVE] Reintentando guardado..."),H(!0)},oe))}finally{te.current=!1}},[n,h,g,k,i,b,c,de,F]),xe=d.useCallback(async()=>{try{N("saving");const A=await Us(n,h,g,k,i,b,!1);if(A.success){const K=c(n,i);z.current=K,x(new Date),N("saved"),_(!1),X.success("💾 Proyecto guardado exitosamente"),console.log("✅ [MANUAL-SAVE] Guardado manual exitoso")}else O(A.error),N("error"),X.error(`❌ Error al guardar: ${A.error}`);return A.success}catch(A){return console.error("❌ [MANUAL-SAVE] Error:",A),O(A.message),N("error"),X.error(`❌ Error inesperado: ${A.message}`),!1}},[n,h,g,k,i,b,c]);return d.useEffect(()=>{if(!(h!=null&&h.id)||!n||n.length===0)return;const A=c(n,i);return z.current&&A!==z.current?(console.log("🔄 [AUTO-SAVE] Cambios detectados, programando guardado..."),_(!0),N("pending"),T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{H()},r)):z.current||(z.current=A),()=>{T.current&&clearTimeout(T.current)}},[n,i,h==null?void 0:h.id,c,H]),d.useEffect(()=>{if(h!=null&&h.id)return B.current&&clearInterval(B.current),B.current=setInterval(()=>{E&&(console.log("⏰ [AUTO-SAVE] Auto-save periódico activado"),H())},he),()=>{B.current&&clearInterval(B.current)}},[h==null?void 0:h.id,E,H]),d.useEffect(()=>{const A=()=>{console.log("🌐 [AUTO-SAVE] Conexión restaurada"),q(!0),E&&setTimeout(()=>H(!0),1e3)},K=()=>{console.log("📴 [AUTO-SAVE] Conexión perdida"),q(!1)};return window.addEventListener("online",A),window.addEventListener("offline",K),()=>{window.removeEventListener("online",A),window.removeEventListener("offline",K)}},[E,H]),d.useEffect(()=>{const A=K=>{if(E){const L={pages:n,projectInfo:{id:h.id},workspace:i,meta:{savedAt:new Date().toISOString()}};return de(L),K.preventDefault(),K.returnValue="¿Estás seguro de salir? Hay cambios sin guardar.","¿Estás seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",A),()=>window.removeEventListener("beforeunload",A)},[E,n,h==null?void 0:h.id,i,de]),d.useEffect(()=>()=>{T.current&&clearTimeout(T.current),B.current&&clearInterval(B.current),D.current&&clearTimeout(D.current)},[]),d.useEffect(()=>{P&&(P.includes("max_allowed_packet")||P.includes("data_too_large")?X.error("❌ El proyecto es demasiado grande para guardar automáticamente. Reduce el número o tamaño de imágenes."):X.error(`❌ Error de auto-guardado: ${P}`))},[P]),{saveStatus:w,lastSaved:$,lastAutoSaved:V,saveError:P,hasUnsavedChanges:E,isOnline:F,saveManually:xe,performAutoSave:()=>H(!0),loadFromLocalStorage:Fe,getStorageKey:ee,autoSaveInterval:he,debounceDelay:r}},Yn=({saveStatus:n,lastSaved:h,lastAutoSaved:g,hasUnsavedChanges:k,isOnline:i,saveError:b,onManualSave:w,className:N=""})=>{const $=R=>{if(!R)return null;const O=new Date-R,E=Math.floor(O/(1e3*60)),_=Math.floor(O/1e3);if(_<30)return"hace unos segundos";if(E<1)return`hace ${_}s`;if(E<60)return`hace ${E}m`;const F=Math.floor(E/60);return F<24?`hace ${F}h`:R.toLocaleDateString()},V=(()=>{if(!i)return{icon:e.jsx(Ms,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexión",detail:"Guardado local activo"};switch(n){case"saving":return{icon:e.jsx(kn,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(zs,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:g?`Auto-guardado ${$(g)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(Fs,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:b||"Error desconocido"};case"pending":return{icon:e.jsx(Cn,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:k?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(Rs,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${N}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${V.bg} ${V.color}
                    hover:shadow-md
                `,onClick:()=>n!=="saving"&&(w==null?void 0:w()),children:[V.icon,e.jsx("span",{className:"text-sm font-medium",children:V.text}),k&&n!=="saving"&&e.jsx("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-pulse"}),e.jsx("div",{className:"flex items-center",children:i?e.jsx(Vn,{className:"w-3 h-3 text-green-500"}):e.jsx(Ms,{className:"w-3 h-3 text-orange-500"})})]}),e.jsxs("div",{className:`
                absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2
                bg-gray-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg
                opacity-0 group-hover:opacity-100 pointer-events-none
                transition-opacity duration-200 z-50 whitespace-nowrap
            `,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:V.text}),e.jsx("div",{className:"text-gray-300",children:V.detail}),h&&e.jsxs("div",{className:"text-gray-400 text-xs",children:["Último guardado manual: ",$(h)]}),e.jsxs("div",{className:"text-gray-400 text-xs",children:[i?"🌐 En línea":"📴 Sin conexión",n!=="saving"&&" • Click para guardar"]})]}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"})]}),n==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},Xn=({isOpen:n,onClose:h,savedProgress:g,onLoadProgress:k,onDiscardProgress:i})=>{var V;const[b,w]=d.useState(!1);if(!n||!g)return null;const N=async()=>{w(!0);try{await k(g),h()}catch(R){console.error("Error cargando progreso:",R)}finally{w(!1)}},$=async()=>{w(!0);try{await i(),h()}catch(R){console.error("Error descartando progreso:",R)}finally{w(!1)}},x=R=>{const P=new Date(R),E=new Date-P,_=Math.floor(E/(1e3*60)),F=Math.floor(_/60),q=Math.floor(F/24);return _<1?"hace unos segundos":_<60?`hace ${_} minutos`:F<24?`hace ${F} horas`:q===1?"ayer":q<7?`hace ${q} días`:P.toLocaleDateString()};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 p-6 border-b border-gray-200",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(mn,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Progreso Guardado Encontrado"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Se encontró un trabajo sin finalizar"})]})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Un,{className:"w-4 h-4 text-gray-400 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Guardado automáticamente"}),e.jsx("div",{className:"text-xs text-gray-500",children:x(g.savedAt)})]})]}),g.pages&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Sn,{className:"w-4 h-4 text-gray-400 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[g.pages.length," páginas en progreso"]}),e.jsx("div",{className:"text-xs text-gray-500",children:((V=g.meta)==null?void 0:V.version)||"Versión no especificada"})]})]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Fs,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-amber-800",children:[e.jsx("div",{className:"font-medium mb-1",children:"¿Qué te gustaría hacer?"}),e.jsx("div",{className:"text-amber-700",children:"Puedes continuar desde donde lo dejaste o comenzar un nuevo diseño."})]})]})})]}),e.jsxs("div",{className:"flex gap-3 p-6 border-t border-gray-200",children:[e.jsxs("button",{onClick:N,disabled:b,className:`flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium 
                                 flex items-center justify-center gap-2 transition-colors disabled:opacity-50`,children:[b?e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}):e.jsx(zs,{className:"w-4 h-4"}),"Continuar Editando"]}),e.jsxs("button",{onClick:$,disabled:b,className:`flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2.5 rounded-lg font-medium 
                                 flex items-center justify-center gap-2 transition-colors disabled:opacity-50`,children:[e.jsx(yt,{className:"w-4 h-4"}),"Comenzar de Nuevo"]})]}),e.jsx("button",{onClick:h,className:"absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors",disabled:b,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})};function Ke(n,h){let g;return function(...i){const b=()=>{clearTimeout(g),n(...i)};clearTimeout(g),g=setTimeout(b,h)}}const xt=bt.memo(({pageId:n,thumbnail:h,altText:g,type:k})=>{const[i,b]=d.useState(!1),[w,N]=d.useState(!1);if(h&&!w)return e.jsxs("div",{className:"relative w-full h-full",children:[!i&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:h,alt:g,className:`w-full h-full object-contain transition-opacity duration-200 ${i?"opacity-100":"opacity-0"}`,onLoad:()=>b(!0),onError:()=>N(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const $=k==="cover"||k==="final"?Ye:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((x,V)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},V))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx($,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(n,h)=>n.pageId===h.pageId&&n.thumbnail===h.thumbnail&&n.altText===h.altText&&n.type===h.type),Zn=bt.memo(({images:n,onImageSelect:h,isLoading:g})=>{const k=bt.memo(({image:i})=>{const[b,w]=d.useState(!1),[N,$]=d.useState(!1),[x,V]=d.useState(!1),[{isDragging:R},P]=Mn(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:i.url},collect:q=>({isDragging:!!q.isDragging()}),end:()=>{setTimeout(()=>V(!1),100)}})),O=i.thumbnail_url||i.url,E=i.url,_=q=>{V(!0),setTimeout(()=>V(!1),500)},F=q=>{if(x||R)return q.preventDefault(),q.stopPropagation(),!1;h(E)};return e.jsxs("div",{ref:P,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${R?"opacity-50 scale-95":""}`,onMouseDown:_,onClick:F,children:[e.jsxs("div",{className:"aspect-square relative",children:[!b&&!N&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),N?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Ie,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:O,alt:i.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${b?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>w(!0),onError:()=>$(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(Xe,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:i.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),i.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return g?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((i,b)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},b))}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ie,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay imágenes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:n.map((i,b)=>e.jsx(k,{image:i},`${i.id||i.url}-${b}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[n.filter(i=>i.has_thumbnail).length," de ",n.length," imágenes optimizadas"]})})]})});function Da(){var zt,Ft,Vt,Gt,Bt,Ht,Wt,qt,Qt,Jt,Kt,Yt,Xt,Zt,Dt,es,ts,ss,ns,as,os,rs,is,ls,cs,ds,us,gs,ms,hs,fs,ps,xs,bs,ys,vs,ws,js,Es,Ns;const[n,h]=d.useState(null),[g,k]=d.useState(null),[i,b]=d.useState(null),[w,N]=d.useState(null),[$,x]=d.useState(!0),[V,R]=d.useState(null),[P,O]=d.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[E,_]=d.useState(new Map),[F,q]=d.useState([]),[B,T]=d.useState(!1),z=d.useRef(F),te=d.useRef(E);d.useRef(null),d.useEffect(()=>{z.current=F},[F]),d.useEffect(()=>{te.current=E},[E]),d.useEffect(()=>{(async()=>{var s;try{const o=new URLSearchParams(window.location.search).get("project");if(!o){R("No se encontró el ID del proyecto en la URL"),x(!1);return}const l=await fetch(`/api/canvas/projects/${o}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!l.ok)throw new Error("Error al cargar el proyecto");const u=await l.json();h(u.project),k(u.item),b(u.canvasPreset),N(u.initialProject),x(!1)}catch(a){console.error("❌ Error cargando proyecto:",a),R(a.message),x(!1)}})()},[]);const[D,he]=d.useState(Ts.Local.get(`${Is.APP_CORRELATIVE}_cart`)??[]);d.useEffect(()=>{Ts.Local.set(`${Is.APP_CORRELATIVE}_cart`,D)},[D]);const[r,oe]=d.useState([]),[c,ee]=d.useState(0),[de,Fe]=d.useState("preset"),[H,xe]=d.useState(null),[A,K]=d.useState(null),[L,se]=d.useState("pages"),[De,et]=d.useState("basic"),[fe,re]=d.useState([JSON.stringify(r)]),[ue,Se]=d.useState(0),[Bs,Dn]=d.useState(!1),[ea,vt]=d.useState(null),[Z,ae]=d.useState({}),[ta,sa]=d.useState(!1),[be,Ce]=d.useState([]),[tt,wt]=d.useState(!1),[Ve,Hs]=d.useState(new Map),[Oe,Ws]=d.useState(()=>new Map),[$e,Ge]=d.useState(null);d.useEffect(()=>{console.log("🔍 [DEBUG] ActiveTab cambió a:",L),L==="filters"&&console.trace("🔍 [DEBUG] Stack trace del cambio a filters:")},[L]);const ke=d.useRef(null),[Be,Ue]=d.useState(!1),jt=d.useRef(),[U,Et]=d.useState({width:800,height:600}),st=d.useCallback(async()=>{if(n!=null&&n.id)try{const t=await fetch(`/api/thumbnails/${n.id}`);if(t.ok){const s=await t.json();if(s.success&&s.thumbnails&&s.thumbnails.length>0){const a={};s.thumbnails.forEach(o=>{o.page_id&&o.thumbnail_url&&(a[o.page_id]=o.thumbnail_url)}),Object.keys(a).length>0?(ae(o=>({...o,...a})),console.log("✅ Thumbnails cargados desde storage:",Object.keys(a).length)):console.log("ℹ️ No hay thumbnails guardados, usando generación local")}else console.log("ℹ️ No hay thumbnails guardados para este proyecto")}}catch(t){console.warn("⚠️ Error cargando thumbnails guardados (usando locales):",t)}},[n==null?void 0:n.id]),ge=d.useCallback(async()=>{if(!r[c]||!U)return;const t=r[c];if(Z[t.id]){console.log(`✅ Thumbnail ya existe para página: ${t.id}`);return}if(ye.current){console.log("⏳ Ya se está generando un thumbnail...");return}ye.current=!0;try{console.log(`📸 Generando thumbnail para página actual: ${t.id}`);const s=await Wn({page:t,workspaceDimensions:U,onProgress:a=>{Ge(a)}});s&&(ae(a=>({...a,[t.id]:s})),console.log(`✅ Thumbnail generado para página: ${t.id}`))}catch(s){console.warn("⚠️ Error generando thumbnail de página actual:",s)}finally{ye.current=!1,Ge(null)}},[r,c,U,Z]),nt=d.useCallback(Ke(async()=>{if(!(!(r!=null&&r.length)||!U)){if(ye.current){console.log("⏳ Thumbnails ya se están generando, saltando...");return}ye.current=!0;try{const t=r.filter(a=>!Z[a.id]);if(t.length===0){console.log("✅ Todos los thumbnails ya existen");return}console.log(`📸 Generando ${t.length} thumbnails rápidos...`);const s=await Os({pages:t,workspaceDimensions:U,onProgress:a=>{Ge(a)}});s&&Object.keys(s).length>0&&(ae(a=>({...a,...s})),console.log("✅ Thumbnails rápidos generados:",Object.keys(s).length))}catch(t){console.warn("⚠️ Error generando thumbnails rápidos:",t)}finally{ye.current=!1,Ge(null)}}},300),[r,U,Z]),ye=d.useRef(!1);d.useCallback(async(t=[])=>{if(!ye.current)try{if(ye.current=!0,t.length>0){const s=r.filter(a=>t.includes(a.id));if(s.length>0){console.log(`🎯 Generando ${s.length} thumbnails prioritarios...`);const a=await Os({pages:s,workspaceDimensions:U});a&&Object.keys(a).length>0&&ae(o=>({...o,...a}))}}}catch(s){console.warn("⚠️ Error en generación prioritaria:",s)}finally{ye.current=!1}},[r,U,nt]);const Nt=d.useCallback(t=>{if(Oe.has&&Oe.has(t))return;const s=new Image;s.crossOrigin="anonymous",s.onload=()=>{if(s.width>1200||s.height>1200){const o=document.createElement("canvas"),l=o.getContext("2d"),u=1200,f=Math.min(u/s.width,u/s.height),m=s.width*f,p=s.height*f;o.width=m,o.height=p,l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",l.drawImage(s,0,0,m,p),o.toBlob(v=>{if(v){const j=URL.createObjectURL(v);Ws(S=>{const I=new Map(S);if(I.set(t,j),I.size>15){const y=I.keys().next().value,C=I.get(y);URL.revokeObjectURL(C),I.delete(y)}return I})}},"image/webp",.85)}},s.onerror=()=>{console.warn("❌ Error pre-cargando imagen:",t)},s.src=t},[]);d.useEffect(()=>{be.length>0&&be.slice(0,10).forEach((s,a)=>{setTimeout(()=>{Nt(s.url)},a*100)})},[be,Nt]),d.useEffect(()=>()=>{Oe&&Oe.forEach&&Oe.forEach(t=>URL.revokeObjectURL(t))},[]),d.useEffect(()=>()=>{$s()},[]);const at=d.useCallback(async()=>{var t;if(!(!(n!=null&&n.id)||!(r!=null&&r.length)))try{const s=await fetch(`/api/thumbnails/${n.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:r})});if(s.ok){const a=await s.json();a&&Object.keys(a).length>0?(ae(o=>({...o,...a})),console.log("✅ Thumbnails existentes cargados:",Object.keys(a).length)):(console.log("📸 No hay thumbnails existentes, generando para página actual..."),setTimeout(()=>ge(),200))}}catch(s){console.warn("⚠️ Error cargando thumbnails existentes:",s),setTimeout(()=>ge(),200)}},[n==null?void 0:n.id,r,ge]);d.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(r!=null&&r.length)))try{const t=r[c];if(!t)return;const s=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:U.width,height:U.height,quality:95,scale:4,dpi:300})});if(s.ok){const a=await s.json();if(a.success&&a.thumbnails){const o={};a.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(o[l.page_id]=l.thumbnail_url)}),ae(l=>({...l,...o})),console.log("✅ Thumbnail generado y guardado en storage para página actual:",a.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando thumbnail:",t)}},[n==null?void 0:n.id,r,c,U]),d.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(r!=null&&r.length)))try{const t=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:r,width:U.width,height:U.height,quality:95,scale:4,dpi:300})});if(t.ok){const s=await t.json();if(s.success&&s.thumbnails){const a={};s.thumbnails.forEach(o=>{o.page_id&&o.thumbnail_url&&(a[o.page_id]=o.thumbnail_url)}),ae(o=>({...o,...a})),console.log("✅ Todos los thumbnails generados y guardados en storage:",s.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando todos los thumbnails:",t)}},[n==null?void 0:n.id,r,U]),d.useEffect(()=>{if(w&&g&&i){if(w.pages&&Array.isArray(w.pages)){const t=w.pages.map(s=>{let a=null,o=i.background_color||"#ffffff";return s.type==="cover"?g.cover_image&&(a=`/storage/images/item/${g.cover_image}`):s.type==="content"?g.content_image&&(a=`/storage/images/item/${g.content_image}`):(s.type==="final"||s.type==="contraportada")&&g.back_cover_image&&(a=`/storage/images/item/${g.back_cover_image}`),{...s,backgroundImage:a,backgroundColor:o}});oe(s=>s.length>0?(console.log("⚠️ Páginas ya existentes, preservando cambios del usuario"),s.map((a,o)=>{const l=t[o];return l?{...a,backgroundImage:a.backgroundImage||l.backgroundImage,backgroundColor:a.backgroundColor||l.backgroundColor}:a})):(console.log("📄 Carga inicial de páginas desde la base de datos"),t)),re(s=>s.length<=1?[JSON.stringify(t)]:s),Se(s=>s===0&&fe.length<=1?0:s),setTimeout(()=>{st()},100)}else{const t=$t(i,g);oe(t),re([JSON.stringify(t)]),Se(0),setTimeout(()=>{st()},100)}typeof w.currentPage=="number"&&ee(w.currentPage),w.workspaceSize&&Fe(w.workspaceSize)}},[w,g,i,st]);const ve=Kn(r,n,g,i,U,Z),St=()=>{if(i!=null&&i.width&&(i!=null&&i.height)){let m=i.width,p=i.height,v=m*37.8,j=p*37.8;if(v&&j){const S=window.innerWidth*.6,I=window.innerHeight*.7,y=S/v,C=I/j,M=Math.min(y,C,1);return{width:Math.round(v*M),height:Math.round(j*M),originalWidth:m,originalHeight:p,scale:M,unit:"cm",originalWidthPx:Math.round(v),originalHeightPx:Math.round(j)}}}if(i!=null&&i.extra_settings)try{const m=typeof i.extra_settings=="string"?JSON.parse(i.extra_settings):i.extra_settings;if(m!=null&&m.canvas_config){const p=m.canvas_config;let v=p.width,j=p.height,S=v*37.8,I=j*37.8;if(S&&I){const y=window.innerWidth*.6,C=window.innerHeight*.7,M=y/S,G=C/I,Y=Math.min(M,G,1);return{width:Math.round(S*Y),height:Math.round(I*Y),originalWidth:v,originalHeight:j,scale:Y,unit:"cm",originalWidthPx:Math.round(S),originalHeightPx:Math.round(I)}}}}catch(m){console.warn("Error parsing extra_settings:",m)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},s=t[de]||t.preset,a=window.innerWidth*.6,o=window.innerHeight*.7,l=a/s.width,u=o/s.height,f=Math.min(l,u,1);return{width:Math.round(s.width*f),height:Math.round(s.height*f),originalWidth:s.width,originalHeight:s.height,scale:f,unit:"px"}},we=d.useCallback(async(t={type:"thumbnail"})=>{if(!r[c])return null;try{let s=document.querySelector(`#page-${r[c].id}`);if(!s)return console.warn("❌ THUMBNAIL: No se encontró el elemento de página específico"),null;const a=r[c],o=t.type==="pdf",l=o?11.81:3,u=1,f=getComputedStyle(s);let m=(a==null?void 0:a.backgroundColor)||"#ffffff";f.backgroundColor&&f.backgroundColor!=="rgba(0, 0, 0, 0)"&&(m=f.backgroundColor);const p={scale:l,useCORS:!0,allowTaint:!1,backgroundColor:m,width:U.width,height:U.height,x:0,y:0,scrollX:0,scrollY:0,foreignObjectRendering:!!o,removeContainer:!1,logging:!1,imageTimeout:o?6e4:15e3,pixelRatio:o?3:window.devicePixelRatio||1,canvas:o?document.createElement("canvas"):null,windowWidth:o?U.width*l:null,windowHeight:o?U.height*l:null,onclone:async S=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(y=>{try{S.querySelectorAll(y).forEach(M=>M.remove())}catch(C){console.warn("Error removing selector:",y,C)}});try{const y=S.querySelector(`#page-${r[c].id}`);y&&(y.style.width=U.width+"px",y.style.height=U.height+"px",y.style.position="relative",y.style.overflow="hidden",a!=null&&a.backgroundImage&&(y.style.backgroundImage=`url(${a.backgroundImage})`,y.style.backgroundSize="cover",y.style.backgroundPosition="center",y.style.backgroundRepeat="no-repeat"),a!=null&&a.backgroundColor&&(y.style.backgroundColor=a.backgroundColor))}catch(y){console.error("❌ [THUMBNAIL-FIX] Error configurando elemento de página:",y)}try{const y=new Map;s.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((Q,je)=>{if(Q.complete&&Q.naturalWidth>0){const ce=(Q.closest('[data-element-type="image"]')||Q.parentElement).getBoundingClientRect(),pe=Q.getBoundingClientRect();y.set(Q.src,{src:Q.src,naturalWidth:Q.naturalWidth,naturalHeight:Q.naturalHeight,containerWidth:ce.width,containerHeight:ce.height,objectFit:getComputedStyle(Q).objectFit||"cover",objectPosition:getComputedStyle(Q).objectPosition||"center",crossOrigin:Q.crossOrigin})}});const M=async(Q,je,ie,ce,pe)=>new Promise(Ae=>{try{const Te=je/ie,gt=ce/pe;let We,qe,mt,ht,Ss,Cs;gt>Te?(Cs=ie,Ss=ie*gt,qe=pe,We=pe*Te,mt=(ce-We)/2,ht=0):(Ss=je,Cs=je/gt,We=ce,qe=ce/Te,mt=0,ht=(pe-qe)/2);const Qe=S.createElement("canvas");Qe.width=je,Qe.height=ie;const un=Qe.getContext("2d"),ze=new Image;ze.crossOrigin="anonymous",ze.onload=()=>{try{un.drawImage(ze,mt,ht,We,qe,0,0,je,ie);const ft=Qe.toDataURL("image/png",1);Q.src=ft,Q.style.objectFit="fill",Q.style.objectPosition="center",Q.style.width="100%",Q.style.height="100%",Ae()}catch(ft){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en canvas processing:",ft),Ae()}},ze.onerror=()=>{console.warn("⚠️ [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),Ae()},ze.src=Q.src}catch(Te){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",Te),Ae()}}),G=S.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),Y=[];G.forEach((Q,je)=>{if(Q.src&&y.has(Q.src)){const ie=y.get(Q.src),ce=Q.closest('[data-element-type="image"]')||Q.parentElement;if(ce&&(ce.style.overflow="hidden",ce.style.position="relative"),ie.objectFit==="cover"||Q.classList.contains("object-cover")||Q.classList.contains("workspace-image")){const pe=M(Q,ie.containerWidth,ie.containerHeight,ie.naturalWidth,ie.naturalHeight);Y.push(pe)}else Q.style.width="100%",Q.style.height="100%",Q.style.objectFit="fill"}}),Y.length>0&&await Promise.all(Y);const W=S.createElement("style");W.textContent=`
                            /* CORRECCIÓN THUMBNAIL: Estructura del elemento de página */
                            #page-${r[c].id} {
                                width: ${U.width}px !important;
                                height: ${U.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* 🖨️ IMÁGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya están recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${o?`
                                /* 🖨️ IMPRESIÓN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de página */
                            #page-${r[c].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* 🖨️ OPTIMIZACIONES GENERALES PARA PDF DE IMPRESIÓN */
                            ${o?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,S.head.appendChild(W)}catch(y){console.error("❌ [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",y);const C=S.createElement("style");C.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,S.head.appendChild(C)}}},v=await As(s,p);if(o&&v){const S=v.getContext("2d");if(S){S.imageSmoothingEnabled=!1,S.imageSmoothingQuality="high";const I=S.getImageData(0,0,v.width,v.height),y=I.data;for(let C=0;C<y.length;C+=4)y[C]=Math.min(255,y[C]*1.05),y[C+1]=Math.min(255,y[C+1]*1.05),y[C+2]=Math.min(255,y[C+2]*1.05);S.putImageData(I,0,0)}}if(!v)throw new Error("html2canvas no devolvió un canvas válido para el elemento de página");if(v.width===0||v.height===0)throw new Error("Canvas del elemento de página tiene dimensiones inválidas");const j=v.toDataURL("image/png",u);if(!j||j==="data:,")throw new Error("No se pudo generar dataURL del elemento de página");return o?v:j}catch(s){console.error("❌ [THUMBNAIL-FIX] Error capturando elemento de página:",s);try{const a=document.createElement("canvas"),o=t.type==="pdf"?11.81:1;a.width=U.width*o,a.height=U.height*o;const l=a.getContext("2d"),u=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return l.fillStyle=u,l.fillRect(0,0,a.width,a.height),l.fillStyle=u==="#ffffff"||u.includes("white")?"#374151":"#666666",l.font=`${14*o}px Arial`,l.textAlign="center",l.fillText("Página "+(c+1),a.width/2,a.height/2),t.type==="pdf"?a:a.toDataURL("image/png",1)}catch{return null}}},[c,r]);d.useCallback(async()=>{if(!r[c])return;const t=await we({type:"thumbnail"});t&&ae(s=>({...s,[r[c].id]:t}))},[we,c,r]),d.useCallback(()=>{clearTimeout(jt.current),jt.current=setTimeout(()=>{r[c]&&(ae(t=>{const s={...t};return delete s[r[c].id],s}),setTimeout(()=>{ge()},200))},1e3)},[r,c,ge]);const qs=d.useCallback(()=>{r[c]&&(ae(t=>{const s={...t};return delete s[r[c].id],s}),setTimeout(()=>{ge()},300))},[r,c,ge]),Qs=d.useCallback(async(t=c,s={width:800,height:600})=>{var a,o;if(!r[t])return null;try{const l=c;t!==c&&(ee(t),await new Promise(p=>setTimeout(p,100)));const u=document.querySelector(`#page-${r[t].id}`);if(!u)return console.warn("Workspace element not found for page:",r[t].id),null;const f={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((a=r[t])==null?void 0:a.backgroundColor)||"#ffffff",width:u.offsetWidth,height:u.offsetHeight,removeContainer:!0,logging:!1,onclone:p=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(y=>{p.querySelectorAll(y).forEach(M=>M.remove())});const j=p.querySelector(`#page-${r[t].id}`);if(j){const y=r[t];y!=null&&y.backgroundImage&&(j.style.backgroundImage=`url(${y.backgroundImage})`,j.style.backgroundSize="cover",j.style.backgroundPosition="center",j.style.backgroundRepeat="no-repeat"),y!=null&&y.backgroundColor&&(j.style.backgroundColor=y.backgroundColor)}try{const y=u.querySelectorAll("img"),C=new Map;y.forEach((G,Y)=>{const W=getComputedStyle(G);C.set(Y,{objectFit:W.objectFit,objectPosition:W.objectPosition,width:W.width,height:W.height,borderRadius:W.borderRadius,transform:W.transform})}),p.querySelectorAll("img").forEach((G,Y)=>{const W=C.get(Y);W&&(G.style.objectFit=W.objectFit||"cover",G.style.objectPosition=W.objectPosition||"center",G.style.width=W.width,G.style.height=W.height,G.style.borderRadius=W.borderRadius,G.style.transform=W.transform)})}catch(y){console.warn("Error preservando estilos de imágenes:",y),p.querySelectorAll("img").forEach(M=>{M.style.objectFit="cover",M.style.objectPosition="center",M.style.width||(M.style.width="100%"),M.style.height||(M.style.height="100%")})}p.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(y=>{const C=y.className;C&&(y.className=C);const M=getComputedStyle?getComputedStyle(y):null;M&&(M.fontFamily&&M.fontFamily!=="Arial"&&(y.style.fontFamily=M.fontFamily),M.fontSize&&(y.style.fontSize=M.fontSize),M.fontWeight&&(y.style.fontWeight=M.fontWeight),M.fontStyle&&(y.style.fontStyle=M.fontStyle))});const I=p.createElement("style");I.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CRÍTICO: Asegurar que las imágenes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CRÍTICO: Asegurar que los backgrounds de página se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,p.head.appendChild(I)}},m=await As(u,f);if(s.width!==m.width||s.height!==m.height){const p=document.createElement("canvas");p.width=s.width,p.height=s.height;const v=p.getContext("2d"),j=m.width/m.height,S=s.width/s.height;let I,y,C=0,M=0;j>S?(I=s.width,y=s.width/j,M=(s.height-y)/2):(y=s.height,I=s.height*j,C=(s.width-I)/2),v.fillStyle=((o=r[t])==null?void 0:o.backgroundColor)||"#ffffff",v.fillRect(0,0,s.width,s.height),v.drawImage(m,C,M,I,y);const G=p.toDataURL("image/png",1);return t!==l&&ee(l),G}return t!==l&&ee(l),m.toDataURL("image/png",1)}catch(l){return console.error("❌ Error generando thumbnail de alta calidad:",l),null}},[r,c,ee]);d.useEffect(()=>{const t=St();Et(t)},[i,de]),d.useEffect(()=>{const t=()=>{const s=St();Et(s)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[i,de]),d.useEffect(()=>{if(r[c]&&!Z[r[c].id]){const t=setTimeout(()=>{ge()},500);return()=>clearTimeout(t)}},[c,r,Z,ge]),d.useEffect(()=>{const t=r[c];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(s=>{s.ok?console.log("✅ [WORKSPACE] Imagen existe en el servidor"):console.error("❌ [WORKSPACE] Imagen NO existe en el servidor. Status:",s.status)}).catch(s=>{console.error("❌ [WORKSPACE] Error verificando imagen:",s)})},[c,(zt=r[c])==null?void 0:zt.backgroundImage]),d.useEffect(()=>{const t=`${U.width}x${U.height}`,s=sessionStorage.getItem("lastWorkspaceDimensions");s&&s!==t&&r.length>0&&(ae({}),setTimeout(()=>{r[c]&&qs()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[U.width,U.height]),d.useEffect(()=>{if(!(n!=null&&n.id)||r.length===0)return;let t,s=Date.now(),a=!1;const o=()=>{a=!0,s=Date.now()},l=async()=>{if(a)try{console.log("🔄 [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(p=>({...p,saveStatus:"saving"}));const f=await fetch(`/api/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:r,force:!1})}),m=await f.json();if(f.ok&&m.success)a=!1,O(p=>({...p,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("✅ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado falló")}catch(f){console.error("❌ [AUTO-SAVE] Error en guardado silencioso:",f),O(m=>({...m,saveStatus:"error",saveError:f.message}))}},u=()=>{t=setInterval(()=>{const f=Date.now()-s;a&&f>6e4&&(console.log("⏰ [AUTO-SAVE] Condiciones cumplidas para guardado automático"),l())},3*60*1e3)};return JSON.stringify(r),r[c],o(),u(),()=>{t&&clearInterval(t)}},[r,c,n==null?void 0:n.id]),d.useEffect(()=>{var s;if(!r[c])return;const t=((s=r[c].cells)==null?void 0:s.flatMap(a=>a.elements))||[];JSON.stringify(t),O(a=>({...a,hasUnsavedChanges:!0}))},[(Ft=r[c])==null?void 0:Ft.cells,c]);const[na,ot]=d.useState(!1),[aa,Js]=d.useState({elementId:null,cellId:null}),[Ks,Ct]=d.useState(!1),[Ys,kt]=d.useState(!1),[Xs,Zs]=d.useState(null),rt=d.useRef(null),At=t=>{var o,l,u,f;const s=A||((l=(o=r[c])==null?void 0:o.cells[0])==null?void 0:l.id);if(!s)return;const a={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((f=(u=r[c].cells.find(m=>m.id===s))==null?void 0:u.elements)==null?void 0:f.length)||0)+1};Re(s,a),X.success("Imagen añadida correctamente")},it=d.useCallback(Ke(async(t=!1)=>{if(!(n!=null&&n.id))return;const s=Ve.get(n.id);if(!t&&s&&s.length>0){console.log("🔄 Usando imágenes desde cache"),be.length===0&&Ce(s);return}if(ke.current&&clearTimeout(ke.current),tt&&!t){console.log("⏳ Carga de imágenes ya en progreso");return}wt(!0);try{const a=new AbortController,o=setTimeout(()=>a.abort(),1e4),l=await fetch(`/api/canvas/projects/${n.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:a.signal});if(clearTimeout(o),!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);const u=await l.json();if(u.success){const f=u.images||[],m=JSON.stringify(be),p=JSON.stringify(f);m!==p&&(Ce(f),Hs(v=>{const j=new Map(v);if(j.set(n.id,f),j.size>5){const S=j.keys().next().value;j.delete(S)}return j}))}else console.error("Error cargando imágenes:",u.message),X.error("Error cargando galería de imágenes")}catch(a){a.name==="AbortError"?console.warn("⚠️ Carga de imágenes cancelada por timeout"):(console.error("Error cargando imágenes del proyecto:",a),X.error("Error de conexión al cargar imágenes"))}finally{wt(!1)}},200),[n==null?void 0:n.id,Ve,be,tt]),Ds=d.useCallback(async t=>{const s=t.target.files[0];if(!s||!(n!=null&&n.id))return;const a=X.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),o=URL.createObjectURL(s),l={id:`temp-${Date.now()}`,filename:s.name,url:o,thumbnail_url:o,has_thumbnail:!1,size:s.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Ce(f=>[l,...f]),At(o);const u=new FormData;u.append("image",s),u.append("projectId",n.id);try{const m=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:u})).json();if(m.success){const p={id:m.id||Date.now(),filename:s.name,url:m.url,thumbnail_url:m.thumbnail_url||m.url,has_thumbnail:m.has_thumbnail||!1,size:s.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Ce(v=>[p,...v.filter(j=>j.id!==l.id)]),setTimeout(()=>{oe(v=>{const j=[...v];return j[c].cells.forEach(I=>{I.elements.forEach(y=>{y.type==="image"&&y.content===o&&(y.content=m.url)})}),j})},100),X.dismiss(a),X.success(m.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{it(!0)},2e3)}else Ce(p=>p.filter(v=>v.id!==l.id)),URL.revokeObjectURL(o),X.dismiss(a),X.error(m.message||"Error al subir la imagen")}catch(f){console.error("Error subiendo la imagen:",f),Ce(m=>m.filter(p=>p.id!==l.id)),URL.revokeObjectURL(o),X.dismiss(a),X.error("Error de red al subir la imagen")}},[n==null?void 0:n.id,c,At,it]);d.useEffect(()=>{if(n!=null&&n.id){const t=Ve.get(n.id);if(t&&t.length>0){Ce(t);return}return ke.current=setTimeout(()=>{it(!1)},150),()=>{ke.current&&clearTimeout(ke.current)}}},[n==null?void 0:n.id,Ve]),d.useEffect(()=>()=>{ke.current&&clearTimeout(ke.current)},[]);const Tt=(t,s)=>{if(console.log("🖼️ [ADD-IMAGE] Agregando imagen sin selección automática"),!r||r.length===0||!r[c]){console.error("❌ [ADD-IMAGE] No hay páginas válidas para agregar imagen");return}const a=JSON.parse(JSON.stringify(r));let o=!1;for(let l=0;l<a[c].cells.length;l++)if(a[c].cells[l].id===t){a[c].cells[l].elements.push(s),o=!0,console.log("✅ [ADD-IMAGE] Imagen agregada a la celda:",t);break}if(!o){console.error("❌ [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{Le(a),console.log("✅ [ADD-IMAGE] Estado actualizado sin selección automática")},0)},en=d.useCallback(t=>{var f,m,p,v;console.log("🖼️ [ADD-FROM-GALLERY] Iniciando proceso de agregar imagen:",t);const s=Be;Ue(!0);const a=L==="images",o=A||((m=(f=r[c])==null?void 0:f.cells[0])==null?void 0:m.id);if(!o){console.error("❌ [ADD-FROM-GALLERY] No hay celda disponible"),X.error("No hay celda disponible para agregar la imagen"),Ue(s);return}if(!t||typeof t!="string"){console.error("❌ [ADD-FROM-GALLERY] URL de imagen inválida"),X.error("URL de imagen no válida"),Ue(s);return}const l=JSON.parse(JSON.stringify(r));console.log("📸 [ADD-FROM-GALLERY] Snapshot del estado actual capturado");const u={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((v=(p=l[c].cells.find(j=>j.id===o))==null?void 0:p.elements)==null?void 0:v.length)||0)+1};console.log("📝 [ADD-FROM-GALLERY] Elemento creado:",u),setTimeout(()=>{Tt(o,u),setTimeout(()=>{a&&(se("images"),console.log("🔄 [ADD-FROM-GALLERY] Tab restaurado a images")),setTimeout(()=>{Ue(s),X.success("✅ Imagen añadida desde la galería"),console.log("✅ [ADD-FROM-GALLERY] Proceso completado exitosamente")},50)},50)},50)},[L,A,r,c,Be,Tt]),It=d.useCallback(async(t,s)=>{var l,u;const a=[],o=[];for(const f of t){const m={...f};if(f.cells){m.cells=[];for(const p of f.cells){const v={...p};if(p.elements){v.elements=[];for(const j of p.elements)if(j.type==="image"&&((l=j.content)!=null&&l.startsWith("data:image/"))){const S=`${j.id}_${Date.now()}`,I=j.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(I){const y=I[1],C=I[2],G=`${S}.${y==="jpeg"?"jpg":y}`;o.push({filename:G,data:C,type:y,elementId:j.id}),v.elements.push({...j,content:j.content,_wasBase64:!0,_originalSize:j.content.length,_elementId:j.id})}else v.elements.push(j)}else v.elements.push(j)}m.cells.push(v)}}a.push(m)}if(o.length>0)try{const f=await fetch(`/api/canvas/projects/${s}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:o})});if(f.ok){const m=await f.json();if(m.uploadedImages){const p=new Map;m.uploadedImages.forEach(v=>{p.set(v.elementId,v.url)});for(const v of a)if(v.cells){for(const j of v.cells)if(j.elements)for(const S of j.elements)S._wasBase64&&S._elementId&&p.has(S._elementId)&&(S.content=p.get(S._elementId),delete S._elementId)}}}else{const m=await f.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("❌ [IMAGE-UPLOAD] Error subiendo imágenes:",m),t}}catch(f){return console.error("❌ [IMAGE-UPLOAD] Error de red subiendo imágenes:",f),t}return a},[]),_e=d.useCallback(async(t=r,s=!1)=>{var a;if(!(!(n!=null&&n.id)||!s&&t.length===0))try{const u={design_data:{pages:await It(t,n.id),currentPage:c,workspaceDimensions:U,workspaceSize:de,selectedElement:H,selectedCell:A,history:fe.slice(-5),historyIndex:Math.min(ue,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:n.id,name:(g==null?void 0:g.name)||"Álbum Personalizado",item_id:g==null?void 0:g.id,preset_id:i==null?void 0:i.id}},thumbnails:Z},m=JSON.stringify(u).length/(1024*1024),p=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(u)});if(p.ok){const v=await p.json(),j=`editor_progress_project_${n.id}`;return localStorage.removeItem(j),_(S=>{const I=new Map(S);return s?I.clear():I.delete(c),I}),r&&r.length>0&&setTimeout(()=>{ge().catch(S=>{console.warn("⚠️ Error regenerando thumbnail de página actual:",S)})},300),!0}else{const v=await p.json().catch(()=>({message:"Error desconocido"}));return console.error("❌ [AUTO-SAVE] Error guardando en BD:",v),!1}}catch(o){return console.error("❌ [AUTO-SAVE] Error en auto-save con procesamiento de imágenes:",o),!1}},[r,c,U,de,H,A,fe,ue,n==null?void 0:n.id,g==null?void 0:g.name,g==null?void 0:g.id,i==null?void 0:i.id,Z,It,nt]);d.useEffect(()=>{if(!(n!=null&&n.id))return;const t=setInterval(()=>{r.length>0&&_e(r,!1)},5*60*1e3);return()=>clearInterval(t)},[_e,r,n==null?void 0:n.id]),d.useCallback(async()=>{if(!r.length)return{};console.log("📸 [THUMBNAILS] Capturando thumbnails de todas las páginas...");const t={},s=c;try{for(let a=0;a<r.length;a++){const o=r[a];if(o!=null&&o.id)try{a!==c&&(ee(a),await new Promise(u=>setTimeout(u,300)));const l=await we({type:"thumbnail"});l&&(t[o.id]=l,console.log(`✅ [THUMBNAILS] Thumbnail capturado para página ${a+1}: ${o.id}`))}catch(l){console.warn(`⚠️ [THUMBNAILS] Error capturando thumbnail para página ${o.id}:`,l),Z[o.id]&&(t[o.id]=Z[o.id])}}return s!==c&&ee(s),console.log(`✅ [THUMBNAILS] Capturados ${Object.keys(t).length} thumbnails de ${r.length} páginas`),t}catch(a){return console.error("❌ [THUMBNAILS] Error capturando thumbnails:",a),s!==c&&ee(s),Z}},[r,c,ee,we,Z]);const tn=d.useCallback(async()=>{if(!(n!=null&&n.id)||r.length===0)return X.error("No hay datos para guardar"),!1;try{return console.log("📸 [SAVE] Generando thumbnail de página actual..."),await ge(),await at(),await _e(r,!0)?(X.success("Progreso guardado exitosamente"),!0):(X.error("Error al guardar el progreso"),!1)}catch(t){return console.error("❌ [SAVE] Error al guardar el progreso:",t),X.error("Error al guardar el progreso"),!1}},[_e,r,n==null?void 0:n.id,U,i,nt]),Pt=d.useCallback(async t=>{var s;if(console.log("💾 [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("🔍 [QUEUE-SAVE] Datos disponibles:",{projectId:n==null?void 0:n.id,pagesCount:t==null?void 0:t.length,currentPage:c,hasDimensions:!!U,hasThumbnails:!!Z}),!(n!=null&&n.id))return console.error("❌ [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return console.error("❌ [QUEUE-SAVE] No hay páginas para guardar"),!1;try{const o={design_data:{pages:t,currentPage:c,workspaceDimensions:U,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:Z};console.log("📤 [QUEUE-SAVE] Enviando petición al servidor...");const l=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(o)});if(console.log("📥 [QUEUE-SAVE] Respuesta del servidor:",l.status,l.statusText),l.ok){const u=await l.json();return console.log("✅ [QUEUE-SAVE] Guardado exitoso desde cola:",u),!0}else{const u=await l.text();return console.error("❌ [QUEUE-SAVE] Error en respuesta del servidor:",l.status,u),!1}}catch(a){return console.error("❌ [QUEUE-SAVE] Error guardando desde cola:",a),!1}},[n==null?void 0:n.id,c,U,Z]),lt=d.useCallback(async()=>{if(console.log("🔍 [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:B,saveQueueLength:F.length}),B){console.log("⚠️ [SAVE-QUEUE] Ya se está procesando, saltando...");return}if(F.length===0){console.log("⚠️ [SAVE-QUEUE] Cola vacía, no hay nada que procesar");return}console.log("🚀 [SAVE-QUEUE] Iniciando procesamiento de cola..."),T(!0);try{const t=F.slice();console.log("� [SAVE-QUEUE] Cola capturada para procesamiento:",t.length,"elementos"),q([]),console.log("🧹 [SAVE-QUEUE] Cola limpiada");for(const s of t)console.log("💾 [SAVE-QUEUE] Guardando página:",s.pageIndex),await Pt(s.pages)?(_(o=>{const l=new Map(o);return l.delete(s.pageIndex),l}),console.log("✅ [SAVE-QUEUE] Página guardada exitosamente:",s.pageIndex)):(console.error("❌ [SAVE-QUEUE] Error guardando página:",s.pageIndex),q(o=>[...o,s]));console.log("✅ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(t){console.error("❌ [SAVE-QUEUE] Error procesando cola:",t)}finally{T(!1),console.log("🔓 [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[B,F,Pt]);d.useEffect(()=>{console.log("🔄 [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:F.length,isProcessingQueue:B,shouldProcess:F.length>0&&!B}),F.length>0&&!B&&(console.log("⏰ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{lt()},100))},[F.length,B,lt]),d.useEffect(()=>{console.log("📊 [SAVE-QUEUE] Estado de cola actualizado:",{longitud:F.length,elementos:F.map(t=>`página ${t.pageIndex}`),procesando:B})},[F,B]);const Mt=d.useCallback((t,s)=>{console.log("🔍 [SAVE-QUEUE] Intentando agregar página a cola:",t),_(a=>{const o=Array.from(a.keys());return console.log("🔍 [SAVE-QUEUE] Cambios actuales:",o.join(", ")||"ninguno"),a.has(t)?(console.log("✅ [SAVE-QUEUE] Página tiene cambios, agregando a cola:",t),q(l=>{console.log("🔍 [SAVE-QUEUE] Cola actual antes de agregar:",l.length,"elementos");const u=l.findIndex(f=>f.pageIndex===t);if(u!==-1){const f=[...l];return f[u]={pageIndex:t,pages:s,timestamp:Date.now()},console.log("🔄 [SAVE-QUEUE] Actualizando elemento existente en cola"),f}else{const f=[...l,{pageIndex:t,pages:s,timestamp:Date.now()}];return console.log("➕ [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",f.length),f}}),console.log("📤 [SAVE-QUEUE] Página agregada a cola:",t),a):(console.log("⚠️ [SAVE-QUEUE] No hay cambios para la página:",t,"- No se agregará a cola"),a)})},[]),ct=d.useCallback(async t=>{if(console.log("🔄 [PAGE-CHANGE] Iniciando cambio de página de",c,"a",t),t===c){console.log("⚠️ [PAGE-CHANGE] Misma página, no se hace nada");return}_(s=>{console.log("🔍 [PAGE-CHANGE] Verificando cambios en página actual:",c);const a=Array.from(s.keys());return console.log("🔍 [PAGE-CHANGE] Páginas con cambios:",a.join(", ")||"ninguna"),s.has(c)?(console.log("💾 [PAGE-CHANGE] ✅ Página actual tiene cambios, guardando antes del cambio:",c),Mt(c,r)):console.log("ℹ️ [PAGE-CHANGE] No hay cambios en la página actual:",c),s}),ee(t),console.log("📄 [PAGE-CHANGE] ✅ Página cambiada a:",t)},[c,r,Mt]),Me=()=>`editor_progress_project_${n==null?void 0:n.id}`,Ot=d.useCallback(async()=>{var s,a,o,l;if(!(n!=null&&n.id))return;if(r.some(u=>{var f;return(f=u.cells)==null?void 0:f.some(m=>{var p;return((p=m.elements)==null?void 0:p.length)>0})})){console.log("⚠️ [RECOVERY] Ya hay contenido en el workspace, saltando recuperación automática");return}try{const u=ve.loadFromLocalStorage(),f=await fetch(`/api/canvas/projects/${n.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let m=null;if(f.ok){const v=await f.json();v.success&&((s=v.data)!=null&&s.design_data)&&(m=v.data)}let p=null;if(u&&m){const v=new Date(u.savedAt).getTime(),j=new Date(m.saved_at).getTime();p=v>j?u:m}else u?p=u:m&&(p=m);if(p&&(((a=p.pages)==null?void 0:a.length)>0||((l=(o=p.design_data)==null?void 0:o.pages)==null?void 0:l.length)>0)){const v=new Date(p.savedAt||p.saved_at).getTime();Date.now()-v<30*60*1e3?(Zs(p),kt(!0)):console.log("📅 [RECOVERY] Progreso muy antiguo, ignorando automáticamente")}}catch(u){console.error("❌ [RECOVERY] Error verificando progreso guardado:",u)}},[n==null?void 0:n.id,ve,r]),sn=d.useCallback(async t=>{var s;try{let a=[];if(t.pages?a=t.pages:(s=t.design_data)!=null&&s.pages&&(a=t.design_data.pages),a.length>0){oe(a);const o=[JSON.stringify(a)];re(o),Se(0),setTimeout(()=>{ae({})},100),X.success("✅ Progreso cargado exitosamente")}}catch(a){console.error("❌ [RECOVERY] Error cargando progreso:",a),X.error("Error al cargar el progreso guardado")}},[oe,re,Se,ae]),nn=d.useCallback(async()=>{try{const t=ve.getStorageKey();localStorage.removeItem(t),X.success("Progreso anterior eliminado")}catch(t){console.error("❌ [RECOVERY] Error descartando progreso:",t)}},[ve]);d.useEffect(()=>{n&&g&&i&&(!(w!=null&&w.pages)||w.pages.length===0)&&$t(i,g)},[n,g,i,w]),d.useEffect(()=>{n!=null&&n.id&&!$&&r.length===0&&!Be&&(Ue(!0),setTimeout(()=>{Ot()},500))},[n==null?void 0:n.id,$,r.length,Ot,Be]),d.useEffect(()=>{n!=null&&n.id&&r.length>0&&setTimeout(()=>{at()},100)},[n==null?void 0:n.id,r.length,at]);const $t=(t,s)=>{try{const a=[],o=s.pages||t.pages||20,l=s.cover_image?`/storage/images/item/${s.cover_image}`:null,u=s.cover_image?null:t.background_color||"#ffffff",f={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:l,backgroundColor:u,cells:[{id:"cell-cover-1",elements:[]}]};a.push(f);const m=s.content_image?`/storage/images/item/${s.content_image}`:null,p=s.content_image?null:t.background_color||"#ffffff";for(let I=1;I<=o;I++){const y={id:`page-content-${I}`,type:"content",pageNumber:I,layout:"layout-1",backgroundImage:m,backgroundColor:p,cells:[{id:`cell-content-${I}-1`,elements:[]}]};a.push(y)}const v=s.back_cover_image?`/storage/images/item/${s.back_cover_image}`:null,j=s.back_cover_image?null:t.background_color||"#ffffff",S={id:"page-final",type:"final",layout:"layout-1",backgroundImage:v,backgroundColor:j,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};a.push(S),oe(a),ee(0),t.width&&t.height&&Fe("preset")}catch(a){console.error("❌ Error creating pages:",a),R(a.message)}},dt=d.useMemo(()=>({cover:r.filter(t=>t.type==="cover"),content:r.filter(t=>t.type==="content"),final:r.filter(t=>t.type==="final")}),[r]),J=d.useCallback(()=>{if(!H||!A||r.length===0)return null;const t=r[c];if(!t)return null;const s=t.cells.find(a=>a.id===A);return s?s.elements.find(a=>a.id===H):null},[H,A,r,c]),Ut=(t,s)=>{if(s){const a=r[c].cells.find(l=>l.id===s),o=a==null?void 0:a.elements.find(l=>l.id===t);if(o!=null&&o.locked){const l=document.createElement("div");l.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",l.textContent="Este elemento es parte del diseño base y no se puede editar",document.body.appendChild(l),setTimeout(()=>{document.body.contains(l)&&document.body.removeChild(l)},3e3);return}}if(s&&K(s),xe(t),t){const a=r[c].cells.find(l=>l.id===(s||A)),o=a==null?void 0:a.elements.find(l=>l.id===t);(o==null?void 0:o.type)==="image"?(vt(o),console.log("🖼️ Imagen seleccionada:",o.id,"- Tab actual mantenido:",L)):(o==null?void 0:o.type)==="text"?(ot(!0),Js({elementId:t,cellId:s||A}),L!=="filters"&&L!=="images"&&se("text")):ot(!1)}else ot(!1),vt(null)},Ne=()=>{if(r.length===0)return le[0];const t=r[c];return t?le.find(s=>s.id===t.layout)||le[0]:le[0]},_t=d.useCallback(Ke(t=>{try{const s=Me(),a={pages:t,currentPage:c,savedAt:Date.now()},o=JSON.stringify(a),l=Math.round(o.length/1024);l<2048?localStorage.setItem(s,o):(console.warn(`⚠️ Datos demasiado grandes para localStorage (${l} KB)`),localStorage.removeItem(s))}catch(s){if(console.error("❌ Error guardando en localStorage:",s),s.name==="QuotaExceededError")try{localStorage.removeItem(Me())}catch(a){console.error("Error limpiando localStorage:",a)}}},300),[c,Me]),Le=d.useCallback(t=>{oe(s=>{if(s===t)return s;const a=JSON.stringify(s),o=JSON.stringify(t);return a===o?(console.log("🔄 [UPDATE-PAGES] Sin cambios, evitando actualización"),s):(console.log("📝 [UPDATE-PAGES] Aplicando cambios..."),requestAnimationFrame(()=>{if(_(l=>{const u=new Map(l);return u.set(c,Date.now()),u}),t[c]){const l=t[c].id;ae(u=>{if(u[l]){const f={...u};return delete f[l],f}return u})}}),setTimeout(()=>{re(l=>{const u=[...l.slice(0,ue+1),o];return u.length>50?u.slice(-50):u}),Se(l=>{const u=l+1;return u>50?49:u})},0),t)}),_t(t)},[c,ue,_t]);d.useEffect(()=>{try{const t=Me(),s={pages:r,currentPage:c,savedAt:Date.now()},a=JSON.stringify(s),o=Math.round(a.length/1024);o<2048?localStorage.setItem(t,a):console.warn(`⚠️ Datos demasiado grandes para localStorage (${o} KB), saltando guardado`)}catch(t){if(console.error("❌ Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const s=Me();localStorage.removeItem(s)}catch(s){console.error("Error limpiando localStorage:",s)}}},[c,r,Me]);const an=t=>{const s=le.find(u=>u.id===t);if(!s)return;const a=[...r],o=a[c],l=Array.from({length:s.cells}).map((u,f)=>o.cells[f]||{id:`cell-${o.id}-${f+1}`,elements:[]});a[c]={...o,layout:t,cells:l},Le(a),xe(null),K(null)},Re=(t,s)=>{const a=[...r];for(let o=0;o<a[c].cells.length;o++)a[c].cells[o].id===t&&a[c].cells[o].elements.push(s);Le(a),xe(s.id),K(t)},Lt=d.useCallback(Ke(()=>{_(t=>{const s=new Map(t);return s.set(c,Date.now()),s})},100),[c]),ne=d.useCallback((t,s,a,o=!1)=>{oe(l=>{const u=[...l],f=u[c].cells.findIndex(m=>m.id===t);if(f===-1)return l;if(o){const m=u[c].cells[f].elements.find(p=>p.id===s);if(!m)return l;u[c].cells[f].elements.push({...m,...a})}else{const m=u[c].cells[f].elements.findIndex(j=>j.id===s);if(m===-1)return l;const p=u[c].cells[f].elements[m];if(!Object.keys(a).some(j=>{const S=p[j],I=a[j];return typeof I=="object"&&typeof S=="object"?JSON.stringify(S)!==JSON.stringify(I):S!==I}))return l;u[c].cells[f].elements[m]={...p,...a}}return u}),a.position||a.size?requestAnimationFrame(()=>{_(l=>{if(l.has(c))return l;const u=new Map(l);return u.set(c,Date.now()),u})}):Lt()},[c,Lt]),He=(t,s)=>{const a=[...r],o=a[c].cells.findIndex(l=>l.id===t);o!==-1&&(a[c].cells[o].elements=a[c].cells[o].elements.filter(l=>l.id!==s),Le(a),H===s&&xe(null))},on=(t,s,a)=>{const o=[...r],l=o[c].cells.findIndex(u=>u.id===t);if(l!==-1){const u=o[c].cells[l].elements,f=u.findIndex(m=>m.id===s);if(f!==-1){const m=a==="up"?f+1:f-1;if(m>=0&&m<u.length){const p=u[f];u[f]=u[m],u[m]=p,Le(o)}}}},rn=()=>{ue>0&&(Se(ue-1),oe(JSON.parse(fe[ue-1])),xe(null),K(null))},ln=()=>{ue<fe.length-1&&(Se(ue+1),oe(JSON.parse(fe[ue+1])),xe(null),K(null))},ut=(t="body")=>{const s=`text-${Date.now()}`,a={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},o={heading:"Título Principal",subheading:"Subtítulo",body:"Haz clic para editar"},l={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},u={id:s,type:"text",content:o[t],position:{x:.05,y:.05},size:l[t],style:a[t]};A?Re(A,u):console.log("Selecciona una celda primero")},Rt=d.useMemo(()=>{var l;const t=r[c];if(!t)return null;const s=((l=t.cells)==null?void 0:l.flatMap(u=>u.elements||[]))||[],a=s.map(u=>({id:u.id,type:u.type,position:u.position,size:u.size}));return{pageId:t.id,elementsCount:s.length,contentHash:JSON.stringify(a).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[r,c]);d.useEffect(()=>{if(r.length===0||$||!Rt)return;let t=!1;const s=async()=>{try{const o=r[c];if(!o||!o.id)return;const l=o.id;if(ae(f=>{const m={...f};return delete m[l],m}),await new Promise(f=>setTimeout(f,100)),t)return;const u=await we();u&&!t?ae(f=>({...f,[l]:u})):console.warn("⚠️ [DEBUG] No se pudo generar miniatura para:",l)}catch(o){t||console.error("❌ [DEBUG] Error regenerando miniatura:",o)}},a=setTimeout(()=>{s()},500);return()=>{t=!0,clearTimeout(a)}},[c,Rt,$,we]),d.useEffect(()=>{if(r.length===0||$)return;const t=async()=>{const a=r.filter(o=>!Z[o.id]);if(a.length!==0)for(const o of a)try{const l=document.createElement("canvas");l.width=200,l.height=150;const u=l.getContext("2d");if(u.fillStyle=o.backgroundColor||"#ffffff",u.fillRect(0,0,200,150),o.backgroundImage)try{const m=new Image;m.crossOrigin="anonymous",await new Promise((p,v)=>{m.onload=p,m.onerror=v,m.src=o.backgroundImage}),u.drawImage(m,0,0,200,150)}catch(m){console.warn("No se pudo cargar imagen de fondo para miniatura:",m)}o.cells&&o.cells.forEach(m=>{m.elements&&m.elements.forEach(p=>{var v;p.type==="text"&&p.content&&(u.fillStyle=((v=p.style)==null?void 0:v.color)||"#000000",u.font="12px Arial",u.fillText(p.content.substring(0,20)+(p.content.length>20?"...":""),10,30))})});const f=l.toDataURL("image/jpeg",.7);ae(m=>({...m,[o.id]:f})),await new Promise(m=>setTimeout(m,300))}catch(l){console.error("❌ Error generando miniatura de fondo para:",o.id,l)}},s=setTimeout(()=>{t()},2e3);return()=>clearTimeout(s)},[r,Z,$]),d.useEffect(()=>{const t=s=>{const a=z.current,o=te.current;if(a.length>0||o.size>0)return s.preventDefault(),s.returnValue="Hay cambios sin guardar. ¿Estás seguro de que quieres salir?",s.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),d.useEffect(()=>()=>{console.log("🧹 [CLEANUP] Componente desmontado")},[]);const cn=async()=>{var t;try{if(!g||!i||!(n!=null&&n.id))return!1;await _e(r,!0)||console.warn("⚠️ No se pudo guardar el progreso, pero continuando...");const a={design_data:{id:n.id,title:(g==null?void 0:g.name)||"Álbum Personalizado",pages:r,workspace_dimensions:U,created_at:new Date().toISOString()},item_data:{id:g==null?void 0:g.id,name:(g==null?void 0:g.name)||(g==null?void 0:g.title),price:g==null?void 0:g.price,user_id:g==null?void 0:g.user_id,width:g==null?void 0:g.width,height:g==null?void 0:g.height},preset_data:{id:i==null?void 0:i.id,width:i==null?void 0:i.width,height:i==null?void 0:i.height,cover_image:i==null?void 0:i.cover_image,content_layer_image:i==null?void 0:i.content_layer_image,final_layer_image:i==null?void 0:i.final_layer_image},dimensions:{width_mm:(i==null?void 0:i.width)||(g==null?void 0:g.width)||210,height_mm:(i==null?void 0:i.height)||(g==null?void 0:g.height)||297,workspace_width:(U==null?void 0:U.width)||800,workspace_height:(U==null?void 0:U.height)||600}};try{const j=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:n.id,status:"ready_for_pdf",pdf_data:a,completed_at:new Date().toISOString()})});if(j.ok){const S=await j.json()}else console.warn("⚠️ Error marcando proyecto como completado")}catch(j){console.warn("⚠️ Error en marcado de completado:",j)}const o=Date.now(),l=n.id;window.currentProjectId=l,window.albumProjectId=l;let u=i.cover_image;Z&&Z["page-cover"]&&(u=Z["page-cover"]);let f=u;u&&u.startsWith("data:image/")&&u.length>1e5&&(f=i.cover_image||"/assets/img/default-album.jpg");const m={...g,project_id:l,canvas_project_id:n.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:i.width,height_mm:i.height,pages_count:r.length,workspace_dimensions:U,requires_pdf_generation:!0}},p=structuredClone(D),v=p.findIndex(j=>j.id==m.id);return v==-1?p.push({...m,quantity:1}):p[v].quantity++,he(p),X.success("Álbum agregado al carrito",{description:`${m.name} se ha añadido al carrito. El PDF se generará en el backend.`,icon:e.jsx(Pn,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:p,action:"add",product:m}})),!0}catch(s){return console.error("❌ === ERROR EN addAlbumToCart ==="),console.error("Error completo:",s),console.error("Stack trace:",s.stack),console.error("Mensaje del error:",s.message),X.error("Error al agregar al carrito",{description:`Error específico: ${s.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!r||r.length===0)throw new Error("No hay páginas para finalizar");const a={design_data:{pages:(S=>S.map(I=>({id:I.id,type:I.type,pageNumber:I.pageNumber,layout:I.layout,cells:I.cells.map(y=>({id:y.id,elements:y.elements.map(C=>{const M={id:C.id,type:C.type,position:C.position,zIndex:C.zIndex||1};if(C.type==="image"){if(C.content.startsWith("data:image/")){const G=btoa(C.content.substring(0,100)).substring(0,20);M.content=`[BASE64_IMAGE_${G}]`,M.contentType=C.content.split(";")[0].split(":")[1],M.originalSize=C.content.length}else M.content=C.content;if(C.filters){const G=Object.entries(C.filters).filter(([Y,W])=>W!==0&&W!==!1&&W!==null).reduce((Y,[W,Q])=>(Y[W]=Q,Y),{});Object.keys(G).length>0&&(M.filters=G)}C.mask&&C.mask!=="none"&&(M.mask=C.mask),C.size&&(M.size=C.size),C.locked&&(M.locked=C.locked)}else if(C.type==="text"&&(M.content=C.content,C.style)){const G=Object.entries(C.style).filter(([Y,W])=>!(Y==="fontSize"&&W==="16px"||Y==="color"&&W==="#000000"||Y==="fontFamily"&&W==="Arial")).reduce((Y,[W,Q])=>(Y[W]=Q,Y),{});Object.keys(G).length>0&&(M.style=G)}return M})}))})))(r),projectInfo:{id:n==null?void 0:n.id,item_id:g==null?void 0:g.id,title:g==null?void 0:g.title,preset_id:i==null?void 0:i.id},presetInfo:{id:i==null?void 0:i.id,name:i==null?void 0:i.name,cover_image:i==null?void 0:i.cover_image,content_image:i==null?void 0:i.content_image,back_cover_image:i==null?void 0:i.back_cover_image},workspace:{width:U.width,height:U.height,scale:U.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(Z).map(([S,I])=>[S,I]))},o=JSON.stringify(a),l=Math.round(o.length/1024),u=Math.round(l/1024*100)/100;let f=0,m=0;r.forEach(S=>{var I;(I=S.cells)==null||I.forEach(y=>{var C;(C=y.elements)==null||C.forEach(M=>{M.type==="image"&&M.content&&M.content.startsWith("data:image/")&&(f++,m+=M.content.length)})})});const p=Math.round(m/(1024*1024)*100)/100;if(l>1024&&!confirm(`El diseño contiene ${f} imágenes (${p} MB en imágenes). Payload completo: ${u} MB. Esto podría causar problemas al guardarlo. ¿Desea continuar de todos modos?`))return!1;const v=await fetch(`/api/canvas/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:o});if(!v.ok){let S="Error al finalizar el diseño";try{S=(await v.json()).message||S}catch{v.status===413?S="El diseño es demasiado grande para ser guardado. Intente simplificar las imágenes.":v.status>=500&&(S="Error del servidor. Intente nuevamente más tarde.")}throw new Error(S)}const j=await v.json();return!0}catch(t){console.error("Error al finalizar diseño:",t);let s=t.message;return t.message.includes("Failed to fetch")?s="Error de conexión. Verifique su conexión a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(s="Error de red. Intente nuevamente más tarde."),alert("Error al finalizar el diseño: "+s),!1}};const dn=d.useCallback(async()=>{try{const{jsPDF:t}=await gn(async()=>{const{jsPDF:G}=await import("./jspdf.es.min-D3plwuQr.js").then(Y=>Y.j);return{jsPDF:G}},__vite__mapDeps([0,1,2,3,4]));let s=(i==null?void 0:i.width)||21,a=(i==null?void 0:i.height)||29.7;const o=.3,l=s+o*2,u=a+o*2,f=l*28.35,m=u*28.35,p=new t({orientation:f>m?"landscape":"portrait",unit:"pt",format:[f,m],compress:!1}),v=r.length;let j=0;const S=document.createElement("div");S.id="pdf-progress",S.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",S.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${v} páginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(S);const I=G=>{const Y=G/v*100;document.getElementById("pdf-progress-bar").style.width=`${Y}%`,document.getElementById("current-page").textContent=G},y=c;for(let G=0;G<r.length;G++){const Y=r[G];ee(G),await new Promise(W=>setTimeout(W,500));try{const W=await we({type:"pdf"});if(W){const Q=W.width/W.height,je=f/m;let ie,ce,pe=0,Ae=0;Q>je?(ie=f,ce=f/Q,Ae=(m-ce)/2):(ce=m,ie=m*Q,pe=(f-ie)/2);const Te=W.toDataURL("image/png",1);G>0&&p.addPage([f,m]),p.addImage(Te,"PNG",pe,Ae,ie,ce)}else console.warn(`⚠️ No se pudo capturar la página ${G+1}`),G>0&&p.addPage([f,m]),p.setFontSize(12),p.text(`Error al renderizar página ${G+1}`,f/2,m/2,{align:"center"})}catch(W){console.error(`❌ Error procesando página ${G+1}:`,W),G>0&&p.addPage([f,m]),p.setFontSize(12),p.text(`Error al procesar página ${G+1}`,f/2,m/2,{align:"center"})}j++,I(j),await new Promise(W=>setTimeout(W,200))}ee(y);const C=`${(g==null?void 0:g.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;p.save(C),document.body.removeChild(S);const M=document.createElement("div");return M.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",M.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${C}</span>
                </div>
            `,document.body.appendChild(M),setTimeout(()=>{document.body.contains(M)&&document.body.removeChild(M)},5e3),C}catch(t){console.error("❌ Error generando PDF:",t);const s=document.getElementById("pdf-progress");s&&document.body.removeChild(s);const a=document.createElement("div");throw a.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",a.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(a),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},7e3),t}},[r,c,ee,we,i,g]);return window.generateAlbumPDF=dn,window.generateHighQualityThumbnail=Qs,window.captureCurrentWorkspace=we,e.jsxs(hn,{backend:fn,className:"!h-screen !w-screen overflow-hidden",children:[$?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu álbum personalizado..."})]})}):V?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:V}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):r.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando páginas del álbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx(Nn,{isOpen:Ks,onRequestClose:()=>Ct(!1),pages:r.map(t=>({...t,layout:le.find(s=>s.id===t.layout)||le[0]})),workspaceDimensions:U,getCurrentLayout:t=>t?le.find(s=>s.id===t.layout)||le[0]:le[0],presetData:i,pageThumbnails:Z,addAlbumToCart:cn,projectData:n,itemData:g}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(An,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:rn,disabled:ue<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(pn,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:ln,disabled:ue>=fe.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(xn,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(n==null?void 0:n.name)||"Álbum Sin Título",onChange:t=>h({...n,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del diseño"})}),e.jsxs("div",{className:"flex items-center gap-4",children:[(F.length>0||B)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",F.length]})]})}),e.jsx(Yn,{saveStatus:ve.saveStatus,lastSaved:ve.lastSaved,lastAutoSaved:ve.lastAutoSaved,hasUnsavedChanges:P.hasUnsavedChanges||!!(E instanceof Map&&E.has(c)),isOnline:ve.isOnline,saveError:ve.saveError,onManualSave:tn,saveQueueSize:F.length,isProcessingQueue:B,pageChangesCount:E instanceof Map?E.size:0}),F.length>0&&e.jsxs("button",{onClick:()=>{console.log("🔧 [DEBUG] Procesando cola manualmente"),lt()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(Rs,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsxs("div",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:["P",c,": ",E instanceof Map&&E.has(c)?"🔴":"🟢"]}),e.jsx("button",{onClick:()=>{console.log("🔧 [DEBUG] Marcando página actual como modificada"),_(t=>{const s=new Map(t);return s.set(c,Date.now()),s})},className:"text-xs text-white bg-green-500 hover:bg-green-600 px-2 py-1 rounded",children:"Marcar Modificada"}),e.jsx(Je,{variant:"secondary",size:"sm",onClick:()=>Ct(!0),icon:e.jsx(Ye,{className:"h-4 w-4"}),children:"Vista de Álbum"}),e.jsx("div",{className:"relative",children:e.jsx("button",{className:"h-8 w-8 rounded-full bg-[#af5cb8] flex items-center justify-center text-white font-medium",children:e.jsx(Tn,{className:"h-4 w-4"})})})]})]})}),e.jsxs("div",{className:`flex h-full ${H?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{onClick:()=>se("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${L==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ye,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Páginas"})]}),e.jsxs("button",{onClick:()=>se("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${L==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(pt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Diseños"})]}),e.jsxs("button",{onClick:()=>se("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${L==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ze,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{onClick:()=>se("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${L==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(_s,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]}),e.jsxs("button",{onClick:()=>se("filters"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${L==="filters"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ps,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Filtros"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[L==="templates"&&"Templates",L==="images"&&"Images",L==="text"&&"Text",L==="shapes"&&"Shapes",L==="stickers"&&"Stickers",L==="pages"&&"Pages",L==="panel"&&"Layers Panel",L==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[L==="templates"&&"Choose a template to get started",L==="images"&&"Search for images",L==="text"&&"Add and edit text",L==="shapes"&&"Add shapes and graphics",L==="stickers"&&"Add fun stickers",L==="pages"&&"Manage your pages",L==="panel"&&"Organize layers and z-index",L==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(Ln,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[L==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(pt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Bn,{currentLayoutId:(Vt=r[c])==null?void 0:Vt.layout,onLayoutChange:an})]}),L==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ie,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Imágenes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[be.length," imagen",be.length!==1?"s":""]})]}),e.jsx(Zn,{images:be,onImageSelect:en,isLoading:tt})]}),L==="text"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>ut("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"Título Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Xe,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>ut("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subtítulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Xe,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>ut("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Xe,{className:"h-4 w-4"})})]})})]}),L==="text"&&H&&((Gt=J())==null?void 0:Gt.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(zn,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=J();ne(A,H,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((Ht=(Bt=J())==null?void 0:Bt.style)==null?void 0:Ht.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=J();ne(A,H,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((qt=(Wt=J())==null?void 0:Wt.style)==null?void 0:qt.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=J();ne(A,H,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((Jt=(Qt=J())==null?void 0:Qt.style)==null?void 0:Jt.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipografía:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Yt=(Kt=J())==null?void 0:Kt.style)==null?void 0:Yt.fontFamily)||"Arial",onChange:t=>{const s=J();ne(A,H,{style:{...s.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tamaño:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Zt=(Xt=J())==null?void 0:Xt.style)==null?void 0:Zt.fontSize)||"16px",onChange:t=>{const s=J();ne(A,H,{style:{...s.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((es=(Dt=J())==null?void 0:Dt.style)==null?void 0:es.color)||"#000000",onChange:t=>{const s=J();ne(A,H,{style:{...s.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((ss=(ts=J())==null?void 0:ts.style)==null?void 0:ss.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((as=(ns=J())==null?void 0:ns.style)==null?void 0:as.backgroundColor)||"#ffffff",onChange:t=>{const s=J();ne(A,H,{style:{...s.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=J();ne(A,H,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"🚫"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var s,a;return e.jsxs("button",{onClick:()=>{const o=J();ne(A,H,{style:{...o.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((a=(s=J())==null?void 0:s.style)==null?void 0:a.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"⬅",t==="center"&&"⬌",t==="right"&&"➡",t==="justify"&&"⬍"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((rs=(os=J())==null?void 0:os.style)==null?void 0:rs.lineHeight)||"1.5",onChange:t=>{const s=J();ne(A,H,{style:{...s.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((ls=(is=J())==null?void 0:is.style)==null?void 0:ls.letterSpacing)||"normal",onChange:t=>{const s=J();ne(A,H,{style:{...s.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=J();ne(A,H,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((ds=(cs=J())==null?void 0:cs.style)==null?void 0:ds.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAYÚS"]}),e.jsxs("button",{onClick:()=>{const t=J();ne(A,H,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((gs=(us=J())==null?void 0:us.style)==null?void 0:gs.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"minús"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((hs=(ms=J())==null?void 0:ms.style)==null?void 0:hs.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((ps=(fs=J())==null?void 0:fs.style)==null?void 0:ps.opacity)||"1",onChange:t=>{const s=J();ne(A,H,{style:{...s.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((bs=(xs=J())==null?void 0:xs.style)==null?void 0:bs.opacity)||1)*100}%, #e5e7eb ${(((vs=(ys=J())==null?void 0:ys.style)==null?void 0:vs.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),L==="pages"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[r.length," total"]})]}),e.jsx("button",{onClick:()=>{ae({}),$s(),setTimeout(()=>ge(),100)},className:"text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50 transition-colors",title:"Regenerar todos los thumbnails",children:"🔄 Regenerar"})]}),$e&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[$e.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${$e.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:$e.message||`Página: ${$e.pageId||"actual"}`})]}),r.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando páginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),dt.cover.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${c===r.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>ct(r.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(xt,{pageId:t.id,thumbnail:Z[t.id],altText:"Cover",type:"cover"}),E instanceof Map&&E.has&&E.has(r.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:dt.content.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${c===r.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>ct(r.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(xt,{pageId:t.id,thumbnail:Z[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),E instanceof Map&&E.has&&E.has(r.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),dt.final.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${c===r.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>ct(r.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(xt,{pageId:t.id,thumbnail:Z[t.id],altText:"Back Cover",type:"final"}),E instanceof Map&&E.has&&E.has(r.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),L==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Gn,{pages:r,currentPage:c,selectedCell:A,selectedElement:H,onSelectCell:K,onSelectElement:xe,onUpdateElement:(t,s,a)=>{ne(t,s,a)},onDeleteElement:(t,s)=>{He(t,s)},onMoveElement:(t,s,a)=>{on(t,s,a)}})}),L==="filters"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ps,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=J();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Hn,{selectedMask:t.mask||"none",onSelect:s=>{ne(A,H,{mask:s})},availableMasks:Ls.map(s=>s.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(bn,{filters:t.filters||{},onFilterChange:s=>{ne(A,H,{filters:s})},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(Ie,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:J()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>se("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(pt,{className:"h-4 w-4"}),"Diseño de página"]}),e.jsxs("button",{onClick:()=>se("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Ze,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(Je,{variant:"ghost",tooltip:"Añadir Imagen",onClick:()=>rt.current&&rt.current.click(),children:e.jsx(Ie,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:rt,onChange:Ds,className:"hidden",accept:"image/*"})]}),H&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(Je,{variant:"ghost",size:"sm",onClick:()=>{if(H&&A){const t=J();if(t){const s={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};Re(A,s)}}},className:"h-8 px-2",icon:e.jsx(In,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(Je,{variant:"ghost",size:"sm",onClick:()=>{H&&A&&He(A,H)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(yt,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{className:"flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100",children:Bs?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:U.width,height:U.height},children:e.jsx("div",{id:`page-${r[c].id}`,className:`grid ${Ne().template} gap-6`,style:{width:"100%",height:"100%"},children:r[c].cells.map((t,s)=>{var a;return e.jsx(ks,{id:t.id,elements:t.elements.filter(o=>!o.locked),workspaceSize:U,cellStyle:(a=Ne().cellStyles)==null?void 0:a[r[c].cells.indexOf(t)],selectedElement:A===t.id?H:null,onSelectElement:Ut,onAddElement:(o,l)=>Re(l,o),onUpdateElement:(o,l,u)=>ne(t.id,o,l,u),onDeleteElement:o=>He(t.id,o),availableMasks:Ne().maskCategories.flatMap(o=>o.masks),projectData:n},t.id)})})})}):e.jsxs("div",{id:`page-${r[c].id}`,className:" shadow-xl overflow-hidden",style:{width:U.width,height:U.height,position:"relative",backgroundColor:((ws=r[c])==null?void 0:ws.backgroundColor)||"#ffffff",backgroundImage:(js=r[c])!=null&&js.backgroundImage?`url(${r[c].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=r[c];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${Ne().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((Es=Ne().style)==null?void 0:Es.gap)||"16px",padding:((Ns=Ne().style)==null?void 0:Ns.padding)||"16px"},children:r[c].cells.map(t=>{var s;return e.jsx(ks,{id:t.id,elements:t.elements.filter(a=>!a.locked),workspaceSize:U,cellStyle:(s=Ne().cellStyles)==null?void 0:s[r[c].cells.indexOf(t)],selectedElement:A===t.id?H:null,onSelectElement:Ut,onAddElement:(a,o)=>Re(o,a),onUpdateElement:(a,o,l)=>ne(t.id,a,o,l),onDeleteElement:a=>He(t.id,a),availableMasks:Ne().maskCategories.flatMap(a=>a.masks),projectData:n},t.id)})})]})})]})]})]}),e.jsx(En,{}),e.jsx(Xn,{isOpen:Ys,onClose:()=>kt(!1),savedProgress:Xs,onLoadProgress:sn,onDiscardProgress:nn})]})}export{Da as default};
