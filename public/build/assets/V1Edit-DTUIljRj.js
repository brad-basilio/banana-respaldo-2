import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as j}from"./index-BH53Isel.js";import"./EditorLayout-CkCvwqGw.js";import"./thumbnailGenerator-B4goYG9Y.js";import"./index-BZYhE2TF.js";import"./TextElement-_pvTHO57.js";import{R as H}from"./PaymentModal-BB1JXzaZ.js";import{H as ne}from"./jspdf.es.min-D3plwuQr.js";import{X as U}from"./x-DBMwyD6F.js";import{C as ie}from"./chevron-left-B2s3ZsB7.js";import{C as le}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./preload-helper-BfFHrpNk.js";import"./typeof-QjJsDpFa.js";import"./createLucideIcon-Cy5Ya80P.js";const X={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},ce=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;H.setAppElement("#app");const Fe=({isOpen:u,onRequestClose:x,pages:d,pageThumbnails:p={},addAlbumToCart:V,workspaceDimensions:k={width:800,height:600},layouts:W=[],presetData:B=null,projectData:E=null,itemData:me=null,albumLoadingState:P={isLoading:!1,loadedImages:0,totalImages:0,message:""}})=>{const[D,Y]=j.useState(0),[R,b]=j.useState(!1),[T,ge]=j.useState(!1),[Q,A]=j.useState({}),[q,K]=j.useState(!1),F=j.useRef();function ee(t,o,l,r,s,m){const a=o.width,c=o.height,i=s/m,g=a/c;let f=0,v=0,h=a,n=c;i>g?(n=a/i,v=(c-n)/2):(h=c*i,f=(a-h)/2),t.drawImage(o,f,v,h,n,l,r,s,m)}function te(t){const o=t.match(/grid-cols-(\d+)/),l=t.match(/grid-rows-(\d+)/),r=t.match(/gap-(\d+)/);return{cols:o?parseInt(o[1],10):1,rows:l?parseInt(l[1],10):1,gap:r?parseInt(r[1],10)*4:0}}function Z(t,o,l=1){const r=t&&t.match(new RegExp(`${o}-span-(\\d+)`));return r?parseInt(r[1],10):l}function re(t,o,l){const{cols:r,rows:s,gap:m}=te(t.template),a=t.style&&t.style.padding?parseInt(t.style.padding):0,c=o.width-2*a,i=o.height-2*a,g=(c-m*(r-1))/r,f=(i-m*(s-1))/s,v=Array.from({length:s},()=>Array(r).fill(!1)),h={};for(let n=0;n<t.cells;n++){const C=t.cellStyles&&t.cellStyles[n]?t.cellStyles[n]:"",N=Z(C,"col",1),O=Z(C,"row",1);let $=!1;for(let y=0;y<=s-O&&!$;y++)for(let _=0;_<=r-N&&!$;_++){let z=!0;for(let w=y;w<y+O;w++){for(let I=_;I<_+N;I++)if(v[w][I]){z=!1;break}if(!z)break}if(z){for(let I=y;I<y+O;I++)for(let L=_;L<_+N;L++)v[I][L]=!0;const w=l&&l[n]?l[n].id:n;h[w]={x:a+_*(g+m),y:a+y*(f+m),width:g*N+m*(N-1),height:f*O+m*(O-1)},console.log(`[GRID-PLACEMENT] cellId:${w} col-span:${N} row-span:${O} => x:${h[w].x} y:${h[w].y} w:${h[w].width} h:${h[w].height}`),$=!0}}if(!$){const y=l&&l[n]?l[n].id:n;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${y}`),h[y]={x:0,y:0,width:g,height:f}}}return h}j.useCallback(async()=>{if(!d||d.length===0||!u)return;console.log("🚀 Iniciando generación de thumbnails para BookPreview..."),K(!0),A({});const t={},o=4,l=(a,c,i,g)=>{if(!c||!c.image)return;const f=new Image;f.src=c.image,f.onload=()=>{const v=i.x+c.x*g,h=i.y+c.y*g,n=c.width*g,C=c.height*g;ee(a,f,v,h,n,C)}},r=async(a,c)=>{const i=document.createElement("canvas"),g=i.getContext("2d");if(i.width=k.width*o,i.height=k.height*o,B&&B.final_layer_image){const n=new Image;n.src=B.final_layer_image,n.onload=()=>{g.drawImage(n,0,0,i.width,i.height)}}const f=W.find(n=>n.id===a.layoutId);if(!f)return;const v=re(f,k,a.cells);a.cells.forEach(n=>{const C=v[n.id];C&&n.elements.forEach(N=>{l(g,N,C,o)})});const h=i.toDataURL("image/jpeg",.9);return{[c]:h}},s=d.map((a,c)=>r(a,c));(await Promise.all(s)).forEach(a=>{Object.assign(t,a)}),A(t),K(!1)},[d,u,k,W,B]),j.useEffect(()=>{u&&(console.log("📖 [BOOK-MODAL] Modal abierto"),console.log("📊 [BOOK-MODAL] Thumbnails recibidos:",Object.keys(p).length,"de",d.length,"páginas"),Object.keys(p).length>0?(console.log("✅ [BOOK-MODAL] Usando thumbnails del Editor"),A(p)):(console.log("ℹ️ [BOOK-MODAL] No se recibieron thumbnails, usando placeholders"),A({})))},[u,p]),j.useEffect(()=>{u||A({})},[u]);const J=Object.keys(p).length>0?p:Q;if(!d||!Array.isArray(d)||d.length===0)return e.jsx(H,{isOpen:u,onRequestClose:x,style:X,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del álbum"}),e.jsx("button",{onClick:x,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:e.jsx(U,{size:24})})]}),e.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay páginas disponibles para mostrar."})]})});const ae=()=>{F.current&&F.current.pageFlip().flipPrev()},oe=()=>{F.current&&F.current.pageFlip().flipNext()},se=k.width/k.height,S=600,M=Math.round(S*se),G=(()=>{const t=[],o=[...d.filter(r=>r.type==="cover"),...d.filter(r=>r.type==="content"),...d.filter(r=>r.type==="final")];o.length>0&&(t.push(o[0]),t.push({...o[0],isBack:!0}));for(let r=1;r<o.length-1;r++)t.push(o[r]),r+1<o.length-1?(t.push(o[r+1]),r++):t.push({...o[r],isBack:!0,isEmpty:!0});const l=o.find(r=>r.type==="final");return l&&(t.push({...l,isBack:!0,isEmpty:!0}),t.push(l)),t})();return e.jsxs(H,{isOpen:u,onRequestClose:x,style:X,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[e.jsx("style",{dangerouslySetInnerHTML:{__html:ce}}),(q||T||P.isLoading)&&e.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center max-w-md mx-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),P.isLoading?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700 text-center",children:P.message||"Cargando álbum..."}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mt-3",children:e.jsx("div",{className:"bg-purple-600 h-2 rounded-full transition-all duration-300",style:{width:`${P.totalImages>0?P.loadedImages/P.totalImages*100:0}%`}})}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:[P.loadedImages," de ",P.totalImages," imágenes"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700",children:T?"Generando PDF de alta calidad...":"Generando vistas previas de alta calidad..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})]})}),e.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[e.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del álbum"}),e.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las páginas de su álbum usando los controles de navegación o teclado. Puede cerrar esta ventana presionando Escape o el botón de cerrar."}),e.jsx("button",{onClick:x,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del álbum",children:e.jsx(U,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[e.jsx("button",{onClick:ae,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página anterior",children:e.jsx(ie,{className:"h-6 w-6"})}),e.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const t=G[D];return t?t.isBack&&t.isEmpty?"Reverso":t.isBack?"Reverso de la página":t.type==="cover"?"Portada":t.type==="final"?"Contraportada":`Página ${t.pageNumber||Math.ceil((D+1)/2)}`:"Cargando..."})(),e.jsx("span",{className:"mx-2 text-gray-400",children:"•"}),Math.ceil((D+1)/2)," / ",Math.ceil(G.length/2)," hojas"]}),e.jsx("button",{onClick:oe,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página siguiente",children:e.jsx(le,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ne,{ref:F,width:M,height:S,size:"stretch",minWidth:M*.7,maxWidth:M*1.3,minHeight:S*.7,maxHeight:S*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:t=>Y(t.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:G.map((t,o)=>e.jsx("div",{id:`page-${t.id}`,className:"page-container",style:{width:M,height:S,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:e.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:t.isEmpty||t.isBack?e.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:t.isBack?"Reverso":""}):J[t.id]?e.jsx("img",{src:J[t.id],alt:`${t.type==="cover"?"Portada":t.type==="final"?"Contraportada":`Página ${t.pageNumber||o+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):e.jsx(de,{page:t,pageIdx:o})})},`page-${o}`))})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-2xl mx-auto",children:[e.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${R?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var t,o,l;if(!R){b(!0),console.log("🚀 === INICIO PROCESO COMPRA CON GENERACIÓN PDF BACKEND ===");try{if(!(E!=null&&E.id)){console.error("❌ No hay datos del proyecto"),alert("Error: No se encontró información del proyecto."),b(!1);return}console.log("📄 Generando PDF en el backend usando thumbnails existentes..."),console.log("� Proyecto ID:",E.id);const r=await fetch(`/api/projects/${E.id}/generate-pdf-backend`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({project_id:E.id,use_thumbnails:!0,workspace_dimensions:k,pages:d})});if(!r.ok){const a=await r.json();console.error("❌ Error generando PDF:",a),alert(`Error al generar PDF: ${a.message||"Error del servidor"}`),b(!1);return}const s=await r.json();if(console.log("✅ PDF generado exitosamente:",s),!s.success||!s.pdf_path){console.error("❌ PDF no se generó correctamente:",s),alert("Error: El PDF no se pudo generar correctamente."),b(!1);return}if(console.log("📄 PDF guardado en:",s.pdf_path),console.log("🌐 PDF URL:",s.pdf_url),console.log("🛒 Agregando álbum al carrito con datos del PDF..."),typeof V!="function"){console.error("❌ addAlbumToCart no es una función"),alert("Error: Función de carrito no disponible. Inténtelo nuevamente."),b(!1);return}let m;try{const a=V({pdf_data:{pdf_path:s.pdf_path,pdf_url:s.pdf_url,pdf_size:s.pdf_size,pages_count:s.pages_count,dimensions:s.dimensions,generated_at:new Date().toISOString()}});a&&typeof a.then=="function"?m=await a:m=a,console.log("✅ Resultado de addAlbumToCart:",m)}catch(a){console.error("❌ Error en addAlbumToCart:",a),alert("Error al agregar al carrito: "+a.message),b(!1);return}if(!m){console.error("❌ No se pudo agregar al carrito"),alert("Error al agregar el álbum al carrito. Revise la consola para más detalles."),b(!1);return}console.log("✅ Álbum agregado al carrito exitosamente con PDF backend");try{const a=`${((o=window.Global)==null?void 0:o.APP_CORRELATIVE)||"bananalab"}_cart`,i=JSON.parse(localStorage.getItem(a)||"[]").find(g=>g.type==="custom_album"&&g.project_id===E.id);i&&i.pdf_data?console.log("📄 Datos del PDF en carrito confirmados:",{project_id:i.project_id,pdf_path:i.pdf_data.pdf_path,pdf_url:i.pdf_data.pdf_url,pdf_size:i.pdf_data.pdf_size,pages_count:i.pdf_data.pages_count}):console.warn("⚠️ No se encontraron datos completos del PDF en el carrito")}catch(a){console.warn("⚠️ Error verificando datos de PDF en carrito:",a)}console.log("✅ Álbum agregado al carrito exitosamente"),alert(`¡Álbum agregado al carrito exitosamente!

Puedes continuar editando o ir al carrito cuando termines.`),setTimeout(()=>{x(),b(!1)},1e3)}catch(r){console.error("❌ === ERROR GENERAL EN PROCESO COMPRA ==="),console.error("Tipo:",r.name),console.error("Mensaje:",r.message),console.error("Stack:",r.stack);try{const s=`${((l=window.Global)==null?void 0:l.APP_CORRELATIVE)||"bananalab"}_cart`;if(JSON.parse(localStorage.getItem(s)||"[]").length>0){console.log("✅ Hay items en carrito, mostrando éxito..."),alert("¡Álbum agregado al carrito! Puedes continuar editando o ir al carrito manualmente."),setTimeout(()=>{x(),b(!1)},1e3);return}}catch(s){console.error("❌ Error en recuperación:",s)}alert(`Error: ${r.message}. Si el álbum se agregó, puede ir manualmente al carrito.`)}finally{b(!1)}}},disabled:R||T,children:R?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Generando PDF..."]}):"Comprar ahora"}),e.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:x,disabled:R||T,children:"Continuar editando"})]}),"        "]})},de=({page:u,pageIdx:x})=>{let d="",p="";switch(u.type){case"cover":d="Portada",p="📚";break;case"final":d="Contraportada",p="📖";break;case"content":d=`Página ${u.pageNumber||x+1}`,p="📄";break;default:d=`Página ${x+1}`,p="📄"}return e.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[e.jsx("div",{className:"text-6xl mb-4",children:p}),e.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:d}),e.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),u.layout&&e.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",u.layout.name||"Personalizado"]})]})};export{Fe as B};
