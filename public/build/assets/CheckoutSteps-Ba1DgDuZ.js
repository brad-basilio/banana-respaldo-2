import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as p}from"./index-BH53Isel.js";import{N as q}from"./Number2Currency-e57Tgsuk.js";import{B as je,a as Ie,D as Be,A as Ue,O as Ge,C as He}from"./OptionCard-D7cBZZov.js";import{S as de}from"./sparkles-DeLUn6av.js";import{c as ve}from"./createLucideIcon-Cy5Ya80P.js";import{M as Xe}from"./minus-jyhodMPN.js";import{P as Ke}from"./plus-Bot15Khs.js";import{T as Qe}from"./trash-2-DK1wnsDn.js";import{a as Ye}from"./index-Dq7h7Pqt.js";import{X as Re}from"./x-DBMwyD6F.js";import{m as Je}from"./main-6DCdASTx.js";import{G as ce}from"./Global-ErywZRdd.js";import{t as $}from"./index-BZYhE2TF.js";import{I as se}from"./InputForm-ZnsQvLid.js";import{l as We}from"./lodash-B86Kzq6J.js";import{C as he}from"./circle-x-p-TkKhsF.js";import{m as ae}from"./proxy-F8AlgMSF.js";import"./ProductNavigation-Bbmjh1UG.js";import"./ProductCard-CRhBSmWZ.js";/* empty css              */import"./BlogCarousel-BcMdR14t.js";/* empty css               */import"./InfiniteCategory-D40taAX0.js";import{M as Ze}from"./PaymentModal-Bxx5p2o_.js";import{H as et}from"./HtmlContent-FTivcJrM.js";import"./index-yBjzXJbu.js";import"./loader-circle-CrvBvIt1.js";import"./useStateManager-7e1e8489.esm-BdOfxnTj.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./hoist-non-react-statics.cjs-kbdZbs82.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./ItemsRest-Cez3tX8T.js";import"./BasicRest-DXMDQ7uA.js";import"./HeaderSearch-7Gr-0bsN.js";import"./CartItemRow-JDzRN0oi.js";import"./tippy-react.esm-BWiGTO87.js";import"./index-CmxRu895.js";import"./eye-CKCH9ORv.js";import"./index-Chjiymov.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=ve("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=ve("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=ve("OctagonX",[["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"M2.586 16.726A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2h6.624a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586z",key:"2d38gg"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=ve("UserRoundX",[["path",{d:"M2 21a8 8 0 0 1 11.873-7",key:"74fkxq"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"m17 17 5 5",key:"p7ous7"}],["path",{d:"m22 17-5 5",key:"gqnmv0"}]]);function at({onClick:n,className:x=""}){return e.jsxs("div",{className:`relative ${x}`,children:[e.jsx(de,{size:12,className:"absolute -top-1 -left-1 text-yellow-400 animate-ping",style:{animationDelay:"0s"}}),e.jsx(de,{size:10,className:"absolute -top-2 -right-1 text-pink-400 animate-ping",style:{animationDelay:"0.5s"}}),e.jsx(de,{size:8,className:"absolute -bottom-1 -left-2 text-blue-400 animate-ping",style:{animationDelay:"1s"}}),e.jsx(de,{size:14,className:"absolute -bottom-2 -right-2 text-purple-400 animate-ping",style:{animationDelay:"1.5s"}}),e.jsxs("button",{onClick:n,className:"relative group bg-primary p-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 animate-bounce cursor-pointer",style:{animationDuration:"2s",animationIterationCount:"infinite"},children:[e.jsx("div",{className:"absolute inset-0 bg-primary rounded-xl opacity-0 group-hover:opacity-50 transition-opacity duration-300 blur-lg"}),e.jsx(be,{size:24,className:"text-white relative z-10 drop-shadow-sm"}),e.jsx("div",{className:"absolute inset-0 bg-primary rounded-xl animate-pulse opacity-30"})]}),e.jsx("div",{className:"absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20",children:"¡Promoción disponible!"})]})}const rt=({setCart:n,hasPromotion:x,onPromotionClick:i,...u})=>{const S=()=>{n(j=>j.filter(c=>c.id!==u.id))},N=()=>{n(j=>j.map(c=>c.id===u.id?{...c,quantity:(c.quantity||1)+1}:c))},f=()=>{n(j=>j.map(c=>{if(c.id===u.id){const d=(c.quantity||1)-1;return d<=0?(S(u.id),null):{...c,quantity:d}}return c}).filter(Boolean))};return e.jsx("div",{className:"w-full bg-white rounded-lg shadow p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center  justify-between gap-4 w-full",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-grow",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:`/storage/images/item/${u.image}`,alt:u.name,className:"w-20 h-20 object-cover rounded flex-shrink-0",onError:j=>j.target.src="/api/cover/thumbnail/null"}),x&&e.jsx("div",{className:"absolute -top-2 -right-2",children:e.jsx(at,{onClick:()=>i(u),className:"group"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium text-lg mb-2 line-clamp-2",children:u.name}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Marca: ",e.jsx("span",{className:"customtext-neutral-dark",children:u.brand.name})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Disponibilidad: ",e.jsxs("span",{className:"customtext-neutral-dark",children:[u.stock>=u.quantity?"En stock":"Agotado"," "]})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["SKU: ",e.jsx("span",{className:"customtext-neutral-dark",children:u.sku})]})]})]}),e.jsxs("div",{className:"flex flex-row justify-between md:flex-col items-end md:items-end gap-4 mt-4 md:mt-0 flex-shrink-0",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-gray-500 line-through",children:["S/ ",Number(u.price*u.quantity).toFixed(2)]}),e.jsxs("div",{className:"font-bold text-lg",children:["S/ ",Number(u.final_price*u.quantity).toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center border border-gray-200 rounded-lg overflow-hidden shadow-sm",children:[e.jsx("button",{type:"button",onClick:f,className:"p-2 text-gray-600 hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary","aria-label":"Decrease quantity",children:e.jsx(Xe,{size:16})}),e.jsx("div",{className:"w-12 h-8 flex justify-center items-center bg-white",children:e.jsx("span",{className:"font-semibold text-sm",children:u.quantity||1})}),e.jsx("button",{type:"button",onClick:N,className:"p-2 text-gray-600 hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary","aria-label":"Increase quantity",children:e.jsx(Ke,{size:16})})]}),e.jsx("button",{onClick:S,className:"p-2 text-gray-400 hover:text-red-500 transition-colors duration-200 rounded-full hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-200","aria-label":"Remove item",children:e.jsx(Qe,{size:18})})]})]})]})},u.id)},nt="/api";class _e{static async applyToCart(x,i,u=null){var S;try{if(console.log("🛒 Applying discount rules to cart:",{cartItems:x,totalAmount:i,customerEmail:u}),!Array.isArray(x)||x.length===0)return{success:!1,error:"Carrito vacío o inválido",data:null};const N={cart_items:x.map(j=>{const c={item_id:String(j.item_id||j.id||""),quantity:parseInt(j.quantity)||1,price:parseFloat(j.price||j.final_price||0),name:String(j.name||j.description||"Producto sin nombre"),category_id:j.category_id?String(j.category_id):null};return console.log("📦 Processing cart item:",c),c}),total_amount:parseFloat(i)||0,customer_email:u||null};console.log("📤 Sending payload to API:",N);const f=await Ye.post(`${nt}/discount-rules/apply-to-cart`,N);return f.data.status===200?{success:!0,data:f.data.data,message:f.data.message}:{success:!1,error:f.data.message||"Error al aplicar descuentos",data:null}}catch(N){return console.error("Error applying discount rules:",N),(S=N.response)!=null&&S.data?{success:!1,error:N.response.data.message||"Error del servidor",data:N.response.data.data||null}:{success:!1,error:"Error de conexión",data:null}}}static formatDiscounts(x){return!x||!Array.isArray(x)?[]:x.map(i=>({id:i.rule_id,name:i.rule_name||"Descuento automático",description:i.description||"",amount:parseFloat(i.discount_amount||0),type:i.discount_type||"fixed",promotion_type:i.promotion_type||null,free_items:i.free_items||[],formatted_amount:i.discount_type==="percentage"?`${i.discount_amount}%`:`S/ ${parseFloat(i.discount_amount||0).toFixed(2)}`}))}static getFreeItems(x){if(!x||!Array.isArray(x))return[];const i=[];return x.forEach(u=>{u.free_items&&Array.isArray(u.free_items)&&i.push(...u.free_items)}),i}static calculateTotalDiscount(x){return!x||!Array.isArray(x)?0:x.reduce((i,u)=>i+parseFloat(u.discount_amount||0),0)}}function ot({isOpen:n,onClose:x,suggestion:i,onAddToCart:u,productName:S}){const[N,f]=p.useState(!1);if(!n||!i)return null;const j=async()=>{f(!0);try{console.log("Modal - suggestion data:",i),await u(i),x()}catch(c){console.error("Error adding promotional item:",c)}finally{f(!1)}};return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity duration-300",onClick:x}),e.jsx("div",{className:"flex min-h-full items-center justify-center p-4",children:e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-auto transform transition-all duration-300 scale-100",children:[e.jsx("button",{onClick:x,className:"absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 transition-colors rounded-full hover:bg-gray-100",children:e.jsx(Re,{size:20})}),e.jsxs("div",{className:"text-center pt-8 pb-6 px-6",children:[e.jsxs("div",{className:"relative inline-block mb-4",children:[e.jsx("div",{className:"animate-bounce",children:e.jsx(be,{size:48,className:"customtext-primary mx-auto"})}),e.jsx(de,{size:20,className:"absolute -top-2 -right-2 text-yellow-400 animate-pulse"}),e.jsx(de,{size:16,className:"absolute -bottom-1 -left-2 text-yellow-400 animate-pulse delay-300"})]}),e.jsx("h2",{className:"text-2xl font-bold customtext-neutral-dark mb-2",children:"🎉 ¡Promoción Especial!"}),e.jsx("p",{className:"text-gray-600",children:"Tienes un producto que califica para una promoción"})]}),e.jsxs("div",{className:"px-6 pb-6",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 mb-6",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Al tener  ",e.jsxs("span",{className:"font-semibold customtext-primary",children:[i.current_quantity," ",S]})," en tu carrito"]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 shadow-sm",children:[e.jsx("p",{className:"font-bold text-lg customtext-primary mb-1",children:i.rule_name}),e.jsx("p",{className:"text-sm customtext-neutral-light",children:i.description||"Obtén un producto gratis"})]})]})}),e.jsx("div",{className:"border-2 border-dashed rounded-xl p-4 mb-6 bg-green-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3 w-9/12",children:[e.jsx("div",{className:"w-12 h-12  rounded-full flex items-center justify-center",children:e.jsx(be,{className:"customtext-primary",size:24})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold customtext-neutral-dark",children:i.item_name}),e.jsxs("p",{className:"text-sm customtext-primary",children:["Cantidad: ",i.suggested_quantity]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-lg font-bold customtext-primary",children:"¡GRATIS!"}),e.jsxs("p",{className:"text-xs text-gray-500 line-through",children:["S/ ",Number(i.value||0).toFixed(2)]})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:j,disabled:N,className:"w-full bg-primary text-white font-semibold py-3 px-6 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:transform-none shadow-lg",children:N?e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Agregando..."})]}):e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(be,{size:20}),e.jsx("span",{children:"¡Agregar Regalo!"})]})}),e.jsx("button",{onClick:x,className:"w-full bg-gray-100 customtext-neutral-light font-medium py-3 px-6 rounded-xl hover:bg-gray-200 transition-colors duration-200",children:"Tal vez después"})]}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-4",children:"* Promoción válida mientras tengas los productos requeridos en tu carrito"})]})]})})]})}function it({cart:n,setCart:x,onContinue:i,subTotal:u,envio:S,igv:N,totalFinal:f,openModal:j,automaticDiscounts:c,setAutomaticDiscounts:d,automaticDiscountTotal:a,setAutomaticDiscountTotal:g,totalWithoutDiscounts:y}){const[l,P]=p.useState(c||[]),[F,L]=p.useState(a||0),[O,re]=p.useState(!1),[Ne,Z]=p.useState([]),[Y,H]=p.useState([]),[X,K]=p.useState(!1),[ee,me]=p.useState(null),[R,ne]=p.useState(null),Q=n.length===0;p.useEffect(()=>{if(n.length>0&&u>0)te();else{const h=[];P(h),L(0),Z([]),H([]),d&&d(h),g&&g(0)}},[n,u]);const te=async()=>{re(!0);try{const h=n.reduce((C,E)=>C+(E.quantity||0),0);console.log("🛒 CartStep applying discounts:",{cart:n,subTotal:u,totalWithoutDiscounts:y,totalQuantity:h,cartLength:n.length,cartItems:n.map(C=>({id:C.id||C.item_id,name:C.name,quantity:C.quantity,price:C.price||C.final_price,category_id:C.category_id}))});const m=await _e.applyToCart(n,y);if(console.log("📥 Server response:",{success:m.success,data:m.data,error:m.error,fullResult:m}),m.success&&m.data){console.log("✅ Discounts found:",m.data.applied_discounts);const C=_e.formatDiscounts(m.data.applied_discounts),E=m.data.total_discount||0,U=_e.getFreeItems(m.data.applied_discounts),D=[];m.data.applied_discounts.forEach(G=>{G.suggested_items&&Array.isArray(G.suggested_items)&&D.push(...G.suggested_items)}),P(C),L(E),Z(U),H(D),d&&d(C),g&&g(E)}else{console.error("❌ Discount application failed:",{error:m.error,success:m.success,data:m.data,fullResult:m});const C=[],E=0;P(C),L(E),Z([]),H([]),d&&d(C),g&&g(E)}}catch(h){console.error("Error applying discount rules:",h);const m=[],C=0;P(m),L(C),Z([]),H([]),d&&d(m),g&&g(C)}finally{re(!1)}},ue=h=>Y.some(m=>m.item_id===h||m.triggering_item_id===h),w=h=>Y.find(m=>m.item_id===h||m.triggering_item_id===h),z=h=>{const m=w(h.id);m&&(me(m),ne(h),K(!0))},oe=async h=>{try{console.log("CartStep - handleAddPromotionalItem received:",h),console.log("CartStep - current cart:",n),x(m=>{console.log("CartStep - old cart before update:",m);const C=m.findIndex(E=>(E.item_id||E.id)===h.item_id);if(console.log("CartStep - existingItemIndex:",C),C!==-1){const E=[...m],U=h.quantity||h.suggested_quantity||1;return console.log("CartStep - adding quantity:",U),E[C].quantity+=U,console.log("CartStep - updated cart:",E),E}else{console.log("CartStep - item not found, creating new product");const E={id:h.item_id,name:h.item_name,quantity:h.quantity||h.suggested_quantity||1,price:h.value||0,final_price:h.value||0,image:h.item_image||"default.jpg",brand:{name:h.item_brand||"N/A"},sku:h.item_sku||"PROMO",stock:999};return[...m,E]}}),setTimeout(()=>{te()},100)}catch(m){console.error("Error adding promotional item:",m)}};return e.jsxs("div",{className:"grid lg:grid-cols-5 gap-4 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3 space-y-4 md:space-y-6",children:Q?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center animate-fade-in",children:[e.jsx("svg",{className:"w-24 h-24 text-gray-300 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-600 mb-2",children:"Tu carrito está vacío"}),e.jsx("p",{className:"text-gray-500",children:"¡Explora nuestros productos y encuentra algo especial!"})]}):n.map((h,m)=>e.jsx(rt,{...h,setCart:x,hasPromotion:ue(h.id),onPromotionClick:z},m))}),e.jsxs("div",{className:"lg:col-span-2 bg-[#F7F9FB] rounded-xl shadow-lg p-4 md:p-6 h-max mt-4 md:mt-0",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6",children:"Resumen"}),e.jsxs("div",{className:"space-y-3 md:space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold",children:["S/ ",q(u)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"IGV"}),e.jsxs("span",{className:"font-semibold",children:["S/ ",q(N)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Envío"}),e.jsxs("span",{className:"font-semibold",children:["S/ ",q(S)]})]}),O&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Verificando descuentos..."}),e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"})]}),!O&&l.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6  customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),l.map((h,m)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[h.name,h.description&&e.jsx("span",{className:"text-xs font-semibold block",children:h.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-S/ ",q(h.amount)]})]},m)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-S/ ",q(F)]})]})]}),e.jsxs("div",{className:"py-3 border-y-2 mt-4 md:mt-6",children:[e.jsxs("div",{className:"flex justify-between font-bold text-lg md:text-[20px] items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["S/ ",q(f)]})]}),F>0&&e.jsxs("div",{className:"text-sm text-gray-500 mt-1",children:[e.jsxs("span",{className:"line-through",children:["S/ ",q(y||f+F)]}),e.jsxs("span",{className:"ml-2 customtext-neutral-dark font-semibold",children:["Ahorras S/ ",q(F)]})]})]}),e.jsxs("div",{className:"space-y-2 pt-3 md:pt-4",children:[e.jsx(je,{onClick:i,className:"w-full",disabled:Q,children:Q?"Carrito Vacío":"Continuar Compra"}),e.jsx(Ie,{href:"/",className:"w-full",children:Q?"Ir a Comprar":"Cancelar"})]}),e.jsx("div",{children:e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>j(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>j(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})})]})]}),e.jsx(ot,{isOpen:X,onClose:()=>K(!1),suggestion:ee,onAddToCart:oe,productName:(R==null?void 0:R.name)||""})]})}function lt(){let n="";for(let x=0;x<12;x++){const i=Math.floor(Math.random()*10);n+=i}return n}const ct=n=>new Promise((x,i)=>{var u;try{console.log(n);const S=lt(n.email);console.log(S);let N=!1;window.Culqi.publicKey=ce.CULQI_PUBLIC_KEY;const f=parseFloat(n.amount.toFixed(2)),j=Math.round(f*100);console.log("💰 Configurando Culqi:"),console.log("   - Monto original:",n.amount),console.log("   - Monto redondeado (soles):",f),console.log("   - Monto en céntimos:",j),console.log("   - Email:",n.email),window.Culqi.settings({title:ce.APP_NAME,email:n.email,currency:"PEN",amount:j,order:`${S}`}),console.log(window.Culqi.settings),window.Culqi.options({lang:"es",installments:!1,paymentMethods:{tarjeta:!0,yape:!0,bancaMovil:!0,agente:!0,billetera:!0,cuotealo:!0},style:{logo:ce.APP_URL+"/assets/resources/logo.png",bannerColor:ce.APP_COLOR_PRIMARY,buttonBackground:ce.APP_COLOR_PRIMARY}});const c=(u=window.Culqi)==null?void 0:u.close;c&&(window.Culqi.close=function(){return!window.Culqi.token&&!N&&(console.log("🚫 Modal de Culqi cerrado sin completar el pago"),i("Pago cancelado por el usuario")),c.apply(this,arguments)}),window.Culqi.open(),window.culqi=async function(){try{if(!window.Culqi.token){i("No se obtuvo un token de Culqi");return}N=!0;const a=window.Culqi.token.id;console.log("✅ Token generado:",a),n={...n,token:a,orderNumber:S},console.log("_request actualizado",n);const{status:g,result:y}=await Je.Fetch("./api/pago",{method:"POST",body:JSON.stringify(n)});g||console.log((y==null?void 0:y.message)||"Error en el pago"),window.Culqi.close(),$.success("¡Pago exitoso!",{description:"Tu pago se procesó correctamente. Pronto recibirás la confirmación de tu pedido.",duration:3e3,position:"top-right",richColors:!0}),x(y)}catch(a){$.error("¡Error en el Pago!",{description:a.message,duration:3e3,position:"top-right",richColors:!0}),i(a.message||"Error en el pago")}},window.addEventListener("message",function(a){a.data==="culqi_closed"&&i("Pago cancelado por el usuario")});const d=a=>{a.key==="Escape"&&!N&&(console.log("🚫 Modal de Culqi cerrado con Escape"),i("Pago cancelado por el usuario"))};document.addEventListener("keydown",d),setTimeout(()=>{document.removeEventListener("keydown",d)},3e5),document.addEventListener("culqi.error",function(a){var g,y;$.error("¡Error en Culqi!",{description:((g=a.detail)==null?void 0:g.message)||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),i(((y=a.detail)==null?void 0:y.message)||"Error desconocido")})}catch(S){$.error("¡Error en la integración con Culqi!",{description:S.message,duration:3e3,position:"top-right",richColors:!0}),i("Error en la integración con Culqi")}});function dt({cart:n,setSale:x,setCode:i,setDelivery:u,setCart:S,onContinue:N,noContinue:f,subTotal:j,igv:c,totalFinal:d,user:a,setEnvio:g,envio:y,ubigeos:l=[],openModal:P,setCouponDiscount:F,setCouponCode:L,automaticDiscounts:O=[],automaticDiscountTotal:re=0,totalWithoutDiscounts:Ne,conversionScripts:Z,setConversionScripts:Y,onPurchaseComplete:H}){var Fe,Me;const[X,K]=p.useState(null),[ee,me]=p.useState(null),[R,ne]=p.useState([]),[Q,te]=p.useState(0);R.reduce((t,s)=>s.free_items&&Array.isArray(s.free_items)?[...t,...s.free_items]:t,[]);const ue=(t,s)=>{var _;let r=[],k=0;for(const o of s)switch(o.type){case"buy_x_get_y":{t.forEach(b=>{var v;if((v=o.product_ids)!=null&&v.includes(b.id)){const A=Math.floor(b.quantity/(o.buy+o.get));if(A>0&&o.get>0){const W=A*o.get,xe=W*b.final_price;r.push({name:o.name,amount:xe,description:o.description,free_items:[{...b,quantity:W}]}),k+=xe}}});break}case"quantity_discount":{t.forEach(b=>{var v;if((v=o.product_ids)!=null&&v.includes(b.id)){const A=Math.floor(b.quantity/o.buy);if(A>0&&o.pay<o.buy){const W=A*(o.buy-o.pay)*b.final_price;r.push({name:o.name,amount:W,description:o.description}),k+=W}}});break}case"tiered_discount":{t.forEach(b=>{var v;if((v=o.product_ids)!=null&&v.includes(b.id)){const A=Math.floor(b.quantity/o.tier);if(A>0&&o.free>0){const W=A*o.free,xe=W*b.final_price;r.push({name:o.name,amount:xe,description:o.description,free_items:[{...b,quantity:W}]}),k+=xe}}});break}case"category_discount":{t.forEach(b=>{var v;if((v=o.category_ids)!=null&&v.includes(b.category_id)){const A=b.final_price*b.quantity*(o.percent/100);A>0&&(r.push({name:o.name,amount:A,description:o.description}),k+=A)}});break}case"cart_discount":{const b=t.reduce((v,A)=>v+A.final_price*A.quantity,0);if(b>=(o.min_total||0)){const v=o.percent?b*(o.percent/100):o.amount||0;v>0&&(r.push({name:o.name,amount:v,description:o.description}),k+=v)}break}case"bundle_discount":{((_=o.product_ids)==null?void 0:_.every(v=>t.some(A=>A.id===v)))&&o.amount>0&&(r.push({name:o.name,amount:o.amount,description:o.description}),k+=o.amount);break}}return{discounts:r,totalDiscount:k}};p.useEffect(()=>{if(O&&Array.isArray(O)&&O.length>0){const{discounts:t,totalDiscount:s}=ue(n,O);ne(t),te(s)}else ne([]),te(0)},[n,O]);const[w,z]=p.useState({name:(a==null?void 0:a.name)||"",lastname:(a==null?void 0:a.lastname)||"",email:(a==null?void 0:a.email)||"",phone:(a==null?void 0:a.phone)||"",department:(a==null?void 0:a.department)||"",province:(a==null?void 0:a.province)||"",district:(a==null?void 0:a.district)||"",address:(a==null?void 0:a.address)||"",number:(a==null?void 0:a.number)||"",comment:"",reference:(a==null?void 0:a.reference)||"",ubigeo:(a==null?void 0:a.ubigeo)||null});p.useEffect(()=>{if(a!=null&&a.ubigeo&&(a!=null&&a.district)&&(a!=null&&a.province)&&(a!=null&&a.department)){const t={value:a.ubigeo,label:`${a.district}, ${a.province}, ${a.department}`,data:{reniec:a.ubigeo,departamento:a.department,provincia:a.province,distrito:a.district}};me(t),K(t),Te(t)}},[a]);const[oe,h]=p.useState(!1),[m,C]=p.useState(!1),[E,U]=p.useState([]),[D,G]=p.useState(null),[M,J]=p.useState(null),[T,V]=p.useState({}),[fe,ie]=p.useState(""),[le,Se]=p.useState(""),[I,qe]=p.useState(null),[we,Ee]=p.useState(0),[ge,Pe]=p.useState(!1),[ke,pe]=p.useState(""),$e=t=>{var r,k,_;const s=["name","lastname","email","phone","ubigeo","address","shipping"];for(const o of s)if(t[o]){let b=null,v=!1;if(o==="ubigeo"?b=((k=(r=document.querySelector('[name="ubigeo"]'))==null?void 0:r.parentElement)==null?void 0:k.parentElement)||document.querySelector(".css-1s2u09g-control")||document.querySelector('[class*="react-select"]'):o==="shipping"?b=((_=document.querySelector('input[name="shipping"]'))==null?void 0:_.closest(".space-y-4"))||document.querySelector(".space-y-4 h3")||document.querySelector("h3"):(b=document.querySelector(`[name="${o}"]`),v=!0),b){b.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),v&&setTimeout(()=>{try{b.focus(),b.tagName==="INPUT"&&b.type==="text"&&b.select()}catch(A){console.warn("No se pudo enfocar el elemento:",A)}},600),Oe(b);break}}},Oe=t=>{if(!t)return;const s=document.createElement("div");if(s.style.cssText=`
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #ef4444;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1000;
            animation: pulse 0.6s ease-in-out;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        `,!document.querySelector("#error-highlight-styles")){const k=document.createElement("style");k.id="error-highlight-styles",k.textContent=`
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.02); opacity: 0.8; }
                    100% { transform: scale(1); opacity: 1; }
                }
            `,document.head.appendChild(k)}const r=t.style.position;(!r||r==="static")&&(t.style.position="relative"),t.appendChild(s),setTimeout(()=>{s.parentNode&&(s.parentNode.removeChild(s),(!r||r==="static")&&(t.style.position=r))},1200)},Te=async t=>{if(!t)return;V(r=>({...r,ubigeo:""}));const{data:s}=t;z(r=>({...r,department:s.departamento,province:s.provincia,district:s.distrito,ubigeo:s.reniec})),h(!0);try{const r=await Be.getShippingCost({ubigeo:s.reniec}),k=[];r.data.is_free?(k.push({type:"free",price:0,description:r.data.standard.description,deliveryType:r.data.standard.type,characteristics:r.data.standard.characteristics}),r.data.express.price>0&&k.push({type:"express",price:r.data.express.price,description:r.data.express.description,deliveryType:r.data.express.type,characteristics:r.data.express.characteristics})):r.data.is_agency?k.push({type:"agency",price:0,description:r.data.agency.description,deliveryType:r.data.agency.type,characteristics:r.data.agency.characteristics}):k.push({type:"standard",price:r.data.standard.price,description:r.data.standard.description,deliveryType:r.data.standard.type,characteristics:r.data.standard.characteristics}),U(k),G(k[0].type),g(k[0].price)}catch{$.error("Sin cobertura",{description:"No realizamos envíos a esta ubicación.",icon:e.jsx(Ce,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"}),U([]),G(null),g(0)}h(!1)},Ae=async t=>{var _,o;if(t.preventDefault(),m)return;if(!a){$.error("Acceso requerido",{description:"Debe iniciar sesión para continuar.",icon:e.jsx(st,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"});return}const s={},r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,k=/^[0-9]{9}$/;if(w.name.trim()||(s.name="Nombre es requerido"),w.lastname.trim()||(s.lastname="Apellido es requerido"),w.email.trim()?r.test(w.email)||(s.email="Email inválido"):s.email="Email es requerido",w.phone.trim()?k.test(w.phone.trim())||(s.phone="Teléfono debe tener exactamente 9 dígitos"):s.phone="Teléfono es requerido",w.ubigeo||(s.ubigeo="Ubicación es requerida"),w.address||(s.address="Dirección es requerida"),D||(s.shipping="Seleccione un método de envío"),Object.keys(s).length>0){V(s);const b=Object.keys(s)[0],v={name:"Por favor ingrese su nombre",lastname:"Por favor ingrese su apellido",email:(_=s.email)!=null&&_.includes("inválido")?"Por favor ingrese un correo electrónico válido":"Por favor ingrese su correo electrónico",phone:(o=s.phone)!=null&&o.includes("9 dígitos")?"El teléfono debe tener exactamente 9 dígitos":"Por favor ingrese su número de teléfono",ubigeo:"Por favor seleccione su ubicación de entrega",address:"Por favor ingrese su dirección de entrega",shipping:"Por favor seleccione un método de envío"};$.error("Complete el campo requerido",{description:v[b],icon:e.jsx(he,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),$e(s);return}C(!0);try{const b={user_id:a.id,...w,fullname:`${w.name} ${w.lastname}`,country:"Perú",amount:B(ye),delivery:B(y),cart:n,coupon_id:(I==null?void 0:I.id)||null,coupon_code:(I==null?void 0:I.code)||null,coupon_discount:B(we||0),applied_promotions:O||[],promotion_discount:B(re||0)};console.log("📦 Request completo a enviar:",b),console.log("💰 Monto final con cupón:",ye),console.log("🎟️ Descuento del cupón:",we),console.log("🚚 Costo de envío:",y);const v=await ct(b);v.status?(x(v.sale),u(v.delivery),i(v.code),v.conversion_scripts&&(console.log("Scripts de conversión recibidos:",v.conversion_scripts),Y(v.conversion_scripts),H&&H(v.sale_id,v.conversion_scripts)),S([]),N()):$.error("Error en el pago",{description:v.message||"Pago rechazado",icon:e.jsx(Ce,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}catch{$.error("Lo sentimos, no puede continuar con la compra",{description:"Ocurrió un error al procesar el pedido.",icon:e.jsx(Ce,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}finally{C(!1)}},ze=p.useCallback(We.debounce((t,s)=>{if(t.length<3){s([]);return}fetch(`/api/ubigeo/search?q=${encodeURIComponent(t)}`).then(r=>{if(!r.ok)throw new Error("Error en la respuesta");return r.json()}).then(r=>{const k=r.map(_=>({value:_.reniec,label:`${_.distrito}, ${_.provincia}, ${_.departamento}`,data:{inei:_.inei,reniec:_.reniec,departamento:_.departamento,provincia:_.provincia,distrito:_.distrito}}));s(k)}).catch(r=>{s([])})},300),[]);p.useEffect(()=>{V(t=>{const s={...t};return w.name.trim()&&delete s.name,w.lastname.trim()&&delete s.lastname,w.email.trim()&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(w.email)&&delete s.email,w.phone.trim()&&/^[0-9]{9}$/.test(w.phone.trim())&&delete s.phone,w.address.trim()&&delete s.address,w.ubigeo&&delete s.ubigeo,D&&delete s.shipping,s})},[w,D]);const De=t=>({control:s=>({...s,border:`1px solid ${t?"#ef4444":"#e5e7eb"}`,boxShadow:"none",minHeight:"50px","&:hover":{borderColor:t?"#ef4444":"#6b7280"},borderRadius:"0.75rem",padding:"2px 8px"}),menu:s=>({...s,zIndex:9999,marginTop:"4px",borderRadius:"8px"}),option:s=>({...s,color:"#1f2937",backgroundColor:"white","&:hover":{backgroundColor:"#f3f4f6"},padding:"12px 16px"})}),Le=async()=>{var t;if(!le.trim()){pe("Ingrese un código de cupón");return}Pe(!0),pe("");try{const s=[...new Set(n.map(o=>o.category_id).filter(Boolean))],r=n.map(o=>o.id);console.log("Validando cupón:",{code:le.trim(),cart_total:j,category_ids:s,product_ids:r});const k=await He.validateCoupon({code:le.trim(),cart_total:j,category_ids:s,product_ids:r});console.log("Respuesta del cupón:",k);const _=k.data||k;if(_&&_.valid){qe(_.coupon);const o=Math.round(_.discount*100)/100;Ee(o),F&&F(o),L&&L(((t=_.coupon)==null?void 0:t.code)||le.trim()),$.success("Cupón aplicado",{description:_.message||"Cupón aplicado correctamente",duration:3e3,position:"top-center"})}else{const o=(_==null?void 0:_.message)||"Cupón no válido";pe(o),$.error("Cupón no válido",{description:o,icon:e.jsx(he,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}}catch(s){console.error("Error al validar cupón:",s),pe("Error al validar el cupón"),$.error("Error",{description:s.message||"No se pudo validar el cupón. Intente nuevamente.",icon:e.jsx(he,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}finally{Pe(!1)}},Ve=()=>{qe(null),Ee(0),Se(""),pe(""),F&&F(0),L&&L(""),$.success("Cupón removido",{description:"El cupón ha sido removido de su pedido",duration:2e3,position:"top-center"})},B=t=>{const s=typeof t=="string"?parseFloat(t):t;return parseFloat(s.toFixed(2))},ye=B(d);return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsxs("form",{className:"space-y-4 md:space-y-6 bg-white p-4 md:p-6 rounded-xl shadow-sm",onSubmit:Ae,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(se,{name:"name",label:"Nombres",value:w.name,error:T.name,onChange:t=>{z(s=>({...s,name:t.target.value})),t.target.value.trim()&&T.name&&V(s=>({...s,name:""}))},required:!0,className:`border-gray-200 ${T.name?"border-red-500 bg-red-50":""}`}),e.jsx(se,{name:"lastname",label:"Apellidos",value:w.lastname,error:T.lastname,onChange:t=>{z(s=>({...s,lastname:t.target.value})),t.target.value.trim()&&T.lastname&&V(s=>({...s,lastname:""}))},required:!0,className:`border-gray-200 ${T.lastname?"border-red-500 bg-red-50":""}`})]}),e.jsx(se,{name:"email",label:"Correo electrónico",type:"email",value:w.email,error:T.email,onChange:t=>{z(s=>({...s,email:t.target.value})),t.target.value.trim()&&T.email&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.target.value)&&V(r=>({...r,email:""}))},required:!0,className:`border-gray-200 ${T.email?"border-red-500 bg-red-50":""}`}),e.jsx(se,{name:"phone",label:"Teléfono",type:"tel",value:w.phone,error:T.phone,onChange:t=>{const s=t.target.value.replace(/\D/g,"");z(r=>({...r,phone:s})),s.length===9&&T.phone&&V(r=>({...r,phone:""}))},maxLength:"9",placeholder:"Ej: 987654321",required:!0,className:`border-gray-200 ${T.phone?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"block text-sm 2xl:text-base mb-2 font-medium customtext-neutral-dark",children:["Distrito / Provincia / Departamento (Ubicación de entrega)",e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx(Ue,{name:"ubigeo",cacheOptions:!0,value:X,loadOptions:ze,onChange:t=>{K(t),Te(t),ie("")},inputValue:fe,onInputChange:(t,{action:s})=>{s==="input-change"&&ie(t)},onFocus:()=>{K(null),ie("")},onMenuOpen:()=>{X&&(K(null),ie(""))},placeholder:"Buscar por Distrito ...",loadingMessage:()=>"Buscando ubicaciones...",noOptionsMessage:({inputValue:t})=>t.length<3?"Buscar por Distrito ...":"No se encontraron resultados",isLoading:oe,styles:De(!!T.ubigeo),formatOptionLabel:({data:t})=>e.jsxs("div",{className:"text-sm py-1",children:[e.jsx("div",{className:"font-medium",children:t.distrito}),e.jsxs("div",{className:"text-gray-500",children:[t.provincia,", ",t.departamento]})]}),className:"w-full rounded-xl transition-all duration-300",menuPortalTarget:document.body,isClearable:!0}),T.ubigeo&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:T.ubigeo})]}),e.jsx(se,{name:"address",label:"Dirección ",value:w.address,error:T.address,onChange:t=>{z(s=>({...s,address:t.target.value})),t.target.value.trim()&&T.address&&V(s=>({...s,address:""}))},required:!0,className:`border-gray-200 ${T.address?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(se,{label:"Número",value:w.number,onChange:t=>z(s=>({...s,number:t.target.value})),className:"border-gray-200"}),e.jsx(se,{label:"Referencia",value:w.reference,onChange:t=>z(s=>({...s,reference:t.target.value})),className:"border-gray-200"})]}),E.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Método de envío"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:E.map(t=>e.jsx(Ge,{title:t.deliveryType,price:t.price,description:t.description,selected:D===t.type,onSelect:()=>{G(t.type),g(t.price),V(s=>({...s,shipping:""}))}},t.type))}),D&&E.length>0&&e.jsx("div",{className:"space-y-3 mt-4",children:(Me=(Fe=E.find(t=>t.type===D))==null?void 0:Fe.characteristics)==null?void 0:Me.map((t,s)=>e.jsxs("div",{className:"flex items-start gap-3 bg-gray-50 p-4 rounded-xl",children:[e.jsx("div",{className:"w-5 flex-shrink-0",children:e.jsx(tt,{className:"customtext-primary"})}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm font-medium customtext-neutral-dark",children:t})})]},`char-${s}`))})]}),!f&&e.jsxs("div",{className:"flex flex-col md:flex-row justify-end gap-3 md:gap-4 mt-6",children:[e.jsx(Ie,{type:"button",onClick:()=>window.history.back(),className:"w-full md:w-auto",children:"Regresar"}),e.jsx(je,{type:"submit",loading:oe,className:"w-full md:w-auto",children:"Continuar"})]})]})}),e.jsxs("div",{className:"bg-[#F7F9FB] rounded-xl shadow-lg p-6 col-span-2 h-max",children:[e.jsx("h3",{className:"text-2xl font-bold pb-6",children:"Resumen"}),e.jsx("div",{className:"space-y-4 border-b-2 pb-6",children:n.map(t=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:`/storage/images/item/${t.image}`,alt:t.name,className:"w-16 h-16 object-cover rounded-lg",onError:s=>s.target.src="/api/cover/thumbnail/null"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Cantidad: ",t.quantity]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["S/ ",q(t.final_price)]})]})]},t.id))}),e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["S/ ",q(B(j))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"IGV (18%):"}),e.jsxs("span",{children:["S/ ",q(B(c))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Envío:"}),e.jsxs("span",{children:["S/ ",q(B(y))]})]}),e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium customtext-neutral-dark",children:"¿Tienes un cupón de descuento?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",placeholder:"Ingresa tu código de cupón",value:le,onChange:t=>Se(t.target.value.toUpperCase()),className:`w-full px-4 py-3 border customtext-neutral-dark  border-gray-100 rounded-xl focus:ring-0 focus:outline-0   transition-all duration-300 ${ke?"border-red-300 bg-red-50 text-red-900 focus:border-red-500 focus:ring-red-200":I?"border-gray-200 bg-white customtext-neutral-dark focus:ring-blue-200":" bg-white border-neutral-light focus:ring-0 focus:outline-0"} `,disabled:!!I||ge}),ge&&e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"})})]}),I?e.jsx("button",{type:"button",onClick:Ve,className:"px-4 py-3 bg-gray-200 customtext-neutral-dark text-sm rounded-xl hover:bg-gray-300 transition-colors duration-200",title:"Remover cupón",children:e.jsx(he,{className:"h-4 w-4"})}):e.jsx("button",{type:"button",onClick:Le,disabled:ge||!le.trim(),className:"px-6 py-3 bg-primary text-white text-sm font-medium rounded-xl hover:opacity-90 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200 whitespace-nowrap",children:ge?"Validando...":"Aplicar"})]}),ke&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(he,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:ke})]}),I&&e.jsx("div",{className:"bg-gray-50 border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsxs("p",{className:"customtext-primary font-semibold text-sm",children:["Descto. ",I.type==="percentage"?`${I.value}%`:`S/${q(I.value)}`]}),e.jsx("p",{className:"customtext-primary text-xs mt-1",children:I.code})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-primary font-bold text-base",children:["-S/ ",q(B(we))]})})]})})]})}),R&&R.length>0&&e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium customtext-neutral-dark mb-2",children:"🎉 Descuentos automáticos aplicados:"}),R.map((t,s)=>e.jsx("div",{className:" border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"customtext-neutral-dark font-semibold text-sm",children:t.name}),t.description&&e.jsx("p",{className:"customtext-neutral-dark text-xs mt-1",children:t.description})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-neutral-dark font-bold text-base",children:["-S/ ",q(t.amount)]})})]})},s)),Q>0&&e.jsx("div",{className:"l p-3",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark font-semibold",children:"Total descuentos automáticos:"}),e.jsxs("span",{className:"customtext-neutral-dark font-bold text-lg",children:["-S/ ",q(Q)]})]})})]})}),e.jsx("div",{className:"pt-4 border-t-2",children:e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["S/ ",q(B(ye))]})]})}),e.jsx(je,{onClick:Ae,className:"w-full mt-6",disabled:m,loading:m,children:m?"Procesando...":`Pagar S/ ${q(B(ye))}`}),e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>P(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>P(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})]})]})]})}function mt({cart:n,code:x,delivery:i,couponDiscount:u=0,couponCode:S=null,conversionScripts:N=null,automaticDiscounts:f=[],automaticDiscountTotal:j=0}){const c=n.reduce((l,P)=>{const F=P.final_price;return l+F*P.quantity},0),d=parseFloat((c/1.18).toFixed(2)),a=parseFloat((c-d).toFixed(2)),y=parseFloat(d)+parseFloat(a)+parseFloat(i)-u-j;return p.useEffect(()=>{if(N){console.log("Executing conversion scripts...");try{if(N.head){const l=document.createElement("script");l.innerHTML=N.head,document.head.appendChild(l)}if(N.body){const l=document.createElement("script");l.innerHTML=N.body,document.body.appendChild(l)}console.log("Conversion scripts executed successfully")}catch(l){console.error("Error executing conversion scripts:",l)}}},[N]),e.jsx(ae.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},className:"mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-12",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl p-6 md:p-10",children:e.jsxs(ae.div,{initial:{scale:.9},animate:{scale:1},transition:{delay:.3},className:"text-center space-y-6",children:[e.jsx(ae.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",delay:.5},className:"w-20 h-20 bg-secondary rounded-full mx-auto flex items-center justify-center",children:e.jsx("span",{className:"text-4xl",children:"✓"})}),e.jsx("h2",{className:"text-2xl md:text-3xl customtext-neutral-light animate-bounce",children:"¡Gracias por tu compra! 🎉"}),e.jsx("p",{className:"customtext-neutral-dark text-3xl md:text-5xl font-bold",children:"Tu orden ha sido recibida"}),e.jsxs(ae.div,{whileHover:{scale:1.05},className:"py-6 px-4 bg-secondary rounded-xl inline-block",children:[e.jsx("div",{className:"customtext-neutral-light",children:"Código de pedido"}),e.jsx("div",{className:"customtext-neutral-dark text-xl font-bold",children:`#${x}`})]}),e.jsxs("div",{className:"space-y-6 bg-[#F7F9FB] p-6 md:p-8 rounded-xl shadow-inner",children:[e.jsx("div",{className:"space-y-6 border-b-2 pb-6",children:n.map((l,P)=>e.jsx(ae.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:P*.2},className:"bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow duration-300",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6 items-center sm:items-start",children:[e.jsx("div",{className:"bg-gray-50 p-3 rounded-xl",children:e.jsx("img",{src:`/storage/images/item/${l.image}`,alt:l.name,className:"w-24 h-24 object-cover rounded-lg",onError:F=>F.target.src="/api/cover/thumbnail/null",loading:"lazy"})}),e.jsxs("div",{className:"text-center sm:text-left flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-xl lg:w-8/12 line-clamp-3",children:l.name}),e.jsx("div",{className:"mt-2 sm:mt-0 text-center lg:text-right lg:w-4/12",children:e.jsxs("div",{className:"font-bold text-lg customtext-primary",children:["S/ ",q(l.final_price*l.quantity)]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Marca: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:l.brand.name})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Cantidad: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:l.quantity})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["SKU: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:l.sku})]})]})]})]})},P))}),e.jsxs(ae.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},className:"space-y-4 mt-6",children:[[{label:"Subtotal",value:d},{label:"IGV",value:a},{label:"Envío",value:i}].map((l,P)=>e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"customtext-neutral-dark",children:l.label}),e.jsxs("span",{className:"font-semibold",children:["S/ ",q(l.value)]})]},P)),u>0&&S&&e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsxs("span",{className:"customtext-neutral-dark text-start",children:["Cupón: ",e.jsx("br",{className:"lg:hidden"}),e.jsxs("span",{className:"font-semibold text-xs lg:text-base",children:["(",S,")"]})]}),e.jsxs("span",{className:"font-semibold",children:["-S/ ",q(u)]})]}),j>0&&f.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6 customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),f.map((l,P)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[l.name,l.description&&e.jsx("span",{className:"text-xs font-semibold block",children:l.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-S/ ",q(l.amount)]})]},P)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-S/ ",q(j)]})]})]}),e.jsx("div",{className:"py-4 border-y-2 mt-6",children:e.jsxs("div",{className:"flex justify-between font-bold text-xl md:text-2xl items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["S/ ",q(y)]})]})})]}),e.jsx(ae.div,{className:"pt-6",whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsx(je,{href:"/catalogo",className:"w-full mx-auto md:w-auto",children:"Seguir Comprando"})})]})]})})})}const ut=()=>{const n=p.useRef({hasTrackedPageView:!1,hasTrackedInitiateCheckout:!1}),x=(c,d={})=>{typeof window>"u"||(typeof window.fbq<"u"&&window.fbq("track","ViewContent",{content_ids:[c],content_type:"product",content_name:d.name||"",value:d.price||0,currency:"PEN"}),typeof window.gtag<"u"&&window.gtag("event","view_item",{currency:"PEN",value:d.price||0,items:[{item_id:c,item_name:d.name||"",category:d.category||"",price:d.price||0}]}),typeof window.ttq<"u"&&window.ttq.track("ViewContent",{content_id:c,content_type:"product",content_name:d.name||"",value:d.price||0,currency:"PEN"}),console.log("✅ ProductView tracked for product:",c))},i=async(c,d=1,a={})=>{var g;if(!(typeof window>"u"))try{const l=await(await fetch("/api/tracking/add-to-cart",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((g=document.querySelector('meta[name="csrf-token"]'))==null?void 0:g.content)||""},body:JSON.stringify({product_id:c,quantity:d,...a})})).json();l.success&&l.tracking_scripts&&(f(l.tracking_scripts),console.log("✅ AddToCart tracked successfully"))}catch(y){console.error("❌ Error tracking AddToCart:",y)}},u=async(c,d)=>{var a;if(!(typeof window>"u"||n.current.hasTrackedInitiateCheckout))try{n.current.hasTrackedInitiateCheckout=!0;const y=await(await fetch("/api/tracking/initiate-checkout",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content)||""},body:JSON.stringify({cart_items:c.map(l=>({product_id:l.id,name:l.name,price:l.final_price||l.price,quantity:l.quantity,subtotal:(l.final_price||l.price)*l.quantity}))})})).json();y.success&&y.tracking_scripts&&(f(y.tracking_scripts),console.log("✅ InitiateCheckout tracked successfully"))}catch(g){console.error("❌ Error tracking InitiateCheckout:",g),n.current.hasTrackedInitiateCheckout=!1}},S=(c,d)=>{typeof window>"u"||(d?f(d):fetch(`/api/tracking/purchase/${c}`).then(a=>a.text()).then(a=>{a&&(f(a),console.log("✅ Purchase tracked successfully"))}).catch(a=>{console.error("❌ Error tracking Purchase:",a)}))},N=(c,d=[])=>{if(typeof window>"u"||n.current.hasTrackedPageView)return;n.current.hasTrackedPageView=!0;const a=d.reduce((g,y)=>g+(y.final_price||y.price)*y.quantity,0);typeof window.fbq<"u"&&(window.fbq("track","PageView"),c===1&&d.length>0&&window.fbq("track","AddToCart",{content_ids:d.map(g=>g.id),content_type:"product",value:a,currency:"PEN",num_items:d.length})),typeof window.gtag<"u"&&(window.gtag("event","page_view",{page_title:`Checkout - Paso ${c}`,page_location:window.location.href}),c===1&&d.length>0&&window.gtag("event","view_cart",{currency:"PEN",value:a,items:d.map(g=>{var y;return{item_id:g.id,item_name:g.name,category:((y=g.category)==null?void 0:y.name)||"Sin categoría",quantity:g.quantity,price:g.final_price||g.price}})})),console.log(`✅ Checkout PageView tracked - Step ${c}`)},f=c=>{if(typeof window>"u"||!c)return;const d=document.createElement("div");d.innerHTML=c,d.querySelectorAll("script").forEach(g=>{const y=document.createElement("script");y.textContent=g.textContent,document.head.appendChild(y),setTimeout(()=>{y.parentNode&&y.parentNode.removeChild(y)},100)})};return{trackProductView:x,trackAddToCart:i,trackInitiateCheckout:u,trackPurchase:S,trackCheckoutPageView:N,resetTracking:()=>{n.current={hasTrackedPageView:!1,hasTrackedInitiateCheckout:!1}}}};function ss({cart:n,setCart:x,user:i,ubigeos:u=[],items:S,generals:N}){const[f,j]=p.useState(1),c=n.reduce((M,J)=>M+J.final_price*J.quantity,0),{trackCheckoutPageView:d,trackInitiateCheckout:a,trackPurchase:g,resetTracking:y}=ut(),l=parseFloat((c/1.18).toFixed(2)),P=parseFloat((c-l).toFixed(2)),[F,L]=p.useState(0),[O,re]=p.useState(0),[Ne,Z]=p.useState(null),[Y,H]=p.useState([]),[X,K]=p.useState(0),ee=l+P+parseFloat(F),me=O+X,R=Math.max(0,ee-me),[ne,Q]=p.useState([]),[te,ue]=p.useState([]),[w,z]=p.useState([]),[oe,h]=p.useState(null);p.useEffect(()=>(d(f,n),()=>y()),[]),p.useEffect(()=>{d(f,n),f===2&&a(n,R)},[f]),p.useEffect(()=>{const M=document.createElement("script");return M.src=ce.CULQI_API,M.async=!0,M.onload=()=>{window.culqi=function(){window.Culqi.token||window.Culqi.order}},document.body.appendChild(M),()=>document.body.removeChild(M)},[]);const m=M=>{j(M),window.scrollTo({top:0,behavior:"smooth"})},C={privacy_policy:"Políticas de privacidad",terms_conditions:"Términos y condiciones",saleback_policy:"Políticas de devolucion y cambio"},[E,U]=p.useState(null),D=M=>U(M),G=()=>U(null);return e.jsxs("div",{className:"min-h-screen bg-[#F7F9FB] py-4 md:py-12 px-2 sm:px-primary 2xl:px-0 2xl:max-w-7xl mx-auto",children:[e.jsxs("div",{className:"bg-white p-3 md:p-8 rounded-lg md:rounded-xl shadow-sm",children:[e.jsx("div",{className:"mb-4 md:mb-8",children:e.jsxs("div",{className:"flex items-center justify-between gap-1 md:gap-4 max-w-3xl mx-auto",children:[e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${f===1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:" bg-primary text-white w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm",children:"1"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Carrito"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:f>1?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${f>1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${f>1?"bg-primary text-white":"bg-white customtext-primary"}`,children:"2"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Envío"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:f>2?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${f===3?"customtext-primary  font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${f===3?"bg-primary text-white":"bg-white customtext-primary"}`,children:"3"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Confirmación"})]})]})}),f===1&&e.jsx(it,{cart:n,setCart:x,onContinue:()=>m(2),subTotal:l,envio:F,igv:P,totalFinal:R,openModal:D,automaticDiscounts:Y,setAutomaticDiscounts:H,automaticDiscountTotal:X,setAutomaticDiscountTotal:K,totalWithoutDiscounts:ee}),f===2&&e.jsx(dt,{items:S,setCode:ue,setDelivery:z,cart:n,setSale:Q,setCart:x,onContinue:()=>m(3),noContinue:()=>m(1),subTotal:l,envio:F,setEnvio:L,igv:P,totalFinal:R,user:i,ubigeos:u,openModal:D,setCouponDiscount:re,setCouponCode:Z,automaticDiscounts:Y,automaticDiscountTotal:X,totalWithoutDiscounts:ee}),f===3&&e.jsx(mt,{code:te,delivery:w,cart:ne,subTotal:l,envio:F,igv:P,totalFinal:R,couponDiscount:O,couponCode:Ne,automaticDiscounts:Y,automaticDiscountTotal:X,totalWithoutDiscounts:ee,conversionScripts:oe,setConversionScripts:h,onPurchaseComplete:(M,J)=>{g(M,J)}})]}),Object.keys(C).map((M,J)=>{var fe;const T=C[M],V=((fe=N.find(ie=>ie.correlative==M))==null?void 0:fe.description)??"";return e.jsxs(Ze,{isOpen:E===J,onRequestClose:G,contentLabel:T,className:"absolute left-1/2 -translate-x-1/2 bg-white p-6 rounded-xl shadow-lg w-[95%] max-w-4xl my-8",overlayClassName:"fixed inset-0 bg-black bg-opacity-50 z-50",children:[e.jsx("button",{onClick:G,className:"float-right text-red-500 hover:text-red-700 transition-all duration-300 ",children:e.jsx(Re,{width:"2rem",strokeWidth:"4px"})}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:T}),e.jsx(et,{className:"prose",html:V})]},J)})]})}export{ss as default};
