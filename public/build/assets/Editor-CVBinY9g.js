const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as Vn}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as m,R as Pt}from"./index-BH53Isel.js";import{T as nn,l as me,i as rn,D as Gn,H as Wn,U as qn,R as Qn,B as rt,F as Jn,E as Go}from"./EditableCell-DehGgdxe.js";import{h as Wo}from"./thumbnailGenerator-B4goYG9Y.js";import{B as lt}from"./dom-to-image-more.min-D1PIV9fo.js";import{L as dt}from"./layers-6oegOx-p.js";import{C as Kn}from"./chevron-down-DS-mdh9v.js";import{C as Yn}from"./chevron-right-Ckt5D2ka.js";import{E as Xn}from"./eye-CKCH9ORv.js";import{c as Ee}from"./createLucideIcon-Cy5Ya80P.js";import{T as an}from"./trash-2-DK1wnsDn.js";import{S as Zn}from"./star-wPQTHY_n.js";import{I as Re}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as ee,T as Dn}from"./index-BZYhE2TF.js";import{m as qo}from"./main-6DCdASTx.js";import{B as er}from"./V1Edit-DW0Ov01F.js";import{G as Qo}from"./Global-D6eBBAMK.js";import{S as sn}from"./save-BvSyoVHO.js";import{C as tr}from"./clock-BTrEpQej.js";import{T as or}from"./triangle-alert-vFMqKi4t.js";import{C as nr}from"./check-DQ7QoS0v.js";import{L as rr}from"./loader-circle-CrvBvIt1.js";import{C as ar}from"./chevron-left-B2s3ZsB7.js";import{F as Jo}from"./filter-Ci9tsc_e.js";import{P as ct}from"./plus-Bot15Khs.js";import{C as sr}from"./copy-6OEekgvq.js";import{C as ir}from"./circle-check-big-D6DM3vPb.js";import{u as lr}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cr=Ee("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dr=Ee("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ur=Ee("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gr=Ee("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mr=Ee("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hr=Ee("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=Ee("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pr=Ee("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fr=Ee("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ko=Ee("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xr=Ee("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),br=({pages:t,currentPage:s,selectedCell:i,selectedElement:u,onSelectCell:a,onSelectElement:g,onUpdateElement:w,onDeleteElement:S,onMoveElement:y})=>{var z;if(!t||!t[s])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(dt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const x=t[s],P=((z=x==null?void 0:x.cells)==null?void 0:z.filter(T=>T.elements&&T.elements.length>0))||[],[U,v]=m.useState(()=>{const T={};return P.forEach(O=>{T[O.id]=!0}),T}),N=T=>{v(O=>({...O,[T]:!O[T]}))},E=T=>{switch(T){case"image":return e.jsx(Re,{className:"h-4 w-4"});case"text":return e.jsx(nn,{className:"h-4 w-4"});case"shape":return e.jsx(fr,{className:"h-4 w-4"});case"sticker":return e.jsx(Zn,{className:"h-4 w-4"});default:return e.jsx(gr,{className:"h-4 w-4"})}},A=(T,O)=>{switch(T.type){case"text":return T.content?T.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${O+1}`;case"shape":return T.shape||"Shape";case"sticker":return`Sticker ${O+1}`;default:return`Element ${O+1}`}},C=(T,O,J)=>{w(T,O,{visible:J})},_=(T,O)=>{a(T),g(O)};return e.jsx("div",{className:"space-y-2",children:P.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(dt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):P.map(T=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${i===T.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{N(T.id),a(T.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:U[T.id]?e.jsx(Kn,{className:"h-4 w-4"}):e.jsx(Yn,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",T.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[T.elements.length," element",T.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[T.x,", ",T.y]})]}),U[T.id]&&e.jsx("div",{className:"border-t border-gray-100",children:T.elements.map((O,J)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${u===O.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>_(T.id,O.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:E(O.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:A(O,J)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[O.type," ‚Ä¢ Layer ",J+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:V=>{V.stopPropagation(),C(T.id,O.id,!O.visible)},className:"p-1 hover:bg-gray-200 rounded",title:O.visible?"Hide element":"Show element",children:O.visible!==!1?e.jsx(Xn,{className:"h-3 w-3 text-gray-500"}):e.jsx(hr,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:V=>{V.stopPropagation(),y(T.id,O.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:J===T.elements.length-1,children:e.jsx(dr,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:V=>{V.stopPropagation(),y(T.id,O.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:J===0,children:e.jsx(cr,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:V=>{V.stopPropagation(),S(T.id,O.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(an,{className:"h-3 w-3"})})]})]},O.id))})]},T.id))})};function vr({currentLayoutId:t,onLayoutChange:s}){const[i,u]=m.useState("all"),a={all:{name:"Todos",layouts:me},hero:{name:"Hero",layouts:me.filter(g=>g.category==="hero")},editorial:{name:"Editorial",layouts:me.filter(g=>g.category==="editorial")},storytelling:{name:"Historia",layouts:me.filter(g=>g.category==="storytelling")},minimal:{name:"Minimal",layouts:me.filter(g=>g.category==="minimal")},creative:{name:"Creativo",layouts:me.filter(g=>g.category==="creative")},classic:{name:"Cl√°sico",layouts:me.filter(g=>g.category==="classic")}};return Object.keys(a).filter(g=>g==="all"||a[g].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:a[i].layouts.map(g=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>s(g.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${g.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:g.cells}).map((w,S)=>{var y,x;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(x=(y=g.cellStyles)==null?void 0:y[S])!=null&&x.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},S)})}),t===g.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:g.name}),g.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:g.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[g.cells," ",g.cells===1?"celda":"celdas"]})})]})]},g.id))}),a[i].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categor√≠a."})})]})}const yr=({selectedMask:t,onSelect:s,availableMasks:i=[],selectedImage:u})=>{var S,y;const[a,g]=m.useState("B√°sicas"),w={};return rn.forEach(x=>{w[x.category]||(w[x.category]=[]),(i.includes(x.id)||x.id==="none")&&w[x.category].push(x)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(w).slice(0,2).map(x=>w[x].length>0&&e.jsx("button",{onClick:()=>g(x),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${a===x?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:x},x))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(S=w[a])==null?void 0:S.slice(0,6).map(x=>e.jsxs("div",{onClick:()=>s(x.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${t===x.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:u!=null&&u.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:u.content,alt:x.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:x.name})]},x.id))}),((y=w[a])==null?void 0:y.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver m√°s m√°scaras (",w[a].length-6," m√°s)"]})]})};let Mt={},ln;function Tt(t={}){Mt={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...t}}function R(t){return t?Mt[t]:Mt}function wr(t){ln=t}function ve(){return ln}let ut={};function at(t,s){ut[t]=s}function Ue(t){var s;(s=ut[t])==null||s.call(ut)}function Er(){ut={}}function st(t,s,i,u){return(t/=u/2)<1?i/2*t*t+s:-i/2*(--t*(t-2)-1)+s}function cn(t){const s='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return t.flatMap(i=>{const u=i.matches(s),a=Array.from(i.querySelectorAll(s));return[...u?[i]:[],...a]}).filter(i=>getComputedStyle(i).pointerEvents!=="none"&&Sr(i))}function dn(t){if(!t||Nr(t))return;const s=R("smoothScroll"),i=t.offsetHeight>window.innerHeight;t.scrollIntoView({behavior:!s||jr(t)?"auto":"smooth",inline:"center",block:i?"start":"center"})}function jr(t){if(!t||!t.parentElement)return;const s=t.parentElement;return s.scrollHeight>s.clientHeight}function Nr(t){const s=t.getBoundingClientRect();return s.top>=0&&s.left>=0&&s.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&s.right<=(window.innerWidth||document.documentElement.clientWidth)}function Sr(t){return!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length)}let gt={};function de(t,s){gt[t]=s}function F(t){return t?gt[t]:gt}function Yo(){gt={}}function Cr(t,s,i,u){let a=F("__activeStagePosition");const g=a||i.getBoundingClientRect(),w=u.getBoundingClientRect(),S=st(t,g.x,w.x-g.x,s),y=st(t,g.y,w.y-g.y,s),x=st(t,g.width,w.width-g.width,s),P=st(t,g.height,w.height-g.height,s);a={x:S,y,width:x,height:P},gn(a),de("__activeStagePosition",a)}function un(t){if(!t)return;const s=t.getBoundingClientRect(),i={x:s.x,y:s.y,width:s.width,height:s.height};de("__activeStagePosition",i),gn(i)}function kr(){const t=F("__activeStagePosition"),s=F("__overlaySvg");if(!t)return;if(!s){console.warn("No stage svg found.");return}const i=window.innerWidth,u=window.innerHeight;s.setAttribute("viewBox",`0 0 ${i} ${u}`)}function Ar(t){const s=Tr(t);document.body.appendChild(s),pn(s,i=>{i.target.tagName==="path"&&Ue("overlayClick")}),de("__overlaySvg",s)}function gn(t){const s=F("__overlaySvg");if(!s){Ar(t);return}const i=s.firstElementChild;if((i==null?void 0:i.tagName)!=="path")throw new Error("no path element found in stage svg");i.setAttribute("d",mn(t))}function Tr(t){const s=window.innerWidth,i=window.innerHeight,u=document.createElementNS("http://www.w3.org/2000/svg","svg");u.classList.add("driver-overlay","driver-overlay-animated"),u.setAttribute("viewBox",`0 0 ${s} ${i}`),u.setAttribute("xmlSpace","preserve"),u.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),u.setAttribute("version","1.1"),u.setAttribute("preserveAspectRatio","xMinYMin slice"),u.style.fillRule="evenodd",u.style.clipRule="evenodd",u.style.strokeLinejoin="round",u.style.strokeMiterlimit="2",u.style.zIndex="10000",u.style.position="fixed",u.style.top="0",u.style.left="0",u.style.width="100%",u.style.height="100%";const a=document.createElementNS("http://www.w3.org/2000/svg","path");return a.setAttribute("d",mn(t)),a.style.fill=R("overlayColor")||"rgb(0,0,0)",a.style.opacity=`${R("overlayOpacity")}`,a.style.pointerEvents="auto",a.style.cursor="auto",u.appendChild(a),u}function mn(t){const s=window.innerWidth,i=window.innerHeight,u=R("stagePadding")||0,a=R("stageRadius")||0,g=t.width+u*2,w=t.height+u*2,S=Math.min(a,g/2,w/2),y=Math.floor(Math.max(S,0)),x=t.x-u+y,P=t.y-u,U=g-y*2,v=w-y*2;return`M${s},0L0,0L0,${i}L${s},${i}L${s},0Z
    M${x},${P} h${U} a${y},${y} 0 0 1 ${y},${y} v${v} a${y},${y} 0 0 1 -${y},${y} h-${U} a${y},${y} 0 0 1 -${y},-${y} v-${v} a${y},${y} 0 0 1 ${y},-${y} z`}function Ir(){const t=F("__overlaySvg");t&&t.remove()}function Pr(){const t=document.getElementById("driver-dummy-element");if(t)return t;let s=document.createElement("div");return s.id="driver-dummy-element",s.style.width="0",s.style.height="0",s.style.pointerEvents="none",s.style.opacity="0",s.style.position="fixed",s.style.top="50%",s.style.left="50%",document.body.appendChild(s),s}function Xo(t){const{element:s}=t;let i=typeof s=="function"?s():typeof s=="string"?document.querySelector(s):s;i||(i=Pr()),_r(i,t)}function Mr(){const t=F("__activeElement"),s=F("__activeStep");t&&(un(t),kr(),xn(t,s))}function _r(t,s){var i;const u=Date.now(),a=F("__activeStep"),g=F("__activeElement")||t,w=!g||g===t,S=t.id==="driver-dummy-element",y=g.id==="driver-dummy-element",x=R("animate"),P=s.onHighlightStarted||R("onHighlightStarted"),U=(s==null?void 0:s.onHighlighted)||R("onHighlighted"),v=(a==null?void 0:a.onDeselected)||R("onDeselected"),N=R(),E=F();!w&&v&&v(y?void 0:g,a,{config:N,state:E,driver:ve()}),P&&P(S?void 0:t,s,{config:N,state:E,driver:ve()});const A=!w&&x;let C=!1;Ur(),de("previousStep",a),de("previousElement",g),de("activeStep",s),de("activeElement",t);const _=()=>{if(F("__transitionCallback")!==_)return;const z=Date.now()-u,T=400-z<=400/2;s.popover&&T&&!C&&A&&(Zo(t,s),C=!0),R("animate")&&z<400?Cr(z,400,g,t):(un(t),U&&U(S?void 0:t,s,{config:R(),state:F(),driver:ve()}),de("__transitionCallback",void 0),de("__previousStep",a),de("__previousElement",g),de("__activeStep",s),de("__activeElement",t)),window.requestAnimationFrame(_)};de("__transitionCallback",_),window.requestAnimationFrame(_),dn(t),!A&&s.popover&&Zo(t,s),g.classList.remove("driver-active-element","driver-no-interaction"),g.removeAttribute("aria-haspopup"),g.removeAttribute("aria-expanded"),g.removeAttribute("aria-controls"),((i=s.disableActiveInteraction)!=null?i:R("disableActiveInteraction"))&&t.classList.add("driver-no-interaction"),t.classList.add("driver-active-element"),t.setAttribute("aria-haspopup","dialog"),t.setAttribute("aria-expanded","true"),t.setAttribute("aria-controls","driver-popover-content")}function $r(){var t;(t=document.getElementById("driver-dummy-element"))==null||t.remove(),document.querySelectorAll(".driver-active-element").forEach(s=>{s.classList.remove("driver-active-element","driver-no-interaction"),s.removeAttribute("aria-haspopup"),s.removeAttribute("aria-expanded"),s.removeAttribute("aria-controls")})}function Ye(){const t=F("__resizeTimeout");t&&window.cancelAnimationFrame(t),de("__resizeTimeout",window.requestAnimationFrame(Mr))}function Lr(t){var s;if(!F("isInitialized")||!(t.key==="Tab"||t.keyCode===9))return;const i=F("__activeElement"),u=(s=F("popover"))==null?void 0:s.wrapper,a=cn([...u?[u]:[],...i?[i]:[]]),g=a[0],w=a[a.length-1];if(t.preventDefault(),t.shiftKey){const S=a[a.indexOf(document.activeElement)-1]||w;S==null||S.focus()}else{const S=a[a.indexOf(document.activeElement)+1]||g;S==null||S.focus()}}function hn(t){var s;((s=R("allowKeyboardControl"))==null||s)&&(t.key==="Escape"?Ue("escapePress"):t.key==="ArrowRight"?Ue("arrowRightPress"):t.key==="ArrowLeft"&&Ue("arrowLeftPress"))}function pn(t,s,i){const u=(a,g)=>{const w=a.target;t.contains(w)&&((!i||i(w))&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation()),g==null||g(a))};document.addEventListener("pointerdown",u,!0),document.addEventListener("mousedown",u,!0),document.addEventListener("pointerup",u,!0),document.addEventListener("mouseup",u,!0),document.addEventListener("click",a=>{u(a,s)},!0)}function Or(){window.addEventListener("keyup",hn,!1),window.addEventListener("keydown",Lr,!1),window.addEventListener("resize",Ye),window.addEventListener("scroll",Ye)}function Rr(){window.removeEventListener("keyup",hn),window.removeEventListener("resize",Ye),window.removeEventListener("scroll",Ye)}function Ur(){const t=F("popover");t&&(t.wrapper.style.display="none")}function Zo(t,s){var i,u;let a=F("popover");a&&document.body.removeChild(a.wrapper),a=Br(),document.body.appendChild(a.wrapper);const{title:g,description:w,showButtons:S,disableButtons:y,showProgress:x,nextBtnText:P=R("nextBtnText")||"Next &rarr;",prevBtnText:U=R("prevBtnText")||"&larr; Previous",progressText:v=R("progressText")||"{current} of {total}"}=s.popover||{};a.nextButton.innerHTML=P,a.previousButton.innerHTML=U,a.progress.innerHTML=v,g?(a.title.innerHTML=g,a.title.style.display="block"):a.title.style.display="none",w?(a.description.innerHTML=w,a.description.style.display="block"):a.description.style.display="none";const N=S||R("showButtons"),E=x||R("showProgress")||!1,A=(N==null?void 0:N.includes("next"))||(N==null?void 0:N.includes("previous"))||E;a.closeButton.style.display=N.includes("close")?"block":"none",A?(a.footer.style.display="flex",a.progress.style.display=E?"block":"none",a.nextButton.style.display=N.includes("next")?"block":"none",a.previousButton.style.display=N.includes("previous")?"block":"none"):a.footer.style.display="none";const C=y||R("disableButtons")||[];C!=null&&C.includes("next")&&(a.nextButton.disabled=!0,a.nextButton.classList.add("driver-popover-btn-disabled")),C!=null&&C.includes("previous")&&(a.previousButton.disabled=!0,a.previousButton.classList.add("driver-popover-btn-disabled")),C!=null&&C.includes("close")&&(a.closeButton.disabled=!0,a.closeButton.classList.add("driver-popover-btn-disabled"));const _=a.wrapper;_.style.display="block",_.style.left="",_.style.top="",_.style.bottom="",_.style.right="",_.id="driver-popover-content",_.setAttribute("role","dialog"),_.setAttribute("aria-labelledby","driver-popover-title"),_.setAttribute("aria-describedby","driver-popover-description");const z=a.arrow;z.className="driver-popover-arrow";const T=((i=s.popover)==null?void 0:i.popoverClass)||R("popoverClass")||"";_.className=`driver-popover ${T}`.trim(),pn(a.wrapper,re=>{var se,fe,c;const oe=re.target,h=((se=s.popover)==null?void 0:se.onNextClick)||R("onNextClick"),ae=((fe=s.popover)==null?void 0:fe.onPrevClick)||R("onPrevClick"),ie=((c=s.popover)==null?void 0:c.onCloseClick)||R("onCloseClick");if(oe.closest(".driver-popover-next-btn"))return h?h(t,s,{config:R(),state:F(),driver:ve()}):Ue("nextClick");if(oe.closest(".driver-popover-prev-btn"))return ae?ae(t,s,{config:R(),state:F(),driver:ve()}):Ue("prevClick");if(oe.closest(".driver-popover-close-btn"))return ie?ie(t,s,{config:R(),state:F(),driver:ve()}):Ue("closeClick")},re=>!(a!=null&&a.description.contains(re))&&!(a!=null&&a.title.contains(re))&&typeof re.className=="string"&&re.className.includes("driver-popover")),de("popover",a);const O=((u=s.popover)==null?void 0:u.onPopoverRender)||R("onPopoverRender");O&&O(a,{config:R(),state:F(),driver:ve()}),xn(t,s),dn(_);const J=t.classList.contains("driver-dummy-element"),V=cn([_,...J?[]:[t]]);V.length>0&&V[0].focus()}function fn(){const t=F("popover");if(!(t!=null&&t.wrapper))return;const s=t.wrapper.getBoundingClientRect(),i=R("stagePadding")||0,u=R("popoverOffset")||0;return{width:s.width+i+u,height:s.height+i+u,realWidth:s.width,realHeight:s.height}}function Do(t,s){const{elementDimensions:i,popoverDimensions:u,popoverPadding:a,popoverArrowDimensions:g}=s;return t==="start"?Math.max(Math.min(i.top-a,window.innerHeight-u.realHeight-g.width),g.width):t==="end"?Math.max(Math.min(i.top-(u==null?void 0:u.realHeight)+i.height+a,window.innerHeight-(u==null?void 0:u.realHeight)-g.width),g.width):t==="center"?Math.max(Math.min(i.top+i.height/2-(u==null?void 0:u.realHeight)/2,window.innerHeight-(u==null?void 0:u.realHeight)-g.width),g.width):0}function en(t,s){const{elementDimensions:i,popoverDimensions:u,popoverPadding:a,popoverArrowDimensions:g}=s;return t==="start"?Math.max(Math.min(i.left-a,window.innerWidth-u.realWidth-g.width),g.width):t==="end"?Math.max(Math.min(i.left-(u==null?void 0:u.realWidth)+i.width+a,window.innerWidth-(u==null?void 0:u.realWidth)-g.width),g.width):t==="center"?Math.max(Math.min(i.left+i.width/2-(u==null?void 0:u.realWidth)/2,window.innerWidth-(u==null?void 0:u.realWidth)-g.width),g.width):0}function xn(t,s){const i=F("popover");if(!i)return;const{align:u="start",side:a="left"}=(s==null?void 0:s.popover)||{},g=u,w=t.id==="driver-dummy-element"?"over":a,S=R("stagePadding")||0,y=fn(),x=i.arrow.getBoundingClientRect(),P=t.getBoundingClientRect(),U=P.top-y.height;let v=U>=0;const N=window.innerHeight-(P.bottom+y.height);let E=N>=0;const A=P.left-y.width;let C=A>=0;const _=window.innerWidth-(P.right+y.width);let z=_>=0;const T=!v&&!E&&!C&&!z;let O=w;if(w==="top"&&v?z=C=E=!1:w==="bottom"&&E?z=C=v=!1:w==="left"&&C?z=v=E=!1:w==="right"&&z&&(C=v=E=!1),w==="over"){const J=window.innerWidth/2-y.realWidth/2,V=window.innerHeight/2-y.realHeight/2;i.wrapper.style.left=`${J}px`,i.wrapper.style.right="auto",i.wrapper.style.top=`${V}px`,i.wrapper.style.bottom="auto"}else if(T){const J=window.innerWidth/2-(y==null?void 0:y.realWidth)/2,V=10;i.wrapper.style.left=`${J}px`,i.wrapper.style.right="auto",i.wrapper.style.bottom=`${V}px`,i.wrapper.style.top="auto"}else if(C){const J=Math.min(A,window.innerWidth-(y==null?void 0:y.realWidth)-x.width),V=Do(g,{elementDimensions:P,popoverDimensions:y,popoverPadding:S,popoverArrowDimensions:x});i.wrapper.style.left=`${J}px`,i.wrapper.style.top=`${V}px`,i.wrapper.style.bottom="auto",i.wrapper.style.right="auto",O="left"}else if(z){const J=Math.min(_,window.innerWidth-(y==null?void 0:y.realWidth)-x.width),V=Do(g,{elementDimensions:P,popoverDimensions:y,popoverPadding:S,popoverArrowDimensions:x});i.wrapper.style.right=`${J}px`,i.wrapper.style.top=`${V}px`,i.wrapper.style.bottom="auto",i.wrapper.style.left="auto",O="right"}else if(v){const J=Math.min(U,window.innerHeight-y.realHeight-x.width);let V=en(g,{elementDimensions:P,popoverDimensions:y,popoverPadding:S,popoverArrowDimensions:x});i.wrapper.style.top=`${J}px`,i.wrapper.style.left=`${V}px`,i.wrapper.style.bottom="auto",i.wrapper.style.right="auto",O="top"}else if(E){const J=Math.min(N,window.innerHeight-(y==null?void 0:y.realHeight)-x.width);let V=en(g,{elementDimensions:P,popoverDimensions:y,popoverPadding:S,popoverArrowDimensions:x});i.wrapper.style.left=`${V}px`,i.wrapper.style.bottom=`${J}px`,i.wrapper.style.top="auto",i.wrapper.style.right="auto",O="bottom"}T?i.arrow.classList.add("driver-popover-arrow-none"):zr(g,O,t)}function zr(t,s,i){const u=F("popover");if(!u)return;const a=i.getBoundingClientRect(),g=fn(),w=u.arrow,S=g.width,y=window.innerWidth,x=a.width,P=a.left,U=g.height,v=window.innerHeight,N=a.top,E=a.height;w.className="driver-popover-arrow";let A=s,C=t;if(s==="top"?(P+x<=0?(A="right",C="end"):P+x-S<=0&&(A="top",C="start"),P>=y?(A="left",C="end"):P+S>=y&&(A="top",C="end")):s==="bottom"?(P+x<=0?(A="right",C="start"):P+x-S<=0&&(A="bottom",C="start"),P>=y?(A="left",C="start"):P+S>=y&&(A="bottom",C="end")):s==="left"?(N+E<=0?(A="bottom",C="end"):N+E-U<=0&&(A="left",C="start"),N>=v?(A="top",C="end"):N+U>=v&&(A="left",C="end")):s==="right"&&(N+E<=0?(A="bottom",C="start"):N+E-U<=0&&(A="right",C="start"),N>=v?(A="top",C="start"):N+U>=v&&(A="right",C="end")),!A)w.classList.add("driver-popover-arrow-none");else{w.classList.add(`driver-popover-arrow-side-${A}`),w.classList.add(`driver-popover-arrow-align-${C}`);const _=i.getBoundingClientRect(),z=w.getBoundingClientRect(),T=R("stagePadding")||0,O=_.left-T<window.innerWidth&&_.right+T>0&&_.top-T<window.innerHeight&&_.bottom+T>0;s==="bottom"&&O&&(z.x>_.x&&z.x+z.width<_.x+_.width?u.wrapper.style.transform="translateY(0)":(w.classList.remove(`driver-popover-arrow-align-${C}`),w.classList.add("driver-popover-arrow-none"),u.wrapper.style.transform=`translateY(-${T/2}px)`))}}function Br(){const t=document.createElement("div");t.classList.add("driver-popover");const s=document.createElement("div");s.classList.add("driver-popover-arrow");const i=document.createElement("header");i.id="driver-popover-title",i.classList.add("driver-popover-title"),i.style.display="none",i.innerText="Popover Title";const u=document.createElement("div");u.id="driver-popover-description",u.classList.add("driver-popover-description"),u.style.display="none",u.innerText="Popover description is here";const a=document.createElement("button");a.type="button",a.classList.add("driver-popover-close-btn"),a.setAttribute("aria-label","Close"),a.innerHTML="&times;";const g=document.createElement("footer");g.classList.add("driver-popover-footer");const w=document.createElement("span");w.classList.add("driver-popover-progress-text"),w.innerText="";const S=document.createElement("span");S.classList.add("driver-popover-navigation-btns");const y=document.createElement("button");y.type="button",y.classList.add("driver-popover-prev-btn"),y.innerHTML="&larr; Previous";const x=document.createElement("button");return x.type="button",x.classList.add("driver-popover-next-btn"),x.innerHTML="Next &rarr;",S.appendChild(y),S.appendChild(x),g.appendChild(w),g.appendChild(S),t.appendChild(a),t.appendChild(s),t.appendChild(i),t.appendChild(u),t.appendChild(g),{wrapper:t,arrow:s,title:i,description:u,footer:g,previousButton:y,nextButton:x,closeButton:a,footerButtons:S,progress:w}}function Hr(){var t;const s=F("popover");s&&((t=s.wrapper.parentElement)==null||t.removeChild(s.wrapper))}function Fr(t={}){Tt(t);function s(){R("allowClose")&&P()}function i(){const v=R("overlayClickBehavior");if(R("allowClose")&&v==="close"){P();return}v==="nextStep"&&u()}function u(){const v=F("activeIndex"),N=R("steps")||[];if(typeof v>"u")return;const E=v+1;N[E]?x(E):P()}function a(){const v=F("activeIndex"),N=R("steps")||[];if(typeof v>"u")return;const E=v-1;N[E]?x(E):P()}function g(v){(R("steps")||[])[v]?x(v):P()}function w(){var v;if(F("__transitionCallback"))return;const N=F("activeIndex"),E=F("__activeStep"),A=F("__activeElement");if(typeof N>"u"||typeof E>"u"||typeof F("activeIndex")>"u")return;const C=((v=E.popover)==null?void 0:v.onPrevClick)||R("onPrevClick");if(C)return C(A,E,{config:R(),state:F(),driver:ve()});a()}function S(){var v;if(F("__transitionCallback"))return;const N=F("activeIndex"),E=F("__activeStep"),A=F("__activeElement");if(typeof N>"u"||typeof E>"u")return;const C=((v=E.popover)==null?void 0:v.onNextClick)||R("onNextClick");if(C)return C(A,E,{config:R(),state:F(),driver:ve()});u()}function y(){F("isInitialized")||(de("isInitialized",!0),document.body.classList.add("driver-active",R("animate")?"driver-fade":"driver-simple"),Or(),at("overlayClick",i),at("escapePress",s),at("arrowLeftPress",w),at("arrowRightPress",S))}function x(v=0){var N,E,A,C,_,z,T,O;const J=R("steps");if(!J){console.error("No steps to drive through"),P();return}if(!J[v]){P();return}de("__activeOnDestroyed",document.activeElement),de("activeIndex",v);const V=J[v],re=J[v+1],se=J[v-1],fe=((N=V.popover)==null?void 0:N.doneBtnText)||R("doneBtnText")||"Done",c=R("allowClose"),oe=typeof((E=V.popover)==null?void 0:E.showProgress)<"u"?(A=V.popover)==null?void 0:A.showProgress:R("showProgress"),h=(((C=V.popover)==null?void 0:C.progressText)||R("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${v+1}`).replace("{{total}}",`${J.length}`),ae=((_=V.popover)==null?void 0:_.showButtons)||R("showButtons"),ie=["next","previous",...c?["close"]:[]].filter(W=>!(ae!=null&&ae.length)||ae.includes(W)),Be=((z=V.popover)==null?void 0:z.onNextClick)||R("onNextClick"),B=((T=V.popover)==null?void 0:T.onPrevClick)||R("onPrevClick"),Z=((O=V.popover)==null?void 0:O.onCloseClick)||R("onCloseClick");Xo({...V,popover:{showButtons:ie,nextBtnText:re?void 0:fe,disableButtons:[...se?[]:["previous"]],showProgress:oe,progressText:h,onNextClick:Be||(()=>{re?x(v+1):P()}),onPrevClick:B||(()=>{x(v-1)}),onCloseClick:Z||(()=>{P()}),...(V==null?void 0:V.popover)||{}}})}function P(v=!0){const N=F("__activeElement"),E=F("__activeStep"),A=F("__activeOnDestroyed"),C=R("onDestroyStarted");if(v&&C){const T=!N||(N==null?void 0:N.id)==="driver-dummy-element";C(T?void 0:N,E,{config:R(),state:F(),driver:ve()});return}const _=(E==null?void 0:E.onDeselected)||R("onDeselected"),z=R("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),Rr(),Hr(),$r(),Ir(),Er(),Yo(),N&&E){const T=N.id==="driver-dummy-element";_&&_(T?void 0:N,E,{config:R(),state:F(),driver:ve()}),z&&z(T?void 0:N,E,{config:R(),state:F(),driver:ve()})}A&&A.focus()}const U={isActive:()=>F("isInitialized")||!1,refresh:Ye,drive:(v=0)=>{y(),x(v)},setConfig:Tt,setSteps:v=>{Yo(),Tt({...R(),steps:v})},getConfig:R,getState:F,getActiveIndex:()=>F("activeIndex"),isFirstStep:()=>F("activeIndex")===0,isLastStep:()=>{const v=R("steps")||[],N=F("activeIndex");return N!==void 0&&N===v.length-1},getActiveStep:()=>F("activeStep"),getActiveElement:()=>F("activeElement"),getPreviousElement:()=>F("previousElement"),getPreviousStep:()=>F("previousStep"),moveNext:u,movePrevious:a,moveTo:g,hasNextStep:()=>{const v=R("steps")||[],N=F("activeIndex");return N!==void 0&&!!v[N+1]},hasPreviousStep:()=>{const v=R("steps")||[],N=F("activeIndex");return N!==void 0&&!!v[N-1]},highlight:v=>{y(),Xo({...v,popover:v.popover?{showButtons:[],showProgress:!1,progressText:"",...v.popover}:void 0})},destroy:()=>{P(!1)}};return wr(U),U}const Ie=new Map,ze=new Map;async function bn(t){return Ie.has(t)?Ie.get(t):new Promise((s,i)=>{const u=new Image;u.crossOrigin="anonymous",u.onload=()=>{Ie.set(t,u),s(u)},u.onerror=()=>{console.warn(`‚ö†Ô∏è No se pudo cargar imagen: ${t}`),s(null)},setTimeout(()=>{Ie.has(t)||(console.warn(`‚è∞ Timeout cargando imagen: ${t}`),s(null))},3e3),u.src=t})}function vn(t,s,i){var N,E,A,C;const{x:u,y:a,width:g,height:w}=i,S=((N=s.position)==null?void 0:N.x)||0,y=((E=s.position)==null?void 0:E.y)||0,x=u+(S<=1?S*g:S),P=a+(y<=1?y*w:y),U=(A=s.size)!=null&&A.width?s.size.width<=1?s.size.width*g:s.size.width:g,v=(C=s.size)!=null&&C.height?s.size.height<=1?s.size.height*w:s.size.height:w;if(s.type==="image"&&s.content){const _=Ie.get(s.content);if(_){if(t.save(),s.filters){const{brightness:se=100,contrast:fe=100,saturation:c=100,opacity:oe=100}=s.filters;(se!==100||fe!==100||c!==100||oe!==100)&&(t.filter=`brightness(${se/100}) contrast(${fe/100}) saturate(${c/100}) opacity(${oe/100})`)}const z=_.width/_.height,T=U/v;let O=0,J=0,V=_.width,re=_.height;z>T?(V=_.height*T,O=(_.width-V)/2):(re=_.width/T,J=(_.height-re)/2),t.drawImage(_,O,J,V,re,x,P,U,v),t.restore()}}else if(s.type==="text"&&s.content){t.save();const _=s.style||{},z=Math.max(8,parseInt(_.fontSize)||16),T=_.color||"#000000";t.font=`${z}px Arial, sans-serif`,t.fillStyle=T,t.textBaseline="top";let O=s.content.split(`
`)[0]||"";O.length>50&&(O=O.substring(0,50)+"..."),t.fillText(O,x+4,P+4),t.restore()}}async function Vr({page:t,workspaceDimensions:s,onProgress:i=null}){console.log(`‚ö° Generando thumbnail para p√°gina: ${t.id}`);const a=(g,w,S="")=>{const y=Math.round(g/w*100);console.log(`üìä Progreso p√°gina ${t.id}: ${g}/${w} (${y}%) ${S}`),i&&i({current:g,total:w,percentage:y,message:S,pageId:t.id})};try{const g=300/Math.max(s.width,s.height),w=Math.round(s.width*g),S=Math.round(s.height*g),y=`${t.id}-${w}x${S}`;if(ze.has(y))return console.log(`üì¶ Thumbnail encontrado en cache: ${t.id}`),a(4,4,"Cargado desde cache"),ze.get(y);a(1,4,"Iniciando generaci√≥n...");const x=new Set;t.backgroundImage&&x.add(t.backgroundImage),t.cells&&t.cells.forEach(E=>{E.elements&&E.elements.forEach(A=>{A.type==="image"&&A.content&&x.add(A.content)})}),a(2,4,"Cargando im√°genes...");const P=Array.from(x).map(async E=>{try{const A=new Promise((_,z)=>setTimeout(()=>z(new Error("Timeout")),3e3)),C=bn(E);await Promise.race([C,A])}catch{console.warn(`‚ö†Ô∏è Error/timeout cargando imagen: ${E}`)}});await Promise.all(P),a(3,4,"Renderizando thumbnail...");const U=document.createElement("canvas"),v=U.getContext("2d",{alpha:!1,willReadFrequently:!1});if(U.width=w,U.height=S,v.fillStyle=t.backgroundColor||"#ffffff",v.fillRect(0,0,U.width,U.height),t.backgroundImage){const E=Ie.get(t.backgroundImage);E&&v.drawImage(E,0,0,U.width,U.height)}if(t.cells&&t.cells.length>0){const E=Math.ceil(Math.sqrt(Math.min(t.cells.length,9))),A=U.width/E,C=U.height/Math.ceil(Math.min(t.cells.length,9)/E);t.cells.slice(0,9).forEach((_,z)=>{const T=z%E,O=Math.floor(z/E),J=T*A,V=O*C;_.elements&&_.elements.filter(se=>se.type==="image"||se.type==="text").slice(0,3).forEach(se=>{vn(v,se,{x:J,y:V,width:A,height:C})})})}a(4,4,"Guardando thumbnail...");const N=U.toDataURL("image/jpeg",.7);return ze.set(y,N),console.log(`‚úÖ Thumbnail generado para p√°gina: ${t.id}`),N}catch(g){return console.error(`‚ùå Error generando thumbnail para p√°gina ${t.id}:`,g),a(4,4,"Error en generaci√≥n"),null}}async function tn({pages:t,workspaceDimensions:s,onProgress:i=null}){const u={};console.log(`‚ö° Generando ${t.length} thumbnails r√°pidos...`);const g=(v,N,E="")=>{const A=Math.round(v/N*100);console.log(`üìä Progreso: ${v}/${N} (${A}%) ${E}`),i&&i({current:v,total:N,percentage:A,message:E})},w=new Set;t.forEach(v=>{v.backgroundImage&&w.add(v.backgroundImage),v.cells&&v.cells.forEach(N=>{N.elements&&N.elements.forEach(E=>{E.type==="image"&&E.content&&w.add(E.content)})})});const S=Array.from(w),y=5;g(0,S.length,"Cargando im√°genes...");for(let v=0;v<S.length;v+=y){const N=S.slice(v,v+y);await Promise.all(N.map(bn)),g(Math.min(v+y,S.length),S.length,"Cargando im√°genes...")}console.log(`üì∏ Im√°genes cargadas: ${Ie.size}`);const x=300/Math.max(s.width,s.height),P=Math.round(s.width*x),U=Math.round(s.height*x);g(0,t.length,"Generando thumbnails...");for(let v=0;v<t.length;v++){const N=t[v];try{const E=`${N.id}-${P}x${U}`;if(ze.has(E)){u[N.id]=ze.get(E),g(v+1,t.length,`Thumbnail ${N.id} (cached)`);continue}const A=document.createElement("canvas"),C=A.getContext("2d",{alpha:!1,willReadFrequently:!1});if(A.width=P,A.height=U,C.fillStyle=N.backgroundColor||"#ffffff",C.fillRect(0,0,A.width,A.height),N.backgroundImage){const z=Ie.get(N.backgroundImage);z&&C.drawImage(z,0,0,A.width,A.height)}if(N.cells&&N.cells.length>0){const z=Math.ceil(Math.sqrt(N.cells.length)),T=A.width/z,O=A.height/Math.ceil(N.cells.length/z);N.cells.forEach((J,V)=>{if(V>=9)return;const re=V%z,se=Math.floor(V/z),fe=re*T,c=se*O;J.elements&&J.elements.filter(h=>h.type==="image"||h.type==="text").slice(0,3).forEach(h=>{vn(C,h,{x:fe,y:c,width:T,height:O})})})}const _=A.toDataURL("image/jpeg",.7);u[N.id]=_,ze.set(E,_),g(v+1,t.length,`Thumbnail ${N.id} generado`)}catch(E){console.error(`‚ùå Error generando thumbnail r√°pido para ${N.id}:`,E),u[N.id]=null,g(v+1,t.length,`Error en ${N.id}`)}}return console.log(`‚ö° ¬°${Object.keys(u).length} thumbnails generados en modo r√°pido!`),u}function Gr(){Ie.clear(),ze.clear(),console.log("üßπ Caches de thumbnails limpiados")}const Wr=async(t,s,i)=>{var u;try{console.log("üì§ [SAVE] Subiendo imagen al backend:",s);const[a,g]=t.split(","),w=((u=a.match(/data:image\/(\w+)/))==null?void 0:u[1])||"png",S=new FormData,y=atob(g),x=new Array(y.length);for(let E=0;E<y.length;E++)x[E]=y.charCodeAt(E);const P=new Uint8Array(x),U=new Blob([P],{type:`image/${w}`});S.append("image",U,`element_${s}.${w}`),S.append("project_id",i),S.append("element_id",s);const v=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:S});if(!v.ok)throw new Error("Error al subir imagen al servidor");const N=await v.json();return console.log("‚úÖ [SAVE] Imagen subida exitosamente:",N.url),N.url}catch(a){throw console.error("‚ùå [SAVE] Error subiendo imagen:",a),a}},qr=async(t,s)=>{var g,w;console.log("üîÑ [SAVE] Procesando im√°genes para guardado...");const i=[];let u=0,a=0;for(const S of t)for(const y of S.cells||[])for(const x of y.elements||[])x.type==="image"&&((g=x.content)!=null&&g.startsWith("data:image/"))&&u++;console.log(`üìä [SAVE] Total de im√°genes base64 a procesar: ${u}`);for(const S of t){const y={...S};y.cells=[];for(const x of S.cells||[]){const P={...x};P.elements=[];for(const U of x.elements||[]){const v={...U};if(U.type==="image"&&((w=U.content)!=null&&w.startsWith("data:image/")))try{const N=await Wr(U.content,U.id,s);v.content=N,v.isUploaded=!0,a++,console.log(`‚úÖ [SAVE] Imagen ${a}/${u} procesada`)}catch(N){console.error("‚ùå [SAVE] Error procesando imagen:",U.id,N),v.uploadError=N.message}P.elements.push(v)}y.cells.push(P)}i.push(y)}return console.log(`‚úÖ [SAVE] Procesamiento completado: ${a}/${u} im√°genes subidas`),i},Qr=async(t,s)=>{var i;try{console.log("üîç [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:t,thumbnailsCount:Object.keys(s).length});const u=[];for(const[w,S]of Object.entries(s))console.log(`üîç [DEBUG] Procesando thumbnail para p√°gina ${w}:`,{hasData:!!S,isBase64:S&&S.startsWith("data:image/"),dataLength:S?S.length:0}),S&&S.startsWith("data:image/")&&u.push({page_id:w,thumbnail_data:S});if(u.length===0){console.log("‚ÑπÔ∏è [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`üñºÔ∏è [THUMBNAILS] Guardando ${u.length} thumbnails como archivos...`),console.log(`üîç [DEBUG] URL del endpoint: /api/thumbnails/${t}/save-as-files`);const a=await fetch(`/api/thumbnails/${t}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.content)||""},credentials:"include",body:JSON.stringify({thumbnails:u})});if(console.log("üîç [DEBUG] Respuesta del servidor:",{status:a.status,statusText:a.statusText,ok:a.ok}),!a.ok){const w=await a.text();throw console.error("‚ùå [THUMBNAILS] Error respuesta del servidor:",w),new Error(`Error al guardar thumbnails: ${a.status} ${a.statusText}`)}const g=await a.json();return console.log("‚úÖ [THUMBNAILS] Thumbnails guardados como archivos:",g),g}catch(u){throw console.error("‚ùå [THUMBNAILS] Error guardando thumbnails:",u),u}},on=async(t,s,i,u,a,g,w=!1)=>{try{if(!(s!=null&&s.id))throw new Error("No se encontr√≥ el ID del proyecto");console.log(`üíæ [SAVE] Iniciando ${w?"auto-guardado":"guardado manual"}...`);let S=t;w||(S=await qr(t,s.id));const y={pages:S,projectInfo:{id:s.id,item_id:i==null?void 0:i.id,title:i==null?void 0:i.title,preset_id:u==null?void 0:u.id},workspace:{width:a.width,height:a.height,scale:a.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:w,totalPages:t.length}},x=w?"save-progress":"save",P=await fetch(`/api/canvas/projects/${s.id}/${x}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:y,thumbnails:g})});if(!P.ok){const v=await P.json().catch(()=>({}));throw new Error(v.message||"Error al guardar el proyecto")}const U=await P.json();if(console.log(`‚úÖ [SAVE] ${w?"Auto-guardado":"Guardado"} exitoso:`,U),!w&&g&&Object.keys(g).length>0){console.log("üñºÔ∏è [SAVE] Guardando thumbnails como archivos...");try{await Qr(s.id,g),console.log("‚úÖ [SAVE] Thumbnails guardados como archivos")}catch(v){console.warn("‚ö†Ô∏è [SAVE] Error guardando thumbnails como archivos:",v)}}return{success:!0,data:U}}catch(S){return console.error(`‚ùå [SAVE] Error en ${w?"auto-guardado":"guardado"}:`,S),{success:!1,error:S.message}}},Jr=(t,s,i,u,a,g)=>{const[w,S]=m.useState("saved"),[y,x]=m.useState(null),[P,U]=m.useState(null),[v,N]=m.useState(null),[E,A]=m.useState(!1),[C,_]=m.useState(navigator.onLine),z=m.useRef(null),T=m.useRef(null),O=m.useRef(null),J=m.useRef(!1),V=m.useRef(null),re=15e3,se=2e3,fe=5e3,c=m.useCallback((B,Z)=>{try{const W={pages:B.map(ue=>{var Q;return{id:ue.id,layout:ue.layout,cells:((Q=ue.cells)==null?void 0:Q.map(pe=>{var mt;return{id:pe.id,elements:((mt=pe.elements)==null?void 0:mt.map(xe=>{var je;return{id:xe.id,type:xe.type,content:xe.type==="image"&&((je=xe.content)!=null&&je.startsWith("data:image/"))?`[IMAGE_${xe.content.length}]`:xe.content,position:xe.position,size:xe.size,style:xe.style,filters:xe.filters,rotation:xe.rotation}}))||[]}}))||[]}})||[],workspace:{width:Z==null?void 0:Z.width,height:Z==null?void 0:Z.height}};return btoa(JSON.stringify(W)).substring(0,32)}catch(W){return console.warn("‚ö†Ô∏è [AUTO-SAVE] Error generando hash:",W),Date.now().toString()}},[]),oe=m.useCallback(()=>`album_editor_autosave_${(s==null?void 0:s.id)||"draft"}`,[s==null?void 0:s.id]),h=m.useCallback(B=>{try{const Z=oe(),W={...B,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(Z,JSON.stringify(W)),console.log("üíæ [AUTO-SAVE] Guardado en localStorage"),!0}catch(Z){return console.error("‚ùå [AUTO-SAVE] Error guardando en localStorage:",Z),!1}},[oe]),ae=m.useCallback(()=>{var B;try{const Z=oe(),W=localStorage.getItem(Z);if(W){const ue=JSON.parse(W);return console.log("üìÇ [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(B=ue.pages)==null?void 0:B.length,savedAt:new Date(ue.savedAt).toLocaleString()}),ue}}catch(Z){console.error("‚ùå [AUTO-SAVE] Error cargando desde localStorage:",Z)}return null},[oe]),ie=m.useCallback(async(B=!1)=>{if(J.current&&!B){console.log("‚è≥ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(s!=null&&s.id)||!t||t.length===0){console.log("‚ö†Ô∏è [AUTO-SAVE] Datos insuficientes para guardar");return}const Z=c(t,a);if(!B&&Z===O.current){console.log("üìä [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{J.current=!0,S("saving"),N(null);const W={pages:t,projectInfo:{id:s.id,item_id:i==null?void 0:i.id,title:i==null?void 0:i.title,preset_id:u==null?void 0:u.id},workspace:a,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:Z}};if(h(W),C){const ue=await on(t,s,i,u,a,g,!0);if(ue.success)O.current=Z,U(new Date),S("saved"),A(!1),console.log("‚úÖ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(ue.error)}else console.log("ÔøΩ [AUTO-SAVE] Sin conexi√≥n, solo guardado en localStorage"),S("pending"),A(!0)}catch(W){console.error("‚ùå [AUTO-SAVE] Error:",W),N(W.message),S("error"),C&&(V.current=setTimeout(()=>{console.log("üîÑ [AUTO-SAVE] Reintentando guardado..."),ie(!0)},fe))}finally{J.current=!1}},[t,s,i,u,a,g,c,h,C]),Be=m.useCallback(async()=>{try{S("saving");const B=await on(t,s,i,u,a,g,!1);if(B.success){const Z=c(t,a);O.current=Z,x(new Date),S("saved"),A(!1),ee.success("üíæ Proyecto guardado exitosamente"),console.log("‚úÖ [MANUAL-SAVE] Guardado manual exitoso")}else N(B.error),S("error"),ee.error(`‚ùå Error al guardar: ${B.error}`);return B.success}catch(B){return console.error("‚ùå [MANUAL-SAVE] Error:",B),N(B.message),S("error"),ee.error(`‚ùå Error inesperado: ${B.message}`),!1}},[t,s,i,u,a,g,c]);return m.useEffect(()=>{if(!(s!=null&&s.id)||!t||t.length===0)return;const B=c(t,a);return O.current&&B!==O.current?(console.log("üîÑ [AUTO-SAVE] Cambios detectados, programando guardado..."),A(!0),S("pending"),T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{ie()},se)):O.current||(O.current=B),()=>{T.current&&clearTimeout(T.current)}},[t,a,s==null?void 0:s.id,c,ie]),m.useEffect(()=>{if(s!=null&&s.id)return z.current&&clearInterval(z.current),z.current=setInterval(()=>{E&&(console.log("‚è∞ [AUTO-SAVE] Auto-save peri√≥dico activado"),ie())},re),()=>{z.current&&clearInterval(z.current)}},[s==null?void 0:s.id,E,ie]),m.useEffect(()=>{const B=()=>{console.log("üåê [AUTO-SAVE] Conexi√≥n restaurada"),_(!0),E&&setTimeout(()=>ie(!0),1e3)},Z=()=>{console.log("üì¥ [AUTO-SAVE] Conexi√≥n perdida"),_(!1)};return window.addEventListener("online",B),window.addEventListener("offline",Z),()=>{window.removeEventListener("online",B),window.removeEventListener("offline",Z)}},[E,ie]),m.useEffect(()=>{const B=Z=>{if(E){const W={pages:t,projectInfo:{id:s.id},workspace:a,meta:{savedAt:new Date().toISOString()}};return h(W),Z.preventDefault(),Z.returnValue="¬øEst√°s seguro de salir? Hay cambios sin guardar.","¬øEst√°s seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",B),()=>window.removeEventListener("beforeunload",B)},[E,t,s==null?void 0:s.id,a,h]),m.useEffect(()=>()=>{T.current&&clearTimeout(T.current),z.current&&clearInterval(z.current),V.current&&clearTimeout(V.current)},[]),m.useEffect(()=>{v&&(v.includes("max_allowed_packet")||v.includes("data_too_large")?ee.error("‚ùå El proyecto es demasiado grande para guardar autom√°ticamente. Reduce el n√∫mero o tama√±o de im√°genes."):ee.error(`‚ùå Error de auto-guardado: ${v}`))},[v]),{saveStatus:w,lastSaved:y,lastAutoSaved:P,saveError:v,hasUnsavedChanges:E,isOnline:C,saveManually:Be,performAutoSave:()=>ie(!0),loadFromLocalStorage:ae,getStorageKey:oe,autoSaveInterval:re,debounceDelay:se}},Kr=({saveStatus:t,lastSaved:s,lastAutoSaved:i,hasUnsavedChanges:u,isOnline:a,saveError:g,onManualSave:w,className:S=""})=>{const y=U=>{if(!U)return null;const N=new Date-U,E=Math.floor(N/(1e3*60)),A=Math.floor(N/1e3);if(A<30)return"hace unos segundos";if(E<1)return`hace ${A}s`;if(E<60)return`hace ${E}m`;const C=Math.floor(E/60);return C<24?`hace ${C}h`:U.toLocaleDateString()},P=(()=>{if(!a)return{icon:e.jsx(Ko,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexi√≥n",detail:"Guardado local activo"};switch(t){case"saving":return{icon:e.jsx(rr,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(nr,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:i?`Auto-guardado ${y(i)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(or,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:g||"Error desconocido"};case"pending":return{icon:e.jsx(tr,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:u?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(sn,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${S}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${P.bg} ${P.color}
                    hover:shadow-md
                `,onClick:()=>t!=="saving"&&(w==null?void 0:w()),children:[P.icon,e.jsx("span",{className:"text-sm font-medium",children:P.text}),u&&t!=="saving"&&e.jsx("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-pulse"}),e.jsx("div",{className:"flex items-center",children:a?e.jsx(xr,{className:"w-3 h-3 text-green-500"}):e.jsx(Ko,{className:"w-3 h-3 text-orange-500"})})]}),e.jsxs("div",{className:`
                absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2
                bg-gray-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg
                opacity-0 group-hover:opacity-100 pointer-events-none
                transition-opacity duration-200 z-50 whitespace-nowrap
            `,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:P.text}),e.jsx("div",{className:"text-gray-300",children:P.detail}),s&&e.jsxs("div",{className:"text-gray-400 text-xs",children:["√öltimo guardado manual: ",y(s)]}),e.jsxs("div",{className:"text-gray-400 text-xs",children:[a?"üåê En l√≠nea":"üì¥ Sin conexi√≥n",t!=="saving"&&" ‚Ä¢ Click para guardar"]})]}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"})]}),t==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},Yr=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const t=document.createElement("style");t.textContent=Yr,document.head.appendChild(t)}function it(t,s){let i;return function(...a){const g=()=>{clearTimeout(i),t(...a)};clearTimeout(i),i=setTimeout(g,s)}}const It=Pt.memo(({pageId:t,thumbnail:s,altText:i,type:u})=>{const[a,g]=m.useState(!1),[w,S]=m.useState(!1);if(s&&!w)return e.jsxs("div",{className:"relative w-full h-full",children:[!a&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:s,alt:i,className:`w-full h-full object-contain transition-opacity duration-200 ${a?"opacity-100":"opacity-0"}`,onLoad:()=>g(!0),onError:()=>S(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const y=u==="cover"||u==="final"?lt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((x,P)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},P))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(y,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(t,s)=>t.pageId===s.pageId&&t.thumbnail===s.thumbnail&&t.altText===s.altText&&t.type===s.type),Xr=Pt.memo(({images:t,onImageSelect:s,isLoading:i})=>{const u=Pt.memo(({image:a})=>{const[g,w]=m.useState(!1),[S,y]=m.useState(!1),[x,P]=m.useState(!1),[{isDragging:U},v]=lr(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:a.url},collect:_=>({isDragging:!!_.isDragging()}),end:()=>{setTimeout(()=>P(!1),100)}})),N=a.thumbnail_url||a.url,E=a.url,A=_=>{P(!0),setTimeout(()=>P(!1),500)},C=_=>{if(x||U)return _.preventDefault(),_.stopPropagation(),!1;s(E)};return e.jsxs("div",{ref:v,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${U?"opacity-50 scale-95":""}`,onMouseDown:A,onClick:C,children:[e.jsxs("div",{className:"aspect-square relative",children:[!g&&!S&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),S?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Re,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:N,alt:a.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${g?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>w(!0),onError:()=>y(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(ct,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:a.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),a.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return i?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((a,g)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},g))}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Re,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay im√°genes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:t.map((a,g)=>e.jsx(u,{image:a},`${a.id||a.url}-${g}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[t.filter(a=>a.has_thumbnail).length," de ",t.length," im√°genes optimizadas"]})})]})});function es(){var to,oo,no,ro,ao,so,io,lo,co,uo,go,mo,ho,po,fo,xo,bo,vo,yo,wo,Eo,jo,No,So,Co,ko,Ao,To,Io,Po,Mo,_o,$o,Lo,Oo,Ro,Uo,zo,Bo,Ho;const[t,s]=m.useState(null),[i,u]=m.useState(null),[a,g]=m.useState(null),[w,S]=m.useState(null),[y,x]=m.useState(!0),[P,U]=m.useState(null),[v,N]=m.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[E,A]=m.useState(new Map),[C,_]=m.useState([]),[z,T]=m.useState(!1),O=m.useRef(C),J=m.useRef(E);m.useRef(null);const V=m.useRef(null),re=m.useRef(null);m.useEffect(()=>{O.current=C},[C]),m.useEffect(()=>{J.current=E},[E]),m.useEffect(()=>{(async()=>{var n;try{const l=new URLSearchParams(window.location.search).get("project");if(!l){U("No se encontr√≥ el ID del proyecto en la URL"),x(!1);return}const d=await fetch(`/api/canvas/projects/${l}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!d.ok)throw new Error("Error al cargar el proyecto");const p=await d.json();s(p.project),u(p.item),g(p.canvasPreset),S(p.initialProject),x(!1)}catch(r){console.error("‚ùå Error cargando proyecto:",r),U(r.message),x(!1)}})()},[]);const[se,fe]=m.useState(qo.Local.get(`${Qo.APP_CORRELATIVE}_cart`)??[]);m.useEffect(()=>{qo.Local.set(`${Qo.APP_CORRELATIVE}_cart`,se)},[se]);const[c,oe]=m.useState([]),[h,ae]=m.useState(0),[ie,Be]=m.useState("preset"),[B,Z]=m.useState(null),[W,ue]=m.useState(null),[Q,pe]=m.useState("pages"),[mt,xe]=m.useState("basic"),[je,Fe]=m.useState([JSON.stringify(c)]),[be,_e]=m.useState(0),[yn,Zr]=m.useState(!1),[Dr,_t]=m.useState(null),[ne,ce]=m.useState({}),[ea,ta]=m.useState(!1),[Se,$e]=m.useState([]),[ht,$t]=m.useState(!1),[Xe,wn]=m.useState(new Map),[Ve,En]=m.useState(()=>new Map),[Ge,Ze]=m.useState(null),[Lt,Ot]=m.useState(!1);m.useEffect(()=>{console.log("‚úÖ [FILTERS] Tab actual:",Q)},[Q]),m.useCallback((o,n="manual")=>{if(console.log(`üîÑ [ACTIVE_TAB] Cambiando de "${Q}" a "${o}" - Raz√≥n: ${n}`),o==="filters"&&n!=="manual"){console.warn("üö® [ACTIVE_TAB] Cambio autom√°tico a filters bloqueado!");return}pe(o)},[Q]),console.log("üéâ [FILTERS FIX] Editor cargado - Fix del problema de filtros ACTIVADO");const[De,We]=m.useState(!1),Rt=m.useRef(),[q,Ut]=m.useState({width:800,height:600}),zt=m.useMemo(()=>Fr({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¬°Bienvenido al Editor de BananaLab! üçå",description:"Este es tu lienzo de trabajo donde crear√°s dise√±os incre√≠bles. Aqu√≠ puedes ver y editar la p√°gina actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"üéØ Navegaci√≥n Principal",description:"En la barra lateral izquierda encontrar√°s todas las herramientas organizadas por categor√≠as. Cada √≠cono te lleva a una secci√≥n espec√≠fica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"üìÑ Secci√≥n P√°ginas",description:"Gestiona todas las p√°ginas de tu proyecto: portada, p√°ginas de contenido y contraportada. Haz clic en cualquier p√°gina para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"üé® Secci√≥n Dise√±os",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu p√°gina. Cada dise√±o tiene una distribuci√≥n √∫nica.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"üìö Secci√≥n Capas",description:"Organiza y controla la superposici√≥n de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posici√≥n.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"‚úçÔ∏è Secci√≥n Textos",description:"Agrega y personaliza textos: t√≠tulos, subt√≠tulos y p√°rrafos. Cambia fuentes, colores, tama√±os y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"üé≠ Secci√≥n Filtros",description:"Aplica efectos visuales a tus im√°genes: brillo, contraste, saturaci√≥n, m√°scaras y m√°s filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"‚ö° Acciones R√°pidas",description:"Herramientas de acceso r√°pido: cambiar dise√±o de p√°gina, gestionar capas, agregar im√°genes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"üíæ Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso autom√°ticamente y acceder a la vista previa de tu √°lbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"üëÅÔ∏è Vista de √Ålbum",description:"Visualiza tu proyecto completo como un √°lbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"üéâ ¬°Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una p√°gina y agregando elementos. ¬°Divi√©rtete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente ‚Üí",prevBtnText:"‚Üê Anterior",doneBtnText:"¬°Empezar a crear! üöÄ",closeBtnText:"‚úï",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(o,n)=>{var l,d;console.log("üéØ Mostrando paso:",(l=n.popover)==null?void 0:l.title);const r=(d=o==null?void 0:o.getAttribute)==null?void 0:d.call(o,"data-tab");r&&Q!==r&&pe(r)},onDeselected:()=>{console.log("‚úÖ Gu√≠a completada"),ee.success("¬°Gu√≠a completada! Ya puedes empezar a crear tu dise√±o.",{duration:3e3})}}),[Q,pe]),jn=m.useCallback(()=>{console.log("üöÄ Iniciando tour guiado"),zt.drive()},[zt]),pt=m.useCallback(async()=>{if(t!=null&&t.id)try{const o=await fetch(`/api/thumbnails/${t.id}`);if(o.ok){const n=await o.json();if(n.success&&n.thumbnails&&n.thumbnails.length>0){const r={};n.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(r[l.page_id]=l.thumbnail_url)}),Object.keys(r).length>0?(ce(l=>({...l,...r})),console.log("‚úÖ Thumbnails cargados desde storage:",Object.keys(r).length)):console.log("‚ÑπÔ∏è No hay thumbnails guardados, usando generaci√≥n local")}else console.log("‚ÑπÔ∏è No hay thumbnails guardados para este proyecto")}}catch(o){console.warn("‚ö†Ô∏è Error cargando thumbnails guardados (usando locales):",o)}},[t==null?void 0:t.id]),ye=m.useCallback(async()=>{if(!c[h]||!q)return;const o=c[h];if(ne[o.id]){console.log(`‚úÖ Thumbnail ya existe para p√°gina: ${o.id}`);return}if(Ce.current){console.log("‚è≥ Ya se est√° generando un thumbnail...");return}Ce.current=!0;try{console.log(`üì∏ Generando thumbnail para p√°gina actual: ${o.id}`);const n=await Vr({page:o,workspaceDimensions:q,onProgress:r=>{Ze(r)}});n&&(ce(r=>({...r,[o.id]:n})),console.log(`‚úÖ Thumbnail generado para p√°gina: ${o.id}`))}catch(n){console.warn("‚ö†Ô∏è Error generando thumbnail de p√°gina actual:",n)}finally{Ce.current=!1,Ze(null)}},[c,h,q,ne]),ft=m.useCallback(it(async()=>{if(!(!(c!=null&&c.length)||!q)){if(Ce.current){console.log("‚è≥ Thumbnails ya se est√°n generando, saltando...");return}Ce.current=!0;try{const o=c.filter(r=>!ne[r.id]);if(o.length===0){console.log("‚úÖ Todos los thumbnails ya existen");return}console.log(`üì∏ Generando ${o.length} thumbnails r√°pidos...`);const n=await tn({pages:o,workspaceDimensions:q,onProgress:r=>{Ze(r)}});n&&Object.keys(n).length>0&&(ce(r=>({...r,...n})),console.log("‚úÖ Thumbnails r√°pidos generados:",Object.keys(n).length))}catch(o){console.warn("‚ö†Ô∏è Error generando thumbnails r√°pidos:",o)}finally{Ce.current=!1,Ze(null)}}},300),[c,q,ne]),Ce=m.useRef(!1);m.useCallback(async(o=[])=>{if(!Ce.current)try{if(Ce.current=!0,o.length>0){const n=c.filter(r=>o.includes(r.id));if(n.length>0){console.log(`üéØ Generando ${n.length} thumbnails prioritarios...`);const r=await tn({pages:n,workspaceDimensions:q});r&&Object.keys(r).length>0&&ce(l=>({...l,...r}))}}}catch(n){console.warn("‚ö†Ô∏è Error en generaci√≥n prioritaria:",n)}finally{Ce.current=!1}},[c,q,ft]);const Bt=m.useCallback(o=>{if(Ve.has&&Ve.has(o))return;const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{if(n.width>1200||n.height>1200){const l=document.createElement("canvas"),d=l.getContext("2d"),p=1200,b=Math.min(p/n.width,p/n.height),f=n.width*b,j=n.height*b;l.width=f,l.height=j,d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.drawImage(n,0,0,f,j),l.toBlob(k=>{if(k){const M=URL.createObjectURL(k);En($=>{const G=new Map($);if(G.set(o,M),G.size>15){const I=G.keys().next().value,L=G.get(I);URL.revokeObjectURL(L),G.delete(I)}return G})}},"image/webp",.85)}},n.onerror=()=>{console.warn("‚ùå Error pre-cargando imagen:",o)},n.src=o},[]);m.useEffect(()=>{Se.length>0&&Se.slice(0,10).forEach((n,r)=>{setTimeout(()=>{Bt(n.url)},r*100)})},[Se,Bt]),m.useEffect(()=>()=>{Ve&&Ve.forEach&&Ve.forEach(o=>URL.revokeObjectURL(o))},[]),m.useEffect(()=>()=>{Gr()},[]);const Ht=m.useCallback(async()=>{var o;if(!(!(t!=null&&t.id)||!(c!=null&&c.length))){if(Lt){console.log("‚è≥ Ya hay una carga de thumbnails en progreso, omitiendo...");return}try{Ot(!0),console.log("üîÑ Iniciando carga de thumbnails existentes...");const n=await fetch(`/api/thumbnails/${t.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:c})});if(n.ok){const r=await n.json();r&&Object.keys(r).length>0?(ce(l=>({...l,...r})),console.log("‚úÖ Thumbnails existentes cargados:",Object.keys(r).length)):(console.log("üì∏ No hay thumbnails existentes, generando para p√°gina actual..."),setTimeout(()=>ye(),200))}}catch(n){console.warn("‚ö†Ô∏è Error cargando thumbnails existentes:",n),setTimeout(()=>ye(),200)}finally{Ot(!1)}}},[t==null?void 0:t.id,c,ye,Lt]);m.useCallback(async()=>{if(!(!(t!=null&&t.id)||!(c!=null&&c.length)))try{const o=c[h];if(!o)return;const n=await fetch(`/api/thumbnails/${t.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[o],width:q.width,height:q.height,quality:95,scale:4,dpi:300})});if(n.ok){const r=await n.json();if(r.success&&r.thumbnails){const l={};r.thumbnails.forEach(d=>{d.page_id&&d.thumbnail_url&&(l[d.page_id]=d.thumbnail_url)}),ce(d=>({...d,...l})),console.log("‚úÖ Thumbnail generado y guardado en storage para p√°gina actual:",r.thumbnails.length)}}}catch(o){console.warn("‚ö†Ô∏è Error generando thumbnail:",o)}},[t==null?void 0:t.id,c,h,q]),m.useCallback(async()=>{if(!(!(t!=null&&t.id)||!(c!=null&&c.length)))try{const o=await fetch(`/api/thumbnails/${t.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:c,width:q.width,height:q.height,quality:95,scale:4,dpi:300})});if(o.ok){const n=await o.json();if(n.success&&n.thumbnails){const r={};n.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(r[l.page_id]=l.thumbnail_url)}),ce(l=>({...l,...r})),console.log("‚úÖ Todos los thumbnails generados y guardados en storage:",n.thumbnails.length)}}}catch(o){console.warn("‚ö†Ô∏è Error generando todos los thumbnails:",o)}},[t==null?void 0:t.id,c,q]);const Nn=m.useCallback(async(o=null)=>{if(!(t!=null&&t.id)||!(c!=null&&c.length))return{};try{console.log("üìñ [ALBUM-MODAL] Cargando thumbnails PDF existentes...");const n={},r={};let l=0;const d=async(b,f)=>new Promise(j=>{const k=new Image;k.onload=()=>{r[f]=b,l++,o==null||o(l,c.length),j(!0)},k.onerror=()=>{console.warn(`‚ö†Ô∏è [ALBUM-MODAL] Thumbnail no encontrado: ${b}`),l++,o==null||o(l,c.length),j(!1)},k.src=b}),p=c.map(async(b,f)=>{const j=`/storage/images/thumbnails/${t.id}/page-${f}-pdf.png`,k=b.id||`page-${f}`;return n[k]=j,d(j,k)});return await Promise.all(p),console.log(`‚úÖ [ALBUM-MODAL] Thumbnails verificados: ${Object.keys(r).length}/${c.length}`),n}catch(n){return console.warn("‚ö†Ô∏è [ALBUM-MODAL] Error cargando thumbnails PDF:",n),{}}},[t==null?void 0:t.id,c]);m.useEffect(()=>{if(w&&i&&a){if(w.pages&&Array.isArray(w.pages)){const o=w.pages.map(n=>{let r=null,l=a.background_color||"#ffffff";return n.type==="cover"&&i.has_cover_image!==!1?i.cover_image&&(r=`/storage/images/item/${i.cover_image}`):n.type==="content"?i.content_image&&(r=`/storage/images/item/${i.content_image}`):(n.type==="final"||n.type==="contraportada")&&i.has_back_cover_image!==!1&&i.back_cover_image&&(r=`/storage/images/item/${i.back_cover_image}`),{...n,backgroundImage:r,backgroundColor:l}}).filter(n=>!(n.type==="cover"&&i.has_cover_image===!1||(n.type==="final"||n.type==="contraportada")&&i.has_back_cover_image===!1));oe(n=>n.length>0?(console.log("‚ö†Ô∏è P√°ginas ya existentes, preservando cambios del usuario"),n.map((r,l)=>{const d=o[l];return d?{...r,backgroundImage:r.backgroundImage||d.backgroundImage,backgroundColor:r.backgroundColor||d.backgroundColor}:r})):(console.log("üìÑ Carga inicial de p√°ginas desde la base de datos"),o)),Fe(n=>n.length<=1?[JSON.stringify(o)]:n),_e(n=>n===0&&je.length<=1?0:n),setTimeout(()=>{pt()},100)}else{const o=Yt(a,i);oe(o),Fe([JSON.stringify(o)]),_e(0),setTimeout(()=>{pt()},100)}typeof w.currentPage=="number"&&ae(w.currentPage),w.workspaceSize&&Be(w.workspaceSize)}},[w,i,a,pt]);const ke=Jr(c,t,i,a,q,ne),Ft=()=>{if(a!=null&&a.width&&(a!=null&&a.height)){let f=a.width,j=a.height,k=f*37.8,M=j*37.8;if(k&&M){const $=window.innerWidth*.6,G=window.innerHeight*.7,I=$/k,L=G/M,H=Math.min(I,L,1);return{width:Math.round(k*H),height:Math.round(M*H),originalWidth:f,originalHeight:j,scale:H,unit:"cm",originalWidthPx:Math.round(k),originalHeightPx:Math.round(M)}}}if(a!=null&&a.extra_settings)try{const f=typeof a.extra_settings=="string"?JSON.parse(a.extra_settings):a.extra_settings;if(f!=null&&f.canvas_config){const j=f.canvas_config;let k=j.width,M=j.height,$=k*37.8,G=M*37.8;if($&&G){const I=window.innerWidth*.6,L=window.innerHeight*.7,H=I/$,K=L/G,te=Math.min(H,K,1);return{width:Math.round($*te),height:Math.round(G*te),originalWidth:k,originalHeight:M,scale:te,unit:"cm",originalWidthPx:Math.round($),originalHeightPx:Math.round(G)}}}}catch(f){console.warn("Error parsing extra_settings:",f)}const o={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},n=o[ie]||o.preset,r=window.innerWidth*.6,l=window.innerHeight*.7,d=r/n.width,p=l/n.height,b=Math.min(d,p,1);return{width:Math.round(n.width*b),height:Math.round(n.height*b),originalWidth:n.width,originalHeight:n.height,scale:b,unit:"px"}},Ae=m.useCallback(async(o={type:"thumbnail"})=>{if(!c[h])return null;try{let n=document.querySelector(`#page-${c[h].id}`);if(!n)return console.warn("‚ùå THUMBNAIL: No se encontr√≥ el elemento de p√°gina espec√≠fico"),null;const r=c[h],l=o.type==="pdf",d=l?11.81:3,p=1,b=getComputedStyle(n);let f=(r==null?void 0:r.backgroundColor)||"#ffffff";b.backgroundColor&&b.backgroundColor!=="rgba(0, 0, 0, 0)"&&(f=b.backgroundColor);const j={scale:d,useCORS:!0,allowTaint:!1,backgroundColor:f,width:q.width,height:q.height,x:0,y:0,scrollX:0,scrollY:0,foreignObjectRendering:!!l,removeContainer:!1,logging:!1,imageTimeout:l?6e4:15e3,pixelRatio:l?3:window.devicePixelRatio||1,canvas:l?document.createElement("canvas"):null,windowWidth:l?q.width*d:null,windowHeight:l?q.height*d:null,onclone:async $=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(I=>{try{$.querySelectorAll(I).forEach(H=>H.remove())}catch(L){console.warn("Error removing selector:",I,L)}});try{const I=$.querySelector(`#page-${c[h].id}`);I&&(I.style.width=q.width+"px",I.style.height=q.height+"px",I.style.position="relative",I.style.overflow="hidden",r!=null&&r.backgroundImage&&(I.style.backgroundImage=`url(${r.backgroundImage})`,I.style.backgroundSize="cover",I.style.backgroundPosition="center",I.style.backgroundRepeat="no-repeat"),r!=null&&r.backgroundColor&&(I.style.backgroundColor=r.backgroundColor))}catch(I){console.error("‚ùå [THUMBNAIL-FIX] Error configurando elemento de p√°gina:",I)}try{const I=new Map;n.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((X,Te)=>{if(X.complete&&X.naturalWidth>0){const he=(X.closest('[data-element-type="image"]')||X.parentElement).getBoundingClientRect(),Ne=X.getBoundingClientRect();I.set(X.src,{src:X.src,naturalWidth:X.naturalWidth,naturalHeight:X.naturalHeight,containerWidth:he.width,containerHeight:he.height,objectFit:getComputedStyle(X).objectFit||"cover",objectPosition:getComputedStyle(X).objectPosition||"center",crossOrigin:X.crossOrigin})}});const H=async(X,Te,ge,he,Ne)=>new Promise(Le=>{try{const Oe=Te/ge,Nt=he/Ne;let tt,ot,St,Ct,Fo,Vo;Nt>Oe?(Vo=ge,Fo=ge*Nt,ot=Ne,tt=Ne*Oe,St=(he-tt)/2,Ct=0):(Fo=Te,Vo=Te/Nt,tt=he,ot=he/Oe,St=0,Ct=(Ne-ot)/2);const nt=$.createElement("canvas");nt.width=Te,nt.height=ge;const Fn=nt.getContext("2d"),Ke=new Image;Ke.crossOrigin="anonymous",Ke.onload=()=>{try{Fn.drawImage(Ke,St,Ct,tt,ot,0,0,Te,ge);const kt=nt.toDataURL("image/png",1);X.src=kt,X.style.objectFit="fill",X.style.objectPosition="center",X.style.width="100%",X.style.height="100%",Le()}catch(kt){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en canvas processing:",kt),Le()}},Ke.onerror=()=>{console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),Le()},Ke.src=X.src}catch(Oe){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",Oe),Le()}}),K=$.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),te=[];K.forEach((X,Te)=>{if(X.src&&I.has(X.src)){const ge=I.get(X.src),he=X.closest('[data-element-type="image"]')||X.parentElement;if(he&&(he.style.overflow="hidden",he.style.position="relative"),ge.objectFit==="cover"||X.classList.contains("object-cover")||X.classList.contains("workspace-image")){const Ne=H(X,ge.containerWidth,ge.containerHeight,ge.naturalWidth,ge.naturalHeight);te.push(Ne)}else X.style.width="100%",X.style.height="100%",X.style.objectFit="fill"}}),te.length>0&&await Promise.all(te);const Y=$.createElement("style");Y.textContent=`
                            /* CORRECCI√ìN THUMBNAIL: Estructura del elemento de p√°gina */
                            #page-${c[h].id} {
                                width: ${q.width}px !important;
                                height: ${q.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* üñ®Ô∏è IM√ÅGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya est√°n recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${l?`
                                /* üñ®Ô∏è IMPRESI√ìN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de p√°gina */
                            #page-${c[h].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* üñ®Ô∏è OPTIMIZACIONES GENERALES PARA PDF DE IMPRESI√ìN */
                            ${l?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,$.head.appendChild(Y)}catch(I){console.error("‚ùå [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",I);const L=$.createElement("style");L.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,$.head.appendChild(L)}}},k=await Wo(n,j);if(l&&k){const $=k.getContext("2d");if($){$.imageSmoothingEnabled=!1,$.imageSmoothingQuality="high";const G=$.getImageData(0,0,k.width,k.height),I=G.data;for(let L=0;L<I.length;L+=4)I[L]=Math.min(255,I[L]*1.05),I[L+1]=Math.min(255,I[L+1]*1.05),I[L+2]=Math.min(255,I[L+2]*1.05);$.putImageData(G,0,0)}}if(!k)throw new Error("html2canvas no devolvi√≥ un canvas v√°lido para el elemento de p√°gina");if(k.width===0||k.height===0)throw new Error("Canvas del elemento de p√°gina tiene dimensiones inv√°lidas");const M=k.toDataURL("image/png",p);if(!M||M==="data:,")throw new Error("No se pudo generar dataURL del elemento de p√°gina");return l?k:M}catch(n){console.error("‚ùå [THUMBNAIL-FIX] Error capturando elemento de p√°gina:",n);try{const r=document.createElement("canvas"),l=o.type==="pdf"?11.81:1;r.width=q.width*l,r.height=q.height*l;const d=r.getContext("2d"),p=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return d.fillStyle=p,d.fillRect(0,0,r.width,r.height),d.fillStyle=p==="#ffffff"||p.includes("white")?"#374151":"#666666",d.font=`${14*l}px Arial`,d.textAlign="center",d.fillText("P√°gina "+(h+1),r.width/2,r.height/2),o.type==="pdf"?r:r.toDataURL("image/png",1)}catch{return null}}},[h,c]);m.useCallback(async()=>{if(!c[h])return;const o=await Ae({type:"thumbnail"});o&&ce(n=>({...n,[c[h].id]:o}))},[Ae,h,c]),m.useCallback(()=>{clearTimeout(Rt.current),Rt.current=setTimeout(()=>{c[h]&&(ce(o=>{const n={...o};return delete n[c[h].id],n}),setTimeout(()=>{ye()},200))},1e3)},[c,h,ye]);const Sn=m.useCallback(()=>{c[h]&&(ce(o=>{const n={...o};return delete n[c[h].id],n}),setTimeout(()=>{ye()},300))},[c,h,ye]),Cn=m.useCallback(async(o=h,n={width:800,height:600})=>{var r,l;if(!c[o])return null;try{const d=h;o!==h&&(ae(o),await new Promise(j=>setTimeout(j,100)));const p=document.querySelector(`#page-${c[o].id}`);if(!p)return console.warn("Workspace element not found for page:",c[o].id),null;const b={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((r=c[o])==null?void 0:r.backgroundColor)||"#ffffff",width:p.offsetWidth,height:p.offsetHeight,removeContainer:!0,logging:!1,onclone:j=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(I=>{j.querySelectorAll(I).forEach(H=>H.remove())});const M=j.querySelector(`#page-${c[o].id}`);if(M){const I=c[o];I!=null&&I.backgroundImage&&(M.style.backgroundImage=`url(${I.backgroundImage})`,M.style.backgroundSize="cover",M.style.backgroundPosition="center",M.style.backgroundRepeat="no-repeat"),I!=null&&I.backgroundColor&&(M.style.backgroundColor=I.backgroundColor)}try{const I=p.querySelectorAll("img"),L=new Map;I.forEach((K,te)=>{const Y=getComputedStyle(K);L.set(te,{objectFit:Y.objectFit,objectPosition:Y.objectPosition,width:Y.width,height:Y.height,borderRadius:Y.borderRadius,transform:Y.transform})}),j.querySelectorAll("img").forEach((K,te)=>{const Y=L.get(te);Y&&(K.style.objectFit=Y.objectFit||"cover",K.style.objectPosition=Y.objectPosition||"center",K.style.width=Y.width,K.style.height=Y.height,K.style.borderRadius=Y.borderRadius,K.style.transform=Y.transform)})}catch(I){console.warn("Error preservando estilos de im√°genes:",I),j.querySelectorAll("img").forEach(H=>{H.style.objectFit="cover",H.style.objectPosition="center",H.style.width||(H.style.width="100%"),H.style.height||(H.style.height="100%")})}j.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(I=>{const L=I.className;L&&(I.className=L);const H=getComputedStyle?getComputedStyle(I):null;H&&(H.fontFamily&&H.fontFamily!=="Arial"&&(I.style.fontFamily=H.fontFamily),H.fontSize&&(I.style.fontSize=H.fontSize),H.fontWeight&&(I.style.fontWeight=H.fontWeight),H.fontStyle&&(I.style.fontStyle=H.fontStyle))});const G=j.createElement("style");G.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CR√çTICO: Asegurar que las im√°genes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CR√çTICO: Asegurar que los backgrounds de p√°gina se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,j.head.appendChild(G)}},f=await Wo(p,b);if(n.width!==f.width||n.height!==f.height){const j=document.createElement("canvas");j.width=n.width,j.height=n.height;const k=j.getContext("2d"),M=f.width/f.height,$=n.width/n.height;let G,I,L=0,H=0;M>$?(G=n.width,I=n.width/M,H=(n.height-I)/2):(I=n.height,G=n.height*M,L=(n.width-G)/2),k.fillStyle=((l=c[o])==null?void 0:l.backgroundColor)||"#ffffff",k.fillRect(0,0,n.width,n.height),k.drawImage(f,L,H,G,I);const K=j.toDataURL("image/png",1);return o!==d&&ae(d),K}return o!==d&&ae(d),f.toDataURL("image/png",1)}catch(d){return console.error("‚ùå Error generando thumbnail de alta calidad:",d),null}},[c,h,ae]);m.useEffect(()=>{const o=Ft();Ut(o)},[a,ie]),m.useEffect(()=>{const o=()=>{const n=Ft();Ut(n)};return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[a,ie]),m.useEffect(()=>{if(c[h]&&!ne[c[h].id]){const o=setTimeout(()=>{ye()},500);return()=>clearTimeout(o)}},[h,c,ne,ye]),m.useEffect(()=>{const o=c[h];o!=null&&o.backgroundImage&&fetch(o.backgroundImage,{method:"HEAD"}).then(n=>{n.ok?console.log("‚úÖ [WORKSPACE] Imagen existe en el servidor"):console.error("‚ùå [WORKSPACE] Imagen NO existe en el servidor. Status:",n.status)}).catch(n=>{console.error("‚ùå [WORKSPACE] Error verificando imagen:",n)})},[h,(to=c[h])==null?void 0:to.backgroundImage]),m.useEffect(()=>{const o=`${q.width}x${q.height}`,n=sessionStorage.getItem("lastWorkspaceDimensions");n&&n!==o&&c.length>0&&(ce({}),setTimeout(()=>{c[h]&&Sn()},800)),sessionStorage.setItem("lastWorkspaceDimensions",o)},[q.width,q.height]),m.useEffect(()=>{if(!(t!=null&&t.id)||c.length===0)return;let o,n=Date.now(),r=!1;const l=()=>{r=!0,n=Date.now()},d=async()=>{if(r)try{console.log("üîÑ [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(j=>({...j,saveStatus:"saving"}));const b=await fetch(`/api/projects/${t.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:c,force:!1})}),f=await b.json();if(b.ok&&f.success)r=!1,N(j=>({...j,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("‚úÖ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado fall√≥")}catch(b){console.error("‚ùå [AUTO-SAVE] Error en guardado silencioso:",b),N(f=>({...f,saveStatus:"error",saveError:b.message}))}},p=()=>{o=setInterval(()=>{const b=Date.now()-n;r&&b>6e4&&(console.log("‚è∞ [AUTO-SAVE] Condiciones cumplidas para guardado autom√°tico"),d())},3*60*1e3)};return JSON.stringify(c),c[h],l(),p(),()=>{o&&clearInterval(o)}},[c,h,t==null?void 0:t.id]),m.useEffect(()=>{var n;if(!c[h])return;const o=((n=c[h].cells)==null?void 0:n.flatMap(r=>r.elements))||[];JSON.stringify(o),N(r=>({...r,hasUnsavedChanges:!0}))},[(oo=c[h])==null?void 0:oo.cells,h]);const[oa,xt]=m.useState(!1),[na,kn]=m.useState({elementId:null,cellId:null}),[An,Vt]=m.useState(!1),[ra,Tn]=m.useState(!1),[aa,sa]=m.useState(null),[In,Pn]=m.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[Pe,we]=m.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de √°lbum...",subMessage:"Preparando tu vista previa personalizada"}),bt=m.useRef(null),Gt=o=>{var l,d,p,b;const n=W||((d=(l=c[h])==null?void 0:l.cells[0])==null?void 0:d.id);if(!n)return;const r={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:o,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((b=(p=c[h].cells.find(f=>f.id===n))==null?void 0:p.elements)==null?void 0:b.length)||0)+1};Je(n,r),ee.success("Imagen a√±adida correctamente")},vt=m.useCallback(it(async(o=!1)=>{if(!(t!=null&&t.id))return;const n=Xe.get(t.id);if(!o&&n&&n.length>0){console.log("üîÑ Usando im√°genes desde cache"),Se.length===0&&$e(n);return}if(V.current&&clearTimeout(V.current),ht&&!o){console.log("‚è≥ Carga de im√°genes ya en progreso");return}$t(!0);try{const r=new AbortController,l=setTimeout(()=>r.abort(),1e4),d=await fetch(`/api/canvas/projects/${t.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:r.signal});if(clearTimeout(l),!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const p=await d.json();if(p.success){const b=p.images||[],f=JSON.stringify(Se),j=JSON.stringify(b);f!==j&&($e(b),wn(k=>{const M=new Map(k);if(M.set(t.id,b),M.size>5){const $=M.keys().next().value;M.delete($)}return M}))}else console.error("Error cargando im√°genes:",p.message),ee.error("Error cargando galer√≠a de im√°genes")}catch(r){r.name==="AbortError"?console.warn("‚ö†Ô∏è Carga de im√°genes cancelada por timeout"):(console.error("Error cargando im√°genes del proyecto:",r),ee.error("Error de conexi√≥n al cargar im√°genes"))}finally{$t(!1)}},200),[t==null?void 0:t.id,Xe,Se,ht]),Mn=m.useCallback(async o=>{const n=o.target.files[0];if(!n||!(t!=null&&t.id))return;const r=ee.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),l=URL.createObjectURL(n),d={id:`temp-${Date.now()}`,filename:n.name,url:l,thumbnail_url:l,has_thumbnail:!1,size:n.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};$e(b=>[d,...b]),Gt(l);const p=new FormData;p.append("image",n),p.append("projectId",t.id);try{const f=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:p})).json();if(f.success){const j={id:f.id||Date.now(),filename:n.name,url:f.url,thumbnail_url:f.thumbnail_url||f.url,has_thumbnail:f.has_thumbnail||!1,size:n.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};$e(k=>[j,...k.filter(M=>M.id!==d.id)]),setTimeout(()=>{oe(k=>{const M=[...k];return M[h].cells.forEach(G=>{G.elements.forEach(I=>{I.type==="image"&&I.content===l&&(I.content=f.url)})}),M})},100),ee.dismiss(r),ee.success(f.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{vt(!0)},2e3)}else $e(j=>j.filter(k=>k.id!==d.id)),URL.revokeObjectURL(l),ee.dismiss(r),ee.error(f.message||"Error al subir la imagen")}catch(b){console.error("Error subiendo la imagen:",b),$e(f=>f.filter(j=>j.id!==d.id)),URL.revokeObjectURL(l),ee.dismiss(r),ee.error("Error de red al subir la imagen")}},[t==null?void 0:t.id,h,Gt,vt]);m.useEffect(()=>{if(t!=null&&t.id){const o=Xe.get(t.id);if(o&&o.length>0){$e(o);return}return V.current=setTimeout(()=>{vt(!1)},150),()=>{V.current&&clearTimeout(V.current)}}},[t==null?void 0:t.id,Xe]),m.useEffect(()=>()=>{V.current&&clearTimeout(V.current)},[]);const Wt=(o,n)=>{if(console.log("üñºÔ∏è [ADD-IMAGE] Agregando imagen sin selecci√≥n autom√°tica"),!c||c.length===0||!c[h]){console.error("‚ùå [ADD-IMAGE] No hay p√°ginas v√°lidas para agregar imagen");return}const r=JSON.parse(JSON.stringify(c));let l=!1;for(let d=0;d<r[h].cells.length;d++)if(r[h].cells[d].id===o){r[h].cells[d].elements.push(n),l=!0,console.log("‚úÖ [ADD-IMAGE] Imagen agregada a la celda:",o);break}if(!l){console.error("‚ùå [ADD-IMAGE] Celda no encontrada:",o);return}setTimeout(()=>{Qe(r),console.log("‚úÖ [ADD-IMAGE] Estado actualizado sin selecci√≥n autom√°tica")},0)},_n=m.useCallback(o=>{var b,f,j,k;console.log("üñºÔ∏è [ADD-FROM-GALLERY] Iniciando proceso de agregar imagen:",o);const n=De;We(!0);const r=Q==="images",l=W||((f=(b=c[h])==null?void 0:b.cells[0])==null?void 0:f.id);if(!l){console.error("‚ùå [ADD-FROM-GALLERY] No hay celda disponible"),ee.error("No hay celda disponible para agregar la imagen"),We(n);return}if(!o||typeof o!="string"){console.error("‚ùå [ADD-FROM-GALLERY] URL de imagen inv√°lida"),ee.error("URL de imagen no v√°lida"),We(n);return}const d=JSON.parse(JSON.stringify(c));console.log("üì∏ [ADD-FROM-GALLERY] Snapshot del estado actual capturado");const p={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:o,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((k=(j=d[h].cells.find(M=>M.id===l))==null?void 0:j.elements)==null?void 0:k.length)||0)+1};console.log("üìù [ADD-FROM-GALLERY] Elemento creado:",p),setTimeout(()=>{Wt(l,p),setTimeout(()=>{r&&(pe("images"),console.log("üîÑ [ADD-FROM-GALLERY] Tab restaurado a images")),setTimeout(()=>{We(n),ee.success("‚úÖ Imagen a√±adida desde la galer√≠a"),console.log("‚úÖ [ADD-FROM-GALLERY] Proceso completado exitosamente")},50)},50)},50)},[Q,W,c,h,De,Wt]),qt=m.useCallback(async(o,n)=>{var d,p;const r=[],l=[];for(const b of o){const f={...b};if(b.cells){f.cells=[];for(const j of b.cells){const k={...j};if(j.elements){k.elements=[];for(const M of j.elements)if(M.type==="image"&&((d=M.content)!=null&&d.startsWith("data:image/"))){const $=`${M.id}_${Date.now()}`,G=M.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(G){const I=G[1],L=G[2],K=`${$}.${I==="jpeg"?"jpg":I}`;l.push({filename:K,data:L,type:I,elementId:M.id}),k.elements.push({...M,content:M.content,_wasBase64:!0,_originalSize:M.content.length,_elementId:M.id})}else k.elements.push(M)}else k.elements.push(M)}f.cells.push(k)}}r.push(f)}if(l.length>0)try{const b=await fetch(`/api/canvas/projects/${n}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((p=document.querySelector('meta[name="csrf-token"]'))==null?void 0:p.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:l})});if(b.ok){const f=await b.json();if(f.uploadedImages){const j=new Map;f.uploadedImages.forEach(k=>{j.set(k.elementId,k.url)});for(const k of r)if(k.cells){for(const M of k.cells)if(M.elements)for(const $ of M.elements)$._wasBase64&&$._elementId&&j.has($._elementId)&&($.content=j.get($._elementId),delete $._elementId)}}}else{const f=await b.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("‚ùå [IMAGE-UPLOAD] Error subiendo im√°genes:",f),o}}catch(b){return console.error("‚ùå [IMAGE-UPLOAD] Error de red subiendo im√°genes:",b),o}return r},[]),qe=m.useCallback(async(o=c,n=!1)=>{var r;if(!(!(t!=null&&t.id)||!n&&o.length===0))try{const p={design_data:{pages:await qt(o,t.id),currentPage:h,workspaceDimensions:q,workspaceSize:ie,selectedElement:B,selectedCell:W,history:je.slice(-5),historyIndex:Math.min(be,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:t.id,name:(i==null?void 0:i.name)||"√Ålbum Personalizado",item_id:i==null?void 0:i.id,preset_id:a==null?void 0:a.id}},thumbnails:ne},f=JSON.stringify(p).length/(1024*1024),j=await fetch(`/api/canvas/projects/${t.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(p)});if(j.ok){const k=await j.json(),M=`editor_progress_project_${t.id}`;return localStorage.removeItem(M),A($=>{const G=new Map($);return n?G.clear():G.delete(h),G}),c&&c.length>0&&setTimeout(()=>{ye().catch($=>{console.warn("‚ö†Ô∏è Error regenerando thumbnail de p√°gina actual:",$)})},300),!0}else{const k=await j.json().catch(()=>({message:"Error desconocido"}));return console.error("‚ùå [AUTO-SAVE] Error guardando en BD:",k),!1}}catch(l){return console.error("‚ùå [AUTO-SAVE] Error en auto-save con procesamiento de im√°genes:",l),!1}},[c,h,q,ie,B,W,je,be,t==null?void 0:t.id,i==null?void 0:i.name,i==null?void 0:i.id,a==null?void 0:a.id,ne,qt,ft]);m.useEffect(()=>{if(!(t!=null&&t.id))return;const o=setInterval(()=>{c.length>0&&qe(c,!1)},5*60*1e3);return()=>clearInterval(o)},[qe,c,t==null?void 0:t.id]),m.useCallback(async()=>{if(!c.length)return{};console.log("üì∏ [THUMBNAILS] Capturando thumbnails de todas las p√°ginas...");const o={},n=h;try{for(let r=0;r<c.length;r++){const l=c[r];if(l!=null&&l.id)try{r!==h&&(ae(r),await new Promise(p=>setTimeout(p,300)));const d=await Ae({type:"thumbnail"});d&&(o[l.id]=d,console.log(`‚úÖ [THUMBNAILS] Thumbnail capturado para p√°gina ${r+1}: ${l.id}`))}catch(d){console.warn(`‚ö†Ô∏è [THUMBNAILS] Error capturando thumbnail para p√°gina ${l.id}:`,d),ne[l.id]&&(o[l.id]=ne[l.id])}}return n!==h&&ae(n),console.log(`‚úÖ [THUMBNAILS] Capturados ${Object.keys(o).length} thumbnails de ${c.length} p√°ginas`),o}catch(r){return console.error("‚ùå [THUMBNAILS] Error capturando thumbnails:",r),n!==h&&ae(n),ne}},[c,h,ae,Ae,ne]);const $n=m.useCallback(async()=>{if(!(t!=null&&t.id)||c.length===0)return ee.error("No hay datos para guardar"),!1;try{return console.log("üì∏ [SAVE] Generando thumbnail de p√°gina actual..."),await ye(),await Ht(),await qe(c,!0)?(ee.success("Progreso guardado exitosamente"),!0):(ee.error("Error al guardar el progreso"),!1)}catch(o){return console.error("‚ùå [SAVE] Error al guardar el progreso:",o),ee.error("Error al guardar el progreso"),!1}},[qe,c,t==null?void 0:t.id,q,a,ft]),Qt=m.useCallback(async o=>{var n;if(console.log("üíæ [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("üîç [QUEUE-SAVE] Datos disponibles:",{projectId:t==null?void 0:t.id,pagesCount:o==null?void 0:o.length,currentPage:h,hasDimensions:!!q,hasThumbnails:!!ne}),!(t!=null&&t.id))return console.error("‚ùå [QUEUE-SAVE] No hay project ID"),!1;if(!o||o.length===0)return console.error("‚ùå [QUEUE-SAVE] No hay p√°ginas para guardar"),!1;try{const l={design_data:{pages:o,currentPage:h,workspaceDimensions:q,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:ne};console.log("üì§ [QUEUE-SAVE] Enviando petici√≥n al servidor...");const d=await fetch(`/api/canvas/projects/${t.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(l)});if(console.log("üì• [QUEUE-SAVE] Respuesta del servidor:",d.status,d.statusText),d.ok){const p=await d.json();return console.log("‚úÖ [QUEUE-SAVE] Guardado exitoso desde cola:",p),!0}else{const p=await d.text();return console.error("‚ùå [QUEUE-SAVE] Error en respuesta del servidor:",d.status,p),!1}}catch(r){return console.error("‚ùå [QUEUE-SAVE] Error guardando desde cola:",r),!1}},[t==null?void 0:t.id,h,q,ne]),yt=m.useCallback(async()=>{if(console.log("üîç [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:z,saveQueueLength:C.length}),z){console.log("‚ö†Ô∏è [SAVE-QUEUE] Ya se est√° procesando, saltando...");return}if(C.length===0){console.log("‚ö†Ô∏è [SAVE-QUEUE] Cola vac√≠a, no hay nada que procesar");return}console.log("üöÄ [SAVE-QUEUE] Iniciando procesamiento de cola..."),T(!0);try{const o=C.slice();console.log("ÔøΩ [SAVE-QUEUE] Cola capturada para procesamiento:",o.length,"elementos"),_([]),console.log("üßπ [SAVE-QUEUE] Cola limpiada");for(const n of o)console.log("üíæ [SAVE-QUEUE] Guardando p√°gina:",n.pageIndex),await Qt(n.pages)?(A(l=>{const d=new Map(l);return d.delete(n.pageIndex),d}),console.log("‚úÖ [SAVE-QUEUE] P√°gina guardada exitosamente:",n.pageIndex)):(console.error("‚ùå [SAVE-QUEUE] Error guardando p√°gina:",n.pageIndex),_(l=>[...l,n]));console.log("‚úÖ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(o){console.error("‚ùå [SAVE-QUEUE] Error procesando cola:",o)}finally{T(!1),console.log("üîì [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[z,C,Qt]);m.useEffect(()=>{console.log("üîÑ [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:C.length,isProcessingQueue:z,shouldProcess:C.length>0&&!z}),C.length>0&&!z&&(console.log("‚è∞ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{yt()},100))},[C.length,z,yt]),m.useEffect(()=>{console.log("üìä [SAVE-QUEUE] Estado de cola actualizado:",{longitud:C.length,elementos:C.map(o=>`p√°gina ${o.pageIndex}`),procesando:z})},[C,z]);const Jt=m.useCallback((o,n)=>{console.log("üîç [SAVE-QUEUE] Intentando agregar p√°gina a cola:",o),A(r=>{const l=Array.from(r.keys());return console.log("üîç [SAVE-QUEUE] Cambios actuales:",l.join(", ")||"ninguno"),r.has(o)?(console.log("‚úÖ [SAVE-QUEUE] P√°gina tiene cambios, agregando a cola:",o),_(d=>{console.log("üîç [SAVE-QUEUE] Cola actual antes de agregar:",d.length,"elementos");const p=d.findIndex(b=>b.pageIndex===o);if(p!==-1){const b=[...d];return b[p]={pageIndex:o,pages:n,timestamp:Date.now()},console.log("üîÑ [SAVE-QUEUE] Actualizando elemento existente en cola"),b}else{const b=[...d,{pageIndex:o,pages:n,timestamp:Date.now()}];return console.log("‚ûï [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",b.length),b}}),console.log("üì§ [SAVE-QUEUE] P√°gina agregada a cola:",o),r):(console.log("‚ö†Ô∏è [SAVE-QUEUE] No hay cambios para la p√°gina:",o,"- No se agregar√° a cola"),r)})},[]),wt=m.useCallback(async o=>{if(console.log("üîÑ [PAGE-CHANGE] Iniciando cambio de p√°gina de",h,"a",o),o===h){console.log("‚ö†Ô∏è [PAGE-CHANGE] Misma p√°gina, no se hace nada");return}A(n=>{console.log("üîç [PAGE-CHANGE] Verificando cambios en p√°gina actual:",h);const r=Array.from(n.keys());return console.log("üîç [PAGE-CHANGE] P√°ginas con cambios:",r.join(", ")||"ninguna"),n.has(h)?(console.log("üíæ [PAGE-CHANGE] ‚úÖ P√°gina actual tiene cambios, guardando antes del cambio:",h),Jt(h,c)):console.log("‚ÑπÔ∏è [PAGE-CHANGE] No hay cambios en la p√°gina actual:",h),n}),ae(o),console.log("üìÑ [PAGE-CHANGE] ‚úÖ P√°gina cambiada a:",o)},[h,c,Jt]),He=()=>`editor_progress_project_${t==null?void 0:t.id}`,Kt=m.useCallback(async()=>{var n,r,l,d;if(!(t!=null&&t.id))return;if(c.some(p=>{var b;return(b=p.cells)==null?void 0:b.some(f=>{var j;return((j=f.elements)==null?void 0:j.length)>0})})){console.log("‚ö†Ô∏è [RECOVERY] Ya hay contenido en el workspace, saltando recuperaci√≥n autom√°tica");return}try{const p=ke.loadFromLocalStorage(),b=await fetch(`/api/canvas/projects/${t.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let f=null;if(b.ok){const k=await b.json();k.success&&((n=k.data)!=null&&n.design_data)&&(f=k.data)}let j=null;if(p&&f){const k=new Date(p.savedAt).getTime(),M=new Date(f.saved_at).getTime();j=k>M?p:f}else p?j=p:f&&(j=f);if(j&&(((r=j.pages)==null?void 0:r.length)>0||((d=(l=j.design_data)==null?void 0:l.pages)==null?void 0:d.length)>0)){const k=new Date(j.savedAt||j.saved_at).getTime();Date.now()-k<30*60*1e3?(console.log("üîÑ [AUTO-RECOVERY] Cargando autom√°ticamente el progreso m√°s reciente"),ee.info("üîÑ Cargando progreso guardado autom√°ticamente..."),Ln(j)):console.log("üìÖ [RECOVERY] Progreso muy antiguo, ignorando autom√°ticamente")}}catch(p){console.error("‚ùå [RECOVERY] Error verificando progreso guardado:",p)}},[t==null?void 0:t.id,ke,c]),Ln=m.useCallback(async o=>{var n;try{let r=[];if(o.pages?r=o.pages:(n=o.design_data)!=null&&n.pages&&(r=o.design_data.pages),r.length>0){oe(r);const l=[JSON.stringify(r)];Fe(l),_e(0),setTimeout(()=>{ce({})},100),ee.success("‚úÖ Progreso cargado exitosamente"),Tn(!1)}}catch(r){console.error("‚ùå [RECOVERY] Error cargando progreso:",r),ee.error("Error al cargar el progreso guardado")}},[oe,Fe,_e,ce]);m.useCallback(async()=>{try{const o=ke.getStorageKey();localStorage.removeItem(o),ee.success("Progreso anterior eliminado")}catch(o){console.error("‚ùå [RECOVERY] Error descartando progreso:",o)}},[ke]),m.useEffect(()=>{t&&i&&a&&(!(w!=null&&w.pages)||w.pages.length===0)&&Yt(a,i)},[t,i,a,w]),m.useEffect(()=>{t!=null&&t.id&&!y&&c.length===0&&!De&&(We(!0),setTimeout(()=>{Kt()},500))},[t==null?void 0:t.id,y,c.length,Kt,De]),m.useEffect(()=>(re.current&&clearTimeout(re.current),t!=null&&t.id&&c.length>0&&(re.current=setTimeout(()=>{Ht()},500)),()=>{re.current&&clearTimeout(re.current)}),[t==null?void 0:t.id,c.length]);const Yt=(o,n)=>{try{const r=[],l=n.pages||o.pages||20;if(n.has_cover_image!==!1){const b=n.cover_image?`/storage/images/item/${n.cover_image}`:null,f=n.cover_image?null:o.background_color||"#ffffff",j={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:b,backgroundColor:f,cells:[{id:"cell-cover-1",elements:[]}]};r.push(j)}const d=n.content_image?`/storage/images/item/${n.content_image}`:null,p=n.content_image?null:o.background_color||"#ffffff";for(let b=1;b<=l;b++){const f={id:`page-content-${b}`,type:"content",pageNumber:b,layout:"layout-1",backgroundImage:d,backgroundColor:p,cells:[{id:`cell-content-${b}-1`,elements:[]}]};r.push(f)}if(n.has_back_cover_image!==!1){const b=n.back_cover_image?`/storage/images/item/${n.back_cover_image}`:null,f=n.back_cover_image?null:o.background_color||"#ffffff",j={id:"page-final",type:"final",layout:"layout-1",backgroundImage:b,backgroundColor:f,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};r.push(j)}oe(r),ae(0),o.width&&o.height&&Be("preset")}catch(r){console.error("‚ùå Error creating pages:",r),U(r.message)}},Et=m.useMemo(()=>({cover:c.filter(o=>o.type==="cover"),content:c.filter(o=>o.type==="content"),final:c.filter(o=>o.type==="final")}),[c]),D=m.useCallback(()=>{if(!B||!W||c.length===0)return null;const o=c[h];if(!o)return null;const n=o.cells.find(r=>r.id===W);return n?n.elements.find(r=>r.id===B):null},[B,W,c,h]),Xt=(o,n)=>{if(n){const r=c[h].cells.find(d=>d.id===n),l=r==null?void 0:r.elements.find(d=>d.id===o);if(l!=null&&l.locked){const d=document.createElement("div");d.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",d.textContent="Este elemento es parte del dise√±o base y no se puede editar",document.body.appendChild(d),setTimeout(()=>{document.body.contains(d)&&document.body.removeChild(d)},3e3);return}}if(n&&ue(n),Z(o),o){const r=c[h].cells.find(d=>d.id===(n||W)),l=r==null?void 0:r.elements.find(d=>d.id===o);(l==null?void 0:l.type)==="image"?(_t(l),console.log("üñºÔ∏è Imagen seleccionada:",l.id,"- Tab actual mantenido:",Q),Q==="filters"?console.log("‚úÖ Usuario ya est√° en filtros, manteniendo"):console.log("‚úÖ Imagen seleccionada, pero manteniendo tab actual:",Q)):(l==null?void 0:l.type)==="text"?(xt(!0),kn({elementId:o,cellId:n||W}),Q!=="filters"&&Q!=="images"&&pe("text")):xt(!1)}else xt(!1),_t(null)},Me=()=>{if(c.length===0)return me[0];const o=c[h];return o?me.find(n=>n.id===o.layout)||me[0]:me[0]},Zt=m.useCallback(it(o=>{try{const n=He(),r={pages:o,currentPage:h,savedAt:Date.now()},l=JSON.stringify(r),d=Math.round(l.length/1024);d<2048?localStorage.setItem(n,l):(console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${d} KB)`),localStorage.removeItem(n))}catch(n){if(console.error("‚ùå Error guardando en localStorage:",n),n.name==="QuotaExceededError")try{localStorage.removeItem(He())}catch(r){console.error("Error limpiando localStorage:",r)}}},300),[h,He]),Qe=m.useCallback(o=>{oe(n=>{if(n===o)return n;const r=JSON.stringify(n),l=JSON.stringify(o);return r===l?(console.log("üîÑ [UPDATE-PAGES] Sin cambios, evitando actualizaci√≥n"),n):(console.log("üìù [UPDATE-PAGES] Aplicando cambios..."),requestAnimationFrame(()=>{if(A(d=>{const p=new Map(d);return p.set(h,Date.now()),p}),o[h]){const d=o[h].id;ce(p=>{if(p[d]){const b={...p};return delete b[d],b}return p})}}),setTimeout(()=>{Fe(d=>{const p=[...d.slice(0,be+1),l];return p.length>50?p.slice(-50):p}),_e(d=>{const p=d+1;return p>50?49:p})},0),o)}),Zt(o)},[h,be,Zt]);m.useEffect(()=>{try{const o=He(),n={pages:c,currentPage:h,savedAt:Date.now()},r=JSON.stringify(n),l=Math.round(r.length/1024);l<2048?localStorage.setItem(o,r):console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${l} KB), saltando guardado`)}catch(o){if(console.error("‚ùå Error guardando currentPage en localStorage:",o),o.name==="QuotaExceededError")try{const n=He();localStorage.removeItem(n)}catch(n){console.error("Error limpiando localStorage:",n)}}},[h,c,He]);const On=o=>{const n=me.find(p=>p.id===o);if(!n)return;const r=[...c],l=r[h],d=Array.from({length:n.cells}).map((p,b)=>l.cells[b]||{id:`cell-${l.id}-${b+1}`,elements:[]});r[h]={...l,layout:o,cells:d},Qe(r),Z(null),ue(null)},Je=(o,n)=>{const r=[...c];for(let l=0;l<r[h].cells.length;l++)r[h].cells[l].id===o&&r[h].cells[l].elements.push(n);Qe(r),Z(n.id),ue(o)},Dt=m.useCallback(it(()=>{A(o=>{const n=new Map(o);return n.set(h,Date.now()),n})},100),[h]),le=m.useCallback((o,n,r,l=!1)=>{oe(d=>{const p=[...d],b=p[h].cells.findIndex(f=>f.id===o);if(b===-1)return d;if(l){const f=p[h].cells[b].elements.find(j=>j.id===n);if(!f)return d;p[h].cells[b].elements.push({...f,...r})}else{const f=p[h].cells[b].elements.findIndex(M=>M.id===n);if(f===-1)return d;const j=p[h].cells[b].elements[f];if(!Object.keys(r).some(M=>{const $=j[M],G=r[M];return typeof G=="object"&&typeof $=="object"?JSON.stringify($)!==JSON.stringify(G):$!==G}))return d;p[h].cells[b].elements[f]={...j,...r}}return p}),r.position||r.size?requestAnimationFrame(()=>{A(d=>{if(d.has(h))return d;const p=new Map(d);return p.set(h,Date.now()),p})}):Dt()},[h,Dt]),et=(o,n)=>{const r=[...c],l=r[h].cells.findIndex(d=>d.id===o);l!==-1&&(r[h].cells[l].elements=r[h].cells[l].elements.filter(d=>d.id!==n),Qe(r),B===n&&Z(null))},Rn=(o,n,r)=>{const l=[...c],d=l[h].cells.findIndex(p=>p.id===o);if(d!==-1){const p=l[h].cells[d].elements,b=p.findIndex(f=>f.id===n);if(b!==-1){const f=r==="up"?b+1:b-1;if(f>=0&&f<p.length){const j=p[b];p[b]=p[f],p[f]=j,Qe(l)}}}},Un=()=>{be>0&&(_e(be-1),oe(JSON.parse(je[be-1])),Z(null),ue(null))},zn=()=>{be<je.length-1&&(_e(be+1),oe(JSON.parse(je[be+1])),Z(null),ue(null))},jt=(o="body")=>{const n=`text-${Date.now()}`,r={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},l={heading:"T√≠tulo Principal",subheading:"Subt√≠tulo",body:"Haz clic para editar"},d={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},p={id:n,type:"text",content:l[o],position:{x:.05,y:.05},size:d[o],style:r[o]};W?Je(W,p):console.log("Selecciona una celda primero")},eo=m.useMemo(()=>{var d;const o=c[h];if(!o)return null;const n=((d=o.cells)==null?void 0:d.flatMap(p=>p.elements||[]))||[],r=n.map(p=>({id:p.id,type:p.type,position:p.position,size:p.size}));return{pageId:o.id,elementsCount:n.length,contentHash:JSON.stringify(r).substring(0,100),backgroundImage:o.backgroundImage,backgroundColor:o.backgroundColor,layout:o.layout}},[c,h]);m.useEffect(()=>{if(c.length===0||y||!eo)return;let o=!1;const n=async()=>{try{const l=c[h];if(!l||!l.id)return;const d=l.id;if(ce(b=>{const f={...b};return delete f[d],f}),await new Promise(b=>setTimeout(b,100)),o)return;const p=await Ae();p&&!o?ce(b=>({...b,[d]:p})):console.warn("‚ö†Ô∏è [DEBUG] No se pudo generar miniatura para:",d)}catch(l){o||console.error("‚ùå [DEBUG] Error regenerando miniatura:",l)}},r=setTimeout(()=>{n()},500);return()=>{o=!0,clearTimeout(r)}},[h,eo,y,Ae]),m.useEffect(()=>{if(c.length===0||y)return;const o=async()=>{const r=c.filter(l=>!ne[l.id]);if(r.length!==0)for(const l of r)try{const d=document.createElement("canvas");d.width=200,d.height=150;const p=d.getContext("2d");if(p.fillStyle=l.backgroundColor||"#ffffff",p.fillRect(0,0,200,150),l.backgroundImage)try{const f=new Image;f.crossOrigin="anonymous",await new Promise((j,k)=>{f.onload=j,f.onerror=k,f.src=l.backgroundImage}),p.drawImage(f,0,0,200,150)}catch(f){console.warn("No se pudo cargar imagen de fondo para miniatura:",f)}l.cells&&l.cells.forEach(f=>{f.elements&&f.elements.forEach(j=>{var k;j.type==="text"&&j.content&&(p.fillStyle=((k=j.style)==null?void 0:k.color)||"#000000",p.font="12px Arial",p.fillText(j.content.substring(0,20)+(j.content.length>20?"...":""),10,30))})});const b=d.toDataURL("image/jpeg",.7);ce(f=>({...f,[l.id]:b})),await new Promise(f=>setTimeout(f,300))}catch(d){console.error("‚ùå Error generando miniatura de fondo para:",l.id,d)}},n=setTimeout(()=>{o()},2e3);return()=>clearTimeout(n)},[c,ne,y]),m.useEffect(()=>{const o=n=>{const r=O.current,l=J.current;if(r.length>0||l.size>0)return n.preventDefault(),n.returnValue="Hay cambios sin guardar. ¬øEst√°s seguro de que quieres salir?",n.returnValue};return window.addEventListener("beforeunload",o),()=>{window.removeEventListener("beforeunload",o)}},[]),m.useEffect(()=>()=>{console.log("üßπ [CLEANUP] Componente desmontado")},[]);const Bn=async()=>{var o;try{if(!i||!a||!(t!=null&&t.id))return!1;await qe(c,!0)||console.warn("‚ö†Ô∏è No se pudo guardar el progreso, pero continuando...");const r={design_data:{id:t.id,title:(i==null?void 0:i.name)||"√Ålbum Personalizado",pages:c,workspace_dimensions:q,created_at:new Date().toISOString()},item_data:{id:i==null?void 0:i.id,name:(i==null?void 0:i.name)||(i==null?void 0:i.title),price:i==null?void 0:i.price,user_id:i==null?void 0:i.user_id,width:i==null?void 0:i.width,height:i==null?void 0:i.height},preset_data:{id:a==null?void 0:a.id,width:a==null?void 0:a.width,height:a==null?void 0:a.height,cover_image:a==null?void 0:a.cover_image,content_layer_image:a==null?void 0:a.content_layer_image,final_layer_image:a==null?void 0:a.final_layer_image},dimensions:{width_mm:(a==null?void 0:a.width)||(i==null?void 0:i.width)||210,height_mm:(a==null?void 0:a.height)||(i==null?void 0:i.height)||297,workspace_width:(q==null?void 0:q.width)||800,workspace_height:(q==null?void 0:q.height)||600}};try{const M=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:t.id,status:"ready_for_pdf",pdf_data:r,completed_at:new Date().toISOString()})});if(M.ok){const $=await M.json()}else console.warn("‚ö†Ô∏è Error marcando proyecto como completado")}catch(M){console.warn("‚ö†Ô∏è Error en marcado de completado:",M)}const l=Date.now(),d=t.id;window.currentProjectId=d,window.albumProjectId=d;let p=a.cover_image;ne&&ne["page-cover"]&&(p=ne["page-cover"]);let b=p;p&&p.startsWith("data:image/")&&p.length>1e5&&(b=a.cover_image||"/assets/img/default-album.jpg");const f={...i,project_id:d,canvas_project_id:t.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:a.width,height_mm:a.height,pages_count:c.length,workspace_dimensions:q,requires_pdf_generation:!0}},j=structuredClone(se),k=j.findIndex(M=>M.id==f.id);return k==-1?j.push({...f,quantity:1}):j[k].quantity++,fe(j),ee.success("√Ålbum agregado al carrito",{description:`${f.name} se ha a√±adido al carrito. El PDF se generar√° en el backend.`,icon:e.jsx(ir,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:j,action:"add",product:f}})),!0}catch(n){return console.error("‚ùå === ERROR EN addAlbumToCart ==="),console.error("Error completo:",n),console.error("Stack trace:",n.stack),console.error("Mensaje del error:",n.message),ee.error("Error al agregar al carrito",{description:`Error espec√≠fico: ${n.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!c||c.length===0)throw new Error("No hay p√°ginas para finalizar");const r={design_data:{pages:($=>$.map(G=>({id:G.id,type:G.type,pageNumber:G.pageNumber,layout:G.layout,cells:G.cells.map(I=>({id:I.id,elements:I.elements.map(L=>{const H={id:L.id,type:L.type,position:L.position,zIndex:L.zIndex||1};if(L.type==="image"){if(L.content.startsWith("data:image/")){const K=btoa(L.content.substring(0,100)).substring(0,20);H.content=`[BASE64_IMAGE_${K}]`,H.contentType=L.content.split(";")[0].split(":")[1],H.originalSize=L.content.length}else H.content=L.content;if(L.filters){const K=Object.entries(L.filters).filter(([te,Y])=>Y!==0&&Y!==!1&&Y!==null).reduce((te,[Y,X])=>(te[Y]=X,te),{});Object.keys(K).length>0&&(H.filters=K)}L.mask&&L.mask!=="none"&&(H.mask=L.mask),L.size&&(H.size=L.size),L.locked&&(H.locked=L.locked)}else if(L.type==="text"&&(H.content=L.content,L.style)){const K=Object.entries(L.style).filter(([te,Y])=>!(te==="fontSize"&&Y==="16px"||te==="color"&&Y==="#000000"||te==="fontFamily"&&Y==="Arial")).reduce((te,[Y,X])=>(te[Y]=X,te),{});Object.keys(K).length>0&&(H.style=K)}return H})}))})))(c),projectInfo:{id:t==null?void 0:t.id,item_id:i==null?void 0:i.id,title:i==null?void 0:i.title,preset_id:a==null?void 0:a.id},presetInfo:{id:a==null?void 0:a.id,name:a==null?void 0:a.name,cover_image:a==null?void 0:a.cover_image,content_image:a==null?void 0:a.content_image,back_cover_image:a==null?void 0:a.back_cover_image},workspace:{width:q.width,height:q.height,scale:q.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(ne).map(([$,G])=>[$,G]))},l=JSON.stringify(r),d=Math.round(l.length/1024),p=Math.round(d/1024*100)/100;let b=0,f=0;c.forEach($=>{var G;(G=$.cells)==null||G.forEach(I=>{var L;(L=I.elements)==null||L.forEach(H=>{H.type==="image"&&H.content&&H.content.startsWith("data:image/")&&(b++,f+=H.content.length)})})});const j=Math.round(f/(1024*1024)*100)/100;if(d>1024&&!confirm(`El dise√±o contiene ${b} im√°genes (${j} MB en im√°genes). Payload completo: ${p} MB. Esto podr√≠a causar problemas al guardarlo. ¬øDesea continuar de todos modos?`))return!1;const k=await fetch(`/api/canvas/projects/${t.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:l});if(!k.ok){let $="Error al finalizar el dise√±o";try{$=(await k.json()).message||$}catch{k.status===413?$="El dise√±o es demasiado grande para ser guardado. Intente simplificar las im√°genes.":k.status>=500&&($="Error del servidor. Intente nuevamente m√°s tarde.")}throw new Error($)}const M=await k.json();return!0}catch(o){console.error("Error al finalizar dise√±o:",o);let n=o.message;return o.message.includes("Failed to fetch")?n="Error de conexi√≥n. Verifique su conexi√≥n a internet e intente nuevamente.":(o.message.includes("NetworkError")||o.message.includes("net::"))&&(n="Error de red. Intente nuevamente m√°s tarde."),alert("Error al finalizar el dise√±o: "+n),!1}};const Hn=m.useCallback(async()=>{try{const{jsPDF:o}=await Vn(async()=>{const{jsPDF:K}=await import("./jspdf.es.min-D3plwuQr.js").then(te=>te.j);return{jsPDF:K}},__vite__mapDeps([0,1,2,3,4]));let n=(a==null?void 0:a.width)||21,r=(a==null?void 0:a.height)||29.7;const l=.3,d=n+l*2,p=r+l*2,b=d*28.35,f=p*28.35,j=new o({orientation:b>f?"landscape":"portrait",unit:"pt",format:[b,f],compress:!1}),k=c.length;let M=0;const $=document.createElement("div");$.id="pdf-progress",$.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",$.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${k} p√°ginas procesadas
                    </p>
                </div>
            `,document.body.appendChild($);const G=K=>{const te=K/k*100;document.getElementById("pdf-progress-bar").style.width=`${te}%`,document.getElementById("current-page").textContent=K},I=h;for(let K=0;K<c.length;K++){const te=c[K];ae(K),await new Promise(Y=>setTimeout(Y,500));try{const Y=await Ae({type:"pdf"});if(Y){const X=Y.width/Y.height,Te=b/f;let ge,he,Ne=0,Le=0;X>Te?(ge=b,he=b/X,Le=(f-he)/2):(he=f,ge=f*X,Ne=(b-ge)/2);const Oe=Y.toDataURL("image/png",1);K>0&&j.addPage([b,f]),j.addImage(Oe,"PNG",Ne,Le,ge,he)}else console.warn(`‚ö†Ô∏è No se pudo capturar la p√°gina ${K+1}`),K>0&&j.addPage([b,f]),j.setFontSize(12),j.text(`Error al renderizar p√°gina ${K+1}`,b/2,f/2,{align:"center"})}catch(Y){console.error(`‚ùå Error procesando p√°gina ${K+1}:`,Y),K>0&&j.addPage([b,f]),j.setFontSize(12),j.text(`Error al procesar p√°gina ${K+1}`,b/2,f/2,{align:"center"})}M++,G(M),await new Promise(Y=>setTimeout(Y,200))}ae(I);const L=`${(i==null?void 0:i.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;j.save(L),document.body.removeChild($);const H=document.createElement("div");return H.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",H.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${L}</span>
                </div>
            `,document.body.appendChild(H),setTimeout(()=>{document.body.contains(H)&&document.body.removeChild(H)},5e3),L}catch(o){console.error("‚ùå Error generando PDF:",o);const n=document.getElementById("pdf-progress");n&&document.body.removeChild(n);const r=document.createElement("div");throw r.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",r.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${o.message}</span>
                </div>
            `,document.body.appendChild(r),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},7e3),o}},[c,h,ae,Ae,a,i]);return window.generateAlbumPDF=Hn,window.generateHighQualityThumbnail=Cn,window.captureCurrentWorkspace=Ae,e.jsxs(Gn,{backend:Wn,className:"!h-screen !w-screen overflow-hidden",children:[y?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu √°lbum personalizado..."})]})}):P?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:P}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):c.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando p√°ginas del √°lbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx(er,{isOpen:An,onRequestClose:()=>{Vt(!1),Pn({isLoading:!1,loadedImages:0,totalImages:0,message:""}),we({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:c.map(o=>({...o,layout:me.find(n=>n.id===o.layout)||me[0]})),pageThumbnails:ne,workspaceDimensions:q,getCurrentLayout:o=>o?me.find(n=>n.id===o.layout)||me[0]:me[0],presetData:a,addAlbumToCart:Bn,projectData:t,itemData:i,albumLoadingState:In}),Pe.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-Pe.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:Pe.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:Pe.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${Pe.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[Pe.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(ar,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Un,disabled:be<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(qn,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:zn,disabled:be>=je.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(Qn,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(t==null?void 0:t.name)||"√Ålbum Sin T√≠tulo",onChange:o=>s({...t,name:o.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del dise√±o"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(C.length>0||z)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:z?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",C.length]})]})}),e.jsx(Kr,{saveStatus:ke.saveStatus,lastSaved:ke.lastSaved,lastAutoSaved:ke.lastAutoSaved,hasUnsavedChanges:v.hasUnsavedChanges||!!(E instanceof Map&&E.has(h)),isOnline:ke.isOnline,saveError:ke.saveError,onManualSave:$n,saveQueueSize:C.length,isProcessingQueue:z,pageChangesCount:E instanceof Map?E.size:0}),C.length>0&&e.jsxs("button",{onClick:()=>{console.log("üîß [DEBUG] Procesando cola manualmente"),yt()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(sn,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(rt,{id:"preview-button",variant:"secondary",size:"sm",onClick:async o=>{o.preventDefault(),o.stopPropagation();try{console.log("üé≠ [ALBUM-EXPERIENCE] Iniciando experiencia √∫nica de √°lbum..."),we({isOpen:!0,phase:"preparing",progress:0,message:"‚ú® Creando tu experiencia",subMessage:"Preparando la magia de tu √°lbum personalizado..."});for(let r=0;r<=30;r+=5)await new Promise(l=>setTimeout(l,100)),we(l=>({...l,progress:r,message:"üîß Construyendo previsualizaci√≥n",subMessage:"Optimizando cada detalle para ti..."}));we(r=>({...r,phase:"processing",message:"Cargando el proyecto",subMessage:"Procesando cada p√°gina con calidad profesional..."}));const n=await Nn((r,l)=>{const d=30+r/l*50;we(p=>({...p,progress:Math.round(d),subMessage:`Procesando imagen ${r} de ${l}...`}))});we(r=>({...r,phase:"finalizing",message:"üé® Aplicando toques finales",subMessage:"Perfeccionando tu vista previa..."}));for(let r=80;r<=100;r+=4)await new Promise(l=>setTimeout(l,80)),we(l=>({...l,progress:r}));we(r=>({...r,phase:"ready",progress:100,message:"üéâ ¬°Tu √°lbum est√° listo!",subMessage:"Experiencia premium creada especialmente para ti"})),await new Promise(r=>setTimeout(r,1e3)),we(r=>({...r,isOpen:!1})),ce(r=>({...r,...n})),setTimeout(()=>{Vt(!0),console.log("‚úÖ [ALBUM-EXPERIENCE] Experiencia √∫nica completada")},300)}catch(n){console.error("‚ùå [ALBUM-EXPERIENCE] Error en experiencia:",n),we(r=>({...r,message:"‚ö†Ô∏è Ups, algo sali√≥ mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{we(r=>({...r,isOpen:!1}))},2e3)}},disabled:Pe.isOpen,icon:e.jsx(lt,{className:"h-4 w-4"}),children:Pe.isOpen?"Creando experiencia...":"Vista de √Ålbum"}),e.jsxs("button",{onClick:jn,className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200",title:"Inicia la gu√≠a paso a paso",children:[e.jsx(ur,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"})]})]})]})}),e.jsxs("div",{className:`flex h-full ${B?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>pe("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(lt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"P√°ginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>pe("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(At,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Dise√±os"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>pe("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(dt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>pe("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(nn,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]}),e.jsxs("button",{"data-tab":"filters",onClick:()=>pe("filters"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="filters"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Jo,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Filtros"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[Q==="templates"&&"Templates",Q==="images"&&"Images",Q==="text"&&"Text",Q==="shapes"&&"Shapes",Q==="stickers"&&"Stickers",Q==="pages"&&"Pages",Q==="panel"&&"Layers Panel",Q==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Q==="templates"&&"Choose a template to get started",Q==="images"&&"Search for images",Q==="text"&&"Add and edit text",Q==="shapes"&&"Add shapes and graphics",Q==="stickers"&&"Add fun stickers",Q==="pages"&&"Manage your pages",Q==="panel"&&"Organize layers and z-index",Q==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(mr,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[Q==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(At,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(vr,{currentLayoutId:(no=c[h])==null?void 0:no.layout,onLayoutChange:On})]}),Q==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Re,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Im√°genes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[Se.length," imagen",Se.length!==1?"s":""]})]}),e.jsx(Xr,{images:Se,onImageSelect:_n,isLoading:ht})]}),Q==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>jt("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"T√≠tulo Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(ct,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>jt("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subt√≠tulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(ct,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>jt("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(ct,{className:"h-4 w-4"})})]})})]}),Q==="text"&&B&&((ro=D())==null?void 0:ro.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(pr,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const o=D();le(W,B,{style:{...o.style,fontWeight:o.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((so=(ao=D())==null?void 0:ao.style)==null?void 0:so.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const o=D();le(W,B,{style:{...o.style,fontStyle:o.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((lo=(io=D())==null?void 0:io.style)==null?void 0:lo.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const o=D();le(W,B,{style:{...o.style,textDecoration:o.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((uo=(co=D())==null?void 0:co.style)==null?void 0:uo.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipograf√≠a:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((mo=(go=D())==null?void 0:go.style)==null?void 0:mo.fontFamily)||"Arial",onChange:o=>{const n=D();le(W,B,{style:{...n.style,fontFamily:o.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tama√±o:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((po=(ho=D())==null?void 0:ho.style)==null?void 0:po.fontSize)||"16px",onChange:o=>{const n=D();le(W,B,{style:{...n.style,fontSize:o.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((xo=(fo=D())==null?void 0:fo.style)==null?void 0:xo.color)||"#000000",onChange:o=>{const n=D();le(W,B,{style:{...n.style,color:o.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((vo=(bo=D())==null?void 0:bo.style)==null?void 0:vo.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((wo=(yo=D())==null?void 0:yo.style)==null?void 0:wo.backgroundColor)||"#ffffff",onChange:o=>{const n=D();le(W,B,{style:{...n.style,backgroundColor:o.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const o=D();le(W,B,{style:{...o.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"üö´"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(o=>{var n,r;return e.jsxs("button",{onClick:()=>{const l=D();le(W,B,{style:{...l.style,textAlign:o}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((r=(n=D())==null?void 0:n.style)==null?void 0:r.textAlign)===o?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[o==="left"&&"‚¨Ö",o==="center"&&"‚¨å",o==="right"&&"‚û°",o==="justify"&&"‚¨ç"]},o)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((jo=(Eo=D())==null?void 0:Eo.style)==null?void 0:jo.lineHeight)||"1.5",onChange:o=>{const n=D();le(W,B,{style:{...n.style,lineHeight:o.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((So=(No=D())==null?void 0:No.style)==null?void 0:So.letterSpacing)||"normal",onChange:o=>{const n=D();le(W,B,{style:{...n.style,letterSpacing:o.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const o=D();le(W,B,{style:{...o.style,textTransform:o.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((ko=(Co=D())==null?void 0:Co.style)==null?void 0:ko.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAY√öS"]}),e.jsxs("button",{onClick:()=>{const o=D();le(W,B,{style:{...o.style,textTransform:o.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((To=(Ao=D())==null?void 0:Ao.style)==null?void 0:To.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"min√∫s"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((Po=(Io=D())==null?void 0:Io.style)==null?void 0:Po.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((_o=(Mo=D())==null?void 0:Mo.style)==null?void 0:_o.opacity)||"1",onChange:o=>{const n=D();le(W,B,{style:{...n.style,opacity:o.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((Lo=($o=D())==null?void 0:$o.style)==null?void 0:Lo.opacity)||1)*100}%, #e5e7eb ${(((Ro=(Oo=D())==null?void 0:Oo.style)==null?void 0:Ro.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),Q==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[c.length," total"]})]})}),Ge&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Ge.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Ge.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Ge.message||`P√°gina: ${Ge.pageId||"actual"}`})]}),c.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando p√°ginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),Et.cover.map((o,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${h===c.indexOf(o)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>wt(c.indexOf(o)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(It,{pageId:o.id,thumbnail:ne[o.id],altText:"Cover",type:"cover"}),E instanceof Map&&E.has&&E.has(c.indexOf(o))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},o.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:Et.content.map((o,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${h===c.indexOf(o)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>wt(c.indexOf(o)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(It,{pageId:o.id,thumbnail:ne[o.id],altText:`Page ${o.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:o.pageNumber}),E instanceof Map&&E.has&&E.has(c.indexOf(o))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},o.id))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),Et.final.map((o,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${h===c.indexOf(o)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>wt(c.indexOf(o)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(It,{pageId:o.id,thumbnail:ne[o.id],altText:"Back Cover",type:"final"}),E instanceof Map&&E.has&&E.has(c.indexOf(o))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},o.id))]})]})]}),Q==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(br,{pages:c,currentPage:h,selectedCell:W,selectedElement:B,onSelectCell:ue,onSelectElement:Z,onUpdateElement:(o,n,r)=>{le(o,n,r)},onDeleteElement:(o,n)=>{et(o,n)},onMoveElement:(o,n,r)=>{Rn(o,n,r)}})}),Q==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Jo,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const o=D();return o&&o.type==="image"?e.jsxs(e.Fragment,{children:[o.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Re,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:o.content,alt:"",className:"w-full h-full object-cover"})})]}),o.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(yr,{selectedMask:o.mask||"none",onSelect:n=>{le(W,B,{mask:n})},availableMasks:rn.map(n=>n.id),selectedImage:o})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(Jn,{filters:o.filters||{},onFilterChange:n=>{le(W,B,{filters:n})},selectedElement:o})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(Re,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:D()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>pe("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(At,{className:"h-4 w-4"}),"Dise√±o de p√°gina"]}),e.jsxs("button",{onClick:()=>pe("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(dt,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(rt,{variant:"ghost",tooltip:"A√±adir Imagen",onClick:()=>bt.current&&bt.current.click(),children:e.jsx(Re,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:bt,onChange:Mn,className:"hidden",accept:"image/*"})]}),B&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(rt,{variant:"ghost",size:"sm",onClick:()=>{if(B&&W){const o=D();if(o){const n={...o,id:`${o.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:o.position.x+.05,y:o.position.y+.05}};Je(W,n)}}},className:"h-8 px-2",icon:e.jsx(sr,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(rt,{variant:"ghost",size:"sm",onClick:()=>{B&&W&&et(W,B)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(an,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:"flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100",children:yn?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:q.width,height:q.height},children:e.jsx("div",{id:`page-${c[h].id}`,className:`grid ${Me().template} gap-6`,style:{width:"100%",height:"100%"},children:c[h].cells.map((o,n)=>{var r;return e.jsx(Go,{id:o.id,elements:o.elements.filter(l=>!l.locked),workspaceSize:q,cellStyle:(r=Me().cellStyles)==null?void 0:r[c[h].cells.indexOf(o)],selectedElement:W===o.id?B:null,onSelectElement:Xt,onAddElement:(l,d)=>Je(d,l),onUpdateElement:(l,d,p)=>le(o.id,l,d,p),onDeleteElement:l=>et(o.id,l),availableMasks:Me().maskCategories.flatMap(l=>l.masks),projectData:t},o.id)})})})}):e.jsxs("div",{id:`page-${c[h].id}`,className:" shadow-xl overflow-hidden",style:{width:q.width,height:q.height,position:"relative",backgroundColor:((Uo=c[h])==null?void 0:Uo.backgroundColor)||"#ffffff",backgroundImage:(zo=c[h])!=null&&zo.backgroundImage?`url(${c[h].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const o=c[h];return o!=null&&o.backgroundImage?e.jsx("img",{src:o.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):o!=null&&o.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:o.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${Me().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((Bo=Me().style)==null?void 0:Bo.gap)||"16px",padding:((Ho=Me().style)==null?void 0:Ho.padding)||"16px"},children:c[h].cells.map(o=>{var n;return e.jsx(Go,{id:o.id,elements:o.elements.filter(r=>!r.locked),workspaceSize:q,cellStyle:(n=Me().cellStyles)==null?void 0:n[c[h].cells.indexOf(o)],selectedElement:W===o.id?B:null,onSelectElement:Xt,onAddElement:(r,l)=>Je(l,r),onUpdateElement:(r,l,d)=>le(o.id,r,l,d),onDeleteElement:r=>et(o.id,r),availableMasks:Me().maskCategories.flatMap(r=>r.masks),projectData:t},o.id)})})]})})]})]})]}),e.jsx(Dn,{})]})}export{es as default};
