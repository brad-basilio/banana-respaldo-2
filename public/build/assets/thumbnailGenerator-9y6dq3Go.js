import{h as F}from"./thumbnailGenerator-B4goYG9Y.js";const C={preview:{scale:.5,width:200,height:150,quality:.8},high_quality:{scale:2,width:800,height:600,quality:1},pdf:{scale:3,width:1200,height:900,quality:1}},v=(e,n=2e3)=>new Promise(i=>{const t=Date.now(),o=()=>{const a=getComputedStyle(e).gridTemplateColumns!=="none",r=e.children.length>0,l=e.offsetWidth>0&&e.offsetHeight>0;(a||r)&&l?requestAnimationFrame(()=>i(!0)):Date.now()-t>n?(console.warn("‚ö†Ô∏è Timeout esperando renderizado completo"),i(!1)):requestAnimationFrame(o)};o()}),E=(e,n)=>{var t,o;const i={};return i.position=e.style.position,i.transform=e.style.transform,i.zIndex=e.style.zIndex,e.style.position="relative",e.style.transform="translateZ(0)",e.style.zIndex="1",n&&n.template&&(e.style.display="grid",e.style.gridTemplateColumns=n.template.includes("grid-cols-1")?"1fr":n.template.includes("grid-cols-2")?"1fr 1fr":n.template.includes("grid-cols-3")?"1fr 1fr 1fr":n.template.includes("grid-cols-4")?"1fr 1fr 1fr 1fr":n.template.includes("grid-cols-5")?"1fr 1fr 1fr 1fr 1fr":"1fr",e.style.gridTemplateRows=n.template.includes("grid-rows-1")?"1fr":n.template.includes("grid-rows-2")?"1fr 1fr":n.template.includes("grid-rows-3")?"1fr 1fr 1fr":"1fr",(t=n.style)!=null&&t.gap&&(e.style.gap=n.style.gap),(o=n.style)!=null&&o.padding&&(e.style.padding=n.style.padding)),i},j=(e,n)=>{Object.keys(n).forEach(i=>{n[i]?e.style[i]=n[i]:e.style.removeProperty(i)})},T=async(e,n)=>{const i=n.querySelectorAll("img"),t=e.querySelectorAll("img");console.log(`üñºÔ∏è [COVER-FIX] Procesando ${t.length} im√°genes para simular object-fit: cover`),i.length!==t.length&&console.warn(`‚ö†Ô∏è [COVER-FIX] Mismatch: ${i.length} originales vs ${t.length} clonadas`);const o=new Map;i.forEach((s,a)=>{const r=getComputedStyle(s),f=s.parentElement.getBoundingClientRect();o.set(a,{objectFit:r.objectFit,objectPosition:r.objectPosition,containerWidth:f.width,containerHeight:f.height,naturalWidth:s.naturalWidth,naturalHeight:s.naturalHeight,src:s.src})});for(let s=0;s<t.length;s++){const a=t[s],r=o.get(s);if(r)try{r.objectFit==="cover"||a.classList.contains("object-cover")||a.className.includes("object-cover")||a.style.objectFit==="cover"||a.closest('[data-element-type="image"]')||a.closest(".workspace-image")||a.closest(".element-image")?(console.log(`üîß [COVER-FIX] Procesando imagen ${s} con object-fit: cover`),await S(a,r,e)):(a.style.imageRendering="optimizeQuality",a.style.width="100%",a.style.height="100%",r.objectFit&&r.objectFit!=="fill"&&(a.style.objectFit=r.objectFit),r.objectPosition&&(a.style.objectPosition=r.objectPosition))}catch(l){console.warn(`‚ö†Ô∏è [COVER-FIX] Error procesando imagen ${s}:`,l),a.style.imageRendering="optimizeQuality",a.style.objectFit="cover",a.style.width="100%",a.style.height="100%"}}},S=async(e,n,i)=>new Promise(t=>{try{const{containerWidth:o,containerHeight:s,naturalWidth:a,naturalHeight:r}=n;if(!o||!s||!a||!r){console.warn("‚ö†Ô∏è [COVER-FIX] Dimensiones inv√°lidas:",n),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t();return}const l=o/s,f=a/r;let h=0,g=0,u=a,d=r;f>l?(u=r*l,h=(a-u)/2):(d=a/l,g=(r-d)/2);const c=i.createElement("canvas");c.width=o,c.height=s;const m=c.getContext("2d"),p=new Image;p.crossOrigin="anonymous",p.onload=()=>{try{m.drawImage(p,h,g,u,d,0,0,o,s);const y=c.toDataURL("image/png",1);e.src=y,e.style.objectFit="fill",e.style.objectPosition="center",e.style.width="100%",e.style.height="100%",e.style.imageRendering="optimizeQuality",console.log("‚úÖ [COVER-FIX] Imagen simulada con object-fit: cover exitosamente"),t()}catch(y){console.warn("‚ö†Ô∏è [COVER-FIX] Error en canvas processing:",y),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t()}},p.onerror=()=>{console.warn("‚ö†Ô∏è [COVER-FIX] Error cargando imagen temporal"),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t()},p.src=e.src}catch(o){console.warn("‚ö†Ô∏è [COVER-FIX] Error en simulateObjectFitCover:",o),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t()}}),w=async(e,n,i={})=>{const t=C[i.type||"preview"];try{const o=document.querySelector(`#page-${e}`);if(!o)return console.error(`‚ùå No se encontr√≥ el elemento de p√°gina: #page-${e}`),null;console.log(`üì∏ Generando thumbnail para p√°gina ${e} con layout:`,n==null?void 0:n.id);const s=E(o,n);await v(o);const a={allowTaint:!0,useCORS:!0,scale:t.scale,width:o.offsetWidth,height:o.offsetHeight,backgroundColor:null,logging:!1,imageTimeout:15e3,removeContainer:!0,onclone:async h=>{const g=h.querySelector(`#page-${e}`);if(g&&n&&(g.className=`${g.className} grid ${n.template}`,n.style&&Object.keys(n.style).forEach(c=>{g.style[c]=n.style[c]}),n.cellStyles)){const c=g.children;Object.keys(n.cellStyles).forEach(m=>{c[m]&&(c[m].className+=` ${n.cellStyles[m]}`)})}h.querySelectorAll("script, iframe, video, audio").forEach(c=>c.remove()),await T(h,o);const d=h.createElement("style");d.textContent=`
                    /* Asegurar que las im√°genes mantengan sus proporciones */
                    img {
                        image-rendering: optimizeQuality !important;
                        image-rendering: -webkit-optimize-contrast !important;
                        image-rendering: crisp-edges !important;
                    }
                    
                    /* Contenedores de imagen */
                    [data-element-type="image"] {
                        overflow: hidden !important;
                        position: relative !important;
                    }
                    
                    [data-element-type="image"] img,
                    .workspace-image,
                    .element-image {
                        width: 100% !important;
                        height: 100% !important;
                        display: block !important;
                    }
                    
                    /* Grid layout espec√≠fico */
                    .grid {
                        display: grid !important;
                    }
                `,h.head.appendChild(d)}},r=await F(o,a);if(j(o,s),!r||r.width===0||r.height===0)throw new Error("Canvas inv√°lido generado");let l=r;if(t.width&&t.height&&(r.width!==t.width||r.height!==t.height)){l=document.createElement("canvas"),l.width=t.width,l.height=t.height;const h=l.getContext("2d");h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high";const g=r.width/r.height,u=t.width/t.height;let d,c,m=0,p=0;g>u?(d=t.width,c=t.width/g,p=(t.height-c)/2):(c=t.height,d=t.height*g,m=(t.width-d)/2),h.fillStyle="#ffffff",h.fillRect(0,0,t.width,t.height),h.drawImage(r,m,p,d,c)}const f=l.toDataURL("image/png",t.quality);return console.log(`‚úÖ Thumbnail generado exitosamente para p√°gina ${e}`),f}catch(o){return console.error(`‚ùå Error generando thumbnail para p√°gina ${e}:`,o),null}},b=(e,n,i={width:200,height:150})=>{const t=document.createElement("canvas");t.width=i.width,t.height=i.height;const o=t.getContext("2d"),s={cover:"#8B5CF6",content:"#3B82F6",final:"#10B981"};return o.fillStyle=s[n]||"#6B7280",o.fillRect(0,0,i.width,i.height),o.fillStyle="#FFFFFF",o.font="14px Arial",o.textAlign="center",o.fillText(n==="cover"?"Portada":n==="final"?"Contraportada":"P√°gina",i.width/2,i.height/2),t.toDataURL("image/png",.8)},O=async(e,n={width:800,height:600})=>{const i={};console.log(`üì∏ [COMPAT] Generando ${e.length} thumbnails con nueva API...`);try{for(const t of e)try{const o={id:t.layout||"layout-1",template:"grid-cols-1 grid-rows-1",cells:1,style:{gap:"0px",padding:"0px"}},s=await w(t.id,o,{type:"preview",workspaceDimensions:n});if(s)i[t.id]=s,console.log(`‚úÖ [COMPAT] Thumbnail generado para p√°gina ${t.id}`);else{const a=b(t.id,t.type||"content");i[t.id]=a,console.log(`üîÑ [COMPAT] Fallback generado para p√°gina ${t.id}`)}}catch(o){console.error(`‚ùå [COMPAT] Error en p√°gina ${t.id}:`,o);const s=b(t.id,t.type||"content");i[t.id]=s}return console.log(`‚úÖ [COMPAT] Proceso completado. ${Object.keys(i).length}/${e.length} thumbnails generados`),i}catch(t){console.error("‚ùå [COMPAT] Error general en generateAccurateThumbnails:",t);for(const o of e)i[o.id]||(i[o.id]=b(o.id,o.type||"content"));return i}},P=async(e,n)=>(console.log("üîÑ [STUB] generateFastThumbnails llamada, redirigiendo a generateAccurateThumbnails"),O(e,n)),R=async(e,n,i={})=>(console.log(`üîÑ [STUB] generateSingleThumbnail llamada para p√°gina ${e}`),w(e,n,i)),I=()=>{console.log("üßπ [STUB] clearThumbnailCaches llamada")},W=async(e,n,i={})=>(console.log(`üé® [STUB] generateThumbnailWithGuaranteedFilters llamada para p√°gina ${e}`),w(e,n,{...i,type:"high_quality"})),$=e=>{console.log(`üîç [DEBUG] Analizando im√°genes en p√°gina ${e}...`);const n=document.querySelector(`#page-${e}`);if(!n){console.error(`‚ùå [DEBUG] No se encontr√≥ p√°gina ${e}`);return}const i=n.querySelectorAll("img");console.log(`üìä [DEBUG] Encontradas ${i.length} im√°genes en p√°gina ${e}`),i.forEach((t,o)=>{const s=getComputedStyle(t),a=t.parentElement,r=a?a.getBoundingClientRect():null;console.log(`üñºÔ∏è [DEBUG] Imagen ${o}:`,{src:t.src.substring(0,50)+"...",objectFit:s.objectFit,objectPosition:s.objectPosition,naturalWidth:t.naturalWidth,naturalHeight:t.naturalHeight,displayWidth:t.offsetWidth,displayHeight:t.offsetHeight,containerWidth:r==null?void 0:r.width,containerHeight:r==null?void 0:r.height,classes:t.className,parentClasses:a==null?void 0:a.className,hasObjectCover:t.classList.contains("object-cover")||t.className.includes("object-cover"),computedObjectFit:s.objectFit,inlineObjectFit:t.style.objectFit})})};typeof window<"u"&&(window.debugImageCover=$);export{R as a,P as b,I as c,W as g};
