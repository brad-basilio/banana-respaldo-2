const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as Zn}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as f,R as Lt}from"./index-BH53Isel.js";import{T as pn,l as de,i as fn,D as ea,H as ta,U as oa,R as na,B as lt,F as aa,E as en}from"./EditableCell-DczCXCx2.js";import{h as tn}from"./thumbnailGenerator-B4goYG9Y.js";import{g as kt,B as gt}from"./dom-to-image-more.min-BXf88tF_.js";import{L as ht}from"./layers-6oegOx-p.js";import{C as ra}from"./chevron-down-DS-mdh9v.js";import{C as sa}from"./chevron-right-Ckt5D2ka.js";import{E as ia}from"./eye-CKCH9ORv.js";import{c as Ae}from"./createLucideIcon-Cy5Ya80P.js";import{T as bn}from"./trash-2-DK1wnsDn.js";import{S as la}from"./star-wPQTHY_n.js";import{I as He}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as re,T as ca}from"./index-BZYhE2TF.js";import{m as on}from"./main-6DCdASTx.js";import{B as da}from"./V1Edit-CxI6v2uA.js";import{G as nn}from"./Global-D6eBBAMK.js";import{S as xn}from"./save-BvSyoVHO.js";import{C as ua}from"./clock-BTrEpQej.js";import{T as ga}from"./triangle-alert-vFMqKi4t.js";import{C as ma}from"./check-DQ7QoS0v.js";import{L as ha}from"./loader-circle-CrvBvIt1.js";import{C as pa}from"./chevron-left-B2s3ZsB7.js";import{P as mt}from"./plus-Bot15Khs.js";import{F as fa}from"./filter-Ci9tsc_e.js";import{C as ba}from"./copy-6OEekgvq.js";import{C as xa}from"./circle-check-big-D6DM3vPb.js";import{u as va}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wa=Ae("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ya=Ae("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=Ae("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=Ae("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ta=Ae("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Na=Ae("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=Ae("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Aa=Ae("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=Ae("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const an=Ae("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ia=Ae("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),ja=({pages:o,currentPage:n,selectedCell:s,selectedElement:m,onSelectCell:i,onSelectElement:b,onUpdateElement:N,onDeleteElement:k,onMoveElement:E})=>{var L;if(!o||!o[n])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ht,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const w=o[n],_=((L=w==null?void 0:w.cells)==null?void 0:L.filter(O=>O.elements&&O.elements.length>0))||[],[I,v]=f.useState(()=>{const O={};return _.forEach(U=>{O[U.id]=!0}),O}),T=O=>{v(U=>({...U,[O]:!U[O]}))},j=O=>{switch(O){case"image":return e.jsx(He,{className:"h-4 w-4"});case"text":return e.jsx(pn,{className:"h-4 w-4"});case"shape":return e.jsx(Sa,{className:"h-4 w-4"});case"sticker":return e.jsx(la,{className:"h-4 w-4"});default:return e.jsx(Ca,{className:"h-4 w-4"})}},$=(O,U)=>{switch(O.type){case"text":return O.content?O.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${U+1}`;case"shape":return O.shape||"Shape";case"sticker":return`Sticker ${U+1}`;default:return`Element ${U+1}`}},R=(O,U,K)=>{N(O,U,{visible:K})},H=(O,U)=>{i(O),b(U)};return e.jsx("div",{className:"space-y-2",children:_.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ht,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):_.map(O=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${s===O.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{T(O.id),i(O.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:I[O.id]?e.jsx(ra,{className:"h-4 w-4"}):e.jsx(sa,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",O.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[O.elements.length," element",O.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[O.x,", ",O.y]})]}),I[O.id]&&e.jsx("div",{className:"border-t border-gray-100",children:O.elements.map((U,K)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${m===U.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>H(O.id,U.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:j(U.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:$(U,K)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[U.type," ‚Ä¢ Layer ",K+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:G=>{G.stopPropagation(),R(O.id,U.id,!U.visible)},className:"p-1 hover:bg-gray-200 rounded",title:U.visible?"Hide element":"Show element",children:U.visible!==!1?e.jsx(ia,{className:"h-3 w-3 text-gray-500"}):e.jsx(Na,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:G=>{G.stopPropagation(),E(O.id,U.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:K===O.elements.length-1,children:e.jsx(ya,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:G=>{G.stopPropagation(),E(O.id,U.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:K===0,children:e.jsx(wa,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:G=>{G.stopPropagation(),k(O.id,U.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(bn,{className:"h-3 w-3"})})]})]},U.id))})]},O.id))})};function ka({currentLayoutId:o,onLayoutChange:n}){const[s,m]=f.useState("all"),i={all:{name:"Todos",layouts:de},hero:{name:"Hero",layouts:de.filter(b=>b.category==="hero")},editorial:{name:"Editorial",layouts:de.filter(b=>b.category==="editorial")},storytelling:{name:"Historia",layouts:de.filter(b=>b.category==="storytelling")},minimal:{name:"Minimal",layouts:de.filter(b=>b.category==="minimal")},creative:{name:"Creativo",layouts:de.filter(b=>b.category==="creative")},classic:{name:"Cl√°sico",layouts:de.filter(b=>b.category==="classic")}};return Object.keys(i).filter(b=>b==="all"||i[b].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:i[s].layouts.map(b=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>n(b.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${b.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:b.cells}).map((N,k)=>{var E,w;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(w=(E=b.cellStyles)==null?void 0:E[k])!=null&&w.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},k)})}),o===b.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:b.name}),b.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:b.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[b.cells," ",b.cells===1?"celda":"celdas"]})})]})]},b.id))}),i[s].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categor√≠a."})})]})}const Ra=({selectedMask:o,onSelect:n,availableMasks:s=[],selectedImage:m})=>{var k,E;const[i,b]=f.useState("B√°sicas"),N={};return fn.forEach(w=>{N[w.category]||(N[w.category]=[]),(s.includes(w.id)||w.id==="none")&&N[w.category].push(w)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(N).slice(0,2).map(w=>N[w].length>0&&e.jsx("button",{onClick:()=>b(w),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${i===w?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:w},w))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(k=N[i])==null?void 0:k.slice(0,6).map(w=>e.jsxs("div",{onClick:()=>n(w.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${o===w.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:m!=null&&m.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:w.id==="circle"?"circle(50%)":w.id==="rounded"||w.id==="rounded-sm"?"inset(0 round 8%)":w.id==="rounded-lg"?"inset(0 round 16%)":w.id==="rounded-rect"?"inset(0 round 12%)":w.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":w.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":w.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":w.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":w.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":w.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":w.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":w.id==="frame"?"inset(10% round 10%)":w.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':w.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':w.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:m.content,alt:w.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:w.id==="circle"?"circle(50%)":w.id==="rounded"||w.id==="rounded-sm"?"inset(0 round 8%)":w.id==="rounded-lg"?"inset(0 round 16%)":w.id==="rounded-rect"?"inset(0 round 12%)":w.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":w.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":w.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":w.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":w.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":w.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":w.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":w.id==="frame"?"inset(10% round 10%)":w.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':w.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':w.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:w.name})]},w.id))}),((E=N[i])==null?void 0:E.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver m√°s m√°scaras (",N[i].length-6," m√°s)"]})]})};let Mt={},vn;function Ot(o={}){Mt={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...o}}function z(o){return o?Mt[o]:Mt}function Oa(o){vn=o}function Ce(){return vn}let pt={};function ct(o,n){pt[o]=n}function Ge(o){var n;(n=pt[o])==null||n.call(pt)}function _a(){pt={}}function dt(o,n,s,m){return(o/=m/2)<1?s/2*o*o+n:-s/2*(--o*(o-2)-1)+n}function wn(o){const n='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return o.flatMap(s=>{const m=s.matches(n),i=Array.from(s.querySelectorAll(n));return[...m?[s]:[],...i]}).filter(s=>getComputedStyle(s).pointerEvents!=="none"&&Ma(s))}function yn(o){if(!o||La(o))return;const n=z("smoothScroll"),s=o.offsetHeight>window.innerHeight;o.scrollIntoView({behavior:!n||Pa(o)?"auto":"smooth",inline:"center",block:s?"start":"center"})}function Pa(o){if(!o||!o.parentElement)return;const n=o.parentElement;return n.scrollHeight>n.clientHeight}function La(o){const n=o.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&n.right<=(window.innerWidth||document.documentElement.clientWidth)}function Ma(o){return!!(o.offsetWidth||o.offsetHeight||o.getClientRects().length)}let ft={};function fe(o,n){ft[o]=n}function W(o){return o?ft[o]:ft}function rn(){ft={}}function $a(o,n,s,m){let i=W("__activeStagePosition");const b=i||s.getBoundingClientRect(),N=m.getBoundingClientRect(),k=dt(o,b.x,N.x-b.x,n),E=dt(o,b.y,N.y-b.y,n),w=dt(o,b.width,N.width-b.width,n),_=dt(o,b.height,N.height-b.height,n);i={x:k,y:E,width:w,height:_},Cn(i),fe("__activeStagePosition",i)}function En(o){if(!o)return;const n=o.getBoundingClientRect(),s={x:n.x,y:n.y,width:n.width,height:n.height};fe("__activeStagePosition",s),Cn(s)}function Fa(){const o=W("__activeStagePosition"),n=W("__overlaySvg");if(!o)return;if(!n){console.warn("No stage svg found.");return}const s=window.innerWidth,m=window.innerHeight;n.setAttribute("viewBox",`0 0 ${s} ${m}`)}function Ua(o){const n=Ba(o);document.body.appendChild(n),An(n,s=>{s.target.tagName==="path"&&Ge("overlayClick")}),fe("__overlaySvg",n)}function Cn(o){const n=W("__overlaySvg");if(!n){Ua(o);return}const s=n.firstElementChild;if((s==null?void 0:s.tagName)!=="path")throw new Error("no path element found in stage svg");s.setAttribute("d",Tn(o))}function Ba(o){const n=window.innerWidth,s=window.innerHeight,m=document.createElementNS("http://www.w3.org/2000/svg","svg");m.classList.add("driver-overlay","driver-overlay-animated"),m.setAttribute("viewBox",`0 0 ${n} ${s}`),m.setAttribute("xmlSpace","preserve"),m.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),m.setAttribute("version","1.1"),m.setAttribute("preserveAspectRatio","xMinYMin slice"),m.style.fillRule="evenodd",m.style.clipRule="evenodd",m.style.strokeLinejoin="round",m.style.strokeMiterlimit="2",m.style.zIndex="10000",m.style.position="fixed",m.style.top="0",m.style.left="0",m.style.width="100%",m.style.height="100%";const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",Tn(o)),i.style.fill=z("overlayColor")||"rgb(0,0,0)",i.style.opacity=`${z("overlayOpacity")}`,i.style.pointerEvents="auto",i.style.cursor="auto",m.appendChild(i),m}function Tn(o){const n=window.innerWidth,s=window.innerHeight,m=z("stagePadding")||0,i=z("stageRadius")||0,b=o.width+m*2,N=o.height+m*2,k=Math.min(i,b/2,N/2),E=Math.floor(Math.max(k,0)),w=o.x-m+E,_=o.y-m,I=b-E*2,v=N-E*2;return`M${n},0L0,0L0,${s}L${n},${s}L${n},0Z
    M${w},${_} h${I} a${E},${E} 0 0 1 ${E},${E} v${v} a${E},${E} 0 0 1 -${E},${E} h-${I} a${E},${E} 0 0 1 -${E},-${E} v-${v} a${E},${E} 0 0 1 ${E},-${E} z`}function za(){const o=W("__overlaySvg");o&&o.remove()}function Ha(){const o=document.getElementById("driver-dummy-element");if(o)return o;let n=document.createElement("div");return n.id="driver-dummy-element",n.style.width="0",n.style.height="0",n.style.pointerEvents="none",n.style.opacity="0",n.style.position="fixed",n.style.top="50%",n.style.left="50%",document.body.appendChild(n),n}function sn(o){const{element:n}=o;let s=typeof n=="function"?n():typeof n=="string"?document.querySelector(n):n;s||(s=Ha()),Va(s,o)}function Ga(){const o=W("__activeElement"),n=W("__activeStep");o&&(En(o),Fa(),In(o,n))}function Va(o,n){var s;const m=Date.now(),i=W("__activeStep"),b=W("__activeElement")||o,N=!b||b===o,k=o.id==="driver-dummy-element",E=b.id==="driver-dummy-element",w=z("animate"),_=n.onHighlightStarted||z("onHighlightStarted"),I=(n==null?void 0:n.onHighlighted)||z("onHighlighted"),v=(i==null?void 0:i.onDeselected)||z("onDeselected"),T=z(),j=W();!N&&v&&v(E?void 0:b,i,{config:T,state:j,driver:Ce()}),_&&_(k?void 0:o,n,{config:T,state:j,driver:Ce()});const $=!N&&w;let R=!1;Qa(),fe("previousStep",i),fe("previousElement",b),fe("activeStep",n),fe("activeElement",o);const H=()=>{if(W("__transitionCallback")!==H)return;const L=Date.now()-m,O=400-L<=400/2;n.popover&&O&&!R&&$&&(ln(o,n),R=!0),z("animate")&&L<400?$a(L,400,b,o):(En(o),I&&I(k?void 0:o,n,{config:z(),state:W(),driver:Ce()}),fe("__transitionCallback",void 0),fe("__previousStep",i),fe("__previousElement",b),fe("__activeStep",n),fe("__activeElement",o)),window.requestAnimationFrame(H)};fe("__transitionCallback",H),window.requestAnimationFrame(H),yn(o),!$&&n.popover&&ln(o,n),b.classList.remove("driver-active-element","driver-no-interaction"),b.removeAttribute("aria-haspopup"),b.removeAttribute("aria-expanded"),b.removeAttribute("aria-controls"),((s=n.disableActiveInteraction)!=null?s:z("disableActiveInteraction"))&&o.classList.add("driver-no-interaction"),o.classList.add("driver-active-element"),o.setAttribute("aria-haspopup","dialog"),o.setAttribute("aria-expanded","true"),o.setAttribute("aria-controls","driver-popover-content")}function Da(){var o;(o=document.getElementById("driver-dummy-element"))==null||o.remove(),document.querySelectorAll(".driver-active-element").forEach(n=>{n.classList.remove("driver-active-element","driver-no-interaction"),n.removeAttribute("aria-haspopup"),n.removeAttribute("aria-expanded"),n.removeAttribute("aria-controls")})}function et(){const o=W("__resizeTimeout");o&&window.cancelAnimationFrame(o),fe("__resizeTimeout",window.requestAnimationFrame(Ga))}function Wa(o){var n;if(!W("isInitialized")||!(o.key==="Tab"||o.keyCode===9))return;const s=W("__activeElement"),m=(n=W("popover"))==null?void 0:n.wrapper,i=wn([...m?[m]:[],...s?[s]:[]]),b=i[0],N=i[i.length-1];if(o.preventDefault(),o.shiftKey){const k=i[i.indexOf(document.activeElement)-1]||N;k==null||k.focus()}else{const k=i[i.indexOf(document.activeElement)+1]||b;k==null||k.focus()}}function Nn(o){var n;((n=z("allowKeyboardControl"))==null||n)&&(o.key==="Escape"?Ge("escapePress"):o.key==="ArrowRight"?Ge("arrowRightPress"):o.key==="ArrowLeft"&&Ge("arrowLeftPress"))}function An(o,n,s){const m=(i,b)=>{const N=i.target;o.contains(N)&&((!s||s(N))&&(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation()),b==null||b(i))};document.addEventListener("pointerdown",m,!0),document.addEventListener("mousedown",m,!0),document.addEventListener("pointerup",m,!0),document.addEventListener("mouseup",m,!0),document.addEventListener("click",i=>{m(i,n)},!0)}function qa(){window.addEventListener("keyup",Nn,!1),window.addEventListener("keydown",Wa,!1),window.addEventListener("resize",et),window.addEventListener("scroll",et)}function Ka(){window.removeEventListener("keyup",Nn),window.removeEventListener("resize",et),window.removeEventListener("scroll",et)}function Qa(){const o=W("popover");o&&(o.wrapper.style.display="none")}function ln(o,n){var s,m;let i=W("popover");i&&document.body.removeChild(i.wrapper),i=Ja(),document.body.appendChild(i.wrapper);const{title:b,description:N,showButtons:k,disableButtons:E,showProgress:w,nextBtnText:_=z("nextBtnText")||"Next &rarr;",prevBtnText:I=z("prevBtnText")||"&larr; Previous",progressText:v=z("progressText")||"{current} of {total}"}=n.popover||{};i.nextButton.innerHTML=_,i.previousButton.innerHTML=I,i.progress.innerHTML=v,b?(i.title.innerHTML=b,i.title.style.display="block"):i.title.style.display="none",N?(i.description.innerHTML=N,i.description.style.display="block"):i.description.style.display="none";const T=k||z("showButtons"),j=w||z("showProgress")||!1,$=(T==null?void 0:T.includes("next"))||(T==null?void 0:T.includes("previous"))||j;i.closeButton.style.display=T.includes("close")?"block":"none",$?(i.footer.style.display="flex",i.progress.style.display=j?"block":"none",i.nextButton.style.display=T.includes("next")?"block":"none",i.previousButton.style.display=T.includes("previous")?"block":"none"):i.footer.style.display="none";const R=E||z("disableButtons")||[];R!=null&&R.includes("next")&&(i.nextButton.disabled=!0,i.nextButton.classList.add("driver-popover-btn-disabled")),R!=null&&R.includes("previous")&&(i.previousButton.disabled=!0,i.previousButton.classList.add("driver-popover-btn-disabled")),R!=null&&R.includes("close")&&(i.closeButton.disabled=!0,i.closeButton.classList.add("driver-popover-btn-disabled"));const H=i.wrapper;H.style.display="block",H.style.left="",H.style.top="",H.style.bottom="",H.style.right="",H.id="driver-popover-content",H.setAttribute("role","dialog"),H.setAttribute("aria-labelledby","driver-popover-title"),H.setAttribute("aria-describedby","driver-popover-description");const L=i.arrow;L.className="driver-popover-arrow";const O=((s=n.popover)==null?void 0:s.popoverClass)||z("popoverClass")||"";H.className=`driver-popover ${O}`.trim(),An(i.wrapper,ne=>{var ue,ye,u;const te=ne.target,x=((ue=n.popover)==null?void 0:ue.onNextClick)||z("onNextClick"),X=((ye=n.popover)==null?void 0:ye.onPrevClick)||z("onPrevClick"),ie=((u=n.popover)==null?void 0:u.onCloseClick)||z("onCloseClick");if(te.closest(".driver-popover-next-btn"))return x?x(o,n,{config:z(),state:W(),driver:Ce()}):Ge("nextClick");if(te.closest(".driver-popover-prev-btn"))return X?X(o,n,{config:z(),state:W(),driver:Ce()}):Ge("prevClick");if(te.closest(".driver-popover-close-btn"))return ie?ie(o,n,{config:z(),state:W(),driver:Ce()}):Ge("closeClick")},ne=>!(i!=null&&i.description.contains(ne))&&!(i!=null&&i.title.contains(ne))&&typeof ne.className=="string"&&ne.className.includes("driver-popover")),fe("popover",i);const U=((m=n.popover)==null?void 0:m.onPopoverRender)||z("onPopoverRender");U&&U(i,{config:z(),state:W(),driver:Ce()}),In(o,n),yn(H);const K=o.classList.contains("driver-dummy-element"),G=wn([H,...K?[]:[o]]);G.length>0&&G[0].focus()}function Sn(){const o=W("popover");if(!(o!=null&&o.wrapper))return;const n=o.wrapper.getBoundingClientRect(),s=z("stagePadding")||0,m=z("popoverOffset")||0;return{width:n.width+s+m,height:n.height+s+m,realWidth:n.width,realHeight:n.height}}function cn(o,n){const{elementDimensions:s,popoverDimensions:m,popoverPadding:i,popoverArrowDimensions:b}=n;return o==="start"?Math.max(Math.min(s.top-i,window.innerHeight-m.realHeight-b.width),b.width):o==="end"?Math.max(Math.min(s.top-(m==null?void 0:m.realHeight)+s.height+i,window.innerHeight-(m==null?void 0:m.realHeight)-b.width),b.width):o==="center"?Math.max(Math.min(s.top+s.height/2-(m==null?void 0:m.realHeight)/2,window.innerHeight-(m==null?void 0:m.realHeight)-b.width),b.width):0}function dn(o,n){const{elementDimensions:s,popoverDimensions:m,popoverPadding:i,popoverArrowDimensions:b}=n;return o==="start"?Math.max(Math.min(s.left-i,window.innerWidth-m.realWidth-b.width),b.width):o==="end"?Math.max(Math.min(s.left-(m==null?void 0:m.realWidth)+s.width+i,window.innerWidth-(m==null?void 0:m.realWidth)-b.width),b.width):o==="center"?Math.max(Math.min(s.left+s.width/2-(m==null?void 0:m.realWidth)/2,window.innerWidth-(m==null?void 0:m.realWidth)-b.width),b.width):0}function In(o,n){const s=W("popover");if(!s)return;const{align:m="start",side:i="left"}=(n==null?void 0:n.popover)||{},b=m,N=o.id==="driver-dummy-element"?"over":i,k=z("stagePadding")||0,E=Sn(),w=s.arrow.getBoundingClientRect(),_=o.getBoundingClientRect(),I=_.top-E.height;let v=I>=0;const T=window.innerHeight-(_.bottom+E.height);let j=T>=0;const $=_.left-E.width;let R=$>=0;const H=window.innerWidth-(_.right+E.width);let L=H>=0;const O=!v&&!j&&!R&&!L;let U=N;if(N==="top"&&v?L=R=j=!1:N==="bottom"&&j?L=R=v=!1:N==="left"&&R?L=v=j=!1:N==="right"&&L&&(R=v=j=!1),N==="over"){const K=window.innerWidth/2-E.realWidth/2,G=window.innerHeight/2-E.realHeight/2;s.wrapper.style.left=`${K}px`,s.wrapper.style.right="auto",s.wrapper.style.top=`${G}px`,s.wrapper.style.bottom="auto"}else if(O){const K=window.innerWidth/2-(E==null?void 0:E.realWidth)/2,G=10;s.wrapper.style.left=`${K}px`,s.wrapper.style.right="auto",s.wrapper.style.bottom=`${G}px`,s.wrapper.style.top="auto"}else if(R){const K=Math.min($,window.innerWidth-(E==null?void 0:E.realWidth)-w.width),G=cn(b,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});s.wrapper.style.left=`${K}px`,s.wrapper.style.top=`${G}px`,s.wrapper.style.bottom="auto",s.wrapper.style.right="auto",U="left"}else if(L){const K=Math.min(H,window.innerWidth-(E==null?void 0:E.realWidth)-w.width),G=cn(b,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});s.wrapper.style.right=`${K}px`,s.wrapper.style.top=`${G}px`,s.wrapper.style.bottom="auto",s.wrapper.style.left="auto",U="right"}else if(v){const K=Math.min(I,window.innerHeight-E.realHeight-w.width);let G=dn(b,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});s.wrapper.style.top=`${K}px`,s.wrapper.style.left=`${G}px`,s.wrapper.style.bottom="auto",s.wrapper.style.right="auto",U="top"}else if(j){const K=Math.min(T,window.innerHeight-(E==null?void 0:E.realHeight)-w.width);let G=dn(b,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});s.wrapper.style.left=`${G}px`,s.wrapper.style.bottom=`${K}px`,s.wrapper.style.top="auto",s.wrapper.style.right="auto",U="bottom"}O?s.arrow.classList.add("driver-popover-arrow-none"):Ya(b,U,o)}function Ya(o,n,s){const m=W("popover");if(!m)return;const i=s.getBoundingClientRect(),b=Sn(),N=m.arrow,k=b.width,E=window.innerWidth,w=i.width,_=i.left,I=b.height,v=window.innerHeight,T=i.top,j=i.height;N.className="driver-popover-arrow";let $=n,R=o;if(n==="top"?(_+w<=0?($="right",R="end"):_+w-k<=0&&($="top",R="start"),_>=E?($="left",R="end"):_+k>=E&&($="top",R="end")):n==="bottom"?(_+w<=0?($="right",R="start"):_+w-k<=0&&($="bottom",R="start"),_>=E?($="left",R="start"):_+k>=E&&($="bottom",R="end")):n==="left"?(T+j<=0?($="bottom",R="end"):T+j-I<=0&&($="left",R="start"),T>=v?($="top",R="end"):T+I>=v&&($="left",R="end")):n==="right"&&(T+j<=0?($="bottom",R="start"):T+j-I<=0&&($="right",R="start"),T>=v?($="top",R="start"):T+I>=v&&($="right",R="end")),!$)N.classList.add("driver-popover-arrow-none");else{N.classList.add(`driver-popover-arrow-side-${$}`),N.classList.add(`driver-popover-arrow-align-${R}`);const H=s.getBoundingClientRect(),L=N.getBoundingClientRect(),O=z("stagePadding")||0,U=H.left-O<window.innerWidth&&H.right+O>0&&H.top-O<window.innerHeight&&H.bottom+O>0;n==="bottom"&&U&&(L.x>H.x&&L.x+L.width<H.x+H.width?m.wrapper.style.transform="translateY(0)":(N.classList.remove(`driver-popover-arrow-align-${R}`),N.classList.add("driver-popover-arrow-none"),m.wrapper.style.transform=`translateY(-${O/2}px)`))}}function Ja(){const o=document.createElement("div");o.classList.add("driver-popover");const n=document.createElement("div");n.classList.add("driver-popover-arrow");const s=document.createElement("header");s.id="driver-popover-title",s.classList.add("driver-popover-title"),s.style.display="none",s.innerText="Popover Title";const m=document.createElement("div");m.id="driver-popover-description",m.classList.add("driver-popover-description"),m.style.display="none",m.innerText="Popover description is here";const i=document.createElement("button");i.type="button",i.classList.add("driver-popover-close-btn"),i.setAttribute("aria-label","Close"),i.innerHTML="&times;";const b=document.createElement("footer");b.classList.add("driver-popover-footer");const N=document.createElement("span");N.classList.add("driver-popover-progress-text"),N.innerText="";const k=document.createElement("span");k.classList.add("driver-popover-navigation-btns");const E=document.createElement("button");E.type="button",E.classList.add("driver-popover-prev-btn"),E.innerHTML="&larr; Previous";const w=document.createElement("button");return w.type="button",w.classList.add("driver-popover-next-btn"),w.innerHTML="Next &rarr;",k.appendChild(E),k.appendChild(w),b.appendChild(N),b.appendChild(k),o.appendChild(i),o.appendChild(n),o.appendChild(s),o.appendChild(m),o.appendChild(b),{wrapper:o,arrow:n,title:s,description:m,footer:b,previousButton:E,nextButton:w,closeButton:i,footerButtons:k,progress:N}}function Xa(){var o;const n=W("popover");n&&((o=n.wrapper.parentElement)==null||o.removeChild(n.wrapper))}function Za(o={}){Ot(o);function n(){z("allowClose")&&_()}function s(){const v=z("overlayClickBehavior");if(z("allowClose")&&v==="close"){_();return}v==="nextStep"&&m()}function m(){const v=W("activeIndex"),T=z("steps")||[];if(typeof v>"u")return;const j=v+1;T[j]?w(j):_()}function i(){const v=W("activeIndex"),T=z("steps")||[];if(typeof v>"u")return;const j=v-1;T[j]?w(j):_()}function b(v){(z("steps")||[])[v]?w(v):_()}function N(){var v;if(W("__transitionCallback"))return;const T=W("activeIndex"),j=W("__activeStep"),$=W("__activeElement");if(typeof T>"u"||typeof j>"u"||typeof W("activeIndex")>"u")return;const R=((v=j.popover)==null?void 0:v.onPrevClick)||z("onPrevClick");if(R)return R($,j,{config:z(),state:W(),driver:Ce()});i()}function k(){var v;if(W("__transitionCallback"))return;const T=W("activeIndex"),j=W("__activeStep"),$=W("__activeElement");if(typeof T>"u"||typeof j>"u")return;const R=((v=j.popover)==null?void 0:v.onNextClick)||z("onNextClick");if(R)return R($,j,{config:z(),state:W(),driver:Ce()});m()}function E(){W("isInitialized")||(fe("isInitialized",!0),document.body.classList.add("driver-active",z("animate")?"driver-fade":"driver-simple"),qa(),ct("overlayClick",s),ct("escapePress",n),ct("arrowLeftPress",N),ct("arrowRightPress",k))}function w(v=0){var T,j,$,R,H,L,O,U;const K=z("steps");if(!K){console.error("No steps to drive through"),_();return}if(!K[v]){_();return}fe("__activeOnDestroyed",document.activeElement),fe("activeIndex",v);const G=K[v],ne=K[v+1],ue=K[v-1],ye=((T=G.popover)==null?void 0:T.doneBtnText)||z("doneBtnText")||"Done",u=z("allowClose"),te=typeof((j=G.popover)==null?void 0:j.showProgress)<"u"?($=G.popover)==null?void 0:$.showProgress:z("showProgress"),x=(((R=G.popover)==null?void 0:R.progressText)||z("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${v+1}`).replace("{{total}}",`${K.length}`),X=((H=G.popover)==null?void 0:H.showButtons)||z("showButtons"),ie=["next","previous",...u?["close"]:[]].filter(D=>!(X!=null&&X.length)||X.includes(D)),Ee=((L=G.popover)==null?void 0:L.onNextClick)||z("onNextClick"),B=((O=G.popover)==null?void 0:O.onPrevClick)||z("onPrevClick"),Z=((U=G.popover)==null?void 0:U.onCloseClick)||z("onCloseClick");sn({...G,popover:{showButtons:ie,nextBtnText:ne?void 0:ye,disableButtons:[...ue?[]:["previous"]],showProgress:te,progressText:x,onNextClick:Ee||(()=>{ne?w(v+1):_()}),onPrevClick:B||(()=>{w(v-1)}),onCloseClick:Z||(()=>{_()}),...(G==null?void 0:G.popover)||{}}})}function _(v=!0){const T=W("__activeElement"),j=W("__activeStep"),$=W("__activeOnDestroyed"),R=z("onDestroyStarted");if(v&&R){const O=!T||(T==null?void 0:T.id)==="driver-dummy-element";R(O?void 0:T,j,{config:z(),state:W(),driver:Ce()});return}const H=(j==null?void 0:j.onDeselected)||z("onDeselected"),L=z("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),Ka(),Xa(),Da(),za(),_a(),rn(),T&&j){const O=T.id==="driver-dummy-element";H&&H(O?void 0:T,j,{config:z(),state:W(),driver:Ce()}),L&&L(O?void 0:T,j,{config:z(),state:W(),driver:Ce()})}$&&$.focus()}const I={isActive:()=>W("isInitialized")||!1,refresh:et,drive:(v=0)=>{E(),w(v)},setConfig:Ot,setSteps:v=>{rn(),Ot({...z(),steps:v})},getConfig:z,getState:W,getActiveIndex:()=>W("activeIndex"),isFirstStep:()=>W("activeIndex")===0,isLastStep:()=>{const v=z("steps")||[],T=W("activeIndex");return T!==void 0&&T===v.length-1},getActiveStep:()=>W("activeStep"),getActiveElement:()=>W("activeElement"),getPreviousElement:()=>W("previousElement"),getPreviousStep:()=>W("previousStep"),moveNext:m,movePrevious:i,moveTo:b,hasNextStep:()=>{const v=z("steps")||[],T=W("activeIndex");return T!==void 0&&!!v[T+1]},hasPreviousStep:()=>{const v=z("steps")||[],T=W("activeIndex");return T!==void 0&&!!v[T-1]},highlight:v=>{E(),sn({...v,popover:v.popover?{showButtons:[],showProgress:!1,progressText:"",...v.popover}:void 0})},destroy:()=>{_(!1)}};return Oa(I),I}const Pe=new Map,Le=new Map;function er(o){if(typeof document>"u"||document.getElementById("filter-emergency-button-"+o))return;console.log(`üö® [EMERGENCIA] Creando bot√≥n espec√≠fico para p√°gina ${o}`);const n=document.createElement("button");n.id="filter-emergency-button-"+o,n.innerText="üé® Regenerar filtros",n.style.cssText=`
        position: fixed;
        bottom: 70px;
        right: 20px;
        background: linear-gradient(135deg, #8844ee 0%, #6366f1 100%);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 12px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.2s ease;
    `,n.onmouseover=()=>{n.style.transform="translateY(-2px)",n.style.boxShadow="0 6px 16px rgba(0,0,0,0.25)"},n.onmouseout=()=>{n.style.transform="translateY(0)",n.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)"},n.onclick=()=>{n.style.transform="scale(0.95)",setTimeout(()=>n.style.transform="scale(1)",150),n.innerText="‚öôÔ∏è Regenerando...",window.FORCE_FILTER_APPLICATION=!0,window.PRESERVE_FILTERS_FOR_PAGE=o,Le.has(`${o}-300x300`)&&Le.delete(`${o}-300x300`),setTimeout(()=>{try{console.log(`üîÑ [EMERGENCIA-FILTROS] Regenerando miniatura para p√°gina ${o}`),typeof window.regenerateCurrentThumbnailNow=="function"?window.regenerateCurrentThumbnailNow():typeof window.forceRegenerateThumbnail=="function"&&window.forceRegenerateThumbnail();const s=Date.now();window._lastFilterRegeneration=s,setTimeout(()=>{n.innerText="‚úÖ ¬°Filtros aplicados!",setTimeout(()=>{n.innerText="üé® Regenerar filtros",setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1,window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},2e3)},500)}catch(s){console.error("‚ùå [EMERGENCIA-FILTROS] Error regenerando miniatura:",s),n.innerText="‚ùå Error",setTimeout(()=>{n.innerText="üé® Regenerar filtros"},2e3)}},100)},document.body.appendChild(n)}function tr(o,n,s,m,i,b){if(!n||!n.type)return;console.log("üé≠ [Mask] Aplicando m√°scara:",n.type),o.save(),o.beginPath();const N=s+i/2,k=m+b/2;switch(n.type){case"circle":const E=Math.min(i,b)/2;o.arc(N,k,E,0,2*Math.PI);break;case"ellipse":o.ellipse(N,k,i/2,b/2,0,0,2*Math.PI);break;case"star":const w=5,_=Math.min(i,b)/2,I=_*.4;for(let T=0;T<w*2;T++){const j=T*Math.PI/w,$=T%2===0?_:I,R=N+Math.cos(j)*$,H=k+Math.sin(j)*$;T===0?o.moveTo(R,H):o.lineTo(R,H)}o.closePath();break;case"hexagon":const v=Math.min(i,b)/2;for(let T=0;T<6;T++){const j=T*Math.PI/3,$=N+Math.cos(j)*v,R=k+Math.sin(j)*v;T===0?o.moveTo($,R):o.lineTo($,R)}o.closePath();break;case"triangle":o.moveTo(N,m),o.lineTo(s,m+b),o.lineTo(s+i,m+b),o.closePath();break;default:o.rect(s,m,i,b)}o.clip()}async function jn(o){return Pe.has(o)?Pe.get(o):new Promise((n,s)=>{const m=new Image;m.crossOrigin="anonymous",m.onload=()=>{Pe.set(o,m),n(m)},m.onerror=()=>{console.warn(`‚ö†Ô∏è No se pudo cargar imagen: ${o}`),n(null)},setTimeout(()=>{Pe.has(o)||(console.warn(`‚è∞ Timeout cargando imagen: ${o}`),n(null))},3e3),m.src=o})}function kn(o,n,s){var j,$,R,H;const{x:m,y:i,width:b,height:N}=s,k=((j=n.position)==null?void 0:j.x)||0,E=(($=n.position)==null?void 0:$.y)||0,w=m+(k<=1?k*b:k),_=i+(E<=1?E*N:E),I=(R=n.size)!=null&&R.width?n.size.width<=1?n.size.width*b:n.size.width:b,v=(H=n.size)!=null&&H.height?n.size.height<=1?n.size.height*N:n.size.height:N,T=window.PRESERVE_FILTERS_FOR_PAGE===!0||window.PRESERVE_FILTERS_FOR_PAGE===n.pageId;if(console.log(`üé® [FastThumbnail] Renderizando elemento ${n.id}:`,{type:n.type,hasFilters:!!n.filters,hasMask:!!n.mask,filters:n.filters,mask:n.mask,preserveFilters:T}),n.type==="image"&&n.content){const L=Pe.get(n.content);if(L){if(o.save(),o.translate(w,_),n.filters){console.log("üé® [FastThumbnail] APLICANDO FILTROS COMPLETOS:",n.filters);const u=n.filters.brightness!==void 0&&n.filters.brightness!==100||n.filters.contrast!==void 0&&n.filters.contrast!==100||n.filters.saturation!==void 0&&n.filters.saturation!==100||n.filters.tint!==void 0&&n.filters.tint!==0||n.filters.hue!==void 0&&n.filters.hue!==0||n.filters.blur!==void 0&&n.filters.blur>0||n.filters.gaussianBlur!==void 0&&n.filters.gaussianBlur>0||n.filters.opacity!==void 0&&n.filters.opacity!==100||n.filters.scale!==void 0&&n.filters.scale!==1||n.filters.rotate!==void 0&&n.filters.rotate!==0||n.filters.flipHorizontal||n.filters.flipVertical;u&&(console.log("‚úÖ [FastThumbnail] Filtros reales detectados, aplicando..."),n._hasRealFilters=!0,n.pageId&&!window._pagesWithFilters&&(window._pagesWithFilters=new Set,window._pagesWithFilters.add(n.pageId)));const te=`
                    brightness(${(n.filters.brightness??100)/100})
                    contrast(${(n.filters.contrast??100)/100})
                    saturate(${(n.filters.saturation??100)/100})
                    sepia(${(n.filters.tint??0)/100})
                    hue-rotate(${n.filters.hue??0}deg)
                    blur(${Math.max(n.filters.blur??0,n.filters.gaussianBlur??0)}px)
                    opacity(${(n.filters.opacity??100)/100})
                `.replace(/\s+/g," ").trim();console.log("üé® [FastThumbnail] Filter string:",te);const x=u||window.FORCE_FILTER_APPLICATION;if(x&&n.type==="image"&&L){console.log("üöÄ [FastThumbnail] Usando m√©todo avanzado de dos pasos para filtros");try{const X=L.width/L.height,ie=I/v;let Ee=0,B=0,Z=L.width,D=L.height;X>ie?(Z=L.height*ie,Ee=(L.width-Z)/2):(D=L.width/ie,B=(L.height-D)/2);const le=document.createElement("canvas");le.width=I,le.height=v;const J=le.getContext("2d",{alpha:!0});if(J.filter=te,J.drawImage(L,Ee,B,Z,D,0,0,I,v),n.filters.scale!==1||n.filters.rotate!==0||n.filters.flipHorizontal||n.filters.flipVertical){console.log("‚öôÔ∏è [FastThumbnail] Aplicando transformaciones avanzadas");const pe=document.createElement("canvas");pe.width=I,pe.height=v;const Se=pe.getContext("2d",{alpha:!0});Se.save(),Se.translate(I/2,v/2);const ve=(n.filters.flipHorizontal?-1:1)*(n.filters.scale||1),Te=(n.filters.flipVertical?-1:1)*(n.filters.scale||1);Se.scale(ve,Te),n.filters.rotate&&Se.rotate(n.filters.rotate*Math.PI/180),Se.drawImage(le,-I/2,-v/2),Se.restore(),o.drawImage(pe,0,0)}else o.drawImage(le,0,0);console.log("‚úÖ [FastThumbnail] Filtros aplicados exitosamente con m√©todo avanzado");return}catch(X){console.error("‚ö†Ô∏è Error en m√©todo avanzado de filtros:",X)}}else try{if(o.filter=te,window.FORCE_FILTER_APPLICATION){console.log("üî• [FastThumbnail] Forzando aplicaci√≥n con m√©todo alternativo");const X=o.globalAlpha;o.globalAlpha=.9999,setTimeout(()=>{o&&(o.globalAlpha=X)},0)}}catch(X){console.error("‚ö†Ô∏è Error al aplicar filtros est√°ndar:",X)}if(!x&&n.type==="image"&&L){const X=n.filters.scale??1,ie=n.filters.rotate??0,Ee=n.filters.flipHorizontal??!1,B=n.filters.flipVertical??!1;(X!==1||ie!==0||Ee||B)&&(console.log("‚öôÔ∏è [FastThumbnail] Aplicando transformaciones est√°ndar"),o.translate(I/2,v/2),o.scale(X*(Ee?-1:1),X*(B?-1:1)),o.rotate(ie*Math.PI/180),o.translate(-I/2,-v/2))}}n.mask&&(console.log("üé≠ [FastThumbnail] APLICANDO M√ÅSCARA:",n.mask),tr(o,n.mask,w,_,I,v));const O=L.width/L.height,U=I/v;let K=0,G=0,ne=L.width,ue=L.height;if(O>U?(ne=L.height*U,K=(L.width-ne)/2):(ue=L.width/U,G=(L.height-ue)/2),(n._hasRealFilters||n.filters&&window.ENABLE_ADVANCED_FILTER_RENDERING||window.FORCE_FILTER_APPLICATION)&&typeof un=="function"){console.log("üåü [M√âTODO ULTRA] Usando t√©cnica especializada para garantizar filtros");try{const u=document.createElement("canvas");u.width=I,u.height=v,u.getContext("2d",{alpha:!0}).drawImage(L,K,G,ne,ue,0,0,I,v);const x=un(u,n.filters,I,v);o.drawImage(x,0,0,I,v),console.log("‚úÖ [FastThumbnail] Imagen procesada con m√©todo ultra garantizado"),window._successfulFilterRenderings||(window._successfulFilterRenderings={}),n.id&&(window._successfulFilterRenderings[n.id]={timestamp:Date.now(),method:"ultra",hasRealFilters:!!n._hasRealFilters})}catch(u){console.error("‚ö†Ô∏è Error en m√©todo ultra avanzado, usando fallback:",u);const te=document.createElement("canvas");te.width=I,te.height=v;const x=te.getContext("2d",{alpha:!0});if(o.filter)try{x.filter=o.filter}catch(X){console.warn("‚ö†Ô∏è Error copiando filtros al canvas temporal:",X)}x.drawImage(L,K,G,ne,ue,0,0,I,v),o.drawImage(te,0,0),console.log("üîÑ [FastThumbnail] Imagen procesada con m√©todo de fallback")}}else o.drawImage(L,K,G,ne,ue,0,0,I,v),console.log("üñºÔ∏è [FastThumbnail] Imagen dibujada con m√©todo est√°ndar");o.restore()}}else if(n.type==="text"&&n.content){o.save();const L=n.style||{},O=Math.max(8,parseInt(L.fontSize)||16),U=L.color||"#000000";o.font=`${O}px Arial, sans-serif`,o.fillStyle=U,o.textBaseline="top";let K=n.content.split(`
`)[0]||"";K.length>50&&(K=K.substring(0,50)+"..."),o.fillText(K,w+4,_+4),o.restore()}}function un(o,n,s,m){if(console.log("üî• [FilterHelper] Aplicando filtros avanzados a imagen:",{sourceImgWidth:o.width,sourceImgHeight:o.height,targetWidth:s,targetHeight:m,filters:n}),!(n&&(n.brightness!==void 0&&n.brightness!==100||n.contrast!==void 0&&n.contrast!==100||n.saturation!==void 0&&n.saturation!==100||n.tint!==void 0&&n.tint!==0||n.hue!==void 0&&n.hue!==0||n.blur!==void 0&&n.blur>0||n.gaussianBlur!==void 0&&n.gaussianBlur>0||n.opacity!==void 0&&n.opacity!==100||n.scale!==void 0&&n.scale!==1||n.rotate!==void 0&&n.rotate!==0||n.flipHorizontal||n.flipVertical))&&!window.FORCE_FILTER_APPLICATION){console.log("‚è© [FilterHelper] No hay filtros reales que aplicar, retornando imagen simple");const E=document.createElement("canvas");return E.width=s,E.height=m,E.getContext("2d").drawImage(o,0,0,s,m),E}const b=document.createElement("canvas");b.width=s,b.height=m;const N=b.getContext("2d",{alpha:!0}),k=`
        brightness(${((n==null?void 0:n.brightness)??100)/100})
        contrast(${((n==null?void 0:n.contrast)??100)/100})
        saturate(${((n==null?void 0:n.saturation)??100)/100})
        sepia(${((n==null?void 0:n.tint)??0)/100})
        hue-rotate(${(n==null?void 0:n.hue)??0}deg)
        blur(${Math.max((n==null?void 0:n.blur)??0,(n==null?void 0:n.gaussianBlur)??0)}px)
        opacity(${((n==null?void 0:n.opacity)??100)/100})
    `.replace(/\s+/g," ").trim();console.log("üé® [FilterHelper] Aplicando filtro CSS:",k);try{N.filter=k}catch(E){console.error("‚ö†Ô∏è Error aplicando filtros CSS:",E)}if(N.drawImage(o,0,0,s,m),n&&(n.scale!==void 0&&n.scale!==1||n.rotate!==void 0&&n.rotate!==0||n.flipHorizontal||n.flipVertical)){console.log("üîÑ [FilterHelper] Aplicando transformaciones:",{scale:n.scale,rotate:n.rotate,flipH:n.flipHorizontal,flipV:n.flipVertical});const E=document.createElement("canvas");E.width=s,E.height=m;const w=E.getContext("2d",{alpha:!0});w.save(),w.translate(s/2,m/2);const _=(n.flipHorizontal?-1:1)*(n.scale??1),I=(n.flipVertical?-1:1)*(n.scale??1);return w.scale(_,I),n.rotate&&w.rotate(n.rotate*Math.PI/180),w.drawImage(b,-s/2,-m/2,s,m),w.restore(),console.log("‚úÖ [FilterHelper] Filtros y transformaciones aplicados exitosamente"),E}return console.log("‚úÖ [FilterHelper] Filtros aplicados exitosamente (sin transformaciones)"),b}async function gn({page:o,workspaceDimensions:n,onProgress:s=null,preserveFilters:m=!1}){var w;console.log(`‚ö° Generando thumbnail para p√°gina: ${o.id}${m?" (CON PRESERVACI√ìN DE FILTROS)":""}`),window.ENABLE_ADVANCED_FILTER_RENDERING=!0;let b=!1,N=0;o.cells&&o.cells.forEach(_=>{_.elements&&_.elements.forEach(I=>{I.filters&&(I.filters.brightness!==void 0&&I.filters.brightness!==100||I.filters.contrast!==void 0&&I.filters.contrast!==100||I.filters.saturation!==void 0&&I.filters.saturation!==100||I.filters.tint!==void 0&&I.filters.tint!==0||I.filters.hue!==void 0&&I.filters.hue!==0||I.filters.blur!==void 0&&I.filters.blur>0||I.filters.gaussianBlur!==void 0&&I.filters.gaussianBlur>0||I.filters.opacity!==void 0&&I.filters.opacity!==100||I.filters.scale!==void 0&&I.filters.scale!==1||I.filters.rotate!==void 0&&I.filters.rotate!==0||I.filters.flipHorizontal||I.filters.flipVertical)&&(b=!0,N++,I._hasRealFilters=!0,I.pageId=o.id,console.log(`üîç [FILTROS] Detectado elemento ${I.id} con filtros:`,I.filters))})}),(m||b||window.FORCE_FILTER_APPLICATION)&&(console.log(`üé≠ [FILTROS] Activando preservaci√≥n de filtros para p√°gina ${o.id} (${N} elementos con filtros)`),window.PRESERVE_FILTERS_FOR_PAGE=o.id,window.FORCE_FILTER_APPLICATION=!0,window._pagesWithFiltersProtected||(window._pagesWithFiltersProtected=new Set),window._pagesWithFiltersProtected.add(o.id),b&&typeof document<"u"&&setTimeout(()=>{document.getElementById("filter-emergency-button-"+o.id)||er(o.id)},500));const E=(_,I,v="")=>{const T=Math.round(_/I*100);console.log(`üìä Progreso p√°gina ${o.id}: ${_}/${I} (${T}%) ${v}`),s&&s({current:_,total:I,percentage:T,message:v,pageId:o.id})};try{const _=300/Math.max(n.width,n.height),I=Math.round(n.width*_),v=Math.round(n.height*_),T=`${o.id}-${I}x${v}`;if(Le.has(T))return console.log(`üì¶ Thumbnail encontrado en cache: ${o.id}`),E(4,4,"Cargado desde cache"),Le.get(T);E(1,4,"Iniciando generaci√≥n...");const j=new Set;o.backgroundImage&&j.add(o.backgroundImage),o.cells&&o.cells.forEach(O=>{O.elements&&O.elements.forEach(U=>{U.type==="image"&&U.content&&j.add(U.content)})}),E(2,4,"Cargando im√°genes...");const $=Array.from(j).map(async O=>{try{const U=new Promise((G,ne)=>setTimeout(()=>ne(new Error("Timeout")),3e3)),K=jn(O);await Promise.race([K,U])}catch{console.warn(`‚ö†Ô∏è Error/timeout cargando imagen: ${O}`)}});await Promise.all($),E(3,4,"Renderizando thumbnail...");const R=document.createElement("canvas"),H=R.getContext("2d",{alpha:!1,willReadFrequently:!1});if(R.width=I,R.height=v,H.fillStyle=o.backgroundColor||"#ffffff",H.fillRect(0,0,R.width,R.height),o.backgroundImage){const O=Pe.get(o.backgroundImage);O&&H.drawImage(O,0,0,R.width,R.height)}if(o.cells&&o.cells.length>0){const O=Math.ceil(Math.sqrt(Math.min(o.cells.length,9))),U=R.width/O,K=R.height/Math.ceil(Math.min(o.cells.length,9)/O);o.cells.slice(0,9).forEach((G,ne)=>{const ue=ne%O,ye=Math.floor(ne/O),u=ue*U,te=ye*K;G.elements&&G.elements.filter(X=>X.type==="image"||X.type==="text").slice(0,3).forEach(X=>{kn(H,X,{x:u,y:te,width:U,height:K})})})}E(4,4,"Guardando thumbnail...");const L=R.toDataURL("image/jpeg",.7);if(Le.set(T,L),window.PRESERVE_FILTERS_FOR_PAGE===o.id){console.log("üîç [VERIFICACI√ìN] Comprobando si el thumbnail tiene los filtros aplicados...");let O=0,U=0;(w=o.cells)==null||w.forEach(K=>{var G;(G=K.elements)==null||G.forEach(ne=>{ne._hasRealFilters&&(O++,U++)})}),console.log(`üìä [RESULTADO] Elementos con filtros: ${O}`),console.log(`üßπ [FastThumbnail] Limpiando banderas de filtros para p√°gina ${o.id}`),window.PRESERVE_FILTERS_FOR_PAGE=null,window.FORCE_FILTER_APPLICATION=!1,window._filteredThumbnails||(window._filteredThumbnails={}),window._filteredThumbnails[o.id]={timestamp:Date.now(),elementsWithFilters:O},console.log(`üîí [PROTECCI√ìN] Thumbnail con filtros registrado y protegido: ${o.id}`)}return console.log(`‚úÖ Thumbnail generado para p√°gina: ${o.id}`),L}catch(_){return console.error(`‚ùå Error generando thumbnail para p√°gina ${o.id}:`,_),E(4,4,"Error en generaci√≥n"),null}}async function mn({pages:o,workspaceDimensions:n,onProgress:s=null}){const m={};console.log(`‚ö° Generando ${o.length} thumbnails r√°pidos...`);const b=(v,T,j="")=>{const $=Math.round(v/T*100);console.log(`üìä Progreso: ${v}/${T} (${$}%) ${j}`),s&&s({current:v,total:T,percentage:$,message:j})},N=new Set;o.forEach(v=>{v.backgroundImage&&N.add(v.backgroundImage),v.cells&&v.cells.forEach(T=>{T.elements&&T.elements.forEach(j=>{j.type==="image"&&j.content&&N.add(j.content)})})});const k=Array.from(N),E=5;b(0,k.length,"Cargando im√°genes...");for(let v=0;v<k.length;v+=E){const T=k.slice(v,v+E);await Promise.all(T.map(jn)),b(Math.min(v+E,k.length),k.length,"Cargando im√°genes...")}console.log(`üì∏ Im√°genes cargadas: ${Pe.size}`);const w=300/Math.max(n.width,n.height),_=Math.round(n.width*w),I=Math.round(n.height*w);b(0,o.length,"Generando thumbnails...");for(let v=0;v<o.length;v++){const T=o[v];try{const j=`${T.id}-${_}x${I}`;if(Le.has(j)){m[T.id]=Le.get(j),b(v+1,o.length,`Thumbnail ${T.id} (cached)`);continue}const $=document.createElement("canvas"),R=$.getContext("2d",{alpha:!1,willReadFrequently:!1});if($.width=_,$.height=I,R.fillStyle=T.backgroundColor||"#ffffff",R.fillRect(0,0,$.width,$.height),T.backgroundImage){const L=Pe.get(T.backgroundImage);L&&R.drawImage(L,0,0,$.width,$.height)}if(T.cells&&T.cells.length>0){const L=Math.ceil(Math.sqrt(T.cells.length)),O=$.width/L,U=$.height/Math.ceil(T.cells.length/L);T.cells.forEach((K,G)=>{if(G>=9)return;const ne=G%L,ue=Math.floor(G/L),ye=ne*O,u=ue*U;K.elements&&K.elements.filter(x=>x.type==="image"||x.type==="text").slice(0,3).forEach(x=>{kn(R,x,{x:ye,y:u,width:O,height:U})})})}const H=$.toDataURL("image/jpeg",.7);m[T.id]=H,Le.set(j,H),b(v+1,o.length,`Thumbnail ${T.id} generado`)}catch(j){console.error(`‚ùå Error generando thumbnail r√°pido para ${T.id}:`,j),m[T.id]=null,b(v+1,o.length,`Error en ${T.id}`)}}return console.log(`‚ö° ¬°${Object.keys(m).length} thumbnails generados en modo r√°pido!`),m}function _t(){Pe.clear(),Le.clear(),console.log("üßπ Caches de thumbnails limpiados")}const or=async(o,n,s)=>{var m;try{console.log("üì§ [SAVE] Subiendo imagen al backend:",n);const[i,b]=o.split(","),N=((m=i.match(/data:image\/(\w+)/))==null?void 0:m[1])||"png",k=new FormData,E=atob(b),w=new Array(E.length);for(let j=0;j<E.length;j++)w[j]=E.charCodeAt(j);const _=new Uint8Array(w),I=new Blob([_],{type:`image/${N}`});k.append("image",I,`element_${n}.${N}`),k.append("project_id",s),k.append("element_id",n);const v=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:k});if(!v.ok)throw new Error("Error al subir imagen al servidor");const T=await v.json();return console.log("‚úÖ [SAVE] Imagen subida exitosamente:",T.url),T.url}catch(i){throw console.error("‚ùå [SAVE] Error subiendo imagen:",i),i}},nr=async(o,n)=>{var b,N;console.log("üîÑ [SAVE] Procesando im√°genes para guardado...");const s=[];let m=0,i=0;for(const k of o)for(const E of k.cells||[])for(const w of E.elements||[])w.type==="image"&&((b=w.content)!=null&&b.startsWith("data:image/"))&&m++;console.log(`üìä [SAVE] Total de im√°genes base64 a procesar: ${m}`);for(const k of o){const E={...k};E.cells=[];for(const w of k.cells||[]){const _={...w};_.elements=[];for(const I of w.elements||[]){const v={...I};if(I.type==="image"&&((N=I.content)!=null&&N.startsWith("data:image/")))try{const T=await or(I.content,I.id,n);v.content=T,v.isUploaded=!0,i++,console.log(`‚úÖ [SAVE] Imagen ${i}/${m} procesada`)}catch(T){console.error("‚ùå [SAVE] Error procesando imagen:",I.id,T),v.uploadError=T.message}_.elements.push(v)}E.cells.push(_)}s.push(E)}return console.log(`‚úÖ [SAVE] Procesamiento completado: ${i}/${m} im√°genes subidas`),s},ar=async(o,n)=>{var s;try{console.log("üîç [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:o,thumbnailsCount:Object.keys(n).length});const m=[];for(const[N,k]of Object.entries(n))console.log(`üîç [DEBUG] Procesando thumbnail para p√°gina ${N}:`,{hasData:!!k,isBase64:k&&k.startsWith("data:image/"),dataLength:k?k.length:0}),k&&k.startsWith("data:image/")&&m.push({page_id:N,thumbnail_data:k});if(m.length===0){console.log("‚ÑπÔ∏è [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`üñºÔ∏è [THUMBNAILS] Guardando ${m.length} thumbnails como archivos...`),console.log(`üîç [DEBUG] URL del endpoint: /api/thumbnails/${o}/save-as-files`);const i=await fetch(`/api/thumbnails/${o}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||""},credentials:"include",body:JSON.stringify({thumbnails:m})});if(console.log("üîç [DEBUG] Respuesta del servidor:",{status:i.status,statusText:i.statusText,ok:i.ok}),!i.ok){const N=await i.text();throw console.error("‚ùå [THUMBNAILS] Error respuesta del servidor:",N),new Error(`Error al guardar thumbnails: ${i.status} ${i.statusText}`)}const b=await i.json();return console.log("‚úÖ [THUMBNAILS] Thumbnails guardados como archivos:",b),b}catch(m){throw console.error("‚ùå [THUMBNAILS] Error guardando thumbnails:",m),m}},hn=async(o,n,s,m,i,b,N=!1)=>{try{if(!(n!=null&&n.id))throw new Error("No se encontr√≥ el ID del proyecto");console.log(`üíæ [SAVE] Iniciando ${N?"auto-guardado":"guardado manual"}...`);let k=o;N||(k=await nr(o,n.id));const E={pages:k,projectInfo:{id:n.id,item_id:s==null?void 0:s.id,title:s==null?void 0:s.title,preset_id:m==null?void 0:m.id},workspace:{width:i.width,height:i.height,scale:i.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:N,totalPages:o.length}},w=N?"save-progress":"save",_=await fetch(`/api/canvas/projects/${n.id}/${w}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:E,thumbnails:b})});if(!_.ok){const v=await _.json().catch(()=>({}));throw new Error(v.message||"Error al guardar el proyecto")}const I=await _.json();if(console.log(`‚úÖ [SAVE] ${N?"Auto-guardado":"Guardado"} exitoso:`,I),!N&&b&&Object.keys(b).length>0){console.log("üñºÔ∏è [SAVE] Guardando thumbnails como archivos...");try{await ar(n.id,b),console.log("‚úÖ [SAVE] Thumbnails guardados como archivos")}catch(v){console.warn("‚ö†Ô∏è [SAVE] Error guardando thumbnails como archivos:",v)}}return{success:!0,data:I}}catch(k){return console.error(`‚ùå [SAVE] Error en ${N?"auto-guardado":"guardado"}:`,k),{success:!1,error:k.message}}},rr=(o,n,s,m,i,b)=>{const[N,k]=f.useState("saved"),[E,w]=f.useState(null),[_,I]=f.useState(null),[v,T]=f.useState(null),[j,$]=f.useState(!1),[R,H]=f.useState(navigator.onLine),L=f.useRef(null),O=f.useRef(null),U=f.useRef(null),K=f.useRef(!1),G=f.useRef(null),ne=15e3,ue=2e3,ye=5e3,u=f.useCallback((B,Z)=>{try{const D={pages:B.map(le=>{var J;return{id:le.id,layout:le.layout,cells:((J=le.cells)==null?void 0:J.map(pe=>{var Se;return{id:pe.id,elements:((Se=pe.elements)==null?void 0:Se.map(ve=>{var Te;return{id:ve.id,type:ve.type,content:ve.type==="image"&&((Te=ve.content)!=null&&Te.startsWith("data:image/"))?`[IMAGE_${ve.content.length}]`:ve.content,position:ve.position,size:ve.size,style:ve.style,filters:ve.filters,rotation:ve.rotation}}))||[]}}))||[]}})||[],workspace:{width:Z==null?void 0:Z.width,height:Z==null?void 0:Z.height}};return btoa(JSON.stringify(D)).substring(0,32)}catch(D){return console.warn("‚ö†Ô∏è [AUTO-SAVE] Error generando hash:",D),Date.now().toString()}},[]),te=f.useCallback(()=>`album_editor_autosave_${(n==null?void 0:n.id)||"draft"}`,[n==null?void 0:n.id]),x=f.useCallback(B=>{try{const Z=te(),D={...B,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(Z,JSON.stringify(D)),console.log("üíæ [AUTO-SAVE] Guardado en localStorage"),!0}catch(Z){return console.error("‚ùå [AUTO-SAVE] Error guardando en localStorage:",Z),!1}},[te]),X=f.useCallback(()=>{var B;try{const Z=te(),D=localStorage.getItem(Z);if(D){const le=JSON.parse(D);return console.log("üìÇ [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(B=le.pages)==null?void 0:B.length,savedAt:new Date(le.savedAt).toLocaleString()}),le}}catch(Z){console.error("‚ùå [AUTO-SAVE] Error cargando desde localStorage:",Z)}return null},[te]),ie=f.useCallback(async(B=!1)=>{if(K.current&&!B){console.log("‚è≥ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(n!=null&&n.id)||!o||o.length===0){console.log("‚ö†Ô∏è [AUTO-SAVE] Datos insuficientes para guardar");return}const Z=u(o,i);if(!B&&Z===U.current){console.log("üìä [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{K.current=!0,k("saving"),T(null);const D={pages:o,projectInfo:{id:n.id,item_id:s==null?void 0:s.id,title:s==null?void 0:s.title,preset_id:m==null?void 0:m.id},workspace:i,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:Z}};if(x(D),R){const le=await hn(o,n,s,m,i,b,!0);if(le.success)U.current=Z,I(new Date),k("saved"),$(!1),console.log("‚úÖ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(le.error)}else console.log("ÔøΩ [AUTO-SAVE] Sin conexi√≥n, solo guardado en localStorage"),k("pending"),$(!0)}catch(D){console.error("‚ùå [AUTO-SAVE] Error:",D),T(D.message),k("error"),R&&(G.current=setTimeout(()=>{console.log("üîÑ [AUTO-SAVE] Reintentando guardado..."),ie(!0)},ye))}finally{K.current=!1}},[o,n,s,m,i,b,u,x,R]),Ee=f.useCallback(async()=>{try{k("saving");const B=await hn(o,n,s,m,i,b,!1);if(B.success){const Z=u(o,i);U.current=Z,w(new Date),k("saved"),$(!1),re.success("üíæ Proyecto guardado exitosamente"),console.log("‚úÖ [MANUAL-SAVE] Guardado manual exitoso")}else T(B.error),k("error"),re.error(`‚ùå Error al guardar: ${B.error}`);return B.success}catch(B){return console.error("‚ùå [MANUAL-SAVE] Error:",B),T(B.message),k("error"),re.error(`‚ùå Error inesperado: ${B.message}`),!1}},[o,n,s,m,i,b,u]);return f.useEffect(()=>{if(!(n!=null&&n.id)||!o||o.length===0)return;const B=u(o,i);return U.current&&B!==U.current?(console.log("üîÑ [AUTO-SAVE] Cambios detectados, programando guardado..."),$(!0),k("pending"),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>{ie()},ue)):U.current||(U.current=B),()=>{O.current&&clearTimeout(O.current)}},[o,i,n==null?void 0:n.id,u,ie]),f.useEffect(()=>{if(n!=null&&n.id)return L.current&&clearInterval(L.current),L.current=setInterval(()=>{j&&(console.log("‚è∞ [AUTO-SAVE] Auto-save peri√≥dico activado"),ie())},ne),()=>{L.current&&clearInterval(L.current)}},[n==null?void 0:n.id,j,ie]),f.useEffect(()=>{const B=()=>{console.log("üåê [AUTO-SAVE] Conexi√≥n restaurada"),H(!0),j&&setTimeout(()=>ie(!0),1e3)},Z=()=>{console.log("üì¥ [AUTO-SAVE] Conexi√≥n perdida"),H(!1)};return window.addEventListener("online",B),window.addEventListener("offline",Z),()=>{window.removeEventListener("online",B),window.removeEventListener("offline",Z)}},[j,ie]),f.useEffect(()=>{const B=Z=>{if(j){const D={pages:o,projectInfo:{id:n.id},workspace:i,meta:{savedAt:new Date().toISOString()}};return x(D),Z.preventDefault(),Z.returnValue="¬øEst√°s seguro de salir? Hay cambios sin guardar.","¬øEst√°s seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",B),()=>window.removeEventListener("beforeunload",B)},[j,o,n==null?void 0:n.id,i,x]),f.useEffect(()=>()=>{O.current&&clearTimeout(O.current),L.current&&clearInterval(L.current),G.current&&clearTimeout(G.current)},[]),f.useEffect(()=>{v&&(v.includes("max_allowed_packet")||v.includes("data_too_large")?re.error("‚ùå El proyecto es demasiado grande para guardar autom√°ticamente. Reduce el n√∫mero o tama√±o de im√°genes."):re.error(`‚ùå Error de auto-guardado: ${v}`))},[v]),{saveStatus:N,lastSaved:E,lastAutoSaved:_,saveError:v,hasUnsavedChanges:j,isOnline:R,saveManually:Ee,performAutoSave:()=>ie(!0),loadFromLocalStorage:X,getStorageKey:te,autoSaveInterval:ne,debounceDelay:ue}},sr=({saveStatus:o,lastSaved:n,lastAutoSaved:s,hasUnsavedChanges:m,isOnline:i,saveError:b,onManualSave:N,className:k=""})=>{const E=I=>{if(!I)return null;const T=new Date-I,j=Math.floor(T/(1e3*60)),$=Math.floor(T/1e3);if($<30)return"hace unos segundos";if(j<1)return`hace ${$}s`;if(j<60)return`hace ${j}m`;const R=Math.floor(j/60);return R<24?`hace ${R}h`:I.toLocaleDateString()},_=(()=>{if(!i)return{icon:e.jsx(an,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexi√≥n",detail:"Guardado local activo"};switch(o){case"saving":return{icon:e.jsx(ha,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(ma,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:s?`Auto-guardado ${E(s)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(ga,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:b||"Error desconocido"};case"pending":return{icon:e.jsx(ua,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:m?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(xn,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${k}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${_.bg} ${_.color}
                    hover:shadow-md
                `,onClick:()=>o!=="saving"&&(N==null?void 0:N()),children:[_.icon,e.jsx("span",{className:"text-sm font-medium",children:_.text}),e.jsx("div",{className:"flex items-center",children:i?e.jsx(Ia,{className:"w-3 h-3 text-green-500"}):e.jsx(an,{className:"w-3 h-3 text-orange-500"})})]}),o==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},ir=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const o=document.createElement("style");o.textContent=ir,document.head.appendChild(o)}function ut(o,n){let s;return function(...i){const b=()=>{clearTimeout(s),o(...i)};clearTimeout(s),s=setTimeout(b,n)}}const Pt=Lt.memo(({pageId:o,thumbnail:n,altText:s,type:m})=>{const[i,b]=f.useState(!1),[N,k]=f.useState(!1);if(n&&!N)return e.jsxs("div",{className:"relative w-full h-full",children:[!i&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:n,alt:s,className:`w-full h-full object-contain transition-opacity duration-200 ${i?"opacity-100":"opacity-0"}`,onLoad:()=>b(!0),onError:()=>k(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const E=m==="cover"||m==="final"?gt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((w,_)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},_))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(E,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(o,n)=>o.pageId===n.pageId&&o.thumbnail===n.thumbnail&&o.altText===n.altText&&o.type===n.type),lr=Lt.memo(({images:o,onImageSelect:n,isLoading:s})=>{const m=Lt.memo(({image:i})=>{const[b,N]=f.useState(!1),[k,E]=f.useState(!1),[w,_]=f.useState(!1),[{isDragging:I},v]=va(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:i.url},collect:H=>({isDragging:!!H.isDragging()}),end:()=>{setTimeout(()=>_(!1),100)}})),T=i.thumbnail_url||i.url,j=i.url,$=H=>{_(!0),setTimeout(()=>_(!1),500)},R=H=>{if(w||I)return H.preventDefault(),H.stopPropagation(),!1;n(j)};return e.jsxs("div",{ref:v,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${I?"opacity-50 scale-95":""}`,onMouseDown:$,onClick:R,children:[e.jsxs("div",{className:"aspect-square relative",children:[!b&&!k&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),k?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(He,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:T,alt:i.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${b?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>N(!0),onError:()=>E(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(mt,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:i.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),i.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return s?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((i,b)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},b))}):o.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(He,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay im√°genes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:o.map((i,b)=>e.jsx(m,{image:i},`${i.id||i.url}-${b}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[o.filter(i=>i.has_thumbnail).length," de ",o.length," im√°genes optimizadas"]})})]})});function gs(){var uo,go,mo,ho,po,fo,bo,xo,vo,wo,yo,Eo,Co,To,No,Ao,So,Io,jo,ko,Ro,Oo,_o,Po,Lo,Mo,$o,Fo,Uo,Bo,zo,Ho,Go,Vo,Do,Wo,qo,Ko,Qo,Yo,Jo;const[o,n]=f.useState(null),[s,m]=f.useState(null),[i,b]=f.useState(null),[N,k]=f.useState(null),[E,w]=f.useState(!0),[_,I]=f.useState(null),[v,T]=f.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[j,$]=f.useState(new Map),[R,H]=f.useState([]),[L,O]=f.useState(!1),U=f.useRef(R),K=f.useRef(j);f.useRef(null);const G=f.useRef(null),ne=f.useRef(null);f.useEffect(()=>{U.current=R},[R]),f.useEffect(()=>{K.current=j},[j]),f.useEffect(()=>{(async()=>{var a,r;try{const d=new URLSearchParams(window.location.search).get("project");if(!d){I("No se encontr√≥ el ID del proyecto en la URL"),w(!1);return}const g=await fetch(`/api/canvas/projects/${d}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!g.ok)throw new Error("Error al cargar el proyecto");const h=await g.json();console.log("üìä ===== DATOS DEL PROYECTO CARGADOS ====="),console.log("üîç PROJECT ID desde URL:",d),console.log("üîç PROJECT DATA completo:",h),console.log("üîç PROJECT DATA ID:",(r=h==null?void 0:h.project)==null?void 0:r.id),console.log("========================================"),n(h.project),m(h.item),b(h.canvasPreset),k(h.initialProject),w(!1)}catch(l){console.error("‚ùå Error cargando proyecto:",l),I(l.message),w(!1)}})()},[]);const[ue,ye]=f.useState(on.Local.get(`${nn.APP_CORRELATIVE}_cart`)??[]);f.useEffect(()=>{on.Local.set(`${nn.APP_CORRELATIVE}_cart`,ue)},[ue]);const[u,te]=f.useState([]),[x,X]=f.useState(0),[ie,Ee]=f.useState("preset"),[B,Z]=f.useState(null),[D,le]=f.useState(null),[J,pe]=f.useState("pages"),[Se,ve]=f.useState("basic"),[Te,We]=f.useState([JSON.stringify(u)]),[Ne,Fe]=f.useState(0),[$t,cr]=f.useState(!1),[dr,Ft]=f.useState(null),[ae,se]=f.useState({}),[ur,gr]=f.useState(!1),[je,Ue]=f.useState([]),[bt,Ut]=f.useState(!1),[tt,Rn]=f.useState(new Map),[qe,On]=f.useState(()=>new Map),[Ke,Bt]=f.useState(null),[zt,Ht]=f.useState(!1);f.useEffect(()=>{console.log("‚úÖ [FILTERS] Tab actual:",J)},[J]),f.useCallback((t,a="manual")=>{if(console.log(`üîÑ [ACTIVE_TAB] Cambiando de "${J}" a "${t}" - Raz√≥n: ${a}`),t==="filters"&&a!=="manual"){console.warn("üö® [ACTIVE_TAB] Cambio autom√°tico a filters bloqueado!");return}pe(t)},[J]),console.log("üéâ [FILTERS FIX] Editor cargado - Fix del problema de filtros ACTIVADO"),window.FORCE_THUMBNAIL_REGENERATION=!0,window.PREVENT_THUMBNAIL_RESET=!1,window._protectedThumbnailIds=[],window.THUMBNAIL_PROTECTED=!1,window.PRESERVE_FILTERS=!0,f.useEffect(()=>{window.forceRegenerateAllThumbnails=()=>{console.log("üí£ [EMERGENCIA-GLOBAL] Forzando regeneraci√≥n de TODOS los thumbnails"),window.thumbnailCache={},$(t=>{const a=new Map(t);return u.forEach((r,l)=>{a.set(l,Date.now())}),a}),console.log("1Ô∏è‚É£ Regenerando p√°gina actual"),ce(!0).then(()=>{console.log("‚úÖ Primera regeneraci√≥n completa"),window.BLOCK_AUTO_REGENERATION=!0,setTimeout(()=>{console.log("2Ô∏è‚É£ Ejecutando segunda regeneraci√≥n forzada"),window.forceRegenerateThumbnail&&window.forceRegenerateThumbnail(),window.THUMBNAIL_PROTECTED=!0,setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,console.log("üîì Regeneraci√≥n autom√°tica desbloqueada")},5e3)},200)}).catch(t=>{console.error("‚ùå Error en regeneraci√≥n de emergencia:",t)})},console.log("üì¢ Puedes forzar la regeneraci√≥n de thumbnails usando window.forceRegenerateAllThumbnails()")},[u]),f.useEffect(()=>{window._protectedThumbnails||(window._protectedThumbnails=new Set,console.log("üõ°Ô∏è [PROTECTION SYSTEM] Sistema de protecci√≥n de thumbnails inicializado")),window.protectThumbnail=t=>{window._protectedThumbnails.add(t),console.log(`üõ°Ô∏è [PROTECT] Thumbnail ${t} marcado como protegido`)},window.unprotectThumbnail=t=>{window._protectedThumbnails.delete(t),console.log(`üîì [UNPROTECT] Thumbnail ${t} desprotegido`)},window.isThumbnailProtected=t=>{var a;return((a=window._protectedThumbnails)==null?void 0:a.has(t))||!1},window.blockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!0,console.log("üö´ [BLOCK AUTO] Regeneraciones autom√°ticas BLOQUEADAS")},window.unblockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!1,console.log("‚úÖ [UNBLOCK AUTO] Regeneraciones autom√°ticas DESBLOQUEADAS")},window.isAutoRegenerationBlocked=()=>window._blockAutoRegeneration||!1,window._thumbnailWatchdog||(window._thumbnailWatchdog=setInterval(()=>{window._protectedThumbnailData&&window._protectedThumbnails&&Array.from(window._protectedThumbnails).forEach(a=>{const r=window._protectedThumbnailData[a];r&&se(l=>l[a]&&l[a]!==r?(console.error(`üö® [WATCHDOG] ¬°SOBRESCRITURA DETECTADA! Restaurando ${a}`),{...l,[a]:r}):l)})},100),console.log("üö® [WATCHDOG] Vigilante de thumbnails activado")),window._interceptorInstalled||(window._interceptorInstalled=!0,console.log("üîí [GLOBAL INTERCEPTOR] Interceptor global de setPageThumbnails instalado"))},[]);const[ot,Qe]=f.useState(!1),Gt=f.useRef(),[V,Vt]=f.useState({width:800,height:600}),_n=f.useCallback((t,a,r="unknown")=>{var l;return(l=window.isThumbnailProtected)!=null&&l.call(window,t)?(console.error(`ÔøΩ [PROTECTION BLOCK] ¬°BLOQUEADO! Intento de sobrescribir thumbnail protegido ${t} desde: ${r}`),console.error("üö® [PROTECTION BLOCK] Stack trace:",new Error().stack),!1):(se(d=>{const g=d[t];return console.log(g&&g!==a?`üîÑ [THUMBNAIL UPDATE] Actualizando thumbnail ${t} desde: ${r}`:`‚úÖ [THUMBNAIL SET] Estableciendo thumbnail ${t} desde: ${r}`),{...d,[t]:a}}),!0)},[]),Dt=f.useMemo(()=>Za({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¬°Bienvenido al Editor de BananaLab! üçå",description:"Este es tu lienzo de trabajo donde crear√°s dise√±os incre√≠bles. Aqu√≠ puedes ver y editar la p√°gina actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"üéØ Navegaci√≥n Principal",description:"En la barra lateral izquierda encontrar√°s todas las herramientas organizadas por categor√≠as. Cada √≠cono te lleva a una secci√≥n espec√≠fica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"üìÑ Secci√≥n P√°ginas",description:"Gestiona todas las p√°ginas de tu proyecto: portada, p√°ginas de contenido y contraportada. Haz clic en cualquier p√°gina para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"üé® Secci√≥n Dise√±os",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu p√°gina. Cada dise√±o tiene una distribuci√≥n √∫nica.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"üìö Secci√≥n Capas",description:"Organiza y controla la superposici√≥n de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posici√≥n.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"‚úçÔ∏è Secci√≥n Textos",description:"Agrega y personaliza textos: t√≠tulos, subt√≠tulos y p√°rrafos. Cambia fuentes, colores, tama√±os y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"üé≠ Secci√≥n Filtros",description:"Aplica efectos visuales a tus im√°genes: brillo, contraste, saturaci√≥n, m√°scaras y m√°s filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"‚ö° Acciones R√°pidas",description:"Herramientas de acceso r√°pido: cambiar dise√±o de p√°gina, gestionar capas, agregar im√°genes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"üíæ Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso autom√°ticamente y acceder a la vista previa de tu √°lbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"üëÅÔ∏è Vista de √Ålbum",description:"Visualiza tu proyecto completo como un √°lbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"üéâ ¬°Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una p√°gina y agregando elementos. ¬°Divi√©rtete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente ‚Üí",prevBtnText:"‚Üê Anterior",doneBtnText:"¬°Empezar a crear! üöÄ",closeBtnText:"‚úï",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(t,a)=>{var l,d;console.log("üéØ Mostrando paso:",(l=a.popover)==null?void 0:l.title);const r=(d=t==null?void 0:t.getAttribute)==null?void 0:d.call(t,"data-tab");r&&J!==r&&pe(r)},onDeselected:()=>{console.log("‚úÖ Gu√≠a completada"),re.success("¬°Gu√≠a completada! Ya puedes empezar a crear tu dise√±o.",{duration:3e3})}}),[J,pe]),Pn=f.useCallback(()=>{console.log("üöÄ Iniciando tour guiado"),Dt.drive()},[Dt]),xt=f.useCallback(async()=>{if(o!=null&&o.id)try{const t=await fetch(`/api/thumbnails/${o.id}`);if(t.ok){const a=await t.json();if(a.success&&a.thumbnails&&a.thumbnails.length>0){const r={};a.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(r[l.page_id]=l.thumbnail_url)}),Object.keys(r).length>0?(se(l=>{var g;console.warn("üö® [STORAGE LOAD] ¬°ALERTA! Cargando thumbnails desde storage - POSIBLE CULPABLE DE SOBRESCRITURA"),console.warn("üö® [STORAGE LOAD] Thumbnails protegidos:",Array.from(window._protectedThumbnails||[])),console.warn("üö® [STORAGE LOAD] Stack trace:",new Error().stack);const d={};for(const[h,c]of Object.entries(r))(g=window.isThumbnailProtected)!=null&&g.call(window,h)?console.warn(`üõ°Ô∏è [STORAGE PROTECTION] NO sobrescribiendo thumbnail protegido: ${h}`):d[h]=c;return{...l,...d}}),console.log("‚úÖ Thumbnails cargados desde storage:",Object.keys(r).length)):console.log("‚ÑπÔ∏è No hay thumbnails guardados, usando generaci√≥n local")}else console.log("‚ÑπÔ∏è No hay thumbnails guardados para este proyecto")}}catch(t){console.warn("‚ö†Ô∏è Error cargando thumbnails guardados (usando locales):",t)}},[o==null?void 0:o.id]),nt=f.useRef(new Map),Ve=f.useRef(new Map),Wt=f.useMemo(()=>JSON.stringify(V),[V]),ce=f.useCallback(async(t=!1)=>{var g,h,c,p,C,M;if(window.BLOCK_AUTO_REGENERATION&&!t){console.log("üõ°Ô∏è [PROTECCI√ìN TEMPORAL] Bloqueando regeneraci√≥n mientras se completa otra operaci√≥n");return}const a=u[x];if(!a||!V)return;const r=a.id;if(!t){nt.current.has(r)&&clearTimeout(nt.current.get(r));const A=setTimeout(()=>{nt.current.delete(r),ce(!0)},300);nt.current.set(r,A);return}const l=`${r}-${Wt}`;if(!t&&Ve.current.has(l)){const A=Ve.current.get(l);if(A&&Date.now()-A.timestamp<6e4){console.log(`‚ö° [CACHE HIT] Usando thumbnail cacheado para ${r}`),se(y=>({...y,[r]:A.data}));return}}let d=!1;if(a.cells&&a.cells.forEach(A=>{A.elements&&A.elements.forEach(y=>{y.filters&&(y.filters.brightness!==void 0&&y.filters.brightness!==100&&y.filters.brightness!==1||y.filters.contrast!==void 0&&y.filters.contrast!==100&&y.filters.contrast!==1||y.filters.saturation!==void 0&&y.filters.saturation!==100&&y.filters.saturation!==1||y.filters.tint!==void 0&&y.filters.tint!==0||y.filters.hue!==void 0&&y.filters.hue!==0||y.filters.blur!==void 0&&y.filters.blur>0||y.filters.opacity!==void 0&&y.filters.opacity!==100&&y.filters.opacity!==1||y.filters.scale!==void 0&&y.filters.scale!==1||y.filters.rotate!==void 0&&y.filters.rotate!==0||y.filters.flipHorizontal||y.filters.flipVertical)&&(d=!0,y._hasRealFilters=!0)})}),!t&&!d&&ae[r]){const A=((g=window._thumbnailGenTimes)==null?void 0:g[r])||0;if(Date.now()-A<3e5){console.log(`‚úÖ Thumbnail reciente existe para p√°gina sin filtros: ${r}`);return}}if(ke.current){console.log("‚è≥ Ya se est√° generando un thumbnail...");return}ke.current=!0;try{console.log(`üöÄ [RADICAL GENERATOR] Generando thumbnail para p√°gina: ${r} (filtros: ${d})`),window._currentPageData=a,window._workspaceDimensions=V,window._updateThumbnailInUI=(y,S)=>{var P;if((P=window.isThumbnailProtected)!=null&&P.call(window,y)){console.error(`üö® [UPDATE BLOCKED] ¬°BLOQUEADO! Intento de actualizar thumbnail protegido ${y} via _updateThumbnailInUI`),console.error("üö® [UPDATE BLOCKED] Stack trace:",new Error().stack);return}se(F=>(console.log(`üîÑ [UPDATE UI] Actualizando thumbnail ${y} via _updateThumbnailInUI`),{...F,[y]:S}))},window._thumbnailGenTimes||(window._thumbnailGenTimes={}),window._thumbnailGenTimes[r]=Date.now();let A=null;if(d||t){console.log("üî• [M√âTODO RADICAL] Usando sistema de filtros garantizados"),console.log("üì¶ [DATOS ENVIADOS] currentPageData antes de enviar a forceFilterRenderer:",{pageId:a.id,elementsCount:((h=a.elements)==null?void 0:h.length)||0,elementsWithFilters:((p=(c=a.elements)==null?void 0:c.filter(y=>y.filters&&(y.filters.brightness!==void 0&&y.filters.brightness!==1||y.filters.contrast!==void 0&&y.filters.contrast!==1||y.filters.saturation!==void 0&&y.filters.saturation!==1||y.filters.tint!==void 0&&y.filters.tint!==0||y.filters.hue!==void 0&&y.filters.hue!==0||y.filters.opacity!==void 0&&y.filters.opacity!==1||y.filters.blur!==void 0&&y.filters.blur!==0||y.filters.scale!==void 0&&y.filters.scale!==1||y.filters.rotate!==void 0&&y.filters.rotate!==0||y.filters.flipHorizontal||y.filters.flipVertical)))==null?void 0:p.map(y=>({id:y.id,filters:y.filters})))||[]});try{A=await kt(a,V),console.log("‚úÖ [M√âTODO RADICAL] Thumbnail generado con filtros garantizados")}catch(y){console.error("‚ùå [M√âTODO RADICAL] Error, usando fallback:",y),A=await gn({page:a,workspaceDimensions:V,preserveFilters:!0})}}else console.log("üì∏ [M√âTODO NORMAL] Generando thumbnail sin filtros especiales"),A=await gn({page:a,workspaceDimensions:V,preserveFilters:!1});if(A){if(d){(C=window.protectThumbnail)==null||C.call(window,r),(M=window.blockAutomaticRegeneration)==null||M.call(window),console.log(`üõ°Ô∏è [FILTER PROTECTION] Thumbnail ${r} protegido porque tiene filtros aplicados`),console.log("üö´ [AUTO BLOCK] Regeneraciones autom√°ticas BLOQUEADAS para preservar filtros"),se(P=>(console.log(`üî• [FORCE SET] Estableciendo thumbnail con filtros para ${r} (PROTEGIDO)`),{...P,[r]:A})),setTimeout(()=>{se(P=>P[r]!==A?(console.warn(`üö® [PROTECTION RESTORE] Restaurando thumbnail protegido para ${r}`),{...P,[r]:A}):P)},100);const S=()=>{se(P=>P[r]!==A?(console.error(`üö® [EMERGENCY RESTORE] ¬°PARPADEO DETECTADO! Restaurando thumbnail para ${r}`),{...P,[r]:A}):P)};setTimeout(S,200),setTimeout(S,500),setTimeout(S,1e3),setTimeout(S,2e3),window._protectedThumbnailData||(window._protectedThumbnailData={}),window._protectedThumbnailData[r]=A}else _n(r,A,"generateCurrentPageThumbnail");console.log(`‚úÖ [SUCCESS] Thumbnail generado exitosamente para p√°gina: ${r}`),d&&!t&&(console.log("üîç [VERIFICACI√ìN] Comprobando si los filtros se aplicaron correctamente..."),window._filterVerificationDone||(window._filterVerificationDone=new Set),window._filterVerificationDone.has(r)||(window._filterVerificationDone.add(r),setTimeout(async()=>{var S,P,F;try{console.log("üöÄ [√öLTIMO RECURSO] Intentando m√©todo radical para garantizar filtros..."),console.log("üì¶ [√öLTIMO RECURSO - DATOS] currentPageData:",{pageId:a.id,elementsWithFilters:((P=(S=a.elements)==null?void 0:S.filter(Y=>Y.filters&&Object.keys(Y.filters).some(q=>q==="flipHorizontal"||q==="flipVertical"?Y.filters[q]:q==="brightness"||q==="contrast"||q==="saturation"||q==="opacity"||q==="scale"?Y.filters[q]!==1:q==="tint"||q==="hue"||q==="blur"||q==="rotate"?Y.filters[q]!==0:!1)))==null?void 0:P.map(Y=>({id:Y.id,filters:Y.filters})))||[]});const Q=await kt(a,V);Q&&((F=window.protectThumbnail)==null||F.call(window,r),se(Y=>(console.log(`üöÄ [RADICAL FORCE] Estableciendo thumbnail radical protegido para ${r}`),{...Y,[r]:Q})),console.log("‚úÖ [RADICAL SUCCESS] Filtros garantizados aplicados exitosamente"))}catch(Q){console.warn("‚ö†Ô∏è [RADICAL FALLBACK] Error en m√©todo radical:",Q)}},1e3))),d&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(r)||window._protectedThumbnailIds.push(r));const y=`${r}-${Wt}`;if(Ve.current.set(y,{data:A,timestamp:Date.now(),hasFilters:d}),Ve.current.size>50){const S=Ve.current.keys().next().value;Ve.current.delete(S)}}else console.error(`‚ùå [ERROR] No se pudo generar thumbnail para p√°gina: ${r}`)}catch(A){console.error(`‚ùå [CRITICAL ERROR] Error generando thumbnail para p√°gina ${r}:`,A)}finally{ke.current=!1}},[u,x,V,ae]),vt=f.useCallback(ut(async()=>{var t;if(window.BLOCK_AUTO_REGENERATION){console.log("üõ°Ô∏è [PROTECCI√ìN-GLOBAL] Bloqueando generaci√≥n masiva mientras los filtros est√°n protegidos");return}if(window.THUMBNAIL_PROTECTED){console.log("üîí [PROTECCI√ìN-GLOBAL] Generaci√≥n masiva bloqueada, thumbnails protegidos");return}if(!(!(u!=null&&u.length)||!V)){if(ke.current){console.log("‚è≥ Thumbnails ya se est√°n generando, saltando...");return}ke.current=!0;try{const a=u.filter(l=>!ae[l.id]);if(a.length===0){console.log("‚úÖ Todos los thumbnails ya existen");return}if(console.log(`üì∏ Generando ${a.length} thumbnails r√°pidos...`),(t=window.isAutoRegenerationBlocked)!=null&&t.call(window)){console.warn("üö´ [BLOCKED] Regeneraci√≥n autom√°tica bloqueada, saltando generateFastThumbnails");return}const r=await mn({pages:a,workspaceDimensions:V,onProgress:l=>{Bt(l)}});r&&Object.keys(r).length>0&&(se(l=>{var g;console.warn("üö® [FAST THUMBNAILS] ¬°ALERTA! generateFastThumbnails sobrescribiendo thumbnails - POSIBLE CULPABLE"),console.warn("üö® [FAST THUMBNAILS] Stack trace:",new Error().stack);const d={};for(const[h,c]of Object.entries(r))(g=window.isThumbnailProtected)!=null&&g.call(window,h)?console.warn(`üõ°Ô∏è [FAST PROTECTION] NO sobrescribiendo thumbnail protegido: ${h}`):d[h]=c;return{...l,...d}}),console.log("‚úÖ Thumbnails r√°pidos generados:",Object.keys(r).length))}catch(a){console.warn("‚ö†Ô∏è Error generando thumbnails r√°pidos:",a)}finally{ke.current=!1,Bt(null)}}},300),[u,V,ae]),ke=f.useRef(!1);f.useCallback(async(t=[])=>{var a;if(!ke.current)try{if(ke.current=!0,t.length>0){const r=u.filter(l=>t.includes(l.id));if(r.length>0)if(console.log(`üéØ Generando ${r.length} thumbnails prioritarios...`),(a=window.isAutoRegenerationBlocked)!=null&&a.call(window))console.warn("üö´ [BLOCKED] Regeneraci√≥n de prioridad bloqueada, saltando generateFastThumbnails");else{const l=await mn({pages:r,workspaceDimensions:V});l&&Object.keys(l).length>0&&se(d=>{var h;console.warn("üö® [PRIORITY THUMBNAILS] ¬°ALERTA! generateFastThumbnails de prioridad sobrescribiendo - POSIBLE CULPABLE"),console.warn("üö® [PRIORITY THUMBNAILS] Stack trace:",new Error().stack);const g={};for(const[c,p]of Object.entries(l))(h=window.isThumbnailProtected)!=null&&h.call(window,c)?console.warn(`üõ°Ô∏è [PRIORITY PROTECTION] NO sobrescribiendo thumbnail protegido: ${c}`):g[c]=p;return{...d,...g}})}}}catch(r){console.warn("‚ö†Ô∏è Error en generaci√≥n prioritaria:",r)}finally{ke.current=!1}},[u,V,vt]);const qt=f.useCallback(t=>{if(qe.has&&qe.has(t))return;const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{if(a.width>1200||a.height>1200){const l=document.createElement("canvas"),d=l.getContext("2d"),g=1200,h=Math.min(g/a.width,g/a.height),c=a.width*h,p=a.height*h;l.width=c,l.height=p,d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.drawImage(a,0,0,c,p),l.toBlob(C=>{if(C){const M=URL.createObjectURL(C);On(A=>{const y=new Map(A);if(y.set(t,M),y.size>15){const S=y.keys().next().value,P=y.get(S);URL.revokeObjectURL(P),y.delete(S)}return y})}},"image/webp",.85)}},a.onerror=()=>{console.warn("‚ùå Error pre-cargando imagen:",t)},a.src=t},[]);f.useEffect(()=>{je.length>0&&je.slice(0,10).forEach((a,r)=>{setTimeout(()=>{qt(a.url)},r*100)})},[je,qt]),f.useEffect(()=>()=>{qe&&qe.forEach&&qe.forEach(t=>URL.revokeObjectURL(t))},[]),f.useEffect(()=>()=>{_t()},[]);const Kt=f.useCallback(async()=>{var t;if(!(!(o!=null&&o.id)||!(u!=null&&u.length))){if(zt){console.log("‚è≥ Ya hay una carga de thumbnails en progreso, omitiendo...");return}try{Ht(!0),console.log("üîÑ Iniciando carga de thumbnails existentes...");const a=await fetch(`/api/thumbnails/${o.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:u})});if(a.ok){const r=await a.json();r&&Object.keys(r).length>0?(se(l=>({...l,...r})),console.log("‚úÖ Thumbnails existentes cargados:",Object.keys(r).length)):(console.log("üì∏ No hay thumbnails existentes, generando para p√°gina actual..."),setTimeout(()=>ce(),200))}}catch(a){console.warn("‚ö†Ô∏è Error cargando thumbnails existentes:",a),setTimeout(()=>ce(),200)}finally{Ht(!1)}}},[o==null?void 0:o.id,u,ce,zt]);f.useCallback(async()=>{if(!(!(o!=null&&o.id)||!(u!=null&&u.length)))try{const t=u[x];if(!t)return;const a=await fetch(`/api/thumbnails/${o.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:V.width,height:V.height,quality:95,scale:4,dpi:300})});if(a.ok){const r=await a.json();if(r.success&&r.thumbnails){const l={};r.thumbnails.forEach(d=>{d.page_id&&d.thumbnail_url&&(l[d.page_id]=d.thumbnail_url)}),se(d=>({...d,...l})),console.log("‚úÖ Thumbnail generado y guardado en storage para p√°gina actual:",r.thumbnails.length)}}}catch(t){console.warn("‚ö†Ô∏è Error generando thumbnail:",t)}},[o==null?void 0:o.id,u,x,V]),f.useCallback(async()=>{if(!(!(o!=null&&o.id)||!(u!=null&&u.length)))try{const t=await fetch(`/api/thumbnails/${o.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:u,width:V.width,height:V.height,quality:95,scale:4,dpi:300})});if(t.ok){const a=await t.json();if(a.success&&a.thumbnails){const r={};a.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(r[l.page_id]=l.thumbnail_url)}),se(l=>({...l,...r})),console.log("‚úÖ Todos los thumbnails generados y guardados en storage:",a.thumbnails.length)}}}catch(t){console.warn("‚ö†Ô∏è Error generando todos los thumbnails:",t)}},[o==null?void 0:o.id,u,V]);const Ln=f.useCallback(async(t=null)=>{if(!(o!=null&&o.id)||!(u!=null&&u.length))return{};try{console.log("üìñ [ALBUM-MODAL] Cargando thumbnails PDF existentes...");const a={},r={};let l=0;const d=async(h,c)=>new Promise(p=>{const C=new Image;C.onload=()=>{r[c]=h,l++,t==null||t(l,u.length),p(!0)},C.onerror=()=>{console.warn(`‚ö†Ô∏è [ALBUM-MODAL] Thumbnail no encontrado: ${h}`),l++,t==null||t(l,u.length),p(!1)},C.src=h}),g=u.map(async(h,c)=>{let p;const C=s&&(s.has_cover_image===!0||s.has_cover_image===1),M=s&&(s.has_back_cover_image===!0||s.has_back_cover_image===1),A=C&&u.some(F=>F.type==="cover"),y=M&&u.some(F=>F.type==="final");if(h.type==="cover")p=0;else if(h.type==="content")A?p=u.filter(Y=>Y.type==="content").findIndex(Y=>Y.id===h.id)+1:p=u.filter(Y=>Y.type==="content").findIndex(Y=>Y.id===h.id)+1;else if(h.type==="final"){const F=u.filter(Y=>Y.type==="content");p=F.length+1}else p=c;const S=`/storage/images/thumbnails/${o.id}/page-${p}-pdf.png`,P=h.id||`page-${c}`;return a[P]=S,console.log(`üîç [THUMBNAIL-MAP] P√°gina ${c}:`,{tipo:h.type,pageNumber:h.pageNumber,realPageNumber:p,url:S,pageId:h.id,hasCover:A,hasBackCover:y,coverEnabled:C,backCoverEnabled:M}),d(S,P)});return await Promise.all(g),console.log(`‚úÖ [ALBUM-MODAL] Thumbnails verificados: ${Object.keys(r).length}/${u.length}`),a}catch(a){return console.warn("‚ö†Ô∏è [ALBUM-MODAL] Error cargando thumbnails PDF:",a),{}}},[o==null?void 0:o.id,u,s]);f.useEffect(()=>{if(N&&s&&i){if(N.pages&&Array.isArray(N.pages)){const t=N.pages.map(a=>{let r=null,l=i.background_color||"#ffffff";return a.type==="cover"&&(s.has_cover_image===!0||s.has_cover_image===1)?s.cover_image&&(r=`/storage/images/item/${s.cover_image}`):a.type==="content"?s.content_image&&(r=`/storage/images/item/${s.content_image}`):(a.type==="final"||a.type==="contraportada")&&(s.has_back_cover_image===!0||s.has_back_cover_image===1)&&s.back_cover_image&&(r=`/storage/images/item/${s.back_cover_image}`),{...a,backgroundImage:r,backgroundColor:l}}).filter(a=>!(a.type==="cover"&&(s.has_cover_image===!1||s.has_cover_image===0)||(a.type==="final"||a.type==="contraportada")&&(s.has_back_cover_image===!1||s.has_back_cover_image===0)));te(a=>a.length>0?(console.log("‚ö†Ô∏è P√°ginas ya existentes, preservando cambios del usuario"),a.map((r,l)=>{const d=t[l];return d?{...r,backgroundImage:r.backgroundImage||d.backgroundImage,backgroundColor:r.backgroundColor||d.backgroundColor}:r})):(console.log("üìÑ Carga inicial de p√°ginas desde la base de datos"),t)),We(a=>a.length<=1?[JSON.stringify(t)]:a),Fe(a=>a===0&&Te.length<=1?0:a),setTimeout(()=>{xt()},100)}else{const t=ao(i,s);te(t),We([JSON.stringify(t)]),Fe(0),setTimeout(()=>{xt()},100)}typeof N.currentPage=="number"&&X(N.currentPage),N.workspaceSize&&Ee(N.workspaceSize)}},[N,s,i,xt]);const Re=rr(u,o,s,i,V,ae),Qt=()=>{if(i!=null&&i.width&&(i!=null&&i.height)){let c=i.width,p=i.height,C=c*37.8,M=p*37.8;if(C&&M){const A=window.innerWidth*.6,y=window.innerHeight*.7,S=A/C,P=y/M,F=Math.min(S,P,1);return{width:Math.round(C*F),height:Math.round(M*F),originalWidth:c,originalHeight:p,scale:F,unit:"cm",originalWidthPx:Math.round(C),originalHeightPx:Math.round(M)}}}if(i!=null&&i.extra_settings)try{const c=typeof i.extra_settings=="string"?JSON.parse(i.extra_settings):i.extra_settings;if(c!=null&&c.canvas_config){const p=c.canvas_config;let C=p.width,M=p.height,A=C*37.8,y=M*37.8;if(A&&y){const S=window.innerWidth*.6,P=window.innerHeight*.7,F=S/A,Q=P/y,Y=Math.min(F,Q,1);return{width:Math.round(A*Y),height:Math.round(y*Y),originalWidth:C,originalHeight:M,scale:Y,unit:"cm",originalWidthPx:Math.round(A),originalHeightPx:Math.round(y)}}}}catch(c){console.warn("Error parsing extra_settings:",c)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},a=t[ie]||t.preset,r=window.innerWidth*.6,l=window.innerHeight*.7,d=r/a.width,g=l/a.height,h=Math.min(d,g,1);return{width:Math.round(a.width*h),height:Math.round(a.height*h),originalWidth:a.width,originalHeight:a.height,scale:h,unit:"px"}},Oe=f.useCallback(async(t={type:"thumbnail"})=>{if(!u[x])return null;try{let a=document.querySelector(`#page-${u[x].id}`);if(!a)return console.warn("‚ùå THUMBNAIL: No se encontr√≥ el elemento de p√°gina espec√≠fico"),null;const r=u[x],l=t.type==="pdf",d=l?11.81:3,g=1,h=getComputedStyle(a);let c=(r==null?void 0:r.backgroundColor)||"#ffffff";h.backgroundColor&&h.backgroundColor!=="rgba(0, 0, 0, 0)"&&(c=h.backgroundColor);const p={scale:d,useCORS:!0,allowTaint:!1,backgroundColor:c,width:V.width,height:V.height,x:0,y:0,ignoreElements:A=>{var y;return A.style&&A.style.filter&&t.preserveFilters?(console.log("üé≠ [PRESERVE-FILTER] Preservando elemento con filtro:",A.id),!1):(y=A.classList)==null?void 0:y.contains("exclude-from-capture")},scrollX:0,scrollY:0,foreignObjectRendering:!!l,removeContainer:!1,logging:!1,imageTimeout:l?6e4:15e3,pixelRatio:l?3:window.devicePixelRatio||1,canvas:l?document.createElement("canvas"):null,windowWidth:l?V.width*d:null,windowHeight:l?V.height*d:null,onclone:async A=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(S=>{try{A.querySelectorAll(S).forEach(F=>F.remove())}catch(P){console.warn("Error removing selector:",S,P)}});try{const S=A.querySelector(`#page-${u[x].id}`);S&&(S.style.width=V.width+"px",S.style.height=V.height+"px",S.style.position="relative",S.style.overflow="hidden",r!=null&&r.backgroundImage&&(S.style.backgroundImage=`url(${r.backgroundImage})`,S.style.backgroundSize="cover",S.style.backgroundPosition="center",S.style.backgroundRepeat="no-repeat"),S.querySelectorAll('[style*="filter"]').forEach(F=>{console.log("üé≠ [THUMBNAIL] Preservando filtros en elemento:",F.id)}),r!=null&&r.backgroundColor&&(S.style.backgroundColor=r.backgroundColor))}catch(S){console.error("‚ùå [THUMBNAIL-FIX] Error configurando elemento de p√°gina:",S)}try{const S=new Map;a.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((ee,_e)=>{if(ee.complete&&ee.naturalWidth>0){const xe=(ee.closest('[data-element-type="image"]')||ee.parentElement).getBoundingClientRect(),Ie=ee.getBoundingClientRect();S.set(ee.src,{src:ee.src,naturalWidth:ee.naturalWidth,naturalHeight:ee.naturalHeight,containerWidth:xe.width,containerHeight:xe.height,objectFit:getComputedStyle(ee).objectFit||"cover",objectPosition:getComputedStyle(ee).objectPosition||"center",crossOrigin:ee.crossOrigin})}});const F=async(ee,_e,be,xe,Ie)=>new Promise(Be=>{try{const ze=_e/be,At=xe/Ie;let rt,st,St,It,Xo,Zo;At>ze?(Zo=be,Xo=be*At,st=Ie,rt=Ie*ze,St=(xe-rt)/2,It=0):(Xo=_e,Zo=_e/At,rt=xe,st=xe/ze,St=0,It=(Ie-st)/2);const it=A.createElement("canvas");it.width=_e,it.height=be;const Xn=it.getContext("2d"),Ze=new Image;Ze.crossOrigin="anonymous",Ze.onload=()=>{try{Xn.drawImage(Ze,St,It,rt,st,0,0,_e,be);const jt=it.toDataURL("image/png",1);ee.src=jt,ee.style.objectFit="fill",ee.style.objectPosition="center",ee.style.width="100%",ee.style.height="100%",Be()}catch(jt){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en canvas processing:",jt),Be()}},Ze.onerror=()=>{console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),Be()},Ze.src=ee.src}catch(ze){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",ze),Be()}}),Q=A.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),Y=[];Q.forEach((ee,_e)=>{if(ee.src&&S.has(ee.src)){const be=S.get(ee.src),xe=ee.closest('[data-element-type="image"]')||ee.parentElement;if(xe&&(xe.style.overflow="hidden",xe.style.position="relative"),be.objectFit==="cover"||ee.classList.contains("object-cover")||ee.classList.contains("workspace-image")){const Ie=F(ee,be.containerWidth,be.containerHeight,be.naturalWidth,be.naturalHeight);Y.push(Ie)}else ee.style.width="100%",ee.style.height="100%",ee.style.objectFit="fill"}}),Y.length>0&&await Promise.all(Y);const q=A.createElement("style");q.textContent=`
                            /* CORRECCI√ìN THUMBNAIL: Estructura del elemento de p√°gina */
                            #page-${u[x].id} {
                                width: ${V.width}px !important;
                                height: ${V.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* üñ®Ô∏è IM√ÅGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya est√°n recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${l?`
                                /* üñ®Ô∏è IMPRESI√ìN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de p√°gina */
                            #page-${u[x].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* üñ®Ô∏è OPTIMIZACIONES GENERALES PARA PDF DE IMPRESI√ìN */
                            ${l?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,A.head.appendChild(q)}catch(S){console.error("‚ùå [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",S);const P=A.createElement("style");P.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,A.head.appendChild(P)}}},C=await tn(a,p);if(l&&C){const A=C.getContext("2d");if(A){A.imageSmoothingEnabled=!1,A.imageSmoothingQuality="high";const y=A.getImageData(0,0,C.width,C.height),S=y.data;for(let P=0;P<S.length;P+=4)S[P]=Math.min(255,S[P]*1.05),S[P+1]=Math.min(255,S[P+1]*1.05),S[P+2]=Math.min(255,S[P+2]*1.05);A.putImageData(y,0,0)}}if(!C)throw new Error("html2canvas no devolvi√≥ un canvas v√°lido para el elemento de p√°gina");if(C.width===0||C.height===0)throw new Error("Canvas del elemento de p√°gina tiene dimensiones inv√°lidas");const M=C.toDataURL("image/png",g);if(!M||M==="data:,")throw new Error("No se pudo generar dataURL del elemento de p√°gina");return l?C:M}catch(a){console.error("‚ùå [THUMBNAIL-FIX] Error capturando elemento de p√°gina:",a);try{const r=document.createElement("canvas"),l=t.type==="pdf"?11.81:1;r.width=V.width*l,r.height=V.height*l;const d=r.getContext("2d"),g=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return d.fillStyle=g,d.fillRect(0,0,r.width,r.height),d.fillStyle=g==="#ffffff"||g.includes("white")?"#374151":"#666666",d.font=`${14*l}px Arial`,d.textAlign="center",d.fillText("P√°gina "+(x+1),r.width/2,r.height/2),t.type==="pdf"?r:r.toDataURL("image/png",1)}catch{return null}}},[x,u]);f.useCallback(async()=>{if(!u[x])return;const t=await Oe({type:"thumbnail"});t&&se(a=>({...a,[u[x].id]:t}))},[Oe,x,u]),f.useCallback(()=>{clearTimeout(Gt.current),Gt.current=setTimeout(()=>{u[x]&&(se(t=>{const a={...t};return delete a[u[x].id],a}),setTimeout(()=>{ce()},200))},1e3)},[u,x,ce]);const Mn=f.useCallback(()=>{u[x]&&(se(t=>{const a={...t};return delete a[u[x].id],a}),setTimeout(()=>{ce()},300))},[u,x,ce]),$n=f.useCallback(async(t=x,a={width:800,height:600})=>{var r,l;if(!u[t])return null;try{const d=x;t!==x&&(X(t),await new Promise(p=>setTimeout(p,100)));const g=document.querySelector(`#page-${u[t].id}`);if(!g)return console.warn("Workspace element not found for page:",u[t].id),null;const h={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((r=u[t])==null?void 0:r.backgroundColor)||"#ffffff",width:g.offsetWidth,height:g.offsetHeight,removeContainer:!0,logging:!1,onclone:p=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(S=>{p.querySelectorAll(S).forEach(F=>F.remove())});const M=p.querySelector(`#page-${u[t].id}`);if(M){const S=u[t];S!=null&&S.backgroundImage&&(M.style.backgroundImage=`url(${S.backgroundImage})`,M.style.backgroundSize="cover",M.style.backgroundPosition="center",M.style.backgroundRepeat="no-repeat"),S!=null&&S.backgroundColor&&(M.style.backgroundColor=S.backgroundColor)}try{const S=g.querySelectorAll("img"),P=new Map;S.forEach((Q,Y)=>{const q=getComputedStyle(Q);P.set(Y,{objectFit:q.objectFit,objectPosition:q.objectPosition,width:q.width,height:q.height,borderRadius:q.borderRadius,transform:q.transform})}),p.querySelectorAll("img").forEach((Q,Y)=>{const q=P.get(Y);q&&(Q.style.objectFit=q.objectFit||"cover",Q.style.objectPosition=q.objectPosition||"center",Q.style.width=q.width,Q.style.height=q.height,Q.style.borderRadius=q.borderRadius,Q.style.transform=q.transform)})}catch(S){console.warn("Error preservando estilos de im√°genes:",S),p.querySelectorAll("img").forEach(F=>{F.style.objectFit="cover",F.style.objectPosition="center",F.style.width||(F.style.width="100%"),F.style.height||(F.style.height="100%")})}p.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(S=>{const P=S.className;P&&(S.className=P);const F=getComputedStyle?getComputedStyle(S):null;F&&(F.fontFamily&&F.fontFamily!=="Arial"&&(S.style.fontFamily=F.fontFamily),F.fontSize&&(S.style.fontSize=F.fontSize),F.fontWeight&&(S.style.fontWeight=F.fontWeight),F.fontStyle&&(S.style.fontStyle=F.fontStyle))});const y=p.createElement("style");y.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CR√çTICO: Asegurar que las im√°genes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CR√çTICO: Asegurar que los backgrounds de p√°gina se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,p.head.appendChild(y)}},c=await tn(g,h);if(a.width!==c.width||a.height!==c.height){const p=document.createElement("canvas");p.width=a.width,p.height=a.height;const C=p.getContext("2d"),M=c.width/c.height,A=a.width/a.height;let y,S,P=0,F=0;M>A?(y=a.width,S=a.width/M,F=(a.height-S)/2):(S=a.height,y=a.height*M,P=(a.width-y)/2),C.fillStyle=((l=u[t])==null?void 0:l.backgroundColor)||"#ffffff",C.fillRect(0,0,a.width,a.height),C.drawImage(c,P,F,y,S);const Q=p.toDataURL("image/png",1);return t!==d&&X(d),Q}return t!==d&&X(d),c.toDataURL("image/png",1)}catch(d){return console.error("‚ùå Error generando thumbnail de alta calidad:",d),null}},[u,x,X]);f.useEffect(()=>{const t=Qt();Vt(t)},[i,ie]),f.useEffect(()=>{const t=()=>{const a=Qt();Vt(a)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[i,ie]),f.useEffect(()=>{if(u[x]&&!ae[u[x].id]){const t=setTimeout(()=>{ce()},500);return()=>clearTimeout(t)}},[x,u,ae,ce]),f.useEffect(()=>{const t=u[x];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(a=>{a.ok?console.log("‚úÖ [WORKSPACE] Imagen existe en el servidor"):console.error("‚ùå [WORKSPACE] Imagen NO existe en el servidor. Status:",a.status)}).catch(a=>{console.error("‚ùå [WORKSPACE] Error verificando imagen:",a)})},[x,(uo=u[x])==null?void 0:uo.backgroundImage]),f.useEffect(()=>{const t=`${V.width}x${V.height}`,a=sessionStorage.getItem("lastWorkspaceDimensions");a&&a!==t&&u.length>0&&(se({}),setTimeout(()=>{u[x]&&Mn()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[V.width,V.height]),f.useEffect(()=>{if(!(o!=null&&o.id)||u.length===0)return;let t,a=Date.now(),r=!1;const l=()=>{r=!0,a=Date.now()},d=async()=>{if(r)try{console.log("üîÑ [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(p=>({...p,saveStatus:"saving"}));const h=await fetch(`/api/projects/${o.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:u,force:!1})}),c=await h.json();if(h.ok&&c.success)r=!1,T(p=>({...p,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("‚úÖ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado fall√≥")}catch(h){console.error("‚ùå [AUTO-SAVE] Error en guardado silencioso:",h),T(c=>({...c,saveStatus:"error",saveError:h.message}))}},g=()=>{t=setInterval(()=>{const h=Date.now()-a;r&&h>6e4&&(console.log("‚è∞ [AUTO-SAVE] Condiciones cumplidas para guardado autom√°tico"),d())},3*60*1e3)};return JSON.stringify(u),u[x],l(),g(),()=>{t&&clearInterval(t)}},[u,x,o==null?void 0:o.id]),f.useEffect(()=>{var a;if(!u[x])return;const t=((a=u[x].cells)==null?void 0:a.flatMap(r=>r.elements))||[];JSON.stringify(t),T(r=>({...r,hasUnsavedChanges:!0}))},[(go=u[x])==null?void 0:go.cells,x]);const[mr,wt]=f.useState(!1),[hr,Fn]=f.useState({elementId:null,cellId:null}),[Un,Yt]=f.useState(!1),[pr,Bn]=f.useState(!1),[fr,br]=f.useState(null),[zn,Hn]=f.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[Me,we]=f.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de √°lbum...",subMessage:"Preparando tu vista previa personalizada"}),yt=f.useRef(null),Jt=t=>{var l,d,g,h;const a=D||((d=(l=u[x])==null?void 0:l.cells[0])==null?void 0:d.id);if(!a)return;const r={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((h=(g=u[x].cells.find(c=>c.id===a))==null?void 0:g.elements)==null?void 0:h.length)||0)+1};Xe(a,r),re.success("Imagen a√±adida correctamente")},Et=f.useCallback(ut(async(t=!1)=>{if(!(o!=null&&o.id))return;const a=tt.get(o.id);if(!t&&a&&a.length>0){console.log("üîÑ Usando im√°genes desde cache"),je.length===0&&Ue(a);return}if(G.current&&clearTimeout(G.current),bt&&!t){console.log("‚è≥ Carga de im√°genes ya en progreso");return}Ut(!0);try{const r=new AbortController,l=setTimeout(()=>r.abort(),1e4),d=await fetch(`/api/canvas/projects/${o.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:r.signal});if(clearTimeout(l),!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const g=await d.json();if(g.success){const h=g.images||[],c=JSON.stringify(je),p=JSON.stringify(h);c!==p&&(Ue(h),Rn(C=>{const M=new Map(C);if(M.set(o.id,h),M.size>5){const A=M.keys().next().value;M.delete(A)}return M}))}else console.error("Error cargando im√°genes:",g.message),re.error("Error cargando galer√≠a de im√°genes")}catch(r){r.name==="AbortError"?console.warn("‚ö†Ô∏è Carga de im√°genes cancelada por timeout"):(console.error("Error cargando im√°genes del proyecto:",r),re.error("Error de conexi√≥n al cargar im√°genes"))}finally{Ut(!1)}},200),[o==null?void 0:o.id,tt,je,bt]),Gn=f.useCallback(async t=>{const a=t.target.files[0];if(!a||!(o!=null&&o.id))return;const r=re.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),l=URL.createObjectURL(a),d={id:`temp-${Date.now()}`,filename:a.name,url:l,thumbnail_url:l,has_thumbnail:!1,size:a.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Ue(h=>[d,...h]),Jt(l);const g=new FormData;g.append("image",a),g.append("projectId",o.id);try{const c=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:g})).json();if(c.success){const p={id:c.id||Date.now(),filename:a.name,url:c.url,thumbnail_url:c.thumbnail_url||c.url,has_thumbnail:c.has_thumbnail||!1,size:a.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Ue(C=>[p,...C.filter(M=>M.id!==d.id)]),setTimeout(()=>{te(C=>{const M=[...C];return M[x].cells.forEach(y=>{y.elements.forEach(S=>{S.type==="image"&&S.content===l&&(S.content=c.url)})}),M})},100),re.dismiss(r),re.success(c.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{Et(!0)},2e3)}else Ue(p=>p.filter(C=>C.id!==d.id)),URL.revokeObjectURL(l),re.dismiss(r),re.error(c.message||"Error al subir la imagen")}catch(h){console.error("Error subiendo la imagen:",h),Ue(c=>c.filter(p=>p.id!==d.id)),URL.revokeObjectURL(l),re.dismiss(r),re.error("Error de red al subir la imagen")}},[o==null?void 0:o.id,x,Jt,Et]);f.useEffect(()=>{if(o!=null&&o.id){const t=tt.get(o.id);if(t&&t.length>0){Ue(t);return}return G.current=setTimeout(()=>{Et(!1)},150),()=>{G.current&&clearTimeout(G.current)}}},[o==null?void 0:o.id,tt]),f.useEffect(()=>()=>{G.current&&clearTimeout(G.current)},[]);const Xt=(t,a)=>{if(console.log("üñºÔ∏è [ADD-IMAGE] Agregando imagen sin selecci√≥n autom√°tica"),!u||u.length===0||!u[x]){console.error("‚ùå [ADD-IMAGE] No hay p√°ginas v√°lidas para agregar imagen");return}const r=JSON.parse(JSON.stringify(u));let l=!1;for(let d=0;d<r[x].cells.length;d++)if(r[x].cells[d].id===t){r[x].cells[d].elements.push(a),l=!0,console.log("‚úÖ [ADD-IMAGE] Imagen agregada a la celda:",t);break}if(!l){console.error("‚ùå [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{Je(r),console.log("‚úÖ [ADD-IMAGE] Estado actualizado sin selecci√≥n autom√°tica")},0)},Vn=f.useCallback(t=>{var h,c,p,C;console.log("üñºÔ∏è [ADD-FROM-GALLERY] Iniciando proceso de agregar imagen:",t);const a=ot;Qe(!0);const r=J==="images",l=D||((c=(h=u[x])==null?void 0:h.cells[0])==null?void 0:c.id);if(!l){console.error("‚ùå [ADD-FROM-GALLERY] No hay celda disponible"),re.error("No hay celda disponible para agregar la imagen"),Qe(a);return}if(!t||typeof t!="string"){console.error("‚ùå [ADD-FROM-GALLERY] URL de imagen inv√°lida"),re.error("URL de imagen no v√°lida"),Qe(a);return}const d=JSON.parse(JSON.stringify(u));console.log("üì∏ [ADD-FROM-GALLERY] Snapshot del estado actual capturado");const g={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((C=(p=d[x].cells.find(M=>M.id===l))==null?void 0:p.elements)==null?void 0:C.length)||0)+1};console.log("üìù [ADD-FROM-GALLERY] Elemento creado:",g),setTimeout(()=>{Xt(l,g),setTimeout(()=>{r&&(pe("images"),console.log("üîÑ [ADD-FROM-GALLERY] Tab restaurado a images")),setTimeout(()=>{Qe(a),re.success("‚úÖ Imagen a√±adida desde la galer√≠a"),console.log("‚úÖ [ADD-FROM-GALLERY] Proceso completado exitosamente")},50)},50)},50)},[J,D,u,x,ot,Xt]),Zt=f.useCallback(async(t,a)=>{var d,g;const r=[],l=[];for(const h of t){const c={...h};if(h.cells){c.cells=[];for(const p of h.cells){const C={...p};if(p.elements){C.elements=[];for(const M of p.elements)if(M.type==="image"&&((d=M.content)!=null&&d.startsWith("data:image/"))){const A=`${M.id}_${Date.now()}`,y=M.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(y){const S=y[1],P=y[2],Q=`${A}.${S==="jpeg"?"jpg":S}`;l.push({filename:Q,data:P,type:S,elementId:M.id}),C.elements.push({...M,content:M.content,_wasBase64:!0,_originalSize:M.content.length,_elementId:M.id})}else C.elements.push(M)}else C.elements.push(M)}c.cells.push(C)}}r.push(c)}if(l.length>0)try{const h=await fetch(`/api/canvas/projects/${a}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((g=document.querySelector('meta[name="csrf-token"]'))==null?void 0:g.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:l})});if(h.ok){const c=await h.json();if(c.uploadedImages){const p=new Map;c.uploadedImages.forEach(C=>{p.set(C.elementId,C.url)});for(const C of r)if(C.cells){for(const M of C.cells)if(M.elements)for(const A of M.elements)A._wasBase64&&A._elementId&&p.has(A._elementId)&&(A.content=p.get(A._elementId),delete A._elementId)}}}else{const c=await h.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("‚ùå [IMAGE-UPLOAD] Error subiendo im√°genes:",c),t}}catch(h){return console.error("‚ùå [IMAGE-UPLOAD] Error de red subiendo im√°genes:",h),t}return r},[]),Ye=f.useCallback(async(t=u,a=!1)=>{var r;if(!(!(o!=null&&o.id)||!a&&t.length===0))try{const g={design_data:{pages:await Zt(t,o.id),currentPage:x,workspaceDimensions:V,workspaceSize:ie,selectedElement:B,selectedCell:D,history:Te.slice(-5),historyIndex:Math.min(Ne,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:o.id,name:(s==null?void 0:s.name)||"√Ålbum Personalizado",item_id:s==null?void 0:s.id,preset_id:i==null?void 0:i.id}},thumbnails:ae},c=JSON.stringify(g).length/(1024*1024),p=await fetch(`/api/canvas/projects/${o.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(g)});if(p.ok){const C=await p.json(),M=`editor_progress_project_${o.id}`;return localStorage.removeItem(M),$(A=>{const y=new Map(A);return a?y.clear():y.delete(x),y}),u&&u.length>0&&setTimeout(()=>{ce().catch(A=>{console.warn("‚ö†Ô∏è Error regenerando thumbnail de p√°gina actual:",A)})},300),!0}else{const C=await p.json().catch(()=>({message:"Error desconocido"}));return console.error("‚ùå [AUTO-SAVE] Error guardando en BD:",C),!1}}catch(l){return console.error("‚ùå [AUTO-SAVE] Error en auto-save con procesamiento de im√°genes:",l),!1}},[u,x,V,ie,o==null?void 0:o.id,s==null?void 0:s.name,s==null?void 0:s.id,i==null?void 0:i.id,Zt,vt]);f.useEffect(()=>{if(!(o!=null&&o.id))return;const t=setInterval(()=>{u.length>0&&Ye(u,!1)},10*60*1e3);return()=>clearInterval(t)},[Ye,u,o==null?void 0:o.id]),f.useCallback(async()=>{if(!u.length)return{};console.log("üì∏ [THUMBNAILS] Capturando thumbnails de todas las p√°ginas...");const t={},a=x;try{for(let r=0;r<u.length;r++){const l=u[r];if(l!=null&&l.id)try{r!==x&&(X(r),await new Promise(g=>setTimeout(g,300)));const d=await Oe({type:"thumbnail"});d&&(t[l.id]=d,console.log(`‚úÖ [THUMBNAILS] Thumbnail capturado para p√°gina ${r+1}: ${l.id}`))}catch(d){console.warn(`‚ö†Ô∏è [THUMBNAILS] Error capturando thumbnail para p√°gina ${l.id}:`,d),ae[l.id]&&(t[l.id]=ae[l.id])}}return a!==x&&X(a),console.log(`‚úÖ [THUMBNAILS] Capturados ${Object.keys(t).length} thumbnails de ${u.length} p√°ginas`),t}catch(r){return console.error("‚ùå [THUMBNAILS] Error capturando thumbnails:",r),a!==x&&X(a),ae}},[u,x,X,Oe,ae]);const eo=f.useCallback(async()=>{if(!(o!=null&&o.id)||u.length===0)return re.error("No hay datos para guardar"),!1;try{return console.log("üì∏ [SAVE] Generando thumbnail de p√°gina actual..."),await ce(),await Kt(),await Ye(u,!0)?(re.success("Progreso guardado exitosamente"),!0):(re.error("Error al guardar el progreso"),!1)}catch(t){return console.error("‚ùå [SAVE] Error al guardar el progreso:",t),re.error("Error al guardar el progreso"),!1}},[Ye,u,o==null?void 0:o.id,V,i,vt]),to=f.useCallback(async t=>{var a;if(console.log("üíæ [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("üîç [QUEUE-SAVE] Datos disponibles:",{projectId:o==null?void 0:o.id,pagesCount:t==null?void 0:t.length,currentPage:x,hasDimensions:!!V,hasThumbnails:!!ae}),!(o!=null&&o.id))return console.error("‚ùå [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return console.error("‚ùå [QUEUE-SAVE] No hay p√°ginas para guardar"),!1;try{const l={design_data:{pages:t,currentPage:x,workspaceDimensions:V,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:ae};console.log("üì§ [QUEUE-SAVE] Enviando petici√≥n al servidor...");const d=await fetch(`/api/canvas/projects/${o.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(l)});if(console.log("üì• [QUEUE-SAVE] Respuesta del servidor:",d.status,d.statusText),d.ok){const g=await d.json();return console.log("‚úÖ [QUEUE-SAVE] Guardado exitoso desde cola:",g),!0}else{const g=await d.text();return console.error("‚ùå [QUEUE-SAVE] Error en respuesta del servidor:",d.status,g),!1}}catch(r){return console.error("‚ùå [QUEUE-SAVE] Error guardando desde cola:",r),!1}},[o==null?void 0:o.id,x,V,ae]),Ct=f.useCallback(async()=>{if(console.log("üîç [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:L,saveQueueLength:R.length}),L){console.log("‚ö†Ô∏è [SAVE-QUEUE] Ya se est√° procesando, saltando...");return}if(R.length===0){console.log("‚ö†Ô∏è [SAVE-QUEUE] Cola vac√≠a, no hay nada que procesar");return}console.log("üöÄ [SAVE-QUEUE] Iniciando procesamiento de cola..."),O(!0);try{const t=R.slice();console.log("ÔøΩ [SAVE-QUEUE] Cola capturada para procesamiento:",t.length,"elementos"),H([]),console.log("üßπ [SAVE-QUEUE] Cola limpiada");for(const a of t)console.log("üíæ [SAVE-QUEUE] Guardando p√°gina:",a.pageIndex),await to(a.pages)?($(l=>{const d=new Map(l);return d.delete(a.pageIndex),d}),console.log("‚úÖ [SAVE-QUEUE] P√°gina guardada exitosamente:",a.pageIndex)):(console.error("‚ùå [SAVE-QUEUE] Error guardando p√°gina:",a.pageIndex),H(l=>[...l,a]));console.log("‚úÖ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(t){console.error("‚ùå [SAVE-QUEUE] Error procesando cola:",t)}finally{O(!1),console.log("üîì [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[L,R,to]);f.useEffect(()=>{console.log("üîÑ [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:R.length,isProcessingQueue:L,shouldProcess:R.length>0&&!L}),R.length>0&&!L&&(console.log("‚è∞ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{Ct()},100))},[R.length,L,Ct]),f.useEffect(()=>{console.log("üìä [SAVE-QUEUE] Estado de cola actualizado:",{longitud:R.length,elementos:R.map(t=>`p√°gina ${t.pageIndex}`),procesando:L})},[R,L]);const oo=f.useCallback((t,a)=>{console.log("üîç [SAVE-QUEUE] Intentando agregar p√°gina a cola:",t),$(r=>{const l=Array.from(r.keys());return console.log("üîç [SAVE-QUEUE] Cambios actuales:",l.join(", ")||"ninguno"),r.has(t)?(console.log("‚úÖ [SAVE-QUEUE] P√°gina tiene cambios, agregando a cola:",t),H(d=>{console.log("üîç [SAVE-QUEUE] Cola actual antes de agregar:",d.length,"elementos");const g=d.findIndex(h=>h.pageIndex===t);if(g!==-1){const h=[...d];return h[g]={pageIndex:t,pages:a,timestamp:Date.now()},console.log("üîÑ [SAVE-QUEUE] Actualizando elemento existente en cola"),h}else{const h=[...d,{pageIndex:t,pages:a,timestamp:Date.now()}];return console.log("‚ûï [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",h.length),h}}),console.log("üì§ [SAVE-QUEUE] P√°gina agregada a cola:",t),r):(console.log("‚ö†Ô∏è [SAVE-QUEUE] No hay cambios para la p√°gina:",t,"- No se agregar√° a cola"),r)})},[]),Tt=f.useCallback(async t=>{if(console.log("üîÑ [PAGE-CHANGE] Iniciando cambio de p√°gina de",x,"a",t),t===x){console.log("‚ö†Ô∏è [PAGE-CHANGE] Misma p√°gina, no se hace nada");return}$(a=>{console.log("üîç [PAGE-CHANGE] Verificando cambios en p√°gina actual:",x);const r=Array.from(a.keys());return console.log("üîç [PAGE-CHANGE] P√°ginas con cambios:",r.join(", ")||"ninguna"),a.has(x)?(console.log("üíæ [PAGE-CHANGE] ‚úÖ P√°gina actual tiene cambios, guardando antes del cambio:",x),oo(x,u)):console.log("‚ÑπÔ∏è [PAGE-CHANGE] No hay cambios en la p√°gina actual:",x),a}),X(t),console.log("üìÑ [PAGE-CHANGE] ‚úÖ P√°gina cambiada a:",t)},[x,u,oo]),De=()=>`editor_progress_project_${o==null?void 0:o.id}`,no=f.useCallback(async()=>{var a,r,l,d;if(!(o!=null&&o.id))return;if(u.some(g=>{var h;return(h=g.cells)==null?void 0:h.some(c=>{var p;return((p=c.elements)==null?void 0:p.length)>0})})){console.log("‚ö†Ô∏è [RECOVERY] Ya hay contenido en el workspace, saltando recuperaci√≥n autom√°tica");return}try{const g=Re.loadFromLocalStorage(),h=await fetch(`/api/canvas/projects/${o.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let c=null;if(h.ok){const C=await h.json();C.success&&((a=C.data)!=null&&a.design_data)&&(c=C.data)}let p=null;if(g&&c){const C=new Date(g.savedAt).getTime(),M=new Date(c.saved_at).getTime();p=C>M?g:c}else g?p=g:c&&(p=c);if(p&&(((r=p.pages)==null?void 0:r.length)>0||((d=(l=p.design_data)==null?void 0:l.pages)==null?void 0:d.length)>0)){const C=new Date(p.savedAt||p.saved_at).getTime();Date.now()-C<30*60*1e3?(console.log("üîÑ [AUTO-RECOVERY] Cargando autom√°ticamente el progreso m√°s reciente"),re.info("üîÑ Cargando progreso guardado autom√°ticamente..."),Dn(p)):console.log("üìÖ [RECOVERY] Progreso muy antiguo, ignorando autom√°ticamente")}}catch(g){console.error("‚ùå [RECOVERY] Error verificando progreso guardado:",g)}},[o==null?void 0:o.id,Re,u]),Dn=f.useCallback(async t=>{var a;try{let r=[];if(t.pages?r=t.pages:(a=t.design_data)!=null&&a.pages&&(r=t.design_data.pages),r.length>0){te(r);const l=[JSON.stringify(r)];We(l),Fe(0),setTimeout(()=>{se({})},100),re.success("‚úÖ Progreso cargado exitosamente"),Bn(!1)}}catch(r){console.error("‚ùå [RECOVERY] Error cargando progreso:",r),re.error("Error al cargar el progreso guardado")}},[te,We,Fe,se]);f.useCallback(async()=>{try{const t=Re.getStorageKey();localStorage.removeItem(t),re.success("Progreso anterior eliminado")}catch(t){console.error("‚ùå [RECOVERY] Error descartando progreso:",t)}},[Re]),f.useEffect(()=>{o&&s&&i&&(!(N!=null&&N.pages)||N.pages.length===0)&&ao(i,s)},[o,s,i,N]),f.useEffect(()=>{o!=null&&o.id&&!E&&u.length===0&&!ot&&(Qe(!0),setTimeout(()=>{no()},500))},[o==null?void 0:o.id,E,u.length,no,ot]),f.useEffect(()=>(ne.current&&clearTimeout(ne.current),o!=null&&o.id&&u.length>0&&(ne.current=setTimeout(()=>{Kt()},500)),()=>{ne.current&&clearTimeout(ne.current)}),[o==null?void 0:o.id,u.length]);const ao=(t,a)=>{try{const r=[],l=a.pages||t.pages||20;if(a.has_cover_image===!0||a.has_cover_image===1){const h=a.cover_image?`/storage/images/item/${a.cover_image}`:null,c=a.cover_image?null:t.background_color||"#ffffff",p={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:h,backgroundColor:c,cells:[{id:"cell-cover-1",elements:[]}]};r.push(p)}const d=a.content_image?`/storage/images/item/${a.content_image}`:null,g=a.content_image?null:t.background_color||"#ffffff";for(let h=1;h<=l;h++){const c={id:`page-content-${h}`,type:"content",pageNumber:h,layout:"layout-1",backgroundImage:d,backgroundColor:g,cells:[{id:`cell-content-${h}-1`,elements:[]}]};r.push(c)}if(a.has_back_cover_image===!0||a.has_back_cover_image===1){const h=a.back_cover_image?`/storage/images/item/${a.back_cover_image}`:null,c=a.back_cover_image?null:t.background_color||"#ffffff",p={id:"page-final",type:"final",layout:"layout-1",backgroundImage:h,backgroundColor:c,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};r.push(p)}te(r),X(0),t.width&&t.height&&Ee("preset")}catch(r){console.error("‚ùå Error creating pages:",r),I(r.message)}},ro=f.useCallback(t=>{var g,h;if(!t||t.length===0)return[];const a=t.filter(c=>c.type==="cover"),r=t.filter(c=>c.type==="content"),l=t.filter(c=>c.type==="final");if(console.log("üéØ [BOOK-ORGANIZE] Organizando p√°ginas del libro:",{cover:a.length,content:r.length,final:l.length,total:t.length}),a.length===0&&l.length===0)return console.log("üìñ [BOOK-ORGANIZE] Sin tapas - orden normal"),t;const d=[];return a.length>0&&(d.push(...a),console.log("üìï [BOOK-ORGANIZE] Tapa agregada en posici√≥n 0 (derecha)"),d.push({id:`blank-page-cover-back-${Date.now()}`,type:"blank",isBlankPage:!0,hasLogo:!0,logoUrl:"/assets/resources/logo.png",cells:[],backgroundColor:"#ffffff",layout:((g=de[0])==null?void 0:g.id)||"layout1"}),console.log("üìÑ [BOOK-ORGANIZE] Reverso de tapa con logo agregado en posici√≥n 1 (izquierda)")),r.length>0&&(d.push(...r),console.log("üìÑ [BOOK-ORGANIZE] Contenido agregado:",r.length+" p√°ginas, p√°gina 1 en posici√≥n",d.length-r.length)),l.length>0&&(d.length%2===1&&(d.push({id:`blank-page-before-back-${Date.now()}`,type:"blank",isBlankPage:!0,cells:[],backgroundColor:"#ffffff",layout:((h=de[0])==null?void 0:h.id)||"layout1"}),console.log("üìÑ [BOOK-ORGANIZE] P√°gina en blanco agregada para correcto posicionamiento de contratapa")),d.push(...l),console.log("üìï [BOOK-ORGANIZE] Contratapa agregada en posici√≥n",d.length-1,"(izquierda)")),console.log("‚úÖ [BOOK-ORGANIZE] Organizaci√≥n final:",{totalPages:d.length,sequence:d.map((c,p)=>({position:p,type:c.type,side:p===0?"Tapa (derecha)":p===1&&c.type==="blank"?"Reverso tapa (izquierda)":p===d.length-1&&c.type==="final"?"Contratapa (izquierda)":c.type==="blank"?"P√°gina en blanco":p%2===1?"Izquierda":"Derecha",id:c.id,pageNumber:c.type==="content"?`P√°gina ${r.indexOf(c)+1}`:""}))}),d},[de]),ge=f.useMemo(()=>s?{cover:u.filter(t=>t.type==="cover"&&(s.has_cover_image===!0||s.has_cover_image===1)),content:u.filter(t=>t.type==="content"),final:u.filter(t=>t.type==="final"&&(s.has_back_cover_image===!0||s.has_back_cover_image===1))}:{cover:u.filter(t=>t.type==="cover"),content:u.filter(t=>t.type==="content"),final:u.filter(t=>t.type==="final")},[u,s]),me=f.useCallback(()=>{if(!s)return console.warn("‚ö†Ô∏è [CONTENT-TYPE] itemData no disponible, usando tipo por defecto"),{type:"album",name:"√Ålbum",description:"Vista de √Ålbum",icon:"üìñ",experience:"book"};const t=s.has_cover_image===!0||s.has_cover_image===1,a=s.has_back_cover_image===!0||s.has_back_cover_image===1,r=t&&ge.cover.length>0,l=a&&ge.final.length>0,d=ge.content.length;return console.log("üéØ [CONTENT-TYPE] An√°lisis de contenido:",{coverEnabled:t,backCoverEnabled:a,coverPagesExist:ge.cover.length>0,finalPagesExist:ge.final.length>0,hasCover:r,hasBackCover:l,contentPages:d,itemConfig:{has_cover_image:s.has_cover_image,has_back_cover_image:s.has_back_cover_image}}),r&&l?{type:"album",name:"√Ålbum",description:"Vista de √Ålbum",icon:"üìñ",experience:"book"}:r||l?{type:"booklet",name:"Folleto",description:"Vista de Folleto",icon:"üìã",experience:"booklet"}:d>1?{type:"catalog",name:"Cat√°logo",description:"Vista de Cat√°logo",icon:"üìë",experience:"catalog"}:{type:"card",name:"Dise√±o",description:"Vista Previa",icon:"üé®",experience:"single"}},[ge,s])(),oe=f.useCallback(()=>{if(!B||!D||u.length===0)return null;const t=u[x];if(!t)return null;const a=t.cells.find(r=>r.id===D);return a?a.elements.find(r=>r.id===B):null},[B,D,u,x]),so=(t,a)=>{if(a){const r=u[x].cells.find(d=>d.id===a),l=r==null?void 0:r.elements.find(d=>d.id===t);if(l!=null&&l.locked){const d=document.createElement("div");d.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",d.textContent="Este elemento es parte del dise√±o base y no se puede editar",document.body.appendChild(d),setTimeout(()=>{document.body.contains(d)&&document.body.removeChild(d)},3e3);return}}if(a&&le(a),Z(t),t){const r=u[x].cells.find(d=>d.id===(a||D)),l=r==null?void 0:r.elements.find(d=>d.id===t);(l==null?void 0:l.type)==="image"?(Ft(l),console.log("üñºÔ∏è Imagen seleccionada:",l.id,"- Tab actual mantenido:",J),J==="filters"?console.log("‚úÖ Usuario ya est√° en filtros, manteniendo"):console.log("‚úÖ Imagen seleccionada, pero manteniendo tab actual:",J)):(l==null?void 0:l.type)==="text"?(wt(!0),Fn({elementId:t,cellId:a||D}),J!=="filters"&&J!=="images"&&pe("text")):wt(!1)}else wt(!1),Ft(null)},$e=()=>{if(u.length===0)return de[0];const t=u[x];return t?de.find(a=>a.id===t.layout)||de[0]:de[0]},io=f.useCallback(ut(t=>{try{const a=De(),r={pages:t,currentPage:x,savedAt:Date.now()},l=JSON.stringify(r),d=Math.round(l.length/1024);d<2048?localStorage.setItem(a,l):(console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${d} KB)`),localStorage.removeItem(a))}catch(a){if(console.error("‚ùå Error guardando en localStorage:",a),a.name==="QuotaExceededError")try{localStorage.removeItem(De())}catch(r){console.error("Error limpiando localStorage:",r)}}},300),[x,De]),Je=f.useCallback(t=>{te(a=>{if(a===t)return a;const r=JSON.stringify(a),l=JSON.stringify(t);return r===l?(console.log("üîÑ [UPDATE-PAGES] Sin cambios, evitando actualizaci√≥n"),a):(console.log("üìù [UPDATE-PAGES] Aplicando cambios..."),requestAnimationFrame(()=>{if($(d=>{const g=new Map(d);return g.set(x,Date.now()),g}),t[x]){const d=t[x].id;se(g=>{if(g[d]){const h={...g};return delete h[d],h}return g})}}),setTimeout(()=>{We(d=>{const g=[...d.slice(0,Ne+1),l];return g.length>50?g.slice(-50):g}),Fe(d=>{const g=d+1;return g>50?49:g})},0),t)}),io(t)},[x,Ne,io]);f.useEffect(()=>{try{const t=De(),a={pages:u,currentPage:x,savedAt:Date.now()},r=JSON.stringify(a),l=Math.round(r.length/1024);l<2048?localStorage.setItem(t,r):console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${l} KB), saltando guardado`)}catch(t){if(console.error("‚ùå Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const a=De();localStorage.removeItem(a)}catch(a){console.error("Error limpiando localStorage:",a)}}},[x,u,De]);const Wn=t=>{const a=de.find(g=>g.id===t);if(!a)return;const r=[...u],l=r[x],d=Array.from({length:a.cells}).map((g,h)=>l.cells[h]||{id:`cell-${l.id}-${h+1}`,elements:[]});r[x]={...l,layout:t,cells:d},Je(r),Z(null),le(null)},Xe=(t,a)=>{const r=[...u];for(let l=0;l<r[x].cells.length;l++)r[x].cells[l].id===t&&r[x].cells[l].elements.push(a);Je(r),Z(a.id),le(t)},lo=f.useCallback(ut(()=>{$(t=>{const a=new Map(t);return a.set(x,Date.now()),a})},100),[x]),he=f.useCallback((t,a,r,l=!1)=>{console.log("üîÑ [updateElementInCell] Actualizando elemento:",{cellId:t,elementId:a,updates:r,isDuplicate:l}),console.log("üîç [updateElementInCell] Verificando si hay cambios en filtros/m√°scaras:",{hasFilters:!!r.filters,hasMask:!!r.mask,filtersData:r.filters,maskData:r.mask}),te(d=>{const g=[...d],h=g[x].cells.findIndex(c=>c.id===t);if(h===-1)return d;if(l){const c=g[x].cells[h].elements.find(p=>p.id===a);if(!c)return d;g[x].cells[h].elements.push({...c,...r})}else{const c=g[x].cells[h].elements.findIndex(A=>A.id===a);if(c===-1)return d;const p=g[x].cells[h].elements[c];if(!Object.keys(r).some(A=>{const y=p[A],S=r[A];return typeof S=="object"&&typeof y=="object"?JSON.stringify(y)!==JSON.stringify(S):y!==S}))return console.log("üö´ [updateElementInCell] No hay cambios reales, saltando actualizaci√≥n"),d;const M={...p,...r};console.log("‚úÖ [updateElementInCell] Elemento actualizado:",M),g[x].cells[h].elements[c]=M,r.filters||r.mask?(console.log("üîÑ [AUTO-REGEN] Cambios en filtros/m√°scaras detectados, regenerando thumbnail..."),console.log("üîÑ [AUTO-REGEN] Datos de cambios:",{filters:r.filters,mask:r.mask}),window.FORCE_THUMBNAIL_REGENERATION&&(console.log("üí• [FORZADO-EMERGENCIA] Limpiando cach√© de thumbnails completamente"),window.thumbnailCache={}),ce(!0).then(()=>{console.log("‚úÖ [AUTO-REGEN] Thumbnail regenerado exitosamente"),window.FORCE_THUMBNAIL_REGENERATION&&window.forceRegenerateThumbnail&&setTimeout(()=>{console.log("üîÑ [FORZADO-EMERGENCIA] Ejecutando regeneraci√≥n forzada secundaria");try{window.forceRegenerateThumbnail()}catch(A){console.error("‚ùå [FORZADO-EMERGENCIA] Error en regeneraci√≥n secundaria:",A)}},150)}).catch(A=>{console.error("‚ùå [AUTO-REGEN] Error regenerando thumbnail:",A)})):console.log("üö´ [AUTO-REGEN] No hay cambios en filtros/m√°scaras, saltando regeneraci√≥n")}return g}),r.position||r.size?requestAnimationFrame(()=>{$(d=>{if(d.has(x))return d;const g=new Map(d);return g.set(x,Date.now()),g})}):lo()},[x,lo]);f.useCallback(()=>{var a;console.log("üö® [FORCE-REGEN] Iniciando regeneraci√≥n forzada..."),window.thumbnailCache&&(window.thumbnailCache={}),window.THUMBNAIL_PROTECTED=!0,window._protectedThumbnailIds||(window._protectedThumbnailIds=[]);const t=(a=u[x])==null?void 0:a.id;t&&!window._protectedThumbnailIds.includes(t)&&window._protectedThumbnailIds.push(t),window.BLOCK_AUTO_REGENERATION=!0,ce(!0),setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,console.log("üîì Regeneraci√≥n autom√°tica desbloqueada despu√©s de protecci√≥n")},1e4)},[ce]),f.useCallback(()=>{B&&D?(console.log("üß™ [TEST] Aplicando filtro grayscale de prueba..."),he(D,B,{filters:{brightness:100,contrast:100,saturation:0,opacity:100}})):console.log("‚ö†Ô∏è [TEST] No hay elemento seleccionado")},[B,D,he]),f.useCallback(()=>{console.log("üîí [BLOQUEO-SELECTIVO] Activando protecci√≥n para thumbnails con filtros"),window.THUMBNAIL_PROTECTED=!0,window.PERMANENT_THUMBNAIL_LOCK=!0,window.BLOCK_AUTO_REGENERATION=!1,window._protectedThumbnailIds=Object.keys(ae);const t=window.forceRegenerateThumbnail;window.forceRegenerateThumbnail=(...a)=>window._userInitiated?(console.log("‚úÖ [REGENERACI√ìN AUTORIZADA] Permitiendo regeneraci√≥n solicitada por usuario"),window._userInitiated=!1,t(...a)):(console.log("üõë [REGENERACI√ìN BLOQUEADA] Intento de regeneraci√≥n no autorizado bloqueado"),!1),window._allowNextRegeneration=()=>{window._userInitiated=!0},window.safeRegenerateThumbnail=()=>{window._allowNextRegeneration(),window.forceRegenerateThumbnail()},window._thumbnailBackup={...ae},alert(`üîí Miniaturas protegidas exitosamente!

Si necesitas regenerar una miniatura espec√≠fica, usa window.safeRegenerateThumbnail() en la consola.`),console.log("üîí [BLOQUEO-PERMANENTE] Thumbnails protegidos:",window._protectedThumbnailIds),console.log("üîí [BLOQUEO-PERMANENTE] No se permitir√°n m√°s regeneraciones autom√°ticas"),console.log("üì¢ [INSTRUCCIONES] Para regenerar manualmente una miniatura, ejecuta window.safeRegenerateThumbnail() en la consola")},[ae]),f.useCallback(()=>{console.log("üåà [FILTROS-FORZADOS] Iniciando regeneraci√≥n con filtros garantizados..."),window.FORCE_FILTER_APPLICATION=!0,window.ENABLE_ADVANCED_FILTER_RENDERING=!0,window.thumbnailCache&&window.thumbnailCache.clear(),_t&&_t();const t=u[x];t&&t.cells&&t.cells.forEach(a=>{a.elements&&a.elements.forEach(r=>{r.filters&&(console.log(`üîç [FILTROS-FORZADOS] Marcando elemento ${r.id} para filtros forzados`),r._hasRealFilters=!0,r.pageId=t.id)})}),ce(!0),console.log("üéâ [FILTROS-FORZADOS] Regeneraci√≥n completada")},[u,x,ce]);const at=(t,a)=>{const r=[...u],l=r[x].cells.findIndex(d=>d.id===t);l!==-1&&(r[x].cells[l].elements=r[x].cells[l].elements.filter(d=>d.id!==a),Je(r),B===a&&Z(null))},qn=(t,a,r)=>{const l=[...u],d=l[x].cells.findIndex(g=>g.id===t);if(d!==-1){const g=l[x].cells[d].elements,h=g.findIndex(c=>c.id===a);if(h!==-1){const c=r==="up"?h+1:h-1;if(c>=0&&c<g.length){const p=g[h];g[h]=g[c],g[c]=p,Je(l)}}}},Kn=()=>{Ne>0&&(Fe(Ne-1),te(JSON.parse(Te[Ne-1])),Z(null),le(null))},Qn=()=>{Ne<Te.length-1&&(Fe(Ne+1),te(JSON.parse(Te[Ne+1])),Z(null),le(null))},Nt=(t="body")=>{const a=`text-${Date.now()}`,r={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},l={heading:"T√≠tulo Principal",subheading:"Subt√≠tulo",body:"Haz clic para editar"},d={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},g={id:a,type:"text",content:l[t],position:{x:.05,y:.05},size:d[t],style:r[t]};D?Xe(D,g):console.log("Selecciona una celda primero")},co=f.useMemo(()=>{var d;const t=u[x];if(!t)return null;const a=((d=t.cells)==null?void 0:d.flatMap(g=>g.elements||[]))||[],r=a.map(g=>({id:g.id,type:g.type,position:g.position,size:g.size}));return{pageId:t.id,elementsCount:a.length,contentHash:JSON.stringify(r).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[u,x]);f.useEffect(()=>{var h;const t=u[x];if(!t)return;const a=t.id,r=(h=t==null?void 0:t.cells)==null?void 0:h.some(c=>{var p;return(p=c.elements)==null?void 0:p.some(C=>C.filters&&(C.filters.brightness!==100||C.filters.contrast!==100||C.filters.saturation!==100||C.filters.tint!==0||C.filters.hue!==0))});if(r&&(console.log("üé≠ [FILTROS DETECTADOS] Esta p√°gina tiene filtros aplicados"),window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(a)||window._protectedThumbnailIds.push(a)),console.log("‚úÖ [THUMBNAIL] Generando miniatura "+(r?"CON filtros aplicados":"sin filtros")+"..."),u.length===0||E||!co)return;let l=!1;const d=async()=>{var c;if(console.log("INCIO GENERATE"),window.PREVENT_THUMBNAIL_RESET||window.THUMBNAIL_PROTECTED){console.log("üõ°Ô∏è [PROTECCI√ìN ACTIVA] Regeneraci√≥n cancelada");return}try{const p=u[x];if(console.log("AQUI MOSTRAMOS EL CURRENT ",p),!p||!p.id)return;const C=p.id;if(!window.PREVENT_THUMBNAIL_RESET&&!window.THUMBNAIL_PROTECTED&&se(S=>{const P={...S};return delete P[C],P}),await new Promise(S=>setTimeout(S,100)),console.log("ANTES DEL CANCELED"),l)return;const M=(c=p==null?void 0:p.cells)==null?void 0:c.some(S=>{var P;return(P=S.elements)==null?void 0:P.some(F=>F.filters&&(F.filters.brightness!==100||F.filters.contrast!==100||F.filters.saturation!==100||F.filters.tint!==0||F.filters.hue!==0))}),A=M?{type:"thumbnail",preserveFilters:!0}:{type:"thumbnail"};console.log(`üé≠ [CAPTURE] Generando miniatura ${M?"CON filtros":"est√°ndar"}`);const y=await Oe(A);console.log("ESTA ES THUMBANIL"+y),y&&!l?(se(S=>({...S,[C]:y})),console.log("ESTA ES UNA NUEVA CONSOLA"+M),M&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(C)||window._protectedThumbnailIds.push(C))):console.warn("‚ö†Ô∏è [DEBUG] No se pudo generar miniatura para:",C)}catch(p){l||console.error("‚ùå [DEBUG] Error regenerando miniatura:",p)}},g=setTimeout(()=>{d()},500);return()=>{l=!0,clearTimeout(g)}},[x,co,E,Oe]),f.useEffect(()=>{if(window.BLOCK_AUTO_REGENERATION){console.log("üõ°Ô∏è [PROTECCI√ìN PARCIAL] Bloqueando generaci√≥n temporal en segundo plano");return}if(u.length===0||E)return;const t=async()=>{if(window.BLOCK_AUTO_REGENERATION){console.log("üõ°Ô∏è [PROTECCI√ìN TEMPORAL] Generaci√≥n en segundo plano pausada");return}const r=u.filter(l=>!ae[l.id]);if(r.length!==0)for(const l of r)try{const d=document.createElement("canvas");d.width=200,d.height=150;const g=d.getContext("2d");if(g.fillStyle=l.backgroundColor||"#ffffff",g.fillRect(0,0,200,150),l.backgroundImage)try{const c=new Image;c.crossOrigin="anonymous",await new Promise((p,C)=>{c.onload=p,c.onerror=C,c.src=l.backgroundImage}),g.drawImage(c,0,0,200,150)}catch(c){console.warn("No se pudo cargar imagen de fondo para miniatura:",c)}l.cells&&l.cells.forEach(c=>{c.elements&&c.elements.forEach(p=>{var C;p.type==="text"&&p.content&&(g.fillStyle=((C=p.style)==null?void 0:C.color)||"#000000",g.font="12px Arial",g.fillText(p.content.substring(0,20)+(p.content.length>20?"...":""),10,30))})});const h=d.toDataURL("image/jpeg",.7);se(c=>({...c,[l.id]:h})),await new Promise(c=>setTimeout(c,300))}catch(d){console.error("‚ùå Error generando miniatura de fondo para:",l.id,d)}},a=setTimeout(()=>{t()},2e3);return()=>clearTimeout(a)},[u,ae,E]),f.useEffect(()=>{const t=a=>{const r=U.current,l=K.current;if(r.length>0||l.size>0)return a.preventDefault(),a.returnValue="Hay cambios sin guardar. ¬øEst√°s seguro de que quieres salir?",a.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),f.useEffect(()=>()=>{console.log("üßπ [CLEANUP] Componente desmontado")},[]);const Yn=async()=>{var t;try{if(console.log("üöÄ ===== INICIANDO addAlbumToCart ====="),console.log("üì¶ itemData:",s),console.log("üé® presetData:",i),console.log("üìã projectData:",o),console.log("üÜî projectData?.id:",o==null?void 0:o.id),console.log("====================================="),!s||!i||!(o!=null&&o.id))return!1;await Ye(u,!0)||console.warn("‚ö†Ô∏è No se pudo guardar el progreso, pero continuando...");const r={design_data:{id:o.id,title:(s==null?void 0:s.name)||"√Ålbum Personalizado",pages:u,workspace_dimensions:V,created_at:new Date().toISOString()},item_data:{id:s==null?void 0:s.id,name:(s==null?void 0:s.name)||(s==null?void 0:s.title),price:s==null?void 0:s.price,user_id:s==null?void 0:s.user_id,width:s==null?void 0:s.width,height:s==null?void 0:s.height},preset_data:{id:i==null?void 0:i.id,width:i==null?void 0:i.width,height:i==null?void 0:i.height,cover_image:i==null?void 0:i.cover_image,content_layer_image:i==null?void 0:i.content_layer_image,final_layer_image:i==null?void 0:i.final_layer_image},dimensions:{width_mm:(i==null?void 0:i.width)||(s==null?void 0:s.width)||210,height_mm:(i==null?void 0:i.height)||(s==null?void 0:s.height)||297,workspace_width:(V==null?void 0:V.width)||800,workspace_height:(V==null?void 0:V.height)||600}};try{const M=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:o.id,status:"ready_for_pdf",pdf_data:r,completed_at:new Date().toISOString()})});if(M.ok){const A=await M.json()}else console.warn("‚ö†Ô∏è Error marcando proyecto como completado")}catch(M){console.warn("‚ö†Ô∏è Error en marcado de completado:",M)}const l=Date.now(),d=o.id;window.currentProjectId=d,window.albumProjectId=d;let g=i.cover_image;ae&&ae["page-cover"]&&(g=ae["page-cover"]);let h=g;g&&g.startsWith("data:image/")&&g.length>1e5&&(h=i.cover_image||"/assets/img/default-album.jpg");const c={...s,project_id:d,canvas_project_id:o.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:i.width,height_mm:i.height,pages_count:u.length,workspace_dimensions:V,requires_pdf_generation:!0}};console.log("üì¶ PRODUCTO √ÅLBUM CREADO:",c),console.log("üéØ PROJECT IDS:",{project_id:d,canvas_project_id:o.id,item_id:s==null?void 0:s.id});const p=structuredClone(ue),C=p.findIndex(M=>M.id==c.id);return C==-1?p.push({...c,quantity:1}):p[C].quantity++,ye(p),re.success("√Ålbum agregado al carrito",{description:`${c.name} se ha a√±adido al carrito. El PDF se generar√° en el backend.`,icon:e.jsx(xa,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:p,action:"add",product:c}})),!0}catch(a){return console.error("‚ùå === ERROR EN addAlbumToCart ==="),console.error("Error completo:",a),console.error("Stack trace:",a.stack),console.error("Mensaje del error:",a.message),re.error("Error al agregar al carrito",{description:`Error espec√≠fico: ${a.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!u||u.length===0)throw new Error("No hay p√°ginas para finalizar");const r={design_data:{pages:(A=>A.map(y=>({id:y.id,type:y.type,pageNumber:y.pageNumber,layout:y.layout,cells:y.cells.map(S=>({id:S.id,elements:S.elements.map(P=>{const F={id:P.id,type:P.type,position:P.position,zIndex:P.zIndex||1};if(P.type==="image"){if(P.content.startsWith("data:image/")){const Q=btoa(P.content.substring(0,100)).substring(0,20);F.content=`[BASE64_IMAGE_${Q}]`,F.contentType=P.content.split(";")[0].split(":")[1],F.originalSize=P.content.length}else F.content=P.content;if(P.filters){const Q=Object.entries(P.filters).filter(([Y,q])=>q!==0&&q!==!1&&q!==null).reduce((Y,[q,ee])=>(Y[q]=ee,Y),{});Object.keys(Q).length>0&&(F.filters=Q)}P.mask&&P.mask!=="none"&&(F.mask=P.mask),P.size&&(F.size=P.size),P.locked&&(F.locked=P.locked)}else if(P.type==="text"&&(F.content=P.content,P.style)){const Q=Object.entries(P.style).filter(([Y,q])=>!(Y==="fontSize"&&q==="16px"||Y==="color"&&q==="#000000"||Y==="fontFamily"&&q==="Arial")).reduce((Y,[q,ee])=>(Y[q]=ee,Y),{});Object.keys(Q).length>0&&(F.style=Q)}return F})}))})))(u),projectInfo:{id:o==null?void 0:o.id,item_id:s==null?void 0:s.id,title:s==null?void 0:s.title,preset_id:i==null?void 0:i.id},presetInfo:{id:i==null?void 0:i.id,name:i==null?void 0:i.name,cover_image:i==null?void 0:i.cover_image,content_image:i==null?void 0:i.content_image,back_cover_image:i==null?void 0:i.back_cover_image},workspace:{width:V.width,height:V.height,scale:V.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(ae).map(([A,y])=>[A,y]))},l=JSON.stringify(r),d=Math.round(l.length/1024),g=Math.round(d/1024*100)/100;let h=0,c=0;u.forEach(A=>{var y;(y=A.cells)==null||y.forEach(S=>{var P;(P=S.elements)==null||P.forEach(F=>{F.type==="image"&&F.content&&F.content.startsWith("data:image/")&&(h++,c+=F.content.length)})})});const p=Math.round(c/(1024*1024)*100)/100;if(d>1024&&!confirm(`El dise√±o contiene ${h} im√°genes (${p} MB en im√°genes). Payload completo: ${g} MB. Esto podr√≠a causar problemas al guardarlo. ¬øDesea continuar de todos modos?`))return!1;const C=await fetch(`/api/canvas/projects/${o.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:l});if(!C.ok){let A="Error al finalizar el dise√±o";try{A=(await C.json()).message||A}catch{C.status===413?A="El dise√±o es demasiado grande para ser guardado. Intente simplificar las im√°genes.":C.status>=500&&(A="Error del servidor. Intente nuevamente m√°s tarde.")}throw new Error(A)}const M=await C.json();return!0}catch(t){console.error("Error al finalizar dise√±o:",t);let a=t.message;return t.message.includes("Failed to fetch")?a="Error de conexi√≥n. Verifique su conexi√≥n a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(a="Error de red. Intente nuevamente m√°s tarde."),alert("Error al finalizar el dise√±o: "+a),!1}};const Jn=f.useCallback(async()=>{try{const{jsPDF:t}=await Zn(async()=>{const{jsPDF:Q}=await import("./jspdf.es.min-D3plwuQr.js").then(Y=>Y.j);return{jsPDF:Q}},__vite__mapDeps([0,1,2,3,4]));let a=(i==null?void 0:i.width)||21,r=(i==null?void 0:i.height)||29.7;const l=.3,d=a+l*2,g=r+l*2,h=d*28.35,c=g*28.35,p=new t({orientation:h>c?"landscape":"portrait",unit:"pt",format:[h,c],compress:!1}),C=u.length;let M=0;const A=document.createElement("div");A.id="pdf-progress",A.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",A.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${C} p√°ginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(A);const y=Q=>{const Y=Q/C*100;document.getElementById("pdf-progress-bar").style.width=`${Y}%`,document.getElementById("current-page").textContent=Q},S=x;for(let Q=0;Q<u.length;Q++){const Y=u[Q];X(Q),await new Promise(q=>setTimeout(q,500));try{const q=await Oe({type:"pdf"});if(q){const ee=q.width/q.height,_e=h/c;let be,xe,Ie=0,Be=0;ee>_e?(be=h,xe=h/ee,Be=(c-xe)/2):(xe=c,be=c*ee,Ie=(h-be)/2);const ze=q.toDataURL("image/png",1);Q>0&&p.addPage([h,c]),p.addImage(ze,"PNG",Ie,Be,be,xe)}else console.warn(`‚ö†Ô∏è No se pudo capturar la p√°gina ${Q+1}`),Q>0&&p.addPage([h,c]),p.setFontSize(12),p.text(`Error al renderizar p√°gina ${Q+1}`,h/2,c/2,{align:"center"})}catch(q){console.error(`‚ùå Error procesando p√°gina ${Q+1}:`,q),Q>0&&p.addPage([h,c]),p.setFontSize(12),p.text(`Error al procesar p√°gina ${Q+1}`,h/2,c/2,{align:"center"})}M++,y(M),await new Promise(q=>setTimeout(q,200))}X(S);const P=`${(s==null?void 0:s.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;p.save(P),document.body.removeChild(A);const F=document.createElement("div");return F.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",F.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${P}</span>
                </div>
            `,document.body.appendChild(F),setTimeout(()=>{document.body.contains(F)&&document.body.removeChild(F)},5e3),P}catch(t){console.error("‚ùå Error generando PDF:",t);const a=document.getElementById("pdf-progress");a&&document.body.removeChild(a);const r=document.createElement("div");throw r.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",r.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(r),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},7e3),t}},[u,x,X,Oe,i,s]);return window.generateAlbumPDF=Jn,window.generateHighQualityThumbnail=$n,window.captureCurrentWorkspace=Oe,window.regenerateCurrentThumbnailNow=()=>{var a;console.log("üöÄ [REGENERACI√ìN FORZADA] Regenerando miniatura de p√°gina actual...");const t=(a=u[x])==null?void 0:a.id;if(t){const r=u[x];let l=!1;r&&r.cells&&r.cells.forEach(d=>{d.elements&&d.elements.forEach(g=>{g.filters&&(g.filters.brightness!==100||g.filters.contrast!==100||g.filters.saturation!==100||g.filters.tint!==0||g.filters.hue!==0||g.filters.blur>0||g.filters.opacity!==100||g.filters.scale!==1||g.filters.rotate!==0||g.filters.flipHorizontal||g.filters.flipVertical)&&(l=!0,console.log(`üé® [FILTRO DETECTADO] Elemento ${g.id} tiene filtros aplicados`),g._hasRealFilters=!0)})}),l&&(console.log("üé≠ [FILTROS DETECTADOS] Activando modo de preservaci√≥n de filtros"),window.PRESERVE_FILTERS_FOR_PAGE=t,window.FORCE_FILTER_APPLICATION=!0),se(d=>{const g={...d};return delete g[t],g})}return setTimeout(()=>{console.log("‚ö° [REGENERACI√ìN] Iniciando generaci√≥n con preservaci√≥n de filtros"),ce(!0),console.log("‚úÖ Regeneraci√≥n forzada completada. La miniatura deber√≠a ser visible ahora."),setTimeout(()=>{console.log("üîÑ [CLEANUP] Limpiando flags despu√©s de regeneraci√≥n"),window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},100),"‚úÖ Miniatura regenerada con √©xito!"},window.generateThumbnailWithFilters=()=>{console.log("üé® [FUNCI√ìN GLOBAL] Regenerando miniatura con filtros garantizados"),window.FORCE_FILTER_APPLICATION=!0;const t=Date.now();return window._filterCacheBreaker=t,window.regenerateCurrentThumbnailNow(),setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1},1e3),"‚úÖ Miniatura con filtros regenerada exitosamente"},window.forceRegenerateWithGuaranteedFilters=async()=>{var a,r,l,d,g;console.log("üî• [RADICAL] Usando sistema de filtros garantizados");const t=u[x];if(!t||!V)return console.error("‚ùå [RADICAL] Datos no disponibles"),!1;try{window._filterVerificationDone&&window._filterVerificationDone.clear(),window._currentPageData=t,window._workspaceDimensions=V,window._updateThumbnailInUI=(c,p)=>{se(C=>({...C,[c]:p}))},console.log("üì¶ [FUNCI√ìN GLOBAL - DATOS] currentPageData antes de generar:",{pageId:t.id,elementsCount:((a=t.elements)==null?void 0:a.length)||0,elementsWithRealFilters:((l=(r=t.elements)==null?void 0:r.filter(c=>c.filters?c.filters.brightness!==void 0&&c.filters.brightness!==1||c.filters.contrast!==void 0&&c.filters.contrast!==1||c.filters.saturation!==void 0&&c.filters.saturation!==1||c.filters.tint!==void 0&&c.filters.tint!==0||c.filters.hue!==void 0&&c.filters.hue!==0||c.filters.opacity!==void 0&&c.filters.opacity!==1||c.filters.blur!==void 0&&c.filters.blur!==0||c.filters.scale!==void 0&&c.filters.scale!==1||c.filters.rotate!==void 0&&c.filters.rotate!==0||c.filters.flipHorizontal||c.filters.flipVertical:!1))==null?void 0:l.map(c=>({id:c.id,type:c.type,filtersDetailed:{brightness:c.filters.brightness+" (should be applied as: "+c.filters.brightness+")",contrast:c.filters.contrast+" (should be applied as: "+c.filters.contrast+")",saturation:c.filters.saturation+" (should be applied as: "+c.filters.saturation+")",tint:c.filters.tint+" (should be applied as: "+c.filters.tint+")",hue:c.filters.hue+" (should be applied as: "+c.filters.hue+")",opacity:c.filters.opacity+" (should be applied as: "+c.filters.opacity+")",blur:c.filters.blur+" (should be applied as: "+c.filters.blur+")",scale:c.filters.scale+" (should be applied as: "+c.filters.scale+")",rotate:c.filters.rotate+" (should be applied as: "+c.filters.rotate+")",flipHorizontal:c.filters.flipHorizontal,flipVertical:c.filters.flipVertical}})))||[]});const h=await kt(t,V);return h?(((d=t.elements)==null?void 0:d.some(p=>p.filters?Object.keys(p.filters).some(C=>C==="flipHorizontal"||C==="flipVertical"?p.filters[C]:C==="brightness"||C==="contrast"||C==="saturation"||C==="opacity"||C==="scale"?p.filters[C]!==1:C==="tint"||C==="hue"||C==="blur"||C==="rotate"?p.filters[C]!==0:!1):!1))&&((g=window.protectThumbnail)==null||g.call(window,t.id),console.log(`üõ°Ô∏è [GLOBAL PROTECTION] Thumbnail ${t.id} protegido en funci√≥n global`)),se(p=>(console.log(`üåç [GLOBAL SET] Estableciendo thumbnail desde funci√≥n global para ${t.id}`),{...p,[t.id]:h})),console.log("‚úÖ [RADICAL] Thumbnail generado exitosamente"),!0):!1}catch(h){return console.error("‚ùå [RADICAL] Error:",h),!1}},window.safeRegenerateThumbnail=()=>(console.log("üõ°Ô∏è [SAFE] Regeneraci√≥n segura iniciada"),window._filterVerificationDone&&window._filterVerificationDone.clear(),ce(!0),"‚úÖ Regeneraci√≥n segura completada"),e.jsxs(ea,{backend:ta,className:"!h-screen !w-screen overflow-hidden",children:[E?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu √°lbum personalizado..."})]})}):_?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:_}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):u.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando p√°ginas del √°lbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx("style",{children:`
                        /* Solo aplicar overflow visible en modo edici√≥n (no en preview ni captura) */
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] {
                            overflow: visible !important;
                        }
                        
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] > div {
                            overflow: visible !important;
                        }
                        
                        /* Mantener overflow hidden solo para el contenedor principal para evitar scroll */
                        .editor-workspace:not(.preview-mode) #page-${(mo=u[x])==null?void 0:mo.id} {
                            overflow: visible !important;
                        }
                        
                        /* En preview mode y captura, mantener overflow hidden para el resultado final */
                        .preview-mode [data-element-type="image"],
                        .capture-mode [data-element-type="image"] {
                            overflow: hidden !important;
                        }
                    `}),e.jsx(da,{isOpen:Un,onRequestClose:()=>{Yt(!1),Hn({isLoading:!1,loadedImages:0,totalImages:0,message:""}),we({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:(()=>{if(!s){console.warn("‚ö†Ô∏è [EDITOR-TO-MODAL] itemData no disponible, enviando todas las p√°ginas");const r=ge.cover.concat(ge.content,ge.final).map(l=>({...l,layout:de.find(d=>d.id===l.layout)||de[0]}));return ro(r)}let t=[];(s.has_cover_image===!0||s.has_cover_image===1)&&(t=t.concat(ge.cover)),t=t.concat(ge.content),(s.has_back_cover_image===!0||s.has_back_cover_image===1)&&(t=t.concat(ge.final)),console.log("üì§ [EDITOR-TO-MODAL] Enviando p√°ginas filtradas:",{total:t.length,types:t.map(r=>r.type),itemConfig:{has_cover_image:s.has_cover_image,has_back_cover_image:s.has_back_cover_image}});const a=t.map(r=>({...r,layout:de.find(l=>l.id===r.layout)||de[0]}));return ro(a)})(),pageThumbnails:(()=>{if(!s)return console.warn("‚ö†Ô∏è [EDITOR-TO-MODAL] itemData no disponible para filtrar thumbnails"),ae;const t={};let a=[];return(s.has_cover_image===!0||s.has_cover_image===1)&&(a=a.concat(ge.cover.map(r=>r.id))),a=a.concat(ge.content.map(r=>r.id)),(s.has_back_cover_image===!0||s.has_back_cover_image===1)&&(a=a.concat(ge.final.map(r=>r.id))),a.forEach(r=>{ae[r]&&(t[r]=ae[r])}),console.log("üñºÔ∏è [EDITOR-TO-MODAL] Enviando thumbnails filtrados:",{totalThumbnails:Object.keys(t).length,availableThumbnails:Object.keys(ae).length,enabledPageIds:a,filteredThumbnailIds:Object.keys(t)}),t})(),workspaceDimensions:V,getCurrentLayout:t=>t?de.find(a=>a.id===t.layout)||de[0]:de[0],presetData:i,addAlbumToCart:Yn,projectData:o,itemData:s,contentType:me,categorizedPages:ge,albumLoadingState:zn}),Me.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-Me.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:Me.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:Me.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${Me.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[Me.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(pa,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Kn,disabled:Ne<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(oa,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:Qn,disabled:Ne>=Te.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(na,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(o==null?void 0:o.name)||"√Ålbum Sin T√≠tulo",onChange:t=>n({...o,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del dise√±o"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(R.length>0||L)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:L?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",R.length]})]})}),e.jsx(sr,{saveStatus:Re.saveStatus,lastSaved:Re.lastSaved,lastAutoSaved:Re.lastAutoSaved,hasUnsavedChanges:v.hasUnsavedChanges||!!(j instanceof Map&&j.has(x)),isOnline:Re.isOnline,saveError:Re.saveError,onManualSave:eo,saveQueueSize:R.length,isProcessingQueue:L,pageChangesCount:j instanceof Map?j.size:0}),R.length>0&&e.jsxs("button",{onClick:()=>{console.log("üîß [DEBUG] Procesando cola manualmente"),Ct()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(xn,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(lt,{id:"preview-button",variant:"secondary",size:"sm",onClick:async t=>{t.preventDefault(),t.stopPropagation();try{console.log(`üé≠ [${me.type.toUpperCase()}-EXPERIENCE] Iniciando experiencia de ${me.name.toLowerCase()}...`),console.log("üíæ [AUTO-SAVE] Guardando cambios antes de abrir preview..."),we({isOpen:!0,phase:"saving",progress:0,message:"üíæ Guardando cambios",subMessage:"Asegurando que todo est√© actualizado..."});try{await eo(),console.log("‚úÖ [AUTO-SAVE] Guardado completado exitosamente"),we(c=>({...c,progress:15,message:"‚úÖ Cambios guardados",subMessage:"Preparando vista previa..."})),await new Promise(c=>setTimeout(c,500))}catch(c){console.error("‚ùå [AUTO-SAVE] Error al guardar:",c),we(p=>({...p,progress:10,message:"‚ö†Ô∏è Guardado parcial",subMessage:"Continuando con vista previa..."})),await new Promise(p=>setTimeout(p,300))}we(c=>({...c,phase:"preparing",progress:15,message:`${me.icon} Creando tu ${me.name.toLowerCase()}`,subMessage:me.type==="album"?"Preparando la experiencia completa de tu √°lbum...":me.type==="catalog"?"Organizando tu cat√°logo de contenido...":me.type==="booklet"?"Preparando tu folleto personalizado...":"Optimizando tu dise√±o √∫nico..."}));const a=me.type==="album"?["üîß Encuadernando p√°ginas","üìñ Ajustando tapas","‚ú® Puliendo detalles"]:me.type==="catalog"?["üìë Organizando contenido","üé® Optimizando dise√±o","‚ö° Finalizando cat√°logo"]:me.type==="booklet"?["üìã Preparando folleto","üñºÔ∏è Ajustando formato","‚ú® Aplicando estilo"]:["üé® Procesando dise√±o","‚ö° Optimizando calidad","‚ú® Finalizando vista"];for(let c=15;c<=30;c+=3){await new Promise(C=>setTimeout(C,me.type==="card"?50:100));const p=Math.floor((c-15)/15*a.length);we(C=>({...C,progress:c,message:a[Math.min(p,a.length-1)],subMessage:`Progreso: ${c}% - Optimizando para mejor experiencia...`}))}we(c=>({...c,phase:"processing",message:`üì∑ Procesando ${me.name.toLowerCase()}`,subMessage:"Generando vistas de alta calidad..."}));const r=await Ln((c,p)=>{const C=30+c/p*50;we(M=>({...M,progress:Math.round(C),subMessage:`Procesando imagen ${c} de ${p}...`}))}),d={album:{message:"üìñ Encuadernando √°lbum",sub:"Creando experiencia premium de lectura..."},catalog:{message:"üìë Organizando cat√°logo",sub:"Preparando navegaci√≥n fluida..."},booklet:{message:"üìã Finalizando folleto",sub:"Ajustando formato profesional..."},card:{message:"üé® Puliendo dise√±o",sub:"Aplicando toques finales..."}}[me.type];we(c=>({...c,phase:"finalizing",message:d.message,subMessage:d.sub}));for(let c=80;c<=100;c+=4)await new Promise(p=>setTimeout(p,me.type==="card"?40:80)),we(p=>({...p,progress:c}));const h={album:{message:"üìñ ¬°Tu √°lbum est√° listo!",sub:"Experiencia completa de lectura preparada"},catalog:{message:"üìë ¬°Tu cat√°logo est√° listo!",sub:"Navegaci√≥n profesional activada"},booklet:{message:"üìã ¬°Tu folleto est√° listo!",sub:"Formato profesional completado"},card:{message:"üé® ¬°Tu dise√±o est√° listo!",sub:"Vista previa perfecta creada"}}[me.type];we(c=>({...c,phase:"ready",progress:100,message:h.message,subMessage:h.sub})),await new Promise(c=>setTimeout(c,1e3)),we(c=>({...c,isOpen:!1})),se(c=>({...c,...r})),setTimeout(()=>{Yt(!0),console.log(`‚úÖ [${me.type.toUpperCase()}-EXPERIENCE] Experiencia de ${me.name.toLowerCase()} completada`)},300)}catch(a){console.error(`‚ùå [${me.type.toUpperCase()}-EXPERIENCE] Error en experiencia:`,a),we(r=>({...r,message:"‚ö†Ô∏è Ups, algo sali√≥ mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{we(r=>({...r,isOpen:!1}))},2e3)}},disabled:Me.isOpen,icon:e.jsx(gt,{className:"h-4 w-4"}),children:Me.isOpen?`Creando ${me.name.toLowerCase()}...`:me.description}),e.jsxs("button",{onClick:Pn,className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200",title:"Inicia la gu√≠a paso a paso",children:[e.jsx(Ea,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"})]})]})]})}),e.jsxs("div",{className:`flex h-full ${B?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>pe("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${J==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(gt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"P√°ginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>pe("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${J==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Rt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Dise√±os"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>pe("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${J==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(ht,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>pe("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${J==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(pn,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[J==="templates"&&"Templates",J==="images"&&"Images",J==="text"&&"Text",J==="shapes"&&"Shapes",J==="stickers"&&"Stickers",J==="pages"&&"Pages",J==="panel"&&"Layers Panel",J==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[J==="templates"&&"Choose a template to get started",J==="images"&&"Search for images",J==="text"&&"Add and edit text",J==="shapes"&&"Add shapes and graphics",J==="stickers"&&"Add fun stickers",J==="pages"&&"Manage your pages",J==="panel"&&"Organize layers and z-index",J==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(Ta,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[J==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Rt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(ka,{currentLayoutId:(ho=u[x])==null?void 0:ho.layout,onLayoutChange:Wn})]}),J==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(He,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Im√°genes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[je.length," imagen",je.length!==1?"s":""]})]}),e.jsx(lr,{images:je,onImageSelect:Vn,isLoading:bt})]}),J==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>Nt("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"T√≠tulo Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(mt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Nt("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subt√≠tulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(mt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Nt("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(mt,{className:"h-4 w-4"})})]})})]}),J==="text"&&B&&((po=oe())==null?void 0:po.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(Aa,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=oe();he(D,B,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((bo=(fo=oe())==null?void 0:fo.style)==null?void 0:bo.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=oe();he(D,B,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((vo=(xo=oe())==null?void 0:xo.style)==null?void 0:vo.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=oe();he(D,B,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((yo=(wo=oe())==null?void 0:wo.style)==null?void 0:yo.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipograf√≠a:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Co=(Eo=oe())==null?void 0:Eo.style)==null?void 0:Co.fontFamily)||"Arial",onChange:t=>{const a=oe();he(D,B,{style:{...a.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tama√±o:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((No=(To=oe())==null?void 0:To.style)==null?void 0:No.fontSize)||"16px",onChange:t=>{const a=oe();he(D,B,{style:{...a.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((So=(Ao=oe())==null?void 0:Ao.style)==null?void 0:So.color)||"#000000",onChange:t=>{const a=oe();he(D,B,{style:{...a.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((jo=(Io=oe())==null?void 0:Io.style)==null?void 0:jo.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Ro=(ko=oe())==null?void 0:ko.style)==null?void 0:Ro.backgroundColor)||"#ffffff",onChange:t=>{const a=oe();he(D,B,{style:{...a.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=oe();he(D,B,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"üö´"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var a,r;return e.jsxs("button",{onClick:()=>{const l=oe();he(D,B,{style:{...l.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((r=(a=oe())==null?void 0:a.style)==null?void 0:r.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"‚¨Ö",t==="center"&&"‚¨å",t==="right"&&"‚û°",t==="justify"&&"‚¨ç"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((_o=(Oo=oe())==null?void 0:Oo.style)==null?void 0:_o.lineHeight)||"1.5",onChange:t=>{const a=oe();he(D,B,{style:{...a.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Lo=(Po=oe())==null?void 0:Po.style)==null?void 0:Lo.letterSpacing)||"normal",onChange:t=>{const a=oe();he(D,B,{style:{...a.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=oe();he(D,B,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${(($o=(Mo=oe())==null?void 0:Mo.style)==null?void 0:$o.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAY√öS"]}),e.jsxs("button",{onClick:()=>{const t=oe();he(D,B,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Uo=(Fo=oe())==null?void 0:Fo.style)==null?void 0:Uo.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"min√∫s"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((zo=(Bo=oe())==null?void 0:Bo.style)==null?void 0:zo.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((Go=(Ho=oe())==null?void 0:Ho.style)==null?void 0:Go.opacity)||"1",onChange:t=>{const a=oe();he(D,B,{style:{...a.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((Do=(Vo=oe())==null?void 0:Vo.style)==null?void 0:Do.opacity)||1)*100}%, #e5e7eb ${(((qo=(Wo=oe())==null?void 0:Wo.style)==null?void 0:qo.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),J==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(gt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[u.length," total"]})]})}),Ke&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Ke.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Ke.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Ke.message||`P√°gina: ${Ke.pageId||"actual"}`})]}),u.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando p√°ginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[ge.cover.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),ge.cover.map((t,a)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===u.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Tt(u.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Pt,{pageId:t.id,thumbnail:ae[t.id],altText:"Cover",type:"cover"}),j instanceof Map&&j.has&&j.has(u.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:ge.content.map((t,a)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===u.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>Tt(u.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Pt,{pageId:t.id,thumbnail:ae[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),j instanceof Map&&j.has&&j.has(u.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),ge.final.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),ge.final.map((t,a)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===u.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Tt(u.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(Pt,{pageId:t.id,thumbnail:ae[t.id],altText:"Back Cover",type:"final"}),j instanceof Map&&j.has&&j.has(u.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),J==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(ja,{pages:u,currentPage:x,selectedCell:D,selectedElement:B,onSelectCell:le,onSelectElement:Z,onUpdateElement:(t,a,r)=>{he(t,a,r)},onDeleteElement:(t,a)=>{at(t,a)},onMoveElement:(t,a,r)=>{qn(t,a,r)}})}),J==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(fa,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=oe();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(He,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Ra,{selectedMask:t.mask||"none",onSelect:a=>{he(D,B,{mask:a})},availableMasks:fn.map(a=>a.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(aa,{filters:t.filters||{},onFilterChange:a=>{console.log("üî• [FILTER-CHANGE-IMMEDIATE] APLICANDO FILTROS Y REGENERANDO AHORA!"),he(D,B,{filters:a}),setTimeout(()=>{console.log("üî• [IMMEDIATE-REGEN] Intento 1 de regeneraci√≥n..."),ce(!0)},50),setTimeout(()=>{console.log("üî• [IMMEDIATE-REGEN] Intento 2 de regeneraci√≥n..."),ce(!0)},200),setTimeout(()=>{console.log("üî• [IMMEDIATE-REGEN] Intento 3 de regeneraci√≥n..."),ce(!0)},500)},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(He,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:oe()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>pe("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Rt,{className:"h-4 w-4"}),"Dise√±o de p√°gina"]}),e.jsxs("button",{onClick:()=>pe("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(ht,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(lt,{variant:"ghost",tooltip:"A√±adir Imagen",onClick:()=>yt.current&&yt.current.click(),children:e.jsx(He,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:yt,onChange:Gn,className:"hidden",accept:"image/*"})]}),B&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(lt,{variant:"ghost",size:"sm",onClick:()=>{if(B&&D){const t=oe();if(t){const a={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};Xe(D,a)}}},className:"h-8 px-2",icon:e.jsx(ba,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(lt,{variant:"ghost",size:"sm",onClick:()=>{B&&D&&at(D,B)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(bn,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:`editor-workspace flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100 ${$t?"preview-mode":""}`,children:$t?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:V.width,height:V.height},children:e.jsx("div",{id:`page-${u[x].id}`,className:`grid ${$e().template} gap-6`,style:{width:"100%",height:"100%"},children:u[x].cells.map((t,a)=>{var r;return e.jsx(en,{id:t.id,elements:t.elements.filter(l=>!l.locked),workspaceSize:V,cellStyle:(r=$e().cellStyles)==null?void 0:r[u[x].cells.indexOf(t)],selectedElement:D===t.id?B:null,onSelectElement:so,onAddElement:(l,d)=>Xe(d,l),onUpdateElement:(l,d,g)=>he(t.id,l,d,g),onDeleteElement:l=>at(t.id,l),availableMasks:$e().maskCategories.flatMap(l=>l.masks),projectData:o},t.id)})})})}):e.jsxs("div",{id:`page-${u[x].id}`,className:" shadow-xl overflow-hidden",style:{width:V.width,height:V.height,position:"relative",backgroundColor:((Ko=u[x])==null?void 0:Ko.backgroundColor)||"#ffffff",backgroundImage:(Qo=u[x])!=null&&Qo.backgroundImage?`url(${u[x].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=u[x];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${$e().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((Yo=$e().style)==null?void 0:Yo.gap)||"16px",padding:((Jo=$e().style)==null?void 0:Jo.padding)||"16px"},children:u[x].cells.map(t=>{var a;return e.jsx(en,{id:t.id,elements:t.elements.filter(r=>!r.locked),workspaceSize:V,cellStyle:(a=$e().cellStyles)==null?void 0:a[u[x].cells.indexOf(t)],selectedElement:D===t.id?B:null,onSelectElement:so,onAddElement:(r,l)=>Xe(l,r),onUpdateElement:(r,l,d)=>he(t.id,r,l,d),onDeleteElement:r=>at(t.id,r),availableMasks:$e().maskCategories.flatMap(r=>r.masks),projectData:o},t.id)})})]})})]})]})]}),e.jsx(ca,{})]})}export{gs as default};
