import{j as r}from"./AboutSimple-Cf8x2fCZ.js";import{r as T}from"./index-BH53Isel.js";import"./EditorLayout-3dTmWtvf.js";import"./EditorMain-rmOX089k.js";import{M as Q}from"./PaymentModal-Bxx5p2o_.js";import{H as we}from"./index.es-p8wkj5I3.js";import{G}from"./Global-ErywZRdd.js";import{l as ve,g as Pe}from"./TextElement-t0TJofq8.js";import{X as ie}from"./x-DBMwyD6F.js";import{C as Ne}from"./chevron-left-B2s3ZsB7.js";import{C as je}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./index-BSWw-p5k.js";import"./createLucideIcon-Cy5Ya80P.js";import"./copy-6OEekgvq.js";import"./trash-2-DK1wnsDn.js";const ne={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},ke=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;Q.setAppElement("#app");const Xe=({isOpen:u,onRequestClose:I,pages:m,pageThumbnails:w={},addAlbumToCart:z,workspaceDimensions:$={width:800,height:600},layouts:q=[],presetData:le=null})=>{const[V,se]=T.useState(0),[L,ee]=T.useState(!1),[ce,D]=T.useState({}),[de,te]=T.useState(!1),B=T.useRef();function oe(e,t,l,o,s,a){const d=t.width,f=t.height,v=s/a,c=d/f;let g=0,N=0,i=d,n=f;v>c?(n=d/v,N=(f-n)/2):(i=f*v,g=(d-i)/2),e.drawImage(t,g,N,i,n,l,o,s,a)}function ge(e){const t=e.match(/grid-cols-(\d+)/),l=e.match(/grid-rows-(\d+)/),o=e.match(/gap-(\d+)/);return{cols:t?parseInt(t[1],10):1,rows:l?parseInt(l[1],10):1,gap:o?parseInt(o[1],10)*4:0}}function re(e,t,l=1){const o=e&&e.match(new RegExp(`${t}-span-(\\d+)`));return o?parseInt(o[1],10):l}function he(e,t,l){const{cols:o,rows:s,gap:a}=ge(e.template),d=e.style&&e.style.padding?parseInt(e.style.padding):0,f=t.width-2*d,v=t.height-2*d,c=(f-a*(o-1))/o,g=(v-a*(s-1))/s,N=Array.from({length:s},()=>Array(o).fill(!1)),i={};for(let n=0;n<e.cells;n++){const _=e.cellStyles&&e.cellStyles[n]?e.cellStyles[n]:"",R=re(_,"col",1),b=re(_,"row",1);let j=!1;for(let x=0;x<=s-b&&!j;x++)for(let C=0;C<=o-R&&!j;C++){let H=!0;for(let y=x;y<x+b;y++){for(let p=C;p<C+R;p++)if(N[y][p]){H=!1;break}if(!H)break}if(H){for(let p=x;p<x+b;p++)for(let A=C;A<C+R;A++)N[p][A]=!0;const y=l&&l[n]?l[n].id:n;i[y]={x:d+C*(c+a),y:d+x*(g+a),width:c*R+a*(R-1),height:g*b+a*(b-1)},console.log(`[GRID-PLACEMENT] cellId:${y} col-span:${R} row-span:${b} => x:${i[y].x} y:${i[y].y} w:${i[y].width} h:${i[y].height}`),j=!0}}if(!j){const x=l&&l[n]?l[n].id:n;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${x}`),i[x]={x:0,y:0,width:c,height:g}}}return i}const me=T.useCallback(async()=>{if(!m||m.length===0||!u)return;console.log("ğŸš€ Iniciando generaciÃ³n de thumbnails para BookPreview..."),te(!0),D({});const e={},t=4;for(let l=0;l<m.length;l++){const o=m[l],s=document.createElement("canvas"),a=s.getContext("2d");if(s.width=$.width*t,s.height=$.height*t,console.log(`ğŸ”§ [THUMBNAIL] Generando thumbnail para pÃ¡gina ${l} (${o.type})`),o.backgroundImage)try{const c=new Image;c.crossOrigin="anonymous",await new Promise((g,N)=>{c.onload=()=>{oe(a,c,0,0,s.width,s.height),g()},c.onerror=()=>{a.fillStyle=o.backgroundColor||"#ffffff",a.fillRect(0,0,s.width,s.height),g()},c.src=o.backgroundImage})}catch{a.fillStyle=o.backgroundColor||"#ffffff",a.fillRect(0,0,s.width,s.height)}else a.fillStyle=o.backgroundColor||"#ffffff",a.fillRect(0,0,s.width,s.height);const d=q.find(c=>c.id===o.layout);console.log(`ğŸ”§ [THUMBNAIL] Looking for layout: ${o.layout}, found:`,!!d);let f={};if(d)f=he(d,{width:$.width*t,height:$.height*t},o.cells);else{console.warn(`âš ï¸ [THUMBNAIL] Layout not found for page ${l}:`,o.layout);for(const c of o.cells)f[c.id]={x:0,y:0,width:$.width*t,height:$.height*t}}for(const c of o.cells){const g=f[c.id];if(!g){console.warn(`âš ï¸ [THUMBNAIL] Cell position not found for cell: ${c.id}`);continue}console.log(`ğŸ”§ [THUMBNAIL] Processing cell ${c.id} with ${c.elements.length} elements`);const N=c.elements.sort((i,n)=>(i.zIndex||0)-(n.zIndex||0));for(const i of N){console.log(`ğŸ”§ [THUMBNAIL] Drawing element ${i.id} (${i.type}): "${i.content}"`);const n=i.position||{x:0,y:0},_=g.x/t,R=g.y/t,b=g.width/t,j=g.height/t,x=n.x!==void 0&&Math.abs(n.x)<=1,C=n.y!==void 0&&Math.abs(n.y)<=1,H=x?n.x*b:n.x||0,y=C?n.y*j:n.y||0,p=_+H,A=R+y;if(i.type==="image"&&i.content)try{const P=new Image;P.crossOrigin="anonymous",await new Promise((h,E)=>{P.onload=()=>{const k=i.size||{},Y=k.width!==void 0&&k.width<=1,S=k.height!==void 0&&k.height<=1,F=Y?k.width*b:k.width||b*.8,W=S?k.height*j:k.height||j*.8;oe(a,P,p*t,A*t,F*t,W*t),console.log(`âœ… [THUMBNAIL] Image element drawn: ${i.id} at (${p}, ${A}) size (${F}, ${W})`),h()},P.onerror=()=>{console.error("âŒ [THUMBNAIL] Failed to load image element:",i.content),h()},P.src=i.content})}catch(P){console.error("âŒ [THUMBNAIL] Error loading image element:",P)}else if(i.type==="text"&&i.content){console.log(`ğŸ”§ [THUMBNAIL] Drawing text element: "${i.content}" at relative pos (${n.x}, ${n.y})`);const P=i.style||{};P.fontFamily&&await ve(P.fontFamily);const h=Pe(P,t);a.save(),a.font=`${h.fontWeight} ${h.fontStyle} ${h.fontSize} ${h.fontFamily}`,a.fillStyle=h.color,a.textAlign=h.textAlign,a.textBaseline="top";const E=i.size||{},k=E.width!==void 0&&E.width<=1,Y=E.height!==void 0&&E.height<=1,S=k?E.width*b:E.width||b*.8,F=Y?E.height*j:E.height||j*.3;h.backgroundColor!=="transparent"&&(a.fillStyle=h.backgroundColor,a.fillRect(p*t,A*t,S*t,F*t),a.fillStyle=h.color);const W=i.content.split(`
`),be=parseInt(h.fontSize)*parseFloat(h.lineHeight);W.forEach((Z,xe)=>{if(Z.trim()){let U,J;const K=p*t,ye=A*t+xe*be;switch(h.textAlign){case"center":U=K+S*t/2;break;case"right":U=K+S*t-(h.padding||0);break;default:U=K+(h.padding||0);break}J=ye+(h.padding||0),console.log(`ğŸ”§ [THUMBNAIL] Drawing line "${Z}" at x=${U}, y=${J}, align=${h.textAlign}`),a.fillText(Z,U,J)}}),a.restore(),console.log(`âœ… [THUMBNAIL] Text element drawn: ${i.id} at (${p}, ${A}) size (${S}, ${F})`)}}}const v=s.toDataURL("image/jpeg",.9);console.log(`ğŸ¯ [THUMBNAIL] Generated thumbnail for page ${l}`),e[l]=v}D(e),te(!1)},[m,u,$,q,le]);T.useEffect(()=>{u&&(Object.keys(w).length===0?me():D(w))},[u,w]),T.useEffect(()=>{u||D({})},[u]);const ae=Object.keys(w).length>0?w:ce;if(!m||!Array.isArray(m)||m.length===0)return r.jsx(Q,{isOpen:u,onRequestClose:I,style:ne,contentLabel:"Vista previa del Ã¡lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:r.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del Ã¡lbum"}),r.jsx("button",{onClick:I,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:r.jsx(ie,{size:24})})]}),r.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay pÃ¡ginas disponibles para mostrar."})]})});const fe=()=>{B.current&&B.current.pageFlip().flipPrev()},ue=()=>{B.current&&B.current.pageFlip().flipNext()},pe=$.width/$.height,M=600,O=Math.round(M*pe),X=(()=>{const e=[],t=[...m.filter(o=>o.type==="cover"),...m.filter(o=>o.type==="content"),...m.filter(o=>o.type==="final")];t.length>0&&(e.push(t[0]),e.push({...t[0],isBack:!0}));for(let o=1;o<t.length-1;o++)e.push(t[o]),o+1<t.length-1?(e.push(t[o+1]),o++):e.push({...t[o],isBack:!0,isEmpty:!0});const l=t.find(o=>o.type==="final");return l&&(e.push({...l,isBack:!0,isEmpty:!0}),e.push(l)),e})();return r.jsxs(Q,{isOpen:u,onRequestClose:I,style:ne,contentLabel:"Vista previa del Ã¡lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[r.jsx("style",{dangerouslySetInnerHTML:{__html:ke}}),de&&r.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),r.jsx("p",{className:"text-gray-700",children:"Generando vistas previas de alta calidad..."}),r.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})}),r.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[r.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del Ã¡lbum"}),r.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las pÃ¡ginas de su Ã¡lbum usando los controles de navegaciÃ³n o teclado. Puede cerrar esta ventana presionando Escape o el botÃ³n de cerrar."}),r.jsx("button",{onClick:I,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del Ã¡lbum",children:r.jsx(ie,{className:"h-6 w-6"})}),r.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[r.jsx("button",{onClick:fe,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"PÃ¡gina anterior",children:r.jsx(Ne,{className:"h-6 w-6"})}),r.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const e=X[V];return e?e.isBack&&e.isEmpty?"Reverso":e.isBack?"Reverso de la pÃ¡gina":e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`PÃ¡gina ${e.pageNumber||Math.ceil((V+1)/2)}`:"Cargando..."})(),r.jsx("span",{className:"mx-2 text-gray-400",children:"â€¢"}),Math.ceil((V+1)/2)," / ",Math.ceil(X.length/2)," hojas"]}),r.jsx("button",{onClick:ue,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"PÃ¡gina siguiente",children:r.jsx(je,{className:"h-6 w-6"})})]}),r.jsx("div",{className:"flex items-center justify-center",children:r.jsx(we,{ref:B,width:O,height:M,size:"stretch",minWidth:O*.7,maxWidth:O*1.3,minHeight:M*.7,maxHeight:M*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:e=>se(e.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:X.map((e,t)=>r.jsx("div",{id:`page-${e.id}`,className:"page-container",style:{width:O,height:M,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:r.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:e.isEmpty||e.isBack?r.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:e.isBack?"Reverso":""}):ae[e.id]?r.jsx("img",{src:ae[e.id],alt:`${e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`PÃ¡gina ${e.pageNumber||t+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):r.jsx($e,{page:e,pageIdx:t})})},`page-${t}`))})})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-md mx-auto",children:[r.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${L?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var e,t,l;if(!L){ee(!0);try{if(console.log("ğŸš€ Iniciando proceso de compra con generaciÃ³n de PDF..."),typeof z!="function"){console.error("âŒ addAlbumToCart no es una funciÃ³n"),console.log("addAlbumToCart type:",typeof z),console.log("addAlbumToCart value:",z),alert("Error: FunciÃ³n de carrito no disponible. IntÃ©ntelo nuevamente.");return}if(typeof window.finalizeAlbumDesign=="function"){console.log("ğŸ“„ Finalizando diseÃ±o del Ã¡lbum...");const o=await window.finalizeAlbumDesign();if(console.log("ğŸ“„ Resultado de finalizeAlbumDesign:",o),o){if(console.log("ğŸ“„ Generando PDF del Ã¡lbum..."),typeof window.generateAlbumPDF=="function")try{const a=await window.generateAlbumPDF();console.log("ğŸ“„ PDF generado exitosamente:",a),console.log("ğŸ’¾ Guardando PDF en el servidor...");const d=window.currentAlbumUuid||window.albumUuid;if(!d)throw new Error("No se encontrÃ³ el UUID del Ã¡lbum");const f=await new Promise((g,N)=>{const i=new FileReader;i.onload=()=>{const n=i.result.split(",")[1];g(n)},i.onerror=N,i.readAsDataURL(a)}),v=await fetch(`/api/albums/${d}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"))||""},body:JSON.stringify({pdf_blob:f})});if(!v.ok){const g=await v.json();throw new Error(g.message||"Error al guardar el PDF en el servidor")}const c=await v.json();console.log("ğŸ’¾ PDF guardado en servidor:",c)}catch(a){console.error("âŒ Error generando/guardando PDF:",a),console.log("âš ï¸ Continuando sin PDF...")}else console.warn("âš ï¸ window.generateAlbumPDF no estÃ¡ disponible, continuando sin PDF...");console.log("ğŸ“¦ Agregando Ã¡lbum al carrito...");const s=z();if(console.log("ğŸ“¦ Resultado de addAlbumToCart:",s),s){console.log("âœ… Ãlbum agregado al carrito exitosamente");try{await new Promise(f=>setTimeout(f,200));const a=JSON.parse(localStorage.getItem(`${((t=window.Global)==null?void 0:t.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");console.log("ğŸ” VerificaciÃ³n final del carrito:",a),console.log("ğŸ” Longitud del carrito:",a.length),a.length===0&&console.error("âŒ ADVERTENCIA: El carrito parece vacÃ­o despuÃ©s de agregar");const d=`${G.APP_URL}/cart`;console.log("ğŸ”„ Redirigiendo al carrito..."),console.log("ğŸ”„ URL del carrito:",d),window.location.href=d}catch(a){console.error("âš ï¸ Error durante verificaciÃ³n o redirecciÃ³n:",a),console.log("ğŸ”„ Intentando redirecciÃ³n directa...");const d=`${G.APP_URL}/cart`;console.log("ğŸ”„ Redirigiendo al carrito..."),console.log("ğŸ”„ URL del carrito:",d),window.location.href=d}}else console.error("âŒ No se pudo agregar al carrito"),alert("Error al agregar el Ã¡lbum al carrito. Revise la consola para mÃ¡s detalles.")}else console.error("âŒ No se pudo finalizar el diseÃ±o del Ã¡lbum"),alert("Error al finalizar el diseÃ±o del Ã¡lbum. IntÃ©ntelo nuevamente.")}else console.error("âŒ window.finalizeAlbumDesign no estÃ¡ disponible"),alert("Funcionalidad de finalizaciÃ³n de diseÃ±o pendiente de implementar.")}catch(o){console.error("âŒ === ERROR DURANTE PROCESO DE COMPRA ==="),console.error("Tipo de error:",o.name),console.error("Mensaje:",o.message),console.error("Stack trace:",o.stack),console.error("Error completo:",o);try{const s=JSON.parse(localStorage.getItem(`${((l=G)==null?void 0:l.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");if(console.log("ğŸ” Verificando carrito despuÃ©s del error:",s.length>0?"HAY ITEMS":"VACÃO"),s.length>0){console.log("âœ… El carrito tiene items, redirigiendo de todas formas...");const a=`${G.APP_URL}/cart`;console.log("ğŸ”„ Redirigiendo al carrito..."),console.log("ğŸ”„ URL del carrito:",a),window.location.href=a;return}}catch(s){console.error("âŒ Error durante intento de recuperaciÃ³n:",s)}alert(`Error durante el proceso: ${o.message}. Si el Ã¡lbum se agregÃ³ al carrito, puede ir manualmente a la pÃ¡gina del carrito.`)}finally{ee(!1)}}},disabled:L,children:L?r.jsxs(r.Fragment,{children:[r.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):"Comprar ahora"}),r.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:I,disabled:L,children:"Continuar editando"})]}),"        "]})},$e=({page:u,pageIdx:I})=>{let m="",w="";switch(u.type){case"cover":m="Portada",w="ğŸ“š";break;case"final":m="Contraportada",w="ğŸ“–";break;case"content":m=`PÃ¡gina ${u.pageNumber||I+1}`,w="ğŸ“„";break;default:m=`PÃ¡gina ${I+1}`,w="ğŸ“„"}return r.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[r.jsx("div",{className:"text-6xl mb-4",children:w}),r.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:m}),r.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),u.layout&&r.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",u.layout.name||"Personalizado"]})]})};export{Xe as B};
