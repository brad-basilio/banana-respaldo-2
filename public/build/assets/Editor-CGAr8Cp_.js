const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as no}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as d,R as mt}from"./index-BH53Isel.js";import{T as Ts,l as ae,i as Os,a as ao,D as ro,H as io,U as lo,R as co,B as Be,F as go,E as Ns}from"./EditableCell-B3uFPs_m.js";import{h as Ss}from"./thumbnailGenerator-B4goYG9Y.js";import{L as Qe}from"./layers-6oegOx-p.js";import{C as uo}from"./chevron-down-DS-mdh9v.js";import{C as ho}from"./chevron-right-Ckt5D2ka.js";import{E as mo}from"./eye-CKCH9ORv.js";import{c as me}from"./createLucideIcon-Cy5Ya80P.js";import{T as ft}from"./trash-2-DK1wnsDn.js";import{S as fo}from"./star-wPQTHY_n.js";import{I as Ie}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as Z,T as po}from"./index-BZYhE2TF.js";import{m as Cs}from"./main-6DCdASTx.js";import{B as xo}from"./V1Edit-CNtDxOEt.js";import{G as As}from"./Global-ErywZRdd.js";import{S as Rs,F as bo}from"./save-BfW-kI1U.js";import{C as yo}from"./clock-BTrEpQej.js";import{C as Ms}from"./check-DQ7QoS0v.js";import{L as vo}from"./loader-circle-CrvBvIt1.js";import{B as qe}from"./dom-to-image-more.min-Cey65QPP.js";import{C as wo}from"./chevron-left-B2s3ZsB7.js";import{U as Eo}from"./user-BvYmyGTY.js";import{F as ks}from"./filter-Ci9tsc_e.js";import{P as Ke}from"./plus-Bot15Khs.js";import{C as jo}from"./copy-6OEekgvq.js";import{C as No}from"./circle-check-big-D6DM3vPb.js";import{u as So}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-Bxx5p2o_.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./download-Dh5rRDOT.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Co=me("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ao=me("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ko=me("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Io=me("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Po=me("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const To=me("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=me("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oo=me("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ro=me("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ls=me("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=me("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mo=me("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Lo=({pages:n,currentPage:h,selectedCell:g,selectedElement:S,onSelectCell:r,onSelectElement:f,onUpdateElement:y,onDeleteElement:v,onMoveElement:O})=>{var V;if(!n||!n[h])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Qe,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const x=n[h],N=((V=x==null?void 0:x.cells)==null?void 0:V.filter(I=>I.elements&&I.elements.length>0))||[],[T,F]=d.useState(()=>{const I={};return N.forEach(z=>{I[z.id]=!0}),I}),K=I=>{F(z=>({...z,[I]:!z[I]}))},R=I=>{switch(I){case"image":return e.jsx(Ie,{className:"h-4 w-4"});case"text":return e.jsx(Ts,{className:"h-4 w-4"});case"shape":return e.jsx(Ro,{className:"h-4 w-4"});case"sticker":return e.jsx(fo,{className:"h-4 w-4"});default:return e.jsx(Io,{className:"h-4 w-4"})}},U=(I,z)=>{switch(I.type){case"text":return I.content?I.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${z+1}`;case"shape":return I.shape||"Shape";case"sticker":return`Sticker ${z+1}`;default:return`Element ${z+1}`}},L=(I,z,se)=>{y(I,z,{visible:se})},q=(I,z)=>{r(I),f(z)};return e.jsx("div",{className:"space-y-2",children:N.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Qe,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):N.map(I=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${g===I.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{K(I.id),r(I.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:T[I.id]?e.jsx(uo,{className:"h-4 w-4"}):e.jsx(ho,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",I.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[I.elements.length," element",I.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[I.x,", ",I.y]})]}),T[I.id]&&e.jsx("div",{className:"border-t border-gray-100",children:I.elements.map((z,se)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${S===z.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>q(I.id,z.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:R(z.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:U(z,se)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[z.type," • Layer ",se+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:oe=>{oe.stopPropagation(),L(I.id,z.id,!z.visible)},className:"p-1 hover:bg-gray-200 rounded",title:z.visible?"Hide element":"Show element",children:z.visible!==!1?e.jsx(mo,{className:"h-3 w-3 text-gray-500"}):e.jsx(To,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:oe=>{oe.stopPropagation(),O(I.id,z.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:se===I.elements.length-1,children:e.jsx(Ao,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:oe=>{oe.stopPropagation(),O(I.id,z.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:se===0,children:e.jsx(Co,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:oe=>{oe.stopPropagation(),v(I.id,z.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(ft,{className:"h-3 w-3"})})]})]},z.id))})]},I.id))})};function Uo({currentLayoutId:n,onLayoutChange:h}){const[g,S]=d.useState("all"),r={all:{name:"Todos",layouts:ae},hero:{name:"Hero",layouts:ae.filter(f=>f.category==="hero")},editorial:{name:"Editorial",layouts:ae.filter(f=>f.category==="editorial")},storytelling:{name:"Historia",layouts:ae.filter(f=>f.category==="storytelling")},minimal:{name:"Minimal",layouts:ae.filter(f=>f.category==="minimal")},creative:{name:"Creativo",layouts:ae.filter(f=>f.category==="creative")},classic:{name:"Clásico",layouts:ae.filter(f=>f.category==="classic")}};return Object.keys(r).filter(f=>f==="all"||r[f].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:r[g].layouts.map(f=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>h(f.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${f.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:f.cells}).map((y,v)=>{var O,x;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(x=(O=f.cellStyles)==null?void 0:O[v])!=null&&x.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},v)})}),n===f.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:f.name}),f.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:f.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[f.cells," ",f.cells===1?"celda":"celdas"]})})]})]},f.id))}),r[g].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categoría."})})]})}const $o=({selectedMask:n,onSelect:h,availableMasks:g=[],selectedImage:S})=>{var v,O;const[r,f]=d.useState("Básicas"),y={};return Os.forEach(x=>{y[x.category]||(y[x.category]=[]),(g.includes(x.id)||x.id==="none")&&y[x.category].push(x)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(y).slice(0,2).map(x=>y[x].length>0&&e.jsx("button",{onClick:()=>f(x),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${r===x?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:x},x))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(v=y[r])==null?void 0:v.slice(0,6).map(x=>e.jsxs("div",{onClick:()=>h(x.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${n===x.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:S!=null&&S.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:S.content,alt:x.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:x.name})]},x.id))}),((O=y[r])==null?void 0:O.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver más máscaras (",y[r].length-6," más)"]})]})};function _o(n,h){var T,F,K,R;const g=parseInt((F=(T=n.style)==null?void 0:T.gap)==null?void 0:F.replace("px",""))||16,S=parseInt((R=(K=n.style)==null?void 0:K.padding)==null?void 0:R.replace("px",""))||16,r=U=>{const L=U.match(/grid-cols-(\d+)/),q=U.match(/grid-rows-(\d+)/),V=L?parseInt(L[1]):1,I=q?parseInt(q[1]):1;return{cols:V,rows:I}},{cols:f,rows:y}=r(n.template),v=h.width-2*S,O=h.height-2*S,x=(v-g*(f-1))/f,N=(O-g*(y-1))/y;return console.log("🎯 [WORKSPACE REPLICA] Grid simulation:",{template:n.template,cols:f,rows:y,gap:g,padding:S,workspace:h,cellSize:{width:x,height:N}}),{cols:f,rows:y,gap:g,padding:S,cellWidth:x,cellHeight:N,contentX:S,contentY:S}}function Us(n,h,g,S,r,f){if(!h||!n||r<=0||f<=0)return;const y=h.width/h.height,v=r/f;let O,x,N,T;y>v?(T=h.height,N=T*v,O=(h.width-N)/2,x=0):(N=h.width,T=N/v,O=0,x=(h.height-T)/2),n.save(),n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high";try{n.drawImage(h,Math.max(0,O),Math.max(0,x),Math.min(N,h.width-Math.max(0,O)),Math.min(T,h.height-Math.max(0,x)),g,S,r,f)}catch(F){console.error("Error dibujando imagen:",F)}n.restore()}function zo(n,h,g,S,r,f){return new Promise(async y=>{try{const v=new Image;v.crossOrigin="anonymous",v.onload=()=>{var L,q,V,I;const O=((L=h.position)==null?void 0:L.x)||0,x=((q=h.position)==null?void 0:q.y)||0,N=O>=0&&O<=1,T=x>=0&&x<=1,F=g+(N?O*r:O),K=S+(T?x*f:x),R=(V=h.size)!=null&&V.width?h.size.width<=1?h.size.width*r:h.size.width:r,U=(I=h.size)!=null&&I.height?h.size.height<=1?h.size.height*f:h.size.height:f;console.log("🖼️ [WORKSPACE REPLICA] Imagen:",{id:h.id,cellPos:{x:g,y:S,width:r,height:f},elementPos:{x:F,y:K,width:R,height:U},originalPos:{x:O,y:x},isRelative:{x:N,y:T}}),h.filters&&(n.filter=`
                        brightness(${(h.filters.brightness||100)/100})
                        contrast(${(h.filters.contrast||100)/100})
                        saturate(${(h.filters.saturation||100)/100})
                        blur(${h.filters.blur||0}px)
                        opacity(${(h.filters.opacity||100)/100})
                    `),Us(n,v,F,K,R,U),n.filter="none",y()},v.onerror=()=>{console.error("Error cargando imagen:",h.content),y()},v.src=h.content}catch(v){console.error("Error en renderImageElement:",v),y()}})}function Fo(n,h,g,S,r,f){var y,v,O,x;try{const N=((y=h.position)==null?void 0:y.x)||0,T=((v=h.position)==null?void 0:v.y)||0,F=N>=0&&N<=1,K=T>=0&&T<=1,R=g+(F?N*r:N),U=S+(K?T*f:T),L=(O=h.size)!=null&&O.width?h.size.width<=1?h.size.width*r:h.size.width:r*.8,q=(x=h.size)!=null&&x.height?h.size.height<=1?h.size.height*f:h.size.height:f*.2;console.log("📝 [WORKSPACE REPLICA] Texto:",{id:h.id,content:h.content,cellPos:{x:g,y:S,width:r,height:f},elementPos:{x:R,y:U,width:L,height:q}});const V=h.style||{},I=parseInt(V.fontSize)||16,z=V.fontFamily||"Arial, sans-serif",se=V.fontWeight||"normal",oe=V.fontStyle||"normal",D=V.color||"#000000",l=V.textAlign||"left",le=V.backgroundColor,c=parseInt(V.padding)||8;n.save(),n.font=`${se} ${oe} ${I}px ${z}`,n.fillStyle=D,n.textBaseline="top",le&&le!=="transparent"&&(n.fillStyle=le,n.fillRect(R,U,L,q),n.fillStyle=D);const ee=h.content.split(`
`),he=I*1.2;ee.forEach((Ee,W)=>{if(Ee.trim()){let de=R+c;const A=U+c+W*he;l==="center"?(de=R+L/2,n.textAlign="center"):l==="right"?(de=R+L-c,n.textAlign="right"):n.textAlign="left",de>=0&&A>=0&&de<n.canvas.width&&A<n.canvas.height&&n.fillText(Ee,de,A)}}),n.restore()}catch(N){console.error("Error en renderTextElement:",N)}}async function Vo({pages:n,workspaceDimensions:h,presetData:g}){var r;const S={};console.log("🎯 [WORKSPACE REPLICA] Iniciando generación IDÉNTICA al workspace..."),console.log("📐 [WORKSPACE REPLICA] Dimensiones:",h);for(const f of n)try{console.log(`🔄 [WORKSPACE REPLICA] Procesando página: ${f.id} (${f.type})`);const y=document.createElement("canvas"),v=y.getContext("2d",{willReadFrequently:!0});y.width=h.width,y.height=h.height,v.imageSmoothingEnabled=!0,v.imageSmoothingQuality="high",v.textRendering="geometricPrecision",console.log("🎨 [WORKSPACE REPLICA] Renderizando background...");const O=f.backgroundColor||"#ffffff";if(v.fillStyle=O,v.fillRect(0,0,y.width,y.height),console.log("🎨 [WORKSPACE REPLICA] Background color aplicado:",O),f.backgroundImage)try{console.log("🖼️ [WORKSPACE REPLICA] Cargando background image:",f.backgroundImage);const U=new Image;U.crossOrigin="anonymous",await new Promise((L,q)=>{U.onload=L,U.onerror=q,U.src=f.backgroundImage}),Us(v,U,0,0,y.width,y.height),console.log("✅ [WORKSPACE REPLICA] Background image aplicada")}catch(U){console.error("❌ [WORKSPACE REPLICA] Error con background image:",U)}console.log("🗂️ [WORKSPACE REPLICA] Renderizando grid layout...");const x=ae.find(U=>U.id===f.layout)||ae[0];console.log("📋 [WORKSPACE REPLICA] Layout actual:",x.name,x.template);const N=_o(x,h);if(f.cells&&Array.isArray(f.cells)){console.log(`📦 [WORKSPACE REPLICA] Renderizando ${f.cells.length} celdas...`);const U=[...f.cells].sort((L,q)=>{const V=f.cells.indexOf(L),I=f.cells.indexOf(q);return V-I});for(let L=0;L<U.length;L++){const q=U[L],V=Math.floor(L/N.cols),I=L%N.cols,z=N.contentX+I*(N.cellWidth+N.gap),se=N.contentY+V*(N.cellHeight+N.gap);if(console.log(`📦 [WORKSPACE REPLICA] Celda ${L} (${q.id}):`,{gridPos:{row:V,col:I},realPos:{x:z,y:se,width:N.cellWidth,height:N.cellHeight}}),v.save(),v.fillStyle="transparent",v.fillRect(z,se,N.cellWidth,N.cellHeight),v.restore(),q.elements&&Array.isArray(q.elements)){const oe=[...q.elements].sort((D,l)=>(D.zIndex||0)-(l.zIndex||0));console.log(`🔹 [WORKSPACE REPLICA] Renderizando ${oe.length} elementos en celda ${q.id}`);for(const D of oe){if(D.id==="cover-base"||D.id==="final-base"||(r=D.id)!=null&&r.startsWith("content-base-")){console.log("⏭️ [WORKSPACE REPLICA] Saltando elemento base:",D.id);continue}console.log(`🔸 [WORKSPACE REPLICA] Renderizando elemento: ${D.id} (${D.type})`),D.type==="image"&&D.content?await zo(v,D,z,se,N.cellWidth,N.cellHeight):D.type==="text"&&D.content&&Fo(v,D,z,se,N.cellWidth,N.cellHeight)}}}}console.log("🖼️ [WORKSPACE REPLICA] Generando thumbnail final...");const T=document.createElement("canvas"),F=T.getContext("2d"),K=1200,R=Math.min(K/y.width,K/y.height);T.width=Math.round(y.width*R),T.height=Math.round(y.height*R),F.imageSmoothingEnabled=!0,F.imageSmoothingQuality="high",F.drawImage(y,0,0,y.width,y.height,0,0,T.width,T.height),S[f.id]=T.toDataURL("image/png",.9),console.log(`✅ [WORKSPACE REPLICA] Thumbnail generado para ${f.id} (${f.type}): ${T.width}x${T.height}`),console.log(`📋 [WORKSPACE REPLICA] ID de la página: ${f.id}, Tipo: ${f.type}`)}catch(y){console.error(`❌ [WORKSPACE REPLICA] Error generando thumbnail para página ${f.id}:`,y),S[f.id]=null}return console.log("🎯 [WORKSPACE REPLICA] ¡Generación COMPLETADA! Thumbnails idénticos al workspace."),console.log("📋 [WORKSPACE REPLICA] Thumbnails generados:",Object.keys(S)),console.log("📊 [WORKSPACE REPLICA] Total de thumbnails:",Object.keys(S).length),S}const Wo=async(n,h,g)=>{var S;try{console.log("📤 [SAVE] Subiendo imagen al backend:",h);const[r,f]=n.split(","),y=((S=r.match(/data:image\/(\w+)/))==null?void 0:S[1])||"png",v=new FormData,O=atob(f),x=new Array(O.length);for(let R=0;R<O.length;R++)x[R]=O.charCodeAt(R);const N=new Uint8Array(x),T=new Blob([N],{type:`image/${y}`});v.append("image",T,`element_${h}.${y}`),v.append("project_id",g),v.append("element_id",h);const F=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:v});if(!F.ok)throw new Error("Error al subir imagen al servidor");const K=await F.json();return console.log("✅ [SAVE] Imagen subida exitosamente:",K.url),K.url}catch(r){throw console.error("❌ [SAVE] Error subiendo imagen:",r),r}},Go=async(n,h)=>{var f,y;console.log("🔄 [SAVE] Procesando imágenes para guardado...");const g=[];let S=0,r=0;for(const v of n)for(const O of v.cells||[])for(const x of O.elements||[])x.type==="image"&&((f=x.content)!=null&&f.startsWith("data:image/"))&&S++;console.log(`📊 [SAVE] Total de imágenes base64 a procesar: ${S}`);for(const v of n){const O={...v};O.cells=[];for(const x of v.cells||[]){const N={...x};N.elements=[];for(const T of x.elements||[]){const F={...T};if(T.type==="image"&&((y=T.content)!=null&&y.startsWith("data:image/")))try{const K=await Wo(T.content,T.id,h);F.content=K,F.isUploaded=!0,r++,console.log(`✅ [SAVE] Imagen ${r}/${S} procesada`)}catch(K){console.error("❌ [SAVE] Error procesando imagen:",T.id,K),F.uploadError=K.message}N.elements.push(F)}O.cells.push(N)}g.push(O)}return console.log(`✅ [SAVE] Procesamiento completado: ${r}/${S} imágenes subidas`),g},Bo=async(n,h)=>{var g;try{console.log("🔍 [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:n,thumbnailsCount:Object.keys(h).length});const S=[];for(const[y,v]of Object.entries(h))console.log(`🔍 [DEBUG] Procesando thumbnail para página ${y}:`,{hasData:!!v,isBase64:v&&v.startsWith("data:image/"),dataLength:v?v.length:0}),v&&v.startsWith("data:image/")&&S.push({page_id:y,thumbnail_data:v});if(S.length===0){console.log("ℹ️ [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`🖼️ [THUMBNAILS] Guardando ${S.length} thumbnails como archivos...`),console.log(`🔍 [DEBUG] URL del endpoint: /api/thumbnails/${n}/save-as-files`);const r=await fetch(`/api/thumbnails/${n}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((g=document.querySelector('meta[name="csrf-token"]'))==null?void 0:g.content)||""},credentials:"include",body:JSON.stringify({thumbnails:S})});if(console.log("🔍 [DEBUG] Respuesta del servidor:",{status:r.status,statusText:r.statusText,ok:r.ok}),!r.ok){const y=await r.text();throw console.error("❌ [THUMBNAILS] Error respuesta del servidor:",y),new Error(`Error al guardar thumbnails: ${r.status} ${r.statusText}`)}const f=await r.json();return console.log("✅ [THUMBNAILS] Thumbnails guardados como archivos:",f),f}catch(S){throw console.error("❌ [THUMBNAILS] Error guardando thumbnails:",S),S}},Ps=async(n,h,g,S,r,f,y=!1)=>{try{if(!(h!=null&&h.id))throw new Error("No se encontró el ID del proyecto");console.log(`💾 [SAVE] Iniciando ${y?"auto-guardado":"guardado manual"}...`);let v=n;y||(v=await Go(n,h.id));const O={pages:v,projectInfo:{id:h.id,item_id:g==null?void 0:g.id,title:g==null?void 0:g.title,preset_id:S==null?void 0:S.id},workspace:{width:r.width,height:r.height,scale:r.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:y,totalPages:n.length}},x=y?"save-progress":"save",N=await fetch(`/api/canvas/projects/${h.id}/${x}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:O,thumbnails:f})});if(!N.ok){const F=await N.json().catch(()=>({}));throw new Error(F.message||"Error al guardar el proyecto")}const T=await N.json();if(console.log(`✅ [SAVE] ${y?"Auto-guardado":"Guardado"} exitoso:`,T),!y&&f&&Object.keys(f).length>0){console.log("🖼️ [SAVE] Guardando thumbnails como archivos...");try{await Bo(h.id,f),console.log("✅ [SAVE] Thumbnails guardados como archivos")}catch(F){console.warn("⚠️ [SAVE] Error guardando thumbnails como archivos:",F)}}return{success:!0,data:T}}catch(v){return console.error(`❌ [SAVE] Error en ${y?"auto-guardado":"guardado"}:`,v),{success:!1,error:v.message}}},Ho=(n,h,g,S,r,f)=>{const[y,v]=d.useState("saved"),[O,x]=d.useState(null),[N,T]=d.useState(null),[F,K]=d.useState(null),[R,U]=d.useState(!1),[L,q]=d.useState(navigator.onLine),V=d.useRef(null),I=d.useRef(null),z=d.useRef(null),se=d.useRef(!1),oe=d.useRef(null),D=15e3,l=2e3,le=5e3,c=d.useCallback((A,J)=>{try{const _={pages:A.map(te=>{var Je;return{id:te.id,layout:te.layout,cells:((Je=te.cells)==null?void 0:Je.map(Ye=>{var fe;return{id:Ye.id,elements:((fe=Ye.elements)==null?void 0:fe.map(re=>{var ge;return{id:re.id,type:re.type,content:re.type==="image"&&((ge=re.content)!=null&&ge.startsWith("data:image/"))?`[IMAGE_${re.content.length}]`:re.content,position:re.position,size:re.size,style:re.style,filters:re.filters,rotation:re.rotation}}))||[]}}))||[]}})||[],workspace:{width:J==null?void 0:J.width,height:J==null?void 0:J.height}};return btoa(JSON.stringify(_)).substring(0,32)}catch(_){return console.warn("⚠️ [AUTO-SAVE] Error generando hash:",_),Date.now().toString()}},[]),ee=d.useCallback(()=>`album_editor_autosave_${(h==null?void 0:h.id)||"draft"}`,[h==null?void 0:h.id]),he=d.useCallback(A=>{try{const J=ee(),_={...A,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(J,JSON.stringify(_)),console.log("💾 [AUTO-SAVE] Guardado en localStorage"),!0}catch(J){return console.error("❌ [AUTO-SAVE] Error guardando en localStorage:",J),!1}},[ee]),Ee=d.useCallback(()=>{var A;try{const J=ee(),_=localStorage.getItem(J);if(_){const te=JSON.parse(_);return console.log("📂 [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(A=te.pages)==null?void 0:A.length,savedAt:new Date(te.savedAt).toLocaleString()}),te}}catch(J){console.error("❌ [AUTO-SAVE] Error cargando desde localStorage:",J)}return null},[ee]),W=d.useCallback(async(A=!1)=>{if(se.current&&!A){console.log("⏳ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(h!=null&&h.id)||!n||n.length===0){console.log("⚠️ [AUTO-SAVE] Datos insuficientes para guardar");return}const J=c(n,r);if(!A&&J===z.current){console.log("📊 [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{se.current=!0,v("saving"),K(null);const _={pages:n,projectInfo:{id:h.id,item_id:g==null?void 0:g.id,title:g==null?void 0:g.title,preset_id:S==null?void 0:S.id},workspace:r,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:J}};if(he(_),L){const te=await Ps(n,h,g,S,r,f,!0);if(te.success)z.current=J,T(new Date),v("saved"),U(!1),console.log("✅ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(te.error)}else console.log("� [AUTO-SAVE] Sin conexión, solo guardado en localStorage"),v("pending"),U(!0)}catch(_){console.error("❌ [AUTO-SAVE] Error:",_),K(_.message),v("error"),L&&(oe.current=setTimeout(()=>{console.log("🔄 [AUTO-SAVE] Reintentando guardado..."),W(!0)},le))}finally{se.current=!1}},[n,h,g,S,r,f,c,he,L]),de=d.useCallback(async()=>{try{v("saving");const A=await Ps(n,h,g,S,r,f,!1);if(A.success){const J=c(n,r);z.current=J,x(new Date),v("saved"),U(!1),Z.success("💾 Proyecto guardado exitosamente"),console.log("✅ [MANUAL-SAVE] Guardado manual exitoso")}else K(A.error),v("error"),Z.error(`❌ Error al guardar: ${A.error}`);return A.success}catch(A){return console.error("❌ [MANUAL-SAVE] Error:",A),K(A.message),v("error"),Z.error(`❌ Error inesperado: ${A.message}`),!1}},[n,h,g,S,r,f,c]);return d.useEffect(()=>{if(!(h!=null&&h.id)||!n||n.length===0)return;const A=c(n,r);return z.current&&A!==z.current?(console.log("🔄 [AUTO-SAVE] Cambios detectados, programando guardado..."),U(!0),v("pending"),I.current&&clearTimeout(I.current),I.current=setTimeout(()=>{W()},l)):z.current||(z.current=A),()=>{I.current&&clearTimeout(I.current)}},[n,r,h==null?void 0:h.id,c,W]),d.useEffect(()=>{if(h!=null&&h.id)return V.current&&clearInterval(V.current),V.current=setInterval(()=>{R&&(console.log("⏰ [AUTO-SAVE] Auto-save periódico activado"),W())},D),()=>{V.current&&clearInterval(V.current)}},[h==null?void 0:h.id,R,W]),d.useEffect(()=>{const A=()=>{console.log("🌐 [AUTO-SAVE] Conexión restaurada"),q(!0),R&&setTimeout(()=>W(!0),1e3)},J=()=>{console.log("📴 [AUTO-SAVE] Conexión perdida"),q(!1)};return window.addEventListener("online",A),window.addEventListener("offline",J),()=>{window.removeEventListener("online",A),window.removeEventListener("offline",J)}},[R,W]),d.useEffect(()=>{const A=J=>{if(R){const _={pages:n,projectInfo:{id:h.id},workspace:r,meta:{savedAt:new Date().toISOString()}};return he(_),J.preventDefault(),J.returnValue="¿Estás seguro de salir? Hay cambios sin guardar.","¿Estás seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",A),()=>window.removeEventListener("beforeunload",A)},[R,n,h==null?void 0:h.id,r,he]),d.useEffect(()=>()=>{I.current&&clearTimeout(I.current),V.current&&clearInterval(V.current),oe.current&&clearTimeout(oe.current)},[]),d.useEffect(()=>{F&&(F.includes("max_allowed_packet")||F.includes("data_too_large")?Z.error("❌ El proyecto es demasiado grande para guardar automáticamente. Reduce el número o tamaño de imágenes."):Z.error(`❌ Error de auto-guardado: ${F}`))},[F]),{saveStatus:y,lastSaved:O,lastAutoSaved:N,saveError:F,hasUnsavedChanges:R,isOnline:L,saveManually:de,performAutoSave:()=>W(!0),loadFromLocalStorage:Ee,getStorageKey:ee,autoSaveInterval:D,debounceDelay:l}},qo=({saveStatus:n,lastSaved:h,lastAutoSaved:g,hasUnsavedChanges:S,isOnline:r,saveError:f,onManualSave:y,className:v=""})=>{const O=T=>{if(!T)return null;const K=new Date-T,R=Math.floor(K/(1e3*60)),U=Math.floor(K/1e3);if(U<30)return"hace unos segundos";if(R<1)return`hace ${U}s`;if(R<60)return`hace ${R}m`;const L=Math.floor(R/60);return L<24?`hace ${L}h`:T.toLocaleDateString()},N=(()=>{if(!r)return{icon:e.jsx(Is,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexión",detail:"Guardado local activo"};switch(n){case"saving":return{icon:e.jsx(vo,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(Ms,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:g?`Auto-guardado ${O(g)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(Ls,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:f||"Error desconocido"};case"pending":return{icon:e.jsx(yo,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:S?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(Rs,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${v}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${N.bg} ${N.color}
                    hover:shadow-md
                `,onClick:()=>n!=="saving"&&(y==null?void 0:y()),children:[N.icon,e.jsx("span",{className:"text-sm font-medium",children:N.text}),S&&n!=="saving"&&e.jsx("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-pulse"}),e.jsx("div",{className:"flex items-center",children:r?e.jsx(Mo,{className:"w-3 h-3 text-green-500"}):e.jsx(Is,{className:"w-3 h-3 text-orange-500"})})]}),e.jsxs("div",{className:`
                absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2
                bg-gray-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg
                opacity-0 group-hover:opacity-100 pointer-events-none
                transition-opacity duration-200 z-50 whitespace-nowrap
            `,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:N.text}),e.jsx("div",{className:"text-gray-300",children:N.detail}),h&&e.jsxs("div",{className:"text-gray-400 text-xs",children:["Último guardado manual: ",O(h)]}),e.jsxs("div",{className:"text-gray-400 text-xs",children:[r?"🌐 En línea":"📴 Sin conexión",n!=="saving"&&" • Click para guardar"]})]}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"})]}),n==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},Ko=({isOpen:n,onClose:h,savedProgress:g,onLoadProgress:S,onDiscardProgress:r})=>{var N;const[f,y]=d.useState(!1);if(!n||!g)return null;const v=async()=>{y(!0);try{await S(g),h()}catch(T){console.error("Error cargando progreso:",T)}finally{y(!1)}},O=async()=>{y(!0);try{await r(),h()}catch(T){console.error("Error descartando progreso:",T)}finally{y(!1)}},x=T=>{const F=new Date(T),R=new Date-F,U=Math.floor(R/(1e3*60)),L=Math.floor(U/60),q=Math.floor(L/24);return U<1?"hace unos segundos":U<60?`hace ${U} minutos`:L<24?`hace ${L} horas`:q===1?"ayer":q<7?`hace ${q} días`:F.toLocaleDateString()};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 p-6 border-b border-gray-200",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(ao,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Progreso Guardado Encontrado"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Se encontró un trabajo sin finalizar"})]})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ko,{className:"w-4 h-4 text-gray-400 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Guardado automáticamente"}),e.jsx("div",{className:"text-xs text-gray-500",children:x(g.savedAt)})]})]}),g.pages&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bo,{className:"w-4 h-4 text-gray-400 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[g.pages.length," páginas en progreso"]}),e.jsx("div",{className:"text-xs text-gray-500",children:((N=g.meta)==null?void 0:N.version)||"Versión no especificada"})]})]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ls,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-amber-800",children:[e.jsx("div",{className:"font-medium mb-1",children:"¿Qué te gustaría hacer?"}),e.jsx("div",{className:"text-amber-700",children:"Puedes continuar desde donde lo dejaste o comenzar un nuevo diseño."})]})]})})]}),e.jsxs("div",{className:"flex gap-3 p-6 border-t border-gray-200",children:[e.jsxs("button",{onClick:v,disabled:f,className:`flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium 
                                 flex items-center justify-center gap-2 transition-colors disabled:opacity-50`,children:[f?e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}):e.jsx(Ms,{className:"w-4 h-4"}),"Continuar Editando"]}),e.jsxs("button",{onClick:O,disabled:f,className:`flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2.5 rounded-lg font-medium 
                                 flex items-center justify-center gap-2 transition-colors disabled:opacity-50`,children:[e.jsx(ft,{className:"w-4 h-4"}),"Comenzar de Nuevo"]})]}),e.jsx("button",{onClick:h,className:"absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors",disabled:f,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})};function He(n,h){let g;return function(...r){const f=()=>{clearTimeout(g),n(...r)};clearTimeout(g),g=setTimeout(f,h)}}const ht=mt.memo(({pageId:n,thumbnail:h,altText:g,type:S})=>{const[r,f]=d.useState(!1),[y,v]=d.useState(!1);if(h&&!y)return e.jsxs("div",{className:"relative w-full h-full",children:[!r&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:h,alt:g,className:`w-full h-full object-contain transition-opacity duration-200 ${r?"opacity-100":"opacity-0"}`,onLoad:()=>f(!0),onError:()=>v(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const O=S==="cover"||S==="final"?qe:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((x,N)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},N))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(O,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(n,h)=>n.pageId===h.pageId&&n.thumbnail===h.thumbnail&&n.altText===h.altText&&n.type===h.type),Qo=mt.memo(({images:n,onImageSelect:h,isLoading:g})=>{const S=mt.memo(({image:r})=>{const[f,y]=d.useState(!1),[v,O]=d.useState(!1),[x,N]=d.useState(!1),[{isDragging:T},F]=So(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:r.url},collect:q=>({isDragging:!!q.isDragging()}),end:()=>{setTimeout(()=>N(!1),100)}})),K=r.thumbnail_url||r.url,R=r.url,U=q=>{N(!0),setTimeout(()=>N(!1),500)},L=q=>{if(x||T)return q.preventDefault(),q.stopPropagation(),!1;h(R)};return e.jsxs("div",{ref:F,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${T?"opacity-50 scale-95":""}`,onMouseDown:U,onClick:L,children:[e.jsxs("div",{className:"aspect-square relative",children:[!f&&!v&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),v?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Ie,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:K,alt:r.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${f?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>y(!0),onError:()=>O(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(Ke,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:r.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),r.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return g?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((r,f)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},f))}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ie,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay imágenes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:n.map((r,f)=>e.jsx(S,{image:r},`${r.id||r.url}-${f}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[n.filter(r=>r.has_thumbnail).length," de ",n.length," imágenes optimizadas"]})})]})});function Yn(){var Ut,$t,_t,zt,Ft,Vt,Wt,Gt,Bt,Ht,qt,Kt,Qt,Jt,Yt,Xt,Zt,Dt,es,ts,ss,os,ns,as,rs,is,ls,cs,ds,gs,us,hs,ms,fs,ps,xs,bs,ys,vs,ws;const[n,h]=d.useState(null),[g,S]=d.useState(null),[r,f]=d.useState(null),[y,v]=d.useState(null),[O,x]=d.useState(!0),[N,T]=d.useState(null),[F,K]=d.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[R,U]=d.useState(new Map),[L,q]=d.useState([]),[V,I]=d.useState(!1),z=d.useRef(L),se=d.useRef(R);d.useRef(null),d.useEffect(()=>{z.current=L},[L]),d.useEffect(()=>{se.current=R},[R]),d.useEffect(()=>{(async()=>{var s;try{const a=new URLSearchParams(window.location.search).get("project");if(!a){T("No se encontró el ID del proyecto en la URL"),x(!1);return}const i=await fetch(`/api/canvas/projects/${a}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!i.ok)throw new Error("Error al cargar el proyecto");const u=await i.json();h(u.project),S(u.item),f(u.canvasPreset),v(u.initialProject),x(!1)}catch(o){console.error("❌ Error cargando proyecto:",o),T(o.message),x(!1)}})()},[]);const[oe,D]=d.useState(Cs.Local.get(`${As.APP_CORRELATIVE}_cart`)??[]);d.useEffect(()=>{Cs.Local.set(`${As.APP_CORRELATIVE}_cart`,oe)},[oe]);const[l,le]=d.useState([]),[c,ee]=d.useState(0),[he,Ee]=d.useState("preset"),[W,de]=d.useState(null),[A,J]=d.useState(null),[_,te]=d.useState("pages"),[Je,Ye]=d.useState("basic"),[fe,re]=d.useState([JSON.stringify(l)]),[ge,je]=d.useState(0),[$s,Jo]=d.useState(!1),[Yo,pt]=d.useState(null),[Y,ue]=d.useState({}),[Xo,Zo]=d.useState(!1),[xe,Ne]=d.useState([]),[Xe,xt]=d.useState(!1),[$e,_s]=d.useState(new Map),[Te,zs]=d.useState(()=>new Map),Se=d.useRef(null),[_e,Oe]=d.useState(!1),bt=d.useRef(),[$,yt]=d.useState({width:800,height:600}),Ze=d.useCallback(async()=>{if(n!=null&&n.id)try{const t=await fetch(`/api/thumbnails/${n.id}`);if(t.ok){const s=await t.json();if(s.success&&s.thumbnails&&s.thumbnails.length>0){const o={};s.thumbnails.forEach(a=>{a.page_id&&a.thumbnail_url&&(o[a.page_id]=a.thumbnail_url)}),Object.keys(o).length>0?(ue(a=>({...a,...o})),console.log("✅ Thumbnails cargados desde storage:",Object.keys(o).length)):console.log("ℹ️ No hay thumbnails guardados, usando generación local")}else console.log("ℹ️ No hay thumbnails guardados para este proyecto")}}catch(t){console.warn("⚠️ Error cargando thumbnails guardados (usando locales):",t)}},[n==null?void 0:n.id]),Ce=d.useCallback(He(async()=>{if(!(!(l!=null&&l.length)||!$||!r)){if(De.current){console.log("⏳ Thumbnails ya se están generando, saltando...");return}De.current=!0;try{const t=l.filter(o=>!Y[o.id]);if(t.length===0){console.log("✅ Todos los thumbnails ya existen");return}console.log(`📸 Generando ${t.length} thumbnails faltantes...`);const s=await Vo({pages:t,workspaceDimensions:$,presetData:r});s&&Object.keys(s).length>0&&(ue(o=>({...o,...s})),console.log("✅ Thumbnails locales generados:",Object.keys(s).length))}catch(t){console.warn("⚠️ Error generando thumbnails locales:",t)}finally{De.current=!1}}},500),[l,$,r,Y]),De=d.useRef(!1),vt=d.useCallback(t=>{if(Te.has&&Te.has(t))return;const s=new Image;s.crossOrigin="anonymous",s.onload=()=>{if(s.width>1200||s.height>1200){const a=document.createElement("canvas"),i=a.getContext("2d"),u=1200,p=Math.min(u/s.width,u/s.height),m=s.width*p,b=s.height*p;a.width=m,a.height=b,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(s,0,0,m,b),a.toBlob(E=>{if(E){const j=URL.createObjectURL(E);zs(C=>{const P=new Map(C);if(P.set(t,j),P.size>15){const w=P.keys().next().value,k=P.get(w);URL.revokeObjectURL(k),P.delete(w)}return P})}},"image/webp",.85)}},s.onerror=()=>{console.warn("❌ Error pre-cargando imagen:",t)},s.src=t},[]);d.useEffect(()=>{xe.length>0&&xe.slice(0,10).forEach((s,o)=>{setTimeout(()=>{vt(s.url)},o*100)})},[xe,vt]),d.useEffect(()=>()=>{Te&&Te.forEach&&Te.forEach(t=>URL.revokeObjectURL(t))},[]);const et=d.useCallback(async()=>{var t;if(!(!(n!=null&&n.id)||!(l!=null&&l.length)))try{const s=await fetch(`/api/thumbnails/${n.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:l})});if(s.ok){const o=await s.json();o&&Object.keys(o).length>0?(ue(a=>({...a,...o})),console.log("✅ Thumbnails existentes cargados:",Object.keys(o).length)):(console.log("📸 No hay thumbnails existentes, generando nuevos..."),await Ce())}}catch(s){console.warn("⚠️ Error cargando thumbnails existentes:",s),await Ce()}},[n==null?void 0:n.id,l,Ce]);d.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(l!=null&&l.length)))try{const t=l[c];if(!t)return;const s=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(s.ok){const o=await s.json();if(o.success&&o.thumbnails){const a={};o.thumbnails.forEach(i=>{i.page_id&&i.thumbnail_url&&(a[i.page_id]=i.thumbnail_url)}),ue(i=>({...i,...a})),console.log("✅ Thumbnail generado y guardado en storage para página actual:",o.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando thumbnail:",t)}},[n==null?void 0:n.id,l,c,$]),d.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(l!=null&&l.length)))try{const t=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:l,width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(t.ok){const s=await t.json();if(s.success&&s.thumbnails){const o={};s.thumbnails.forEach(a=>{a.page_id&&a.thumbnail_url&&(o[a.page_id]=a.thumbnail_url)}),ue(a=>({...a,...o})),console.log("✅ Todos los thumbnails generados y guardados en storage:",s.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando todos los thumbnails:",t)}},[n==null?void 0:n.id,l,$]),d.useEffect(()=>{if(y&&g&&r){if(y.pages&&Array.isArray(y.pages)){const t=y.pages.map(s=>{let o=null,a=r.background_color||"#ffffff";return s.type==="cover"?g.cover_image&&(o=`/storage/images/item/${g.cover_image}`):s.type==="content"?g.content_image&&(o=`/storage/images/item/${g.content_image}`):(s.type==="final"||s.type==="contraportada")&&g.back_cover_image&&(o=`/storage/images/item/${g.back_cover_image}`),{...s,backgroundImage:o,backgroundColor:a}});le(s=>s.length>0?(console.log("⚠️ Páginas ya existentes, preservando cambios del usuario"),s.map((o,a)=>{const i=t[a];return i?{...o,backgroundImage:o.backgroundImage||i.backgroundImage,backgroundColor:o.backgroundColor||i.backgroundColor}:o})):(console.log("📄 Carga inicial de páginas desde la base de datos"),t)),re(s=>s.length<=1?[JSON.stringify(t)]:s),je(s=>s===0&&fe.length<=1?0:s),setTimeout(()=>{Ze()},100)}else{const t=Tt(r,g);le(t),re([JSON.stringify(t)]),je(0),setTimeout(()=>{Ze()},100)}typeof y.currentPage=="number"&&ee(y.currentPage),y.workspaceSize&&Ee(y.workspaceSize)}},[y,g,r,Ze]);const be=Ho(l,n,g,r,$,Y),wt=()=>{if(r!=null&&r.width&&(r!=null&&r.height)){let m=r.width,b=r.height,E=m*37.8,j=b*37.8;if(E&&j){const C=window.innerWidth*.6,P=window.innerHeight*.7,w=C/E,k=P/j,M=Math.min(w,k,1);return{width:Math.round(E*M),height:Math.round(j*M),originalWidth:m,originalHeight:b,scale:M,unit:"cm",originalWidthPx:Math.round(E),originalHeightPx:Math.round(j)}}}if(r!=null&&r.extra_settings)try{const m=typeof r.extra_settings=="string"?JSON.parse(r.extra_settings):r.extra_settings;if(m!=null&&m.canvas_config){const b=m.canvas_config;let E=b.width,j=b.height,C=E*37.8,P=j*37.8;if(C&&P){const w=window.innerWidth*.6,k=window.innerHeight*.7,M=w/C,G=k/P,X=Math.min(M,G,1);return{width:Math.round(C*X),height:Math.round(P*X),originalWidth:E,originalHeight:j,scale:X,unit:"cm",originalWidthPx:Math.round(C),originalHeightPx:Math.round(P)}}}}catch(m){console.warn("Error parsing extra_settings:",m)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},s=t[he]||t.preset,o=window.innerWidth*.6,a=window.innerHeight*.7,i=o/s.width,u=a/s.height,p=Math.min(i,u,1);return{width:Math.round(s.width*p),height:Math.round(s.height*p),originalWidth:s.width,originalHeight:s.height,scale:p,unit:"px"}},ye=d.useCallback(async(t={type:"thumbnail"})=>{if(!l[c])return null;try{let s=document.querySelector(`#page-${l[c].id}`);if(!s)return console.warn("❌ THUMBNAIL: No se encontró el elemento de página específico"),null;const o=l[c],a=t.type==="pdf",i=a?11.81:3,u=1,p=getComputedStyle(s);let m=(o==null?void 0:o.backgroundColor)||"#ffffff";p.backgroundColor&&p.backgroundColor!=="rgba(0, 0, 0, 0)"&&(m=p.backgroundColor);const b={scale:i,useCORS:!0,allowTaint:!1,backgroundColor:m,width:$.width,height:$.height,x:0,y:0,scrollX:0,scrollY:0,foreignObjectRendering:!!a,removeContainer:!1,logging:!1,imageTimeout:a?6e4:15e3,pixelRatio:a?3:window.devicePixelRatio||1,canvas:a?document.createElement("canvas"):null,windowWidth:a?$.width*i:null,windowHeight:a?$.height*i:null,onclone:async C=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(w=>{try{C.querySelectorAll(w).forEach(M=>M.remove())}catch(k){console.warn("Error removing selector:",w,k)}});try{const w=C.querySelector(`#page-${l[c].id}`);w&&(w.style.width=$.width+"px",w.style.height=$.height+"px",w.style.position="relative",w.style.overflow="hidden",o!=null&&o.backgroundImage&&(w.style.backgroundImage=`url(${o.backgroundImage})`,w.style.backgroundSize="cover",w.style.backgroundPosition="center",w.style.backgroundRepeat="no-repeat"),o!=null&&o.backgroundColor&&(w.style.backgroundColor=o.backgroundColor))}catch(w){console.error("❌ [THUMBNAIL-FIX] Error configurando elemento de página:",w)}try{const w=new Map;s.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((H,ve)=>{if(H.complete&&H.naturalWidth>0){const ce=(H.closest('[data-element-type="image"]')||H.parentElement).getBoundingClientRect(),pe=H.getBoundingClientRect();w.set(H.src,{src:H.src,naturalWidth:H.naturalWidth,naturalHeight:H.naturalHeight,containerWidth:ce.width,containerHeight:ce.height,objectFit:getComputedStyle(H).objectFit||"cover",objectPosition:getComputedStyle(H).objectPosition||"center",crossOrigin:H.crossOrigin})}});const M=async(H,ve,ie,ce,pe)=>new Promise(Ae=>{try{const ke=ve/ie,lt=ce/pe;let Ve,We,ct,dt,Es,js;lt>ke?(js=ie,Es=ie*lt,We=pe,Ve=pe*ke,ct=(ce-Ve)/2,dt=0):(Es=ve,js=ve/lt,Ve=ce,We=ce/ke,ct=0,dt=(pe-We)/2);const Ge=C.createElement("canvas");Ge.width=ve,Ge.height=ie;const oo=Ge.getContext("2d"),Ue=new Image;Ue.crossOrigin="anonymous",Ue.onload=()=>{try{oo.drawImage(Ue,ct,dt,Ve,We,0,0,ve,ie);const gt=Ge.toDataURL("image/png",1);H.src=gt,H.style.objectFit="fill",H.style.objectPosition="center",H.style.width="100%",H.style.height="100%",Ae()}catch(gt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en canvas processing:",gt),Ae()}},Ue.onerror=()=>{console.warn("⚠️ [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),Ae()},Ue.src=H.src}catch(ke){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",ke),Ae()}}),G=C.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),X=[];G.forEach((H,ve)=>{if(H.src&&w.has(H.src)){const ie=w.get(H.src),ce=H.closest('[data-element-type="image"]')||H.parentElement;if(ce&&(ce.style.overflow="hidden",ce.style.position="relative"),ie.objectFit==="cover"||H.classList.contains("object-cover")||H.classList.contains("workspace-image")){const pe=M(H,ie.containerWidth,ie.containerHeight,ie.naturalWidth,ie.naturalHeight);X.push(pe)}else H.style.width="100%",H.style.height="100%",H.style.objectFit="fill"}}),X.length>0&&await Promise.all(X);const B=C.createElement("style");B.textContent=`
                            /* CORRECCIÓN THUMBNAIL: Estructura del elemento de página */
                            #page-${l[c].id} {
                                width: ${$.width}px !important;
                                height: ${$.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* 🖨️ IMÁGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya están recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${a?`
                                /* 🖨️ IMPRESIÓN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de página */
                            #page-${l[c].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* 🖨️ OPTIMIZACIONES GENERALES PARA PDF DE IMPRESIÓN */
                            ${a?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,C.head.appendChild(B)}catch(w){console.error("❌ [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",w);const k=C.createElement("style");k.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,C.head.appendChild(k)}}},E=await Ss(s,b);if(a&&E){const C=E.getContext("2d");if(C){C.imageSmoothingEnabled=!1,C.imageSmoothingQuality="high";const P=C.getImageData(0,0,E.width,E.height),w=P.data;for(let k=0;k<w.length;k+=4)w[k]=Math.min(255,w[k]*1.05),w[k+1]=Math.min(255,w[k+1]*1.05),w[k+2]=Math.min(255,w[k+2]*1.05);C.putImageData(P,0,0)}}if(!E)throw new Error("html2canvas no devolvió un canvas válido para el elemento de página");if(E.width===0||E.height===0)throw new Error("Canvas del elemento de página tiene dimensiones inválidas");const j=E.toDataURL("image/png",u);if(!j||j==="data:,")throw new Error("No se pudo generar dataURL del elemento de página");return a?E:j}catch(s){console.error("❌ [THUMBNAIL-FIX] Error capturando elemento de página:",s);try{const o=document.createElement("canvas"),a=t.type==="pdf"?11.81:1;o.width=$.width*a,o.height=$.height*a;const i=o.getContext("2d"),u=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return i.fillStyle=u,i.fillRect(0,0,o.width,o.height),i.fillStyle=u==="#ffffff"||u.includes("white")?"#374151":"#666666",i.font=`${14*a}px Arial`,i.textAlign="center",i.fillText("Página "+(c+1),o.width/2,o.height/2),t.type==="pdf"?o:o.toDataURL("image/png",1)}catch{return null}}},[c,l]),ze=d.useCallback(async()=>{if(!l[c])return;const t=await ye({type:"thumbnail"});t&&ue(s=>({...s,[l[c].id]:t}))},[ye,c,l]);d.useCallback(()=>{clearTimeout(bt.current),bt.current=setTimeout(()=>{l[c]&&!Y[l[c].id]&&ze()},1200)},[ze,l,c,Y]);const Et=d.useCallback(()=>{l[c]&&!Y[l[c].id]&&setTimeout(()=>{ze()},300)},[ze,l,c,Y]),Fs=d.useCallback(async(t=c,s={width:800,height:600})=>{var o,a;if(!l[t])return null;try{const i=c;t!==c&&(ee(t),await new Promise(b=>setTimeout(b,100)));const u=document.querySelector(`#page-${l[t].id}`);if(!u)return console.warn("Workspace element not found for page:",l[t].id),null;const p={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((o=l[t])==null?void 0:o.backgroundColor)||"#ffffff",width:u.offsetWidth,height:u.offsetHeight,removeContainer:!0,logging:!1,onclone:b=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(w=>{b.querySelectorAll(w).forEach(M=>M.remove())});const j=b.querySelector(`#page-${l[t].id}`);if(j){const w=l[t];w!=null&&w.backgroundImage&&(j.style.backgroundImage=`url(${w.backgroundImage})`,j.style.backgroundSize="cover",j.style.backgroundPosition="center",j.style.backgroundRepeat="no-repeat"),w!=null&&w.backgroundColor&&(j.style.backgroundColor=w.backgroundColor)}try{const w=u.querySelectorAll("img"),k=new Map;w.forEach((G,X)=>{const B=getComputedStyle(G);k.set(X,{objectFit:B.objectFit,objectPosition:B.objectPosition,width:B.width,height:B.height,borderRadius:B.borderRadius,transform:B.transform})}),b.querySelectorAll("img").forEach((G,X)=>{const B=k.get(X);B&&(G.style.objectFit=B.objectFit||"cover",G.style.objectPosition=B.objectPosition||"center",G.style.width=B.width,G.style.height=B.height,G.style.borderRadius=B.borderRadius,G.style.transform=B.transform)})}catch(w){console.warn("Error preservando estilos de imágenes:",w),b.querySelectorAll("img").forEach(M=>{M.style.objectFit="cover",M.style.objectPosition="center",M.style.width||(M.style.width="100%"),M.style.height||(M.style.height="100%")})}b.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(w=>{const k=w.className;k&&(w.className=k);const M=getComputedStyle?getComputedStyle(w):null;M&&(M.fontFamily&&M.fontFamily!=="Arial"&&(w.style.fontFamily=M.fontFamily),M.fontSize&&(w.style.fontSize=M.fontSize),M.fontWeight&&(w.style.fontWeight=M.fontWeight),M.fontStyle&&(w.style.fontStyle=M.fontStyle))});const P=b.createElement("style");P.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CRÍTICO: Asegurar que las imágenes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CRÍTICO: Asegurar que los backgrounds de página se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,b.head.appendChild(P)}},m=await Ss(u,p);if(s.width!==m.width||s.height!==m.height){const b=document.createElement("canvas");b.width=s.width,b.height=s.height;const E=b.getContext("2d"),j=m.width/m.height,C=s.width/s.height;let P,w,k=0,M=0;j>C?(P=s.width,w=s.width/j,M=(s.height-w)/2):(w=s.height,P=s.height*j,k=(s.width-P)/2),E.fillStyle=((a=l[t])==null?void 0:a.backgroundColor)||"#ffffff",E.fillRect(0,0,s.width,s.height),E.drawImage(m,k,M,P,w);const G=b.toDataURL("image/png",1);return t!==i&&ee(i),G}return t!==i&&ee(i),m.toDataURL("image/png",1)}catch(i){return console.error("❌ Error generando thumbnail de alta calidad:",i),null}},[l,c,ee]);d.useEffect(()=>{const t=wt();yt(t)},[r,he]),d.useEffect(()=>{const t=()=>{const s=wt();yt(s)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[r,he]),d.useEffect(()=>{if(l[c]&&!Y[l[c].id]){const t=setTimeout(()=>{Et()},400);return()=>clearTimeout(t)}},[c]),d.useEffect(()=>{const t=l[c];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(s=>{s.ok?console.log("✅ [WORKSPACE] Imagen existe en el servidor"):console.error("❌ [WORKSPACE] Imagen NO existe en el servidor. Status:",s.status)}).catch(s=>{console.error("❌ [WORKSPACE] Error verificando imagen:",s)})},[c,(Ut=l[c])==null?void 0:Ut.backgroundImage]),d.useEffect(()=>{const t=`${$.width}x${$.height}`,s=sessionStorage.getItem("lastWorkspaceDimensions");s&&s!==t&&l.length>0&&(ue({}),setTimeout(()=>{l[c]&&Et()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[$.width,$.height]),d.useEffect(()=>{if(!(n!=null&&n.id)||l.length===0)return;let t,s=Date.now(),o=!1;const a=()=>{o=!0,s=Date.now()},i=async()=>{if(o)try{console.log("🔄 [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(b=>({...b,saveStatus:"saving"}));const p=await fetch(`/api/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:l,force:!1})}),m=await p.json();if(p.ok&&m.success)o=!1,K(b=>({...b,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("✅ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado falló")}catch(p){console.error("❌ [AUTO-SAVE] Error en guardado silencioso:",p),K(m=>({...m,saveStatus:"error",saveError:p.message}))}},u=()=>{t=setInterval(()=>{const p=Date.now()-s;o&&p>6e4&&(console.log("⏰ [AUTO-SAVE] Condiciones cumplidas para guardado automático"),i())},3*60*1e3)};return JSON.stringify(l),l[c],a(),u(),()=>{t&&clearInterval(t)}},[l,c,n==null?void 0:n.id]),d.useEffect(()=>{var s;if(!l[c])return;const t=((s=l[c].cells)==null?void 0:s.flatMap(o=>o.elements))||[];JSON.stringify(t),K(o=>({...o,hasUnsavedChanges:!0}))},[($t=l[c])==null?void 0:$t.cells,c]);const[Do,tt]=d.useState(!1),[en,Vs]=d.useState({elementId:null,cellId:null}),[Ws,jt]=d.useState(!1),[Gs,Nt]=d.useState(!1),[Bs,Hs]=d.useState(null),st=d.useRef(null),St=t=>{var a,i,u,p;const s=A||((i=(a=l[c])==null?void 0:a.cells[0])==null?void 0:i.id);if(!s)return;const o={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((p=(u=l[c].cells.find(m=>m.id===s))==null?void 0:u.elements)==null?void 0:p.length)||0)+1};Le(s,o),Z.success("Imagen añadida correctamente")},ot=d.useCallback(He(async(t=!1)=>{if(!(n!=null&&n.id))return;const s=$e.get(n.id);if(!t&&s&&s.length>0){console.log("🔄 Usando imágenes desde cache"),xe.length===0&&Ne(s);return}if(Se.current&&clearTimeout(Se.current),Xe&&!t){console.log("⏳ Carga de imágenes ya en progreso");return}xt(!0);try{const o=new AbortController,a=setTimeout(()=>o.abort(),1e4),i=await fetch(`/api/canvas/projects/${n.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:o.signal});if(clearTimeout(a),!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const u=await i.json();if(u.success){const p=u.images||[],m=JSON.stringify(xe),b=JSON.stringify(p);m!==b&&(Ne(p),_s(E=>{const j=new Map(E);if(j.set(n.id,p),j.size>5){const C=j.keys().next().value;j.delete(C)}return j}))}else console.error("Error cargando imágenes:",u.message),Z.error("Error cargando galería de imágenes")}catch(o){o.name==="AbortError"?console.warn("⚠️ Carga de imágenes cancelada por timeout"):(console.error("Error cargando imágenes del proyecto:",o),Z.error("Error de conexión al cargar imágenes"))}finally{xt(!1)}},200),[n==null?void 0:n.id,$e,xe,Xe]),qs=d.useCallback(async t=>{const s=t.target.files[0];if(!s||!(n!=null&&n.id))return;const o=Z.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),a=URL.createObjectURL(s),i={id:`temp-${Date.now()}`,filename:s.name,url:a,thumbnail_url:a,has_thumbnail:!1,size:s.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Ne(p=>[i,...p]),St(a);const u=new FormData;u.append("image",s),u.append("projectId",n.id);try{const m=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:u})).json();if(m.success){const b={id:m.id||Date.now(),filename:s.name,url:m.url,thumbnail_url:m.thumbnail_url||m.url,has_thumbnail:m.has_thumbnail||!1,size:s.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Ne(E=>[b,...E.filter(j=>j.id!==i.id)]),setTimeout(()=>{le(E=>{const j=[...E];return j[c].cells.forEach(P=>{P.elements.forEach(w=>{w.type==="image"&&w.content===a&&(w.content=m.url)})}),j})},100),Z.dismiss(o),Z.success(m.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{ot(!0)},2e3)}else Ne(b=>b.filter(E=>E.id!==i.id)),URL.revokeObjectURL(a),Z.dismiss(o),Z.error(m.message||"Error al subir la imagen")}catch(p){console.error("Error subiendo la imagen:",p),Ne(m=>m.filter(b=>b.id!==i.id)),URL.revokeObjectURL(a),Z.dismiss(o),Z.error("Error de red al subir la imagen")}},[n==null?void 0:n.id,c,St,ot]);d.useEffect(()=>{if(n!=null&&n.id){const t=$e.get(n.id);if(t&&t.length>0){Ne(t);return}return Se.current=setTimeout(()=>{ot(!1)},150),()=>{Se.current&&clearTimeout(Se.current)}}},[n==null?void 0:n.id,$e]),d.useEffect(()=>()=>{Se.current&&clearTimeout(Se.current)},[]);const Ct=(t,s)=>{if(console.log("🖼️ [ADD-IMAGE] Agregando imagen sin selección automática"),!l||l.length===0||!l[c]){console.error("❌ [ADD-IMAGE] No hay páginas válidas para agregar imagen");return}const o=JSON.parse(JSON.stringify(l));let a=!1;for(let i=0;i<o[c].cells.length;i++)if(o[c].cells[i].id===t){o[c].cells[i].elements.push(s),a=!0,console.log("✅ [ADD-IMAGE] Imagen agregada a la celda:",t);break}if(!a){console.error("❌ [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{Me(o),console.log("✅ [ADD-IMAGE] Estado actualizado sin selección automática")},0)},Ks=d.useCallback(t=>{var p,m,b,E;console.log("🖼️ [ADD-FROM-GALLERY] Iniciando proceso de agregar imagen:",t);const s=_e;Oe(!0);const o=_==="images",a=A||((m=(p=l[c])==null?void 0:p.cells[0])==null?void 0:m.id);if(!a){console.error("❌ [ADD-FROM-GALLERY] No hay celda disponible"),Z.error("No hay celda disponible para agregar la imagen"),Oe(s);return}if(!t||typeof t!="string"){console.error("❌ [ADD-FROM-GALLERY] URL de imagen inválida"),Z.error("URL de imagen no válida"),Oe(s);return}const i=JSON.parse(JSON.stringify(l));console.log("📸 [ADD-FROM-GALLERY] Snapshot del estado actual capturado");const u={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((E=(b=i[c].cells.find(j=>j.id===a))==null?void 0:b.elements)==null?void 0:E.length)||0)+1};console.log("📝 [ADD-FROM-GALLERY] Elemento creado:",u),setTimeout(()=>{Ct(a,u),setTimeout(()=>{o&&(te("images"),console.log("🔄 [ADD-FROM-GALLERY] Tab restaurado a images")),setTimeout(()=>{Oe(s),Z.success("✅ Imagen añadida desde la galería"),console.log("✅ [ADD-FROM-GALLERY] Proceso completado exitosamente")},50)},50)},50)},[_,A,l,c,_e,Ct]),At=d.useCallback(async(t,s)=>{var i,u;const o=[],a=[];for(const p of t){const m={...p};if(p.cells){m.cells=[];for(const b of p.cells){const E={...b};if(b.elements){E.elements=[];for(const j of b.elements)if(j.type==="image"&&((i=j.content)!=null&&i.startsWith("data:image/"))){const C=`${j.id}_${Date.now()}`,P=j.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(P){const w=P[1],k=P[2],G=`${C}.${w==="jpeg"?"jpg":w}`;a.push({filename:G,data:k,type:w,elementId:j.id}),E.elements.push({...j,content:j.content,_wasBase64:!0,_originalSize:j.content.length,_elementId:j.id})}else E.elements.push(j)}else E.elements.push(j)}m.cells.push(E)}}o.push(m)}if(a.length>0)try{const p=await fetch(`/api/canvas/projects/${s}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:a})});if(p.ok){const m=await p.json();if(m.uploadedImages){const b=new Map;m.uploadedImages.forEach(E=>{b.set(E.elementId,E.url)});for(const E of o)if(E.cells){for(const j of E.cells)if(j.elements)for(const C of j.elements)C._wasBase64&&C._elementId&&b.has(C._elementId)&&(C.content=b.get(C._elementId),delete C._elementId)}}}else{const m=await p.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("❌ [IMAGE-UPLOAD] Error subiendo imágenes:",m),t}}catch(p){return console.error("❌ [IMAGE-UPLOAD] Error de red subiendo imágenes:",p),t}return o},[]),Re=d.useCallback(async(t=l,s=!1)=>{var o;if(!(!(n!=null&&n.id)||!s&&t.length===0))try{const u={design_data:{pages:await At(t,n.id),currentPage:c,workspaceDimensions:$,workspaceSize:he,selectedElement:W,selectedCell:A,history:fe.slice(-5),historyIndex:Math.min(ge,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:n.id,name:(g==null?void 0:g.name)||"Álbum Personalizado",item_id:g==null?void 0:g.id,preset_id:r==null?void 0:r.id}},thumbnails:Y},m=JSON.stringify(u).length/(1024*1024),b=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(u)});if(b.ok){const E=await b.json(),j=`editor_progress_project_${n.id}`;return localStorage.removeItem(j),U(C=>{const P=new Map(C);return s?P.clear():P.delete(c),P}),l&&l.length>0&&Ce().catch(C=>{console.warn("⚠️ Error generando thumbnails locales:",C)}),!0}else{const E=await b.json().catch(()=>({message:"Error desconocido"}));return console.error("❌ [AUTO-SAVE] Error guardando en BD:",E),!1}}catch(a){return console.error("❌ [AUTO-SAVE] Error en auto-save con procesamiento de imágenes:",a),!1}},[l,c,$,he,W,A,fe,ge,n==null?void 0:n.id,g==null?void 0:g.name,g==null?void 0:g.id,r==null?void 0:r.id,Y,At,Ce]);d.useEffect(()=>{if(!(n!=null&&n.id))return;const t=setInterval(()=>{l.length>0&&Re(l,!1)},5*60*1e3);return()=>clearInterval(t)},[Re,l,n==null?void 0:n.id]),d.useCallback(async()=>{if(!l.length)return{};console.log("📸 [THUMBNAILS] Capturando thumbnails de todas las páginas...");const t={},s=c;try{for(let o=0;o<l.length;o++){const a=l[o];if(a!=null&&a.id)try{o!==c&&(ee(o),await new Promise(u=>setTimeout(u,300)));const i=await ye({type:"thumbnail"});i&&(t[a.id]=i,console.log(`✅ [THUMBNAILS] Thumbnail capturado para página ${o+1}: ${a.id}`))}catch(i){console.warn(`⚠️ [THUMBNAILS] Error capturando thumbnail para página ${a.id}:`,i),Y[a.id]&&(t[a.id]=Y[a.id])}}return s!==c&&ee(s),console.log(`✅ [THUMBNAILS] Capturados ${Object.keys(t).length} thumbnails de ${l.length} páginas`),t}catch(o){return console.error("❌ [THUMBNAILS] Error capturando thumbnails:",o),s!==c&&ee(s),Y}},[l,c,ee,ye,Y]);const Qs=d.useCallback(async()=>{if(!(n!=null&&n.id)||l.length===0)return Z.error("No hay datos para guardar"),!1;try{return console.log("📸 [SAVE] Generando thumbnails localmente..."),await Ce(),await et(),await Re(l,!0)?(Z.success("Progreso guardado exitosamente"),!0):(Z.error("Error al guardar el progreso"),!1)}catch(t){return console.error("❌ [SAVE] Error al guardar el progreso:",t),Z.error("Error al guardar el progreso"),!1}},[Re,l,n==null?void 0:n.id,$,r,Ce]),kt=d.useCallback(async t=>{var s;if(console.log("💾 [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("🔍 [QUEUE-SAVE] Datos disponibles:",{projectId:n==null?void 0:n.id,pagesCount:t==null?void 0:t.length,currentPage:c,hasDimensions:!!$,hasThumbnails:!!Y}),!(n!=null&&n.id))return console.error("❌ [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return console.error("❌ [QUEUE-SAVE] No hay páginas para guardar"),!1;try{const a={design_data:{pages:t,currentPage:c,workspaceDimensions:$,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:Y};console.log("📤 [QUEUE-SAVE] Enviando petición al servidor...");const i=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(a)});if(console.log("📥 [QUEUE-SAVE] Respuesta del servidor:",i.status,i.statusText),i.ok){const u=await i.json();return console.log("✅ [QUEUE-SAVE] Guardado exitoso desde cola:",u),!0}else{const u=await i.text();return console.error("❌ [QUEUE-SAVE] Error en respuesta del servidor:",i.status,u),!1}}catch(o){return console.error("❌ [QUEUE-SAVE] Error guardando desde cola:",o),!1}},[n==null?void 0:n.id,c,$,Y]),nt=d.useCallback(async()=>{if(console.log("🔍 [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:V,saveQueueLength:L.length}),V){console.log("⚠️ [SAVE-QUEUE] Ya se está procesando, saltando...");return}if(L.length===0){console.log("⚠️ [SAVE-QUEUE] Cola vacía, no hay nada que procesar");return}console.log("🚀 [SAVE-QUEUE] Iniciando procesamiento de cola..."),I(!0);try{const t=L.slice();console.log("� [SAVE-QUEUE] Cola capturada para procesamiento:",t.length,"elementos"),q([]),console.log("🧹 [SAVE-QUEUE] Cola limpiada");for(const s of t)console.log("💾 [SAVE-QUEUE] Guardando página:",s.pageIndex),await kt(s.pages)?(U(a=>{const i=new Map(a);return i.delete(s.pageIndex),i}),console.log("✅ [SAVE-QUEUE] Página guardada exitosamente:",s.pageIndex)):(console.error("❌ [SAVE-QUEUE] Error guardando página:",s.pageIndex),q(a=>[...a,s]));console.log("✅ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(t){console.error("❌ [SAVE-QUEUE] Error procesando cola:",t)}finally{I(!1),console.log("🔓 [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[V,L,kt]);d.useEffect(()=>{console.log("🔄 [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:L.length,isProcessingQueue:V,shouldProcess:L.length>0&&!V}),L.length>0&&!V&&(console.log("⏰ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{nt()},100))},[L.length,V,nt]),d.useEffect(()=>{console.log("📊 [SAVE-QUEUE] Estado de cola actualizado:",{longitud:L.length,elementos:L.map(t=>`página ${t.pageIndex}`),procesando:V})},[L,V]);const It=d.useCallback((t,s)=>{console.log("🔍 [SAVE-QUEUE] Intentando agregar página a cola:",t),U(o=>{const a=Array.from(o.keys());return console.log("🔍 [SAVE-QUEUE] Cambios actuales:",a.join(", ")||"ninguno"),o.has(t)?(console.log("✅ [SAVE-QUEUE] Página tiene cambios, agregando a cola:",t),q(i=>{console.log("🔍 [SAVE-QUEUE] Cola actual antes de agregar:",i.length,"elementos");const u=i.findIndex(p=>p.pageIndex===t);if(u!==-1){const p=[...i];return p[u]={pageIndex:t,pages:s,timestamp:Date.now()},console.log("🔄 [SAVE-QUEUE] Actualizando elemento existente en cola"),p}else{const p=[...i,{pageIndex:t,pages:s,timestamp:Date.now()}];return console.log("➕ [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",p.length),p}}),console.log("📤 [SAVE-QUEUE] Página agregada a cola:",t),o):(console.log("⚠️ [SAVE-QUEUE] No hay cambios para la página:",t,"- No se agregará a cola"),o)})},[]),at=d.useCallback(async t=>{if(console.log("🔄 [PAGE-CHANGE] Iniciando cambio de página de",c,"a",t),t===c){console.log("⚠️ [PAGE-CHANGE] Misma página, no se hace nada");return}U(s=>{console.log("🔍 [PAGE-CHANGE] Verificando cambios en página actual:",c);const o=Array.from(s.keys());return console.log("🔍 [PAGE-CHANGE] Páginas con cambios:",o.join(", ")||"ninguna"),s.has(c)?(console.log("💾 [PAGE-CHANGE] ✅ Página actual tiene cambios, guardando antes del cambio:",c),It(c,l)):console.log("ℹ️ [PAGE-CHANGE] No hay cambios en la página actual:",c),s}),ee(t),console.log("📄 [PAGE-CHANGE] ✅ Página cambiada a:",t)},[c,l,It]),Pe=()=>`editor_progress_project_${n==null?void 0:n.id}`,Pt=d.useCallback(async()=>{var s,o,a,i;if(!(n!=null&&n.id))return;if(l.some(u=>{var p;return(p=u.cells)==null?void 0:p.some(m=>{var b;return((b=m.elements)==null?void 0:b.length)>0})})){console.log("⚠️ [RECOVERY] Ya hay contenido en el workspace, saltando recuperación automática");return}try{const u=be.loadFromLocalStorage(),p=await fetch(`/api/canvas/projects/${n.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let m=null;if(p.ok){const E=await p.json();E.success&&((s=E.data)!=null&&s.design_data)&&(m=E.data)}let b=null;if(u&&m){const E=new Date(u.savedAt).getTime(),j=new Date(m.saved_at).getTime();b=E>j?u:m}else u?b=u:m&&(b=m);if(b&&(((o=b.pages)==null?void 0:o.length)>0||((i=(a=b.design_data)==null?void 0:a.pages)==null?void 0:i.length)>0)){const E=new Date(b.savedAt||b.saved_at).getTime();Date.now()-E<30*60*1e3?(Hs(b),Nt(!0)):console.log("📅 [RECOVERY] Progreso muy antiguo, ignorando automáticamente")}}catch(u){console.error("❌ [RECOVERY] Error verificando progreso guardado:",u)}},[n==null?void 0:n.id,be,l]),Js=d.useCallback(async t=>{var s;try{let o=[];if(t.pages?o=t.pages:(s=t.design_data)!=null&&s.pages&&(o=t.design_data.pages),o.length>0){le(o);const a=[JSON.stringify(o)];re(a),je(0),setTimeout(()=>{ue({})},100),Z.success("✅ Progreso cargado exitosamente")}}catch(o){console.error("❌ [RECOVERY] Error cargando progreso:",o),Z.error("Error al cargar el progreso guardado")}},[le,re,je,ue]),Ys=d.useCallback(async()=>{try{const t=be.getStorageKey();localStorage.removeItem(t),Z.success("Progreso anterior eliminado")}catch(t){console.error("❌ [RECOVERY] Error descartando progreso:",t)}},[be]);d.useEffect(()=>{n&&g&&r&&(!(y!=null&&y.pages)||y.pages.length===0)&&Tt(r,g)},[n,g,r,y]),d.useEffect(()=>{n!=null&&n.id&&!O&&l.length===0&&!_e&&(Oe(!0),setTimeout(()=>{Pt()},500))},[n==null?void 0:n.id,O,l.length,Pt,_e]),d.useEffect(()=>{n!=null&&n.id&&l.length>0&&setTimeout(()=>{et()},100)},[n==null?void 0:n.id,l.length,et]);const Tt=(t,s)=>{try{const o=[],a=s.pages||t.pages||20,i=s.cover_image?`/storage/images/item/${s.cover_image}`:null,u=s.cover_image?null:t.background_color||"#ffffff",p={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:i,backgroundColor:u,cells:[{id:"cell-cover-1",elements:[]}]};o.push(p);const m=s.content_image?`/storage/images/item/${s.content_image}`:null,b=s.content_image?null:t.background_color||"#ffffff";for(let P=1;P<=a;P++){const w={id:`page-content-${P}`,type:"content",pageNumber:P,layout:"layout-1",backgroundImage:m,backgroundColor:b,cells:[{id:`cell-content-${P}-1`,elements:[]}]};o.push(w)}const E=s.back_cover_image?`/storage/images/item/${s.back_cover_image}`:null,j=s.back_cover_image?null:t.background_color||"#ffffff",C={id:"page-final",type:"final",layout:"layout-1",backgroundImage:E,backgroundColor:j,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};o.push(C),le(o),ee(0),t.width&&t.height&&Ee("preset")}catch(o){console.error("❌ Error creating pages:",o),T(o.message)}},rt=d.useMemo(()=>({cover:l.filter(t=>t.type==="cover"),content:l.filter(t=>t.type==="content"),final:l.filter(t=>t.type==="final")}),[l]),Q=d.useCallback(()=>{if(!W||!A||l.length===0)return null;const t=l[c];if(!t)return null;const s=t.cells.find(o=>o.id===A);return s?s.elements.find(o=>o.id===W):null},[W,A,l,c]),Ot=(t,s)=>{if(s){const o=l[c].cells.find(i=>i.id===s),a=o==null?void 0:o.elements.find(i=>i.id===t);if(a!=null&&a.locked){const i=document.createElement("div");i.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",i.textContent="Este elemento es parte del diseño base y no se puede editar",document.body.appendChild(i),setTimeout(()=>{document.body.contains(i)&&document.body.removeChild(i)},3e3);return}}if(s&&J(s),de(t),t){const o=l[c].cells.find(i=>i.id===(s||A)),a=o==null?void 0:o.elements.find(i=>i.id===t);(a==null?void 0:a.type)==="image"?(pt(a),_!=="images"&&te("filters")):(a==null?void 0:a.type)==="text"?(tt(!0),Vs({elementId:t,cellId:s||A}),te("text")):tt(!1)}else tt(!1),pt(null)},we=()=>{if(l.length===0)return ae[0];const t=l[c];return t?ae.find(s=>s.id===t.layout)||ae[0]:ae[0]},Rt=d.useCallback(He(t=>{try{const s=Pe(),o={pages:t,currentPage:c,savedAt:Date.now()},a=JSON.stringify(o),i=Math.round(a.length/1024);i<2048?localStorage.setItem(s,a):(console.warn(`⚠️ Datos demasiado grandes para localStorage (${i} KB)`),localStorage.removeItem(s))}catch(s){if(console.error("❌ Error guardando en localStorage:",s),s.name==="QuotaExceededError")try{localStorage.removeItem(Pe())}catch(o){console.error("Error limpiando localStorage:",o)}}},300),[c,Pe]),Me=d.useCallback(t=>{le(s=>{if(s===t)return s;const o=JSON.stringify(s),a=JSON.stringify(t);return o===a?(console.log("🔄 [UPDATE-PAGES] Sin cambios, evitando actualización"),s):(console.log("📝 [UPDATE-PAGES] Aplicando cambios..."),requestAnimationFrame(()=>{if(U(i=>{const u=new Map(i);return u.set(c,Date.now()),u}),t[c]){const i=t[c].id;ue(u=>{if(u[i]){const p={...u};return delete p[i],p}return u})}}),setTimeout(()=>{re(i=>{const u=[...i.slice(0,ge+1),a];return u.length>50?u.slice(-50):u}),je(i=>{const u=i+1;return u>50?49:u})},0),t)}),Rt(t)},[c,ge,Rt]);d.useEffect(()=>{try{const t=Pe(),s={pages:l,currentPage:c,savedAt:Date.now()},o=JSON.stringify(s),a=Math.round(o.length/1024);a<2048?localStorage.setItem(t,o):console.warn(`⚠️ Datos demasiado grandes para localStorage (${a} KB), saltando guardado`)}catch(t){if(console.error("❌ Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const s=Pe();localStorage.removeItem(s)}catch(s){console.error("Error limpiando localStorage:",s)}}},[c,l,Pe]);const Xs=t=>{const s=ae.find(u=>u.id===t);if(!s)return;const o=[...l],a=o[c],i=Array.from({length:s.cells}).map((u,p)=>a.cells[p]||{id:`cell-${a.id}-${p+1}`,elements:[]});o[c]={...a,layout:t,cells:i},Me(o),de(null),J(null)},Le=(t,s)=>{const o=[...l];for(let a=0;a<o[c].cells.length;a++)o[c].cells[a].id===t&&o[c].cells[a].elements.push(s);Me(o),de(s.id),J(t)},Mt=d.useCallback(He(()=>{U(t=>{const s=new Map(t);return s.set(c,Date.now()),s})},100),[c]),ne=d.useCallback((t,s,o,a=!1)=>{le(i=>{const u=[...i],p=u[c].cells.findIndex(m=>m.id===t);if(p===-1)return i;if(a){const m=u[c].cells[p].elements.find(b=>b.id===s);if(!m)return i;u[c].cells[p].elements.push({...m,...o})}else{const m=u[c].cells[p].elements.findIndex(j=>j.id===s);if(m===-1)return i;const b=u[c].cells[p].elements[m];if(!Object.keys(o).some(j=>{const C=b[j],P=o[j];return typeof P=="object"&&typeof C=="object"?JSON.stringify(C)!==JSON.stringify(P):C!==P}))return i;u[c].cells[p].elements[m]={...b,...o}}return u}),o.position||o.size?requestAnimationFrame(()=>{U(i=>{if(i.has(c))return i;const u=new Map(i);return u.set(c,Date.now()),u})}):Mt()},[c,Mt]),Fe=(t,s)=>{const o=[...l],a=o[c].cells.findIndex(i=>i.id===t);a!==-1&&(o[c].cells[a].elements=o[c].cells[a].elements.filter(i=>i.id!==s),Me(o),W===s&&de(null))},Zs=(t,s,o)=>{const a=[...l],i=a[c].cells.findIndex(u=>u.id===t);if(i!==-1){const u=a[c].cells[i].elements,p=u.findIndex(m=>m.id===s);if(p!==-1){const m=o==="up"?p+1:p-1;if(m>=0&&m<u.length){const b=u[p];u[p]=u[m],u[m]=b,Me(a)}}}},Ds=()=>{ge>0&&(je(ge-1),le(JSON.parse(fe[ge-1])),de(null),J(null))},eo=()=>{ge<fe.length-1&&(je(ge+1),le(JSON.parse(fe[ge+1])),de(null),J(null))},it=(t="body")=>{const s=`text-${Date.now()}`,o={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},a={heading:"Título Principal",subheading:"Subtítulo",body:"Haz clic para editar"},i={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},u={id:s,type:"text",content:a[t],position:{x:.05,y:.05},size:i[t],style:o[t]};A?Le(A,u):console.log("Selecciona una celda primero")},Lt=d.useMemo(()=>{var i;const t=l[c];if(!t)return null;const s=((i=t.cells)==null?void 0:i.flatMap(u=>u.elements||[]))||[],o=s.map(u=>({id:u.id,type:u.type,position:u.position,size:u.size}));return{pageId:t.id,elementsCount:s.length,contentHash:JSON.stringify(o).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[l,c]);d.useEffect(()=>{if(l.length===0||O||!Lt)return;let t=!1;const s=async()=>{try{const a=l[c];if(!a||!a.id)return;const i=a.id;if(ue(p=>{const m={...p};return delete m[i],m}),await new Promise(p=>setTimeout(p,100)),t)return;const u=await ye();u&&!t?ue(p=>({...p,[i]:u})):console.warn("⚠️ [DEBUG] No se pudo generar miniatura para:",i)}catch(a){t||console.error("❌ [DEBUG] Error regenerando miniatura:",a)}},o=setTimeout(()=>{s()},500);return()=>{t=!0,clearTimeout(o)}},[c,Lt,O,ye]),d.useEffect(()=>{if(l.length===0||O)return;const t=async()=>{const o=l.filter(a=>!Y[a.id]);if(o.length!==0)for(const a of o)try{const i=document.createElement("canvas");i.width=200,i.height=150;const u=i.getContext("2d");if(u.fillStyle=a.backgroundColor||"#ffffff",u.fillRect(0,0,200,150),a.backgroundImage)try{const m=new Image;m.crossOrigin="anonymous",await new Promise((b,E)=>{m.onload=b,m.onerror=E,m.src=a.backgroundImage}),u.drawImage(m,0,0,200,150)}catch(m){console.warn("No se pudo cargar imagen de fondo para miniatura:",m)}a.cells&&a.cells.forEach(m=>{m.elements&&m.elements.forEach(b=>{var E;b.type==="text"&&b.content&&(u.fillStyle=((E=b.style)==null?void 0:E.color)||"#000000",u.font="12px Arial",u.fillText(b.content.substring(0,20)+(b.content.length>20?"...":""),10,30))})});const p=i.toDataURL("image/jpeg",.7);ue(m=>({...m,[a.id]:p})),await new Promise(m=>setTimeout(m,300))}catch(i){console.error("❌ Error generando miniatura de fondo para:",a.id,i)}},s=setTimeout(()=>{t()},2e3);return()=>clearTimeout(s)},[l,Y,O]),d.useEffect(()=>{const t=s=>{const o=z.current,a=se.current;if(o.length>0||a.size>0)return s.preventDefault(),s.returnValue="Hay cambios sin guardar. ¿Estás seguro de que quieres salir?",s.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),d.useEffect(()=>()=>{console.log("🧹 [CLEANUP] Componente desmontado")},[]);const to=async()=>{var t;try{if(!g||!r||!(n!=null&&n.id))return!1;await Re(l,!0)||console.warn("⚠️ No se pudo guardar el progreso, pero continuando...");const o={design_data:{id:n.id,title:(g==null?void 0:g.name)||"Álbum Personalizado",pages:l,workspace_dimensions:$,created_at:new Date().toISOString()},item_data:{id:g==null?void 0:g.id,name:(g==null?void 0:g.name)||(g==null?void 0:g.title),price:g==null?void 0:g.price,user_id:g==null?void 0:g.user_id,width:g==null?void 0:g.width,height:g==null?void 0:g.height},preset_data:{id:r==null?void 0:r.id,width:r==null?void 0:r.width,height:r==null?void 0:r.height,cover_image:r==null?void 0:r.cover_image,content_layer_image:r==null?void 0:r.content_layer_image,final_layer_image:r==null?void 0:r.final_layer_image},dimensions:{width_mm:(r==null?void 0:r.width)||(g==null?void 0:g.width)||210,height_mm:(r==null?void 0:r.height)||(g==null?void 0:g.height)||297,workspace_width:($==null?void 0:$.width)||800,workspace_height:($==null?void 0:$.height)||600}};try{const j=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:n.id,status:"ready_for_pdf",pdf_data:o,completed_at:new Date().toISOString()})});if(j.ok){const C=await j.json()}else console.warn("⚠️ Error marcando proyecto como completado")}catch(j){console.warn("⚠️ Error en marcado de completado:",j)}const a=Date.now(),i=n.id;window.currentProjectId=i,window.albumProjectId=i;let u=r.cover_image;Y&&Y["page-cover"]&&(u=Y["page-cover"]);let p=u;u&&u.startsWith("data:image/")&&u.length>1e5&&(p=r.cover_image||"/assets/img/default-album.jpg");const m={...g,project_id:i,canvas_project_id:n.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:r.width,height_mm:r.height,pages_count:l.length,workspace_dimensions:$,requires_pdf_generation:!0}},b=structuredClone(oe),E=b.findIndex(j=>j.id==m.id);return E==-1?b.push({...m,quantity:1}):b[E].quantity++,D(b),Z.success("Álbum agregado al carrito",{description:`${m.name} se ha añadido al carrito. El PDF se generará en el backend.`,icon:e.jsx(No,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:b,action:"add",product:m}})),!0}catch(s){return console.error("❌ === ERROR EN addAlbumToCart ==="),console.error("Error completo:",s),console.error("Stack trace:",s.stack),console.error("Mensaje del error:",s.message),Z.error("Error al agregar al carrito",{description:`Error específico: ${s.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!l||l.length===0)throw new Error("No hay páginas para finalizar");const o={design_data:{pages:(C=>C.map(P=>({id:P.id,type:P.type,pageNumber:P.pageNumber,layout:P.layout,cells:P.cells.map(w=>({id:w.id,elements:w.elements.map(k=>{const M={id:k.id,type:k.type,position:k.position,zIndex:k.zIndex||1};if(k.type==="image"){if(k.content.startsWith("data:image/")){const G=btoa(k.content.substring(0,100)).substring(0,20);M.content=`[BASE64_IMAGE_${G}]`,M.contentType=k.content.split(";")[0].split(":")[1],M.originalSize=k.content.length}else M.content=k.content;if(k.filters){const G=Object.entries(k.filters).filter(([X,B])=>B!==0&&B!==!1&&B!==null).reduce((X,[B,H])=>(X[B]=H,X),{});Object.keys(G).length>0&&(M.filters=G)}k.mask&&k.mask!=="none"&&(M.mask=k.mask),k.size&&(M.size=k.size),k.locked&&(M.locked=k.locked)}else if(k.type==="text"&&(M.content=k.content,k.style)){const G=Object.entries(k.style).filter(([X,B])=>!(X==="fontSize"&&B==="16px"||X==="color"&&B==="#000000"||X==="fontFamily"&&B==="Arial")).reduce((X,[B,H])=>(X[B]=H,X),{});Object.keys(G).length>0&&(M.style=G)}return M})}))})))(l),projectInfo:{id:n==null?void 0:n.id,item_id:g==null?void 0:g.id,title:g==null?void 0:g.title,preset_id:r==null?void 0:r.id},presetInfo:{id:r==null?void 0:r.id,name:r==null?void 0:r.name,cover_image:r==null?void 0:r.cover_image,content_image:r==null?void 0:r.content_image,back_cover_image:r==null?void 0:r.back_cover_image},workspace:{width:$.width,height:$.height,scale:$.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(Y).map(([C,P])=>[C,P]))},a=JSON.stringify(o),i=Math.round(a.length/1024),u=Math.round(i/1024*100)/100;let p=0,m=0;l.forEach(C=>{var P;(P=C.cells)==null||P.forEach(w=>{var k;(k=w.elements)==null||k.forEach(M=>{M.type==="image"&&M.content&&M.content.startsWith("data:image/")&&(p++,m+=M.content.length)})})});const b=Math.round(m/(1024*1024)*100)/100;if(i>1024&&!confirm(`El diseño contiene ${p} imágenes (${b} MB en imágenes). Payload completo: ${u} MB. Esto podría causar problemas al guardarlo. ¿Desea continuar de todos modos?`))return!1;const E=await fetch(`/api/canvas/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:a});if(!E.ok){let C="Error al finalizar el diseño";try{C=(await E.json()).message||C}catch{E.status===413?C="El diseño es demasiado grande para ser guardado. Intente simplificar las imágenes.":E.status>=500&&(C="Error del servidor. Intente nuevamente más tarde.")}throw new Error(C)}const j=await E.json();return!0}catch(t){console.error("Error al finalizar diseño:",t);let s=t.message;return t.message.includes("Failed to fetch")?s="Error de conexión. Verifique su conexión a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(s="Error de red. Intente nuevamente más tarde."),alert("Error al finalizar el diseño: "+s),!1}};const so=d.useCallback(async()=>{try{const{jsPDF:t}=await no(async()=>{const{jsPDF:G}=await import("./jspdf.es.min-D3plwuQr.js").then(X=>X.j);return{jsPDF:G}},__vite__mapDeps([0,1,2,3,4]));let s=(r==null?void 0:r.width)||21,o=(r==null?void 0:r.height)||29.7;const a=.3,i=s+a*2,u=o+a*2,p=i*28.35,m=u*28.35,b=new t({orientation:p>m?"landscape":"portrait",unit:"pt",format:[p,m],compress:!1}),E=l.length;let j=0;const C=document.createElement("div");C.id="pdf-progress",C.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",C.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${E} páginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(C);const P=G=>{const X=G/E*100;document.getElementById("pdf-progress-bar").style.width=`${X}%`,document.getElementById("current-page").textContent=G},w=c;for(let G=0;G<l.length;G++){const X=l[G];ee(G),await new Promise(B=>setTimeout(B,500));try{const B=await ye({type:"pdf"});if(B){const H=B.width/B.height,ve=p/m;let ie,ce,pe=0,Ae=0;H>ve?(ie=p,ce=p/H,Ae=(m-ce)/2):(ce=m,ie=m*H,pe=(p-ie)/2);const ke=B.toDataURL("image/png",1);G>0&&b.addPage([p,m]),b.addImage(ke,"PNG",pe,Ae,ie,ce)}else console.warn(`⚠️ No se pudo capturar la página ${G+1}`),G>0&&b.addPage([p,m]),b.setFontSize(12),b.text(`Error al renderizar página ${G+1}`,p/2,m/2,{align:"center"})}catch(B){console.error(`❌ Error procesando página ${G+1}:`,B),G>0&&b.addPage([p,m]),b.setFontSize(12),b.text(`Error al procesar página ${G+1}`,p/2,m/2,{align:"center"})}j++,P(j),await new Promise(B=>setTimeout(B,200))}ee(w);const k=`${(g==null?void 0:g.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;b.save(k),document.body.removeChild(C);const M=document.createElement("div");return M.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",M.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${k}</span>
                </div>
            `,document.body.appendChild(M),setTimeout(()=>{document.body.contains(M)&&document.body.removeChild(M)},5e3),k}catch(t){console.error("❌ Error generando PDF:",t);const s=document.getElementById("pdf-progress");s&&document.body.removeChild(s);const o=document.createElement("div");throw o.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",o.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(o),setTimeout(()=>{document.body.contains(o)&&document.body.removeChild(o)},7e3),t}},[l,c,ee,ye,r,g]);return window.generateAlbumPDF=so,window.generateHighQualityThumbnail=Fs,window.captureCurrentWorkspace=ye,e.jsxs(ro,{backend:io,className:"!h-screen !w-screen overflow-hidden",children:[O?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu álbum personalizado..."})]})}):N?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:N}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):l.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando páginas del álbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx(xo,{isOpen:Ws,onRequestClose:()=>jt(!1),pages:l.map(t=>({...t,layout:ae.find(s=>s.id===t.layout)||ae[0]})),workspaceDimensions:$,getCurrentLayout:t=>t?ae.find(s=>s.id===t.layout)||ae[0]:ae[0],presetData:r,pageThumbnails:Y,addAlbumToCart:to,projectData:n,itemData:g}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(wo,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Ds,disabled:ge<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(lo,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:eo,disabled:ge>=fe.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(co,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(n==null?void 0:n.name)||"Álbum Sin Título",onChange:t=>h({...n,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del diseño"})}),e.jsxs("div",{className:"flex items-center gap-4",children:[(L.length>0||V)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:V?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",L.length]})]})}),e.jsx(qo,{saveStatus:be.saveStatus,lastSaved:be.lastSaved,lastAutoSaved:be.lastAutoSaved,hasUnsavedChanges:F.hasUnsavedChanges||!!(R instanceof Map&&R.has(c)),isOnline:be.isOnline,saveError:be.saveError,onManualSave:Qs,saveQueueSize:L.length,isProcessingQueue:V,pageChangesCount:R instanceof Map?R.size:0}),L.length>0&&e.jsxs("button",{onClick:()=>{console.log("🔧 [DEBUG] Procesando cola manualmente"),nt()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(Rs,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsxs("div",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:["P",c,": ",R instanceof Map&&R.has(c)?"🔴":"🟢"]}),e.jsx("button",{onClick:()=>{console.log("🔧 [DEBUG] Marcando página actual como modificada"),U(t=>{const s=new Map(t);return s.set(c,Date.now()),s})},className:"text-xs text-white bg-green-500 hover:bg-green-600 px-2 py-1 rounded",children:"Marcar Modificada"}),e.jsx(Be,{variant:"secondary",size:"sm",onClick:()=>jt(!0),icon:e.jsx(qe,{className:"h-4 w-4"}),children:"Vista de Álbum"}),e.jsx("div",{className:"relative",children:e.jsx("button",{className:"h-8 w-8 rounded-full bg-[#af5cb8] flex items-center justify-center text-white font-medium",children:e.jsx(Eo,{className:"h-4 w-4"})})})]})]})}),e.jsxs("div",{className:`flex h-full ${W?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{onClick:()=>te("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${_==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(qe,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Páginas"})]}),e.jsxs("button",{onClick:()=>te("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${_==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(ut,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Diseños"})]}),e.jsxs("button",{onClick:()=>te("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${_==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Qe,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{onClick:()=>te("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${_==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ts,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]}),e.jsxs("button",{onClick:()=>te("filters"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${_==="filters"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(ks,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Filtros"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[_==="templates"&&"Templates",_==="images"&&"Images",_==="text"&&"Text",_==="shapes"&&"Shapes",_==="stickers"&&"Stickers",_==="pages"&&"Pages",_==="panel"&&"Layers Panel",_==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[_==="templates"&&"Choose a template to get started",_==="images"&&"Search for images",_==="text"&&"Add and edit text",_==="shapes"&&"Add shapes and graphics",_==="stickers"&&"Add fun stickers",_==="pages"&&"Manage your pages",_==="panel"&&"Organize layers and z-index",_==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(Po,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[_==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ut,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Uo,{currentLayoutId:(_t=l[c])==null?void 0:_t.layout,onLayoutChange:Xs})]}),_==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ie,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Imágenes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[xe.length," imagen",xe.length!==1?"s":""]})]}),e.jsx(Qo,{images:xe,onImageSelect:Ks,isLoading:Xe})]}),_==="text"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>it("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"Título Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Ke,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>it("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subtítulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Ke,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>it("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Ke,{className:"h-4 w-4"})})]})})]}),_==="text"&&W&&((zt=Q())==null?void 0:zt.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(Oo,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=Q();ne(A,W,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((Vt=(Ft=Q())==null?void 0:Ft.style)==null?void 0:Vt.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=Q();ne(A,W,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((Gt=(Wt=Q())==null?void 0:Wt.style)==null?void 0:Gt.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=Q();ne(A,W,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((Ht=(Bt=Q())==null?void 0:Bt.style)==null?void 0:Ht.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipografía:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Kt=(qt=Q())==null?void 0:qt.style)==null?void 0:Kt.fontFamily)||"Arial",onChange:t=>{const s=Q();ne(A,W,{style:{...s.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tamaño:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Jt=(Qt=Q())==null?void 0:Qt.style)==null?void 0:Jt.fontSize)||"16px",onChange:t=>{const s=Q();ne(A,W,{style:{...s.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Xt=(Yt=Q())==null?void 0:Yt.style)==null?void 0:Xt.color)||"#000000",onChange:t=>{const s=Q();ne(A,W,{style:{...s.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((Dt=(Zt=Q())==null?void 0:Zt.style)==null?void 0:Dt.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((ts=(es=Q())==null?void 0:es.style)==null?void 0:ts.backgroundColor)||"#ffffff",onChange:t=>{const s=Q();ne(A,W,{style:{...s.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=Q();ne(A,W,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"🚫"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var s,o;return e.jsxs("button",{onClick:()=>{const a=Q();ne(A,W,{style:{...a.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((o=(s=Q())==null?void 0:s.style)==null?void 0:o.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"⬅",t==="center"&&"⬌",t==="right"&&"➡",t==="justify"&&"⬍"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((os=(ss=Q())==null?void 0:ss.style)==null?void 0:os.lineHeight)||"1.5",onChange:t=>{const s=Q();ne(A,W,{style:{...s.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((as=(ns=Q())==null?void 0:ns.style)==null?void 0:as.letterSpacing)||"normal",onChange:t=>{const s=Q();ne(A,W,{style:{...s.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=Q();ne(A,W,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((is=(rs=Q())==null?void 0:rs.style)==null?void 0:is.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAYÚS"]}),e.jsxs("button",{onClick:()=>{const t=Q();ne(A,W,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((cs=(ls=Q())==null?void 0:ls.style)==null?void 0:cs.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"minús"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((gs=(ds=Q())==null?void 0:ds.style)==null?void 0:gs.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((hs=(us=Q())==null?void 0:us.style)==null?void 0:hs.opacity)||"1",onChange:t=>{const s=Q();ne(A,W,{style:{...s.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((fs=(ms=Q())==null?void 0:ms.style)==null?void 0:fs.opacity)||1)*100}%, #e5e7eb ${(((xs=(ps=Q())==null?void 0:ps.style)==null?void 0:xs.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),_==="pages"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(qe,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[l.length," total"]})]}),l.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando páginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),rt.cover.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${c===l.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>at(l.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(ht,{pageId:t.id,thumbnail:Y[t.id],altText:"Cover",type:"cover"}),R instanceof Map&&R.has&&R.has(l.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:rt.content.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${c===l.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>at(l.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(ht,{pageId:t.id,thumbnail:Y[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),R instanceof Map&&R.has&&R.has(l.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),rt.final.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${c===l.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>at(l.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(ht,{pageId:t.id,thumbnail:Y[t.id],altText:"Back Cover",type:"final"}),R instanceof Map&&R.has&&R.has(l.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),_==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Lo,{pages:l,currentPage:c,selectedCell:A,selectedElement:W,onSelectCell:J,onSelectElement:de,onUpdateElement:(t,s,o)=>{ne(t,s,o)},onDeleteElement:(t,s)=>{Fe(t,s)},onMoveElement:(t,s,o)=>{Zs(t,s,o)}})}),_==="filters"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ks,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=Q();return t?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx($o,{selectedMask:t.mask||"none",onSelect:s=>{ne(A,W,{mask:s})},availableMasks:Os.map(s=>s.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(go,{filters:t.filters||{},onFilterChange:s=>{ne(A,W,{filters:s})},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(Ie,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an element"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Choose an image or text element to apply filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>te("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(ut,{className:"h-4 w-4"}),"Diseño de página"]}),e.jsxs("button",{onClick:()=>te("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Qe,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(Be,{variant:"ghost",tooltip:"Añadir Imagen",onClick:()=>st.current&&st.current.click(),children:e.jsx(Ie,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:st,onChange:qs,className:"hidden",accept:"image/*"})]}),W&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(Be,{variant:"ghost",size:"sm",onClick:()=>{if(W&&A){const t=Q();if(t){const s={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};Le(A,s)}}},className:"h-8 px-2",icon:e.jsx(jo,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(Be,{variant:"ghost",size:"sm",onClick:()=>{W&&A&&Fe(A,W)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(ft,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{className:"flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100",children:$s?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:$.width,height:$.height},children:e.jsx("div",{id:`page-${l[c].id}`,className:`grid ${we().template} gap-6`,style:{width:"100%",height:"100%"},children:l[c].cells.map((t,s)=>{var o;return e.jsx(Ns,{id:t.id,elements:t.elements.filter(a=>!a.locked),workspaceSize:$,cellStyle:(o=we().cellStyles)==null?void 0:o[l[c].cells.indexOf(t)],selectedElement:A===t.id?W:null,onSelectElement:Ot,onAddElement:(a,i)=>Le(i,a),onUpdateElement:(a,i,u)=>ne(t.id,a,i,u),onDeleteElement:a=>Fe(t.id,a),availableMasks:we().maskCategories.flatMap(a=>a.masks),projectData:n},t.id)})})})}):e.jsxs("div",{id:`page-${l[c].id}`,className:" shadow-xl overflow-hidden",style:{width:$.width,height:$.height,position:"relative",backgroundColor:((bs=l[c])==null?void 0:bs.backgroundColor)||"#ffffff",backgroundImage:(ys=l[c])!=null&&ys.backgroundImage?`url(${l[c].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=l[c];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${we().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((vs=we().style)==null?void 0:vs.gap)||"16px",padding:((ws=we().style)==null?void 0:ws.padding)||"16px"},children:l[c].cells.map(t=>{var s;return e.jsx(Ns,{id:t.id,elements:t.elements.filter(o=>!o.locked),workspaceSize:$,cellStyle:(s=we().cellStyles)==null?void 0:s[l[c].cells.indexOf(t)],selectedElement:A===t.id?W:null,onSelectElement:Ot,onAddElement:(o,a)=>Le(a,o),onUpdateElement:(o,a,i)=>ne(t.id,o,a,i),onDeleteElement:o=>Fe(t.id,o),availableMasks:we().maskCategories.flatMap(o=>o.masks),projectData:n},t.id)})})]})})]})]})]}),e.jsx(po,{}),e.jsx(Ko,{isOpen:Gs,onClose:()=>Nt(!1),savedProgress:Bs,onLoadProgress:Js,onDiscardProgress:Ys})]})}export{Yn as default};
