import{j as r}from"./AboutSimple-Cf8x2fCZ.js";import{B as J}from"./Base-Bzg5c0XG.js";import{S as Y}from"./SwitchFormGroup-CGYpv_4Q.js";import{T as z}from"./TextareaFormGroup-DVzYJtLM.js";import{r as s}from"./index-BH53Isel.js";import{c as H}from"./ReactAppend-DTVVXReZ.js";import{s as p}from"./server.browser-Bf4gQIc7.js";import{S as A}from"./ProductCard-CRhBSmWZ.js";import{B as W}from"./BasicRest-C4m6wu80.js";import{t as x}from"./index-BZYhE2TF.js";import{m as F}from"./main-6DCdASTx.js";import{M as K}from"./Modal-B6PZ5H4-.js";import{T as Q}from"./Table-DitbKwtZ.js";import{I as a}from"./InputFormGroup-D5I6zpZc.js";import{S as X}from"./SelectFormGroup-BmhC2uob.js";import{D as B}from"./DxButton-DV0H-ZcL.js";import{C as Z}from"./CreateReactScript-DERNRfBB.js";import{N as O}from"./Number2Currency-e57Tgsuk.js";import{R as ee}from"./ReactAppend-D7S498fx.js";import"./index-yBjzXJbu.js";import"./Global-D6eBBAMK.js";import"./tippy-react.esm-BWiGTO87.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";/* empty css              */import"./Logout-TGKOqZqZ.js";import"./MenuItemContainer-CY0sLPNq.js";import"./index.esm-POOiSFi2.js";import"./index-Dq7h7Pqt.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";/* empty css               */import"./General-BmbBKdsB.js";import"./LaravelSession-Dz9cpV3l.js";class re extends W{constructor(){super(),this.path="admin/coupons"}async validate(o,n={}){try{const{status:c,result:l}=await F.Fetch(`/api/${this.path}/validate`,{method:"POST",body:JSON.stringify({code:o,cart_total:n.total||0,category_ids:n.category_ids||[],product_ids:n.product_ids||[]}),headers:{"Content-Type":"application/json"}});return l.valid?(x.success("¡Excelente!",{description:l.message,duration:3e3,position:"bottom-center",richColors:!0}),l):(x.error("¡Error!",{description:l.message,duration:3e3,position:"bottom-center",richColors:!0}),null)}catch(c){return x.error("¡Error!",{description:c.message||"Error al validar el cupón",duration:3e3,position:"bottom-center",richColors:!0}),null}}async generateCode(){var o;try{const{status:n,result:c}=await F.Fetch(`/api/${this.path}/generate-code`);return n?((o=c.data)==null?void 0:o.code)||c.code:null}catch{return x.error("¡Error!",{description:"Error al generar código",duration:3e3,position:"bottom-center",richColors:!0}),null}}async checkFirstPurchaseCoupon(o=0){try{const{status:n,result:c}=await F.Fetch(`/api/${this.path}/check-first-purchase-coupon`,{method:"POST",body:JSON.stringify({current_id:o}),headers:{"Content-Type":"application/json"}});return n&&c.exists}catch{return x.error("¡Error!",{description:"Error al verificar cupones de primera compra",duration:3e3,position:"bottom-center",richColors:!0}),!1}}}const d=new re,te=({categories:T,products:o})=>{const[n,c]=s.useState(!1),l=s.useRef(),N=s.useRef(),f=s.useRef(),u=s.useRef(),g=s.useRef(),v=s.useRef(),b=s.useRef(),j=s.useRef(),y=s.useRef(),R=s.useRef(),w=s.useRef(),C=s.useRef(),S=s.useRef(),_=s.useRef(),h=s.useRef(),[se,E]=s.useState(!1),k=e=>{e!=null&&e.id?c(!0):c(!1),$(N.current).modal("show"),setTimeout(()=>{f.current&&(f.current.value=(e==null?void 0:e.id)??""),u.current&&(u.current.value=(e==null?void 0:e.code)??""),g.current&&(g.current.value=(e==null?void 0:e.name)??""),v.current&&(v.current.value=(e==null?void 0:e.description)??""),j.current&&(j.current.value=(e==null?void 0:e.value)??""),y.current&&(y.current.value=(e==null?void 0:e.minimum_amount)??""),R.current&&(R.current.value=(e==null?void 0:e.usage_limit)??""),w.current&&(w.current.value=(e==null?void 0:e.usage_limit_per_user)??1),_.current&&(_.current.value=(e==null?void 0:e.maximum_discount)??""),C.current&&(C.current.value=e!=null&&e.starts_at?D(new Date(e.starts_at)):""),S.current&&(S.current.value=e!=null&&e.expires_at?D(new Date(e.expires_at)):""),h.current&&(h.current.checked=(e==null?void 0:e.first_purchase_only)??!1);const t=(e==null?void 0:e.type)||"percentage";b.current&&($(b.current).val(t).trigger("change"),E(t==="percentage"))},100)},D=e=>{const t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),m=String(e.getDate()).padStart(2,"0"),M=String(e.getHours()).padStart(2,"0"),P=String(e.getMinutes()).padStart(2,"0");return`${t}-${i}-${m}T${M}:${P}`},G=async e=>{if(e.preventDefault(),h.current.checked){const m=document.querySelector('input[name="active"]');if((m?m.checked:!0)&&await d.checkFirstPurchaseCoupon(f.current.value||0)){A.fire({title:"Error de validación",text:"Ya existe un cupón activo para primera compra. Desactive ese cupón antes de crear uno nuevo o desmarque la opción 'Solo primera compra'.",icon:"error"});return}}const t={id:f.current.value||void 0,code:u.current.value,name:g.current.value,description:v.current.value,type:b.current.value,value:j.current.value,minimum_amount:y.current.value||0,usage_limit:R.current.value||null,usage_limit_per_user:w.current.value,starts_at:C.current.value,expires_at:S.current.value,maximum_discount:_.current.value||null,first_purchase_only:h.current.checked?1:0};await d.save(t)&&($(l.current).dxDataGrid("instance").refresh(),$(N.current).modal("hide"))},q=async({id:e,value:t})=>{await d.boolean({id:e,field:"active",value:t})&&$(l.current).dxDataGrid("instance").refresh()},I=async e=>{const{isConfirmed:t}=await A.fire({title:"Eliminar cupón",text:"¿Estás seguro de eliminar este cupón?",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"});!t||!await d.delete(e)||$(l.current).dxDataGrid("instance").refresh()},L=e=>{E(e.target.value==="percentage")},U=async()=>{const e=await d.generateCode();e&&u.current&&(u.current.value=e)},V=e=>({active:"badge-success",expired:"badge-danger",pending:"badge-warning",exhausted:"badge-secondary",inactive:"badge-dark"})[e]||"badge-secondary";return r.jsxs(r.Fragment,{children:[r.jsx(Q,{gridRef:l,title:"Cupones",rest:d,toolBar:e=>{e.unshift({widget:"dxButton",location:"after",options:{icon:"refresh",hint:"Refrescar tabla",onClick:()=>$(l.current).dxDataGrid("instance").refresh()}}),e.unshift({widget:"dxButton",location:"after",options:{icon:"plus",text:"Agregar",hint:"Agregar cupón",onClick:()=>k()}})},exportable:!0,exportableName:"Cupones",columns:[{dataField:"id",caption:"ID",visible:!1},{dataField:"code",caption:"Código",width:"120px",cellTemplate:(e,{data:t})=>{e.html(p.renderToString(r.jsxs("div",{children:[r.jsx("strong",{className:"font-monospace",children:t.code}),r.jsx("br",{}),r.jsx("span",{className:`badge ${V(t.status)} badge-sm`,children:t.status_text})]})))}},{dataField:"name",caption:"Nombre",minWidth:"200px",cellTemplate:(e,{data:t})=>{e.html(p.renderToString(r.jsxs("div",{children:[r.jsx("strong",{children:t.name}),t.description&&r.jsxs(r.Fragment,{children:[r.jsx("br",{}),r.jsx("small",{className:"text-muted",children:t.description.length>50?t.description.substring(0,50)+"...":t.description})]})]})))}},{dataField:"type",caption:"Tipo",width:"100px",cellTemplate:(e,{data:t})=>{const i=t.type==="percentage"?"Porcentaje":"Monto Fijo",m=t.type==="percentage"?"badge-info":"badge-primary";e.html(p.renderToString(r.jsx("span",{className:`badge ${m}`,children:i})))}},{dataField:"value",caption:"Valor",width:"100px",cellTemplate:(e,{data:t})=>{const i=t.type==="percentage"?`${t.value}%`:`S/. ${O(t.value)}`;e.html(p.renderToString(r.jsx("strong",{children:i})))}},{dataField:"minimum_amount",caption:"Mín. Compra",width:"110px",cellTemplate:(e,{data:t})=>{e.html(p.renderToString(r.jsxs("span",{children:["S/. ",O(t.minimum_amount)]})))}},{dataField:"usage_limit",caption:"Usos",width:"80px",cellTemplate:(e,{data:t})=>{const i=t.usage_limit?`${t.used_count}/${t.usage_limit}`:`${t.used_count}/∞`;e.html(p.renderToString(r.jsx("span",{children:i})))}},{dataField:"starts_at",caption:"Inicio",dataType:"datetime",width:"110px",format:"dd/MM/yyyy"},{dataField:"expires_at",caption:"Expiración",dataType:"datetime",width:"110px",format:"dd/MM/yyyy"},{dataField:"active",caption:"Activo",dataType:"boolean",width:"80px",cellTemplate:(e,{data:t})=>{ee(e,r.jsx(Y,{checked:t.active,onChange:i=>q({id:t.id,value:i.target.checked})}))}},{caption:"Acciones",width:"100px",cellTemplate:(e,{data:t})=>{e.css("text-overflow","unset"),e.append(B({className:"btn btn-xs btn-soft-primary",title:"Editar",icon:"fa fa-pen",onClick:()=>k(t)})),e.append(B({className:"btn btn-xs btn-soft-danger",title:"Eliminar",icon:"fa fa-trash",onClick:()=>I(t.id)}))},allowFiltering:!1,allowExporting:!1}]}),r.jsx(K,{modalRef:N,title:n?"Editar cupón":"Agregar cupón",onSubmit:G,size:"xl",children:r.jsxs("div",{className:"row",id:"coupons-form",children:[r.jsx("input",{ref:f,type:"hidden"}),r.jsxs("div",{className:"col-md-6",children:[r.jsxs("div",{className:"row",children:[r.jsx("div",{className:"col-md-8",children:r.jsx(a,{eRef:u,label:"Código del cupón",required:!0,placeholder:"Ej: DESCUENTO20"})}),r.jsxs("div",{className:"col-md-4",children:[r.jsx("label",{className:"form-label",children:" "}),r.jsx("button",{type:"button",className:"btn btn-outline-secondary d-block",onClick:U,children:"Generar"})]})]}),r.jsx(a,{eRef:g,label:"Nombre",required:!0,placeholder:"Nombre descriptivo del cupón"}),r.jsx(z,{eRef:v,label:"Descripción",rows:3,placeholder:"Descripción del cupón"}),r.jsxs("div",{className:"row",children:[r.jsx("div",{className:"col-md-6",children:r.jsxs(X,{eRef:b,label:"Tipo de descuento",required:!0,onChange:L,dropdownParent:"#coupons-form",children:[r.jsx("option",{value:"percentage",children:"Porcentaje"}),r.jsx("option",{value:"fixed",children:"Monto fijo"})]})}),r.jsx("div",{className:"col-md-6",children:r.jsx(a,{eRef:j,label:"Valor",type:"number",step:"0.01",min:"0",required:!0,placeholder:"Ej: 20 o 50.00"})})]}),r.jsx(a,{eRef:_,label:"Descuento máximo (S/.)",type:"number",step:"0.01",min:"0",placeholder:"Opcional - límite máximo de descuento"}),r.jsx(a,{eRef:y,label:"Monto mínimo de compra (S/.)",type:"number",step:"0.01",min:"0",placeholder:"0.00"})]}),r.jsxs("div",{className:"col-md-6",children:[r.jsxs("div",{className:"row",children:[r.jsx("div",{className:"col-md-6",children:r.jsx(a,{eRef:R,label:"Límite de usos",type:"number",min:"1",placeholder:"Dejar vacío para ilimitado"})}),r.jsx("div",{className:"col-md-6",children:r.jsx(a,{eRef:w,label:"Usos por usuario",type:"number",min:"1",defaultValue:"1",required:!0})})]}),r.jsxs("div",{className:"row",children:[r.jsx("div",{className:"col-md-6",children:r.jsx(a,{eRef:C,label:"Fecha de inicio",type:"datetime-local"})}),r.jsx("div",{className:"col-md-6",children:r.jsx(a,{eRef:S,label:"Fecha de expiración",type:"datetime-local"})})]}),r.jsxs("div",{className:"form-check mb-3",children:[r.jsx("input",{ref:h,className:"form-check-input",type:"checkbox",id:"firstPurchaseOnly"}),r.jsx("label",{className:"form-check-label",htmlFor:"firstPurchaseOnly",children:"Solo primera compra"})]})]})]})})]})};Z((T,o)=>{H.createRoot(T).render(r.jsx(J,{...o,title:"Cupones",children:r.jsx(te,{...o})}))});
