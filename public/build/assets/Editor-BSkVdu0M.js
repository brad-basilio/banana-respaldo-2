const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as rr}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as h,R as Ht}from"./index-BH53Isel.js";import{T as En,l as ie,i as Cn,D as ar,H as sr,U as ir,R as lr,B as gt,F as cr,E as cn}from"./EditableCell-DczCXCx2.js";import{h as dn}from"./thumbnailGenerator-B4goYG9Y.js";import{g as Ut,a as un,b as gn,c as $t,B as bt}from"./dom-to-image-more.min-BDwmsQ8h.js";import{L as vt}from"./layers-6oegOx-p.js";import{C as dr}from"./chevron-down-DS-mdh9v.js";import{C as ur}from"./chevron-right-Ckt5D2ka.js";import{E as gr}from"./eye-CKCH9ORv.js";import{c as Se}from"./createLucideIcon-Cy5Ya80P.js";import{T as Nn}from"./trash-2-DK1wnsDn.js";import{S as mr}from"./star-wPQTHY_n.js";import{I as Ve}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as oe,T as pr}from"./index-BZYhE2TF.js";import{m as mn}from"./main-6DCdASTx.js";import{B as hr}from"./V1Edit-CxI6v2uA.js";import{G as pn}from"./Global-D6eBBAMK.js";import{S as Tn}from"./save-BvSyoVHO.js";import{C as fr}from"./clock-BTrEpQej.js";import{T as br}from"./triangle-alert-vFMqKi4t.js";import{C as xr}from"./check-DQ7QoS0v.js";import{L as vr}from"./loader-circle-CrvBvIt1.js";import{C as wr}from"./chevron-left-B2s3ZsB7.js";import{P as xt}from"./plus-Bot15Khs.js";import{F as yr}from"./filter-Ci9tsc_e.js";import{C as Er}from"./copy-6OEekgvq.js";import{C as Cr}from"./circle-check-big-D6DM3vPb.js";import{u as Nr}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tr=Se("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ar=Se("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sr=Se("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jr=Se("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kr=Se("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Or=Se("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=Se("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ir=Se("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _r=Se("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hn=Se("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rr=Se("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Pr=({pages:n,currentPage:d,selectedCell:a,selectedElement:b,onSelectCell:s,onSelectElement:x,onUpdateElement:T,onDeleteElement:k,onMoveElement:A})=>{var K;if(!n||!n[d])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(vt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const v=n[d],M=((K=v==null?void 0:v.cells)==null?void 0:K.filter(L=>L.elements&&L.elements.length>0))||[],[W,S]=h.useState(()=>{const L={};return M.forEach(D=>{L[D.id]=!0}),L}),R=L=>{S(D=>({...D,[L]:!D[L]}))},O=L=>{switch(L){case"image":return e.jsx(Ve,{className:"h-4 w-4"});case"text":return e.jsx(En,{className:"h-4 w-4"});case"shape":return e.jsx(_r,{className:"h-4 w-4"});case"sticker":return e.jsx(mr,{className:"h-4 w-4"});default:return e.jsx(jr,{className:"h-4 w-4"})}},F=(L,D)=>{switch(L.type){case"text":return L.content?L.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${D+1}`;case"shape":return L.shape||"Shape";case"sticker":return`Sticker ${D+1}`;default:return`Element ${D+1}`}},P=(L,D,ee)=>{T(L,D,{visible:ee})},q=(L,D)=>{s(L),x(D)};return e.jsx("div",{className:"space-y-2",children:M.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(vt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):M.map(L=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${a===L.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{R(L.id),s(L.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:W[L.id]?e.jsx(dr,{className:"h-4 w-4"}):e.jsx(ur,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",L.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[L.elements.length," element",L.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[L.x,", ",L.y]})]}),W[L.id]&&e.jsx("div",{className:"border-t border-gray-100",children:L.elements.map((D,ee)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${b===D.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>q(L.id,D.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:O(D.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:F(D,ee)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[D.type," • Layer ",ee+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Q=>{Q.stopPropagation(),P(L.id,D.id,!D.visible)},className:"p-1 hover:bg-gray-200 rounded",title:D.visible?"Hide element":"Show element",children:D.visible!==!1?e.jsx(gr,{className:"h-3 w-3 text-gray-500"}):e.jsx(Or,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:Q=>{Q.stopPropagation(),A(L.id,D.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:ee===L.elements.length-1,children:e.jsx(Ar,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:Q=>{Q.stopPropagation(),A(L.id,D.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:ee===0,children:e.jsx(Tr,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:Q=>{Q.stopPropagation(),k(L.id,D.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(Nn,{className:"h-3 w-3"})})]})]},D.id))})]},L.id))})};function Lr({currentLayoutId:n,onLayoutChange:d}){const[a,b]=h.useState("all"),s={all:{name:"Todos",layouts:ie},hero:{name:"Hero",layouts:ie.filter(x=>x.category==="hero")},editorial:{name:"Editorial",layouts:ie.filter(x=>x.category==="editorial")},storytelling:{name:"Historia",layouts:ie.filter(x=>x.category==="storytelling")},minimal:{name:"Minimal",layouts:ie.filter(x=>x.category==="minimal")},creative:{name:"Creativo",layouts:ie.filter(x=>x.category==="creative")},classic:{name:"Clásico",layouts:ie.filter(x=>x.category==="classic")}};return Object.keys(s).filter(x=>x==="all"||s[x].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:s[a].layouts.map(x=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>d(x.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${x.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:x.cells}).map((T,k)=>{var A,v;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(v=(A=x.cellStyles)==null?void 0:A[k])!=null&&v.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},k)})}),n===x.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:x.name}),x.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:x.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[x.cells," ",x.cells===1?"celda":"celdas"]})})]})]},x.id))}),s[a].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categoría."})})]})}const Mr=({selectedMask:n,onSelect:d,availableMasks:a=[],selectedImage:b})=>{var k,A;const[s,x]=h.useState("Básicas"),T={};return Cn.forEach(v=>{T[v.category]||(T[v.category]=[]),(a.includes(v.id)||v.id==="none")&&T[v.category].push(v)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(T).slice(0,2).map(v=>T[v].length>0&&e.jsx("button",{onClick:()=>x(v),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${s===v?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:v},v))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(k=T[s])==null?void 0:k.slice(0,6).map(v=>e.jsxs("div",{onClick:()=>d(v.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${n===v.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:b!=null&&b.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:v.id==="circle"?"circle(50%)":v.id==="rounded"||v.id==="rounded-sm"?"inset(0 round 8%)":v.id==="rounded-lg"?"inset(0 round 16%)":v.id==="rounded-rect"?"inset(0 round 12%)":v.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":v.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":v.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":v.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":v.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":v.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":v.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":v.id==="frame"?"inset(10% round 10%)":v.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':v.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':v.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:b.content,alt:v.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:v.id==="circle"?"circle(50%)":v.id==="rounded"||v.id==="rounded-sm"?"inset(0 round 8%)":v.id==="rounded-lg"?"inset(0 round 16%)":v.id==="rounded-rect"?"inset(0 round 12%)":v.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":v.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":v.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":v.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":v.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":v.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":v.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":v.id==="frame"?"inset(10% round 10%)":v.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':v.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':v.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:v.name})]},v.id))}),((A=T[s])==null?void 0:A.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver más máscaras (",T[s].length-6," más)"]})]})};let Vt={},An;function zt(n={}){Vt={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...n}}function B(n){return n?Vt[n]:Vt}function Ur(n){An=n}function Ne(){return An}let wt={};function mt(n,d){wt[n]=d}function De(n){var d;(d=wt[n])==null||d.call(wt)}function $r(){wt={}}function pt(n,d,a,b){return(n/=b/2)<1?a/2*n*n+d:-a/2*(--n*(n-2)-1)+d}function Sn(n){const d='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return n.flatMap(a=>{const b=a.matches(d),s=Array.from(a.querySelectorAll(d));return[...b?[a]:[],...s]}).filter(a=>getComputedStyle(a).pointerEvents!=="none"&&Fr(a))}function jn(n){if(!n||zr(n))return;const d=B("smoothScroll"),a=n.offsetHeight>window.innerHeight;n.scrollIntoView({behavior:!d||Br(n)?"auto":"smooth",inline:"center",block:a?"start":"center"})}function Br(n){if(!n||!n.parentElement)return;const d=n.parentElement;return d.scrollHeight>d.clientHeight}function zr(n){const d=n.getBoundingClientRect();return d.top>=0&&d.left>=0&&d.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&d.right<=(window.innerWidth||document.documentElement.clientWidth)}function Fr(n){return!!(n.offsetWidth||n.offsetHeight||n.getClientRects().length)}let yt={};function me(n,d){yt[n]=d}function G(n){return n?yt[n]:yt}function fn(){yt={}}function Gr(n,d,a,b){let s=G("__activeStagePosition");const x=s||a.getBoundingClientRect(),T=b.getBoundingClientRect(),k=pt(n,x.x,T.x-x.x,d),A=pt(n,x.y,T.y-x.y,d),v=pt(n,x.width,T.width-x.width,d),M=pt(n,x.height,T.height-x.height,d);s={x:k,y:A,width:v,height:M},On(s),me("__activeStagePosition",s)}function kn(n){if(!n)return;const d=n.getBoundingClientRect(),a={x:d.x,y:d.y,width:d.width,height:d.height};me("__activeStagePosition",a),On(a)}function Hr(){const n=G("__activeStagePosition"),d=G("__overlaySvg");if(!n)return;if(!d){console.warn("No stage svg found.");return}const a=window.innerWidth,b=window.innerHeight;d.setAttribute("viewBox",`0 0 ${a} ${b}`)}function Vr(n){const d=Dr(n);document.body.appendChild(d),Rn(d,a=>{a.target.tagName==="path"&&De("overlayClick")}),me("__overlaySvg",d)}function On(n){const d=G("__overlaySvg");if(!d){Vr(n);return}const a=d.firstElementChild;if((a==null?void 0:a.tagName)!=="path")throw new Error("no path element found in stage svg");a.setAttribute("d",In(n))}function Dr(n){const d=window.innerWidth,a=window.innerHeight,b=document.createElementNS("http://www.w3.org/2000/svg","svg");b.classList.add("driver-overlay","driver-overlay-animated"),b.setAttribute("viewBox",`0 0 ${d} ${a}`),b.setAttribute("xmlSpace","preserve"),b.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),b.setAttribute("version","1.1"),b.setAttribute("preserveAspectRatio","xMinYMin slice"),b.style.fillRule="evenodd",b.style.clipRule="evenodd",b.style.strokeLinejoin="round",b.style.strokeMiterlimit="2",b.style.zIndex="10000",b.style.position="fixed",b.style.top="0",b.style.left="0",b.style.width="100%",b.style.height="100%";const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",In(n)),s.style.fill=B("overlayColor")||"rgb(0,0,0)",s.style.opacity=`${B("overlayOpacity")}`,s.style.pointerEvents="auto",s.style.cursor="auto",b.appendChild(s),b}function In(n){const d=window.innerWidth,a=window.innerHeight,b=B("stagePadding")||0,s=B("stageRadius")||0,x=n.width+b*2,T=n.height+b*2,k=Math.min(s,x/2,T/2),A=Math.floor(Math.max(k,0)),v=n.x-b+A,M=n.y-b,W=x-A*2,S=T-A*2;return`M${d},0L0,0L0,${a}L${d},${a}L${d},0Z
    M${v},${M} h${W} a${A},${A} 0 0 1 ${A},${A} v${S} a${A},${A} 0 0 1 -${A},${A} h-${W} a${A},${A} 0 0 1 -${A},-${A} v-${S} a${A},${A} 0 0 1 ${A},-${A} z`}function Wr(){const n=G("__overlaySvg");n&&n.remove()}function qr(){const n=document.getElementById("driver-dummy-element");if(n)return n;let d=document.createElement("div");return d.id="driver-dummy-element",d.style.width="0",d.style.height="0",d.style.pointerEvents="none",d.style.opacity="0",d.style.position="fixed",d.style.top="50%",d.style.left="50%",document.body.appendChild(d),d}function bn(n){const{element:d}=n;let a=typeof d=="function"?d():typeof d=="string"?document.querySelector(d):d;a||(a=qr()),Qr(a,n)}function Kr(){const n=G("__activeElement"),d=G("__activeStep");n&&(kn(n),Hr(),Ln(n,d))}function Qr(n,d){var a;const b=Date.now(),s=G("__activeStep"),x=G("__activeElement")||n,T=!x||x===n,k=n.id==="driver-dummy-element",A=x.id==="driver-dummy-element",v=B("animate"),M=d.onHighlightStarted||B("onHighlightStarted"),W=(d==null?void 0:d.onHighlighted)||B("onHighlighted"),S=(s==null?void 0:s.onDeselected)||B("onDeselected"),R=B(),O=G();!T&&S&&S(A?void 0:x,s,{config:R,state:O,driver:Ne()}),M&&M(k?void 0:n,d,{config:R,state:O,driver:Ne()});const F=!T&&v;let P=!1;ea(),me("previousStep",s),me("previousElement",x),me("activeStep",d),me("activeElement",n);const q=()=>{if(G("__transitionCallback")!==q)return;const K=Date.now()-b,L=400-K<=400/2;d.popover&&L&&!P&&F&&(xn(n,d),P=!0),B("animate")&&K<400?Gr(K,400,x,n):(kn(n),W&&W(k?void 0:n,d,{config:B(),state:G(),driver:Ne()}),me("__transitionCallback",void 0),me("__previousStep",s),me("__previousElement",x),me("__activeStep",d),me("__activeElement",n)),window.requestAnimationFrame(q)};me("__transitionCallback",q),window.requestAnimationFrame(q),jn(n),!F&&d.popover&&xn(n,d),x.classList.remove("driver-active-element","driver-no-interaction"),x.removeAttribute("aria-haspopup"),x.removeAttribute("aria-expanded"),x.removeAttribute("aria-controls"),((a=d.disableActiveInteraction)!=null?a:B("disableActiveInteraction"))&&n.classList.add("driver-no-interaction"),n.classList.add("driver-active-element"),n.setAttribute("aria-haspopup","dialog"),n.setAttribute("aria-expanded","true"),n.setAttribute("aria-controls","driver-popover-content")}function Yr(){var n;(n=document.getElementById("driver-dummy-element"))==null||n.remove(),document.querySelectorAll(".driver-active-element").forEach(d=>{d.classList.remove("driver-active-element","driver-no-interaction"),d.removeAttribute("aria-haspopup"),d.removeAttribute("aria-expanded"),d.removeAttribute("aria-controls")})}function nt(){const n=G("__resizeTimeout");n&&window.cancelAnimationFrame(n),me("__resizeTimeout",window.requestAnimationFrame(Kr))}function Jr(n){var d;if(!G("isInitialized")||!(n.key==="Tab"||n.keyCode===9))return;const a=G("__activeElement"),b=(d=G("popover"))==null?void 0:d.wrapper,s=Sn([...b?[b]:[],...a?[a]:[]]),x=s[0],T=s[s.length-1];if(n.preventDefault(),n.shiftKey){const k=s[s.indexOf(document.activeElement)-1]||T;k==null||k.focus()}else{const k=s[s.indexOf(document.activeElement)+1]||x;k==null||k.focus()}}function _n(n){var d;((d=B("allowKeyboardControl"))==null||d)&&(n.key==="Escape"?De("escapePress"):n.key==="ArrowRight"?De("arrowRightPress"):n.key==="ArrowLeft"&&De("arrowLeftPress"))}function Rn(n,d,a){const b=(s,x)=>{const T=s.target;n.contains(T)&&((!a||a(T))&&(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation()),x==null||x(s))};document.addEventListener("pointerdown",b,!0),document.addEventListener("mousedown",b,!0),document.addEventListener("pointerup",b,!0),document.addEventListener("mouseup",b,!0),document.addEventListener("click",s=>{b(s,d)},!0)}function Xr(){window.addEventListener("keyup",_n,!1),window.addEventListener("keydown",Jr,!1),window.addEventListener("resize",nt),window.addEventListener("scroll",nt)}function Zr(){window.removeEventListener("keyup",_n),window.removeEventListener("resize",nt),window.removeEventListener("scroll",nt)}function ea(){const n=G("popover");n&&(n.wrapper.style.display="none")}function xn(n,d){var a,b;let s=G("popover");s&&document.body.removeChild(s.wrapper),s=oa(),document.body.appendChild(s.wrapper);const{title:x,description:T,showButtons:k,disableButtons:A,showProgress:v,nextBtnText:M=B("nextBtnText")||"Next &rarr;",prevBtnText:W=B("prevBtnText")||"&larr; Previous",progressText:S=B("progressText")||"{current} of {total}"}=d.popover||{};s.nextButton.innerHTML=M,s.previousButton.innerHTML=W,s.progress.innerHTML=S,x?(s.title.innerHTML=x,s.title.style.display="block"):s.title.style.display="none",T?(s.description.innerHTML=T,s.description.style.display="block"):s.description.style.display="none";const R=k||B("showButtons"),O=v||B("showProgress")||!1,F=(R==null?void 0:R.includes("next"))||(R==null?void 0:R.includes("previous"))||O;s.closeButton.style.display=R.includes("close")?"block":"none",F?(s.footer.style.display="flex",s.progress.style.display=O?"block":"none",s.nextButton.style.display=R.includes("next")?"block":"none",s.previousButton.style.display=R.includes("previous")?"block":"none"):s.footer.style.display="none";const P=A||B("disableButtons")||[];P!=null&&P.includes("next")&&(s.nextButton.disabled=!0,s.nextButton.classList.add("driver-popover-btn-disabled")),P!=null&&P.includes("previous")&&(s.previousButton.disabled=!0,s.previousButton.classList.add("driver-popover-btn-disabled")),P!=null&&P.includes("close")&&(s.closeButton.disabled=!0,s.closeButton.classList.add("driver-popover-btn-disabled"));const q=s.wrapper;q.style.display="block",q.style.left="",q.style.top="",q.style.bottom="",q.style.right="",q.id="driver-popover-content",q.setAttribute("role","dialog"),q.setAttribute("aria-labelledby","driver-popover-title"),q.setAttribute("aria-describedby","driver-popover-description");const K=s.arrow;K.className="driver-popover-arrow";const L=((a=d.popover)==null?void 0:a.popoverClass)||B("popoverClass")||"";q.className=`driver-popover ${L}`.trim(),Rn(s.wrapper,ge=>{var Te,Ue,g;const se=ge.target,f=((Te=d.popover)==null?void 0:Te.onNextClick)||B("onNextClick"),re=((Ue=d.popover)==null?void 0:Ue.onPrevClick)||B("onPrevClick"),ue=((g=d.popover)==null?void 0:g.onCloseClick)||B("onCloseClick");if(se.closest(".driver-popover-next-btn"))return f?f(n,d,{config:B(),state:G(),driver:Ne()}):De("nextClick");if(se.closest(".driver-popover-prev-btn"))return re?re(n,d,{config:B(),state:G(),driver:Ne()}):De("prevClick");if(se.closest(".driver-popover-close-btn"))return ue?ue(n,d,{config:B(),state:G(),driver:Ne()}):De("closeClick")},ge=>!(s!=null&&s.description.contains(ge))&&!(s!=null&&s.title.contains(ge))&&typeof ge.className=="string"&&ge.className.includes("driver-popover")),me("popover",s);const D=((b=d.popover)==null?void 0:b.onPopoverRender)||B("onPopoverRender");D&&D(s,{config:B(),state:G(),driver:Ne()}),Ln(n,d),jn(q);const ee=n.classList.contains("driver-dummy-element"),Q=Sn([q,...ee?[]:[n]]);Q.length>0&&Q[0].focus()}function Pn(){const n=G("popover");if(!(n!=null&&n.wrapper))return;const d=n.wrapper.getBoundingClientRect(),a=B("stagePadding")||0,b=B("popoverOffset")||0;return{width:d.width+a+b,height:d.height+a+b,realWidth:d.width,realHeight:d.height}}function vn(n,d){const{elementDimensions:a,popoverDimensions:b,popoverPadding:s,popoverArrowDimensions:x}=d;return n==="start"?Math.max(Math.min(a.top-s,window.innerHeight-b.realHeight-x.width),x.width):n==="end"?Math.max(Math.min(a.top-(b==null?void 0:b.realHeight)+a.height+s,window.innerHeight-(b==null?void 0:b.realHeight)-x.width),x.width):n==="center"?Math.max(Math.min(a.top+a.height/2-(b==null?void 0:b.realHeight)/2,window.innerHeight-(b==null?void 0:b.realHeight)-x.width),x.width):0}function wn(n,d){const{elementDimensions:a,popoverDimensions:b,popoverPadding:s,popoverArrowDimensions:x}=d;return n==="start"?Math.max(Math.min(a.left-s,window.innerWidth-b.realWidth-x.width),x.width):n==="end"?Math.max(Math.min(a.left-(b==null?void 0:b.realWidth)+a.width+s,window.innerWidth-(b==null?void 0:b.realWidth)-x.width),x.width):n==="center"?Math.max(Math.min(a.left+a.width/2-(b==null?void 0:b.realWidth)/2,window.innerWidth-(b==null?void 0:b.realWidth)-x.width),x.width):0}function Ln(n,d){const a=G("popover");if(!a)return;const{align:b="start",side:s="left"}=(d==null?void 0:d.popover)||{},x=b,T=n.id==="driver-dummy-element"?"over":s,k=B("stagePadding")||0,A=Pn(),v=a.arrow.getBoundingClientRect(),M=n.getBoundingClientRect(),W=M.top-A.height;let S=W>=0;const R=window.innerHeight-(M.bottom+A.height);let O=R>=0;const F=M.left-A.width;let P=F>=0;const q=window.innerWidth-(M.right+A.width);let K=q>=0;const L=!S&&!O&&!P&&!K;let D=T;if(T==="top"&&S?K=P=O=!1:T==="bottom"&&O?K=P=S=!1:T==="left"&&P?K=S=O=!1:T==="right"&&K&&(P=S=O=!1),T==="over"){const ee=window.innerWidth/2-A.realWidth/2,Q=window.innerHeight/2-A.realHeight/2;a.wrapper.style.left=`${ee}px`,a.wrapper.style.right="auto",a.wrapper.style.top=`${Q}px`,a.wrapper.style.bottom="auto"}else if(L){const ee=window.innerWidth/2-(A==null?void 0:A.realWidth)/2,Q=10;a.wrapper.style.left=`${ee}px`,a.wrapper.style.right="auto",a.wrapper.style.bottom=`${Q}px`,a.wrapper.style.top="auto"}else if(P){const ee=Math.min(F,window.innerWidth-(A==null?void 0:A.realWidth)-v.width),Q=vn(x,{elementDimensions:M,popoverDimensions:A,popoverPadding:k,popoverArrowDimensions:v});a.wrapper.style.left=`${ee}px`,a.wrapper.style.top=`${Q}px`,a.wrapper.style.bottom="auto",a.wrapper.style.right="auto",D="left"}else if(K){const ee=Math.min(q,window.innerWidth-(A==null?void 0:A.realWidth)-v.width),Q=vn(x,{elementDimensions:M,popoverDimensions:A,popoverPadding:k,popoverArrowDimensions:v});a.wrapper.style.right=`${ee}px`,a.wrapper.style.top=`${Q}px`,a.wrapper.style.bottom="auto",a.wrapper.style.left="auto",D="right"}else if(S){const ee=Math.min(W,window.innerHeight-A.realHeight-v.width);let Q=wn(x,{elementDimensions:M,popoverDimensions:A,popoverPadding:k,popoverArrowDimensions:v});a.wrapper.style.top=`${ee}px`,a.wrapper.style.left=`${Q}px`,a.wrapper.style.bottom="auto",a.wrapper.style.right="auto",D="top"}else if(O){const ee=Math.min(R,window.innerHeight-(A==null?void 0:A.realHeight)-v.width);let Q=wn(x,{elementDimensions:M,popoverDimensions:A,popoverPadding:k,popoverArrowDimensions:v});a.wrapper.style.left=`${Q}px`,a.wrapper.style.bottom=`${ee}px`,a.wrapper.style.top="auto",a.wrapper.style.right="auto",D="bottom"}L?a.arrow.classList.add("driver-popover-arrow-none"):ta(x,D,n)}function ta(n,d,a){const b=G("popover");if(!b)return;const s=a.getBoundingClientRect(),x=Pn(),T=b.arrow,k=x.width,A=window.innerWidth,v=s.width,M=s.left,W=x.height,S=window.innerHeight,R=s.top,O=s.height;T.className="driver-popover-arrow";let F=d,P=n;if(d==="top"?(M+v<=0?(F="right",P="end"):M+v-k<=0&&(F="top",P="start"),M>=A?(F="left",P="end"):M+k>=A&&(F="top",P="end")):d==="bottom"?(M+v<=0?(F="right",P="start"):M+v-k<=0&&(F="bottom",P="start"),M>=A?(F="left",P="start"):M+k>=A&&(F="bottom",P="end")):d==="left"?(R+O<=0?(F="bottom",P="end"):R+O-W<=0&&(F="left",P="start"),R>=S?(F="top",P="end"):R+W>=S&&(F="left",P="end")):d==="right"&&(R+O<=0?(F="bottom",P="start"):R+O-W<=0&&(F="right",P="start"),R>=S?(F="top",P="start"):R+W>=S&&(F="right",P="end")),!F)T.classList.add("driver-popover-arrow-none");else{T.classList.add(`driver-popover-arrow-side-${F}`),T.classList.add(`driver-popover-arrow-align-${P}`);const q=a.getBoundingClientRect(),K=T.getBoundingClientRect(),L=B("stagePadding")||0,D=q.left-L<window.innerWidth&&q.right+L>0&&q.top-L<window.innerHeight&&q.bottom+L>0;d==="bottom"&&D&&(K.x>q.x&&K.x+K.width<q.x+q.width?b.wrapper.style.transform="translateY(0)":(T.classList.remove(`driver-popover-arrow-align-${P}`),T.classList.add("driver-popover-arrow-none"),b.wrapper.style.transform=`translateY(-${L/2}px)`))}}function oa(){const n=document.createElement("div");n.classList.add("driver-popover");const d=document.createElement("div");d.classList.add("driver-popover-arrow");const a=document.createElement("header");a.id="driver-popover-title",a.classList.add("driver-popover-title"),a.style.display="none",a.innerText="Popover Title";const b=document.createElement("div");b.id="driver-popover-description",b.classList.add("driver-popover-description"),b.style.display="none",b.innerText="Popover description is here";const s=document.createElement("button");s.type="button",s.classList.add("driver-popover-close-btn"),s.setAttribute("aria-label","Close"),s.innerHTML="&times;";const x=document.createElement("footer");x.classList.add("driver-popover-footer");const T=document.createElement("span");T.classList.add("driver-popover-progress-text"),T.innerText="";const k=document.createElement("span");k.classList.add("driver-popover-navigation-btns");const A=document.createElement("button");A.type="button",A.classList.add("driver-popover-prev-btn"),A.innerHTML="&larr; Previous";const v=document.createElement("button");return v.type="button",v.classList.add("driver-popover-next-btn"),v.innerHTML="Next &rarr;",k.appendChild(A),k.appendChild(v),x.appendChild(T),x.appendChild(k),n.appendChild(s),n.appendChild(d),n.appendChild(a),n.appendChild(b),n.appendChild(x),{wrapper:n,arrow:d,title:a,description:b,footer:x,previousButton:A,nextButton:v,closeButton:s,footerButtons:k,progress:T}}function na(){var n;const d=G("popover");d&&((n=d.wrapper.parentElement)==null||n.removeChild(d.wrapper))}function ra(n={}){zt(n);function d(){B("allowClose")&&M()}function a(){const S=B("overlayClickBehavior");if(B("allowClose")&&S==="close"){M();return}S==="nextStep"&&b()}function b(){const S=G("activeIndex"),R=B("steps")||[];if(typeof S>"u")return;const O=S+1;R[O]?v(O):M()}function s(){const S=G("activeIndex"),R=B("steps")||[];if(typeof S>"u")return;const O=S-1;R[O]?v(O):M()}function x(S){(B("steps")||[])[S]?v(S):M()}function T(){var S;if(G("__transitionCallback"))return;const R=G("activeIndex"),O=G("__activeStep"),F=G("__activeElement");if(typeof R>"u"||typeof O>"u"||typeof G("activeIndex")>"u")return;const P=((S=O.popover)==null?void 0:S.onPrevClick)||B("onPrevClick");if(P)return P(F,O,{config:B(),state:G(),driver:Ne()});s()}function k(){var S;if(G("__transitionCallback"))return;const R=G("activeIndex"),O=G("__activeStep"),F=G("__activeElement");if(typeof R>"u"||typeof O>"u")return;const P=((S=O.popover)==null?void 0:S.onNextClick)||B("onNextClick");if(P)return P(F,O,{config:B(),state:G(),driver:Ne()});b()}function A(){G("isInitialized")||(me("isInitialized",!0),document.body.classList.add("driver-active",B("animate")?"driver-fade":"driver-simple"),Xr(),mt("overlayClick",a),mt("escapePress",d),mt("arrowLeftPress",T),mt("arrowRightPress",k))}function v(S=0){var R,O,F,P,q,K,L,D;const ee=B("steps");if(!ee){console.error("No steps to drive through"),M();return}if(!ee[S]){M();return}me("__activeOnDestroyed",document.activeElement),me("activeIndex",S);const Q=ee[S],ge=ee[S+1],Te=ee[S-1],Ue=((R=Q.popover)==null?void 0:R.doneBtnText)||B("doneBtnText")||"Done",g=B("allowClose"),se=typeof((O=Q.popover)==null?void 0:O.showProgress)<"u"?(F=Q.popover)==null?void 0:F.showProgress:B("showProgress"),f=(((P=Q.popover)==null?void 0:P.progressText)||B("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${S+1}`).replace("{{total}}",`${ee.length}`),re=((q=Q.popover)==null?void 0:q.showButtons)||B("showButtons"),ue=["next","previous",...g?["close"]:[]].filter(H=>!(re!=null&&re.length)||re.includes(H)),We=((K=Q.popover)==null?void 0:K.onNextClick)||B("onNextClick"),z=((L=Q.popover)==null?void 0:L.onPrevClick)||B("onPrevClick"),J=((D=Q.popover)==null?void 0:D.onCloseClick)||B("onCloseClick");bn({...Q,popover:{showButtons:ue,nextBtnText:ge?void 0:Ue,disableButtons:[...Te?[]:["previous"]],showProgress:se,progressText:f,onNextClick:We||(()=>{ge?v(S+1):M()}),onPrevClick:z||(()=>{v(S-1)}),onCloseClick:J||(()=>{M()}),...(Q==null?void 0:Q.popover)||{}}})}function M(S=!0){const R=G("__activeElement"),O=G("__activeStep"),F=G("__activeOnDestroyed"),P=B("onDestroyStarted");if(S&&P){const L=!R||(R==null?void 0:R.id)==="driver-dummy-element";P(L?void 0:R,O,{config:B(),state:G(),driver:Ne()});return}const q=(O==null?void 0:O.onDeselected)||B("onDeselected"),K=B("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),Zr(),na(),Yr(),Wr(),$r(),fn(),R&&O){const L=R.id==="driver-dummy-element";q&&q(L?void 0:R,O,{config:B(),state:G(),driver:Ne()}),K&&K(L?void 0:R,O,{config:B(),state:G(),driver:Ne()})}F&&F.focus()}const W={isActive:()=>G("isInitialized")||!1,refresh:nt,drive:(S=0)=>{A(),v(S)},setConfig:zt,setSteps:S=>{fn(),zt({...B(),steps:S})},getConfig:B,getState:G,getActiveIndex:()=>G("activeIndex"),isFirstStep:()=>G("activeIndex")===0,isLastStep:()=>{const S=B("steps")||[],R=G("activeIndex");return R!==void 0&&R===S.length-1},getActiveStep:()=>G("activeStep"),getActiveElement:()=>G("activeElement"),getPreviousElement:()=>G("previousElement"),getPreviousStep:()=>G("previousStep"),moveNext:b,movePrevious:s,moveTo:x,hasNextStep:()=>{const S=B("steps")||[],R=G("activeIndex");return R!==void 0&&!!S[R+1]},hasPreviousStep:()=>{const S=B("steps")||[],R=G("activeIndex");return R!==void 0&&!!S[R-1]},highlight:S=>{A(),bn({...S,popover:S.popover?{showButtons:[],showProgress:!1,progressText:"",...S.popover}:void 0})},destroy:()=>{M(!1)}};return Ur(W),W}const aa=async(n,d,a)=>{var b;try{console.log("📤 [SAVE] Subiendo imagen al backend:",d);const[s,x]=n.split(","),T=((b=s.match(/data:image\/(\w+)/))==null?void 0:b[1])||"png",k=new FormData,A=atob(x),v=new Array(A.length);for(let O=0;O<A.length;O++)v[O]=A.charCodeAt(O);const M=new Uint8Array(v),W=new Blob([M],{type:`image/${T}`});k.append("image",W,`element_${d}.${T}`),k.append("project_id",a),k.append("element_id",d);const S=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:k});if(!S.ok)throw new Error("Error al subir imagen al servidor");const R=await S.json();return console.log("✅ [SAVE] Imagen subida exitosamente:",R.url),R.url}catch(s){throw console.error("❌ [SAVE] Error subiendo imagen:",s),s}},sa=async(n,d)=>{var x,T;console.log("🔄 [SAVE] Procesando imágenes para guardado...");const a=[];let b=0,s=0;for(const k of n)for(const A of k.cells||[])for(const v of A.elements||[])v.type==="image"&&((x=v.content)!=null&&x.startsWith("data:image/"))&&b++;console.log(`📊 [SAVE] Total de imágenes base64 a procesar: ${b}`);for(const k of n){const A={...k};A.cells=[];for(const v of k.cells||[]){const M={...v};M.elements=[];for(const W of v.elements||[]){const S={...W};if(W.type==="image"&&((T=W.content)!=null&&T.startsWith("data:image/")))try{const R=await aa(W.content,W.id,d);S.content=R,S.isUploaded=!0,s++,console.log(`✅ [SAVE] Imagen ${s}/${b} procesada`)}catch(R){console.error("❌ [SAVE] Error procesando imagen:",W.id,R),S.uploadError=R.message}M.elements.push(S)}A.cells.push(M)}a.push(A)}return console.log(`✅ [SAVE] Procesamiento completado: ${s}/${b} imágenes subidas`),a},ia=async(n,d)=>{var a;try{console.log("🔍 [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:n,thumbnailsCount:Object.keys(d).length});const b=[];for(const[T,k]of Object.entries(d))console.log(`🔍 [DEBUG] Procesando thumbnail para página ${T}:`,{hasData:!!k,isBase64:k&&k.startsWith("data:image/"),dataLength:k?k.length:0}),k&&k.startsWith("data:image/")&&b.push({page_id:T,thumbnail_data:k});if(b.length===0){console.log("ℹ️ [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`🖼️ [THUMBNAILS] Guardando ${b.length} thumbnails como archivos...`),console.log(`🔍 [DEBUG] URL del endpoint: /api/thumbnails/${n}/save-as-files`);const s=await fetch(`/api/thumbnails/${n}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content)||""},credentials:"include",body:JSON.stringify({thumbnails:b})});if(console.log("🔍 [DEBUG] Respuesta del servidor:",{status:s.status,statusText:s.statusText,ok:s.ok}),!s.ok){const T=await s.text();throw console.error("❌ [THUMBNAILS] Error respuesta del servidor:",T),new Error(`Error al guardar thumbnails: ${s.status} ${s.statusText}`)}const x=await s.json();return console.log("✅ [THUMBNAILS] Thumbnails guardados como archivos:",x),x}catch(b){throw console.error("❌ [THUMBNAILS] Error guardando thumbnails:",b),b}},yn=async(n,d,a,b,s,x,T=!1)=>{try{if(!(d!=null&&d.id))throw new Error("No se encontró el ID del proyecto");console.log(`💾 [SAVE] Iniciando ${T?"auto-guardado":"guardado manual"}...`);let k=n;T||(k=await sa(n,d.id));const A={pages:k,projectInfo:{id:d.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:b==null?void 0:b.id},workspace:{width:s.width,height:s.height,scale:s.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:T,totalPages:n.length}},v=T?"save-progress":"save",M=await fetch(`/api/canvas/projects/${d.id}/${v}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:A,thumbnails:x})});if(!M.ok){const S=await M.json().catch(()=>({}));throw new Error(S.message||"Error al guardar el proyecto")}const W=await M.json();if(console.log(`✅ [SAVE] ${T?"Auto-guardado":"Guardado"} exitoso:`,W),!T&&x&&Object.keys(x).length>0){console.log("🖼️ [SAVE] Guardando thumbnails como archivos...");try{await ia(d.id,x),console.log("✅ [SAVE] Thumbnails guardados como archivos")}catch(S){console.warn("⚠️ [SAVE] Error guardando thumbnails como archivos:",S)}}return{success:!0,data:W}}catch(k){return console.error(`❌ [SAVE] Error en ${T?"auto-guardado":"guardado"}:`,k),{success:!1,error:k.message}}},la=(n,d,a,b,s,x)=>{const[T,k]=h.useState("saved"),[A,v]=h.useState(null),[M,W]=h.useState(null),[S,R]=h.useState(null),[O,F]=h.useState(!1),[P,q]=h.useState(navigator.onLine),K=h.useRef(null),L=h.useRef(null),D=h.useRef(null),ee=h.useRef(!1),Q=h.useRef(null),ge=15e3,Te=2e3,Ue=5e3,g=h.useCallback((z,J)=>{try{const H={pages:z.map(pe=>{var Y;return{id:pe.id,layout:pe.layout,cells:((Y=pe.cells)==null?void 0:Y.map(xe=>{var Et;return{id:xe.id,elements:((Et=xe.elements)==null?void 0:Et.map(Ce=>{var ke;return{id:Ce.id,type:Ce.type,content:Ce.type==="image"&&((ke=Ce.content)!=null&&ke.startsWith("data:image/"))?`[IMAGE_${Ce.content.length}]`:Ce.content,position:Ce.position,size:Ce.size,style:Ce.style,filters:Ce.filters,rotation:Ce.rotation}}))||[]}}))||[]}})||[],workspace:{width:J==null?void 0:J.width,height:J==null?void 0:J.height}};return btoa(JSON.stringify(H)).substring(0,32)}catch(H){return console.warn("⚠️ [AUTO-SAVE] Error generando hash:",H),Date.now().toString()}},[]),se=h.useCallback(()=>`album_editor_autosave_${(d==null?void 0:d.id)||"draft"}`,[d==null?void 0:d.id]),f=h.useCallback(z=>{try{const J=se(),H={...z,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(J,JSON.stringify(H)),console.log("💾 [AUTO-SAVE] Guardado en localStorage"),!0}catch(J){return console.error("❌ [AUTO-SAVE] Error guardando en localStorage:",J),!1}},[se]),re=h.useCallback(()=>{var z;try{const J=se(),H=localStorage.getItem(J);if(H){const pe=JSON.parse(H);return console.log("📂 [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(z=pe.pages)==null?void 0:z.length,savedAt:new Date(pe.savedAt).toLocaleString()}),pe}}catch(J){console.error("❌ [AUTO-SAVE] Error cargando desde localStorage:",J)}return null},[se]),ue=h.useCallback(async(z=!1)=>{if(ee.current&&!z){console.log("⏳ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(d!=null&&d.id)||!n||n.length===0){console.log("⚠️ [AUTO-SAVE] Datos insuficientes para guardar");return}const J=g(n,s);if(!z&&J===D.current){console.log("📊 [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{ee.current=!0,k("saving"),R(null);const H={pages:n,projectInfo:{id:d.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:b==null?void 0:b.id},workspace:s,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:J}};if(f(H),P){const pe=await yn(n,d,a,b,s,x,!0);if(pe.success)D.current=J,W(new Date),k("saved"),F(!1),console.log("✅ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(pe.error)}else console.log("� [AUTO-SAVE] Sin conexión, solo guardado en localStorage"),k("pending"),F(!0)}catch(H){console.error("❌ [AUTO-SAVE] Error:",H),R(H.message),k("error"),P&&(Q.current=setTimeout(()=>{console.log("🔄 [AUTO-SAVE] Reintentando guardado..."),ue(!0)},Ue))}finally{ee.current=!1}},[n,d,a,b,s,x,g,f,P]),We=h.useCallback(async()=>{try{k("saving");const z=await yn(n,d,a,b,s,x,!1);if(z.success){const J=g(n,s);D.current=J,v(new Date),k("saved"),F(!1),oe.success("💾 Proyecto guardado exitosamente"),console.log("✅ [MANUAL-SAVE] Guardado manual exitoso")}else R(z.error),k("error"),oe.error(`❌ Error al guardar: ${z.error}`);return z.success}catch(z){return console.error("❌ [MANUAL-SAVE] Error:",z),R(z.message),k("error"),oe.error(`❌ Error inesperado: ${z.message}`),!1}},[n,d,a,b,s,x,g]);return h.useEffect(()=>{if(!(d!=null&&d.id)||!n||n.length===0)return;const z=g(n,s);return D.current&&z!==D.current?(console.log("🔄 [AUTO-SAVE] Cambios detectados, programando guardado..."),F(!0),k("pending"),L.current&&clearTimeout(L.current),L.current=setTimeout(()=>{ue()},Te)):D.current||(D.current=z),()=>{L.current&&clearTimeout(L.current)}},[n,s,d==null?void 0:d.id,g,ue]),h.useEffect(()=>{if(d!=null&&d.id)return K.current&&clearInterval(K.current),K.current=setInterval(()=>{O&&(console.log("⏰ [AUTO-SAVE] Auto-save periódico activado"),ue())},ge),()=>{K.current&&clearInterval(K.current)}},[d==null?void 0:d.id,O,ue]),h.useEffect(()=>{const z=()=>{console.log("🌐 [AUTO-SAVE] Conexión restaurada"),q(!0),O&&setTimeout(()=>ue(!0),1e3)},J=()=>{console.log("📴 [AUTO-SAVE] Conexión perdida"),q(!1)};return window.addEventListener("online",z),window.addEventListener("offline",J),()=>{window.removeEventListener("online",z),window.removeEventListener("offline",J)}},[O,ue]),h.useEffect(()=>{const z=J=>{if(O){const H={pages:n,projectInfo:{id:d.id},workspace:s,meta:{savedAt:new Date().toISOString()}};return f(H),J.preventDefault(),J.returnValue="¿Estás seguro de salir? Hay cambios sin guardar.","¿Estás seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",z),()=>window.removeEventListener("beforeunload",z)},[O,n,d==null?void 0:d.id,s,f]),h.useEffect(()=>()=>{L.current&&clearTimeout(L.current),K.current&&clearInterval(K.current),Q.current&&clearTimeout(Q.current)},[]),h.useEffect(()=>{S&&(S.includes("max_allowed_packet")||S.includes("data_too_large")?oe.error("❌ El proyecto es demasiado grande para guardar automáticamente. Reduce el número o tamaño de imágenes."):oe.error(`❌ Error de auto-guardado: ${S}`))},[S]),{saveStatus:T,lastSaved:A,lastAutoSaved:M,saveError:S,hasUnsavedChanges:O,isOnline:P,saveManually:We,performAutoSave:()=>ue(!0),loadFromLocalStorage:re,getStorageKey:se,autoSaveInterval:ge,debounceDelay:Te}},ca=({saveStatus:n,lastSaved:d,lastAutoSaved:a,hasUnsavedChanges:b,isOnline:s,saveError:x,onManualSave:T,className:k=""})=>{const A=W=>{if(!W)return null;const R=new Date-W,O=Math.floor(R/(1e3*60)),F=Math.floor(R/1e3);if(F<30)return"hace unos segundos";if(O<1)return`hace ${F}s`;if(O<60)return`hace ${O}m`;const P=Math.floor(O/60);return P<24?`hace ${P}h`:W.toLocaleDateString()},M=(()=>{if(!s)return{icon:e.jsx(hn,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexión",detail:"Guardado local activo"};switch(n){case"saving":return{icon:e.jsx(vr,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(xr,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:a?`Auto-guardado ${A(a)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(br,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:x||"Error desconocido"};case"pending":return{icon:e.jsx(fr,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:b?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(Tn,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${k}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${M.bg} ${M.color}
                    hover:shadow-md
                `,onClick:()=>n!=="saving"&&(T==null?void 0:T()),children:[M.icon,e.jsx("span",{className:"text-sm font-medium",children:M.text}),e.jsx("div",{className:"flex items-center",children:s?e.jsx(Rr,{className:"w-3 h-3 text-green-500"}):e.jsx(hn,{className:"w-3 h-3 text-orange-500"})})]}),n==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},je=typeof window>"u",Be=!je&&!0,ht=()=>{},Ft=console.error,we=Be?()=>{}:console.log,da=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const n=document.createElement("style");n.textContent=da,document.head.appendChild(n)}function ft(n,d){let a;return function(...s){const x=()=>{clearTimeout(a),n(...s)};clearTimeout(a),a=setTimeout(x,d)}}const ua=(n,d,a)=>{var R;if(!n||!n.template)return a;const b=n.template;let s=1,x=1;const T=b.match(/grid-cols-(\d+)/),k=b.match(/grid-rows-(\d+)/);T&&(s=parseInt(T[1])),k&&(x=parseInt(k[1]));const A=(R=n.style)!=null&&R.gap?parseInt(n.style.gap):24,v=a.width-A*(s-1),M=a.height-A*(x-1),W=Math.floor(v/s),S=Math.floor(M/x);return we(`🔧 [CELL-DIMENSIONS] Layout: ${n.id}, Celda: ${d}, Grid: ${s}x${x}, Dims: ${W}x${S}`),{width:W,height:S}},Gt=Ht.memo(({pageId:n,thumbnail:d,altText:a,type:b})=>{const[s,x]=h.useState(!1),[T,k]=h.useState(!1);if(d&&!T)return e.jsxs("div",{className:"relative w-full h-full",children:[!s&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:d,alt:a,className:`w-full h-full object-contain transition-opacity duration-200 ${s?"opacity-100":"opacity-0"}`,onLoad:()=>x(!0),onError:()=>k(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const A=b==="cover"||b==="final"?bt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((v,M)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},M))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(A,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(n,d)=>n.pageId===d.pageId&&n.thumbnail===d.thumbnail&&n.altText===d.altText&&n.type===d.type),ga=Ht.memo(({images:n,onImageSelect:d,isLoading:a})=>{const b=Ht.memo(({image:s})=>{const[x,T]=h.useState(!1),[k,A]=h.useState(!1),[v,M]=h.useState(!1),[{isDragging:W},S]=Nr(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:s.url},collect:q=>({isDragging:!!q.isDragging()}),end:()=>{setTimeout(()=>M(!1),100)}})),R=s.thumbnail_url||s.url,O=s.url,F=q=>{M(!0),setTimeout(()=>M(!1),500)},P=q=>{if(v||W)return q.preventDefault(),q.stopPropagation(),!1;d(O)};return e.jsxs("div",{ref:S,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${W?"opacity-50 scale-95":""}`,onMouseDown:F,onClick:P,children:[e.jsxs("div",{className:"aspect-square relative",children:[!x&&!k&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),k?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Ve,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:R,alt:s.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${x?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>T(!0),onError:()=>A(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(xt,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:s.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),s.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return a?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((s,x)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},x))}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ve,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay imágenes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:n.map((s,x)=>e.jsx(b,{image:s},`${s.id||s.url}-${x}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[n.filter(s=>s.has_thumbnail).length," de ",n.length," imágenes optimizadas"]})})]})});function fs(){var vo,wo,yo,Eo,Co,No,To,Ao,So,jo,ko,Oo,Io,_o,Ro,Po,Lo,Mo,Uo,$o,Bo,zo,Fo,Go,Ho,Vo,Do,Wo,qo,Ko,Qo,Yo,Jo,Xo,Zo,en,tn,on,nn,rn,an;const[n,d]=h.useState(null),[a,b]=h.useState(null),[s,x]=h.useState(null),[T,k]=h.useState(null),[A,v]=h.useState(!0),[M,W]=h.useState(null),[S,R]=h.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[O,F]=h.useState(new Map),[P,q]=h.useState([]),[K,L]=h.useState(!1),D=h.useRef(P),ee=h.useRef(O);h.useRef(null);const Q=h.useRef(null),ge=h.useRef(null);h.useEffect(()=>{D.current=P},[P]),h.useEffect(()=>{ee.current=O},[O]),h.useEffect(()=>{(async()=>{var o,r;try{const c=new URLSearchParams(window.location.search).get("project");if(!c){W("No se encontró el ID del proyecto en la URL"),v(!1);return}const u=await fetch(`/api/canvas/projects/${c}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!u.ok)throw new Error("Error al cargar el proyecto");const m=await u.json();ht("📊 ===== DATOS DEL PROYECTO CARGADOS ====="),ht("🔍 PROJECT ID desde URL:",c),we("🔍 PROJECT DATA completo:",m),ht("🔍 PROJECT DATA ID:",(r=m==null?void 0:m.project)==null?void 0:r.id),ht("========================================"),d(m.project),b(m.item),x(m.canvasPreset),k(m.initialProject),v(!1)}catch(l){console.error("❌ Error cargando proyecto:",l),W(l.message),v(!1)}})()},[]);const[Te,Ue]=h.useState(mn.Local.get(`${pn.APP_CORRELATIVE}_cart`)??[]);h.useEffect(()=>{mn.Local.set(`${pn.APP_CORRELATIVE}_cart`,Te)},[Te]);const[g,se]=h.useState([]),[f,re]=h.useState(0),[ue,We]=h.useState("preset"),[z,J]=h.useState(null),[H,pe]=h.useState(null),[Y,xe]=h.useState("pages"),[Et,Ce]=h.useState("basic"),[ke,Ke]=h.useState([JSON.stringify(g)]),[Ae,ze]=h.useState(0),[Dt,ma]=h.useState(!1),[pa,Wt]=h.useState(null),[te,ne]=h.useState({}),[ha,fa]=h.useState(!1),[Oe,Fe]=h.useState([]),[Ct,qt]=h.useState(!1),[rt,Mn]=h.useState(new Map),[Qe,Un]=h.useState(()=>new Map),[Ye,Kt]=h.useState(null),[Qt,Yt]=h.useState(!1);h.useEffect(()=>{we("✅ [FILTERS] Tab actual:",Y)},[Y]),h.useCallback((t,o="manual")=>{if(we(`🔄 [ACTIVE_TAB] Cambiando de "${Y}" a "${t}" - Razón: ${o}`),t==="filters"&&o!=="manual"){console.warn("🚨 [ACTIVE_TAB] Cambio automático a filters bloqueado!");return}xe(t)},[Y]),je||(window.FORCE_THUMBNAIL_REGENERATION=!0,window.PREVENT_THUMBNAIL_RESET=!1,window._protectedThumbnailIds=[],window.THUMBNAIL_PROTECTED=!1,window.PRESERVE_FILTERS=!0),h.useEffect(()=>{je||(window.forceRegenerateAllThumbnails=()=>{we("💣 [EMERGENCIA-GLOBAL] Forzando regeneración de TODOS los thumbnails"),window.thumbnailCache={},F(t=>{const o=new Map(t);return g.forEach((r,l)=>{o.set(l,Date.now())}),o}),we("1️⃣ Regenerando página actual"),ae(!0).then(()=>{we("✅ Primera regeneración completa"),window.BLOCK_AUTO_REGENERATION=!0,setTimeout(()=>{we("2️⃣ Ejecutando segunda regeneración forzada"),window.forceRegenerateThumbnail&&window.forceRegenerateThumbnail(),window.THUMBNAIL_PROTECTED=!0,setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,we("🔓 Regeneración automática desbloqueada")},5e3)},200)}).catch(t=>{console.error("❌ Error en regeneración de emergencia:",t)})})},[g]),h.useEffect(()=>{window._protectedThumbnails||(window._protectedThumbnails=new Set),window.protectThumbnail=t=>{window._protectedThumbnails.add(t),we(`🛡️ [PROTECT] Thumbnail ${t} marcado como protegido`)},window.unprotectThumbnail=t=>{window._protectedThumbnails.delete(t),we(`🔓 [UNPROTECT] Thumbnail ${t} desprotegido`)},window.isThumbnailProtected=t=>{var o;return((o=window._protectedThumbnails)==null?void 0:o.has(t))||!1},window.blockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!0,we("🚫 [BLOCK AUTO] Regeneraciones automáticas BLOQUEADAS")},window.unblockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!1,we("✅ [UNBLOCK AUTO] Regeneraciones automáticas DESBLOQUEADAS")},window.isAutoRegenerationBlocked=()=>window._blockAutoRegeneration||!1,window._thumbnailWatchdog||(window._thumbnailWatchdog=setInterval(()=>{window._protectedThumbnailData&&window._protectedThumbnails&&Array.from(window._protectedThumbnails).forEach(o=>{const r=window._protectedThumbnailData[o];r&&ne(l=>l[o]&&l[o]!==r?(console.error(`🚨 [WATCHDOG] ¡SOBRESCRITURA DETECTADA! Restaurando ${o}`),{...l,[o]:r}):l)})},100),console.log("🚨 [WATCHDOG] Vigilante de thumbnails activado")),window._interceptorInstalled||(window._interceptorInstalled=!0,console.log("🔒 [GLOBAL INTERCEPTOR] Interceptor global de setPageThumbnails instalado"))},[]);const[at,Je]=h.useState(!1),Jt=h.useRef(),[$,Xt]=h.useState({width:800,height:600}),$n=h.useCallback((t,o,r="unknown")=>{var l;return(l=window.isThumbnailProtected)!=null&&l.call(window,t)?(console.error(`� [PROTECTION BLOCK] ¡BLOQUEADO! Intento de sobrescribir thumbnail protegido ${t} desde: ${r}`),console.error("🚨 [PROTECTION BLOCK] Stack trace:",new Error().stack),!1):(ne(c=>{const u=c[t];return console.log(u&&u!==o?`🔄 [THUMBNAIL UPDATE] Actualizando thumbnail ${t} desde: ${r}`:`✅ [THUMBNAIL SET] Estableciendo thumbnail ${t} desde: ${r}`),{...c,[t]:o}}),!0)},[]),Zt=h.useMemo(()=>ra({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¡Bienvenido al Editor de BananaLab! 🍌",description:"Este es tu lienzo de trabajo donde crearás diseños increíbles. Aquí puedes ver y editar la página actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"🎯 Navegación Principal",description:"En la barra lateral izquierda encontrarás todas las herramientas organizadas por categorías. Cada ícono te lleva a una sección específica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"📄 Sección Páginas",description:"Gestiona todas las páginas de tu proyecto: portada, páginas de contenido y contraportada. Haz clic en cualquier página para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"🎨 Sección Diseños",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu página. Cada diseño tiene una distribución única.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"📚 Sección Capas",description:"Organiza y controla la superposición de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posición.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"✍️ Sección Textos",description:"Agrega y personaliza textos: títulos, subtítulos y párrafos. Cambia fuentes, colores, tamaños y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"🎭 Sección Filtros",description:"Aplica efectos visuales a tus imágenes: brillo, contraste, saturación, máscaras y más filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"⚡ Acciones Rápidas",description:"Herramientas de acceso rápido: cambiar diseño de página, gestionar capas, agregar imágenes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"💾 Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso automáticamente y acceder a la vista previa de tu álbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"👁️ Vista de Álbum",description:"Visualiza tu proyecto completo como un álbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"🎉 ¡Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una página y agregando elementos. ¡Diviértete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente →",prevBtnText:"← Anterior",doneBtnText:"¡Empezar a crear! 🚀",closeBtnText:"✕",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(t,o)=>{var l,c;console.log("🎯 Mostrando paso:",(l=o.popover)==null?void 0:l.title);const r=(c=t==null?void 0:t.getAttribute)==null?void 0:c.call(t,"data-tab");r&&Y!==r&&xe(r)},onDeselected:()=>{console.log("✅ Guía completada"),oe.success("¡Guía completada! Ya puedes empezar a crear tu diseño.",{duration:3e3})}}),[Y,xe]),Bn=h.useCallback(()=>{console.log("🚀 Iniciando tour guiado"),Zt.drive()},[Zt]),Nt=h.useCallback(async()=>{if(n!=null&&n.id)try{const t=await fetch(`/api/thumbnails/${n.id}`);if(t.ok){const o=await t.json();if(o.success&&o.thumbnails&&o.thumbnails.length>0){const r={};o.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(r[l.page_id]=l.thumbnail_url)}),Object.keys(r).length>0?(ne(l=>{var u;console.warn("🚨 [STORAGE LOAD] ¡ALERTA! Cargando thumbnails desde storage - POSIBLE CULPABLE DE SOBRESCRITURA"),console.warn("🚨 [STORAGE LOAD] Thumbnails protegidos:",Array.from(window._protectedThumbnails||[])),console.warn("🚨 [STORAGE LOAD] Stack trace:",new Error().stack);const c={};for(const[m,i]of Object.entries(r))(u=window.isThumbnailProtected)!=null&&u.call(window,m)?console.warn(`🛡️ [STORAGE PROTECTION] NO sobrescribiendo thumbnail protegido: ${m}`):c[m]=i;return{...l,...c}}),console.log("✅ Thumbnails cargados desde storage:",Object.keys(r).length)):console.log("ℹ️ No hay thumbnails guardados, usando generación local")}else console.log("ℹ️ No hay thumbnails guardados para este proyecto")}}catch(t){console.warn("⚠️ Error cargando thumbnails guardados (usando locales):",t)}},[n==null?void 0:n.id]),st=h.useRef(new Map),Ie=h.useRef(new Map),Tt=h.useRef(null);h.useEffect(()=>(Be&&(Tt.current=setInterval(()=>{const t=Date.now(),o=5*60*1e3;for(const[r,l]of Ie.current.entries())t-l.timestamp>o&&Ie.current.delete(r);if(window.gc&&window.gc(),window.thumbnailCache&&typeof window.thumbnailCache=="object"){const r=Object.keys(window.thumbnailCache);if(r.length>50){const l=r.sort().slice(-30),c={};l.forEach(u=>{c[u]=window.thumbnailCache[u]}),window.thumbnailCache=c}}Ft("🧹 [VPS CLEANUP] Limpieza de memoria ejecutada")},12e4)),()=>{Tt.current&&clearInterval(Tt.current)}),[Be]);const eo=h.useMemo(()=>JSON.stringify($),[$]),ae=h.useCallback(async(t=!1)=>{var m,i,p,w;if(window.BLOCK_AUTO_REGENERATION&&!t){console.log("🛡️ [PROTECCIÓN TEMPORAL] Bloqueando regeneración mientras se completa otra operación");return}const o=g[f];if(!o||!$)return;const r=o.id;if(!t){st.current.has(r)&&clearTimeout(st.current.get(r));const C=setTimeout(()=>{st.current.delete(r),ae(!0)},300);st.current.set(r,C);return}const l=`${r}-${eo}`,c=Be?18e4:6e4;if(!t&&Ie.current.has(l)){const C=Ie.current.get(l);if(C&&Date.now()-C.timestamp<c){ne(E=>({...E,[r]:C.data}));return}else C&&Ie.current.delete(l)}let u=!1;if(o.cells&&o.cells.forEach(C=>{C.elements&&C.elements.forEach(E=>{E.filters&&(E.filters.brightness!==void 0&&E.filters.brightness!==100&&E.filters.brightness!==1||E.filters.contrast!==void 0&&E.filters.contrast!==100&&E.filters.contrast!==1||E.filters.saturation!==void 0&&E.filters.saturation!==100&&E.filters.saturation!==1||E.filters.tint!==void 0&&E.filters.tint!==0||E.filters.hue!==void 0&&E.filters.hue!==0||E.filters.blur!==void 0&&E.filters.blur>0||E.filters.opacity!==void 0&&E.filters.opacity!==100&&E.filters.opacity!==1||E.filters.scale!==void 0&&E.filters.scale!==1||E.filters.rotate!==void 0&&E.filters.rotate!==0||E.filters.flipHorizontal||E.filters.flipVertical)&&(u=!0,E._hasRealFilters=!0)})}),!t&&!u&&te[r]){const C=((m=window._thumbnailGenTimes)==null?void 0:m[r])||0;if(Date.now()-C<3e5){console.log(`✅ Thumbnail reciente existe para página sin filtros: ${r}`);return}}if(_e.current){console.log("⏳ Ya se está generando un thumbnail...");return}_e.current=!0;try{console.log(`🚀 [RADICAL GENERATOR] Generando thumbnail para página: ${r} (filtros: ${u})`),window._currentPageData=o,window._workspaceDimensions=$,window._updateThumbnailInUI=(E,_)=>{var N;if((N=window.isThumbnailProtected)!=null&&N.call(window,E)){console.error(`🚨 [UPDATE BLOCKED] ¡BLOQUEADO! Intento de actualizar thumbnail protegido ${E} via _updateThumbnailInUI`),console.error("🚨 [UPDATE BLOCKED] Stack trace:",new Error().stack);return}ne(I=>(console.log(`🔄 [UPDATE UI] Actualizando thumbnail ${E} via _updateThumbnailInUI`),{...I,[E]:_}))},window._thumbnailGenTimes||(window._thumbnailGenTimes={}),window._thumbnailGenTimes[r]=Date.now();let C=null;if(u||t){const E=Be?{id:o.id,cells:((i=o.cells)==null?void 0:i.map(_=>{var N;return{id:_.id,elements:((N=_.elements)==null?void 0:N.filter(I=>I.filters&&Object.keys(I.filters).length>0).map(I=>{var y;return{id:I.id,type:I.type,content:((y=I.content)==null?void 0:y.length)>100?I.content.substring(0,100)+"...":I.content,position:I.position,size:I.size,filters:I.filters}}))||[]}}))||[]}:o;try{C=await Ut(Be?E:o,$),Be&&E&&Object.keys(E).forEach(_=>{delete E[_]})}catch(_){_("❌ [MÉTODO RADICAL] Error, usando fallback:",_),C=await un({page:o,workspaceDimensions:$,preserveFilters:!0})}}else console.log("📸 [MÉTODO NORMAL] Generando thumbnail sin filtros especiales"),C=await un({page:o,workspaceDimensions:$,preserveFilters:!1});if(C){if(u){(p=window.protectThumbnail)==null||p.call(window,r),(w=window.blockAutomaticRegeneration)==null||w.call(window),console.log(`🛡️ [FILTER PROTECTION] Thumbnail ${r} protegido porque tiene filtros aplicados`),console.log("🚫 [AUTO BLOCK] Regeneraciones automáticas BLOQUEADAS para preservar filtros"),ne(N=>(console.log(`🔥 [FORCE SET] Estableciendo thumbnail con filtros para ${r} (PROTEGIDO)`),{...N,[r]:C})),setTimeout(()=>{ne(N=>N[r]!==C?(console.warn(`🚨 [PROTECTION RESTORE] Restaurando thumbnail protegido para ${r}`),{...N,[r]:C}):N)},100);const _=()=>{ne(N=>N[r]!==C?(console.error(`🚨 [EMERGENCY RESTORE] ¡PARPADEO DETECTADO! Restaurando thumbnail para ${r}`),{...N,[r]:C}):N)};setTimeout(_,200),setTimeout(_,500),setTimeout(_,1e3),setTimeout(_,2e3),window._protectedThumbnailData||(window._protectedThumbnailData={}),window._protectedThumbnailData[r]=C}else $n(r,C,"generateCurrentPageThumbnail");console.log(`✅ [SUCCESS] Thumbnail generado exitosamente para página: ${r}`),u&&!t&&(console.log("🔍 [VERIFICACIÓN] Comprobando si los filtros se aplicaron correctamente..."),window._filterVerificationDone||(window._filterVerificationDone=new Set),window._filterVerificationDone.has(r)||(window._filterVerificationDone.add(r),setTimeout(async()=>{var _,N,I;try{console.log("🚀 [ÚLTIMO RECURSO] Intentando método radical para garantizar filtros..."),console.log("📦 [ÚLTIMO RECURSO - DATOS] currentPageData:",{pageId:o.id,elementsWithFilters:((N=(_=o.elements)==null?void 0:_.filter(U=>U.filters&&Object.keys(U.filters).some(j=>j==="flipHorizontal"||j==="flipVertical"?U.filters[j]:j==="brightness"||j==="contrast"||j==="saturation"||j==="opacity"||j==="scale"?U.filters[j]!==1:j==="tint"||j==="hue"||j==="blur"||j==="rotate"?U.filters[j]!==0:!1)))==null?void 0:N.map(U=>({id:U.id,filters:U.filters})))||[]});const y=await Ut(o,$);y&&((I=window.protectThumbnail)==null||I.call(window,r),ne(U=>(console.log(`🚀 [RADICAL FORCE] Estableciendo thumbnail radical protegido para ${r}`),{...U,[r]:y})),console.log("✅ [RADICAL SUCCESS] Filtros garantizados aplicados exitosamente"))}catch(y){console.warn("⚠️ [RADICAL FALLBACK] Error en método radical:",y)}},1e3))),u&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(r)||window._protectedThumbnailIds.push(r));const E=`${r}-${eo}`;if(Ie.current.set(E,{data:C,timestamp:Date.now(),hasFilters:u}),Ie.current.size>50){const _=Ie.current.keys().next().value;Ie.current.delete(_)}}else console.error(`❌ [ERROR] No se pudo generar thumbnail para página: ${r}`)}catch(C){console.error(`❌ [CRITICAL ERROR] Error generando thumbnail para página ${r}:`,C)}finally{_e.current=!1}},[g,f,$,te]),At=h.useCallback(ft(async()=>{var t;if(window.BLOCK_AUTO_REGENERATION){console.log("🛡️ [PROTECCIÓN-GLOBAL] Bloqueando generación masiva mientras los filtros están protegidos");return}if(window.THUMBNAIL_PROTECTED){console.log("🔒 [PROTECCIÓN-GLOBAL] Generación masiva bloqueada, thumbnails protegidos");return}if(!(!(g!=null&&g.length)||!$)){if(_e.current){console.log("⏳ Thumbnails ya se están generando, saltando...");return}_e.current=!0;try{const o=g.filter(l=>!te[l.id]);if(o.length===0){console.log("✅ Todos los thumbnails ya existen");return}if(console.log(`📸 Generando ${o.length} thumbnails rápidos...`),(t=window.isAutoRegenerationBlocked)!=null&&t.call(window)){console.warn("🚫 [BLOCKED] Regeneración automática bloqueada, saltando generateFastThumbnails");return}const r=await gn({pages:o,workspaceDimensions:$,onProgress:l=>{Kt(l)}});r&&Object.keys(r).length>0&&(ne(l=>{var u;console.warn("🚨 [FAST THUMBNAILS] ¡ALERTA! generateFastThumbnails sobrescribiendo thumbnails - POSIBLE CULPABLE"),console.warn("🚨 [FAST THUMBNAILS] Stack trace:",new Error().stack);const c={};for(const[m,i]of Object.entries(r))(u=window.isThumbnailProtected)!=null&&u.call(window,m)?console.warn(`🛡️ [FAST PROTECTION] NO sobrescribiendo thumbnail protegido: ${m}`):c[m]=i;return{...l,...c}}),console.log("✅ Thumbnails rápidos generados:",Object.keys(r).length))}catch(o){console.warn("⚠️ Error generando thumbnails rápidos:",o)}finally{_e.current=!1,Kt(null)}}},300),[g,$,te]),_e=h.useRef(!1);h.useCallback(async(t=[])=>{var o;if(!_e.current)try{if(_e.current=!0,t.length>0){const r=g.filter(l=>t.includes(l.id));if(r.length>0)if(console.log(`🎯 Generando ${r.length} thumbnails prioritarios...`),(o=window.isAutoRegenerationBlocked)!=null&&o.call(window))console.warn("🚫 [BLOCKED] Regeneración de prioridad bloqueada, saltando generateFastThumbnails");else{const l=await gn({pages:r,workspaceDimensions:$});l&&Object.keys(l).length>0&&ne(c=>{var m;console.warn("🚨 [PRIORITY THUMBNAILS] ¡ALERTA! generateFastThumbnails de prioridad sobrescribiendo - POSIBLE CULPABLE"),console.warn("🚨 [PRIORITY THUMBNAILS] Stack trace:",new Error().stack);const u={};for(const[i,p]of Object.entries(l))(m=window.isThumbnailProtected)!=null&&m.call(window,i)?console.warn(`🛡️ [PRIORITY PROTECTION] NO sobrescribiendo thumbnail protegido: ${i}`):u[i]=p;return{...c,...u}})}}}catch(r){console.warn("⚠️ Error en generación prioritaria:",r)}finally{_e.current=!1}},[g,$,At]);const to=h.useCallback(t=>{if(Qe.has&&Qe.has(t))return;const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{if(o.width>1200||o.height>1200){const l=document.createElement("canvas"),c=l.getContext("2d"),u=1200,m=Math.min(u/o.width,u/o.height),i=o.width*m,p=o.height*m;l.width=i,l.height=p,c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(o,0,0,i,p),l.toBlob(w=>{if(w){const C=URL.createObjectURL(w);Un(E=>{const _=new Map(E);if(_.set(t,C),_.size>15){const N=_.keys().next().value,I=_.get(N);URL.revokeObjectURL(I),_.delete(N)}return _})}},"image/webp",.85)}},o.onerror=()=>{console.warn("❌ Error pre-cargando imagen:",t)},o.src=t},[]);h.useEffect(()=>{Oe.length>0&&Oe.slice(0,10).forEach((o,r)=>{setTimeout(()=>{to(o.url)},r*100)})},[Oe,to]),h.useEffect(()=>()=>{Qe&&Qe.forEach&&Qe.forEach(t=>URL.revokeObjectURL(t))},[]),h.useEffect(()=>()=>{$t()},[]);const oo=h.useCallback(async()=>{var t;if(!(!(n!=null&&n.id)||!(g!=null&&g.length))){if(Qt){console.log("⏳ Ya hay una carga de thumbnails en progreso, omitiendo...");return}try{Yt(!0),console.log("🔄 Iniciando carga de thumbnails existentes...");const o=await fetch(`/api/thumbnails/${n.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:g})});if(o.ok){const r=await o.json();r&&Object.keys(r).length>0?(ne(l=>({...l,...r})),console.log("✅ Thumbnails existentes cargados:",Object.keys(r).length)):(console.log("📸 No hay thumbnails existentes, generando para página actual..."),setTimeout(()=>ae(),200))}}catch(o){console.warn("⚠️ Error cargando thumbnails existentes:",o),setTimeout(()=>ae(),200)}finally{Yt(!1)}}},[n==null?void 0:n.id,g,ae,Qt]);h.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(g!=null&&g.length)))try{const t=g[f];if(!t)return;const o=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(o.ok){const r=await o.json();if(r.success&&r.thumbnails){const l={};r.thumbnails.forEach(c=>{c.page_id&&c.thumbnail_url&&(l[c.page_id]=c.thumbnail_url)}),ne(c=>({...c,...l})),console.log("✅ Thumbnail generado y guardado en storage para página actual:",r.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando thumbnail:",t)}},[n==null?void 0:n.id,g,f,$]),h.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(g!=null&&g.length)))try{const t=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:g,width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(t.ok){const o=await t.json();if(o.success&&o.thumbnails){const r={};o.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(r[l.page_id]=l.thumbnail_url)}),ne(l=>({...l,...r})),console.log("✅ Todos los thumbnails generados y guardados en storage:",o.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando todos los thumbnails:",t)}},[n==null?void 0:n.id,g,$]);const zn=h.useCallback(async(t=null)=>{if(!(n!=null&&n.id)||!(g!=null&&g.length))return{};try{console.log("📖 [ALBUM-MODAL] Cargando thumbnails PDF existentes...");const o={},r={};let l=0;const c=async(m,i)=>new Promise(p=>{const w=new Image;w.onload=()=>{r[i]=m,l++,t==null||t(l,g.length),p(!0)},w.onerror=()=>{console.warn(`⚠️ [ALBUM-MODAL] Thumbnail no encontrado: ${m}`),l++,t==null||t(l,g.length),p(!1)},w.src=m}),u=g.map(async(m,i)=>{let p;const w=a&&(a.has_cover_image===!0||a.has_cover_image===1),C=a&&(a.has_back_cover_image===!0||a.has_back_cover_image===1),E=w&&g.some(y=>y.type==="cover"),_=C&&g.some(y=>y.type==="final");if(m.type==="cover")p=0;else if(m.type==="content")E?p=g.filter(j=>j.type==="content").findIndex(j=>j.id===m.id)+1:p=g.filter(j=>j.type==="content").findIndex(j=>j.id===m.id)+1;else if(m.type==="final"){const y=g.filter(j=>j.type==="content");p=y.length+1}else p=i;const N=`/storage/images/thumbnails/${n.id}/page-${p}-pdf.png`,I=m.id||`page-${i}`;return o[I]=N,console.log(`🔍 [THUMBNAIL-MAP] Página ${i}:`,{tipo:m.type,pageNumber:m.pageNumber,realPageNumber:p,url:N,pageId:m.id,hasCover:E,hasBackCover:_,coverEnabled:w,backCoverEnabled:C}),c(N,I)});return await Promise.all(u),console.log(`✅ [ALBUM-MODAL] Thumbnails verificados: ${Object.keys(r).length}/${g.length}`),o}catch(o){return console.warn("⚠️ [ALBUM-MODAL] Error cargando thumbnails PDF:",o),{}}},[n==null?void 0:n.id,g,a]);h.useEffect(()=>{if(T&&a&&s){if(T.pages&&Array.isArray(T.pages)){const t=T.pages.map(o=>{let r=null,l=s.background_color||"#ffffff";return o.type==="cover"&&(a.has_cover_image===!0||a.has_cover_image===1)?a.cover_image&&(r=`/storage/images/item/${a.cover_image}`):o.type==="content"?a.content_image&&(r=`/storage/images/item/${a.content_image}`):(o.type==="final"||o.type==="contraportada")&&(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&a.back_cover_image&&(r=`/storage/images/item/${a.back_cover_image}`),{...o,backgroundImage:r,backgroundColor:l}}).filter(o=>!(o.type==="cover"&&(a.has_cover_image===!1||a.has_cover_image===0)||(o.type==="final"||o.type==="contraportada")&&(a.has_back_cover_image===!1||a.has_back_cover_image===0)));se(o=>o.length>0?(console.log("⚠️ Páginas ya existentes, preservando cambios del usuario"),o.map((r,l)=>{const c=t[l];return c?{...r,backgroundImage:r.backgroundImage||c.backgroundImage,backgroundColor:r.backgroundColor||c.backgroundColor}:r})):(console.log("📄 Carga inicial de páginas desde la base de datos"),t)),Ke(o=>o.length<=1?[JSON.stringify(t)]:o),ze(o=>o===0&&ke.length<=1?0:o),setTimeout(()=>{Nt()},100)}else{const t=mo(s,a);se(t),Ke([JSON.stringify(t)]),ze(0),setTimeout(()=>{Nt()},100)}typeof T.currentPage=="number"&&re(T.currentPage),T.workspaceSize&&We(T.workspaceSize)}},[T,a,s,Nt]);const Re=la(g,n,a,s,$,te),no=()=>{if(s!=null&&s.width&&(s!=null&&s.height)){let i=s.width,p=s.height,w=i*37.8,C=p*37.8;if(w&&C){const E=window.innerWidth*.6,_=window.innerHeight*.7,N=E/w,I=_/C,y=Math.min(N,I,1);return{width:Math.round(w*y),height:Math.round(C*y),originalWidth:i,originalHeight:p,scale:y,unit:"cm",originalWidthPx:Math.round(w),originalHeightPx:Math.round(C)}}}if(s!=null&&s.extra_settings)try{const i=typeof s.extra_settings=="string"?JSON.parse(s.extra_settings):s.extra_settings;if(i!=null&&i.canvas_config){const p=i.canvas_config;let w=p.width,C=p.height,E=w*37.8,_=C*37.8;if(E&&_){const N=window.innerWidth*.6,I=window.innerHeight*.7,y=N/E,U=I/_,j=Math.min(y,U,1);return{width:Math.round(E*j),height:Math.round(_*j),originalWidth:w,originalHeight:C,scale:j,unit:"cm",originalWidthPx:Math.round(E),originalHeightPx:Math.round(_)}}}}catch(i){console.warn("Error parsing extra_settings:",i)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},o=t[ue]||t.preset,r=je?1200:window.innerWidth*.6,l=je?800:window.innerHeight*.7,c=r/o.width,u=l/o.height,m=Math.min(c,u,1);return{width:Math.round(o.width*m),height:Math.round(o.height*m),originalWidth:o.width,originalHeight:o.height,scale:m,unit:"px"}},Pe=h.useCallback(async(t={type:"thumbnail"})=>{var o;if(je)return Ft("🚫 [VPS-PROTECTION] captureCurrentWorkspace bloqueado en servidor"),null;if(!g[f])return null;try{let r=document.querySelector(`#page-${g[f].id}`);if(!r)return console.warn("❌ THUMBNAIL: No se encontró el elemento de página específico"),null;const l=g[f],u=(l==null?void 0:l.cells)&&l.cells.length>0&&r.classList.contains("grid");we(`🔧 [CAPTURE-MODE] Página ${f}: ${u?"LAYOUT":"LIBRE"}, Celdas: ${((o=l==null?void 0:l.cells)==null?void 0:o.length)||0}`),u&&await new Promise(U=>{requestAnimationFrame(()=>{const j=r.querySelectorAll("[data-cell-id]");U()})});const m=t.type==="pdf",i=!0,p=m?11.81:i?2:3,w=1,C=getComputedStyle(r);let E=(l==null?void 0:l.backgroundColor)||"#ffffff";C.backgroundColor&&C.backgroundColor!=="rgba(0, 0, 0, 0)"&&(E=C.backgroundColor);const _={scale:p,useCORS:!0,allowTaint:!1,backgroundColor:E,width:$.width,height:$.height,x:0,y:0,scrollX:0,scrollY:0,...u&&{windowWidth:$.width,windowHeight:$.height,ignoreElements:y=>{var U;return y.style&&y.style.filter&&t.preserveFilters?!1:(U=y.classList)==null?void 0:U.contains("exclude-from-capture")}},...!u&&{ignoreElements:y=>{var U;return y.style&&y.style.filter&&t.preserveFilters?!1:(U=y.classList)==null?void 0:U.contains("exclude-from-capture")}},foreignObjectRendering:!!(m||u),removeContainer:!1,logging:!!(u&&!i),imageTimeout:m?6e4:u?i?15e3:3e4:15e3,pixelRatio:m?3:i||je?1:window.devicePixelRatio||1,...u&&{allowTaint:!0,useCORS:!0,letterRendering:!i,ignoreElements:y=>{var U,j;return((U=y.classList)==null?void 0:U.contains("exclude-from-capture"))||((j=y.classList)==null?void 0:j.contains("ui-element"))}},canvas:m?document.createElement("canvas"):null,windowWidth:m?$.width*p:null,windowHeight:m?$.height*p:null,onclone:async y=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(j=>{try{y.querySelectorAll(j).forEach(fe=>fe.remove())}catch(V){console.warn("Error removing selector:",j,V)}});try{const j=y.querySelector(`#page-${g[f].id}`);if(j){if(j.style.width=$.width+"px",j.style.height=$.height+"px",u||(j.style.position="relative"),j.style.overflow="hidden",l!=null&&l.backgroundImage&&(j.style.backgroundImage=`url(${l.backgroundImage})`,j.style.backgroundSize="cover",j.style.backgroundPosition="center",j.style.backgroundRepeat="no-repeat"),j.querySelectorAll('[style*="filter"]').forEach(fe=>{console.log("🎭 [THUMBNAIL] Preservando filtros en elemento:",fe.id)}),u){console.log("🔧 [THUMBNAIL-LAYOUT] Aplicando correcciones para grid CSS...");const fe=j.className;console.log(`🔧 [THUMBNAIL-LAYOUT] Clases del grid: ${fe}`);const Ge=getComputedStyle(r);j.style.display="grid",j.style.gridTemplateColumns=Ge.gridTemplateColumns,j.style.gridTemplateRows=Ge.gridTemplateRows,j.style.gap=Ge.gap,j.querySelectorAll("[data-cell-id]").forEach((ye,Z)=>{const Ee=r.querySelector(`[data-cell-id="${ye.getAttribute("data-cell-id")}"]`);if(Ee){const he=getComputedStyle(Ee);ye.style.gridColumn=he.gridColumn,ye.style.gridRow=he.gridRow,ye.style.position="relative"}ye.querySelectorAll('img, [data-element-type="image"]').forEach(he=>{he.style.position==="absolute"&&(he.style.position="absolute")})})}l!=null&&l.backgroundColor&&(j.style.backgroundColor=l.backgroundColor)}}catch(j){console.error("❌ [THUMBNAIL-FIX] Error configurando elemento de página:",j)}try{const j=new Map;r.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((Z,Ee)=>{if(Z.complete&&Z.naturalWidth>0){const he=(Z.closest('[data-element-type="image"]')||Z.parentElement).getBoundingClientRect(),He=Z.getBoundingClientRect();j.set(Z.src,{src:Z.src,naturalWidth:Z.naturalWidth,naturalHeight:Z.naturalHeight,containerWidth:he.width,containerHeight:he.height,objectFit:getComputedStyle(Z).objectFit||"cover",objectPosition:getComputedStyle(Z).objectPosition||"center",crossOrigin:Z.crossOrigin})}});const fe=async(Z,Ee,be,he,He)=>new Promise(lt=>{try{const tt=Ee/be,Rt=he/He;let ct,dt,Pt,Lt,sn,ln;Rt>tt?(ln=be,sn=be*Rt,dt=He,ct=He*tt,Pt=(he-ct)/2,Lt=0):(sn=Ee,ln=Ee/Rt,ct=he,dt=he/tt,Pt=0,Lt=(He-dt)/2);const ut=y.createElement("canvas");ut.width=Ee,ut.height=be;const nr=ut.getContext("2d"),ot=new Image;ot.crossOrigin="anonymous",ot.onload=()=>{try{nr.drawImage(ot,Pt,Lt,ct,dt,0,0,Ee,be);const Mt=ut.toDataURL("image/png",1);Z.src=Mt,Z.style.objectFit="fill",Z.style.objectPosition="center",Z.style.width="100%",Z.style.height="100%",lt()}catch(Mt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en canvas processing:",Mt),lt()}},ot.onerror=()=>{console.warn("⚠️ [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),lt()},ot.src=Z.src}catch(tt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",tt),lt()}}),Ge=y.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),Me=[];Ge.forEach((Z,Ee)=>{if(Z.src&&j.has(Z.src)){const be=j.get(Z.src),he=Z.closest('[data-element-type="image"]')||Z.parentElement;if(he&&(he.style.overflow="hidden",he.style.position="relative"),be.objectFit==="cover"||Z.classList.contains("object-cover")||Z.classList.contains("workspace-image")){const He=fe(Z,be.containerWidth,be.containerHeight,be.naturalWidth,be.naturalHeight);Me.push(He)}else Z.style.width="100%",Z.style.height="100%",Z.style.objectFit="fill"}}),Me.length>0&&await Promise.all(Me);const ye=y.createElement("style");ye.textContent=`
                            /* CORRECCIÓN THUMBNAIL: Estructura del elemento de página */
                            #page-${g[f].id} {
                                width: ${$.width}px !important;
                                height: ${$.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* 🖨️ IMÁGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya están recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${m?`
                                /* 🖨️ IMPRESIÓN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de página */
                            #page-${g[f].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* 🖨️ OPTIMIZACIONES GENERALES PARA PDF DE IMPRESIÓN */
                            ${m?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,y.head.appendChild(ye)}catch(j){console.error("❌ [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",j);const V=y.createElement("style");V.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,y.head.appendChild(V)}}};let N=null,I="";try{if(N=await dn(r,_),m&&N){const y=N.getContext("2d");if(y){y.imageSmoothingEnabled=!1,y.imageSmoothingQuality="high";const U=y.getImageData(0,0,N.width,N.height),j=U.data;for(let V=0;V<j.length;V+=4)j[V]=Math.min(255,j[V]*1.05),j[V+1]=Math.min(255,j[V+1]*1.05),j[V+2]=Math.min(255,j[V+2]*1.05);y.putImageData(U,0,0)}}if(!N)throw new Error("html2canvas no devolvió un canvas válido para el elemento de página");if(N.width===0||N.height===0)throw new Error("Canvas del elemento de página tiene dimensiones inválidas");I=N.toDataURL("image/png",w)}catch(y){throw console.error("❌ [ERROR-CAPTURA]:",y),y}finally{if(N){const y=N.getContext("2d");y&&y.clearRect(0,0,N.width,N.height),N.width=0,N.height=0,N=null}if(i&&window.gc)try{window.gc()}catch{}}if(!I||I==="data:,")throw new Error("No se pudo generar dataURL del elemento de página");return m?N:I}catch(r){console.error("❌ [THUMBNAIL-FIX] Error capturando elemento de página:",r);try{const l=document.createElement("canvas"),c=t.type==="pdf"?11.81:1;l.width=$.width*c,l.height=$.height*c;const u=l.getContext("2d"),m=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return u.fillStyle=m,u.fillRect(0,0,l.width,l.height),u.fillStyle=m==="#ffffff"||m.includes("white")?"#374151":"#666666",u.font=`${14*c}px Arial`,u.textAlign="center",u.fillText("Página "+(f+1),l.width/2,l.height/2),t.type==="pdf"?l:l.toDataURL("image/png",1)}catch{return null}}},[f,g]);h.useCallback(async()=>{if(!g[f])return;const t=await Pe({type:"thumbnail"});t&&ne(o=>({...o,[g[f].id]:t}))},[Pe,f,g]),h.useCallback(()=>{clearTimeout(Jt.current),Jt.current=setTimeout(()=>{g[f]&&(ne(t=>{const o={...t};return delete o[g[f].id],o}),setTimeout(()=>{ae()},200))},1e3)},[g,f,ae]);const Fn=h.useCallback(()=>{g[f]&&(ne(t=>{const o={...t};return delete o[g[f].id],o}),setTimeout(()=>{ae()},300))},[g,f,ae]),Gn=h.useCallback(async(t=f,o={width:800,height:600})=>{var r,l;if(!g[t])return null;try{const c=f;t!==f&&(re(t),await new Promise(p=>setTimeout(p,100)));const u=document.querySelector(`#page-${g[t].id}`);if(!u)return console.warn("Workspace element not found for page:",g[t].id),null;const m={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((r=g[t])==null?void 0:r.backgroundColor)||"#ffffff",width:u.offsetWidth,height:u.offsetHeight,removeContainer:!0,logging:!1,onclone:p=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(N=>{p.querySelectorAll(N).forEach(y=>y.remove())});const C=p.querySelector(`#page-${g[t].id}`);if(C){const N=g[t];N!=null&&N.backgroundImage&&(C.style.backgroundImage=`url(${N.backgroundImage})`,C.style.backgroundSize="cover",C.style.backgroundPosition="center",C.style.backgroundRepeat="no-repeat"),N!=null&&N.backgroundColor&&(C.style.backgroundColor=N.backgroundColor)}try{const N=u.querySelectorAll("img"),I=new Map;N.forEach((U,j)=>{const V=getComputedStyle(U);I.set(j,{objectFit:V.objectFit,objectPosition:V.objectPosition,width:V.width,height:V.height,borderRadius:V.borderRadius,transform:V.transform})}),p.querySelectorAll("img").forEach((U,j)=>{const V=I.get(j);V&&(U.style.objectFit=V.objectFit||"cover",U.style.objectPosition=V.objectPosition||"center",U.style.width=V.width,U.style.height=V.height,U.style.borderRadius=V.borderRadius,U.style.transform=V.transform)})}catch(N){console.warn("Error preservando estilos de imágenes:",N),p.querySelectorAll("img").forEach(y=>{y.style.objectFit="cover",y.style.objectPosition="center",y.style.width||(y.style.width="100%"),y.style.height||(y.style.height="100%")})}p.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(N=>{const I=N.className;I&&(N.className=I);const y=getComputedStyle?getComputedStyle(N):null;y&&(y.fontFamily&&y.fontFamily!=="Arial"&&(N.style.fontFamily=y.fontFamily),y.fontSize&&(N.style.fontSize=y.fontSize),y.fontWeight&&(N.style.fontWeight=y.fontWeight),y.fontStyle&&(N.style.fontStyle=y.fontStyle))});const _=p.createElement("style");_.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CRÍTICO: Asegurar que las imágenes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CRÍTICO: Asegurar que los backgrounds de página se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,p.head.appendChild(_)}},i=await dn(u,m);if(o.width!==i.width||o.height!==i.height){const p=document.createElement("canvas");p.width=o.width,p.height=o.height;const w=p.getContext("2d"),C=i.width/i.height,E=o.width/o.height;let _,N,I=0,y=0;C>E?(_=o.width,N=o.width/C,y=(o.height-N)/2):(N=o.height,_=o.height*C,I=(o.width-_)/2),w.fillStyle=((l=g[t])==null?void 0:l.backgroundColor)||"#ffffff",w.fillRect(0,0,o.width,o.height),w.drawImage(i,I,y,_,N);const U=p.toDataURL("image/png",1);return t!==c&&re(c),U}return t!==c&&re(c),i.toDataURL("image/png",1)}catch(c){return console.error("❌ Error generando thumbnail de alta calidad:",c),null}},[g,f,re]);h.useEffect(()=>{const t=no();Xt(t)},[s,ue]),h.useEffect(()=>{const t=()=>{const o=no();Xt(o)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s,ue]),h.useEffect(()=>{if(!je&&g[f]&&!te[g[f].id]){const t=setTimeout(()=>{ae()},500);return()=>clearTimeout(t)}},[f,g,te,ae]),h.useEffect(()=>{const t=g[f];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(o=>{o.ok?console.log("✅ [WORKSPACE] Imagen existe en el servidor"):console.error("❌ [WORKSPACE] Imagen NO existe en el servidor. Status:",o.status)}).catch(o=>{console.error("❌ [WORKSPACE] Error verificando imagen:",o)})},[f,(vo=g[f])==null?void 0:vo.backgroundImage]),h.useEffect(()=>{const t=`${$.width}x${$.height}`,o=sessionStorage.getItem("lastWorkspaceDimensions");o&&o!==t&&g.length>0&&(ne({}),setTimeout(()=>{g[f]&&Fn()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[$.width,$.height]),h.useEffect(()=>{if(!(n!=null&&n.id)||g.length===0)return;let t,o=Date.now(),r=!1;const l=()=>{r=!0,o=Date.now()},c=async()=>{if(r)try{console.log("🔄 [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(p=>({...p,saveStatus:"saving"}));const m=await fetch(`/api/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:g,force:!1})}),i=await m.json();if(m.ok&&i.success)r=!1,R(p=>({...p,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("✅ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado falló")}catch(m){console.error("❌ [AUTO-SAVE] Error en guardado silencioso:",m),R(i=>({...i,saveStatus:"error",saveError:m.message}))}},u=()=>{t=setInterval(()=>{const m=Date.now()-o;r&&m>6e4&&(console.log("⏰ [AUTO-SAVE] Condiciones cumplidas para guardado automático"),c())},3*60*1e3)};return JSON.stringify(g),g[f],l(),u(),()=>{t&&clearInterval(t)}},[g,f,n==null?void 0:n.id]),h.useEffect(()=>{var o;if(!g[f])return;const t=((o=g[f].cells)==null?void 0:o.flatMap(r=>r.elements))||[];JSON.stringify(t),R(r=>({...r,hasUnsavedChanges:!0}))},[(wo=g[f])==null?void 0:wo.cells,f]);const[ba,St]=h.useState(!1),[xa,Hn]=h.useState({elementId:null,cellId:null}),[Vn,ro]=h.useState(!1),[va,Dn]=h.useState(!1),[wa,ya]=h.useState(null),[Wn,qn]=h.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[$e,ve]=h.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de álbum...",subMessage:"Preparando tu vista previa personalizada"}),jt=h.useRef(null),ao=t=>{var l,c,u,m;const o=H||((c=(l=g[f])==null?void 0:l.cells[0])==null?void 0:c.id);if(!o)return;const r={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((m=(u=g[f].cells.find(i=>i.id===o))==null?void 0:u.elements)==null?void 0:m.length)||0)+1};et(o,r),oe.success("Imagen añadida correctamente")},kt=h.useCallback(ft(async(t=!1)=>{if(!(n!=null&&n.id))return;const o=rt.get(n.id);if(!t&&o&&o.length>0){console.log("🔄 Usando imágenes desde cache"),Oe.length===0&&Fe(o);return}if(Q.current&&clearTimeout(Q.current),Ct&&!t){console.log("⏳ Carga de imágenes ya en progreso");return}qt(!0);try{const r=new AbortController,l=setTimeout(()=>r.abort(),1e4),c=await fetch(`/api/canvas/projects/${n.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:r.signal});if(clearTimeout(l),!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const u=await c.json();if(u.success){const m=u.images||[],i=JSON.stringify(Oe),p=JSON.stringify(m);i!==p&&(Fe(m),Mn(w=>{const C=new Map(w);if(C.set(n.id,m),C.size>5){const E=C.keys().next().value;C.delete(E)}return C}))}else console.error("Error cargando imágenes:",u.message),oe.error("Error cargando galería de imágenes")}catch(r){r.name==="AbortError"?console.warn("⚠️ Carga de imágenes cancelada por timeout"):(console.error("Error cargando imágenes del proyecto:",r),oe.error("Error de conexión al cargar imágenes"))}finally{qt(!1)}},200),[n==null?void 0:n.id,rt,Oe,Ct]),Kn=h.useCallback(async t=>{const o=t.target.files[0];if(!o||!(n!=null&&n.id))return;const r=oe.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),l=URL.createObjectURL(o),c={id:`temp-${Date.now()}`,filename:o.name,url:l,thumbnail_url:l,has_thumbnail:!1,size:o.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Fe(m=>[c,...m]),ao(l);const u=new FormData;u.append("image",o),u.append("projectId",n.id);try{const i=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:u})).json();if(i.success){const p={id:i.id||Date.now(),filename:o.name,url:i.url,thumbnail_url:i.thumbnail_url||i.url,has_thumbnail:i.has_thumbnail||!1,size:o.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Fe(w=>[p,...w.filter(C=>C.id!==c.id)]),setTimeout(()=>{se(w=>{const C=[...w];return C[f].cells.forEach(_=>{_.elements.forEach(N=>{N.type==="image"&&N.content===l&&(N.content=i.url)})}),C})},100),oe.dismiss(r),oe.success(i.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{kt(!0)},2e3)}else Fe(p=>p.filter(w=>w.id!==c.id)),URL.revokeObjectURL(l),oe.dismiss(r),oe.error(i.message||"Error al subir la imagen")}catch(m){console.error("Error subiendo la imagen:",m),Fe(i=>i.filter(p=>p.id!==c.id)),URL.revokeObjectURL(l),oe.dismiss(r),oe.error("Error de red al subir la imagen")}},[n==null?void 0:n.id,f,ao,kt]);h.useEffect(()=>{if(n!=null&&n.id){const t=rt.get(n.id);if(t&&t.length>0){Fe(t);return}return Q.current=setTimeout(()=>{kt(!1)},150),()=>{Q.current&&clearTimeout(Q.current)}}},[n==null?void 0:n.id,rt]),h.useEffect(()=>()=>{Q.current&&clearTimeout(Q.current)},[]);const so=(t,o)=>{if(console.log("🖼️ [ADD-IMAGE] Agregando imagen sin selección automática"),!g||g.length===0||!g[f]){console.error("❌ [ADD-IMAGE] No hay páginas válidas para agregar imagen");return}const r=JSON.parse(JSON.stringify(g));let l=!1;for(let c=0;c<r[f].cells.length;c++)if(r[f].cells[c].id===t){r[f].cells[c].elements.push(o),l=!0,console.log("✅ [ADD-IMAGE] Imagen agregada a la celda:",t);break}if(!l){console.error("❌ [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{Ze(r),console.log("✅ [ADD-IMAGE] Estado actualizado sin selección automática")},0)},Qn=h.useCallback(t=>{var m,i,p,w;console.log("🖼️ [ADD-FROM-GALLERY] Iniciando proceso de agregar imagen:",t);const o=at;Je(!0);const r=Y==="images",l=H||((i=(m=g[f])==null?void 0:m.cells[0])==null?void 0:i.id);if(!l){console.error("❌ [ADD-FROM-GALLERY] No hay celda disponible"),oe.error("No hay celda disponible para agregar la imagen"),Je(o);return}if(!t||typeof t!="string"){console.error("❌ [ADD-FROM-GALLERY] URL de imagen inválida"),oe.error("URL de imagen no válida"),Je(o);return}const c=JSON.parse(JSON.stringify(g));console.log("📸 [ADD-FROM-GALLERY] Snapshot del estado actual capturado");const u={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((w=(p=c[f].cells.find(C=>C.id===l))==null?void 0:p.elements)==null?void 0:w.length)||0)+1};console.log("📝 [ADD-FROM-GALLERY] Elemento creado:",u),setTimeout(()=>{so(l,u),setTimeout(()=>{r&&(xe("images"),console.log("🔄 [ADD-FROM-GALLERY] Tab restaurado a images")),setTimeout(()=>{Je(o),oe.success("✅ Imagen añadida desde la galería"),console.log("✅ [ADD-FROM-GALLERY] Proceso completado exitosamente")},50)},50)},50)},[Y,H,g,f,at,so]),io=h.useCallback(async(t,o)=>{var c,u;const r=[],l=[];for(const m of t){const i={...m};if(m.cells){i.cells=[];for(const p of m.cells){const w={...p};if(p.elements){w.elements=[];for(const C of p.elements)if(C.type==="image"&&((c=C.content)!=null&&c.startsWith("data:image/"))){const E=`${C.id}_${Date.now()}`,_=C.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(_){const N=_[1],I=_[2],U=`${E}.${N==="jpeg"?"jpg":N}`;l.push({filename:U,data:I,type:N,elementId:C.id}),w.elements.push({...C,content:C.content,_wasBase64:!0,_originalSize:C.content.length,_elementId:C.id})}else w.elements.push(C)}else w.elements.push(C)}i.cells.push(w)}}r.push(i)}if(l.length>0)try{const m=await fetch(`/api/canvas/projects/${o}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:l})});if(m.ok){const i=await m.json();if(i.uploadedImages){const p=new Map;i.uploadedImages.forEach(w=>{p.set(w.elementId,w.url)});for(const w of r)if(w.cells){for(const C of w.cells)if(C.elements)for(const E of C.elements)E._wasBase64&&E._elementId&&p.has(E._elementId)&&(E.content=p.get(E._elementId),delete E._elementId)}}}else{const i=await m.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("❌ [IMAGE-UPLOAD] Error subiendo imágenes:",i),t}}catch(m){return console.error("❌ [IMAGE-UPLOAD] Error de red subiendo imágenes:",m),t}return r},[]),Xe=h.useCallback(async(t=g,o=!1)=>{var r;if(!(!(n!=null&&n.id)||!o&&t.length===0))try{const u={design_data:{pages:await io(t,n.id),currentPage:f,workspaceDimensions:$,workspaceSize:ue,selectedElement:z,selectedCell:H,history:ke.slice(-5),historyIndex:Math.min(Ae,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:n.id,name:(a==null?void 0:a.name)||"Álbum Personalizado",item_id:a==null?void 0:a.id,preset_id:s==null?void 0:s.id}},thumbnails:te},i=JSON.stringify(u).length/(1024*1024),p=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(u)});if(p.ok){const w=await p.json(),C=`editor_progress_project_${n.id}`;return localStorage.removeItem(C),F(E=>{const _=new Map(E);return o?_.clear():_.delete(f),_}),g&&g.length>0&&setTimeout(()=>{ae().catch(E=>{console.warn("⚠️ Error regenerando thumbnail de página actual:",E)})},300),!0}else{const w=await p.json().catch(()=>({message:"Error desconocido"}));return console.error("❌ [AUTO-SAVE] Error guardando en BD:",w),!1}}catch(l){return console.error("❌ [AUTO-SAVE] Error en auto-save con procesamiento de imágenes:",l),!1}},[g,f,$,ue,n==null?void 0:n.id,a==null?void 0:a.name,a==null?void 0:a.id,s==null?void 0:s.id,io,At]);h.useEffect(()=>{if(!(n!=null&&n.id))return;const t=setInterval(()=>{g.length>0&&Xe(g,!1)},10*60*1e3);return()=>clearInterval(t)},[Xe,g,n==null?void 0:n.id]),h.useCallback(async()=>{if(!g.length)return{};console.log("📸 [THUMBNAILS] Capturando thumbnails de todas las páginas...");const t={},o=f;try{for(let r=0;r<g.length;r++){const l=g[r];if(l!=null&&l.id)try{r!==f&&(re(r),await new Promise(u=>setTimeout(u,300)));const c=await Pe({type:"thumbnail"});c&&(t[l.id]=c,console.log(`✅ [THUMBNAILS] Thumbnail capturado para página ${r+1}: ${l.id}`))}catch(c){console.warn(`⚠️ [THUMBNAILS] Error capturando thumbnail para página ${l.id}:`,c),te[l.id]&&(t[l.id]=te[l.id])}}return o!==f&&re(o),console.log(`✅ [THUMBNAILS] Capturados ${Object.keys(t).length} thumbnails de ${g.length} páginas`),t}catch(r){return console.error("❌ [THUMBNAILS] Error capturando thumbnails:",r),o!==f&&re(o),te}},[g,f,re,Pe,te]);const lo=h.useCallback(async()=>{if(!(n!=null&&n.id)||g.length===0)return oe.error("No hay datos para guardar"),!1;try{return console.log("📸 [SAVE] Generando thumbnail de página actual..."),await ae(),await oo(),await Xe(g,!0)?(oe.success("Progreso guardado exitosamente"),!0):(oe.error("Error al guardar el progreso"),!1)}catch(t){return console.error("❌ [SAVE] Error al guardar el progreso:",t),oe.error("Error al guardar el progreso"),!1}},[Xe,g,n==null?void 0:n.id,$,s,At]),co=h.useCallback(async t=>{var o;if(console.log("💾 [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("🔍 [QUEUE-SAVE] Datos disponibles:",{projectId:n==null?void 0:n.id,pagesCount:t==null?void 0:t.length,currentPage:f,hasDimensions:!!$,hasThumbnails:!!te}),!(n!=null&&n.id))return console.error("❌ [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return console.error("❌ [QUEUE-SAVE] No hay páginas para guardar"),!1;try{const l={design_data:{pages:t,currentPage:f,workspaceDimensions:$,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:te};console.log("📤 [QUEUE-SAVE] Enviando petición al servidor...");const c=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(l)});if(console.log("📥 [QUEUE-SAVE] Respuesta del servidor:",c.status,c.statusText),c.ok){const u=await c.json();return console.log("✅ [QUEUE-SAVE] Guardado exitoso desde cola:",u),!0}else{const u=await c.text();return console.error("❌ [QUEUE-SAVE] Error en respuesta del servidor:",c.status,u),!1}}catch(r){return console.error("❌ [QUEUE-SAVE] Error guardando desde cola:",r),!1}},[n==null?void 0:n.id,f,$,te]),Ot=h.useCallback(async()=>{if(console.log("🔍 [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:K,saveQueueLength:P.length}),K){console.log("⚠️ [SAVE-QUEUE] Ya se está procesando, saltando...");return}if(P.length===0){console.log("⚠️ [SAVE-QUEUE] Cola vacía, no hay nada que procesar");return}console.log("🚀 [SAVE-QUEUE] Iniciando procesamiento de cola..."),L(!0);try{const t=P.slice();console.log("� [SAVE-QUEUE] Cola capturada para procesamiento:",t.length,"elementos"),q([]),console.log("🧹 [SAVE-QUEUE] Cola limpiada");for(const o of t)console.log("💾 [SAVE-QUEUE] Guardando página:",o.pageIndex),await co(o.pages)?(F(l=>{const c=new Map(l);return c.delete(o.pageIndex),c}),console.log("✅ [SAVE-QUEUE] Página guardada exitosamente:",o.pageIndex)):(console.error("❌ [SAVE-QUEUE] Error guardando página:",o.pageIndex),q(l=>[...l,o]));console.log("✅ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(t){console.error("❌ [SAVE-QUEUE] Error procesando cola:",t)}finally{L(!1),console.log("🔓 [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[K,P,co]);h.useEffect(()=>{console.log("🔄 [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:P.length,isProcessingQueue:K,shouldProcess:P.length>0&&!K}),P.length>0&&!K&&(console.log("⏰ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{Ot()},100))},[P.length,K,Ot]),h.useEffect(()=>{console.log("📊 [SAVE-QUEUE] Estado de cola actualizado:",{longitud:P.length,elementos:P.map(t=>`página ${t.pageIndex}`),procesando:K})},[P,K]);const uo=h.useCallback((t,o)=>{console.log("🔍 [SAVE-QUEUE] Intentando agregar página a cola:",t),F(r=>{const l=Array.from(r.keys());return console.log("🔍 [SAVE-QUEUE] Cambios actuales:",l.join(", ")||"ninguno"),r.has(t)?(console.log("✅ [SAVE-QUEUE] Página tiene cambios, agregando a cola:",t),q(c=>{console.log("🔍 [SAVE-QUEUE] Cola actual antes de agregar:",c.length,"elementos");const u=c.findIndex(m=>m.pageIndex===t);if(u!==-1){const m=[...c];return m[u]={pageIndex:t,pages:o,timestamp:Date.now()},console.log("🔄 [SAVE-QUEUE] Actualizando elemento existente en cola"),m}else{const m=[...c,{pageIndex:t,pages:o,timestamp:Date.now()}];return console.log("➕ [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",m.length),m}}),console.log("📤 [SAVE-QUEUE] Página agregada a cola:",t),r):(console.log("⚠️ [SAVE-QUEUE] No hay cambios para la página:",t,"- No se agregará a cola"),r)})},[]),It=h.useCallback(async t=>{if(console.log("🔄 [PAGE-CHANGE] Iniciando cambio de página de",f,"a",t),t===f){console.log("⚠️ [PAGE-CHANGE] Misma página, no se hace nada");return}F(o=>{console.log("🔍 [PAGE-CHANGE] Verificando cambios en página actual:",f);const r=Array.from(o.keys());return console.log("🔍 [PAGE-CHANGE] Páginas con cambios:",r.join(", ")||"ninguna"),o.has(f)?(console.log("💾 [PAGE-CHANGE] ✅ Página actual tiene cambios, guardando antes del cambio:",f),uo(f,g)):console.log("ℹ️ [PAGE-CHANGE] No hay cambios en la página actual:",f),o}),re(t),console.log("📄 [PAGE-CHANGE] ✅ Página cambiada a:",t)},[f,g,uo]),qe=()=>`editor_progress_project_${n==null?void 0:n.id}`,go=h.useCallback(async()=>{var o,r,l,c;if(!(n!=null&&n.id))return;if(g.some(u=>{var m;return(m=u.cells)==null?void 0:m.some(i=>{var p;return((p=i.elements)==null?void 0:p.length)>0})})){console.log("⚠️ [RECOVERY] Ya hay contenido en el workspace, saltando recuperación automática");return}try{const u=Re.loadFromLocalStorage(),m=await fetch(`/api/canvas/projects/${n.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let i=null;if(m.ok){const w=await m.json();w.success&&((o=w.data)!=null&&o.design_data)&&(i=w.data)}let p=null;if(u&&i){const w=new Date(u.savedAt).getTime(),C=new Date(i.saved_at).getTime();p=w>C?u:i}else u?p=u:i&&(p=i);if(p&&(((r=p.pages)==null?void 0:r.length)>0||((c=(l=p.design_data)==null?void 0:l.pages)==null?void 0:c.length)>0)){const w=new Date(p.savedAt||p.saved_at).getTime();Date.now()-w<30*60*1e3?(console.log("🔄 [AUTO-RECOVERY] Cargando automáticamente el progreso más reciente"),oe.info("🔄 Cargando progreso guardado automáticamente..."),Yn(p)):console.log("📅 [RECOVERY] Progreso muy antiguo, ignorando automáticamente")}}catch(u){console.error("❌ [RECOVERY] Error verificando progreso guardado:",u)}},[n==null?void 0:n.id,Re,g]),Yn=h.useCallback(async t=>{var o;try{let r=[];if(t.pages?r=t.pages:(o=t.design_data)!=null&&o.pages&&(r=t.design_data.pages),r.length>0){se(r);const l=[JSON.stringify(r)];Ke(l),ze(0),setTimeout(()=>{ne({})},100),oe.success("✅ Progreso cargado exitosamente"),Dn(!1)}}catch(r){console.error("❌ [RECOVERY] Error cargando progreso:",r),oe.error("Error al cargar el progreso guardado")}},[se,Ke,ze,ne]);h.useCallback(async()=>{try{const t=Re.getStorageKey();localStorage.removeItem(t),oe.success("Progreso anterior eliminado")}catch(t){console.error("❌ [RECOVERY] Error descartando progreso:",t)}},[Re]),h.useEffect(()=>{n&&a&&s&&(!(T!=null&&T.pages)||T.pages.length===0)&&mo(s,a)},[n,a,s,T]),h.useEffect(()=>{n!=null&&n.id&&!A&&g.length===0&&!at&&(Je(!0),setTimeout(()=>{go()},500))},[n==null?void 0:n.id,A,g.length,go,at]),h.useEffect(()=>(ge.current&&clearTimeout(ge.current),n!=null&&n.id&&g.length>0&&(ge.current=setTimeout(()=>{oo()},500)),()=>{ge.current&&clearTimeout(ge.current)}),[n==null?void 0:n.id,g.length]);const mo=(t,o)=>{try{const r=[],l=o.pages||t.pages||20;if(o.has_cover_image===!0||o.has_cover_image===1){const m=o.cover_image?`/storage/images/item/${o.cover_image}`:null,i=o.cover_image?null:t.background_color||"#ffffff",p={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:m,backgroundColor:i,cells:[{id:"cell-cover-1",elements:[]}]};r.push(p)}const c=o.content_image?`/storage/images/item/${o.content_image}`:null,u=o.content_image?null:t.background_color||"#ffffff";for(let m=1;m<=l;m++){const i={id:`page-content-${m}`,type:"content",pageNumber:m,layout:"layout-1",backgroundImage:c,backgroundColor:u,cells:[{id:`cell-content-${m}-1`,elements:[]}]};r.push(i)}if(o.has_back_cover_image===!0||o.has_back_cover_image===1){const m=o.back_cover_image?`/storage/images/item/${o.back_cover_image}`:null,i=o.back_cover_image?null:t.background_color||"#ffffff",p={id:"page-final",type:"final",layout:"layout-1",backgroundImage:m,backgroundColor:i,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};r.push(p)}se(r),re(0),t.width&&t.height&&We("preset")}catch(r){console.error("❌ Error creating pages:",r),W(r.message)}},po=h.useCallback(t=>{var u,m;if(!t||t.length===0)return[];const o=t.filter(i=>i.type==="cover"),r=t.filter(i=>i.type==="content"),l=t.filter(i=>i.type==="final");if(console.log("🎯 [BOOK-ORGANIZE] Organizando páginas del libro:",{cover:o.length,content:r.length,final:l.length,total:t.length}),o.length===0&&l.length===0)return console.log("📖 [BOOK-ORGANIZE] Sin tapas - orden normal"),t;const c=[];return o.length>0&&(c.push(...o),console.log("📕 [BOOK-ORGANIZE] Tapa agregada en posición 0 (derecha)"),c.push({id:`blank-page-cover-back-${Date.now()}`,type:"blank",isBlankPage:!0,hasLogo:!0,logoUrl:"/assets/resources/logo.png",cells:[],backgroundColor:"#ffffff",layout:((u=ie[0])==null?void 0:u.id)||"layout1"}),console.log("📄 [BOOK-ORGANIZE] Reverso de tapa con logo agregado en posición 1 (izquierda)")),r.length>0&&(c.push(...r),console.log("📄 [BOOK-ORGANIZE] Contenido agregado:",r.length+" páginas, página 1 en posición",c.length-r.length)),l.length>0&&(c.length%2===1&&(c.push({id:`blank-page-before-back-${Date.now()}`,type:"blank",isBlankPage:!0,cells:[],backgroundColor:"#ffffff",layout:((m=ie[0])==null?void 0:m.id)||"layout1"}),console.log("📄 [BOOK-ORGANIZE] Página en blanco agregada para correcto posicionamiento de contratapa")),c.push(...l),console.log("📕 [BOOK-ORGANIZE] Contratapa agregada en posición",c.length-1,"(izquierda)")),console.log("✅ [BOOK-ORGANIZE] Organización final:",{totalPages:c.length,sequence:c.map((i,p)=>({position:p,type:i.type,side:p===0?"Tapa (derecha)":p===1&&i.type==="blank"?"Reverso tapa (izquierda)":p===c.length-1&&i.type==="final"?"Contratapa (izquierda)":i.type==="blank"?"Página en blanco":p%2===1?"Izquierda":"Derecha",id:i.id,pageNumber:i.type==="content"?`Página ${r.indexOf(i)+1}`:""}))}),c},[ie]),le=h.useMemo(()=>a?{cover:g.filter(t=>t.type==="cover"&&(a.has_cover_image===!0||a.has_cover_image===1)),content:g.filter(t=>t.type==="content"),final:g.filter(t=>t.type==="final"&&(a.has_back_cover_image===!0||a.has_back_cover_image===1))}:{cover:g.filter(t=>t.type==="cover"),content:g.filter(t=>t.type==="content"),final:g.filter(t=>t.type==="final")},[g,a]),ce=h.useCallback(()=>{if(!a)return console.warn("⚠️ [CONTENT-TYPE] itemData no disponible, usando tipo por defecto"),{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"};const t=a.has_cover_image===!0||a.has_cover_image===1,o=a.has_back_cover_image===!0||a.has_back_cover_image===1,r=t&&le.cover.length>0,l=o&&le.final.length>0,c=le.content.length;return console.log("🎯 [CONTENT-TYPE] Análisis de contenido:",{coverEnabled:t,backCoverEnabled:o,coverPagesExist:le.cover.length>0,finalPagesExist:le.final.length>0,hasCover:r,hasBackCover:l,contentPages:c,itemConfig:{has_cover_image:a.has_cover_image,has_back_cover_image:a.has_back_cover_image}}),r&&l?{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"}:r||l?{type:"booklet",name:"Folleto",description:"Vista de Folleto",icon:"📋",experience:"booklet"}:c>1?{type:"catalog",name:"Catálogo",description:"Vista de Catálogo",icon:"📑",experience:"catalog"}:{type:"card",name:"Diseño",description:"Vista Previa",icon:"🎨",experience:"single"}},[le,a])(),X=h.useCallback(()=>{if(!z||!H||g.length===0)return null;const t=g[f];if(!t)return null;const o=t.cells.find(r=>r.id===H);return o?o.elements.find(r=>r.id===z):null},[z,H,g,f]),ho=(t,o)=>{if(o){const r=g[f].cells.find(c=>c.id===o),l=r==null?void 0:r.elements.find(c=>c.id===t);if(l!=null&&l.locked){const c=document.createElement("div");c.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",c.textContent="Este elemento es parte del diseño base y no se puede editar",document.body.appendChild(c),setTimeout(()=>{document.body.contains(c)&&document.body.removeChild(c)},3e3);return}}if(o&&pe(o),J(t),t){const r=g[f].cells.find(c=>c.id===(o||H)),l=r==null?void 0:r.elements.find(c=>c.id===t);(l==null?void 0:l.type)==="image"?(Wt(l),console.log("🖼️ Imagen seleccionada:",l.id,"- Tab actual mantenido:",Y),Y==="filters"?console.log("✅ Usuario ya está en filtros, manteniendo"):console.log("✅ Imagen seleccionada, pero manteniendo tab actual:",Y)):(l==null?void 0:l.type)==="text"?(St(!0),Hn({elementId:t,cellId:o||H}),Y!=="filters"&&Y!=="images"&&xe("text")):St(!1)}else St(!1),Wt(null)},Le=()=>{if(g.length===0)return ie[0];const t=g[f];return t?ie.find(o=>o.id===t.layout)||ie[0]:ie[0]},fo=h.useCallback(ft(t=>{try{const o=qe(),r={pages:t,currentPage:f,savedAt:Date.now()},l=JSON.stringify(r),c=Math.round(l.length/1024);c<2048?localStorage.setItem(o,l):(console.warn(`⚠️ Datos demasiado grandes para localStorage (${c} KB)`),localStorage.removeItem(o))}catch(o){if(console.error("❌ Error guardando en localStorage:",o),o.name==="QuotaExceededError")try{localStorage.removeItem(qe())}catch(r){console.error("Error limpiando localStorage:",r)}}},300),[f,qe]),Ze=h.useCallback(t=>{se(o=>{if(o===t)return o;const r=JSON.stringify(o),l=JSON.stringify(t);return r===l?(console.log("🔄 [UPDATE-PAGES] Sin cambios, evitando actualización"),o):(console.log("📝 [UPDATE-PAGES] Aplicando cambios..."),requestAnimationFrame(()=>{if(F(c=>{const u=new Map(c);return u.set(f,Date.now()),u}),t[f]){const c=t[f].id;ne(u=>{if(u[c]){const m={...u};return delete m[c],m}return u})}}),setTimeout(()=>{Ke(c=>{const u=[...c.slice(0,Ae+1),l];return u.length>50?u.slice(-50):u}),ze(c=>{const u=c+1;return u>50?49:u})},0),t)}),fo(t)},[f,Ae,fo]);h.useEffect(()=>{try{const t=qe(),o={pages:g,currentPage:f,savedAt:Date.now()},r=JSON.stringify(o),l=Math.round(r.length/1024);l<2048?localStorage.setItem(t,r):console.warn(`⚠️ Datos demasiado grandes para localStorage (${l} KB), saltando guardado`)}catch(t){if(console.error("❌ Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const o=qe();localStorage.removeItem(o)}catch(o){console.error("Error limpiando localStorage:",o)}}},[f,g,qe]);const Jn=t=>{const o=ie.find(u=>u.id===t);if(!o)return;const r=[...g],l=r[f],c=Array.from({length:o.cells}).map((u,m)=>l.cells[m]||{id:`cell-${l.id}-${m+1}`,elements:[]});r[f]={...l,layout:t,cells:c},Ze(r),J(null),pe(null)},et=(t,o)=>{const r=[...g];for(let l=0;l<r[f].cells.length;l++)r[f].cells[l].id===t&&r[f].cells[l].elements.push(o);Ze(r),J(o.id),pe(t)},bo=h.useCallback(ft(()=>{F(t=>{const o=new Map(t);return o.set(f,Date.now()),o})},100),[f]),de=h.useCallback((t,o,r,l=!1)=>{console.log("🔄 [updateElementInCell] Actualizando elemento:",{cellId:t,elementId:o,updates:r,isDuplicate:l}),console.log("🔍 [updateElementInCell] Verificando si hay cambios en filtros/máscaras:",{hasFilters:!!r.filters,hasMask:!!r.mask,filtersData:r.filters,maskData:r.mask}),se(c=>{const u=[...c],m=u[f].cells.findIndex(i=>i.id===t);if(m===-1)return c;if(l){const i=u[f].cells[m].elements.find(p=>p.id===o);if(!i)return c;u[f].cells[m].elements.push({...i,...r})}else{const i=u[f].cells[m].elements.findIndex(E=>E.id===o);if(i===-1)return c;const p=u[f].cells[m].elements[i];if(!Object.keys(r).some(E=>{const _=p[E],N=r[E];return typeof N=="object"&&typeof _=="object"?JSON.stringify(_)!==JSON.stringify(N):_!==N}))return console.log("🚫 [updateElementInCell] No hay cambios reales, saltando actualización"),c;const C={...p,...r};console.log("✅ [updateElementInCell] Elemento actualizado:",C),u[f].cells[m].elements[i]=C,r.filters||r.mask?(console.log("🔄 [AUTO-REGEN] Cambios en filtros/máscaras detectados, regenerando thumbnail..."),console.log("🔄 [AUTO-REGEN] Datos de cambios:",{filters:r.filters,mask:r.mask}),window.FORCE_THUMBNAIL_REGENERATION&&(console.log("💥 [FORZADO-EMERGENCIA] Limpiando caché de thumbnails completamente"),window.thumbnailCache={}),ae(!0).then(()=>{console.log("✅ [AUTO-REGEN] Thumbnail regenerado exitosamente"),window.FORCE_THUMBNAIL_REGENERATION&&window.forceRegenerateThumbnail&&setTimeout(()=>{console.log("🔄 [FORZADO-EMERGENCIA] Ejecutando regeneración forzada secundaria");try{window.forceRegenerateThumbnail()}catch(E){console.error("❌ [FORZADO-EMERGENCIA] Error en regeneración secundaria:",E)}},150)}).catch(E=>{console.error("❌ [AUTO-REGEN] Error regenerando thumbnail:",E)})):console.log("🚫 [AUTO-REGEN] No hay cambios en filtros/máscaras, saltando regeneración")}return u}),r.position||r.size?requestAnimationFrame(()=>{F(c=>{if(c.has(f))return c;const u=new Map(c);return u.set(f,Date.now()),u})}):bo()},[f,bo]);h.useCallback(()=>{var o;if(je){Ft("🚫 [VPS-PROTECTION] forceRegenerateThumbnail bloqueado en servidor");return}console.log("🚨 [FORCE-REGEN] Iniciando regeneración forzada..."),window.thumbnailCache&&(window.thumbnailCache={}),window.THUMBNAIL_PROTECTED=!0,window._protectedThumbnailIds||(window._protectedThumbnailIds=[]);const t=(o=g[f])==null?void 0:o.id;t&&!window._protectedThumbnailIds.includes(t)&&window._protectedThumbnailIds.push(t),window.BLOCK_AUTO_REGENERATION=!0,ae(!0),setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,console.log("🔓 Regeneración automática desbloqueada después de protección")},1e4)},[ae]),h.useCallback(()=>{z&&H?(console.log("🧪 [TEST] Aplicando filtro grayscale de prueba..."),de(H,z,{filters:{brightness:100,contrast:100,saturation:0,opacity:100}})):console.log("⚠️ [TEST] No hay elemento seleccionado")},[z,H,de]),h.useCallback(()=>{console.log("🔒 [BLOQUEO-SELECTIVO] Activando protección para thumbnails con filtros"),window.THUMBNAIL_PROTECTED=!0,window.PERMANENT_THUMBNAIL_LOCK=!0,window.BLOCK_AUTO_REGENERATION=!1,window._protectedThumbnailIds=Object.keys(te);const t=window.forceRegenerateThumbnail;window.forceRegenerateThumbnail=(...o)=>window._userInitiated?(console.log("✅ [REGENERACIÓN AUTORIZADA] Permitiendo regeneración solicitada por usuario"),window._userInitiated=!1,t(...o)):(console.log("🛑 [REGENERACIÓN BLOQUEADA] Intento de regeneración no autorizado bloqueado"),!1),window._allowNextRegeneration=()=>{window._userInitiated=!0},window.safeRegenerateThumbnail=()=>{window._allowNextRegeneration(),window.forceRegenerateThumbnail()},window._thumbnailBackup={...te},alert(`🔒 Miniaturas protegidas exitosamente!

Si necesitas regenerar una miniatura específica, usa window.safeRegenerateThumbnail() en la consola.`),console.log("🔒 [BLOQUEO-PERMANENTE] Thumbnails protegidos:",window._protectedThumbnailIds),console.log("🔒 [BLOQUEO-PERMANENTE] No se permitirán más regeneraciones automáticas"),console.log("📢 [INSTRUCCIONES] Para regenerar manualmente una miniatura, ejecuta window.safeRegenerateThumbnail() en la consola")},[te]),h.useCallback(()=>{console.log("🌈 [FILTROS-FORZADOS] Iniciando regeneración con filtros garantizados..."),window.FORCE_FILTER_APPLICATION=!0,window.ENABLE_ADVANCED_FILTER_RENDERING=!0,window.thumbnailCache&&window.thumbnailCache.clear(),$t&&$t();const t=g[f];t&&t.cells&&t.cells.forEach(o=>{o.elements&&o.elements.forEach(r=>{r.filters&&(console.log(`🔍 [FILTROS-FORZADOS] Marcando elemento ${r.id} para filtros forzados`),r._hasRealFilters=!0,r.pageId=t.id)})}),ae(!0),console.log("🎉 [FILTROS-FORZADOS] Regeneración completada")},[g,f,ae]);const it=(t,o)=>{const r=[...g],l=r[f].cells.findIndex(c=>c.id===t);l!==-1&&(r[f].cells[l].elements=r[f].cells[l].elements.filter(c=>c.id!==o),Ze(r),z===o&&J(null))},Xn=(t,o,r)=>{const l=[...g],c=l[f].cells.findIndex(u=>u.id===t);if(c!==-1){const u=l[f].cells[c].elements,m=u.findIndex(i=>i.id===o);if(m!==-1){const i=r==="up"?m+1:m-1;if(i>=0&&i<u.length){const p=u[m];u[m]=u[i],u[i]=p,Ze(l)}}}},Zn=()=>{Ae>0&&(ze(Ae-1),se(JSON.parse(ke[Ae-1])),J(null),pe(null))},er=()=>{Ae<ke.length-1&&(ze(Ae+1),se(JSON.parse(ke[Ae+1])),J(null),pe(null))},_t=(t="body")=>{const o=`text-${Date.now()}`,r={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},l={heading:"Título Principal",subheading:"Subtítulo",body:"Haz clic para editar"},c={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},u={id:o,type:"text",content:l[t],position:{x:.05,y:.05},size:c[t],style:r[t]};H?et(H,u):console.log("Selecciona una celda primero")},xo=h.useMemo(()=>{var c;const t=g[f];if(!t)return null;const o=((c=t.cells)==null?void 0:c.flatMap(u=>u.elements||[]))||[],r=o.map(u=>({id:u.id,type:u.type,position:u.position,size:u.size}));return{pageId:t.id,elementsCount:o.length,contentHash:JSON.stringify(r).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[g,f]);h.useEffect(()=>{var m;if(je)return;const t=g[f];if(!t)return;const o=t.id,r=(m=t==null?void 0:t.cells)==null?void 0:m.some(i=>{var p;return(p=i.elements)==null?void 0:p.some(w=>w.filters&&(w.filters.brightness!==100||w.filters.contrast!==100||w.filters.saturation!==100||w.filters.tint!==0||w.filters.hue!==0))});if(r&&(console.log("🎭 [FILTROS DETECTADOS] Esta página tiene filtros aplicados"),window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(o)||window._protectedThumbnailIds.push(o)),console.log("✅ [THUMBNAIL] Generando miniatura "+(r?"CON filtros aplicados":"sin filtros")+"..."),g.length===0||A||!xo)return;let l=!1;const c=async()=>{var i;if(console.log("INCIO GENERATE"),window.PREVENT_THUMBNAIL_RESET||window.THUMBNAIL_PROTECTED){console.log("🛡️ [PROTECCIÓN ACTIVA] Regeneración cancelada");return}try{const p=g[f];if(console.log("AQUI MOSTRAMOS EL CURRENT ",p),!p||!p.id)return;const w=p.id;if(!window.PREVENT_THUMBNAIL_RESET&&!window.THUMBNAIL_PROTECTED&&ne(N=>{const I={...N};return delete I[w],I}),await new Promise(N=>setTimeout(N,100)),console.log("ANTES DEL CANCELED"),l)return;const C=(i=p==null?void 0:p.cells)==null?void 0:i.some(N=>{var I;return(I=N.elements)==null?void 0:I.some(y=>y.filters&&(y.filters.brightness!==100||y.filters.contrast!==100||y.filters.saturation!==100||y.filters.tint!==0||y.filters.hue!==0))}),E=C?{type:"thumbnail",preserveFilters:!0}:{type:"thumbnail"};console.log(`🎭 [CAPTURE] Generando miniatura ${C?"CON filtros":"estándar"}`);const _=await Pe(E);console.log("ESTA ES THUMBANIL"+_),_&&!l?(ne(N=>({...N,[w]:_})),console.log("ESTA ES UNA NUEVA CONSOLA"+C),C&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(w)||window._protectedThumbnailIds.push(w))):console.warn("⚠️ [DEBUG] No se pudo generar miniatura para:",w)}catch(p){l||console.error("❌ [DEBUG] Error regenerando miniatura:",p)}},u=setTimeout(()=>{c()},500);return()=>{l=!0,clearTimeout(u)}},[f,xo,A,Pe]),h.useEffect(()=>{if(window.BLOCK_AUTO_REGENERATION){console.log("🛡️ [PROTECCIÓN PARCIAL] Bloqueando generación temporal en segundo plano");return}if(g.length===0||A)return;const t=async()=>{if(window.BLOCK_AUTO_REGENERATION){console.log("🛡️ [PROTECCIÓN TEMPORAL] Generación en segundo plano pausada");return}const r=g.filter(l=>!te[l.id]);if(r.length!==0)for(const l of r)try{const c=document.createElement("canvas");c.width=200,c.height=150;const u=c.getContext("2d");if(u.fillStyle=l.backgroundColor||"#ffffff",u.fillRect(0,0,200,150),l.backgroundImage)try{const i=new Image;i.crossOrigin="anonymous",await new Promise((p,w)=>{i.onload=p,i.onerror=w,i.src=l.backgroundImage}),u.drawImage(i,0,0,200,150)}catch(i){console.warn("No se pudo cargar imagen de fondo para miniatura:",i)}l.cells&&l.cells.forEach(i=>{i.elements&&i.elements.forEach(p=>{var w;p.type==="text"&&p.content&&(u.fillStyle=((w=p.style)==null?void 0:w.color)||"#000000",u.font="12px Arial",u.fillText(p.content.substring(0,20)+(p.content.length>20?"...":""),10,30))})});const m=c.toDataURL("image/jpeg",.7);ne(i=>({...i,[l.id]:m})),await new Promise(i=>setTimeout(i,300))}catch(c){console.error("❌ Error generando miniatura de fondo para:",l.id,c)}},o=setTimeout(()=>{t()},2e3);return()=>clearTimeout(o)},[g,te,A]),h.useEffect(()=>{const t=o=>{const r=D.current,l=ee.current;if(r.length>0||l.size>0)return o.preventDefault(),o.returnValue="Hay cambios sin guardar. ¿Estás seguro de que quieres salir?",o.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),h.useEffect(()=>()=>{console.log("🧹 [CLEANUP] Componente desmontado")},[]);const tr=async()=>{var t;try{if(console.log("🚀 ===== INICIANDO addAlbumToCart ====="),console.log("📦 itemData:",a),console.log("🎨 presetData:",s),console.log("📋 projectData:",n),console.log("🆔 projectData?.id:",n==null?void 0:n.id),console.log("====================================="),!a||!s||!(n!=null&&n.id))return!1;await Xe(g,!0)||console.warn("⚠️ No se pudo guardar el progreso, pero continuando...");const r={design_data:{id:n.id,title:(a==null?void 0:a.name)||"Álbum Personalizado",pages:g,workspace_dimensions:$,created_at:new Date().toISOString()},item_data:{id:a==null?void 0:a.id,name:(a==null?void 0:a.name)||(a==null?void 0:a.title),price:a==null?void 0:a.price,user_id:a==null?void 0:a.user_id,width:a==null?void 0:a.width,height:a==null?void 0:a.height},preset_data:{id:s==null?void 0:s.id,width:s==null?void 0:s.width,height:s==null?void 0:s.height,cover_image:s==null?void 0:s.cover_image,content_layer_image:s==null?void 0:s.content_layer_image,final_layer_image:s==null?void 0:s.final_layer_image},dimensions:{width_mm:(s==null?void 0:s.width)||(a==null?void 0:a.width)||210,height_mm:(s==null?void 0:s.height)||(a==null?void 0:a.height)||297,workspace_width:($==null?void 0:$.width)||800,workspace_height:($==null?void 0:$.height)||600}};try{const C=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:n.id,status:"ready_for_pdf",pdf_data:r,completed_at:new Date().toISOString()})});if(C.ok){const E=await C.json()}else console.warn("⚠️ Error marcando proyecto como completado")}catch(C){console.warn("⚠️ Error en marcado de completado:",C)}const l=Date.now(),c=n.id;window.currentProjectId=c,window.albumProjectId=c;let u=s.cover_image;te&&te["page-cover"]&&(u=te["page-cover"]);let m=u;u&&u.startsWith("data:image/")&&u.length>1e5&&(m=s.cover_image||"/assets/img/default-album.jpg");const i={...a,project_id:c,canvas_project_id:n.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:s.width,height_mm:s.height,pages_count:g.length,workspace_dimensions:$,requires_pdf_generation:!0}};console.log("📦 PRODUCTO ÁLBUM CREADO:",i),console.log("🎯 PROJECT IDS:",{project_id:c,canvas_project_id:n.id,item_id:a==null?void 0:a.id});const p=structuredClone(Te),w=p.findIndex(C=>C.id==i.id);return w==-1?p.push({...i,quantity:1}):p[w].quantity++,Ue(p),oe.success("Álbum agregado al carrito",{description:`${i.name} se ha añadido al carrito. El PDF se generará en el backend.`,icon:e.jsx(Cr,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:p,action:"add",product:i}})),!0}catch(o){return console.error("❌ === ERROR EN addAlbumToCart ==="),console.error("Error completo:",o),console.error("Stack trace:",o.stack),console.error("Mensaje del error:",o.message),oe.error("Error al agregar al carrito",{description:`Error específico: ${o.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!g||g.length===0)throw new Error("No hay páginas para finalizar");const r={design_data:{pages:(E=>E.map(_=>({id:_.id,type:_.type,pageNumber:_.pageNumber,layout:_.layout,cells:_.cells.map(N=>({id:N.id,elements:N.elements.map(I=>{const y={id:I.id,type:I.type,position:I.position,zIndex:I.zIndex||1};if(I.type==="image"){if(I.content.startsWith("data:image/")){const U=btoa(I.content.substring(0,100)).substring(0,20);y.content=`[BASE64_IMAGE_${U}]`,y.contentType=I.content.split(";")[0].split(":")[1],y.originalSize=I.content.length}else y.content=I.content;if(I.filters){const U=Object.entries(I.filters).filter(([j,V])=>V!==0&&V!==!1&&V!==null).reduce((j,[V,fe])=>(j[V]=fe,j),{});Object.keys(U).length>0&&(y.filters=U)}I.mask&&I.mask!=="none"&&(y.mask=I.mask),I.size&&(y.size=I.size),I.locked&&(y.locked=I.locked)}else if(I.type==="text"&&(y.content=I.content,I.style)){const U=Object.entries(I.style).filter(([j,V])=>!(j==="fontSize"&&V==="16px"||j==="color"&&V==="#000000"||j==="fontFamily"&&V==="Arial")).reduce((j,[V,fe])=>(j[V]=fe,j),{});Object.keys(U).length>0&&(y.style=U)}return y})}))})))(g),projectInfo:{id:n==null?void 0:n.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:s==null?void 0:s.id},presetInfo:{id:s==null?void 0:s.id,name:s==null?void 0:s.name,cover_image:s==null?void 0:s.cover_image,content_image:s==null?void 0:s.content_image,back_cover_image:s==null?void 0:s.back_cover_image},workspace:{width:$.width,height:$.height,scale:$.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(te).map(([E,_])=>[E,_]))},l=JSON.stringify(r),c=Math.round(l.length/1024),u=Math.round(c/1024*100)/100;let m=0,i=0;g.forEach(E=>{var _;(_=E.cells)==null||_.forEach(N=>{var I;(I=N.elements)==null||I.forEach(y=>{y.type==="image"&&y.content&&y.content.startsWith("data:image/")&&(m++,i+=y.content.length)})})});const p=Math.round(i/(1024*1024)*100)/100;if(c>1024&&!confirm(`El diseño contiene ${m} imágenes (${p} MB en imágenes). Payload completo: ${u} MB. Esto podría causar problemas al guardarlo. ¿Desea continuar de todos modos?`))return!1;const w=await fetch(`/api/canvas/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:l});if(!w.ok){let E="Error al finalizar el diseño";try{E=(await w.json()).message||E}catch{w.status===413?E="El diseño es demasiado grande para ser guardado. Intente simplificar las imágenes.":w.status>=500&&(E="Error del servidor. Intente nuevamente más tarde.")}throw new Error(E)}const C=await w.json();return!0}catch(t){console.error("Error al finalizar diseño:",t);let o=t.message;return t.message.includes("Failed to fetch")?o="Error de conexión. Verifique su conexión a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(o="Error de red. Intente nuevamente más tarde."),alert("Error al finalizar el diseño: "+o),!1}};const or=h.useCallback(async()=>{try{const{jsPDF:t}=await rr(async()=>{const{jsPDF:U}=await import("./jspdf.es.min-D3plwuQr.js").then(j=>j.j);return{jsPDF:U}},__vite__mapDeps([0,1,2,3,4]));let o=(s==null?void 0:s.width)||21,r=(s==null?void 0:s.height)||29.7;const l=.3,c=o+l*2,u=r+l*2,m=c*28.35,i=u*28.35,p=new t({orientation:m>i?"landscape":"portrait",unit:"pt",format:[m,i],compress:!1}),w=g.length;let C=0;const E=document.createElement("div");E.id="pdf-progress",E.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",E.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${w} páginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(E);const _=U=>{const j=U/w*100;document.getElementById("pdf-progress-bar").style.width=`${j}%`,document.getElementById("current-page").textContent=U},N=f;for(let U=0;U<g.length;U++){const j=g[U];re(U),await new Promise(V=>setTimeout(V,500));try{const V=await Pe({type:"pdf"});if(V){const fe=V.width/V.height,Ge=m/i;let Me,ye,Z=0,Ee=0;fe>Ge?(Me=m,ye=m/fe,Ee=(i-ye)/2):(ye=i,Me=i*fe,Z=(m-Me)/2);const be=V.toDataURL("image/png",1);U>0&&p.addPage([m,i]),p.addImage(be,"PNG",Z,Ee,Me,ye)}else console.warn(`⚠️ No se pudo capturar la página ${U+1}`),U>0&&p.addPage([m,i]),p.setFontSize(12),p.text(`Error al renderizar página ${U+1}`,m/2,i/2,{align:"center"})}catch(V){console.error(`❌ Error procesando página ${U+1}:`,V),U>0&&p.addPage([m,i]),p.setFontSize(12),p.text(`Error al procesar página ${U+1}`,m/2,i/2,{align:"center"})}C++,_(C),await new Promise(V=>setTimeout(V,200))}re(N);const I=`${(a==null?void 0:a.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;p.save(I),document.body.removeChild(E);const y=document.createElement("div");return y.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",y.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${I}</span>
                </div>
            `,document.body.appendChild(y),setTimeout(()=>{document.body.contains(y)&&document.body.removeChild(y)},5e3),I}catch(t){console.error("❌ Error generando PDF:",t);const o=document.getElementById("pdf-progress");o&&document.body.removeChild(o);const r=document.createElement("div");throw r.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",r.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(r),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},7e3),t}},[g,f,re,Pe,s,a]);return window.generateAlbumPDF=or,window.generateHighQualityThumbnail=Gn,window.captureCurrentWorkspace=Pe,window.regenerateCurrentThumbnailNow=()=>{var o;console.log("🚀 [REGENERACIÓN FORZADA] Regenerando miniatura de página actual...");const t=(o=g[f])==null?void 0:o.id;if(t){const r=g[f];let l=!1;r&&r.cells&&r.cells.forEach(c=>{c.elements&&c.elements.forEach(u=>{u.filters&&(u.filters.brightness!==100||u.filters.contrast!==100||u.filters.saturation!==100||u.filters.tint!==0||u.filters.hue!==0||u.filters.blur>0||u.filters.opacity!==100||u.filters.scale!==1||u.filters.rotate!==0||u.filters.flipHorizontal||u.filters.flipVertical)&&(l=!0,console.log(`🎨 [FILTRO DETECTADO] Elemento ${u.id} tiene filtros aplicados`),u._hasRealFilters=!0)})}),l&&(console.log("🎭 [FILTROS DETECTADOS] Activando modo de preservación de filtros"),window.PRESERVE_FILTERS_FOR_PAGE=t,window.FORCE_FILTER_APPLICATION=!0),ne(c=>{const u={...c};return delete u[t],u})}return setTimeout(()=>{console.log("⚡ [REGENERACIÓN] Iniciando generación con preservación de filtros"),ae(!0),console.log("✅ Regeneración forzada completada. La miniatura debería ser visible ahora."),setTimeout(()=>{console.log("🔄 [CLEANUP] Limpiando flags después de regeneración"),window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},100),"✅ Miniatura regenerada con éxito!"},window.generateThumbnailWithFilters=()=>{console.log("🎨 [FUNCIÓN GLOBAL] Regenerando miniatura con filtros garantizados"),window.FORCE_FILTER_APPLICATION=!0;const t=Date.now();return window._filterCacheBreaker=t,window.regenerateCurrentThumbnailNow(),setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1},1e3),"✅ Miniatura con filtros regenerada exitosamente"},window.forceRegenerateWithGuaranteedFilters=async()=>{var o,r,l,c,u;console.log("🔥 [RADICAL] Usando sistema de filtros garantizados");const t=g[f];if(!t||!$)return console.error("❌ [RADICAL] Datos no disponibles"),!1;try{window._filterVerificationDone&&window._filterVerificationDone.clear(),window._currentPageData=t,window._workspaceDimensions=$,window._updateThumbnailInUI=(i,p)=>{ne(w=>({...w,[i]:p}))},console.log("📦 [FUNCIÓN GLOBAL - DATOS] currentPageData antes de generar:",{pageId:t.id,elementsCount:((o=t.elements)==null?void 0:o.length)||0,elementsWithRealFilters:((l=(r=t.elements)==null?void 0:r.filter(i=>i.filters?i.filters.brightness!==void 0&&i.filters.brightness!==1||i.filters.contrast!==void 0&&i.filters.contrast!==1||i.filters.saturation!==void 0&&i.filters.saturation!==1||i.filters.tint!==void 0&&i.filters.tint!==0||i.filters.hue!==void 0&&i.filters.hue!==0||i.filters.opacity!==void 0&&i.filters.opacity!==1||i.filters.blur!==void 0&&i.filters.blur!==0||i.filters.scale!==void 0&&i.filters.scale!==1||i.filters.rotate!==void 0&&i.filters.rotate!==0||i.filters.flipHorizontal||i.filters.flipVertical:!1))==null?void 0:l.map(i=>({id:i.id,type:i.type,filtersDetailed:{brightness:i.filters.brightness+" (should be applied as: "+i.filters.brightness+")",contrast:i.filters.contrast+" (should be applied as: "+i.filters.contrast+")",saturation:i.filters.saturation+" (should be applied as: "+i.filters.saturation+")",tint:i.filters.tint+" (should be applied as: "+i.filters.tint+")",hue:i.filters.hue+" (should be applied as: "+i.filters.hue+")",opacity:i.filters.opacity+" (should be applied as: "+i.filters.opacity+")",blur:i.filters.blur+" (should be applied as: "+i.filters.blur+")",scale:i.filters.scale+" (should be applied as: "+i.filters.scale+")",rotate:i.filters.rotate+" (should be applied as: "+i.filters.rotate+")",flipHorizontal:i.filters.flipHorizontal,flipVertical:i.filters.flipVertical}})))||[]});const m=await Ut(t,$);return m?(((c=t.elements)==null?void 0:c.some(p=>p.filters?Object.keys(p.filters).some(w=>w==="flipHorizontal"||w==="flipVertical"?p.filters[w]:w==="brightness"||w==="contrast"||w==="saturation"||w==="opacity"||w==="scale"?p.filters[w]!==1:w==="tint"||w==="hue"||w==="blur"||w==="rotate"?p.filters[w]!==0:!1):!1))&&((u=window.protectThumbnail)==null||u.call(window,t.id),console.log(`🛡️ [GLOBAL PROTECTION] Thumbnail ${t.id} protegido en función global`)),ne(p=>(console.log(`🌍 [GLOBAL SET] Estableciendo thumbnail desde función global para ${t.id}`),{...p,[t.id]:m})),console.log("✅ [RADICAL] Thumbnail generado exitosamente"),!0):!1}catch(m){return console.error("❌ [RADICAL] Error:",m),!1}},window.safeRegenerateThumbnail=()=>(console.log("🛡️ [SAFE] Regeneración segura iniciada"),window._filterVerificationDone&&window._filterVerificationDone.clear(),ae(!0),"✅ Regeneración segura completada"),e.jsxs(ar,{backend:sr,className:"!h-screen !w-screen overflow-hidden",children:[A?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu álbum personalizado..."})]})}):M?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:M}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):g.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando páginas del álbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx("style",{children:`
                        /* Solo aplicar overflow visible en modo edición (no en preview ni captura) */
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] {
                            overflow: visible !important;
                        }
                        
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] > div {
                            overflow: visible !important;
                        }
                        
                        /* Mantener overflow hidden solo para el contenedor principal para evitar scroll */
                        .editor-workspace:not(.preview-mode) #page-${(yo=g[f])==null?void 0:yo.id} {
                            overflow: visible !important;
                        }
                        
                        /* En preview mode y captura, mantener overflow hidden para el resultado final */
                        .preview-mode [data-element-type="image"],
                        .capture-mode [data-element-type="image"] {
                            overflow: hidden !important;
                        }
                    `}),e.jsx(hr,{isOpen:Vn,onRequestClose:()=>{ro(!1),qn({isLoading:!1,loadedImages:0,totalImages:0,message:""}),ve({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:(()=>{if(!a){console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible, enviando todas las páginas");const r=le.cover.concat(le.content,le.final).map(l=>({...l,layout:ie.find(c=>c.id===l.layout)||ie[0]}));return po(r)}let t=[];(a.has_cover_image===!0||a.has_cover_image===1)&&(t=t.concat(le.cover)),t=t.concat(le.content),(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&(t=t.concat(le.final)),console.log("📤 [EDITOR-TO-MODAL] Enviando páginas filtradas:",{total:t.length,types:t.map(r=>r.type),itemConfig:{has_cover_image:a.has_cover_image,has_back_cover_image:a.has_back_cover_image}});const o=t.map(r=>({...r,layout:ie.find(l=>l.id===r.layout)||ie[0]}));return po(o)})(),pageThumbnails:(()=>{if(!a)return console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible para filtrar thumbnails"),te;const t={};let o=[];return(a.has_cover_image===!0||a.has_cover_image===1)&&(o=o.concat(le.cover.map(r=>r.id))),o=o.concat(le.content.map(r=>r.id)),(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&(o=o.concat(le.final.map(r=>r.id))),o.forEach(r=>{te[r]&&(t[r]=te[r])}),console.log("🖼️ [EDITOR-TO-MODAL] Enviando thumbnails filtrados:",{totalThumbnails:Object.keys(t).length,availableThumbnails:Object.keys(te).length,enabledPageIds:o,filteredThumbnailIds:Object.keys(t)}),t})(),workspaceDimensions:$,getCurrentLayout:t=>t?ie.find(o=>o.id===t.layout)||ie[0]:ie[0],presetData:s,addAlbumToCart:tr,projectData:n,itemData:a,contentType:ce,categorizedPages:le,albumLoadingState:Wn}),$e.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-$e.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:$e.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:$e.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${$e.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[$e.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(wr,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Zn,disabled:Ae<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(ir,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:er,disabled:Ae>=ke.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(lr,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(n==null?void 0:n.name)||"Álbum Sin Título",onChange:t=>d({...n,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del diseño"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(P.length>0||K)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:K?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",P.length]})]})}),e.jsx(ca,{saveStatus:Re.saveStatus,lastSaved:Re.lastSaved,lastAutoSaved:Re.lastAutoSaved,hasUnsavedChanges:S.hasUnsavedChanges||!!(O instanceof Map&&O.has(f)),isOnline:Re.isOnline,saveError:Re.saveError,onManualSave:lo,saveQueueSize:P.length,isProcessingQueue:K,pageChangesCount:O instanceof Map?O.size:0}),P.length>0&&e.jsxs("button",{onClick:()=>{console.log("🔧 [DEBUG] Procesando cola manualmente"),Ot()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(Tn,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(gt,{id:"preview-button",variant:"secondary",size:"sm",onClick:async t=>{t.preventDefault(),t.stopPropagation();try{console.log(`🎭 [${ce.type.toUpperCase()}-EXPERIENCE] Iniciando experiencia de ${ce.name.toLowerCase()}...`),console.log("💾 [AUTO-SAVE] Guardando cambios antes de abrir preview..."),ve({isOpen:!0,phase:"saving",progress:0,message:"💾 Guardando cambios",subMessage:"Asegurando que todo esté actualizado..."});try{await lo(),console.log("✅ [AUTO-SAVE] Guardado completado exitosamente"),ve(i=>({...i,progress:15,message:"✅ Cambios guardados",subMessage:"Preparando vista previa..."})),await new Promise(i=>setTimeout(i,500))}catch(i){console.error("❌ [AUTO-SAVE] Error al guardar:",i),ve(p=>({...p,progress:10,message:"⚠️ Guardado parcial",subMessage:"Continuando con vista previa..."})),await new Promise(p=>setTimeout(p,300))}ve(i=>({...i,phase:"preparing",progress:15,message:`${ce.icon} Creando tu ${ce.name.toLowerCase()}`,subMessage:ce.type==="album"?"Preparando la experiencia completa de tu álbum...":ce.type==="catalog"?"Organizando tu catálogo de contenido...":ce.type==="booklet"?"Preparando tu folleto personalizado...":"Optimizando tu diseño único..."}));const o=ce.type==="album"?["🔧 Encuadernando páginas","📖 Ajustando tapas","✨ Puliendo detalles"]:ce.type==="catalog"?["📑 Organizando contenido","🎨 Optimizando diseño","⚡ Finalizando catálogo"]:ce.type==="booklet"?["📋 Preparando folleto","🖼️ Ajustando formato","✨ Aplicando estilo"]:["🎨 Procesando diseño","⚡ Optimizando calidad","✨ Finalizando vista"];for(let i=15;i<=30;i+=3){await new Promise(w=>setTimeout(w,ce.type==="card"?50:100));const p=Math.floor((i-15)/15*o.length);ve(w=>({...w,progress:i,message:o[Math.min(p,o.length-1)],subMessage:`Progreso: ${i}% - Optimizando para mejor experiencia...`}))}ve(i=>({...i,phase:"processing",message:`📷 Procesando ${ce.name.toLowerCase()}`,subMessage:"Generando vistas de alta calidad..."}));const r=await zn((i,p)=>{const w=30+i/p*50;ve(C=>({...C,progress:Math.round(w),subMessage:`Procesando imagen ${i} de ${p}...`}))}),c={album:{message:"📖 Encuadernando álbum",sub:"Creando experiencia premium de lectura..."},catalog:{message:"📑 Organizando catálogo",sub:"Preparando navegación fluida..."},booklet:{message:"📋 Finalizando folleto",sub:"Ajustando formato profesional..."},card:{message:"🎨 Puliendo diseño",sub:"Aplicando toques finales..."}}[ce.type];ve(i=>({...i,phase:"finalizing",message:c.message,subMessage:c.sub}));for(let i=80;i<=100;i+=4)await new Promise(p=>setTimeout(p,ce.type==="card"?40:80)),ve(p=>({...p,progress:i}));const m={album:{message:"📖 ¡Tu álbum está listo!",sub:"Experiencia completa de lectura preparada"},catalog:{message:"📑 ¡Tu catálogo está listo!",sub:"Navegación profesional activada"},booklet:{message:"📋 ¡Tu folleto está listo!",sub:"Formato profesional completado"},card:{message:"🎨 ¡Tu diseño está listo!",sub:"Vista previa perfecta creada"}}[ce.type];ve(i=>({...i,phase:"ready",progress:100,message:m.message,subMessage:m.sub})),await new Promise(i=>setTimeout(i,1e3)),ve(i=>({...i,isOpen:!1})),ne(i=>({...i,...r})),setTimeout(()=>{ro(!0),console.log(`✅ [${ce.type.toUpperCase()}-EXPERIENCE] Experiencia de ${ce.name.toLowerCase()} completada`)},300)}catch(o){console.error(`❌ [${ce.type.toUpperCase()}-EXPERIENCE] Error en experiencia:`,o),ve(r=>({...r,message:"⚠️ Ups, algo salió mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{ve(r=>({...r,isOpen:!1}))},2e3)}},disabled:$e.isOpen,icon:e.jsx(bt,{className:"h-4 w-4"}),children:$e.isOpen?`Creando ${ce.name.toLowerCase()}...`:ce.description}),e.jsxs("button",{onClick:Bn,className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200",title:"Inicia la guía paso a paso",children:[e.jsx(Sr,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"})]})]})]})}),e.jsxs("div",{className:`flex h-full ${z?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>xe("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(bt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Páginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>xe("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Bt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Diseños"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>xe("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(vt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>xe("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(En,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[Y==="templates"&&"Templates",Y==="images"&&"Images",Y==="text"&&"Text",Y==="shapes"&&"Shapes",Y==="stickers"&&"Stickers",Y==="pages"&&"Pages",Y==="panel"&&"Layers Panel",Y==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Y==="templates"&&"Choose a template to get started",Y==="images"&&"Search for images",Y==="text"&&"Add and edit text",Y==="shapes"&&"Add shapes and graphics",Y==="stickers"&&"Add fun stickers",Y==="pages"&&"Manage your pages",Y==="panel"&&"Organize layers and z-index",Y==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(kr,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[Y==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Bt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Lr,{currentLayoutId:(Eo=g[f])==null?void 0:Eo.layout,onLayoutChange:Jn})]}),Y==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ve,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Imágenes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[Oe.length," imagen",Oe.length!==1?"s":""]})]}),e.jsx(ga,{images:Oe,onImageSelect:Qn,isLoading:Ct})]}),Y==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>_t("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"Título Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(xt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>_t("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subtítulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(xt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>_t("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(xt,{className:"h-4 w-4"})})]})})]}),Y==="text"&&z&&((Co=X())==null?void 0:Co.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(Ir,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=X();de(H,z,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((To=(No=X())==null?void 0:No.style)==null?void 0:To.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=X();de(H,z,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((So=(Ao=X())==null?void 0:Ao.style)==null?void 0:So.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=X();de(H,z,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((ko=(jo=X())==null?void 0:jo.style)==null?void 0:ko.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipografía:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Io=(Oo=X())==null?void 0:Oo.style)==null?void 0:Io.fontFamily)||"Arial",onChange:t=>{const o=X();de(H,z,{style:{...o.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tamaño:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Ro=(_o=X())==null?void 0:_o.style)==null?void 0:Ro.fontSize)||"16px",onChange:t=>{const o=X();de(H,z,{style:{...o.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Lo=(Po=X())==null?void 0:Po.style)==null?void 0:Lo.color)||"#000000",onChange:t=>{const o=X();de(H,z,{style:{...o.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((Uo=(Mo=X())==null?void 0:Mo.style)==null?void 0:Uo.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Bo=($o=X())==null?void 0:$o.style)==null?void 0:Bo.backgroundColor)||"#ffffff",onChange:t=>{const o=X();de(H,z,{style:{...o.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=X();de(H,z,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"🚫"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var o,r;return e.jsxs("button",{onClick:()=>{const l=X();de(H,z,{style:{...l.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((r=(o=X())==null?void 0:o.style)==null?void 0:r.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"⬅",t==="center"&&"⬌",t==="right"&&"➡",t==="justify"&&"⬍"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Fo=(zo=X())==null?void 0:zo.style)==null?void 0:Fo.lineHeight)||"1.5",onChange:t=>{const o=X();de(H,z,{style:{...o.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Ho=(Go=X())==null?void 0:Go.style)==null?void 0:Ho.letterSpacing)||"normal",onChange:t=>{const o=X();de(H,z,{style:{...o.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=X();de(H,z,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Do=(Vo=X())==null?void 0:Vo.style)==null?void 0:Do.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAYÚS"]}),e.jsxs("button",{onClick:()=>{const t=X();de(H,z,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((qo=(Wo=X())==null?void 0:Wo.style)==null?void 0:qo.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"minús"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((Qo=(Ko=X())==null?void 0:Ko.style)==null?void 0:Qo.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((Jo=(Yo=X())==null?void 0:Yo.style)==null?void 0:Jo.opacity)||"1",onChange:t=>{const o=X();de(H,z,{style:{...o.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((Zo=(Xo=X())==null?void 0:Xo.style)==null?void 0:Zo.opacity)||1)*100}%, #e5e7eb ${(((tn=(en=X())==null?void 0:en.style)==null?void 0:tn.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),Y==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[g.length," total"]})]})}),Ye&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Ye.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Ye.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Ye.message||`Página: ${Ye.pageId||"actual"}`})]}),g.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando páginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[le.cover.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),le.cover.map((t,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${f===g.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>It(g.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Gt,{pageId:t.id,thumbnail:te[t.id],altText:"Cover",type:"cover"}),O instanceof Map&&O.has&&O.has(g.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:le.content.map((t,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${f===g.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>It(g.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Gt,{pageId:t.id,thumbnail:te[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),O instanceof Map&&O.has&&O.has(g.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),le.final.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),le.final.map((t,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${f===g.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>It(g.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(Gt,{pageId:t.id,thumbnail:te[t.id],altText:"Back Cover",type:"final"}),O instanceof Map&&O.has&&O.has(g.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),Y==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Pr,{pages:g,currentPage:f,selectedCell:H,selectedElement:z,onSelectCell:pe,onSelectElement:J,onUpdateElement:(t,o,r)=>{de(t,o,r)},onDeleteElement:(t,o)=>{it(t,o)},onMoveElement:(t,o,r)=>{Xn(t,o,r)}})}),Y==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(yr,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=X();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ve,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Mr,{selectedMask:t.mask||"none",onSelect:o=>{de(H,z,{mask:o})},availableMasks:Cn.map(o=>o.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(cr,{filters:t.filters||{},onFilterChange:o=>{console.log("🔥 [FILTER-CHANGE-IMMEDIATE] APLICANDO FILTROS Y REGENERANDO AHORA!"),de(H,z,{filters:o}),setTimeout(()=>{console.log("🔥 [IMMEDIATE-REGEN] Intento 1 de regeneración..."),ae(!0)},50),setTimeout(()=>{console.log("🔥 [IMMEDIATE-REGEN] Intento 2 de regeneración..."),ae(!0)},200),setTimeout(()=>{console.log("🔥 [IMMEDIATE-REGEN] Intento 3 de regeneración..."),ae(!0)},500)},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(Ve,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:X()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>xe("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Bt,{className:"h-4 w-4"}),"Diseño de página"]}),e.jsxs("button",{onClick:()=>xe("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(vt,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(gt,{variant:"ghost",tooltip:"Añadir Imagen",onClick:()=>jt.current&&jt.current.click(),children:e.jsx(Ve,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:jt,onChange:Kn,className:"hidden",accept:"image/*"})]}),z&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(gt,{variant:"ghost",size:"sm",onClick:()=>{if(z&&H){const t=X();if(t){const o={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};et(H,o)}}},className:"h-8 px-2",icon:e.jsx(Er,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(gt,{variant:"ghost",size:"sm",onClick:()=>{z&&H&&it(H,z)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(Nn,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:`editor-workspace flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100 ${Dt?"preview-mode":""}`,children:Dt?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:$.width,height:$.height},children:e.jsx("div",{id:`page-${g[f].id}`,className:`grid ${Le().template} gap-6`,style:{width:"100%",height:"100%"},children:g[f].cells.map((t,o)=>{var c;const r=Le(),l=ua(r,o,$);return e.jsx(cn,{id:t.id,elements:t.elements.filter(u=>!u.locked),workspaceSize:l,cellStyle:(c=Le().cellStyles)==null?void 0:c[g[f].cells.indexOf(t)],selectedElement:H===t.id?z:null,onSelectElement:ho,onAddElement:(u,m)=>et(m,u),onUpdateElement:(u,m,i)=>de(t.id,u,m,i),onDeleteElement:u=>it(t.id,u),availableMasks:Le().maskCategories.flatMap(u=>u.masks),projectData:n},t.id)})})})}):e.jsxs("div",{id:`page-${g[f].id}`,className:" shadow-xl overflow-hidden",style:{width:$.width,height:$.height,position:"relative",backgroundColor:((on=g[f])==null?void 0:on.backgroundColor)||"#ffffff",backgroundImage:(nn=g[f])!=null&&nn.backgroundImage?`url(${g[f].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=g[f];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${Le().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((rn=Le().style)==null?void 0:rn.gap)||"16px",padding:((an=Le().style)==null?void 0:an.padding)||"16px"},children:g[f].cells.map(t=>{var o;return e.jsx(cn,{id:t.id,elements:t.elements.filter(r=>!r.locked),workspaceSize:$,cellStyle:(o=Le().cellStyles)==null?void 0:o[g[f].cells.indexOf(t)],selectedElement:H===t.id?z:null,onSelectElement:ho,onAddElement:(r,l)=>et(l,r),onUpdateElement:(r,l,c)=>de(t.id,r,l,c),onDeleteElement:r=>it(t.id,r),availableMasks:Le().maskCategories.flatMap(r=>r.masks),projectData:n},t.id)})})]})})]})]})]}),e.jsx(pr,{})]})}export{fs as default};
