const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-CPZgRw3w.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as hn}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as g,R as Kt}from"./index-BH53Isel.js";import{l as se,D as pn,H as fn,U as bn,R as xn,B as pt,F as vn}from"./FilterControls-DY5EJfOZ.js";import{h as po}from"./thumbnailGenerator-B4goYG9Y.js";import{d as wn,r as yn,a as fo,g as En,c as Cn}from"./dataUrlToBlobUrl-Dt_VdBHQ.js";import{L as Ct}from"./layers-6oegOx-p.js";import{C as Nn}from"./chevron-down-DS-mdh9v.js";import{C as Sn}from"./chevron-right-Ckt5D2ka.js";import{E as Tn}from"./eye-CKCH9ORv.js";import{c as Ie}from"./createLucideIcon-Cy5Ya80P.js";import{T as _o}from"./trash-2-DK1wnsDn.js";import{S as jn}from"./star-wPQTHY_n.js";import{T as Ao,i as Io,E as bo,u as kn}from"./EditorMain-iD8VdMfn.js";import{I as Ve}from"./image-BEA0kkBS.js";import"./EditorLayout-Chs2lmbc.js";import"./jspdf.es.min-CPZgRw3w.js";import{t as re,T as _n}from"./index-BZYhE2TF.js";import{m as xo}from"./main-6DCdASTx.js";import{B as An}from"./V1Edit-BmUcbimI.js";import{G as vo}from"./Global-D6eBBAMK.js";import{g as ft,a as wo,b as yo,c as Wt}from"./thumbnailGenerator-CDq815ue.js";import{S as Oo}from"./save-BvSyoVHO.js";import{C as In}from"./clock-BTrEpQej.js";import{T as On}from"./triangle-alert-vFMqKi4t.js";import{C as Pn}from"./check-DQ7QoS0v.js";import{L as Rn}from"./loader-circle-CrvBvIt1.js";import{C as Ln}from"./chevron-left-B2s3ZsB7.js";import{B as yt}from"./book-BuHIVa2d.js";import{P as Et}from"./plus-Bot15Khs.js";import{F as Mn}from"./filter-Ci9tsc_e.js";import{C as $n}from"./copy-6OEekgvq.js";import{C as Bn}from"./circle-check-big-D6DM3vPb.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./index-BSWw-p5k.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Un=Ie("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zn=Ie("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fn=Ie("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hn=Ie("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wn=Ie("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vn=Ie("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=Ie("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gn=Ie("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qn=Ie("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Eo=Ie("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kn=Ie("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Jn=({pages:r,currentPage:l,selectedCell:i,selectedElement:f,onSelectCell:a,onSelectElement:x,onUpdateElement:N,onDeleteElement:k,onMoveElement:E})=>{var D;if(!r||!r[l])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ct,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const w=r[l],_=((D=w==null?void 0:w.cells)==null?void 0:D.filter(R=>R.elements&&R.elements.length>0))||[],[B,C]=g.useState(()=>{const R={};return _.forEach(W=>{R[W.id]=!0}),R}),T=R=>{C(W=>({...W,[R]:!W[R]}))},A=R=>{switch(R){case"image":return e.jsx(Ve,{className:"h-4 w-4"});case"text":return e.jsx(Ao,{className:"h-4 w-4"});case"shape":return e.jsx(qn,{className:"h-4 w-4"});case"sticker":return e.jsx(jn,{className:"h-4 w-4"});default:return e.jsx(Hn,{className:"h-4 w-4"})}},H=(R,W)=>{switch(R.type){case"text":return R.content?R.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${W+1}`;case"shape":return R.shape||"Shape";case"sticker":return`Sticker ${W+1}`;default:return`Element ${W+1}`}},O=(R,W,te)=>{N(R,W,{visible:te})},K=(R,W)=>{a(R),x(W)};return e.jsx("div",{className:"space-y-2",children:_.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ct,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):_.map(R=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${i===R.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{T(R.id),a(R.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:B[R.id]?e.jsx(Nn,{className:"h-4 w-4"}):e.jsx(Sn,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",R.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[R.elements.length," element",R.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[R.x,", ",R.y]})]}),B[R.id]&&e.jsx("div",{className:"border-t border-gray-100",children:R.elements.map((W,te)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${f===W.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>K(R.id,W.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:A(W.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:H(W,te)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[W.type," • Layer ",te+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:J=>{J.stopPropagation(),O(R.id,W.id,!W.visible)},className:"p-1 hover:bg-gray-200 rounded",title:W.visible?"Hide element":"Show element",children:W.visible!==!1?e.jsx(Tn,{className:"h-3 w-3 text-gray-500"}):e.jsx(Vn,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:J=>{J.stopPropagation(),E(R.id,W.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:te===R.elements.length-1,children:e.jsx(zn,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:J=>{J.stopPropagation(),E(R.id,W.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:te===0,children:e.jsx(Un,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:J=>{J.stopPropagation(),k(R.id,W.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(_o,{className:"h-3 w-3"})})]})]},W.id))})]},R.id))})};function Dn({currentLayoutId:r,onLayoutChange:l}){const[i,f]=g.useState("all"),a={all:{name:"Todos",layouts:se},hero:{name:"Hero",layouts:se.filter(x=>x.category==="hero")},editorial:{name:"Editorial",layouts:se.filter(x=>x.category==="editorial")},storytelling:{name:"Historia",layouts:se.filter(x=>x.category==="storytelling")},minimal:{name:"Minimal",layouts:se.filter(x=>x.category==="minimal")},creative:{name:"Creativo",layouts:se.filter(x=>x.category==="creative")},classic:{name:"Clásico",layouts:se.filter(x=>x.category==="classic")}};return Object.keys(a).filter(x=>x==="all"||a[x].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:a[i].layouts.map(x=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>l(x.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${x.template}`,style:{gap:"4px",padding:"0px"},children:Array.from({length:x.cells}).map((N,k)=>{var E,w,_,B,C;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${((E=x.cellStyles)==null?void 0:E[k])||""}`,style:{minHeight:"8px",gridColumn:((_=(w=x.cellStyles)==null?void 0:w[k])!=null&&_.includes("col-span"),void 0),gridRow:((C=(B=x.cellStyles)==null?void 0:B[k])!=null&&C.includes("row-span"),void 0)}},k)})}),r===x.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:x.name}),x.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:x.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[x.cells," ",x.cells===1?"celda":"celdas"]})})]})]},x.id))}),a[i].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categoría."})})]})}const Qn=({selectedMask:r,onSelect:l,availableMasks:i=[],selectedImage:f})=>{var k,E;const[a,x]=g.useState("Básicas"),N={};return Io.forEach(w=>{N[w.category]||(N[w.category]=[]),(i.includes(w.id)||w.id==="none")&&N[w.category].push(w)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(N).slice(0,2).map(w=>N[w].length>0&&e.jsx("button",{onClick:()=>x(w),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${a===w?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:w},w))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(k=N[a])==null?void 0:k.slice(0,6).map(w=>e.jsxs("div",{onClick:()=>l(w.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${r===w.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:f!=null&&f.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:w.id==="circle"?"circle(50%)":w.id==="rounded"||w.id==="rounded-sm"?"inset(0 round 8%)":w.id==="rounded-lg"?"inset(0 round 16%)":w.id==="rounded-rect"?"inset(0 round 12%)":w.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":w.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":w.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":w.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":w.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":w.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":w.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":w.id==="frame"?"inset(10% round 10%)":w.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':w.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':w.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:f.content,alt:w.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:w.id==="circle"?"circle(50%)":w.id==="rounded"||w.id==="rounded-sm"?"inset(0 round 8%)":w.id==="rounded-lg"?"inset(0 round 16%)":w.id==="rounded-rect"?"inset(0 round 12%)":w.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":w.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":w.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":w.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":w.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":w.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":w.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":w.id==="frame"?"inset(10% round 10%)":w.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':w.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':w.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:w.name})]},w.id))}),((E=N[a])==null?void 0:E.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver más máscaras (",N[a].length-6," más)"]})]})};let Jt={},Po;function Gt(r={}){Jt={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...r}}function U(r){return r?Jt[r]:Jt}function Yn(r){Po=r}function Ne(){return Po}let Nt={};function bt(r,l){Nt[r]=l}function Ge(r){var l;(l=Nt[r])==null||l.call(Nt)}function Xn(){Nt={}}function xt(r,l,i,f){return(r/=f/2)<1?i/2*r*r+l:-i/2*(--r*(r-2)-1)+l}function Ro(r){const l='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return r.flatMap(i=>{const f=i.matches(l),a=Array.from(i.querySelectorAll(l));return[...f?[i]:[],...a]}).filter(i=>getComputedStyle(i).pointerEvents!=="none"&&ta(i))}function Lo(r){if(!r||ea(r))return;const l=U("smoothScroll"),i=r.offsetHeight>window.innerHeight;r.scrollIntoView({behavior:!l||Zn(r)?"auto":"smooth",inline:"center",block:i?"start":"center"})}function Zn(r){if(!r||!r.parentElement)return;const l=r.parentElement;return l.scrollHeight>l.clientHeight}function ea(r){const l=r.getBoundingClientRect();return l.top>=0&&l.left>=0&&l.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&l.right<=(window.innerWidth||document.documentElement.clientWidth)}function ta(r){return!!(r.offsetWidth||r.offsetHeight||r.getClientRects().length)}let St={};function he(r,l){St[r]=l}function V(r){return r?St[r]:St}function Co(){St={}}function ra(r,l,i,f){let a=V("__activeStagePosition");const x=a||i.getBoundingClientRect(),N=f.getBoundingClientRect(),k=xt(r,x.x,N.x-x.x,l),E=xt(r,x.y,N.y-x.y,l),w=xt(r,x.width,N.width-x.width,l),_=xt(r,x.height,N.height-x.height,l);a={x:k,y:E,width:w,height:_},$o(a),he("__activeStagePosition",a)}function Mo(r){if(!r)return;const l=r.getBoundingClientRect(),i={x:l.x,y:l.y,width:l.width,height:l.height};he("__activeStagePosition",i),$o(i)}function oa(){const r=V("__activeStagePosition"),l=V("__overlaySvg");if(!r)return;if(!l){console.warn("No stage svg found.");return}const i=window.innerWidth,f=window.innerHeight;l.setAttribute("viewBox",`0 0 ${i} ${f}`)}function na(r){const l=aa(r);document.body.appendChild(l),zo(l,i=>{i.target.tagName==="path"&&Ge("overlayClick")}),he("__overlaySvg",l)}function $o(r){const l=V("__overlaySvg");if(!l){na(r);return}const i=l.firstElementChild;if((i==null?void 0:i.tagName)!=="path")throw new Error("no path element found in stage svg");i.setAttribute("d",Bo(r))}function aa(r){const l=window.innerWidth,i=window.innerHeight,f=document.createElementNS("http://www.w3.org/2000/svg","svg");f.classList.add("driver-overlay","driver-overlay-animated"),f.setAttribute("viewBox",`0 0 ${l} ${i}`),f.setAttribute("xmlSpace","preserve"),f.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),f.setAttribute("version","1.1"),f.setAttribute("preserveAspectRatio","xMinYMin slice"),f.style.fillRule="evenodd",f.style.clipRule="evenodd",f.style.strokeLinejoin="round",f.style.strokeMiterlimit="2",f.style.zIndex="10000",f.style.position="fixed",f.style.top="0",f.style.left="0",f.style.width="100%",f.style.height="100%";const a=document.createElementNS("http://www.w3.org/2000/svg","path");return a.setAttribute("d",Bo(r)),a.style.fill=U("overlayColor")||"rgb(0,0,0)",a.style.opacity=`${U("overlayOpacity")}`,a.style.pointerEvents="auto",a.style.cursor="auto",f.appendChild(a),f}function Bo(r){const l=window.innerWidth,i=window.innerHeight,f=U("stagePadding")||0,a=U("stageRadius")||0,x=r.width+f*2,N=r.height+f*2,k=Math.min(a,x/2,N/2),E=Math.floor(Math.max(k,0)),w=r.x-f+E,_=r.y-f,B=x-E*2,C=N-E*2;return`M${l},0L0,0L0,${i}L${l},${i}L${l},0Z
    M${w},${_} h${B} a${E},${E} 0 0 1 ${E},${E} v${C} a${E},${E} 0 0 1 -${E},${E} h-${B} a${E},${E} 0 0 1 -${E},-${E} v-${C} a${E},${E} 0 0 1 ${E},-${E} z`}function sa(){const r=V("__overlaySvg");r&&r.remove()}function ia(){const r=document.getElementById("driver-dummy-element");if(r)return r;let l=document.createElement("div");return l.id="driver-dummy-element",l.style.width="0",l.style.height="0",l.style.pointerEvents="none",l.style.opacity="0",l.style.position="fixed",l.style.top="50%",l.style.left="50%",document.body.appendChild(l),l}function No(r){const{element:l}=r;let i=typeof l=="function"?l():typeof l=="string"?document.querySelector(l):l;i||(i=ia()),ca(i,r)}function la(){const r=V("__activeElement"),l=V("__activeStep");r&&(Mo(r),oa(),Ho(r,l))}function ca(r,l){var i;const f=Date.now(),a=V("__activeStep"),x=V("__activeElement")||r,N=!x||x===r,k=r.id==="driver-dummy-element",E=x.id==="driver-dummy-element",w=U("animate"),_=l.onHighlightStarted||U("onHighlightStarted"),B=(l==null?void 0:l.onHighlighted)||U("onHighlighted"),C=(a==null?void 0:a.onDeselected)||U("onDeselected"),T=U(),A=V();!N&&C&&C(E?void 0:x,a,{config:T,state:A,driver:Ne()}),_&&_(k?void 0:r,l,{config:T,state:A,driver:Ne()});const H=!N&&w;let O=!1;ha(),he("previousStep",a),he("previousElement",x),he("activeStep",l),he("activeElement",r);const K=()=>{if(V("__transitionCallback")!==K)return;const D=Date.now()-f,R=400-D<=400/2;l.popover&&R&&!O&&H&&(So(r,l),O=!0),U("animate")&&D<400?ra(D,400,x,r):(Mo(r),B&&B(k?void 0:r,l,{config:U(),state:V(),driver:Ne()}),he("__transitionCallback",void 0),he("__previousStep",a),he("__previousElement",x),he("__activeStep",l),he("__activeElement",r)),window.requestAnimationFrame(K)};he("__transitionCallback",K),window.requestAnimationFrame(K),Lo(r),!H&&l.popover&&So(r,l),x.classList.remove("driver-active-element","driver-no-interaction"),x.removeAttribute("aria-haspopup"),x.removeAttribute("aria-expanded"),x.removeAttribute("aria-controls"),((i=l.disableActiveInteraction)!=null?i:U("disableActiveInteraction"))&&r.classList.add("driver-no-interaction"),r.classList.add("driver-active-element"),r.setAttribute("aria-haspopup","dialog"),r.setAttribute("aria-expanded","true"),r.setAttribute("aria-controls","driver-popover-content")}function da(){var r;(r=document.getElementById("driver-dummy-element"))==null||r.remove(),document.querySelectorAll(".driver-active-element").forEach(l=>{l.classList.remove("driver-active-element","driver-no-interaction"),l.removeAttribute("aria-haspopup"),l.removeAttribute("aria-expanded"),l.removeAttribute("aria-controls")})}function st(){const r=V("__resizeTimeout");r&&window.cancelAnimationFrame(r),he("__resizeTimeout",window.requestAnimationFrame(la))}function ua(r){var l;if(!V("isInitialized")||!(r.key==="Tab"||r.keyCode===9))return;const i=V("__activeElement"),f=(l=V("popover"))==null?void 0:l.wrapper,a=Ro([...f?[f]:[],...i?[i]:[]]),x=a[0],N=a[a.length-1];if(r.preventDefault(),r.shiftKey){const k=a[a.indexOf(document.activeElement)-1]||N;k==null||k.focus()}else{const k=a[a.indexOf(document.activeElement)+1]||x;k==null||k.focus()}}function Uo(r){var l;((l=U("allowKeyboardControl"))==null||l)&&(r.key==="Escape"?Ge("escapePress"):r.key==="ArrowRight"?Ge("arrowRightPress"):r.key==="ArrowLeft"&&Ge("arrowLeftPress"))}function zo(r,l,i){const f=(a,x)=>{const N=a.target;r.contains(N)&&((!i||i(N))&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation()),x==null||x(a))};document.addEventListener("pointerdown",f,!0),document.addEventListener("mousedown",f,!0),document.addEventListener("pointerup",f,!0),document.addEventListener("mouseup",f,!0),document.addEventListener("click",a=>{f(a,l)},!0)}function ma(){window.addEventListener("keyup",Uo,!1),window.addEventListener("keydown",ua,!1),window.addEventListener("resize",st),window.addEventListener("scroll",st)}function ga(){window.removeEventListener("keyup",Uo),window.removeEventListener("resize",st),window.removeEventListener("scroll",st)}function ha(){const r=V("popover");r&&(r.wrapper.style.display="none")}function So(r,l){var i,f;let a=V("popover");a&&document.body.removeChild(a.wrapper),a=fa(),document.body.appendChild(a.wrapper);const{title:x,description:N,showButtons:k,disableButtons:E,showProgress:w,nextBtnText:_=U("nextBtnText")||"Next &rarr;",prevBtnText:B=U("prevBtnText")||"&larr; Previous",progressText:C=U("progressText")||"{current} of {total}"}=l.popover||{};a.nextButton.innerHTML=_,a.previousButton.innerHTML=B,a.progress.innerHTML=C,x?(a.title.innerHTML=x,a.title.style.display="block"):a.title.style.display="none",N?(a.description.innerHTML=N,a.description.style.display="block"):a.description.style.display="none";const T=k||U("showButtons"),A=w||U("showProgress")||!1,H=(T==null?void 0:T.includes("next"))||(T==null?void 0:T.includes("previous"))||A;a.closeButton.style.display=T.includes("close")?"block":"none",H?(a.footer.style.display="flex",a.progress.style.display=A?"block":"none",a.nextButton.style.display=T.includes("next")?"block":"none",a.previousButton.style.display=T.includes("previous")?"block":"none"):a.footer.style.display="none";const O=E||U("disableButtons")||[];O!=null&&O.includes("next")&&(a.nextButton.disabled=!0,a.nextButton.classList.add("driver-popover-btn-disabled")),O!=null&&O.includes("previous")&&(a.previousButton.disabled=!0,a.previousButton.classList.add("driver-popover-btn-disabled")),O!=null&&O.includes("close")&&(a.closeButton.disabled=!0,a.closeButton.classList.add("driver-popover-btn-disabled"));const K=a.wrapper;K.style.display="block",K.style.left="",K.style.top="",K.style.bottom="",K.style.right="",K.id="driver-popover-content",K.setAttribute("role","dialog"),K.setAttribute("aria-labelledby","driver-popover-title"),K.setAttribute("aria-describedby","driver-popover-description");const D=a.arrow;D.className="driver-popover-arrow";const R=((i=l.popover)==null?void 0:i.popoverClass)||U("popoverClass")||"";K.className=`driver-popover ${R}`.trim(),zo(a.wrapper,me=>{var Se,Be,u;const le=me.target,b=((Se=l.popover)==null?void 0:Se.onNextClick)||U("onNextClick"),ie=((Be=l.popover)==null?void 0:Be.onPrevClick)||U("onPrevClick"),de=((u=l.popover)==null?void 0:u.onCloseClick)||U("onCloseClick");if(le.closest(".driver-popover-next-btn"))return b?b(r,l,{config:U(),state:V(),driver:Ne()}):Ge("nextClick");if(le.closest(".driver-popover-prev-btn"))return ie?ie(r,l,{config:U(),state:V(),driver:Ne()}):Ge("prevClick");if(le.closest(".driver-popover-close-btn"))return de?de(r,l,{config:U(),state:V(),driver:Ne()}):Ge("closeClick")},me=>!(a!=null&&a.description.contains(me))&&!(a!=null&&a.title.contains(me))&&typeof me.className=="string"&&me.className.includes("driver-popover")),he("popover",a);const W=((f=l.popover)==null?void 0:f.onPopoverRender)||U("onPopoverRender");W&&W(a,{config:U(),state:V(),driver:Ne()}),Ho(r,l),Lo(K);const te=r.classList.contains("driver-dummy-element"),J=Ro([K,...te?[]:[r]]);J.length>0&&J[0].focus()}function Fo(){const r=V("popover");if(!(r!=null&&r.wrapper))return;const l=r.wrapper.getBoundingClientRect(),i=U("stagePadding")||0,f=U("popoverOffset")||0;return{width:l.width+i+f,height:l.height+i+f,realWidth:l.width,realHeight:l.height}}function To(r,l){const{elementDimensions:i,popoverDimensions:f,popoverPadding:a,popoverArrowDimensions:x}=l;return r==="start"?Math.max(Math.min(i.top-a,window.innerHeight-f.realHeight-x.width),x.width):r==="end"?Math.max(Math.min(i.top-(f==null?void 0:f.realHeight)+i.height+a,window.innerHeight-(f==null?void 0:f.realHeight)-x.width),x.width):r==="center"?Math.max(Math.min(i.top+i.height/2-(f==null?void 0:f.realHeight)/2,window.innerHeight-(f==null?void 0:f.realHeight)-x.width),x.width):0}function jo(r,l){const{elementDimensions:i,popoverDimensions:f,popoverPadding:a,popoverArrowDimensions:x}=l;return r==="start"?Math.max(Math.min(i.left-a,window.innerWidth-f.realWidth-x.width),x.width):r==="end"?Math.max(Math.min(i.left-(f==null?void 0:f.realWidth)+i.width+a,window.innerWidth-(f==null?void 0:f.realWidth)-x.width),x.width):r==="center"?Math.max(Math.min(i.left+i.width/2-(f==null?void 0:f.realWidth)/2,window.innerWidth-(f==null?void 0:f.realWidth)-x.width),x.width):0}function Ho(r,l){const i=V("popover");if(!i)return;const{align:f="start",side:a="left"}=(l==null?void 0:l.popover)||{},x=f,N=r.id==="driver-dummy-element"?"over":a,k=U("stagePadding")||0,E=Fo(),w=i.arrow.getBoundingClientRect(),_=r.getBoundingClientRect(),B=_.top-E.height;let C=B>=0;const T=window.innerHeight-(_.bottom+E.height);let A=T>=0;const H=_.left-E.width;let O=H>=0;const K=window.innerWidth-(_.right+E.width);let D=K>=0;const R=!C&&!A&&!O&&!D;let W=N;if(N==="top"&&C?D=O=A=!1:N==="bottom"&&A?D=O=C=!1:N==="left"&&O?D=C=A=!1:N==="right"&&D&&(O=C=A=!1),N==="over"){const te=window.innerWidth/2-E.realWidth/2,J=window.innerHeight/2-E.realHeight/2;i.wrapper.style.left=`${te}px`,i.wrapper.style.right="auto",i.wrapper.style.top=`${J}px`,i.wrapper.style.bottom="auto"}else if(R){const te=window.innerWidth/2-(E==null?void 0:E.realWidth)/2,J=10;i.wrapper.style.left=`${te}px`,i.wrapper.style.right="auto",i.wrapper.style.bottom=`${J}px`,i.wrapper.style.top="auto"}else if(O){const te=Math.min(H,window.innerWidth-(E==null?void 0:E.realWidth)-w.width),J=To(x,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});i.wrapper.style.left=`${te}px`,i.wrapper.style.top=`${J}px`,i.wrapper.style.bottom="auto",i.wrapper.style.right="auto",W="left"}else if(D){const te=Math.min(K,window.innerWidth-(E==null?void 0:E.realWidth)-w.width),J=To(x,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});i.wrapper.style.right=`${te}px`,i.wrapper.style.top=`${J}px`,i.wrapper.style.bottom="auto",i.wrapper.style.left="auto",W="right"}else if(C){const te=Math.min(B,window.innerHeight-E.realHeight-w.width);let J=jo(x,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});i.wrapper.style.top=`${te}px`,i.wrapper.style.left=`${J}px`,i.wrapper.style.bottom="auto",i.wrapper.style.right="auto",W="top"}else if(A){const te=Math.min(T,window.innerHeight-(E==null?void 0:E.realHeight)-w.width);let J=jo(x,{elementDimensions:_,popoverDimensions:E,popoverPadding:k,popoverArrowDimensions:w});i.wrapper.style.left=`${J}px`,i.wrapper.style.bottom=`${te}px`,i.wrapper.style.top="auto",i.wrapper.style.right="auto",W="bottom"}R?i.arrow.classList.add("driver-popover-arrow-none"):pa(x,W,r)}function pa(r,l,i){const f=V("popover");if(!f)return;const a=i.getBoundingClientRect(),x=Fo(),N=f.arrow,k=x.width,E=window.innerWidth,w=a.width,_=a.left,B=x.height,C=window.innerHeight,T=a.top,A=a.height;N.className="driver-popover-arrow";let H=l,O=r;if(l==="top"?(_+w<=0?(H="right",O="end"):_+w-k<=0&&(H="top",O="start"),_>=E?(H="left",O="end"):_+k>=E&&(H="top",O="end")):l==="bottom"?(_+w<=0?(H="right",O="start"):_+w-k<=0&&(H="bottom",O="start"),_>=E?(H="left",O="start"):_+k>=E&&(H="bottom",O="end")):l==="left"?(T+A<=0?(H="bottom",O="end"):T+A-B<=0&&(H="left",O="start"),T>=C?(H="top",O="end"):T+B>=C&&(H="left",O="end")):l==="right"&&(T+A<=0?(H="bottom",O="start"):T+A-B<=0&&(H="right",O="start"),T>=C?(H="top",O="start"):T+B>=C&&(H="right",O="end")),!H)N.classList.add("driver-popover-arrow-none");else{N.classList.add(`driver-popover-arrow-side-${H}`),N.classList.add(`driver-popover-arrow-align-${O}`);const K=i.getBoundingClientRect(),D=N.getBoundingClientRect(),R=U("stagePadding")||0,W=K.left-R<window.innerWidth&&K.right+R>0&&K.top-R<window.innerHeight&&K.bottom+R>0;l==="bottom"&&W&&(D.x>K.x&&D.x+D.width<K.x+K.width?f.wrapper.style.transform="translateY(0)":(N.classList.remove(`driver-popover-arrow-align-${O}`),N.classList.add("driver-popover-arrow-none"),f.wrapper.style.transform=`translateY(-${R/2}px)`))}}function fa(){const r=document.createElement("div");r.classList.add("driver-popover");const l=document.createElement("div");l.classList.add("driver-popover-arrow");const i=document.createElement("header");i.id="driver-popover-title",i.classList.add("driver-popover-title"),i.style.display="none",i.innerText="Popover Title";const f=document.createElement("div");f.id="driver-popover-description",f.classList.add("driver-popover-description"),f.style.display="none",f.innerText="Popover description is here";const a=document.createElement("button");a.type="button",a.classList.add("driver-popover-close-btn"),a.setAttribute("aria-label","Close"),a.innerHTML="&times;";const x=document.createElement("footer");x.classList.add("driver-popover-footer");const N=document.createElement("span");N.classList.add("driver-popover-progress-text"),N.innerText="";const k=document.createElement("span");k.classList.add("driver-popover-navigation-btns");const E=document.createElement("button");E.type="button",E.classList.add("driver-popover-prev-btn"),E.innerHTML="&larr; Previous";const w=document.createElement("button");return w.type="button",w.classList.add("driver-popover-next-btn"),w.innerHTML="Next &rarr;",k.appendChild(E),k.appendChild(w),x.appendChild(N),x.appendChild(k),r.appendChild(a),r.appendChild(l),r.appendChild(i),r.appendChild(f),r.appendChild(x),{wrapper:r,arrow:l,title:i,description:f,footer:x,previousButton:E,nextButton:w,closeButton:a,footerButtons:k,progress:N}}function ba(){var r;const l=V("popover");l&&((r=l.wrapper.parentElement)==null||r.removeChild(l.wrapper))}function xa(r={}){Gt(r);function l(){U("allowClose")&&_()}function i(){const C=U("overlayClickBehavior");if(U("allowClose")&&C==="close"){_();return}C==="nextStep"&&f()}function f(){const C=V("activeIndex"),T=U("steps")||[];if(typeof C>"u")return;const A=C+1;T[A]?w(A):_()}function a(){const C=V("activeIndex"),T=U("steps")||[];if(typeof C>"u")return;const A=C-1;T[A]?w(A):_()}function x(C){(U("steps")||[])[C]?w(C):_()}function N(){var C;if(V("__transitionCallback"))return;const T=V("activeIndex"),A=V("__activeStep"),H=V("__activeElement");if(typeof T>"u"||typeof A>"u"||typeof V("activeIndex")>"u")return;const O=((C=A.popover)==null?void 0:C.onPrevClick)||U("onPrevClick");if(O)return O(H,A,{config:U(),state:V(),driver:Ne()});a()}function k(){var C;if(V("__transitionCallback"))return;const T=V("activeIndex"),A=V("__activeStep"),H=V("__activeElement");if(typeof T>"u"||typeof A>"u")return;const O=((C=A.popover)==null?void 0:C.onNextClick)||U("onNextClick");if(O)return O(H,A,{config:U(),state:V(),driver:Ne()});f()}function E(){V("isInitialized")||(he("isInitialized",!0),document.body.classList.add("driver-active",U("animate")?"driver-fade":"driver-simple"),ma(),bt("overlayClick",i),bt("escapePress",l),bt("arrowLeftPress",N),bt("arrowRightPress",k))}function w(C=0){var T,A,H,O,K,D,R,W;const te=U("steps");if(!te){console.error("No steps to drive through"),_();return}if(!te[C]){_();return}he("__activeOnDestroyed",document.activeElement),he("activeIndex",C);const J=te[C],me=te[C+1],Se=te[C-1],Be=((T=J.popover)==null?void 0:T.doneBtnText)||U("doneBtnText")||"Done",u=U("allowClose"),le=typeof((A=J.popover)==null?void 0:A.showProgress)<"u"?(H=J.popover)==null?void 0:H.showProgress:U("showProgress"),b=(((O=J.popover)==null?void 0:O.progressText)||U("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${C+1}`).replace("{{total}}",`${te.length}`),ie=((K=J.popover)==null?void 0:K.showButtons)||U("showButtons"),de=["next","previous",...u?["close"]:[]].filter(G=>!(ie!=null&&ie.length)||ie.includes(G)),qe=((D=J.popover)==null?void 0:D.onNextClick)||U("onNextClick"),z=((R=J.popover)==null?void 0:R.onPrevClick)||U("onPrevClick"),X=((W=J.popover)==null?void 0:W.onCloseClick)||U("onCloseClick");No({...J,popover:{showButtons:de,nextBtnText:me?void 0:Be,disableButtons:[...Se?[]:["previous"]],showProgress:le,progressText:b,onNextClick:qe||(()=>{me?w(C+1):_()}),onPrevClick:z||(()=>{w(C-1)}),onCloseClick:X||(()=>{_()}),...(J==null?void 0:J.popover)||{}}})}function _(C=!0){const T=V("__activeElement"),A=V("__activeStep"),H=V("__activeOnDestroyed"),O=U("onDestroyStarted");if(C&&O){const R=!T||(T==null?void 0:T.id)==="driver-dummy-element";O(R?void 0:T,A,{config:U(),state:V(),driver:Ne()});return}const K=(A==null?void 0:A.onDeselected)||U("onDeselected"),D=U("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),ga(),ba(),da(),sa(),Xn(),Co(),T&&A){const R=T.id==="driver-dummy-element";K&&K(R?void 0:T,A,{config:U(),state:V(),driver:Ne()}),D&&D(R?void 0:T,A,{config:U(),state:V(),driver:Ne()})}H&&H.focus()}const B={isActive:()=>V("isInitialized")||!1,refresh:st,drive:(C=0)=>{E(),w(C)},setConfig:Gt,setSteps:C=>{Co(),Gt({...U(),steps:C})},getConfig:U,getState:V,getActiveIndex:()=>V("activeIndex"),isFirstStep:()=>V("activeIndex")===0,isLastStep:()=>{const C=U("steps")||[],T=V("activeIndex");return T!==void 0&&T===C.length-1},getActiveStep:()=>V("activeStep"),getActiveElement:()=>V("activeElement"),getPreviousElement:()=>V("previousElement"),getPreviousStep:()=>V("previousStep"),moveNext:f,movePrevious:a,moveTo:x,hasNextStep:()=>{const C=U("steps")||[],T=V("activeIndex");return T!==void 0&&!!C[T+1]},hasPreviousStep:()=>{const C=U("steps")||[],T=V("activeIndex");return T!==void 0&&!!C[T-1]},highlight:C=>{E(),No({...C,popover:C.popover?{showButtons:[],showProgress:!1,progressText:"",...C.popover}:void 0})},destroy:()=>{_(!1)}};return Yn(B),B}const va=async(r,l,i)=>{var f;try{console.log("📤 [SAVE] Subiendo imagen al backend:",l);const[a,x]=r.split(","),N=((f=a.match(/data:image\/(\w+)/))==null?void 0:f[1])||"png",k=new FormData,E=atob(x),w=new Array(E.length);for(let A=0;A<E.length;A++)w[A]=E.charCodeAt(A);const _=new Uint8Array(w),B=new Blob([_],{type:`image/${N}`});k.append("image",B,`element_${l}.${N}`),k.append("project_id",i),k.append("element_id",l);const C=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:k});if(!C.ok)throw new Error("Error al subir imagen al servidor");const T=await C.json();return console.log("✅ [SAVE] Imagen subida exitosamente:",T.url),T.url}catch(a){throw console.error("❌ [SAVE] Error subiendo imagen:",a),a}},wa=async(r,l)=>{var x,N;console.log("🔄 [SAVE] Procesando imágenes para guardado...");const i=[];let f=0,a=0;for(const k of r)for(const E of k.cells||[])for(const w of E.elements||[])w.type==="image"&&((x=w.content)!=null&&x.startsWith("data:image/"))&&f++;console.log(`📊 [SAVE] Total de imágenes base64 a procesar: ${f}`);for(const k of r){const E={...k};E.cells=[];for(const w of k.cells||[]){const _={...w};_.elements=[];for(const B of w.elements||[]){const C={...B};if(B.type==="image"&&((N=B.content)!=null&&N.startsWith("data:image/")))try{const T=await va(B.content,B.id,l);C.content=T,C.isUploaded=!0,a++,console.log(`✅ [SAVE] Imagen ${a}/${f} procesada`)}catch(T){console.error("❌ [SAVE] Error procesando imagen:",B.id,T),C.uploadError=T.message}_.elements.push(C)}E.cells.push(_)}i.push(E)}return console.log(`✅ [SAVE] Procesamiento completado: ${a}/${f} imágenes subidas`),i},ya=async(r,l)=>{var i;try{console.log("🔍 [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:r,thumbnailsCount:Object.keys(l).length});const f=[];for(const[N,k]of Object.entries(l))console.log(`🔍 [DEBUG] Procesando thumbnail para página ${N}:`,{hasData:!!k,isBase64:k&&k.startsWith("data:image/"),dataLength:k?k.length:0}),k&&k.startsWith("data:image/")&&f.push({page_id:N,thumbnail_data:k});if(f.length===0){console.log("ℹ️ [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`🖼️ [THUMBNAILS] Guardando ${f.length} thumbnails como archivos...`),console.log(`🔍 [DEBUG] URL del endpoint: /api/thumbnails/${r}/save-as-files`);const a=await fetch(`/api/thumbnails/${r}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.content)||""},credentials:"include",body:JSON.stringify({thumbnails:f})});if(console.log("🔍 [DEBUG] Respuesta del servidor:",{status:a.status,statusText:a.statusText,ok:a.ok}),!a.ok){const N=await a.text();throw console.error("❌ [THUMBNAILS] Error respuesta del servidor:",N),new Error(`Error al guardar thumbnails: ${a.status} ${a.statusText}`)}const x=await a.json();return console.log("✅ [THUMBNAILS] Thumbnails guardados como archivos:",x),x}catch(f){throw console.error("❌ [THUMBNAILS] Error guardando thumbnails:",f),f}},ko=async(r,l,i,f,a,x,N=!1)=>{try{if(!(l!=null&&l.id))throw new Error("No se encontró el ID del proyecto");console.log(`💾 [SAVE] Iniciando ${N?"auto-guardado":"guardado manual"}...`);let k=r;N||(k=await wa(r,l.id));const E={pages:k,projectInfo:{id:l.id,item_id:i==null?void 0:i.id,title:i==null?void 0:i.title,preset_id:f==null?void 0:f.id},workspace:{width:a.width,height:a.height,scale:a.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:N,totalPages:r.length}},w=N?"save-progress":"save",_=await fetch(`/api/canvas/projects/${l.id}/${w}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:E,thumbnails:x})});if(!_.ok){const C=await _.json().catch(()=>({}));throw new Error(C.message||"Error al guardar el proyecto")}const B=await _.json();if(console.log(`✅ [SAVE] ${N?"Auto-guardado":"Guardado"} exitoso:`,B),!N&&x&&Object.keys(x).length>0){console.log("🖼️ [SAVE] Guardando thumbnails como archivos...");try{await ya(l.id,x),console.log("✅ [SAVE] Thumbnails guardados como archivos")}catch(C){console.warn("⚠️ [SAVE] Error guardando thumbnails como archivos:",C)}}return{success:!0,data:B}}catch(k){return console.error(`❌ [SAVE] Error en ${N?"auto-guardado":"guardado"}:`,k),{success:!1,error:k.message}}},Ea=(r,l,i,f,a,x)=>{const[N,k]=g.useState("saved"),[E,w]=g.useState(null),[_,B]=g.useState(null),[C,T]=g.useState(null),[A,H]=g.useState(!1),[O,K]=g.useState(navigator.onLine),D=g.useRef(null),R=g.useRef(null),W=g.useRef(null),te=g.useRef(!1),J=g.useRef(null),me=15e3,Se=2e3,Be=5e3,u=g.useCallback((z,X)=>{try{const G={pages:z.map(pe=>{var Y;return{id:pe.id,layout:pe.layout,cells:((Y=pe.cells)==null?void 0:Y.map(xe=>{var Tt;return{id:xe.id,elements:((Tt=xe.elements)==null?void 0:Tt.map(Ce=>{var Oe;return{id:Ce.id,type:Ce.type,content:Ce.type==="image"&&((Oe=Ce.content)!=null&&Oe.startsWith("data:image/"))?`[IMAGE_${Ce.content.length}]`:Ce.content,position:Ce.position,size:Ce.size,style:Ce.style,filters:Ce.filters,rotation:Ce.rotation}}))||[]}}))||[]}})||[],workspace:{width:X==null?void 0:X.width,height:X==null?void 0:X.height}};return btoa(JSON.stringify(G)).substring(0,32)}catch(G){return console.warn("⚠️ [AUTO-SAVE] Error generando hash:",G),Date.now().toString()}},[]),le=g.useCallback(()=>`album_editor_autosave_${(l==null?void 0:l.id)||"draft"}`,[l==null?void 0:l.id]),b=g.useCallback(z=>{try{const X=le(),G={...z,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(X,JSON.stringify(G)),console.log("💾 [AUTO-SAVE] Guardado en localStorage"),!0}catch(X){return console.error("❌ [AUTO-SAVE] Error guardando en localStorage:",X),!1}},[le]),ie=g.useCallback(()=>{var z;try{const X=le(),G=localStorage.getItem(X);if(G){const pe=JSON.parse(G);return console.log("📂 [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(z=pe.pages)==null?void 0:z.length,savedAt:new Date(pe.savedAt).toLocaleString()}),pe}}catch(X){console.error("❌ [AUTO-SAVE] Error cargando desde localStorage:",X)}return null},[le]),de=g.useCallback(async(z=!1)=>{if(te.current&&!z){console.log("⏳ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(l!=null&&l.id)||!r||r.length===0){console.log("⚠️ [AUTO-SAVE] Datos insuficientes para guardar");return}const X=u(r,a);if(!z&&X===W.current){console.log("📊 [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{te.current=!0,k("saving"),T(null);const G={pages:r,projectInfo:{id:l.id,item_id:i==null?void 0:i.id,title:i==null?void 0:i.title,preset_id:f==null?void 0:f.id},workspace:a,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:X}};if(b(G),O){const pe=await ko(r,l,i,f,a,x,!0);if(pe.success)W.current=X,B(new Date),k("saved"),H(!1),console.log("✅ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(pe.error)}else console.log("� [AUTO-SAVE] Sin conexión, solo guardado en localStorage"),k("pending"),H(!0)}catch(G){console.error("❌ [AUTO-SAVE] Error:",G),T(G.message),k("error"),O&&(J.current=setTimeout(()=>{console.log("🔄 [AUTO-SAVE] Reintentando guardado..."),de(!0)},Be))}finally{te.current=!1}},[r,l,i,f,a,x,u,b,O]),qe=g.useCallback(async()=>{try{k("saving");const z=await ko(r,l,i,f,a,x,!1);if(z.success){const X=u(r,a);W.current=X,w(new Date),k("saved"),H(!1),re.success("💾 Proyecto guardado exitosamente"),console.log("✅ [MANUAL-SAVE] Guardado manual exitoso")}else T(z.error),k("error"),re.error(`❌ Error al guardar: ${z.error}`);return z.success}catch(z){return console.error("❌ [MANUAL-SAVE] Error:",z),T(z.message),k("error"),re.error(`❌ Error inesperado: ${z.message}`),!1}},[r,l,i,f,a,x,u]);return g.useEffect(()=>{if(!(l!=null&&l.id)||!r||r.length===0)return;const z=u(r,a);return W.current&&z!==W.current?(console.log("🔄 [AUTO-SAVE] Cambios detectados, programando guardado..."),H(!0),k("pending"),R.current&&clearTimeout(R.current),R.current=setTimeout(()=>{de()},Se)):W.current||(W.current=z),()=>{R.current&&clearTimeout(R.current)}},[r,a,l==null?void 0:l.id,u,de]),g.useEffect(()=>{if(l!=null&&l.id)return D.current&&clearInterval(D.current),D.current=setInterval(()=>{A&&(console.log("⏰ [AUTO-SAVE] Auto-save periódico activado"),de())},me),()=>{D.current&&clearInterval(D.current)}},[l==null?void 0:l.id,A,de]),g.useEffect(()=>{const z=()=>{console.log("🌐 [AUTO-SAVE] Conexión restaurada"),K(!0),A&&setTimeout(()=>de(!0),1e3)},X=()=>{console.log("📴 [AUTO-SAVE] Conexión perdida"),K(!1)};return window.addEventListener("online",z),window.addEventListener("offline",X),()=>{window.removeEventListener("online",z),window.removeEventListener("offline",X)}},[A,de]),g.useEffect(()=>{const z=X=>{if(A){const G={pages:r,projectInfo:{id:l.id},workspace:a,meta:{savedAt:new Date().toISOString()}};return b(G),X.preventDefault(),X.returnValue="¿Estás seguro de salir? Hay cambios sin guardar.","¿Estás seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",z),()=>window.removeEventListener("beforeunload",z)},[A,r,l==null?void 0:l.id,a,b]),g.useEffect(()=>()=>{R.current&&clearTimeout(R.current),D.current&&clearInterval(D.current),J.current&&clearTimeout(J.current)},[]),g.useEffect(()=>{C&&(C.includes("max_allowed_packet")||C.includes("data_too_large")?re.error("❌ El proyecto es demasiado grande para guardar automáticamente. Reduce el número o tamaño de imágenes."):re.error(`❌ Error de auto-guardado: ${C}`))},[C]),{saveStatus:N,lastSaved:E,lastAutoSaved:_,saveError:C,hasUnsavedChanges:A,isOnline:O,saveManually:qe,performAutoSave:()=>de(!0),loadFromLocalStorage:ie,getStorageKey:le,autoSaveInterval:me,debounceDelay:Se}},Ca=({saveStatus:r,lastSaved:l,lastAutoSaved:i,hasUnsavedChanges:f,isOnline:a,saveError:x,onManualSave:N,className:k=""})=>{const E=B=>{if(!B)return null;const T=new Date-B,A=Math.floor(T/(1e3*60)),H=Math.floor(T/1e3);if(H<30)return"hace unos segundos";if(A<1)return`hace ${H}s`;if(A<60)return`hace ${A}m`;const O=Math.floor(A/60);return O<24?`hace ${O}h`:B.toLocaleDateString()},_=(()=>{if(!a)return{icon:e.jsx(Eo,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexión",detail:"Guardado local activo"};switch(r){case"saving":return{icon:e.jsx(Rn,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(Pn,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:i?`Auto-guardado ${E(i)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(On,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:x||"Error desconocido"};case"pending":return{icon:e.jsx(In,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:f?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(Oo,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${k}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${_.bg} ${_.color}
                    hover:shadow-md
                `,onClick:()=>r!=="saving"&&(N==null?void 0:N()),children:[_.icon,e.jsx("span",{className:"text-sm font-medium",children:_.text}),e.jsx("div",{className:"flex items-center",children:a?e.jsx(Kn,{className:"w-3 h-3 text-green-500"}):e.jsx(Eo,{className:"w-3 h-3 text-orange-500"})})]}),r==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},Na=r=>{const[l,i]=g.useState({}),[f,a]=g.useState(!1);g.useEffect(()=>{if(!r||Object.keys(r).length===0)return;a(!0);const w=async()=>{try{const _={},B={};if(Object.entries(r).forEach(([C,T])=>{T&&T.startsWith("data:image/")?_[C]=T:B[C]=T}),Object.keys(_).length>0){console.log(`🔄 [BLOB-HOOK] Convirtiendo ${Object.keys(_).length} data URLs a Blob URLs...`);const C=Cn(_);i({...B,...C})}else i(B)}catch(_){console.error("❌ [BLOB-HOOK] Error en conversión:",_),i(r)}finally{a(!1)}};requestAnimationFrame(()=>{w()})},[r]);const x=g.useCallback((w,_)=>{if(!w||!w.startsWith("data:image/"))return w;const B=wn(w,_);return i(C=>({...C,[_]:B})),B},[]),N=g.useCallback(w=>{yn(w),i(_=>{const B={..._};return delete B[w],B})},[]),k=g.useCallback(()=>{fo(),i({})},[]),E=g.useCallback(()=>{const w=En(),_=Object.keys(r||{}).length,B=Object.values(l).filter(T=>T==null?void 0:T.startsWith("blob:")).length,C=Object.values(r||{}).filter(T=>T==null?void 0:T.startsWith("data:")).length;return{...w,totalThumbnails:_,blobCount:B,dataCount:C,conversionRate:_>0?(B/_*100).toFixed(1):0}},[r,l]);return g.useEffect(()=>()=>{fo()},[]),{thumbnails:l,isConverting:f,convertSingle:x,cleanup:N,cleanupAll:k,getStats:E}},$e=typeof window>"u",vt=()=>{},Sa=()=>{},De=console.error,Ee=console.log,Ta=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const r=document.createElement("style");r.textContent=Ta,document.head.appendChild(r)}function wt(r,l){let i;return function(...a){const x=()=>{clearTimeout(i),r(...a)};clearTimeout(i),i=setTimeout(x,l)}}const ja=(r,l,i)=>{var H,O;if(!r||!r.template)return i;const f=r.template;let a=1,x=1;const N=f.match(/grid-cols-(\d+)/),k=f.match(/grid-rows-(\d+)/);N&&(a=parseInt(N[1])),k&&(x=parseInt(k[1]));let E=16;const w=f.match(/gap-(\d+)/);w?E=parseInt(w[1])*4:(H=r.style)!=null&&H.gap&&(E=parseInt(r.style.gap));let _=0;(O=r.style)!=null&&O.padding&&(_=parseInt(r.style.padding)*2);const B=i.width-_-E*(a-1),C=i.height-_-E*(x-1);let T=Math.floor(B/a),A=Math.floor(C/x);if(r.cellStyles&&r.cellStyles[l]){const K=r.cellStyles[l],D=K.match(/col-span-(\d+)/),R=K.match(/row-span-(\d+)/);if(D){const W=parseInt(D[1]);T=Math.floor((B+E*(W-1))/a*W)}if(R){const W=parseInt(R[1]);A=Math.floor((C+E*(W-1))/x*W)}}return Ee(`🔧 [CELL-DIMENSIONS] Layout: ${r.id}, Celda: ${l}, Grid: ${a}x${x}, Gap: ${E}px, Dims: ${T}x${A}`),{width:T,height:A}},qt=Kt.memo(({pageId:r,thumbnail:l,altText:i,type:f})=>{const[a,x]=g.useState(!1),[N,k]=g.useState(!1);if(l&&!N)return e.jsxs("div",{className:"relative w-full h-full",children:[!a&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:l,alt:i,className:`w-full h-full object-contain transition-opacity duration-200 ${a?"opacity-100":"opacity-0"}`,onLoad:()=>x(!0),onError:()=>k(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}}),!1]});const E=f==="cover"||f==="final"?yt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((w,_)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},_))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(E,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(r,l)=>r.pageId===l.pageId&&r.thumbnail===l.thumbnail&&r.altText===l.altText&&r.type===l.type),ka=Kt.memo(({images:r,onImageSelect:l,isLoading:i})=>{const f=Kt.memo(({image:a})=>{const[x,N]=g.useState(!1),[k,E]=g.useState(!1),[w,_]=g.useState(!1),[{isDragging:B},C]=kn(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:a.url},collect:K=>({isDragging:!!K.isDragging()}),end:()=>{setTimeout(()=>_(!1),100)}})),T=a.thumbnail_url||a.url,A=a.url,H=K=>{_(!0),setTimeout(()=>_(!1),500)},O=K=>{if(w||B)return K.preventDefault(),K.stopPropagation(),!1;l(A)};return e.jsxs("div",{ref:C,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${B?"opacity-50 scale-95":""}`,onMouseDown:H,onClick:O,children:[e.jsxs("div",{className:"aspect-square relative",children:[!x&&!k&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),k?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Ve,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:T,alt:a.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${x?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>N(!0),onError:()=>E(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(Et,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:a.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),a.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return i?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((a,x)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},x))}):r.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ve,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay imágenes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:r.map((a,x)=>e.jsx(f,{image:a},`${a.id||a.url}-${x}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[r.filter(a=>a.has_thumbnail).length," de ",r.length," imágenes optimizadas"]})})]})});function Ls(){var Sr,Tr,jr,kr,_r,Ar,Ir,Or,Pr,Rr,Lr,Mr,$r,Br,Ur,zr,Fr,Hr,Wr,Vr,Gr,qr,Kr,Jr,Dr,Qr,Yr,Xr,Zr,eo,to,ro,oo,no,ao,so,io,lo,co,uo,mo;const[r,l]=g.useState(null),[i,f]=g.useState(null),[a,x]=g.useState(null),[N,k]=g.useState(null),[E,w]=g.useState(!0),[_,B]=g.useState(null),[C,T]=g.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[A,H]=g.useState(new Map),[O,K]=g.useState([]),[D,R]=g.useState(!1),W=g.useRef(O),te=g.useRef(A);g.useRef(null);const J=g.useRef(null),me=g.useRef(null);g.useEffect(()=>{W.current=O},[O]),g.useEffect(()=>{te.current=A},[A]),g.useEffect(()=>{(async()=>{var o;try{const s=new URLSearchParams(window.location.search).get("project");if(!s){B("No se encontró el ID del proyecto en la URL"),w(!1);return}const c=await fetch(`/api/canvas/projects/${s}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!c.ok)throw new Error("Error al cargar el proyecto");const d=await c.json();l(d.project),f(d.item),x(d.canvasPreset),k(d.initialProject),w(!1)}catch(n){console.error("❌ Error cargando proyecto:",n),B(n.message),w(!1)}})()},[]);const[Se,Be]=g.useState(xo.Local.get(`${vo.APP_CORRELATIVE}_cart`)??[]);g.useEffect(()=>{xo.Local.set(`${vo.APP_CORRELATIVE}_cart`,Se)},[Se]);const[u,le]=g.useState([]),[b,ie]=g.useState(0),[de,qe]=g.useState("preset"),[z,X]=g.useState(null),[G,pe]=g.useState(null),[Y,xe]=g.useState("pages"),[Tt,Ce]=g.useState("basic"),[Oe,Qe]=g.useState([JSON.stringify(u)]),[Te,He]=g.useState(0),[Dt,_a]=g.useState(!1),[Aa,Qt]=g.useState(null),[oe,ne]=g.useState({}),{thumbnails:Ye,isConverting:Yt,getStats:Xt}=Na(oe);g.useEffect(()=>{typeof window<"u"&&(window.checkBlobOptimization=()=>{const t=Xt();return console.log("📊 [BLOB-OPTIMIZATION] Estadísticas del sistema:"),console.log(`📄 Data URLs originales: ${t.dataCount}`),console.log(`🔗 Blob URLs optimizados: ${t.blobCount}`),console.log(`📈 Tasa de conversión: ${t.conversionRate}%`),console.log(`💾 Memoria liberada: ~${t.totalSizeMB} MB`),console.log(`⚡ Convirtiendo: ${Yt?"Sí":"No"}`),console.log(`
🔍 [COMPARISON] Comparación de thumbnails:`),Object.entries(oe).forEach(([o,n])=>{const s=Ye[o];if(n&&s){const c=s.startsWith("blob:");console.log(`📄 ${o}: ${c?"✅ OPTIMIZADO":"❌ SIN OPTIMIZAR"}`)}}),t},window.forceBlobConversion=()=>{console.log("🔄 [FORCE-CONVERSION] Forzando conversión de todos los thumbnails..."),ne(t=>({...t}))})},[oe,Ye,Xt,Yt]);const[Ia,Oa]=g.useState(!1),[Pe,We]=g.useState([]),[jt,Zt]=g.useState(!1),[it,Wo]=g.useState(new Map),[Xe,Vo]=g.useState(()=>new Map),[Ze,er]=g.useState(null),[tr,rr]=g.useState(!1);g.useEffect(()=>{Ee("✅ [FILTERS] Tab actual:",Y)},[Y]),g.useCallback((t,o="manual")=>{if(Ee(`🔄 [ACTIVE_TAB] Cambiando de "${Y}" a "${t}" - Razón: ${o}`),t==="filters"&&o!=="manual"){console.warn("🚨 [ACTIVE_TAB] Cambio automático a filters bloqueado!");return}xe(t)},[Y]),$e||(window.FORCE_THUMBNAIL_REGENERATION=!0,window.PREVENT_THUMBNAIL_RESET=!1,window._protectedThumbnailIds=[],window.THUMBNAIL_PROTECTED=!1,window.PRESERVE_FILTERS=!0),g.useEffect(()=>{$e||(window.forceRegenerateAllThumbnails=()=>{Ee("💣 [EMERGENCIA-GLOBAL] Forzando regeneración de TODOS los thumbnails"),window.thumbnailCache={},H(t=>{const o=new Map(t);return u.forEach((n,s)=>{o.set(s,Date.now())}),o}),Ee("1️⃣ Regenerando página actual"),ae(!0).then(()=>{Ee("✅ Primera regeneración completa"),window.BLOCK_AUTO_REGENERATION=!0,setTimeout(()=>{Ee("2️⃣ Ejecutando segunda regeneración forzada"),window.forceRegenerateThumbnail&&window.forceRegenerateThumbnail(),window.THUMBNAIL_PROTECTED=!0,setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,Ee("🔓 Regeneración automática desbloqueada")},5e3)},200)}).catch(t=>{console.error("❌ Error en regeneración de emergencia:",t)})})},[u]),g.useEffect(()=>{window._protectedThumbnails||(window._protectedThumbnails=new Set),window.protectThumbnail=t=>{window._protectedThumbnails.add(t),Ee(`🛡️ [PROTECT] Thumbnail ${t} marcado como protegido`)},window.unprotectThumbnail=t=>{window._protectedThumbnails.delete(t),Ee(`🔓 [UNPROTECT] Thumbnail ${t} desprotegido`)},window.isThumbnailProtected=t=>{var o;return((o=window._protectedThumbnails)==null?void 0:o.has(t))||!1},window.blockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!0,Ee("🚫 [BLOCK AUTO] Regeneraciones automáticas BLOQUEADAS")},window.unblockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!1,Ee("✅ [UNBLOCK AUTO] Regeneraciones automáticas DESBLOQUEADAS")},window.isAutoRegenerationBlocked=()=>window._blockAutoRegeneration||!1,window._thumbnailWatchdog||(window._thumbnailWatchdog=setInterval(()=>{window._protectedThumbnailData&&window._protectedThumbnails&&Array.from(window._protectedThumbnails).forEach(o=>{const n=window._protectedThumbnailData[o];n&&ne(s=>s[o]&&s[o]!==n?(console.error(`🚨 [WATCHDOG] ¡SOBRESCRITURA DETECTADA! Restaurando ${o}`),{...s,[o]:n}):s)})},100)),window._interceptorInstalled||(window._interceptorInstalled=!0)},[]);const[Ke,et]=g.useState(!1),or=g.useRef(),[q,nr]=g.useState({width:1e3,height:800}),Go=g.useCallback((t,o,n="unknown")=>{var s;return(s=window.isThumbnailProtected)!=null&&s.call(window,t)?(console.error(`� [PROTECTION BLOCK] ¡BLOQUEADO! Intento de sobrescribir thumbnail protegido ${t} desde: ${n}`),console.error("🚨 [PROTECTION BLOCK] Stack trace:",new Error().stack),!1):(ne(c=>(c[t],{...c,[t]:o})),!0)},[]),ar=g.useMemo(()=>xa({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¡Bienvenido al Editor de BananaLab! 🍌",description:"Este es tu lienzo de trabajo donde crearás diseños increíbles. Aquí puedes ver y editar la página actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"🎯 Navegación Principal",description:"En la barra lateral izquierda encontrarás todas las herramientas organizadas por categorías. Cada ícono te lleva a una sección específica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"📄 Sección Páginas",description:"Gestiona todas las páginas de tu proyecto: portada, páginas de contenido y contraportada. Haz clic en cualquier página para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"🎨 Sección Diseños",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu página. Cada diseño tiene una distribución única.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"📚 Sección Capas",description:"Organiza y controla la superposición de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posición.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"✍️ Sección Textos",description:"Agrega y personaliza textos: títulos, subtítulos y párrafos. Cambia fuentes, colores, tamaños y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"🎭 Sección Filtros",description:"Aplica efectos visuales a tus imágenes: brillo, contraste, saturación, máscaras y más filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"⚡ Acciones Rápidas",description:"Herramientas de acceso rápido: cambiar diseño de página, gestionar capas, agregar imágenes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"💾 Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso automáticamente y acceder a la vista previa de tu álbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"👁️ Vista de Álbum",description:"Visualiza tu proyecto completo como un álbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"🎉 ¡Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una página y agregando elementos. ¡Diviértete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente →",prevBtnText:"← Anterior",doneBtnText:"¡Empezar a crear! 🚀",closeBtnText:"✕",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(t,o)=>{var s;const n=(s=t==null?void 0:t.getAttribute)==null?void 0:s.call(t,"data-tab");n&&Y!==n&&xe(n)},onDeselected:()=>{console.log("🎯 [TOUR-COMPLETED] Tour completado por el usuario");const o=`bananalab_editor_tour_user_${(r==null?void 0:r.user_id)||"anonymous"}`;localStorage.setItem("bananalab_editor_tour_completed","true"),localStorage.setItem(o,new Date().toISOString()),re.success("¡Guía completada! Ya puedes empezar a crear tu diseño.",{duration:3e3})}}),[Y,xe]),sr=g.useCallback(()=>{const t=localStorage.getItem("bananalab_editor_tour_completed"),n=`bananalab_editor_tour_user_${(r==null?void 0:r.user_id)||"anonymous"}`,s=localStorage.getItem(n);!t&&!s?(console.log("🎯 [AUTO-TOUR] Usuario nuevo detectado, iniciando tour automático"),setTimeout(()=>{kt(),localStorage.setItem("bananalab_editor_tour_completed","true"),localStorage.setItem(n,new Date().toISOString())},1500)):console.log("🎯 [AUTO-TOUR] Usuario experimentado, no se inicia tour automático")},[r==null?void 0:r.user_id]),kt=g.useCallback(()=>{console.log("🎯 [MANUAL-TOUR] Iniciando tour manual"),ar.drive()},[ar]),qo=g.useCallback(()=>{const t=(r==null?void 0:r.user_id)||"anonymous",o=`bananalab_editor_tour_user_${t}`;localStorage.removeItem("bananalab_editor_tour_completed"),localStorage.removeItem(o),console.log("🔧 [TOUR-RESET] Estado del tour reseteado para usuario:",t),re.info("Estado del tour reseteado. Recarga la página para ver el tour automático.",{duration:4e3})},[r==null?void 0:r.user_id]),_t=g.useCallback(async()=>{if(r!=null&&r.id)try{const t=await fetch(`/api/thumbnails/${r.id}`);if(t.ok){const o=await t.json();if(o.success&&o.thumbnails&&o.thumbnails.length>0){const n={};o.thumbnails.forEach(s=>{s.page_id&&s.thumbnail_url&&(n[s.page_id]=s.thumbnail_url)}),Object.keys(n).length>0&&ne(s=>{var d;console.warn("🚨 [STORAGE LOAD] ¡ALERTA! Cargando thumbnails desde storage - POSIBLE CULPABLE DE SOBRESCRITURA"),console.warn("🚨 [STORAGE LOAD] Thumbnails protegidos:",Array.from(window._protectedThumbnails||[])),console.warn("🚨 [STORAGE LOAD] Stack trace:",new Error().stack);const c={};for(const[h,m]of Object.entries(n))(d=window.isThumbnailProtected)!=null&&d.call(window,h)?console.warn(`🛡️ [STORAGE PROTECTION] NO sobrescribiendo thumbnail protegido: ${h}`):c[h]=m;return{...s,...c}})}}}catch(t){console.warn("⚠️ Error cargando thumbnails guardados (usando locales):",t)}},[r==null?void 0:r.id]),lt=g.useRef(new Map),Ue=g.useRef(new Map),At=g.useRef(null);g.useEffect(()=>(At.current=setInterval(()=>{const t=Date.now(),o=10*60*1e3;for(const[n,s]of Ue.current.entries())t-s.timestamp>o&&Ue.current.delete(n);if(window.thumbnailCache&&typeof window.thumbnailCache=="object"){const n=Object.keys(window.thumbnailCache);if(n.length>100){const s=n.sort().slice(-60),c={};s.forEach(d=>{c[d]=window.thumbnailCache[d]}),window.thumbnailCache=c}}},3e5),()=>{At.current&&clearInterval(At.current)}),[]);const ir=g.useMemo(()=>JSON.stringify(q),[q]),ae=g.useCallback(async(t=!1)=>{var d,h,m;if(window.BLOCK_AUTO_REGENERATION&&!t)return;const o=u[b];if(!o||!q)return;console.log("pagina current actual",o);const n=o.id;if(!t){lt.current.has(n)&&clearTimeout(lt.current.get(n));const p=setTimeout(()=>{lt.current.delete(n),ae(!0)},300);lt.current.set(n,p);return}const s=`${n}-${ir}`;if(!t&&Ue.current.has(s)){const p=Ue.current.get(s);if(p&&Date.now()-p.timestamp<6e4)return}let c=!1;if(o.cells&&o.cells.forEach(p=>{p.elements&&p.elements.forEach(v=>{v.filters&&(v.filters.brightness!==void 0&&v.filters.brightness!==100&&v.filters.brightness!==1||v.filters.contrast!==void 0&&v.filters.contrast!==100&&v.filters.contrast!==1||v.filters.saturation!==void 0&&v.filters.saturation!==100&&v.filters.saturation!==1||v.filters.tint!==void 0&&v.filters.tint!==0||v.filters.hue!==void 0&&v.filters.hue!==0||v.filters.blur!==void 0&&v.filters.blur>0||v.filters.opacity!==void 0&&v.filters.opacity!==100&&v.filters.opacity!==1||v.filters.scale!==void 0&&v.filters.scale!==1||v.filters.rotate!==void 0&&v.filters.rotate!==0||v.filters.flipHorizontal||v.filters.flipVertical)&&(c=!0,v._hasRealFilters=!0)})}),!t&&!c&&oe[n]){const p=((d=window._thumbnailGenTimes)==null?void 0:d[n])||0;if(Date.now()-p<3e5)return}if(!Re.current){Re.current=!0;try{window._currentPageData=o,window._workspaceDimensions=q,window._updateThumbnailInUI=(j,$)=>{var L;if((L=window.isThumbnailProtected)!=null&&L.call(window,j)){console.error(`🚨 [UPDATE BLOCKED] ¡BLOQUEADO! Intento de actualizar thumbnail protegido ${j} via _updateThumbnailInUI`),console.error("🚨 [UPDATE BLOCKED] Stack trace:",new Error().stack);return}ne(y=>({...y,[j]:$}))},window._thumbnailGenTimes||(window._thumbnailGenTimes={}),window._thumbnailGenTimes[n]=Date.now();let p=null;const v=se.find(j=>j.id===o.layout)||se[0];if(v.cellStyles&&Object.values(v.cellStyles).some(j=>j.includes("col-span-")||j.includes("row-span-"))){console.log("🏗️ [LAYOUT COMPLEJO] Usando generador especializado para layout:",v.id);try{console.log("✅ [LAYOUT COMPLEJO] Thumbnail generado exitosamente")}catch(j){console.error("❌ [LAYOUT COMPLEJO] Error, usando fallback:",j),p=await ft(o,q)}}else if(c||t)try{p=await ft(o,q)}catch(j){console.error("❌ [MÉTODO RADICAL] Error, usando fallback:",j),p=await wo({page:o,workspaceDimensions:q,preserveFilters:!0})}else p=await wo({page:o,workspaceDimensions:q,preserveFilters:!1});if(p){if(c){(h=window.protectThumbnail)==null||h.call(window,n),(m=window.blockAutomaticRegeneration)==null||m.call(window),ne(L=>({...L,[n]:p})),setTimeout(()=>{ne(L=>L[n]!==p?(Sa(`🚨 [PROTECTION RESTORE] Restaurando thumbnail protegido para ${n}`),{...L,[n]:p}):L)},100);const $=()=>{ne(L=>L[n]!==p?(De(`🚨 [EMERGENCY RESTORE] ¡PARPADEO DETECTADO! Restaurando thumbnail para ${n}`),{...L,[n]:p}):L)};setTimeout($,200),setTimeout($,500),setTimeout($,1e3),setTimeout($,2e3),window._protectedThumbnailData||(window._protectedThumbnailData={}),window._protectedThumbnailData[n]=p}else Go(n,p,"generateCurrentPageThumbnail");c&&!t&&(window._filterVerificationDone||(window._filterVerificationDone=new Set),window._filterVerificationDone.has(n)||(window._filterVerificationDone.add(n),setTimeout(async()=>{var $;try{const L=await ft(o,q);L&&(($=window.protectThumbnail)==null||$.call(window,n),ne(y=>({...y,[n]:L})))}catch(L){console.warn("⚠️ [RADICAL FALLBACK] Error en método radical:",L)}},1e3))),c&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(n)||window._protectedThumbnailIds.push(n));const j=`${n}-${ir}`;if(Ue.current.set(j,{data:p,timestamp:Date.now(),hasFilters:c}),Ue.current.size>50){const $=Ue.current.keys().next().value;Ue.current.delete($)}}else console.error(`❌ [ERROR] No se pudo generar thumbnail para página: ${n}`)}catch(p){console.error(`❌ [CRITICAL ERROR] Error generando thumbnail para página ${n}:`,p)}finally{Re.current=!1}}},[u,b,q,oe]),It=g.useCallback(wt(async()=>{var t;if(!window.BLOCK_AUTO_REGENERATION&&!window.THUMBNAIL_PROTECTED&&!(!(u!=null&&u.length)||!q)&&!Re.current){Re.current=!0;try{const o=u.filter(s=>!oe[s.id]);if(o.length===0)return;if((t=window.isAutoRegenerationBlocked)!=null&&t.call(window)){console.warn("🚫 [BLOCKED] Regeneración automática bloqueada, saltando generateFastThumbnails");return}const n=await yo({pages:o,workspaceDimensions:q,onProgress:s=>{er(s)}});n&&Object.keys(n).length>0&&ne(s=>{var d;console.warn("🚨 [FAST THUMBNAILS] ¡ALERTA! generateFastThumbnails sobrescribiendo thumbnails - POSIBLE CULPABLE"),console.warn("🚨 [FAST THUMBNAILS] Stack trace:",new Error().stack);const c={};for(const[h,m]of Object.entries(n))(d=window.isThumbnailProtected)!=null&&d.call(window,h)?console.warn(`🛡️ [FAST PROTECTION] NO sobrescribiendo thumbnail protegido: ${h}`):c[h]=m;return{...s,...c}})}catch(o){console.warn("⚠️ Error generando thumbnails rápidos:",o)}finally{Re.current=!1,er(null)}}},300),[u,q,oe]),Re=g.useRef(!1);g.useCallback(async(t=[])=>{var o;if(!Re.current)try{if(Re.current=!0,t.length>0){const n=u.filter(s=>t.includes(s.id));if(n.length>0)if((o=window.isAutoRegenerationBlocked)!=null&&o.call(window))console.warn("🚫 [BLOCKED] Regeneración de prioridad bloqueada, saltando generateFastThumbnails");else{const s=await yo({pages:n,workspaceDimensions:q});s&&Object.keys(s).length>0&&ne(c=>{var h;console.warn("🚨 [PRIORITY THUMBNAILS] ¡ALERTA! generateFastThumbnails de prioridad sobrescribiendo - POSIBLE CULPABLE"),console.warn("🚨 [PRIORITY THUMBNAILS] Stack trace:",new Error().stack);const d={};for(const[m,p]of Object.entries(s))(h=window.isThumbnailProtected)!=null&&h.call(window,m)?console.warn(`🛡️ [PRIORITY PROTECTION] NO sobrescribiendo thumbnail protegido: ${m}`):d[m]=p;return{...c,...d}})}}}catch(n){console.warn("⚠️ Error en generación prioritaria:",n)}finally{Re.current=!1}},[u,q,It]);const lr=g.useCallback(t=>{if(Xe.has&&Xe.has(t))return;const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{if(o.width>1200||o.height>1200){const s=document.createElement("canvas"),c=s.getContext("2d"),d=1200,h=Math.min(d/o.width,d/o.height),m=o.width*h,p=o.height*h;s.width=m,s.height=p,c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(o,0,0,m,p),s.toBlob(v=>{if(v){const P=URL.createObjectURL(v);Vo(j=>{const $=new Map(j);if($.set(t,P),$.size>15){const L=$.keys().next().value,y=$.get(L);URL.revokeObjectURL(y),$.delete(L)}return $})}},"image/webp",.85)}},o.onerror=()=>{console.warn("❌ Error pre-cargando imagen:",t)},o.src=t},[]);g.useEffect(()=>{Pe.length>0&&Pe.slice(0,10).forEach((o,n)=>{setTimeout(()=>{lr(o.url)},n*100)})},[Pe,lr]),g.useEffect(()=>()=>{Xe&&Xe.forEach&&Xe.forEach(t=>URL.revokeObjectURL(t))},[]),g.useEffect(()=>()=>{Wt()},[]);const cr=g.useCallback(async()=>{var t;if(!(!(r!=null&&r.id)||!(u!=null&&u.length))&&!tr)try{rr(!0);const o=await fetch(`/api/thumbnails/${r.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:u})});if(o.ok){const n=await o.json();n&&Object.keys(n).length>0?ne(s=>({...s,...n})):setTimeout(()=>ae(),200)}}catch(o){console.warn("⚠️ Error cargando thumbnails existentes:",o),setTimeout(()=>ae(),200)}finally{rr(!1)}},[r==null?void 0:r.id,u,ae,tr]);g.useCallback(async()=>{if(!(!(r!=null&&r.id)||!(u!=null&&u.length)))try{const t=u[b];if(!t)return;const o=await fetch(`/api/thumbnails/${r.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:q.width,height:q.height,quality:95,scale:4,dpi:300})});if(o.ok){const n=await o.json();if(n.success&&n.thumbnails){const s={};n.thumbnails.forEach(c=>{c.page_id&&c.thumbnail_url&&(s[c.page_id]=c.thumbnail_url)}),ne(c=>({...c,...s}))}}}catch(t){console.warn("⚠️ Error generando thumbnail:",t)}},[r==null?void 0:r.id,u,b,q]),g.useCallback(async()=>{if(!(!(r!=null&&r.id)||!(u!=null&&u.length)))try{const t=await fetch(`/api/thumbnails/${r.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:u,width:q.width,height:q.height,quality:95,scale:4,dpi:300})});if(t.ok){const o=await t.json();if(o.success&&o.thumbnails){const n={};o.thumbnails.forEach(s=>{s.page_id&&s.thumbnail_url&&(n[s.page_id]=s.thumbnail_url)}),ne(s=>({...s,...n}))}}}catch(t){console.warn("⚠️ Error generando todos los thumbnails:",t)}},[r==null?void 0:r.id,u,q]);const Ko=g.useCallback(async(t=null)=>{if(!(r!=null&&r.id)||!(u!=null&&u.length))return{};try{const o={},n={};let s=0;const c=async(h,m)=>new Promise(p=>{const v=new Image;v.onload=()=>{n[m]=h,s++,t==null||t(s,u.length),p(!0)},v.onerror=()=>{console.warn(`⚠️ [ALBUM-MODAL] Thumbnail no encontrado: ${h}`),s++,t==null||t(s,u.length),p(!1)},v.src=h}),d=u.map(async(h,m)=>{let p;const v=i&&(i.has_cover_image===!0||i.has_cover_image===1),P=i&&(i.has_back_cover_image===!0||i.has_back_cover_image===1),j=v&&u.some(I=>I.type==="cover"),$=P&&u.some(I=>I.type==="final");if(h.type==="cover")p=0;else if(h.type==="content")j?p=u.filter(F=>F.type==="content").findIndex(F=>F.id===h.id)+1:p=u.filter(F=>F.type==="content").findIndex(F=>F.id===h.id)+1;else if(h.type==="final"){const I=u.filter(F=>F.type==="content");p=I.length+1}else p=m;const L=`/storage/images/thumbnails/${r.id}/page-${p}-pdf.webp`,y=h.id||`page-${m}`;return o[y]=L,c(L,y)});return await Promise.all(d),o}catch(o){return console.warn("⚠️ [ALBUM-MODAL] Error cargando thumbnails PDF:",o),{}}},[r==null?void 0:r.id,u,i]);g.useEffect(()=>{if(N&&i&&a){if(N.pages&&Array.isArray(N.pages)){const t=N.pages.map(o=>{let n=null,s=a.background_color||"#ffffff";return o.type==="cover"&&(i.has_cover_image===!0||i.has_cover_image===1)?i.cover_image&&(n=`/storage/images/item/${i.cover_image}`):o.type==="content"?i.content_image&&(n=`/storage/images/item/${i.content_image}`):(o.type==="final"||o.type==="contraportada")&&(i.has_back_cover_image===!0||i.has_back_cover_image===1)&&i.back_cover_image&&(n=`/storage/images/item/${i.back_cover_image}`),{...o,backgroundImage:n,backgroundColor:s}}).filter(o=>!(o.type==="cover"&&(i.has_cover_image===!1||i.has_cover_image===0)||(o.type==="final"||o.type==="contraportada")&&(i.has_back_cover_image===!1||i.has_back_cover_image===0)));le(o=>o.length>0?o.map((n,s)=>{const c=t[s];return c?{...n,backgroundImage:n.backgroundImage||c.backgroundImage,backgroundColor:n.backgroundColor||c.backgroundColor}:n}):t),Qe(o=>o.length<=1?[JSON.stringify(t)]:o),He(o=>o===0&&Oe.length<=1?0:o),setTimeout(()=>{_t()},100)}else{const t=vr(a,i);le(t),Qe([JSON.stringify(t)]),He(0),setTimeout(()=>{_t()},100)}typeof N.currentPage=="number"&&ie(N.currentPage),N.workspaceSize&&qe(N.workspaceSize)}},[N,i,a,_t]);const Le=Ea(u,r,i,a,q,oe),dr=()=>{if(a!=null&&a.width&&(a!=null&&a.height)){let m=a.width*6,p=a.height*6,v=m*37.8,P=p*37.8;if(v&&P){const j=window.innerWidth*.6,$=window.innerHeight*.7,L=j/v,y=$/P,I=Math.min(L,y,1);return{width:Math.round(v*I),height:Math.round(P*I),originalWidth:m,originalHeight:p,scale:I,unit:"cm",originalWidthPx:Math.round(v),originalHeightPx:Math.round(P)}}}if(a!=null&&a.extra_settings)try{const m=typeof a.extra_settings=="string"?JSON.parse(a.extra_settings):a.extra_settings;if(m!=null&&m.canvas_config){const p=m.canvas_config;let v=p.width,P=p.height,j=v*37.8,$=P*37.8;if(j&&$){const L=window.innerWidth*.6,y=window.innerHeight*.7,I=L/j,S=y/$,F=Math.min(I,S,1);return{width:Math.round(j*F),height:Math.round($*F),originalWidth:v,originalHeight:P,scale:F,unit:"cm",originalWidthPx:Math.round(j),originalHeightPx:Math.round($)}}}}catch(m){console.warn("Error parsing extra_settings:",m)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},o=t[de]||t.preset,n=$e?1200:window.innerWidth*.6,s=$e?800:window.innerHeight*.7,c=n/o.width,d=s/o.height,h=Math.min(c,d,1);return{width:Math.round(o.width*h),height:Math.round(o.height*h),originalWidth:o.width,originalHeight:o.height,scale:h,unit:"px"}},Ot=()=>{if(a!=null&&a.width&&(a!=null&&a.height)){let n=a.width,s=a.height,c=n*37.8,d=s*37.8;if(c&&d)return{width:Math.round(c),height:Math.round(d),originalWidth:n,originalHeight:s,scale:1,unit:"cm",originalWidthPx:Math.round(c),originalHeightPx:Math.round(d)}}if(a!=null&&a.extra_settings)try{const n=typeof a.extra_settings=="string"?JSON.parse(a.extra_settings):a.extra_settings;if(n!=null&&n.canvas_config){const s=n.canvas_config;let c=s.width,d=s.height,h=c*37.8,m=d*37.8;if(h&&m)return{width:Math.round(h),height:Math.round(m),originalWidth:c,originalHeight:d,scale:1,unit:"cm",originalWidthPx:Math.round(h),originalHeightPx:Math.round(m)}}}catch(n){console.warn("Error parsing extra_settings:",n)}const t={square:{width:1e3,height:1e3},landscape:{width:1280,height:800},portrait:{width:1e3,height:1200},wide:{width:1400,height:800},tall:{width:800,height:1200},preset:{width:1e3,height:800}},o=t[de]||t.preset;return{width:o.width,height:o.height,originalWidth:o.width,originalHeight:o.height,scale:1,unit:"px"}},Me=g.useCallback(async(t={type:"thumbnail"})=>{var o;if($e)return De("🚫 [VPS-PROTECTION] captureCurrentWorkspace bloqueado en servidor"),null;if(!u[b])return null;try{let n=document.querySelector(`#page-${u[b].id}`);if(!n)return console.warn("❌ THUMBNAIL: No se encontró el elemento de página específico"),null;const s=u[b],d=(s==null?void 0:s.cells)&&s.cells.length>0&&n.classList.contains("grid");Ee(`🔧 [CAPTURE-MODE] Página ${b}: ${d?"LAYOUT":"LIBRE"}, Celdas: ${((o=s==null?void 0:s.cells)==null?void 0:o.length)||0}`),d&&await new Promise(F=>{requestAnimationFrame(()=>{const M=n.querySelectorAll("[data-cell-id]");F()})});const h=t.type==="pdf",m=!0,p=4,v=1,P=h?Ot():q,j=getComputedStyle(n);let $=(s==null?void 0:s.backgroundColor)||"#ffffff";j.backgroundColor&&j.backgroundColor!=="rgba(0, 0, 0, 0)"&&($=j.backgroundColor);const L={scale:p,useCORS:!0,allowTaint:!1,backgroundColor:$,width:P.width,height:P.height,x:0,y:0,scrollX:0,scrollY:0,...d&&{windowWidth:P.width,windowHeight:P.height,ignoreElements:S=>{var F;return S.style&&S.style.filter&&t.preserveFilters?!1:(F=S.classList)==null?void 0:F.contains("exclude-from-capture")}},...!d&&{ignoreElements:S=>{var F;return S.style&&S.style.filter&&t.preserveFilters?!1:(F=S.classList)==null?void 0:F.contains("exclude-from-capture")}},foreignObjectRendering:!!(h||d),removeContainer:!1,logging:!!(d&&!m),imageTimeout:h?6e4:d?m?15e3:3e4:15e3,pixelRatio:h?3:m||$e?1:window.devicePixelRatio||1,...d&&{allowTaint:!0,useCORS:!0,letterRendering:!m,ignoreElements:S=>{var F,M;return((F=S.classList)==null?void 0:F.contains("exclude-from-capture"))||((M=S.classList)==null?void 0:M.contains("ui-element"))}},canvas:h?document.createElement("canvas"):null,windowWidth:h?Ot().width*p:null,windowHeight:h?Ot().height*p:null,onclone:async S=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(M=>{try{S.querySelectorAll(M).forEach(be=>be.remove())}catch(Q){console.warn("Error removing selector:",M,Q)}});try{const M=S.querySelector(`#page-${u[b].id}`);if(M){if(M.style.width=P.width+"px",M.style.height=P.height+"px",d||(M.style.position="relative"),M.style.overflow="hidden",s!=null&&s.backgroundImage&&(M.style.backgroundImage=`url(${s.backgroundImage})`,M.style.backgroundSize="cover",M.style.backgroundPosition="center",M.style.backgroundRepeat="no-repeat"),M.querySelectorAll('[style*="filter"]').forEach(be=>{}),d){const be=M.className,ke=getComputedStyle(n);M.style.display="grid",M.style.gridTemplateColumns=ke.gridTemplateColumns,M.style.gridTemplateRows=ke.gridTemplateRows,M.style.gap=ke.gap,M.querySelectorAll("[data-cell-id]").forEach((Ae,ee)=>{const ye=n.querySelector(`[data-cell-id="${Ae.getAttribute("data-cell-id")}"]`);if(ye){const ge=getComputedStyle(ye);Ae.style.gridColumn=ge.gridColumn,Ae.style.gridRow=ge.gridRow,Ae.style.position="relative"}Ae.querySelectorAll('img, [data-element-type="image"]').forEach(ge=>{ge.style.position==="absolute"&&(ge.style.position="absolute")})})}s!=null&&s.backgroundColor&&(M.style.backgroundColor=s.backgroundColor)}}catch(M){console.error("❌ [THUMBNAIL-FIX] Error configurando elemento de página:",M)}try{const M=new Map;n.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((ee,ye)=>{if(ee.complete&&ee.naturalWidth>0){const ge=(ee.closest('[data-element-type="image"]')||ee.parentElement).getBoundingClientRect(),Fe=ee.getBoundingClientRect();M.set(ee.src,{src:ee.src,naturalWidth:ee.naturalWidth,naturalHeight:ee.naturalHeight,containerWidth:ge.width,containerHeight:ge.height,objectFit:getComputedStyle(ee).objectFit||"cover",objectPosition:getComputedStyle(ee).objectPosition||"center",crossOrigin:ee.crossOrigin})}});const be=async(ee,ye,we,ge,Fe)=>new Promise(dt=>{try{const nt=ye/we,Ut=ge/Fe,mn=Math.max(ye,we),ut=Math.max(ge,Fe)/mn;let mt,gt,zt,Ft,go,ho;Ut>nt?(ho=we,go=we*Ut,gt=Fe,mt=Fe*nt,zt=(ge-mt)/2,Ft=0):(go=ye,ho=ye/Ut,mt=ge,gt=ge/nt,zt=0,Ft=(Fe-gt)/2);const ht=S.createElement("canvas");ht.width=ye*ut,ht.height=we*ut;const gn=ht.getContext("2d"),at=new Image;at.crossOrigin="anonymous",at.onload=()=>{try{gn.drawImage(at,zt,Ft,mt,gt,0,0,ye*ut,we*ut);const Ht=ht.toDataURL("image/png",1);ee.src=Ht,ee.style.objectFit="fill",ee.style.objectPosition="center",ee.style.width="100%",ee.style.height="100%",dt()}catch(Ht){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en canvas processing:",Ht),dt()}},at.onerror=()=>{console.warn("⚠️ [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),dt()},at.src=ee.src}catch(nt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",nt),dt()}}),ke=S.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),_e=[];ke.forEach((ee,ye)=>{if(ee.src&&M.has(ee.src)){const we=M.get(ee.src),ge=ee.closest('[data-element-type="image"]')||ee.parentElement;if(ge&&(ge.style.overflow="hidden",ge.style.position="relative"),we.objectFit==="cover"||ee.classList.contains("object-cover")||ee.classList.contains("workspace-image")){const Fe=be(ee,we.containerWidth,we.containerHeight,we.naturalWidth,we.naturalHeight);_e.push(Fe)}else ee.style.width="100%",ee.style.height="100%",ee.style.objectFit="fill"}}),_e.length>0&&await Promise.all(_e);const Ae=S.createElement("style");Ae.textContent=`
                            /* CORRECCIÓN THUMBNAIL: Estructura del elemento de página */
                            #page-${u[b].id} {
                                width: ${P.width}px !important;
                                height: ${P.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* 🖨️ IMÁGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya están recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${h?`
                                /* 🖨️ IMPRESIÓN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de página */
                            #page-${u[b].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* 🖨️ OPTIMIZACIONES GENERALES PARA PDF DE IMPRESIÓN */
                            ${h?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,S.head.appendChild(Ae)}catch(M){console.error("❌ [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",M);const Q=S.createElement("style");Q.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,S.head.appendChild(Q)}}};let y=null,I="";try{if(y=await po(n,L),h&&y){const S=y.getContext("2d");if(S){S.imageSmoothingEnabled=!1,S.imageSmoothingQuality="high";const F=S.getImageData(0,0,y.width,y.height),M=F.data;for(let Q=0;Q<M.length;Q+=4)M[Q]=Math.min(255,M[Q]*1.05),M[Q+1]=Math.min(255,M[Q+1]*1.05),M[Q+2]=Math.min(255,M[Q+2]*1.05);S.putImageData(F,0,0)}}if(!y)throw new Error("html2canvas no devolvió un canvas válido para el elemento de página");if(y.width===0||y.height===0)throw new Error("Canvas del elemento de página tiene dimensiones inválidas");I=y.toDataURL("image/png",2)}catch(S){throw console.error("❌ [ERROR-CAPTURA]:",S),S}finally{if(y){const S=y.getContext("2d");S&&S.clearRect(0,0,y.width,y.height),y.width=0,y.height=0,y=null}if(m&&window.gc)try{window.gc()}catch{}}if(!I||I==="data:,")throw new Error("No se pudo generar dataURL del elemento de página");return h?y:I}catch(n){console.error("❌ [THUMBNAIL-FIX] Error capturando elemento de página:",n);try{const s=document.createElement("canvas");s.width=dimensions.width*scaleFactor,s.height=dimensions.height*scaleFactor;const c=s.getContext("2d"),d=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return c.fillStyle=d,c.fillRect(0,0,s.width,s.height),c.fillStyle=d==="#ffffff"||d.includes("white")?"#374151":"#666666",c.font=`${14*scaleFactor}px Arial`,c.textAlign="center",c.fillText("Página "+(b+1),s.width/2,s.height/2),t.type==="pdf"?s:s.toDataURL("image/png",1)}catch{return null}}},[b,u]);g.useCallback(async()=>{if(!u[b])return;const t=await Me({type:"thumbnail"});t&&ne(o=>({...o,[u[b].id]:t}))},[Me,b,u]),g.useCallback(()=>{clearTimeout(or.current),or.current=setTimeout(()=>{u[b]&&(ne(t=>{const o={...t};return delete o[u[b].id],o}),setTimeout(()=>{ae()},200))},1e3)},[u,b,ae]);const Jo=g.useCallback(()=>{u[b]&&(ne(t=>{const o={...t};return delete o[u[b].id],o}),setTimeout(()=>{ae()},300))},[u,b,ae]),Do=g.useCallback(async(t=b,o={width:800,height:600})=>{var n,s;if(!u[t])return null;try{const c=b;t!==b&&(ie(t),await new Promise(v=>setTimeout(v,100)));const d=document.querySelector(`#page-${u[t].id}`);if(!d)return console.warn("Workspace element not found for page:",u[t].id),null;const h={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((n=u[t])==null?void 0:n.backgroundColor)||"#ffffff",width:d.offsetWidth,height:d.offsetHeight,removeContainer:!0,logging:!1,onclone:v=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(y=>{v.querySelectorAll(y).forEach(S=>S.remove())});const j=v.querySelector(`#page-${u[t].id}`);if(j){const y=u[t];y!=null&&y.backgroundImage&&(j.style.backgroundImage=`url(${y.backgroundImage})`,j.style.backgroundSize="cover",j.style.backgroundPosition="center",j.style.backgroundRepeat="no-repeat"),y!=null&&y.backgroundColor&&(j.style.backgroundColor=y.backgroundColor)}try{const y=d.querySelectorAll("img"),I=new Map;y.forEach((F,M)=>{const Q=getComputedStyle(F);I.set(M,{objectFit:Q.objectFit,objectPosition:Q.objectPosition,width:Q.width,height:Q.height,borderRadius:Q.borderRadius,transform:Q.transform})}),v.querySelectorAll("img").forEach((F,M)=>{const Q=I.get(M);Q&&(F.style.objectFit=Q.objectFit||"cover",F.style.objectPosition=Q.objectPosition||"center",F.style.width=Q.width,F.style.height=Q.height,F.style.borderRadius=Q.borderRadius,F.style.transform=Q.transform)})}catch(y){console.warn("Error preservando estilos de imágenes:",y),v.querySelectorAll("img").forEach(S=>{S.style.objectFit="cover",S.style.objectPosition="center",S.style.width||(S.style.width="100%"),S.style.height||(S.style.height="100%")})}v.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(y=>{const I=y.className;I&&(y.className=I);const S=getComputedStyle?getComputedStyle(y):null;S&&(S.fontFamily&&S.fontFamily!=="Arial"&&(y.style.fontFamily=S.fontFamily),S.fontSize&&(y.style.fontSize=S.fontSize),S.fontWeight&&(y.style.fontWeight=S.fontWeight),S.fontStyle&&(y.style.fontStyle=S.fontStyle))});const L=v.createElement("style");L.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CRÍTICO: Asegurar que las imágenes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CRÍTICO: Asegurar que los backgrounds de página se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,v.head.appendChild(L)}},m=await po(d,h);if(o.width!==m.width||o.height!==m.height){const v=document.createElement("canvas");v.width=o.width,v.height=o.height;const P=v.getContext("2d"),j=m.width/m.height,$=o.width/o.height;let L,y,I=0,S=0;j>$?(L=o.width,y=o.width/j,S=(o.height-y)/2):(y=o.height,L=o.height*j,I=(o.width-L)/2),P.fillStyle=((s=u[t])==null?void 0:s.backgroundColor)||"#ffffff",P.fillRect(0,0,o.width,o.height),P.drawImage(m,I,S,L,y);const F=v.toDataURL("image/png",1);return t!==c&&ie(c),F}return t!==c&&ie(c),m.toDataURL("image/png",1)}catch(c){return console.error("❌ Error generando thumbnail de alta calidad:",c),null}},[u,b,ie]);g.useEffect(()=>{const t=dr();nr(t)},[a,de]),g.useEffect(()=>{const t=()=>{const o=dr();nr(o)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[a,de]),g.useEffect(()=>{if(!$e&&u[b]&&!oe[u[b].id]){const t=setTimeout(()=>{ae()},500);return()=>clearTimeout(t)}},[b,u,oe,ae]),g.useEffect(()=>{const t=u[b];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(o=>{o.ok||console.error("❌ [WORKSPACE] Imagen NO existe en el servidor. Status:",o.status)}).catch(o=>{console.error("❌ [WORKSPACE] Error verificando imagen:",o)})},[b,(Sr=u[b])==null?void 0:Sr.backgroundImage]),g.useEffect(()=>{const t=`${q.width}x${q.height}`,o=sessionStorage.getItem("lastWorkspaceDimensions");o&&o!==t&&u.length>0&&(ne({}),setTimeout(()=>{u[b]&&Jo()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[q.width,q.height]),g.useEffect(()=>{if(!(r!=null&&r.id)||u.length===0)return;let t,o=Date.now(),n=!1;const s=()=>{n=!0,o=Date.now()},c=async()=>{if(n)try{setAutoSave(p=>({...p,saveStatus:"saving"}));const h=await fetch(`/api/projects/${r.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:u,force:!1})}),m=await h.json();if(h.ok&&m.success)n=!1,T(p=>({...p,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1}));else throw new Error("Guardado falló")}catch(h){console.error("❌ [AUTO-SAVE] Error en guardado silencioso:",h),T(m=>({...m,saveStatus:"error",saveError:h.message}))}},d=()=>{t=setInterval(()=>{const h=Date.now()-o;n&&h>6e4&&c()},3*60*1e3)};return JSON.stringify(u),u[b],s(),d(),()=>{t&&clearInterval(t)}},[u,b,r==null?void 0:r.id]),g.useEffect(()=>{var o;if(!u[b])return;const t=((o=u[b].cells)==null?void 0:o.flatMap(n=>n.elements))||[];JSON.stringify(t),T(n=>({...n,hasUnsavedChanges:!0}))},[(Tr=u[b])==null?void 0:Tr.cells,b]);const[Pa,Pt]=g.useState(!1),[Ra,Qo]=g.useState({elementId:null,cellId:null}),[Yo,ur]=g.useState(!1),[La,Xo]=g.useState(!1),[Ma,$a]=g.useState(null),[Zo,en]=g.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[ze,ve]=g.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de álbum...",subMessage:"Preparando tu vista previa personalizada"}),Rt=g.useRef(null),mr=t=>{var s,c,d,h;const o=G||((c=(s=u[b])==null?void 0:s.cells[0])==null?void 0:c.id);if(!o)return;const n={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((h=(d=u[b].cells.find(m=>m.id===o))==null?void 0:d.elements)==null?void 0:h.length)||0)+1};ot(o,n),re.success("Imagen añadida correctamente")},Lt=g.useCallback(wt(async(t=!1)=>{if(!(r!=null&&r.id))return;const o=it.get(r.id);if(!t&&o&&o.length>0){Pe.length===0&&We(o);return}if(J.current&&clearTimeout(J.current),!(jt&&!t)){Zt(!0);try{const n=new AbortController,s=setTimeout(()=>n.abort(),1e4),c=await fetch(`/api/canvas/projects/${r.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:n.signal});if(clearTimeout(s),!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const d=await c.json();if(d.success){const h=d.images||[],m=JSON.stringify(Pe),p=JSON.stringify(h);m!==p&&(We(h),Wo(v=>{const P=new Map(v);if(P.set(r.id,h),P.size>5){const j=P.keys().next().value;P.delete(j)}return P}))}else console.error("Error cargando imágenes:",d.message),re.error("Error cargando galería de imágenes")}catch(n){n.name==="AbortError"?console.warn("⚠️ Carga de imágenes cancelada por timeout"):(console.error("Error cargando imágenes del proyecto:",n),re.error("Error de conexión al cargar imágenes"))}finally{Zt(!1)}}},200),[r==null?void 0:r.id,it,Pe,jt]),tn=g.useCallback(async t=>{console.log("aqui entro ");const o=t.target.files[0];if(!o||!(r!=null&&r.id))return;const n=re.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),s=URL.createObjectURL(o),c={id:`temp-${Date.now()}`,filename:o.name,url:s,thumbnail_url:s,has_thumbnail:!1,size:o.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};We(L=>[c,...L]),mr(s);const{height:d,width:h,dpi:m}=r.canvas_preset,p=Math.max(d,h),v=Math.round(p*m/50.8),j=await(async L=>new Promise(y=>{const I=new Image;I.onload=()=>{const S=Math.max(I.width,I.height);if(S<=v){URL.revokeObjectURL(I.src),y(L);return}const F=v/S,M=Math.round(I.width*F),Q=Math.round(I.height*F),be=document.createElement("canvas");be.width=M,be.height=Q,be.getContext("2d").drawImage(I,0,0,M,Q),be.toBlob(_e=>{URL.revokeObjectURL(I.src),y(new File([_e],L.name,{type:L.type}))},L.type)},I.src=URL.createObjectURL(L)}))(o),$=new FormData;$.append("image",j),$.append("projectId",r.id);try{const y=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:$})).json();if(y.success){const I={id:y.id||Date.now(),filename:j.name,url:y.url,thumbnail_url:y.thumbnail_url||y.url,has_thumbnail:y.has_thumbnail||!1,size:j.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};We(S=>[I,...S.filter(F=>F.id!==c.id)]),setTimeout(()=>{le(S=>{const F=[...S];return F[b].cells.forEach(Q=>{Q.elements.forEach(be=>{be.type==="image"&&be.content===s&&(be.content=y.url)})}),F})},100),re.dismiss(n),re.success(y.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{Lt(!0)},2e3)}else We(I=>I.filter(S=>S.id!==c.id)),URL.revokeObjectURL(s),re.dismiss(n),re.error(y.message||"Error al subir la imagen")}catch(L){console.error("Error subiendo la imagen:",L),We(y=>y.filter(I=>I.id!==c.id)),URL.revokeObjectURL(s),re.dismiss(n),re.error("Error de red al subir la imagen")}},[r==null?void 0:r.id,b,mr,Lt]);g.useEffect(()=>{if(r!=null&&r.id){const t=it.get(r.id);if(t&&t.length>0){We(t);return}return J.current=setTimeout(()=>{Lt(!1)},150),()=>{J.current&&clearTimeout(J.current)}}},[r==null?void 0:r.id,it]),g.useEffect(()=>()=>{J.current&&clearTimeout(J.current)},[]);const gr=(t,o)=>{if(!u||u.length===0||!u[b]){console.error("❌ [ADD-IMAGE] No hay páginas válidas para agregar imagen");return}const n=JSON.parse(JSON.stringify(u));let s=!1;for(let c=0;c<n[b].cells.length;c++)if(n[b].cells[c].id===t){n[b].cells[c].elements.push(o),s=!0;break}if(!s){console.error("❌ [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{rt(n)},0)},rn=g.useCallback(t=>{var h,m,p,v;const o=Ke;et(!0);const n=Y==="images",s=G||((m=(h=u[b])==null?void 0:h.cells[0])==null?void 0:m.id);if(!s){console.error("❌ [ADD-FROM-GALLERY] No hay celda disponible"),re.error("No hay celda disponible para agregar la imagen"),et(o);return}if(!t||typeof t!="string"){console.error("❌ [ADD-FROM-GALLERY] URL de imagen inválida"),re.error("URL de imagen no válida"),et(o);return}const c=JSON.parse(JSON.stringify(u)),d={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((v=(p=c[b].cells.find(P=>P.id===s))==null?void 0:p.elements)==null?void 0:v.length)||0)+1};setTimeout(()=>{gr(s,d),setTimeout(()=>{n&&xe("images"),setTimeout(()=>{et(o),re.success("✅ Imagen añadida desde la galería")},50)},50)},50)},[Y,G,u,b,Ke,gr]),hr=g.useCallback(async(t,o)=>{var c,d;const n=[],s=[];for(const h of t){const m={...h};if(h.cells){m.cells=[];for(const p of h.cells){const v={...p};if(p.elements){v.elements=[];for(const P of p.elements)if(P.type==="image"&&((c=P.content)!=null&&c.startsWith("data:image/"))){const j=`${P.id}_${Date.now()}`,$=P.content.match(/^data:image\/([^;]+);base64,(.+)$/);if($){const L=$[1],y=$[2],S=`${j}.${L==="jpeg"?"jpg":L}`;s.push({filename:S,data:y,type:L,elementId:P.id}),v.elements.push({...P,content:P.content,_wasBase64:!0,_originalSize:P.content.length,_elementId:P.id})}else v.elements.push(P)}else v.elements.push(P)}m.cells.push(v)}}n.push(m)}if(s.length>0)try{const h=await fetch(`/api/canvas/projects/${o}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((d=document.querySelector('meta[name="csrf-token"]'))==null?void 0:d.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:s})});if(h.ok){const m=await h.json();if(m.uploadedImages){const p=new Map;m.uploadedImages.forEach(v=>{p.set(v.elementId,v.url)});for(const v of n)if(v.cells){for(const P of v.cells)if(P.elements)for(const j of P.elements)j._wasBase64&&j._elementId&&p.has(j._elementId)&&(j.content=p.get(j._elementId),delete j._elementId)}}}else{const m=await h.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("❌ [IMAGE-UPLOAD] Error subiendo imágenes:",m),t}}catch(h){return console.error("❌ [IMAGE-UPLOAD] Error de red subiendo imágenes:",h),t}return n},[]),tt=g.useCallback(async(t=u,o=!1)=>{var n;if(!(!(r!=null&&r.id)||!o&&t.length===0))try{const d={design_data:{pages:await hr(t,r.id),currentPage:b,workspaceDimensions:q,workspaceSize:de,selectedElement:z,selectedCell:G,history:Oe.slice(-5),historyIndex:Math.min(Te,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:r.id,name:(i==null?void 0:i.name)||"Álbum Personalizado",item_id:i==null?void 0:i.id,preset_id:a==null?void 0:a.id}},thumbnails:oe},m=JSON.stringify(d).length/(1024*1024),p=await fetch(`/api/canvas/projects/${r.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(d)});if(p.ok){const v=await p.json(),P=`editor_progress_project_${r.id}`;return localStorage.removeItem(P),H(j=>{const $=new Map(j);return o?$.clear():$.delete(b),$}),u&&u.length>0&&setTimeout(()=>{ae().catch(j=>{console.warn("⚠️ Error regenerando thumbnail de página actual:",j)})},300),!0}else{const v=await p.json().catch(()=>({message:"Error desconocido"}));return console.error("❌ [AUTO-SAVE] Error guardando en BD:",v),!1}}catch(s){return console.error("❌ [AUTO-SAVE] Error en auto-save con procesamiento de imágenes:",s),!1}},[u,b,q,de,r==null?void 0:r.id,i==null?void 0:i.name,i==null?void 0:i.id,a==null?void 0:a.id,hr,It]);g.useEffect(()=>{if(!(r!=null&&r.id))return;const t=setInterval(()=>{u.length>0&&tt(u,!1)},10*60*1e3);return()=>clearInterval(t)},[tt,u,r==null?void 0:r.id]),g.useCallback(async()=>{if(!u.length)return{};const t={},o=b;try{for(let n=0;n<u.length;n++){const s=u[n];if(s!=null&&s.id)try{n!==b&&(ie(n),await new Promise(d=>setTimeout(d,300)));const c=await Me({type:"thumbnail"});c&&(t[s.id]=c)}catch(c){console.warn(`⚠️ [THUMBNAILS] Error capturando thumbnail para página ${s.id}:`,c),oe[s.id]&&(t[s.id]=oe[s.id])}}return o!==b&&ie(o),t}catch(n){return console.error("❌ [THUMBNAILS] Error capturando thumbnails:",n),o!==b&&ie(o),oe}},[u,b,ie,Me,oe]);const pr=g.useCallback(async()=>{if(!(r!=null&&r.id)||u.length===0)return re.error("No hay datos para guardar"),!1;try{return await ae(),await cr(),await tt(u,!0)?(re.success("Progreso guardado exitosamente"),!0):(re.error("Error al guardar el progreso"),!1)}catch(t){return console.error("❌ [SAVE] Error al guardar el progreso:",t),re.error("Error al guardar el progreso"),!1}},[tt,u,r==null?void 0:r.id,q,a,It]),fr=g.useCallback(async t=>{var o;if(!(r!=null&&r.id))return De("❌ [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return De("❌ [QUEUE-SAVE] No hay páginas para guardar"),!1;try{const s={design_data:{pages:t,currentPage:b,workspaceDimensions:q,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:oe};vt("📤 [QUEUE-SAVE] Enviando petición al servidor...");const c=await fetch(`/api/canvas/projects/${r.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(s)});if(vt("📥 [QUEUE-SAVE] Respuesta del servidor:",c.status,c.statusText),c.ok){const d=await c.json();return vt("✅ [QUEUE-SAVE] Guardado exitoso desde cola:",d),!0}else{const d=await c.text();return De("❌ [QUEUE-SAVE] Error en respuesta del servidor:",c.status,d),!1}}catch(n){return n("❌ [QUEUE-SAVE] Error guardando desde cola:",n),!1}},[r==null?void 0:r.id,b,q,oe]),Mt=g.useCallback(async()=>{if(!D&&O.length!==0){R(!0);try{const t=O.slice();K([]);for(const o of t)await fr(o.pages)?H(s=>{const c=new Map(s);return c.delete(o.pageIndex),c}):(console.error("❌ [SAVE-QUEUE] Error guardando página:",o.pageIndex),K(s=>[...s,o]))}catch(t){console.error("❌ [SAVE-QUEUE] Error procesando cola:",t)}finally{R(!1)}}},[D,O,fr]);g.useEffect(()=>{O.length>0&&!D&&setTimeout(()=>{Mt()},100)},[O.length,D,Mt]),g.useEffect(()=>{},[O,D]);const br=g.useCallback((t,o)=>{H(n=>(Array.from(n.keys()),n.has(t)&&K(s=>{const c=s.findIndex(d=>d.pageIndex===t);if(c!==-1){const d=[...s];return d[c]={pageIndex:t,pages:o,timestamp:Date.now()},d}else return[...s,{pageIndex:t,pages:o,timestamp:Date.now()}]}),n))},[]),$t=g.useCallback(async t=>{t!==b&&(H(o=>{const n=Array.from(o.keys());return vt("🔍 [PAGE-CHANGE] Páginas con cambios:",n.join(", ")||"ninguna"),o.has(b)&&br(b,u),o}),ie(t))},[b,u,br]),Je=()=>`editor_progress_project_${r==null?void 0:r.id}`,xr=g.useCallback(async()=>{var o,n,s,c;if(!(!(r!=null&&r.id)||u.some(d=>{var h;return(h=d.cells)==null?void 0:h.some(m=>{var p;return((p=m.elements)==null?void 0:p.length)>0})})))try{const d=Le.loadFromLocalStorage(),h=await fetch(`/api/canvas/projects/${r.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let m=null;if(h.ok){const v=await h.json();v.success&&((o=v.data)!=null&&o.design_data)&&(m=v.data)}let p=null;if(d&&m){const v=new Date(d.savedAt).getTime(),P=new Date(m.saved_at).getTime();p=v>P?d:m}else d?p=d:m&&(p=m);if(p&&(((n=p.pages)==null?void 0:n.length)>0||((c=(s=p.design_data)==null?void 0:s.pages)==null?void 0:c.length)>0)){const v=new Date(p.savedAt||p.saved_at).getTime();Date.now()-v<30*60*1e3&&(re.info("🔄 Cargando progreso guardado automáticamente..."),on(p))}}catch(d){console.error("❌ [RECOVERY] Error verificando progreso guardado:",d)}},[r==null?void 0:r.id,Le,u]),on=g.useCallback(async t=>{var o;try{let n=[];if(t.pages?n=t.pages:(o=t.design_data)!=null&&o.pages&&(n=t.design_data.pages),n.length>0){le(n);const s=[JSON.stringify(n)];Qe(s),He(0),setTimeout(()=>{ne({})},100),re.success("✅ Progreso cargado exitosamente"),Xo(!1)}}catch(n){console.error("❌ [RECOVERY] Error cargando progreso:",n),re.error("Error al cargar el progreso guardado")}},[le,Qe,He,ne]);g.useCallback(async()=>{try{const t=Le.getStorageKey();localStorage.removeItem(t),re.success("Progreso anterior eliminado")}catch(t){console.error("❌ [RECOVERY] Error descartando progreso:",t)}},[Le]),g.useEffect(()=>{r&&i&&a&&(!(N!=null&&N.pages)||N.pages.length===0)&&vr(a,i)},[r,i,a,N]),g.useEffect(()=>{r!=null&&r.id&&!E&&u.length===0&&!Ke&&(et(!0),setTimeout(()=>{xr()},500))},[r==null?void 0:r.id,E,u.length,xr,Ke]),g.useEffect(()=>{(r==null?void 0:r.id)&&!E&&u.length>0&&Ke&&(console.log("🎯 [AUTO-TOUR] Editor completamente cargado, verificando si mostrar tour"),sr())},[r==null?void 0:r.id,E,u.length,Ke,sr]),g.useEffect(()=>(me.current&&clearTimeout(me.current),r!=null&&r.id&&u.length>0&&(me.current=setTimeout(()=>{cr()},500)),()=>{me.current&&clearTimeout(me.current)}),[r==null?void 0:r.id,u.length]);const vr=(t,o)=>{try{const n=[],s=o.pages||t.pages||20;if(o.has_cover_image===!0||o.has_cover_image===1){const h=o.cover_image?`/storage/images/item/${o.cover_image}`:null,m=o.cover_image?null:t.background_color||"#ffffff",p={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:h,backgroundColor:m,cells:[{id:"cell-cover-1",elements:[]}]};n.push(p)}const c=o.content_image?`/storage/images/item/${o.content_image}`:null,d=o.content_image?null:t.background_color||"#ffffff";for(let h=1;h<=s;h++){const m={id:`page-content-${h}`,type:"content",pageNumber:h,layout:"layout-1",backgroundImage:c,backgroundColor:d,cells:[{id:`cell-content-${h}-1`,elements:[]}]};n.push(m)}if(o.has_back_cover_image===!0||o.has_back_cover_image===1){const h=o.back_cover_image?`/storage/images/item/${o.back_cover_image}`:null,m=o.back_cover_image?null:t.background_color||"#ffffff",p={id:"page-final",type:"final",layout:"layout-1",backgroundImage:h,backgroundColor:m,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};n.push(p)}le(n),ie(0),t.width&&t.height&&qe("preset")}catch(n){console.error("❌ Error creating pages:",n),B(n.message)}},wr=g.useCallback(t=>{var d,h;if(!t||t.length===0)return[];const o=t.filter(m=>m.type==="cover"),n=t.filter(m=>m.type==="content"),s=t.filter(m=>m.type==="final");if(o.length===0&&s.length===0)return t;const c=[];return o.length>0&&(c.push(...o),c.push({id:`blank-page-cover-back-${Date.now()}`,type:"blank",isBlankPage:!0,hasLogo:!0,logoUrl:"/assets/resources/logo.png",cells:[],backgroundColor:"#ffffff",layout:((d=se[0])==null?void 0:d.id)||"layout1"})),n.length>0&&c.push(...n),s.length>0&&(c.length%2===1&&c.push({id:`blank-page-before-back-${Date.now()}`,type:"blank",isBlankPage:!0,cells:[],backgroundColor:"#ffffff",layout:((h=se[0])==null?void 0:h.id)||"layout1"}),c.push(...s)),c},[se]),ue=g.useMemo(()=>i?{cover:u.filter(t=>t.type==="cover"&&(i.has_cover_image===!0||i.has_cover_image===1)),content:u.filter(t=>t.type==="content"),final:u.filter(t=>t.type==="final"&&(i.has_back_cover_image===!0||i.has_back_cover_image===1))}:{cover:u.filter(t=>t.type==="cover"),content:u.filter(t=>t.type==="content"),final:u.filter(t=>t.type==="final")},[u,i]),fe=g.useCallback(()=>{if(!i)return console.warn("⚠️ [CONTENT-TYPE] itemData no disponible, usando tipo por defecto"),{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"};const t=i.has_cover_image===!0||i.has_cover_image===1,o=i.has_back_cover_image===!0||i.has_back_cover_image===1,n=t&&ue.cover.length>0,s=o&&ue.final.length>0,c=ue.content.length;return n&&s?{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"}:n||s?{type:"booklet",name:"Folleto",description:"Vista de Folleto",icon:"📋",experience:"booklet"}:c>1?{type:"catalog",name:"Catálogo",description:"Vista de Catálogo",icon:"📑",experience:"catalog"}:{type:"card",name:"Diseño",description:"Vista Previa",icon:"🎨",experience:"single"}},[ue,i])(),Z=g.useCallback(()=>{if(!z||!G||u.length===0)return null;const t=u[b];if(!t)return null;const o=t.cells.find(n=>n.id===G);return o?o.elements.find(n=>n.id===z):null},[z,G,u,b]),yr=(t,o)=>{if(o){const n=u[b].cells.find(c=>c.id===o),s=n==null?void 0:n.elements.find(c=>c.id===t);if(s!=null&&s.locked){const c=document.createElement("div");c.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",c.textContent="Este elemento es parte del diseño base y no se puede editar",document.body.appendChild(c),setTimeout(()=>{document.body.contains(c)&&document.body.removeChild(c)},3e3);return}}if(o&&pe(o),X(t),t){const n=u[b].cells.find(c=>c.id===(o||G)),s=n==null?void 0:n.elements.find(c=>c.id===t);(s==null?void 0:s.type)==="image"?Qt(s):(s==null?void 0:s.type)==="text"?(Pt(!0),Qo({elementId:t,cellId:o||G}),Y!=="filters"&&Y!=="images"&&xe("text")):Pt(!1)}else Pt(!1),Qt(null)},je=()=>{if(u.length===0)return se[0];const t=u[b];if(!t)return se[0];const o=se.find(s=>s.id===t.layout)||se[0],n=o.cellStyles&&Object.values(o.cellStyles).some(s=>s.includes("col-span-")||s.includes("row-span-"));return{...o,isComplex:n,pageId:t.id}},Er=g.useCallback(wt(t=>{try{const o=Je(),n={pages:t,currentPage:b,savedAt:Date.now()},s=JSON.stringify(n),c=Math.round(s.length/1024);c<2048?localStorage.setItem(o,s):(console.warn(`⚠️ Datos demasiado grandes para localStorage (${c} KB)`),localStorage.removeItem(o))}catch(o){if(console.error("❌ Error guardando en localStorage:",o),o.name==="QuotaExceededError")try{localStorage.removeItem(Je())}catch(n){console.error("Error limpiando localStorage:",n)}}},300),[b,Je]),rt=g.useCallback(t=>{le(o=>{if(o===t)return o;const n=JSON.stringify(o),s=JSON.stringify(t);return n===s?o:(requestAnimationFrame(()=>{if(H(c=>{const d=new Map(c);return d.set(b,Date.now()),d}),t[b]){const c=t[b].id;ne(d=>{if(d[c]){const h={...d};return delete h[c],h}return d})}}),setTimeout(()=>{Qe(c=>{const d=[...c.slice(0,Te+1),s];return d.length>50?d.slice(-50):d}),He(c=>{const d=c+1;return d>50?49:d})},0),t)}),Er(t)},[b,Te,Er]);g.useEffect(()=>{try{const t=Je(),o={pages:u,currentPage:b,savedAt:Date.now()},n=JSON.stringify(o),s=Math.round(n.length/1024);s<2048?localStorage.setItem(t,n):console.warn(`⚠️ Datos demasiado grandes para localStorage (${s} KB), saltando guardado`)}catch(t){if(console.error("❌ Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const o=Je();localStorage.removeItem(o)}catch(o){console.error("Error limpiando localStorage:",o)}}},[b,u,Je]);const nn=t=>{const o=se.find(d=>d.id===t);if(!o)return;const n=[...u],s=n[b],c=Array.from({length:o.cells}).map((d,h)=>s.cells[h]||{id:`cell-${s.id}-${h+1}`,elements:[]});n[b]={...s,layout:t,cells:c},rt(n),X(null),pe(null)},ot=(t,o)=>{const n=[...u];for(let s=0;s<n[b].cells.length;s++)n[b].cells[s].id===t&&n[b].cells[s].elements.push(o);rt(n),X(o.id),pe(t)},Cr=g.useCallback(wt(()=>{H(t=>{const o=new Map(t);return o.set(b,Date.now()),o})},100),[b]),ce=g.useCallback((t,o,n,s=!1)=>{le(c=>{const d=[...c],h=d[b].cells.findIndex(m=>m.id===t);if(h===-1)return c;if(s){const m=d[b].cells[h].elements.find(p=>p.id===o);if(!m)return c;d[b].cells[h].elements.push({...m,...n})}else{const m=d[b].cells[h].elements.findIndex(j=>j.id===o);if(m===-1)return c;const p=d[b].cells[h].elements[m];if(!Object.keys(n).some(j=>{const $=p[j],L=n[j];return typeof L=="object"&&typeof $=="object"?JSON.stringify($)!==JSON.stringify(L):$!==L}))return c;const P={...p,...n};d[b].cells[h].elements[m]=P,(n.filters||n.mask)&&(window.FORCE_THUMBNAIL_REGENERATION&&(window.thumbnailCache={}),ae(!0).then(()=>{window.FORCE_THUMBNAIL_REGENERATION&&window.forceRegenerateThumbnail&&setTimeout(()=>{try{window.forceRegenerateThumbnail()}catch(j){console.error("❌ [FORZADO-EMERGENCIA] Error en regeneración secundaria:",j)}},150)}).catch(j=>{console.error("❌ [AUTO-REGEN] Error regenerando thumbnail:",j)}))}return d}),n.position||n.size?requestAnimationFrame(()=>{H(c=>{if(c.has(b))return c;const d=new Map(c);return d.set(b,Date.now()),d})}):Cr()},[b,Cr]),an=g.useCallback(()=>{const t=je();return console.log("🧪 [TEST] Layout actual:",t),console.log("🧪 [TEST] Es complejo:",t.isComplex),console.log("🧪 [TEST] CellStyles:",t.cellStyles),ae(!0),`✅ Test ejecutado para layout: ${t.id} (complejo: ${t.isComplex})`},[je,ae]);window.testComplexLayoutThumbnail=an,g.useCallback(()=>{var o;if($e){De("🚫 [VPS-PROTECTION] forceRegenerateThumbnail bloqueado en servidor");return}window.thumbnailCache&&(window.thumbnailCache={}),window.THUMBNAIL_PROTECTED=!0,window._protectedThumbnailIds||(window._protectedThumbnailIds=[]);const t=(o=u[b])==null?void 0:o.id;t&&!window._protectedThumbnailIds.includes(t)&&window._protectedThumbnailIds.push(t),window.BLOCK_AUTO_REGENERATION=!0,ae(!0),setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1},1e4)},[ae]),g.useCallback(()=>{z&&G&&ce(G,z,{filters:{brightness:100,contrast:100,saturation:0,opacity:100}})},[z,G,ce]),g.useCallback(()=>{window.THUMBNAIL_PROTECTED=!0,window.PERMANENT_THUMBNAIL_LOCK=!0,window.BLOCK_AUTO_REGENERATION=!1,window._protectedThumbnailIds=Object.keys(oe);const t=window.forceRegenerateThumbnail;window.forceRegenerateThumbnail=(...o)=>window._userInitiated?(window._userInitiated=!1,t(...o)):!1,window._allowNextRegeneration=()=>{window._userInitiated=!0},window.safeRegenerateThumbnail=()=>{window._allowNextRegeneration(),window.forceRegenerateThumbnail()},window._thumbnailBackup={...oe},alert(`🔒 Miniaturas protegidas exitosamente!

Si necesitas regenerar una miniatura específica, usa window.safeRegenerateThumbnail() en la consola.`)},[oe]),g.useCallback(()=>{window.FORCE_FILTER_APPLICATION=!0,window.ENABLE_ADVANCED_FILTER_RENDERING=!0,window.thumbnailCache&&window.thumbnailCache.clear(),Wt&&Wt();const t=u[b];t&&t.cells&&t.cells.forEach(o=>{o.elements&&o.elements.forEach(n=>{n.filters&&(n._hasRealFilters=!0,n.pageId=t.id)})}),ae(!0)},[u,b,ae]);const ct=(t,o)=>{const n=[...u],s=n[b].cells.findIndex(c=>c.id===t);s!==-1&&(n[b].cells[s].elements=n[b].cells[s].elements.filter(c=>c.id!==o),rt(n),z===o&&X(null))},sn=(t,o,n)=>{const s=[...u],c=s[b].cells.findIndex(d=>d.id===t);if(c!==-1){const d=s[b].cells[c].elements,h=d.findIndex(m=>m.id===o);if(h!==-1){const m=n==="up"?h+1:h-1;if(m>=0&&m<d.length){const p=d[h];d[h]=d[m],d[m]=p,rt(s)}}}},ln=()=>{Te>0&&(He(Te-1),le(JSON.parse(Oe[Te-1])),X(null),pe(null))},cn=()=>{Te<Oe.length-1&&(He(Te+1),le(JSON.parse(Oe[Te+1])),X(null),pe(null))},Bt=(t="body")=>{const o=`text-${Date.now()}`,n={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},s={heading:"Título Principal",subheading:"Subtítulo",body:"Haz clic para editar"},c={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},d={id:o,type:"text",content:s[t],position:{x:.05,y:.05},size:c[t],style:n[t]};G&&ot(G,d)},Nr=g.useMemo(()=>{var c;const t=u[b];if(!t)return null;const o=((c=t.cells)==null?void 0:c.flatMap(d=>d.elements||[]))||[],n=o.map(d=>({id:d.id,type:d.type,position:d.position,size:d.size}));return{pageId:t.id,elementsCount:o.length,contentHash:JSON.stringify(n).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[u,b]);g.useEffect(()=>{var h;if($e)return;const t=u[b];if(!t)return;const o=t.id;if(((h=t==null?void 0:t.cells)==null?void 0:h.some(m=>{var p;return(p=m.elements)==null?void 0:p.some(v=>v.filters&&(v.filters.brightness!==100||v.filters.contrast!==100||v.filters.saturation!==100||v.filters.tint!==0||v.filters.hue!==0))}))&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(o)||window._protectedThumbnailIds.push(o)),u.length===0||E||!Nr)return;let s=!1;const c=async()=>{var m;if(!(window.PREVENT_THUMBNAIL_RESET||window.THUMBNAIL_PROTECTED))try{const p=u[b];if(!p||!p.id)return;const v=p.id;if(!window.PREVENT_THUMBNAIL_RESET&&!window.THUMBNAIL_PROTECTED&&ne(L=>{const y={...L};return delete y[v],y}),await new Promise(L=>setTimeout(L,100)),s)return;const P=(m=p==null?void 0:p.cells)==null?void 0:m.some(L=>{var y;return(y=L.elements)==null?void 0:y.some(I=>I.filters&&(I.filters.brightness!==100||I.filters.contrast!==100||I.filters.saturation!==100||I.filters.tint!==0||I.filters.hue!==0))}),$=await Me(P?{type:"thumbnail",preserveFilters:!0}:{type:"thumbnail"});$&&!s?(ne(L=>({...L,[v]:$})),P&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(v)||window._protectedThumbnailIds.push(v))):console.warn("⚠️ [DEBUG] No se pudo generar miniatura para:",v)}catch(p){s||console.error("❌ [DEBUG] Error regenerando miniatura:",p)}},d=setTimeout(()=>{c()},500);return()=>{s=!0,clearTimeout(d)}},[b,Nr,E,Me]),g.useEffect(()=>{if(window.BLOCK_AUTO_REGENERATION||u.length===0||E)return;const t=async()=>{if(window.BLOCK_AUTO_REGENERATION)return;const n=u.filter(s=>!oe[s.id]);if(n.length!==0)for(const s of n)try{const c=document.createElement("canvas");c.width=200,c.height=150;const d=c.getContext("2d");if(d.fillStyle=s.backgroundColor||"#ffffff",d.fillRect(0,0,200,150),s.backgroundImage)try{const m=new Image;m.crossOrigin="anonymous",await new Promise((p,v)=>{m.onload=p,m.onerror=v,m.src=s.backgroundImage}),d.drawImage(m,0,0,200,150)}catch(m){console.warn("No se pudo cargar imagen de fondo para miniatura:",m)}s.cells&&s.cells.forEach(m=>{m.elements&&m.elements.forEach(p=>{var v;p.type==="text"&&p.content&&(d.fillStyle=((v=p.style)==null?void 0:v.color)||"#000000",d.font="12px Arial",d.fillText(p.content.substring(0,20)+(p.content.length>20?"...":""),10,30))})});const h=c.toDataURL("image/jpeg",.7);await new Promise(m=>setTimeout(m,300))}catch(c){console.error("❌ Error generando miniatura de fondo para:",s.id,c)}},o=setTimeout(()=>{t()},2e3);return()=>clearTimeout(o)},[u,oe,E]),g.useEffect(()=>{const t=o=>{const n=W.current,s=te.current;if(n.length>0||s.size>0)return o.preventDefault(),o.returnValue="Hay cambios sin guardar. ¿Estás seguro de que quieres salir?",o.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),g.useEffect(()=>()=>{},[]);const dn=async()=>{var t;try{if(!i||!a||!(r!=null&&r.id))return!1;await tt(u,!0)||console.warn("⚠️ No se pudo guardar el progreso, pero continuando...");const n={design_data:{id:r.id,title:(i==null?void 0:i.name)||"Álbum Personalizado",pages:u,workspace_dimensions:q,created_at:new Date().toISOString()},item_data:{id:i==null?void 0:i.id,name:(i==null?void 0:i.name)||(i==null?void 0:i.title),price:i==null?void 0:i.price,user_id:i==null?void 0:i.user_id,width:i==null?void 0:i.width,height:i==null?void 0:i.height},preset_data:{id:a==null?void 0:a.id,width:a==null?void 0:a.width,height:a==null?void 0:a.height,cover_image:a==null?void 0:a.cover_image,content_layer_image:a==null?void 0:a.content_layer_image,final_layer_image:a==null?void 0:a.final_layer_image},dimensions:{width_mm:(a==null?void 0:a.width)||(i==null?void 0:i.width)||210,height_mm:(a==null?void 0:a.height)||(i==null?void 0:i.height)||297,workspace_width:(q==null?void 0:q.width)||800,workspace_height:(q==null?void 0:q.height)||600}};try{const P=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:r.id,status:"ready_for_pdf",pdf_data:n,completed_at:new Date().toISOString()})});if(P.ok){const j=await P.json()}else console.warn("⚠️ Error marcando proyecto como completado")}catch(P){console.warn("⚠️ Error en marcado de completado:",P)}const s=Date.now(),c=r.id;window.currentProjectId=c,window.albumProjectId=c;let d=a.cover_image;oe&&oe["page-cover"]&&(d=oe["page-cover"]);let h=d;d&&d.startsWith("data:image/")&&d.length>1e5&&(h=a.cover_image||"/assets/img/default-album.jpg");const m={...i,project_id:c,canvas_project_id:r.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:a.width,height_mm:a.height,pages_count:u.length,workspace_dimensions:q,requires_pdf_generation:!0}},p=structuredClone(Se),v=p.findIndex(P=>P.id==m.id);return v==-1?p.push({...m,quantity:1}):p[v].quantity++,Be(p),re.success("Álbum agregado al carrito",{description:`${m.name} se ha añadido al carrito. El PDF se generará en el backend.`,icon:e.jsx(Bn,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:p,action:"add",product:m}})),console.log("✅ [CART] Álbum agregado exitosamente, redirigiendo al carrito..."),setTimeout(()=>{console.log("🔄 [CART] Ejecutando redirección a /cart"),window.location.href="/cart"},2e3),!0}catch(o){return console.error("❌ === ERROR EN addAlbumToCart ==="),console.error("Error completo:",o),console.error("Stack trace:",o.stack),console.error("Mensaje del error:",o.message),re.error("Error al agregar al carrito",{description:`Error específico: ${o.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!u||u.length===0)throw new Error("No hay páginas para finalizar");const n={design_data:{pages:(j=>j.map($=>({id:$.id,type:$.type,pageNumber:$.pageNumber,layout:$.layout,cells:$.cells.map(L=>({id:L.id,elements:L.elements.map(y=>{const I={id:y.id,type:y.type,position:y.position,zIndex:y.zIndex||1};if(y.type==="image"){if(y.content.startsWith("data:image/")){const S=btoa(y.content.substring(0,100)).substring(0,20);I.content=`[BASE64_IMAGE_${S}]`,I.contentType=y.content.split(";")[0].split(":")[1],I.originalSize=y.content.length}else I.content=y.content;if(y.filters){const S=Object.entries(y.filters).filter(([F,M])=>M!==0&&M!==!1&&M!==null).reduce((F,[M,Q])=>(F[M]=Q,F),{});Object.keys(S).length>0&&(I.filters=S)}y.mask&&y.mask!=="none"&&(I.mask=y.mask),y.size&&(I.size=y.size),y.locked&&(I.locked=y.locked)}else if(y.type==="text"&&(I.content=y.content,y.style)){const S=Object.entries(y.style).filter(([F,M])=>!(F==="fontSize"&&M==="16px"||F==="color"&&M==="#000000"||F==="fontFamily"&&M==="Arial")).reduce((F,[M,Q])=>(F[M]=Q,F),{});Object.keys(S).length>0&&(I.style=S)}return I})}))})))(u),projectInfo:{id:r==null?void 0:r.id,item_id:i==null?void 0:i.id,title:i==null?void 0:i.title,preset_id:a==null?void 0:a.id},presetInfo:{id:a==null?void 0:a.id,name:a==null?void 0:a.name,cover_image:a==null?void 0:a.cover_image,content_image:a==null?void 0:a.content_image,back_cover_image:a==null?void 0:a.back_cover_image},workspace:{width:q.width,height:q.height,scale:q.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(oe).map(([j,$])=>[j,$]))},s=JSON.stringify(n),c=Math.round(s.length/1024),d=Math.round(c/1024*100)/100;let h=0,m=0;u.forEach(j=>{var $;($=j.cells)==null||$.forEach(L=>{var y;(y=L.elements)==null||y.forEach(I=>{I.type==="image"&&I.content&&I.content.startsWith("data:image/")&&(h++,m+=I.content.length)})})});const p=Math.round(m/(1024*1024)*100)/100;if(c>1024&&!confirm(`El diseño contiene ${h} imágenes (${p} MB en imágenes). Payload completo: ${d} MB. Esto podría causar problemas al guardarlo. ¿Desea continuar de todos modos?`))return!1;const v=await fetch(`/api/canvas/projects/${r.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:s});if(!v.ok){let j="Error al finalizar el diseño";try{j=(await v.json()).message||j}catch{v.status===413?j="El diseño es demasiado grande para ser guardado. Intente simplificar las imágenes.":v.status>=500&&(j="Error del servidor. Intente nuevamente más tarde.")}throw new Error(j)}const P=await v.json();return!0}catch(t){console.error("Error al finalizar diseño:",t);let o=t.message;return t.message.includes("Failed to fetch")?o="Error de conexión. Verifique su conexión a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(o="Error de red. Intente nuevamente más tarde."),alert("Error al finalizar el diseño: "+o),!1}};const un=g.useCallback(async()=>{try{const{jsPDF:t}=await hn(async()=>{const{jsPDF:S}=await import("./jspdf.es.min-CPZgRw3w.js").then(F=>F.j);return{jsPDF:S}},__vite__mapDeps([0,1,2,3,4]));let o=(a==null?void 0:a.width)||21,n=(a==null?void 0:a.height)||29.7;const s=.3,c=o+s*2,d=n+s*2,h=c*28.35,m=d*28.35,p=new t({orientation:h>m?"landscape":"portrait",unit:"pt",format:[h,m],compress:!1}),v=u.length;let P=0;const j=document.createElement("div");j.id="pdf-progress",j.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",j.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${v} páginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(j);const $=S=>{const F=S/v*100;document.getElementById("pdf-progress-bar").style.width=`${F}%`,document.getElementById("current-page").textContent=S},L=b;for(let S=0;S<u.length;S++){const F=u[S];ie(S),await new Promise(M=>setTimeout(M,500));try{const M=await Me({type:"pdf"});if(M){const Q=M.width/M.height,be=h/m;let ke,_e,Ae=0,ee=0;Q>be?(ke=h,_e=h/Q,ee=(m-_e)/2):(_e=m,ke=m*Q,Ae=(h-ke)/2);const ye=M.toDataURL("image/png",1);S>0&&p.addPage([h,m]),p.addImage(ye,"PNG",Ae,ee,ke,_e)}else console.warn(`⚠️ No se pudo capturar la página ${S+1}`),S>0&&p.addPage([h,m]),p.setFontSize(12),p.text(`Error al renderizar página ${S+1}`,h/2,m/2,{align:"center"})}catch(M){console.error(`❌ Error procesando página ${S+1}:`,M),S>0&&p.addPage([h,m]),p.setFontSize(12),p.text(`Error al procesar página ${S+1}`,h/2,m/2,{align:"center"})}P++,$(P),await new Promise(M=>setTimeout(M,200))}ie(L);const y=`${(i==null?void 0:i.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;p.save(y),document.body.removeChild(j);const I=document.createElement("div");return I.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",I.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${y}</span>
                </div>
            `,document.body.appendChild(I),setTimeout(()=>{document.body.contains(I)&&document.body.removeChild(I)},5e3),y}catch(t){console.error("❌ Error generando PDF:",t);const o=document.getElementById("pdf-progress");o&&document.body.removeChild(o);const n=document.createElement("div");throw n.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",n.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(n),setTimeout(()=>{document.body.contains(n)&&document.body.removeChild(n)},7e3),t}},[u,b,ie,Me,a,i]);return window.generateAlbumPDF=un,window.generateHighQualityThumbnail=Do,window.captureCurrentWorkspace=Me,window.startEditorTour=kt,window.resetEditorTourState=qo,window.checkTourStatus=()=>{const t=localStorage.getItem("bananalab_editor_tour_completed"),o=(r==null?void 0:r.user_id)||"anonymous",n=`bananalab_editor_tour_user_${o}`,s=localStorage.getItem(n);return{hasSeenTourGlobally:!!t,hasUserSeenTour:!!s,userId:o,shouldShowAutoTour:!t&&!s}},window.regenerateCurrentThumbnailNow=()=>{var o;const t=(o=u[b])==null?void 0:o.id;if(t){const n=u[b];let s=!1;n&&n.cells&&n.cells.forEach(c=>{c.elements&&c.elements.forEach(d=>{d.filters&&(d.filters.brightness!==100||d.filters.contrast!==100||d.filters.saturation!==100||d.filters.tint!==0||d.filters.hue!==0||d.filters.blur>0||d.filters.opacity!==100||d.filters.scale!==1||d.filters.rotate!==0||d.filters.flipHorizontal||d.filters.flipVertical)&&(s=!0,d._hasRealFilters=!0)})}),s&&(window.PRESERVE_FILTERS_FOR_PAGE=t,window.FORCE_FILTER_APPLICATION=!0),ne(c=>{const d={...c};return delete d[t],d})}return setTimeout(()=>{ae(!0),setTimeout(()=>{window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},100),"✅ Miniatura regenerada con éxito!"},window.generateThumbnailWithFilters=()=>{window.FORCE_FILTER_APPLICATION=!0;const t=Date.now();return window._filterCacheBreaker=t,window.regenerateCurrentThumbnailNow(),setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1},1e3),"✅ Miniatura con filtros regenerada exitosamente"},window.forceRegenerateWithGuaranteedFilters=async()=>{var o,n;const t=u[b];if(!t||!q)return console.error("❌ [RADICAL] Datos no disponibles"),!1;try{window._filterVerificationDone&&window._filterVerificationDone.clear(),window._currentPageData=t,window._workspaceDimensions=q,window._updateThumbnailInUI=(c,d)=>{ne(h=>({...h,[c]:d}))};const s=await ft(t,q);return s?(((o=t.elements)==null?void 0:o.some(d=>d.filters?Object.keys(d.filters).some(h=>h==="flipHorizontal"||h==="flipVertical"?d.filters[h]:h==="brightness"||h==="contrast"||h==="saturation"||h==="opacity"||h==="scale"?d.filters[h]!==1:h==="tint"||h==="hue"||h==="blur"||h==="rotate"?d.filters[h]!==0:!1):!1))&&((n=window.protectThumbnail)==null||n.call(window,t.id)),ne(d=>({...d,[t.id]:s})),!0):!1}catch(s){return console.error("❌ [RADICAL] Error:",s),!1}},window.safeRegenerateThumbnail=()=>(window._filterVerificationDone&&window._filterVerificationDone.clear(),ae(!0),"✅ Regeneración segura completada"),e.jsxs(pn,{backend:fn,className:"!h-screen !w-screen overflow-hidden",children:[E?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu álbum personalizado..."})]})}):_?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:_}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):u.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando páginas del álbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx("style",{children:`
                        /* Solo aplicar overflow visible en modo edición (no en preview ni captura) */
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] {
                            overflow: visible !important;
                        }
                        
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] > div {
                            overflow: visible !important;
                        }
                        
                        /* Mantener overflow hidden solo para el contenedor principal para evitar scroll */
                        .editor-workspace:not(.preview-mode) #page-${(jr=u[b])==null?void 0:jr.id} {
                            overflow: visible !important;
                        }
                        
                        /* En preview mode y captura, mantener overflow hidden para el resultado final */
                        .preview-mode [data-element-type="image"],
                        .capture-mode [data-element-type="image"] {
                            overflow: hidden !important;
                        }
                    `}),e.jsx(An,{isOpen:Yo,onRequestClose:()=>{ur(!1),en({isLoading:!1,loadedImages:0,totalImages:0,message:""}),ve({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:(()=>{if(!i){console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible, enviando todas las páginas");const n=ue.cover.concat(ue.content,ue.final).map(s=>({...s,layout:se.find(c=>c.id===s.layout)||se[0]}));return wr(n)}let t=[];(i.has_cover_image===!0||i.has_cover_image===1)&&(t=t.concat(ue.cover)),t=t.concat(ue.content),(i.has_back_cover_image===!0||i.has_back_cover_image===1)&&(t=t.concat(ue.final));const o=t.map(n=>({...n,layout:se.find(s=>s.id===n.layout)||se[0]}));return wr(o)})(),pageThumbnails:(()=>{if(!i)return console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible para filtrar thumbnails"),oe;const t={};let o=[];return(i.has_cover_image===!0||i.has_cover_image===1)&&(o=o.concat(ue.cover.map(n=>n.id))),o=o.concat(ue.content.map(n=>n.id)),(i.has_back_cover_image===!0||i.has_back_cover_image===1)&&(o=o.concat(ue.final.map(n=>n.id))),o.forEach(n=>{oe[n]&&(t[n]=oe[n])}),t})(),workspaceDimensions:q,getCurrentLayout:t=>t?se.find(o=>o.id===t.layout)||se[0]:se[0],presetData:a,addAlbumToCart:dn,projectData:r,itemData:i,contentType:fe,categorizedPages:ue,albumLoadingState:Zo}),ze.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-ze.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:ze.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:ze.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${ze.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[ze.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(Ln,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:ln,disabled:Te<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(bn,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:cn,disabled:Te>=Oe.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(xn,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(r==null?void 0:r.name)||"Álbum Sin Título",onChange:t=>l({...r,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del diseño"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(O.length>0||D)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:D?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",O.length]})]})}),e.jsx(Ca,{saveStatus:Le.saveStatus,lastSaved:Le.lastSaved,lastAutoSaved:Le.lastAutoSaved,hasUnsavedChanges:C.hasUnsavedChanges||!!(A instanceof Map&&A.has(b)),isOnline:Le.isOnline,saveError:Le.saveError,onManualSave:pr,saveQueueSize:O.length,isProcessingQueue:D,pageChangesCount:A instanceof Map?A.size:0}),O.length>0&&e.jsxs("button",{onClick:()=>{Mt()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(Oo,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(pt,{id:"preview-button",variant:"secondary",size:"sm",onClick:async t=>{t.preventDefault(),t.stopPropagation();try{ve({isOpen:!0,phase:"saving",progress:0,message:"💾 Guardando cambios",subMessage:"Asegurando que todo esté actualizado..."});try{await pr(),ve(m=>({...m,progress:15,message:"✅ Cambios guardados",subMessage:"Preparando vista previa..."})),await new Promise(m=>setTimeout(m,500))}catch(m){console.error("❌ [AUTO-SAVE] Error al guardar:",m),ve(p=>({...p,progress:10,message:"⚠️ Guardado parcial",subMessage:"Continuando con vista previa..."})),await new Promise(p=>setTimeout(p,300))}ve(m=>({...m,phase:"preparing",progress:15,message:`${fe.icon} Creando tu ${fe.name.toLowerCase()}`,subMessage:fe.type==="album"?"Preparando la experiencia completa de tu álbum...":fe.type==="catalog"?"Organizando tu catálogo de contenido...":fe.type==="booklet"?"Preparando tu folleto personalizado...":"Optimizando tu diseño único..."}));const o=fe.type==="album"?["🔧 Encuadernando páginas","📖 Ajustando tapas","✨ Puliendo detalles"]:fe.type==="catalog"?["📑 Organizando contenido","🎨 Optimizando diseño","⚡ Finalizando catálogo"]:fe.type==="booklet"?["📋 Preparando folleto","🖼️ Ajustando formato","✨ Aplicando estilo"]:["🎨 Procesando diseño","⚡ Optimizando calidad","✨ Finalizando vista"];for(let m=15;m<=30;m+=3){await new Promise(v=>setTimeout(v,fe.type==="card"?50:100));const p=Math.floor((m-15)/15*o.length);ve(v=>({...v,progress:m,message:o[Math.min(p,o.length-1)],subMessage:`Progreso: ${m}% - Optimizando para mejor experiencia...`}))}ve(m=>({...m,phase:"processing",message:`📷 Procesando ${fe.name.toLowerCase()}`,subMessage:"Generando vistas de alta calidad..."}));const n=await Ko((m,p)=>{const v=30+m/p*50;ve(P=>({...P,progress:Math.round(v),subMessage:`Procesando imagen ${m} de ${p}...`}))}),c={album:{message:"📖 Encuadernando álbum",sub:"Creando experiencia premium de lectura..."},catalog:{message:"📑 Organizando catálogo",sub:"Preparando navegación fluida..."},booklet:{message:"📋 Finalizando folleto",sub:"Ajustando formato profesional..."},card:{message:"🎨 Puliendo diseño",sub:"Aplicando toques finales..."}}[fe.type];ve(m=>({...m,phase:"finalizing",message:c.message,subMessage:c.sub}));for(let m=80;m<=100;m+=4)await new Promise(p=>setTimeout(p,fe.type==="card"?40:80)),ve(p=>({...p,progress:m}));const h={album:{message:"📖 ¡Tu álbum está listo!",sub:"Experiencia completa de lectura preparada"},catalog:{message:"📑 ¡Tu catálogo está listo!",sub:"Navegación profesional activada"},booklet:{message:"📋 ¡Tu folleto está listo!",sub:"Formato profesional completado"},card:{message:"🎨 ¡Tu diseño está listo!",sub:"Vista previa perfecta creada"}}[fe.type];ve(m=>({...m,phase:"ready",progress:100,message:h.message,subMessage:h.sub})),await new Promise(m=>setTimeout(m,1e3)),ve(m=>({...m,isOpen:!1})),ne(m=>({...m,...n})),setTimeout(()=>{ur(!0)},300)}catch(o){console.error(`❌ [${fe.type.toUpperCase()}-EXPERIENCE] Error en experiencia:`,o),ve(n=>({...n,message:"⚠️ Ups, algo salió mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{ve(n=>({...n,isOpen:!1}))},2e3)}},disabled:ze.isOpen,icon:e.jsx(yt,{className:"h-4 w-4"}),children:ze.isOpen?`Creando ${fe.name.toLowerCase()}...`:fe.description}),e.jsxs("button",{onClick:()=>{console.log("🎯 [MANUAL-TOUR] Usuario solicitó tour manual"),kt()},className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200 relative",title:"Inicia la guía paso a paso del editor",children:[e.jsx(Fn,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"}),(()=>{const t=localStorage.getItem("bananalab_editor_tour_completed"),n=`bananalab_editor_tour_user_${(r==null?void 0:r.user_id)||"anonymous"}`,s=localStorage.getItem(n);return!t&&!s?e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse",children:e.jsx("div",{className:"absolute inset-0 w-3 h-3 bg-red-500 rounded-full animate-ping opacity-75"})}):null})()]})]})]})}),e.jsxs("div",{className:`flex h-full ${z?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>xe("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(yt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Páginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>xe("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Vt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Diseños"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>xe("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ct,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>xe("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Y==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ao,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[Y==="templates"&&"Templates",Y==="images"&&"Images",Y==="text"&&"Text",Y==="shapes"&&"Shapes",Y==="stickers"&&"Stickers",Y==="pages"&&"Pages",Y==="panel"&&"Layers Panel",Y==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Y==="templates"&&"Choose a template to get started",Y==="images"&&"Search for images",Y==="text"&&"Add and edit text",Y==="shapes"&&"Add shapes and graphics",Y==="stickers"&&"Add fun stickers",Y==="pages"&&"Manage your pages",Y==="panel"&&"Organize layers and z-index",Y==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(Wn,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[Y==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Vt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Dn,{currentLayoutId:(kr=u[b])==null?void 0:kr.layout,onLayoutChange:nn})]}),Y==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ve,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Imágenes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[Pe.length," imagen",Pe.length!==1?"s":""]})]}),e.jsx(ka,{images:Pe,onImageSelect:rn,isLoading:jt})]}),Y==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>Bt("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"Título Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Et,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Bt("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subtítulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Et,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Bt("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Et,{className:"h-4 w-4"})})]})})]}),Y==="text"&&z&&((_r=Z())==null?void 0:_r.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(Gn,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=Z();ce(G,z,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((Ir=(Ar=Z())==null?void 0:Ar.style)==null?void 0:Ir.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=Z();ce(G,z,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((Pr=(Or=Z())==null?void 0:Or.style)==null?void 0:Pr.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=Z();ce(G,z,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((Lr=(Rr=Z())==null?void 0:Rr.style)==null?void 0:Lr.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipografía:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:(($r=(Mr=Z())==null?void 0:Mr.style)==null?void 0:$r.fontFamily)||"Arial",onChange:t=>{const o=Z();ce(G,z,{style:{...o.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tamaño:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Ur=(Br=Z())==null?void 0:Br.style)==null?void 0:Ur.fontSize)||"16px",onChange:t=>{const o=Z();ce(G,z,{style:{...o.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Fr=(zr=Z())==null?void 0:zr.style)==null?void 0:Fr.color)||"#000000",onChange:t=>{const o=Z();ce(G,z,{style:{...o.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((Wr=(Hr=Z())==null?void 0:Hr.style)==null?void 0:Wr.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Gr=(Vr=Z())==null?void 0:Vr.style)==null?void 0:Gr.backgroundColor)||"#ffffff",onChange:t=>{const o=Z();ce(G,z,{style:{...o.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=Z();ce(G,z,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"🚫"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var o,n;return e.jsxs("button",{onClick:()=>{const s=Z();ce(G,z,{style:{...s.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((n=(o=Z())==null?void 0:o.style)==null?void 0:n.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"⬅",t==="center"&&"⬌",t==="right"&&"➡",t==="justify"&&"⬍"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Kr=(qr=Z())==null?void 0:qr.style)==null?void 0:Kr.lineHeight)||"1.5",onChange:t=>{const o=Z();ce(G,z,{style:{...o.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Dr=(Jr=Z())==null?void 0:Jr.style)==null?void 0:Dr.letterSpacing)||"normal",onChange:t=>{const o=Z();ce(G,z,{style:{...o.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=Z();ce(G,z,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Yr=(Qr=Z())==null?void 0:Qr.style)==null?void 0:Yr.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAYÚS"]}),e.jsxs("button",{onClick:()=>{const t=Z();ce(G,z,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Zr=(Xr=Z())==null?void 0:Xr.style)==null?void 0:Zr.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"minús"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((to=(eo=Z())==null?void 0:eo.style)==null?void 0:to.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((oo=(ro=Z())==null?void 0:ro.style)==null?void 0:oo.opacity)||"1",onChange:t=>{const o=Z();ce(G,z,{style:{...o.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((ao=(no=Z())==null?void 0:no.style)==null?void 0:ao.opacity)||1)*100}%, #e5e7eb ${(((io=(so=Z())==null?void 0:so.style)==null?void 0:io.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),Y==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[u.length," total"]})]})}),Ze&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Ze.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Ze.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Ze.message||`Página: ${Ze.pageId||"actual"}`})]}),u.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando páginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[ue.cover.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),ue.cover.map((t,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${b===u.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>$t(u.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(qt,{pageId:t.id,thumbnail:Ye[t.id],altText:"Cover",type:"cover"}),A instanceof Map&&A.has&&A.has(u.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:ue.content.map((t,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${b===u.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>$t(u.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(qt,{pageId:t.id,thumbnail:Ye[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),A instanceof Map&&A.has&&A.has(u.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),ue.final.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),ue.final.map((t,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${b===u.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>$t(u.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(qt,{pageId:t.id,thumbnail:Ye[t.id],altText:"Back Cover",type:"final"}),A instanceof Map&&A.has&&A.has(u.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),Y==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Jn,{pages:u,currentPage:b,selectedCell:G,selectedElement:z,onSelectCell:pe,onSelectElement:X,onUpdateElement:(t,o,n)=>{ce(t,o,n)},onDeleteElement:(t,o)=>{ct(t,o)},onMoveElement:(t,o,n)=>{sn(t,o,n)}})}),Y==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Mn,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=Z();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ve,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Qn,{selectedMask:t.mask||"none",onSelect:o=>{ce(G,z,{mask:o})},availableMasks:Io.map(o=>o.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(vn,{filters:t.filters||{},onFilterChange:o=>{ce(G,z,{filters:o}),setTimeout(()=>{ae(!0)},50),setTimeout(()=>{ae(!0)},200),setTimeout(()=>{ae(!0)},500)},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(Ve,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:Z()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>xe("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Vt,{className:"h-4 w-4"}),"Diseño de página"]}),e.jsxs("button",{onClick:()=>xe("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Ct,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(pt,{variant:"ghost",tooltip:"Añadir Imagen",onClick:()=>Rt.current&&Rt.current.click(),children:e.jsx(Ve,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:Rt,onChange:tn,className:"hidden",accept:"image/*"})]}),z&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(pt,{variant:"ghost",size:"sm",onClick:()=>{if(z&&G){const t=Z();if(t){const o={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};ot(G,o)}}},className:"h-8 px-2",icon:e.jsx($n,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(pt,{variant:"ghost",size:"sm",onClick:()=>{z&&G&&ct(G,z)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(_o,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:`editor-workspace flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100 ${Dt?"preview-mode":""}`,children:Dt?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:q.width,height:q.height},children:e.jsx("div",{id:`page-${u[b].id}`,className:`grid ${je().template} gap-6`,style:{width:"100%",height:"100%"},children:u[b].cells.map((t,o)=>{var c;const n=je(),s=ja(n,o,q);return e.jsx(bo,{id:t.id,elements:t.elements.filter(d=>!d.locked),workspaceSize:s,cellStyle:(c=je().cellStyles)==null?void 0:c[u[b].cells.indexOf(t)],selectedElement:G===t.id?z:null,onSelectElement:yr,onAddElement:(d,h)=>ot(h,d),onUpdateElement:(d,h,m)=>ce(t.id,d,h,m),onDeleteElement:d=>ct(t.id,d),availableMasks:je().maskCategories.flatMap(d=>d.masks),projectData:r},t.id)})})})}):e.jsxs("div",{id:`page-${u[b].id}`,className:" shadow-xl overflow-hidden",style:{width:q.width,height:q.height,position:"relative",backgroundColor:((lo=u[b])==null?void 0:lo.backgroundColor)||"#ffffff",backgroundImage:(co=u[b])!=null&&co.backgroundImage?`url(${u[b].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=u[b];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${je().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((uo=je().style)==null?void 0:uo.gap)||"16px",padding:((mo=je().style)==null?void 0:mo.padding)||"16px"},children:u[b].cells.map(t=>{var o;return e.jsx(bo,{id:t.id,elements:t.elements.filter(n=>!n.locked),workspaceSize:q,cellStyle:(o=je().cellStyles)==null?void 0:o[u[b].cells.indexOf(t)],selectedElement:G===t.id?z:null,onSelectElement:yr,onAddElement:(n,s)=>ot(s,n),onUpdateElement:(n,s,c)=>ce(t.id,n,s,c),onDeleteElement:n=>ct(t.id,n),availableMasks:je().maskCategories.flatMap(n=>n.masks),projectData:r},t.id)})})]})})]})]})]}),e.jsx(_n,{})]})}export{Ls as default};
