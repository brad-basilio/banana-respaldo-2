import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as c}from"./index-BH53Isel.js";import{N as T}from"./Number2Currency-e57Tgsuk.js";import{b as Le,B as Se,a as Ae,D as at,A as ot,O as rt,I as nt,C as it}from"./OptionCard-D9TmqCXj.js";import{S as pe}from"./sparkles-DeLUn6av.js";import{c as Ie}from"./createLucideIcon-Cy5Ya80P.js";import{M as lt}from"./CartItemRow-aLzOG3-9.js";import{P as ct}from"./plus-Bot15Khs.js";import{T as dt}from"./trash-2-DK1wnsDn.js";import{X as Ge}from"./x-DBMwyD6F.js";import{m as mt}from"./main-Byrjfx4U.js";import{G as me}from"./Global-D6eBBAMK.js";import{t as G}from"./index-BJa4kPFi.js";import{I as oe}from"./InputForm-ZnsQvLid.js";import{S as ut}from"./SelectForm-CuEL0BKa.js";import{S as pt}from"./store-BlkTk2Px.js";import{l as xt}from"./ShippingStep-je273HZY.js";import{C as ue}from"./circle-x-p-TkKhsF.js";import{m as ie}from"./proxy-BdCOtp7i.js";import"./ProductNavigation-CwO_kLuA.js";import"./ProductCard-B4Ag8Mdr.js";/* empty css              */import"./BlogCarousel-BcMdR14t.js";/* empty css               */import"./BlogCarrusel-B3SD0Iql.js";import{R as ht}from"./PaymentModal-lELjrGc2.js";import{H as ft}from"./HtmlContent-FTivcJrM.js";import"./index-yBjzXJbu.js";import"./loader-circle-CrvBvIt1.js";import"./index-NIGUFBhG.js";import"./useStateManager-7e1e8489.esm-CxwdjZvi.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./hoist-non-react-statics.cjs-kbdZbs82.js";import"./index-fRpqIG3j.js";import"./index-B6ujFmsw.js";import"./floating-ui.dom-DKqDEs6p.js";import"./tippy-react.esm-_w2ZiBvC.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./chevron-down-DS-mdh9v.js";import"./search-TwiiKGP5.js";import"./check-DQ7QoS0v.js";import"./ItemsRest-DmQAXZCN.js";import"./BasicRest-DByHAxxD.js";import"./HeaderSearch-BLPm48RP.js";import"./index-CDbJJs-a.js";import"./eye-CKCH9ORv.js";import"./index-Chjiymov.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=Ie("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=Ie("OctagonX",[["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"M2.586 16.726A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2h6.624a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586z",key:"2d38gg"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=Ie("UserRoundX",[["path",{d:"M2 21a8 8 0 0 1 11.873-7",key:"74fkxq"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"m17 17 5 5",key:"p7ous7"}],["path",{d:"m22 17-5 5",key:"gqnmv0"}]]);function yt({onClick:n,className:S=""}){return e.jsxs("div",{className:`relative ${S}`,children:[e.jsx(pe,{size:12,className:"absolute -top-1 -left-1 text-yellow-400 animate-ping",style:{animationDelay:"0s"}}),e.jsx(pe,{size:10,className:"absolute -top-2 -right-1 text-pink-400 animate-ping",style:{animationDelay:"0.5s"}}),e.jsx(pe,{size:8,className:"absolute -bottom-1 -left-2 text-blue-400 animate-ping",style:{animationDelay:"1s"}}),e.jsx(pe,{size:14,className:"absolute -bottom-2 -right-2 text-purple-400 animate-ping",style:{animationDelay:"1.5s"}}),e.jsxs("button",{onClick:n,className:"relative group bg-primary p-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 animate-bounce cursor-pointer",style:{animationDuration:"2s",animationIterationCount:"infinite"},children:[e.jsx("div",{className:"absolute inset-0 bg-primary rounded-xl opacity-0 group-hover:opacity-50 transition-opacity duration-300 blur-lg"}),e.jsx(Ce,{size:24,className:"text-white relative z-10 drop-shadow-sm"}),e.jsx("div",{className:"absolute inset-0 bg-primary rounded-xl animate-pulse opacity-30"})]}),e.jsx("div",{className:"absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20",children:"¡Promoción disponible!"})]})}const bt=({setCart:n,hasPromotion:S,onPromotionClick:h,...g})=>{const P=()=>{n(w=>w.filter(d=>d.id!==g.id))},E=()=>{n(w=>w.map(d=>d.id===g.id?{...d,quantity:(d.quantity||1)+1}:d))},v=()=>{n(w=>w.map(d=>{if(d.id===g.id){const m=(d.quantity||1)-1;return m<=0?(P(g.id),null):{...d,quantity:m}}return d}).filter(Boolean))};return e.jsx("div",{className:"w-full bg-white rounded-lg shadow p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center  justify-between gap-4 w-full",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-grow",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:`/storage/images/item/${g.image}`,alt:g.name,className:"w-20 h-20 object-cover rounded flex-shrink-0",onError:w=>w.target.src="/api/cover/thumbnail/null"}),S&&e.jsx("div",{className:"absolute -top-2 -right-2",children:e.jsx(yt,{onClick:()=>h(g),className:"group"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium text-lg mb-2 line-clamp-2",children:g.name}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Marca: ",e.jsx("span",{className:"customtext-neutral-dark",children:g.brand.name})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Disponibilidad: ",e.jsxs("span",{className:"customtext-neutral-dark",children:[g.stock>=g.quantity?"En stock":"Agotado"," "]})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["SKU: ",e.jsx("span",{className:"customtext-neutral-dark",children:g.sku})]})]})]}),e.jsxs("div",{className:"flex flex-row justify-between md:flex-col items-end md:items-end gap-4 mt-4 md:mt-0 flex-shrink-0",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xs text-gray-500 line-through",children:["S/ ",Number(g.price*g.quantity).toFixed(2)]}),e.jsxs("div",{className:"font-bold text-lg",children:["S/ ",Number(g.final_price*g.quantity).toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center border border-gray-200 rounded-lg overflow-hidden shadow-sm",children:[e.jsx("button",{type:"button",onClick:v,className:"p-2 text-gray-600 hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary","aria-label":"Decrease quantity",children:e.jsx(lt,{size:16})}),e.jsx("div",{className:"w-12 h-8 flex justify-center items-center bg-white",children:e.jsx("span",{className:"font-semibold text-sm",children:g.quantity||1})}),e.jsx("button",{type:"button",onClick:E,className:"p-2 text-gray-600 hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary","aria-label":"Increase quantity",children:e.jsx(ct,{size:16})})]}),e.jsx("button",{onClick:P,className:"p-2 text-gray-400 hover:text-red-500 transition-colors duration-200 rounded-full hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-200","aria-label":"Remove item",children:e.jsx(dt,{size:18})})]})]})]})},g.id)};function jt({isOpen:n,onClose:S,suggestion:h,onAddToCart:g,productName:P}){const[E,v]=c.useState(!1);if(!n||!h)return null;const w=async()=>{v(!0);try{console.log("Modal - suggestion data:",h),await g(h),S()}catch(d){console.error("Error adding promotional item:",d)}finally{v(!1)}};return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity duration-300",onClick:S}),e.jsx("div",{className:"flex min-h-full items-center justify-center p-4",children:e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-auto transform transition-all duration-300 scale-100",children:[e.jsx("button",{onClick:S,className:"absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 transition-colors rounded-full hover:bg-gray-100",children:e.jsx(Ge,{size:20})}),e.jsxs("div",{className:"text-center pt-8 pb-6 px-6",children:[e.jsxs("div",{className:"relative inline-block mb-4",children:[e.jsx("div",{className:"animate-bounce",children:e.jsx(Ce,{size:48,className:"customtext-primary mx-auto"})}),e.jsx(pe,{size:20,className:"absolute -top-2 -right-2 text-yellow-400 animate-pulse"}),e.jsx(pe,{size:16,className:"absolute -bottom-1 -left-2 text-yellow-400 animate-pulse delay-300"})]}),e.jsx("h2",{className:"text-2xl font-bold customtext-neutral-dark mb-2",children:"🎉 ¡Promoción Especial!"}),e.jsx("p",{className:"text-gray-600",children:"Tienes un producto que califica para una promoción"})]}),e.jsxs("div",{className:"px-6 pb-6",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 mb-6",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Al tener  ",e.jsxs("span",{className:"font-semibold customtext-primary",children:[h.current_quantity," ",P]})," en tu carrito"]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 shadow-sm",children:[e.jsx("p",{className:"font-bold text-lg customtext-primary mb-1",children:h.rule_name}),e.jsx("p",{className:"text-sm customtext-neutral-light",children:h.description||"Obtén un producto gratis"})]})]})}),e.jsx("div",{className:"border-2 border-dashed rounded-xl p-4 mb-6 bg-green-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3 w-9/12",children:[e.jsx("div",{className:"w-12 h-12  rounded-full flex items-center justify-center",children:e.jsx(Ce,{className:"customtext-primary",size:24})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold customtext-neutral-dark",children:h.item_name}),e.jsxs("p",{className:"text-sm customtext-primary",children:["Cantidad: ",h.suggested_quantity]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-lg font-bold customtext-primary",children:"¡GRATIS!"}),e.jsxs("p",{className:"text-xs text-gray-500 line-through",children:["S/ ",Number(h.value||0).toFixed(2)]})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:w,disabled:E,className:"w-full bg-primary text-white font-semibold py-3 px-6 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:transform-none shadow-lg",children:E?e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Agregando..."})]}):e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(Ce,{size:20}),e.jsx("span",{children:"¡Agregar Regalo!"})]})}),e.jsx("button",{onClick:S,className:"w-full bg-gray-100 customtext-neutral-light font-medium py-3 px-6 rounded-xl hover:bg-gray-200 transition-colors duration-200",children:"Tal vez después"})]}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-4",children:"* Promoción válida mientras tengas los productos requeridos en tu carrito"})]})]})})]})}function vt({cart:n,setCart:S,onContinue:h,subTotal:g,envio:P,igv:E,totalFinal:v,openModal:w,automaticDiscounts:d,setAutomaticDiscounts:m,automaticDiscountTotal:s,setAutomaticDiscountTotal:f,totalWithoutDiscounts:o}){const[r,q]=c.useState(d||[]),[M,U]=c.useState(s||0),[A,J]=c.useState(!1),[le,Z]=c.useState([]),[K,X]=c.useState([]),[W,Q]=c.useState(!1),[te,re]=c.useState(null),[D,ce]=c.useState(null),Y=n.length===0;c.useEffect(()=>{if(n.length>0&&g>0)ne();else{const y=[];q(y),U(0),Z([]),X([]),m&&m(y),f&&f(0)}},[n,g]);const ne=async()=>{J(!0);try{const y=n.reduce((k,R)=>k+(R.quantity||0),0);console.log("🛒 CartStep applying discounts:",{cart:n,subTotal:g,totalWithoutDiscounts:o,totalQuantity:y,cartLength:n.length,cartItems:n.map(k=>({id:k.id||k.item_id,name:k.name,quantity:k.quantity,price:k.price||k.final_price,category_id:k.category_id}))});const u=await Le.applyToCart(n,o);if(console.log("📥 Server response:",{success:u.success,data:u.data,error:u.error,fullResult:u}),u.success&&u.data){console.log("✅ Discounts found:",u.data.applied_discounts);const k=Le.formatDiscounts(u.data.applied_discounts),R=u.data.total_discount||0,H=Le.getFreeItems(u.data.applied_discounts),se=[];u.data.applied_discounts.forEach(I=>{I.suggested_items&&Array.isArray(I.suggested_items)&&se.push(...I.suggested_items)}),q(k),U(R),Z(H),X(se),m&&m(k),f&&f(R)}else{console.error("❌ Discount application failed:",{error:u.error,success:u.success,data:u.data,fullResult:u});const k=[],R=0;q(k),U(R),Z([]),X([]),m&&m(k),f&&f(R)}}catch(y){console.error("Error applying discount rules:",y);const u=[],k=0;q(u),U(k),Z([]),X([]),m&&m(u),f&&f(k)}finally{J(!1)}},xe=y=>K.some(u=>u.item_id===y||u.triggering_item_id===y),he=y=>K.find(u=>u.item_id===y||u.triggering_item_id===y),j=y=>{const u=he(y.id);u&&(re(u),ce(y),Q(!0))},O=async y=>{try{console.log("CartStep - handleAddPromotionalItem received:",y),console.log("CartStep - current cart:",n),S(u=>{console.log("CartStep - old cart before update:",u);const k=u.findIndex(R=>(R.item_id||R.id)===y.item_id);if(console.log("CartStep - existingItemIndex:",k),k!==-1){const R=[...u],H=y.quantity||y.suggested_quantity||1;return console.log("CartStep - adding quantity:",H),R[k].quantity+=H,console.log("CartStep - updated cart:",R),R}else{console.log("CartStep - item not found, creating new product");const R={id:y.item_id,name:y.item_name,quantity:y.quantity||y.suggested_quantity||1,price:y.value||0,final_price:y.value||0,image:y.item_image||"default.jpg",brand:{name:y.item_brand||"N/A"},sku:y.item_sku||"PROMO",stock:999};return[...u,R]}}),setTimeout(()=>{ne()},100)}catch(u){console.error("Error adding promotional item:",u)}};return e.jsxs("div",{className:"grid lg:grid-cols-5 gap-4 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3 space-y-4 md:space-y-6",children:Y?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center animate-fade-in",children:[e.jsx("svg",{className:"w-24 h-24 text-gray-300 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-600 mb-2",children:"Tu carrito está vacío"}),e.jsx("p",{className:"text-gray-500",children:"¡Explora nuestros productos y encuentra algo especial!"})]}):n.map((y,u)=>e.jsx(bt,{...y,setCart:S,hasPromotion:xe(y.id),onPromotionClick:j},u))}),e.jsxs("div",{className:"lg:col-span-2 bg-[#F7F9FB] rounded-xl shadow-lg p-4 md:p-6 h-max mt-4 md:mt-0",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6",children:"Resumen"}),e.jsxs("div",{className:"space-y-3 md:space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold",children:["S/ ",T(g)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"IGV"}),e.jsxs("span",{className:"font-semibold",children:["S/ ",T(E)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Envío"}),e.jsxs("span",{className:"font-semibold",children:["S/ ",T(P)]})]}),A&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark",children:"Verificando descuentos..."}),e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"})]}),!A&&r.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6  customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),r.map((y,u)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[y.name,y.description&&e.jsx("span",{className:"text-xs font-semibold block",children:y.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-S/ ",T(y.amount)]})]},u)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-S/ ",T(M)]})]})]}),e.jsxs("div",{className:"py-3 border-y-2 mt-4 md:mt-6",children:[e.jsxs("div",{className:"flex justify-between font-bold text-lg md:text-[20px] items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["S/ ",T(v)]})]}),M>0&&e.jsxs("div",{className:"text-sm text-gray-500 mt-1",children:[e.jsxs("span",{className:"line-through",children:["S/ ",T(o||v+M)]}),e.jsxs("span",{className:"ml-2 customtext-neutral-dark font-semibold",children:["Ahorras S/ ",T(M)]})]})]}),e.jsxs("div",{className:"space-y-2 pt-3 md:pt-4",children:[e.jsx(Se,{onClick:h,className:"w-full",disabled:Y,children:Y?"Carrito Vacío":"Continuar Compra"}),e.jsx(Ae,{href:"/",className:"w-full",children:Y?"Ir a Comprar":"Cancelar"})]}),e.jsx("div",{children:e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>w(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>w(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})})]})]}),e.jsx(jt,{isOpen:W,onClose:()=>Q(!1),suggestion:te,onAddToCart:O,productName:(D==null?void 0:D.name)||""})]})}function Nt(){let n="";for(let S=0;S<12;S++){const h=Math.floor(Math.random()*10);n+=h}return n}const wt=n=>new Promise((S,h)=>{var g;try{if(console.log("🔄 Iniciando proceso de pago con Culqi...",n),typeof window.Culqi>"u"){console.error("❌ Error: Culqi no está definido. Verifique que el script de Culqi esté cargado."),h("Error en la integración con Culqi: Script no cargado");return}if(!me.CULQI_PUBLIC_KEY){console.error("❌ Error: CULQI_PUBLIC_KEY no está configurado"),h("Error de configuración: Clave pública de Culqi no encontrada");return}const P=Nt(n.email);console.log("📝 Número de orden generado:",P);let E=!1;try{window.Culqi.publicKey=me.CULQI_PUBLIC_KEY,console.log("✅ Clave pública configurada exitosamente")}catch(s){console.error("❌ Error al configurar la clave pública:",s),h("Error en la integración con Culqi: No se pudo configurar la clave pública");return}const v=parseFloat(n.amount.toFixed(2)),w=Math.round(v*100);console.log("💰 Configurando Culqi:"),console.log("   - Monto original:",n.amount),console.log("   - Monto redondeado (soles):",v),console.log("   - Monto en céntimos:",w),console.log("   - Email:",n.email),window.Culqi.settings({title:me.APP_NAME,email:n.email,currency:"PEN",amount:w,order:`${P}`}),console.log(window.Culqi.settings),window.Culqi.options({lang:"es",installments:!1,paymentMethods:{tarjeta:!0,yape:!0,bancaMovil:!0,agente:!0,billetera:!0,cuotealo:!0},style:{logo:me.APP_URL+"/assets/resources/logo.png",bannerColor:me.APP_COLOR_PRIMARY,buttonBackground:me.APP_COLOR_PRIMARY}});const d=(g=window.Culqi)==null?void 0:g.close;d&&(window.Culqi.close=function(){return!window.Culqi.token&&!E&&(console.log("🚫 Modal de Culqi cerrado sin completar el pago"),h("Pago cancelado por el usuario")),d.apply(this,arguments)}),window.Culqi.open(),window.culqi=async function(){try{if(!window.Culqi.token){h("No se obtuvo un token de Culqi");return}E=!0;const s=window.Culqi.token.id;console.log("✅ Token generado:",s),n={...n,token:s,orderNumber:P},console.log("_request actualizado",n);const{status:f,result:o}=await mt.Fetch("./api/pago",{method:"POST",body:JSON.stringify(n)});f||console.log((o==null?void 0:o.message)||"Error en el pago"),window.Culqi.close(),G.success("¡Pago exitoso!",{description:"Tu pago se procesó correctamente. Pronto recibirás la confirmación de tu pedido.",duration:3e3,position:"top-right",richColors:!0}),S(o)}catch(s){G.error("¡Error en el Pago!",{description:s.message,duration:3e3,position:"top-right",richColors:!0}),h(s.message||"Error en el pago")}},window.addEventListener("message",function(s){s.data==="culqi_closed"&&h("Pago cancelado por el usuario")});const m=s=>{s.key==="Escape"&&!E&&(console.log("🚫 Modal de Culqi cerrado con Escape"),h("Pago cancelado por el usuario"))};document.addEventListener("keydown",m),setTimeout(()=>{document.removeEventListener("keydown",m)},3e5),document.addEventListener("culqi.error",function(s){var f,o;G.error("¡Error en Culqi!",{description:((f=s.detail)==null?void 0:f.message)||"Error desconocido",duration:3e3,position:"top-right",richColors:!0}),h(((o=s.detail)==null?void 0:o.message)||"Error desconocido")})}catch(P){G.error("¡Error en la integración con Culqi!",{description:P.message,duration:3e3,position:"top-right",richColors:!0}),h("Error en la integración con Culqi")}}),kt=({ubigeoCode:n,onStoreSelect:S,selectedStore:h=null,className:g=""})=>{const[P,E]=c.useState([]),[v,w]=c.useState(!1),[d,m]=c.useState(null);c.useEffect(()=>{n&&s()},[n]);const s=async()=>{w(!0),m(null);try{const r=await(await fetch("/api/stores")).json();E(r.data||[])}catch{E([])}finally{w(!1)}},f=o=>{S(o)};return v?e.jsxs("div",{className:`text-center p-6 ${g}`,children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-primary/10 rounded-full mb-4",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}),e.jsx("h3",{className:"text-lg font-semibold customtext-neutral-dark mb-2",children:"Cargando tiendas..."}),e.jsx("p",{className:"customtext-neutral-light text-sm",children:"Buscando tiendas disponibles en tu ubicación"})]}):d?e.jsxs("div",{className:`bg-red-50 border border-red-200 rounded-xl p-4 md:p-6 ${g}`,children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4",children:e.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("h3",{className:"text-lg font-semibold text-red-800 text-center mb-2",children:"Error al cargar tiendas"}),e.jsx("p",{className:"text-red-600 text-center text-sm",children:d})]}):P.length===0?e.jsxs("div",{className:`bg-secondary/30 border border-secondary rounded-xl p-4 md:p-6 ${g}`,children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-secondary rounded-full mx-auto mb-4",children:e.jsx("svg",{className:"w-6 h-6 customtext-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("h3",{className:"text-lg font-semibold customtext-neutral-dark text-center mb-2",children:"Sin tiendas disponibles"}),e.jsx("p",{className:"customtext-neutral-light text-center text-sm",children:"No hay tiendas disponibles para retiro en esta ubicación. Por favor, selecciona otra opción de envío."})]}):e.jsxs("div",{className:g,children:[e.jsxs("div",{className:"mb-4 md:mb-6",children:[e.jsx("h3",{className:"text-lg md:text-xl font-semibold customtext-neutral-dark mb-2",children:"Selecciona una tienda para retiro"}),e.jsx("p",{className:"customtext-neutral-light text-sm md:text-base",children:"Elige la tienda más conveniente para retirar tu pedido"})]}),e.jsx("div",{className:"space-y-3 md:space-y-4",children:P.map(o=>e.jsxs("div",{className:`relative border-2 rounded-xl p-3 md:p-4 cursor-pointer transition-all duration-200 hover:shadow-lg ${(h==null?void 0:h.id)===o.id?"border-primary bg-primary/5 shadow-md":"border-secondary bg-white hover:border-primary/50 hover:shadow-md"}`,onClick:()=>f(o),children:[e.jsx("div",{className:"absolute top-3 md:top-4 right-3 md:right-4",children:e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${(h==null?void 0:h.id)===o.id?"border-primary bg-primary":"border-secondary bg-white"}`,children:(h==null?void 0:h.id)===o.id&&e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 md:gap-4 pr-8",children:[e.jsx("div",{className:"flex-shrink-0 hidden lg:block md:mx-0",children:o.image?e.jsx("img",{src:`/storage/images/store/${o.image}`,alt:o.name,className:"w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg border border-secondary"}):e.jsx("div",{className:"w-16 h-16 md:w-20 md:h-20 bg-secondary rounded-lg border border-secondary flex items-center justify-center",children:e.jsx(pt,{className:"customtext-primary"})})}),e.jsxs("div",{className:"flex-1 min-w-0 text-left md:text-left",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-center md:items-start gap-2 mb-2",children:[e.jsx("h4",{className:"font-semibold customtext-neutral-dark text-base md:text-lg truncate",children:o.name}),e.jsx("span",{className:`hidden lg:block px-2 py-1 rounded-full text-xs font-medium ${o.type==="tienda"?"bg-primary/10 customtext-primary":o.type==="oficina"||o.type==="almacen"?"bg-secondary customtext-neutral-dark":o.type==="showroom"?"bg-primary/10 customtext-primary":"bg-secondary customtext-neutral-dark"}`,children:o.type==="tienda"?"Tienda":o.type==="oficina"?"Oficina":o.type==="almacen"?"Almacén":o.type==="showroom"?"Showroom":o.type||"Otro"})]}),e.jsx("p",{className:"text-sm customtext-neutral-light mb-3 line-clamp-3",children:o.address}),e.jsxs("div",{className:"flex flex-col md:flex-row md:flex-wrap gap-2 md:gap-4 text-sm customtext-neutral-light mb-3",children:[o.phone&&e.jsxs("div",{className:"flex items-center justify-start md:justify-start gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})}),e.jsx("span",{children:o.phone})]}),o.manager&&e.jsxs("div",{className:"flex items-center justify-start md:justify-start gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),e.jsxs("span",{className:"text-center md:text-left",children:["Encargado: ",o.manager]})]})]}),o.business_hours&&e.jsxs("div",{className:"bg-gray-100 rounded-lg p-3 mt-3",children:[e.jsx("div",{className:"text-xs font-medium customtext-neutral-dark mb-2",children:"Horarios de atención:"}),e.jsx("div",{className:"text-xs customtext-neutral-light",children:(()=>{try{const r=typeof o.business_hours=="string"?JSON.parse(o.business_hours):o.business_hours,q=new Date().toLocaleDateString("es-PE",{weekday:"long"}),U={lunes:"Lunes",martes:"Martes",miércoles:"Miércoles",jueves:"Jueves",viernes:"Viernes",sábado:"Sábado",domingo:"Domingo"}[q.toLowerCase()]||q,A=r.find(J=>J.day.toLowerCase()===U.toLowerCase());if(A){const J=A.closed?"Hoy: Cerrado":`Hoy: ${A.open} - ${A.close}`,le=!A.closed&&(()=>{const Z=new Date,K=Z.getHours()*60+Z.getMinutes(),[X,W]=A.open.split(":").map(Number),[Q,te]=A.close.split(":").map(Number),re=X*60+W,D=Q*60+te;return K>=re&&K<=D})();return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:J}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${le?"bg-primary/10 customtext-primary":"bg-red-100 text-red-800"}`,children:le?"Abierto":"Cerrado"})]})}return"Horarios disponibles"}catch{return"Horarios disponibles"}})()})]}),o.description&&e.jsx("div",{className:"hidden lg:block mt-3 pt-3 border-t border-secondary",children:e.jsx("p",{className:"text-sm customtext-neutral-light text-center md:text-left",children:o.description})})]})]})]},o.id))})]})};function Ct({cart:n,setSale:S,setCode:h,setDelivery:g,setCart:P,onContinue:E,noContinue:v,subTotal:w,igv:d,totalFinal:m,user:s,setEnvio:f,envio:o,ubigeos:r=[],openModal:q,setCouponDiscount:M,setCouponCode:U,automaticDiscounts:A=[],automaticDiscountTotal:J=0,totalWithoutDiscounts:le,conversionScripts:Z,setConversionScripts:K,onPurchaseComplete:X}){var He;const[W,Q]=c.useState(null),[te,re]=c.useState(null),[D,ce]=c.useState([]),[Y,ne]=c.useState(0);D.reduce((t,a)=>a.free_items&&Array.isArray(a.free_items)?[...t,...a.free_items]:t,[]);const xe=(t,a)=>{var N;let b=[],C=0;for(const i of a)switch(i.type){case"buy_x_get_y":{t.forEach(p=>{var x;if((x=i.product_ids)!=null&&x.includes(p.id)){const l=Math.floor(p.quantity/(i.buy+i.get));if(l>0&&i.get>0){const $=l*i.get,ae=$*p.final_price;b.push({name:i.name,amount:ae,description:i.description,free_items:[{...p,quantity:$}]}),C+=ae}}});break}case"quantity_discount":{t.forEach(p=>{var x;if((x=i.product_ids)!=null&&x.includes(p.id)){const l=Math.floor(p.quantity/i.buy);if(l>0&&i.pay<i.buy){const $=l*(i.buy-i.pay)*p.final_price;b.push({name:i.name,amount:$,description:i.description}),C+=$}}});break}case"tiered_discount":{t.forEach(p=>{var x;if((x=i.product_ids)!=null&&x.includes(p.id)){const l=Math.floor(p.quantity/i.tier);if(l>0&&i.free>0){const $=l*i.free,ae=$*p.final_price;b.push({name:i.name,amount:ae,description:i.description,free_items:[{...p,quantity:$}]}),C+=ae}}});break}case"category_discount":{t.forEach(p=>{var x;if((x=i.category_ids)!=null&&x.includes(p.category_id)){const l=p.final_price*p.quantity*(i.percent/100);l>0&&(b.push({name:i.name,amount:l,description:i.description}),C+=l)}});break}case"cart_discount":{const p=t.reduce((x,l)=>x+l.final_price*l.quantity,0);if(p>=(i.min_total||0)){const x=i.percent?p*(i.percent/100):i.amount||0;x>0&&(b.push({name:i.name,amount:x,description:i.description}),C+=x)}break}case"bundle_discount":{((N=i.product_ids)==null?void 0:N.every(x=>t.some(l=>l.id===x)))&&i.amount>0&&(b.push({name:i.name,amount:i.amount,description:i.description}),C+=i.amount);break}}return{discounts:b,totalDiscount:C}};c.useEffect(()=>{if(A&&Array.isArray(A)&&A.length>0){const{discounts:t,totalDiscount:a}=xe(n,A);ce(t),ne(a)}else ce([]),ne(0)},[n,A]);const he=[{value:"dni",label:"DNI"},{value:"ruc",label:"RUC"},{value:"ce",label:"CE"},{value:"pasaporte",label:"Pasaporte"}],[j,O]=c.useState({name:(s==null?void 0:s.name)||"",lastname:(s==null?void 0:s.lastname)||"",email:(s==null?void 0:s.email)||"",phone:(s==null?void 0:s.phone)||"",documentType:((He=s==null?void 0:s.document_type)==null?void 0:He.toLowerCase())||"",document:(s==null?void 0:s.document_number)||"",department:(s==null?void 0:s.department)||"",province:(s==null?void 0:s.province)||"",district:(s==null?void 0:s.district)||"",address:(s==null?void 0:s.address)||"",number:(s==null?void 0:s.number)||"",comment:"",reference:(s==null?void 0:s.reference)||"",ubigeo:(s==null?void 0:s.ubigeo)||null});c.useEffect(()=>{if(s!=null&&s.ubigeo&&(s!=null&&s.district)&&(s!=null&&s.province)&&(s!=null&&s.department)){const t={value:s.ubigeo,label:`${s.district}, ${s.province}, ${s.department}`,data:{reniec:s.ubigeo,departamento:s.department,provincia:s.province,distrito:s.district}};re(t),Q(t),Ve(t)}},[s]),c.useEffect(()=>{s&&O(t=>{var a;return{...t,name:s.name||t.name,lastname:s.lastname||t.lastname,email:s.email||t.email,phone:s.phone||t.phone,documentType:((a=s.document_type)==null?void 0:a.toLowerCase())||t.documentType,document:s.document_number||t.document,department:s.department||t.department,province:s.province||t.province,district:s.district||t.district,address:s.address||t.address,number:s.number||t.number,reference:s.reference||t.reference,ubigeo:s.ubigeo||t.ubigeo}})},[s]);const[y,u]=c.useState(!1),[k,R]=c.useState(!1),[H,se]=c.useState([]),[I,F]=c.useState(null),[ee,_e]=c.useState(null),[_,V]=c.useState({}),[Ee,ye]=c.useState(""),[be,je]=c.useState(!1),[de,ze]=c.useState(""),[L,Oe]=c.useState(null),[qe,Pe]=c.useState(0),[ve,Fe]=c.useState(!1),[Te,fe]=c.useState(""),[Ne,Me]=c.useState(null),[Ke,De]=c.useState(!1),[Xe,Re]=c.useState(!1),We=t=>{Me(t),V(a=>({...a,store:""}))},Qe=t=>{var b,C,N;const a=["name","lastname","documentType","document","email","phone","ubigeo","address","shipping"];for(const i of a)if(t[i]){let p=null,x=!1;if(i==="ubigeo"?p=((C=(b=document.querySelector('[name="ubigeo"]'))==null?void 0:b.parentElement)==null?void 0:C.parentElement)||document.querySelector(".css-1s2u09g-control")||document.querySelector('[class*="react-select"]'):i==="shipping"?p=((N=document.querySelector('input[name="shipping"]'))==null?void 0:N.closest(".space-y-4"))||document.querySelector(".space-y-4 h3")||document.querySelector("h3"):(p=document.querySelector(`[name="${i}"]`),x=!0),p){p.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),x&&setTimeout(()=>{try{p.focus(),p.tagName==="INPUT"&&p.type==="text"&&p.select()}catch(l){console.warn("No se pudo enfocar el elemento:",l)}},600),Ye(p);break}}},Ye=t=>{if(!t)return;const a=document.createElement("div");if(a.style.cssText=`
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #ef4444;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1000;
            animation: pulse 0.6s ease-in-out;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        `,!document.querySelector("#error-highlight-styles")){const C=document.createElement("style");C.id="error-highlight-styles",C.textContent=`
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.02); opacity: 0.8; }
                    100% { transform: scale(1); opacity: 1; }
                }
            `,document.head.appendChild(C)}const b=t.style.position;(!b||b==="static")&&(t.style.position="relative"),t.appendChild(a),setTimeout(()=>{a.parentNode&&(a.parentNode.removeChild(a),(!b||b==="static")&&(t.style.position=b))},1200)},Ve=async t=>{var b,C,N,i,p;if(!t)return;V(x=>({...x,ubigeo:""}));const{data:a}=t;O(x=>({...x,department:a.departamento,province:a.provincia,district:a.distrito,ubigeo:a.reniec})),u(!0);try{const x=n.reduce((B,ke)=>B+ke.final_price*ke.quantity,0);console.log("🛒 ShippingStep - Cart total calculado:",x),console.log("🛒 ShippingStep - Cart items:",n.map(B=>({name:B.name,price:B.final_price,quantity:B.quantity,total:B.final_price*B.quantity}))),console.log("💰 ShippingStep - Comparación de totales:"),console.log("   - Cart total (solo productos):",x),console.log("   - SubTotal prop:",w),console.log("   - IGV prop:",d),console.log("   - Total con IGV:",w+d),console.log("   - Total final prop:",m);const l=await at.getShippingCost({ubigeo:a.reniec,cart_total:x});console.log("📦 ShippingStep - Respuesta del backend:",l.data),console.log("✅ ShippingStep - Califica para envío gratis?",l.data.qualifies_free_shipping),console.log("💰 ShippingStep - Umbral requerido:",l.data.free_shipping_threshold),console.log("🔍 ShippingStep - is_free:",l.data.is_free),console.log("🔍 ShippingStep - Descripción standard:",(b=l.data.standard)==null?void 0:b.description),console.log("🔍 ShippingStep - Tipo standard:",(C=l.data.standard)==null?void 0:C.type);const $=[];let ae=!1;if(l.data.is_free&&l.data.qualifies_free_shipping&&(console.log("✅ ShippingStep - Es zona is_free=true Y califica por monto - Agregando envío GRATIS"),$.push({type:"free",price:0,description:l.data.standard.description,deliveryType:l.data.standard.type,characteristics:l.data.standard.characteristics})),l.data.standard&&(!l.data.is_free||l.data.is_free&&!l.data.qualifies_free_shipping)){console.log("📦 ShippingStep - Agregando envío NORMAL");let B=l.data.standard.description;l.data.is_free||(B=B.replace(/envío gratis.*?/gi,"").replace(/envio gratis.*?/gi,"").replace(/gratis.*?compras.*?/gi,"").replace(/mayor.*?200.*?/gi,"").replace(/200.*?mayor.*?/gi,"").replace(/\s+/g," ").trim(),B||(B="Delivery a domicilio")),$.push({type:"standard",price:l.data.standard.price,description:B,deliveryType:l.data.standard.type,characteristics:l.data.standard.characteristics})}l.data.express&&l.data.express.price>0&&(console.log("⚡ ShippingStep - Agregando envío EXPRESS"),$.push({type:"express",price:l.data.express.price,description:l.data.express.description,deliveryType:l.data.express.type,characteristics:l.data.express.characteristics})),l.data.is_agency&&l.data.agency&&(console.log("🏢 ShippingStep - Agregando envío por AGENCIA"),$.push({type:"agency",price:l.data.agency.price||0,description:l.data.agency.description,deliveryType:l.data.agency.type,characteristics:l.data.agency.characteristics})),l.data.is_store_pickup&&(console.log("🏪 ShippingStep - Retiro en tienda disponible"),ae=!0),ae||l.data.is_store_pickup?($.some(ke=>ke.type==="store_pickup")||(l.data.store_pickup?$.push({type:"store_pickup",price:l.data.store_pickup.price,description:l.data.store_pickup.description,deliveryType:l.data.store_pickup.type,characteristics:l.data.store_pickup.characteristics}):$.push({type:"store_pickup",price:0,description:"Retira tu pedido en una de nuestras tiendas",deliveryType:"Retiro en Tienda",characteristics:["Sin costo de envío","Horarios flexibles","Atención personalizada"]})),De(!0)):(De(!1),Me(null)),se($),F(((N=$[0])==null?void 0:N.type)||null),f(((i=$[0])==null?void 0:i.price)||0),je(!1),console.log("📋 ShippingStep - Opciones finales de envío:",$),console.log("🚚 ShippingStep - Precio de envío seleccionado:",((p=$[0])==null?void 0:p.price)||0)}catch{G.error("Sin cobertura",{description:"No realizamos envíos a esta ubicación.",icon:e.jsx($e,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"}),se([]),F(null),f(0),je(!1)}u(!1)},Be=async t=>{var N,i;if(t.preventDefault(),k)return;if(!s){Re(!0);return}const a={},b=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,C=/^[0-9]{9}$/;if(j.name.trim()||(a.name="Nombre es requerido"),j.lastname.trim()||(a.lastname="Apellido es requerido"),j.documentType.trim()||(a.documentType="Tipo de documento es requerido"),j.document.trim()||(a.document="Número de documento es requerido"),j.email.trim()?b.test(j.email)||(a.email="Email inválido"):a.email="Email es requerido",j.phone.trim()?C.test(j.phone.trim())||(a.phone="Teléfono debe tener exactamente 9 dígitos"):a.phone="Teléfono es requerido",j.ubigeo||(a.ubigeo="Ubicación es requerida"),j.address||(a.address="Dirección es requerida"),I||(a.shipping="Seleccione un método de envío"),Object.keys(a).length>0){V(a);const p=Object.keys(a)[0],x={name:"Por favor ingrese su nombre",lastname:"Por favor ingrese su apellido",documentType:"Por favor seleccione el tipo de documento",document:"Por favor ingrese su número de documento",email:(N=a.email)!=null&&N.includes("inválido")?"Por favor ingrese un correo electrónico válido":"Por favor ingrese su correo electrónico",phone:(i=a.phone)!=null&&i.includes("9 dígitos")?"El teléfono debe tener exactamente 9 dígitos":"Por favor ingrese su número de teléfono",ubigeo:"Por favor seleccione su ubicación de entrega",address:"Por favor ingrese su dirección de entrega",shipping:"Por favor seleccione un método de envío"};G.error("Complete el campo requerido",{description:x[p],icon:e.jsx(ue,{className:"h-5 w-5 text-red-500"}),duration:4e3,position:"top-center"}),Qe(a);return}R(!0);try{const p={user_id:s.id,...j,fullname:`${j.name} ${j.lastname}`,country:"Perú",document_type:j.documentType,amount:z(we),delivery:z(o),delivery_type:I,store_id:I==="store_pickup"?Ne==null?void 0:Ne.id:null,cart:n,coupon_id:(L==null?void 0:L.id)||null,coupon_code:(L==null?void 0:L.code)||null,coupon_discount:z(qe||0),applied_promotions:A||[],promotion_discount:z(J||0)};console.log("📦 Request completo a enviar:",p),console.log("💰 Monto final con cupón:",we),console.log("🎟️ Descuento del cupón:",qe),console.log("🚚 Costo de envío:",o);const x=await wt(p);if(console.log("📋 Respuesta completa del procesamiento:",x),x.status){if(console.log("✅ Pago exitoso, procesando respuesta..."),S(x.sale),g(x.delivery),h(x.code),x.conversion_scripts&&(console.log("Scripts de conversión recibidos:",x.conversion_scripts),K(x.conversion_scripts),X)){console.log("🎯 Ejecutando callback onPurchaseComplete...");try{await X(x.sale_id,x.conversion_scripts),console.log("✅ Callback onPurchaseComplete ejecutado exitosamente")}catch(l){console.error("❌ Error en callback onPurchaseComplete:",l)}}console.log("🛒 Limpiando carrito y continuando..."),P([]),E()}else console.log("❌ Pago rechazado:",x),G.error("Error en el pago",{description:x.message||"Pago rechazado",icon:e.jsx($e,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}catch(p){console.error("💥 Error completo en handlePayment:",p),console.error("💥 Stack trace:",p.stack),console.error("💥 Error name:",p.name),console.error("💥 Error message:",p.message),G.error("Lo sentimos, no puede continuar con la compra",{description:`Ocurrió un error al procesar el pedido: ${p.message}`,icon:e.jsx($e,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"bottom-center"})}finally{R(!1)}},Je=c.useCallback(xt.debounce((t,a)=>{if(t.length<3){a([]);return}fetch(`/api/ubigeo/search?q=${encodeURIComponent(t)}`).then(b=>{if(!b.ok)throw new Error("Error en la respuesta");return b.json()}).then(b=>{const C=b.map(N=>({value:N.reniec,label:`${N.distrito}, ${N.provincia}, ${N.departamento}`,data:{inei:N.inei,reniec:N.reniec,departamento:N.departamento,provincia:N.provincia,distrito:N.distrito}}));a(C)}).catch(b=>{a([])})},300),[]);c.useEffect(()=>{V(t=>{const a={...t};return j.name.trim()&&delete a.name,j.lastname.trim()&&delete a.lastname,j.documentType.trim()&&delete a.documentType,j.document.trim()&&delete a.document,j.email.trim()&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(j.email)&&delete a.email,j.phone.trim()&&/^[0-9]{9}$/.test(j.phone.trim())&&delete a.phone,j.address.trim()&&delete a.address,j.ubigeo&&delete a.ubigeo,I&&delete a.shipping,a})},[j,I]);const Ze=t=>({control:a=>({...a,border:`1px solid ${t?"#ef4444":"#e5e7eb"}`,boxShadow:"none",minHeight:"50px","&:hover":{borderColor:t?"#ef4444":"#6b7280"},borderRadius:"0.75rem",padding:"2px 8px"}),menu:a=>({...a,zIndex:9999,marginTop:"4px",borderRadius:"8px"}),option:a=>({...a,color:"#1f2937",backgroundColor:"white","&:hover":{backgroundColor:"#f3f4f6"},padding:"12px 16px"})}),et=async()=>{var t;if(!de.trim()){fe("Ingrese un código de cupón");return}Fe(!0),fe("");try{const a=[...new Set(n.map(i=>i.category_id).filter(Boolean))],b=n.map(i=>i.id);console.log("Validando cupón:",{code:de.trim(),cart_total:w,category_ids:a,product_ids:b});const C=await it.validateCoupon({code:de.trim(),cart_total:w,category_ids:a,product_ids:b});console.log("Respuesta del cupón:",C);const N=C.data||C;if(N&&N.valid){Oe(N.coupon);const i=Math.round(N.discount*100)/100;Pe(i),M&&M(i),U&&U(((t=N.coupon)==null?void 0:t.code)||de.trim()),G.success("Cupón aplicado",{description:N.message||"Cupón aplicado correctamente",duration:3e3,position:"top-center"})}else{const i=(N==null?void 0:N.message)||"Cupón no válido";fe(i),G.error("Cupón no válido",{description:i,icon:e.jsx(ue,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}}catch(a){console.error("Error al validar cupón:",a),fe("Error al validar el cupón"),G.error("Error",{description:a.message||"No se pudo validar el cupón. Intente nuevamente.",icon:e.jsx(ue,{className:"h-5 w-5 text-red-500"}),duration:3e3,position:"top-center"})}finally{Fe(!1)}},tt=()=>{Oe(null),Pe(0),ze(""),fe(""),M&&M(0),U&&U(""),G.success("Cupón removido",{description:"El cupón ha sido removido de su pedido",duration:2e3,position:"top-center"})},z=t=>{const a=typeof t=="string"?parseFloat(t):t;return parseFloat(a.toFixed(2))},Ue=z(w)+z(d)+z(o)-z(Y);let ge=0;L&&(L.type==="percentage"||L.type==="percent"?ge=Ue*Number(L.value)/100:L.type==="fixed"&&(ge=Number(L.value))),c.useEffect(()=>{Pe(z(ge)),M&&M(z(ge))},[L,w,d,o,Y]);const we=Math.max(0,z(Ue-ge)),st=()=>{if(!Xe)return null;const t=a=>{a.target===a.currentTarget&&Re(!1)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:t,children:e.jsx("div",{className:"bg-white rounded-xl p-6 max-w-md w-full shadow-2xl transform transition-all",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4",children:e.jsx(gt,{className:"h-8 w-8 customtext-primary"})}),e.jsx("h2",{className:"text-2xl font-bold customtext-neutral-dark mb-3",children:"Acceso requerido"}),e.jsx("p",{className:"customtext-neutral-light text-sm leading-relaxed",children:"Para continuar con su compra necesita iniciar sesión o crear una cuenta nueva."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>{window.location.href="/iniciar-sesion"},className:"w-full py-3 px-6 bg-primary text-white font-semibold rounded-lg  focus:outline-none focus:ring-2  focus:ring-offset-2 transition duration-200 transform hover:scale-[1.02]",children:"Iniciar sesión"}),e.jsx("button",{onClick:()=>{window.location.href="/crear-cuenta"},className:"w-full py-3 px-6 bg-accent text-white font-semibold rounded-lg  focus:outline-none focus:ring-2  focus:ring-offset-2 transition duration-200 transform hover:scale-[1.02]",children:"Crear cuenta nueva"}),e.jsx("button",{onClick:()=>Re(!1),className:"w-full py-3 px-6 customtext-neutral-light hover:customtext-neutral-dark border border-secondary rounded-lg hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200",children:"Cancelar"})]})]})})})};return e.jsxs(e.Fragment,{children:[e.jsx(st,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 md:gap-8",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsxs("form",{className:"space-y-4 md:space-y-6 bg-white p-4 md:p-6 rounded-xl shadow-sm",onSubmit:Be,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(oe,{name:"name",label:"Nombres",value:j.name,error:_.name,onChange:t=>{O(a=>({...a,name:t.target.value})),t.target.value.trim()&&_.name&&V(a=>({...a,name:""}))},required:!0,className:`border-gray-200 ${_.name?"border-red-500 bg-red-50":""}`}),e.jsx(oe,{name:"lastname",label:"Apellidos",value:j.lastname,error:_.lastname,onChange:t=>{O(a=>({...a,lastname:t.target.value})),t.target.value.trim()&&_.lastname&&V(a=>({...a,lastname:""}))},required:!0,className:`border-gray-200 ${_.lastname?"border-red-500 bg-red-50":""}`})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(ut,{label:"Tipo de documento",options:he,placeholder:"Selecciona tu documento",labelClass:"block text-sm 2xl:!text-base mb-1 customtext-neutral-dark",value:j.documentType,error:_.documentType,onChange:t=>{O(a=>({...a,documentType:t})),t&&_.documentType&&V(a=>({...a,documentType:""}))},required:!0})}),e.jsx(oe,{name:"document",label:"Número de documento",value:j.document,error:_.document,onChange:t=>{O(a=>({...a,document:t.target.value})),t.target.value.trim()&&_.document&&V(a=>({...a,document:""}))},placeholder:"Ej: 12345678",required:!0,className:`border-gray-200 ${_.document?"border-red-500 bg-red-50":""}`})]}),e.jsx(oe,{name:"email",label:"Correo electrónico",type:"email",value:j.email,error:_.email,onChange:t=>{O(a=>({...a,email:t.target.value})),t.target.value.trim()&&_.email&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.target.value)&&V(b=>({...b,email:""}))},required:!0,className:`border-gray-200 ${_.email?"border-red-500 bg-red-50":""}`}),e.jsx(oe,{name:"phone",label:"Teléfono",type:"tel",value:j.phone,error:_.phone,onChange:t=>{const a=t.target.value.replace(/\D/g,"");O(b=>({...b,phone:a})),a.length===9&&_.phone&&V(b=>({...b,phone:""}))},maxLength:"9",placeholder:"Ej: 987654321",required:!0,className:`border-gray-200 ${_.phone?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"block text-sm 2xl:text-base mb-2 font-medium customtext-neutral-dark",children:["Distrito / Provincia / Departamento (Ubicación de entrega)",e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx(ot,{name:"ubigeo",cacheOptions:!0,value:W,loadOptions:Je,onChange:t=>{Q(t),Ve(t),ye("")},inputValue:Ee,onInputChange:(t,{action:a})=>{a==="input-change"&&ye(t)},onFocus:()=>{Q(null),ye("")},onMenuOpen:()=>{W&&(Q(null),ye(""))},placeholder:"Buscar por Distrito ...",loadingMessage:()=>"Buscando ubicaciones...",noOptionsMessage:({inputValue:t})=>t.length<3?"Buscar por Distrito ...":"No se encontraron resultados",isLoading:y,styles:Ze(!!_.ubigeo),formatOptionLabel:({data:t})=>e.jsxs("div",{className:"text-sm py-1",children:[e.jsx("div",{className:"font-medium",children:t.distrito}),e.jsxs("div",{className:"text-gray-500",children:[t.provincia,", ",t.departamento]})]}),className:"w-full rounded-xl transition-all duration-300",menuPortalTarget:document.body,isClearable:!0}),_.ubigeo&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:_.ubigeo})]}),e.jsx(oe,{name:"address",label:"Dirección ",value:j.address,error:_.address,onChange:t=>{O(a=>({...a,address:t.target.value})),t.target.value.trim()&&_.address&&V(a=>({...a,address:""}))},required:!0,className:`border-gray-200 ${_.address?"border-red-500 bg-red-50":""}`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(oe,{label:"Número",value:j.number,onChange:t=>O(a=>({...a,number:t.target.value})),className:"border-gray-200"}),e.jsx(oe,{label:"Referencia",value:j.reference,onChange:t=>O(a=>({...a,reference:t.target.value})),className:"border-gray-200"})]}),H.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Método de envío"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:H.map(t=>e.jsx(rt,{title:t.deliveryType,price:t.price,description:t.description,selected:I===t.type,onSelect:()=>{F(t.type),f(t.price),V(a=>({...a,shipping:"",store:""})),je(!1),t.type!=="store_pickup"&&Me(null)}},t.type))}),I&&H.length>0&&e.jsx("div",{className:"space-y-3 mt-4",children:(()=>{var C;const t=((C=H.find(N=>N.type===I))==null?void 0:C.characteristics)||[],a=t.length>1,b=a&&!be?t.slice(0,1):t;return e.jsxs(e.Fragment,{children:[b.map((N,i)=>e.jsxs("div",{className:"flex items-start gap-3 bg-gray-50 p-4 rounded-xl",children:[e.jsx("div",{className:"w-5 flex-shrink-0",children:e.jsx(nt,{className:"customtext-primary"})}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm font-medium customtext-neutral-dark",children:N})})]},`char-${i}`)),a&&e.jsx("div",{className:"flex justify-center mt-3",children:e.jsxs("button",{type:"button",onClick:()=>je(!be),className:"flex items-center gap-2 px-4 py-2 text-sm font-medium customtext-primary hover:bg-blue-50 rounded-lg transition-colors duration-200",children:[e.jsx("span",{children:be?"Ver menos información":`Ver más información (${t.length-1} más)`}),e.jsx("svg",{className:`w-4 h-4 transition-transform duration-200 ${be?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})})]})})()})]}),I==="store_pickup"&&Ke&&e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(kt,{ubigeoCode:j.ubigeo,onStoreSelect:We,selectedStore:Ne,className:"border border-gray-200 rounded-xl p-4"}),_.store&&e.jsxs("div",{className:"text-red-500 text-sm mt-2 flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"}),_.store]})]}),!v&&e.jsxs("div",{className:"flex flex-col md:flex-row justify-end gap-3 md:gap-4 mt-6",children:[e.jsx(Ae,{type:"button",onClick:()=>window.history.back(),className:"w-full md:w-auto",children:"Regresar"}),e.jsx(Se,{type:"submit",loading:y,className:"w-full md:w-auto",children:"Continuar"})]})]})}),e.jsxs("div",{className:"bg-[#F7F9FB] rounded-xl shadow-lg p-6 col-span-2 h-max",children:[e.jsx("h3",{className:"text-2xl font-bold pb-6",children:"Resumen"}),e.jsx("div",{className:"space-y-4 border-b-2 pb-6",children:n.map(t=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:`/storage/images/item/${t.image}`,alt:t.name,className:"w-16 h-16 object-cover rounded-lg",onError:a=>a.target.src="/api/cover/thumbnail/null"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Cantidad: ",t.quantity]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["S/ ",T(t.final_price)]})]})]},t.id))}),e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["S/ ",T(z(w))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"IGV (18%):"}),e.jsxs("span",{children:["S/ ",T(z(d))]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Envío:"}),e.jsxs("span",{children:["S/ ",T(z(o))]})]}),e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium customtext-neutral-dark",children:"¿Tienes un cupón de descuento?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",placeholder:"Ingresa tu código de cupón",value:de,onChange:t=>ze(t.target.value.toUpperCase()),className:`w-full px-4 py-3 border customtext-neutral-dark  border-gray-100 rounded-xl focus:ring-0 focus:outline-0   transition-all duration-300 ${Te?"border-red-300 bg-red-50 text-red-900 focus:border-red-500 focus:ring-red-200":L?"border-gray-200 bg-white customtext-neutral-dark focus:ring-blue-200":" bg-white border-neutral-light focus:ring-0 focus:outline-0"} `,disabled:!!L||ve}),ve&&e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"})})]}),L?e.jsx("button",{type:"button",onClick:tt,className:"px-4 py-3 bg-gray-200 customtext-neutral-dark text-sm rounded-xl hover:bg-gray-300 transition-colors duration-200",title:"Remover cupón",children:e.jsx(ue,{className:"h-4 w-4"})}):e.jsx("button",{type:"button",onClick:et,disabled:ve||!de.trim(),className:"px-6 py-3 bg-primary text-white text-sm font-medium rounded-xl hover:opacity-90 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200 whitespace-nowrap",children:ve?"Validando...":"Aplicar"})]}),Te&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(ue,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:Te})]}),L&&e.jsx("div",{className:"bg-gray-50 border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsxs("p",{className:"customtext-primary font-semibold text-sm",children:["Descto. ",L.type==="percentage"?`${L.value}%`:`S/${T(L.value)}`]}),e.jsx("p",{className:"customtext-primary text-xs mt-1",children:L.code})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-primary font-bold text-base",children:["-S/ ",T(z(qe))]})})]})})]})}),D&&D.length>0&&e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium customtext-neutral-dark mb-2",children:"🎉 Descuentos automáticos aplicados:"}),D.map((t,a)=>e.jsx("div",{className:" border-2  rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 w-8/12",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"customtext-neutral-dark font-semibold text-sm",children:t.name}),t.description&&e.jsx("p",{className:"customtext-neutral-dark text-xs mt-1",children:t.description})]})]}),e.jsx("div",{className:"text-right w-4/12",children:e.jsxs("span",{className:"customtext-neutral-dark font-bold text-base",children:["-S/ ",T(t.amount)]})})]})},a)),Y>0&&e.jsx("div",{className:"l p-3",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"customtext-neutral-dark font-semibold",children:"Total descuentos automáticos:"}),e.jsxs("span",{className:"customtext-neutral-dark font-bold text-lg",children:["-S/ ",T(Y)]})]})})]})}),e.jsx("div",{className:"pt-4 border-t-2",children:e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["S/ ",T(z(we))]})]})}),e.jsx(Se,{onClick:Be,className:"w-full mt-6",disabled:k,loading:k,children:k?"Procesando...":`Pagar S/ ${T(z(we))}`}),e.jsx(Ae,{onClick:v,className:"w-full mt-3",disabled:k,children:"Regresar al carrito"}),e.jsxs("p",{className:"text-xs md:text-sm customtext-neutral-dark",children:["Al realizar tu pedido, aceptas los ",e.jsx("a",{href:"#",onClick:()=>q(1),className:"customtext-primary font-bold",children:"Términos y Condiciones"}),", y que nosotros usaremos sus datos personales de acuerdo con nuestra ",e.jsx("a",{href:"#",onClick:()=>q(0),className:"customtext-primary font-bold",children:"Política de Privacidad"}),"."]})]})]})]})]})}function St({cart:n,code:S,delivery:h,couponDiscount:g=0,couponCode:P=null,conversionScripts:E=null,automaticDiscounts:v=[],automaticDiscountTotal:w=0}){const d=n.reduce((r,q)=>{const M=q.final_price;return r+M*q.quantity},0),m=parseFloat((d/1.18).toFixed(2)),s=parseFloat((d-m).toFixed(2)),o=parseFloat(m)+parseFloat(s)+parseFloat(h)-g-w;return c.useEffect(()=>{if(E){console.log("Executing conversion scripts...");try{if(E.head){const r=document.createElement("script");r.innerHTML=E.head,document.head.appendChild(r)}if(E.body){const r=document.createElement("script");r.innerHTML=E.body,document.body.appendChild(r)}console.log("Conversion scripts executed successfully")}catch(r){console.error("Error executing conversion scripts:",r)}}},[E]),e.jsx(ie.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},className:"mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-12",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl p-6 md:p-10",children:e.jsxs(ie.div,{initial:{scale:.9},animate:{scale:1},transition:{delay:.3},className:"text-center space-y-6",children:[e.jsx(ie.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",delay:.5},className:"w-20 h-20 bg-secondary rounded-full mx-auto flex items-center justify-center",children:e.jsx("span",{className:"text-4xl",children:"✓"})}),e.jsx("h2",{className:"text-2xl md:text-3xl customtext-neutral-light animate-bounce",children:"¡Gracias por tu compra! 🎉"}),e.jsx("p",{className:"customtext-neutral-dark text-3xl md:text-5xl font-bold",children:"Tu orden ha sido recibida"}),e.jsxs(ie.div,{whileHover:{scale:1.05},className:"py-6 px-4 bg-secondary rounded-xl inline-block",children:[e.jsx("div",{className:"customtext-neutral-light",children:"Código de pedido"}),e.jsx("div",{className:"customtext-neutral-dark text-xl font-bold",children:`#${S}`})]}),e.jsxs("div",{className:"space-y-6 bg-[#F7F9FB] p-6 md:p-8 rounded-xl shadow-inner",children:[e.jsx("div",{className:"space-y-6 border-b-2 pb-6",children:n.map((r,q)=>e.jsx(ie.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:q*.2},className:"bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow duration-300",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-6 items-center sm:items-start",children:[e.jsx("div",{className:"bg-gray-50 p-3 rounded-xl",children:e.jsx("img",{src:`/storage/images/item/${r.image}`,alt:r.name,className:"w-24 h-24 object-cover rounded-lg",onError:M=>M.target.src="/api/cover/thumbnail/null",loading:"lazy"})}),e.jsxs("div",{className:"text-center sm:text-left flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-xl lg:w-8/12 line-clamp-3",children:r.name}),e.jsx("div",{className:"mt-2 sm:mt-0 text-center lg:text-right lg:w-4/12",children:e.jsxs("div",{className:"font-bold text-lg customtext-primary",children:["S/ ",T(r.final_price*r.quantity)]})})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Marca: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:r.brand.name})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["Cantidad: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:r.quantity})]}),e.jsxs("p",{className:"text-sm customtext-neutral-light",children:["SKU: ",e.jsx("span",{className:"customtext-neutral-dark font-medium",children:r.sku})]})]})]})]})},q))}),e.jsxs(ie.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},className:"space-y-4 mt-6",children:[[{label:"Subtotal",value:m},{label:"IGV",value:s},{label:"Envío",value:h}].map((r,q)=>e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"customtext-neutral-dark",children:r.label}),e.jsxs("span",{className:"font-semibold",children:["S/ ",T(r.value)]})]},q)),g>0&&P&&e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsxs("span",{className:"customtext-neutral-dark text-start",children:["Cupón: ",e.jsx("br",{className:"lg:hidden"}),e.jsxs("span",{className:"font-semibold text-xs lg:text-base",children:["(",P,")"]})]}),e.jsxs("span",{className:"font-semibold",children:["-S/ ",T(g)]})]}),w>0&&v.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold pb-4 md:pb-6 customtext-neutral-dark mb-2",children:"🎉 Descuentos aplicados:"}),v.map((r,q)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"customtext-neutral-dark",children:[r.name,r.description&&e.jsx("span",{className:"text-xs font-semibold block",children:r.description})]}),e.jsxs("span",{className:"customtext-neutral-dark font-semibold",children:["-S/ ",T(r.amount)]})]},q)),e.jsxs("div",{className:"flex justify-between text-sm font-semibold customtext-neutral-dark pt-1",children:[e.jsx("span",{children:"Total descuentos:"}),e.jsxs("span",{children:["-S/ ",T(w)]})]})]}),e.jsx("div",{className:"py-4 border-y-2 mt-6",children:e.jsxs("div",{className:"flex justify-between font-bold text-xl md:text-2xl items-center",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["S/ ",T(o)]})]})})]}),e.jsx(ie.div,{className:"pt-6",whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsx(Se,{href:"/catalogo",className:"w-full mx-auto md:w-auto",children:"Seguir Comprando"})})]})]})})})}const _t=()=>{const n=c.useRef({hasTrackedPageView:!1,hasTrackedInitiateCheckout:!1}),S=(d,m={})=>{typeof window>"u"||(typeof window.fbq<"u"&&window.fbq("track","ViewContent",{content_ids:[d],content_type:"product",content_name:m.name||"",value:m.price||0,currency:"PEN"}),typeof window.gtag<"u"&&window.gtag("event","view_item",{currency:"PEN",value:m.price||0,items:[{item_id:d,item_name:m.name||"",category:m.category||"",price:m.price||0}]}),typeof window.ttq<"u"&&window.ttq.track("ViewContent",{content_id:d,content_type:"product",content_name:m.name||"",value:m.price||0,currency:"PEN"}),console.log("✅ ProductView tracked for product:",d))},h=async(d,m=1,s={})=>{var f;if(!(typeof window>"u"))try{const r=await(await fetch("/api/tracking/add-to-cart",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((f=document.querySelector('meta[name="csrf-token"]'))==null?void 0:f.content)||""},body:JSON.stringify({product_id:d,quantity:m,...s})})).json();r.success&&r.tracking_scripts&&(v(r.tracking_scripts),console.log("✅ AddToCart tracked successfully"))}catch(o){console.error("❌ Error tracking AddToCart:",o)}},g=async(d,m)=>{var s;if(!(typeof window>"u"||n.current.hasTrackedInitiateCheckout))try{n.current.hasTrackedInitiateCheckout=!0;const o=await(await fetch("/api/tracking/initiate-checkout",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||""},body:JSON.stringify({cart_items:d.map(r=>({product_id:r.id,name:r.name,price:r.final_price||r.price,quantity:r.quantity,subtotal:(r.final_price||r.price)*r.quantity}))})})).json();o.success&&o.tracking_scripts&&(v(o.tracking_scripts),console.log("✅ InitiateCheckout tracked successfully"))}catch(f){console.error("❌ Error tracking InitiateCheckout:",f),n.current.hasTrackedInitiateCheckout=!1}},P=(d,m)=>{if(!(typeof window>"u")){console.log("🎯 Iniciando tracking de compra:",{orderId:d,conversionScripts:m});try{m?(console.log("📊 Usando scripts de conversión del servidor"),v(m)):(console.log("🔄 Obteniendo scripts de conversión del API"),fetch(`/api/tracking/purchase/${d}`).then(s=>s.text()).then(s=>{s&&(v(s),console.log("✅ Purchase tracked successfully"))}).catch(s=>{console.error("❌ Error tracking Purchase:",s)}))}catch(s){console.error("❌ Error general en trackPurchase:",s)}}},E=(d,m=[])=>{if(typeof window>"u"||n.current.hasTrackedPageView)return;n.current.hasTrackedPageView=!0;const s=m.reduce((f,o)=>f+(o.final_price||o.price)*o.quantity,0);typeof window.fbq<"u"&&(window.fbq("track","PageView"),d===1&&m.length>0&&window.fbq("track","AddToCart",{content_ids:m.map(f=>f.id),content_type:"product",value:s,currency:"PEN",num_items:m.length})),typeof window.gtag<"u"&&(window.gtag("event","page_view",{page_title:`Checkout - Paso ${d}`,page_location:window.location.href}),d===1&&m.length>0&&window.gtag("event","view_cart",{currency:"PEN",value:s,items:m.map(f=>{var o;return{item_id:f.id,item_name:f.name,category:((o=f.category)==null?void 0:o.name)||"Sin categoría",quantity:f.quantity,price:f.final_price||f.price}})})),console.log(`✅ Checkout PageView tracked - Step ${d}`)},v=d=>{if(typeof window>"u"||!d)return;console.log("🎯 Ejecutando scripts de tracking:",d);const m=document.createElement("div");m.innerHTML=d,m.querySelectorAll("script").forEach((f,o)=>{try{const r=document.createElement("script");r.textContent=f.textContent,console.log(`📊 Ejecutando script de tracking ${o+1}:`,f.textContent.trim()),document.head.appendChild(r),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},100),console.log(`✅ Script de tracking ${o+1} ejecutado exitosamente`)}catch(r){console.error(`❌ Error ejecutando script de tracking ${o+1}:`,r),console.error("Script content:",f.textContent)}}),console.log("🎯 Todos los scripts de tracking procesados")};return{trackProductView:S,trackAddToCart:h,trackInitiateCheckout:g,trackPurchase:P,trackCheckoutPageView:E,resetTracking:()=>{n.current={hasTrackedPageView:!1,hasTrackedInitiateCheckout:!1}}}};function Ns({cart:n,setCart:S,user:h,ubigeos:g=[],items:P,generals:E}){const[v,w]=c.useState(1),d=n.reduce((F,ee)=>F+ee.final_price*ee.quantity,0),{trackCheckoutPageView:m,trackInitiateCheckout:s,trackPurchase:f,resetTracking:o}=_t(),r=parseFloat((d/1.18).toFixed(2)),q=parseFloat((d-r).toFixed(2)),[M,U]=c.useState(0),[A,J]=c.useState(0),[le,Z]=c.useState(null),[K,X]=c.useState([]),[W,Q]=c.useState(0),te=r+q+parseFloat(M),re=A+W,D=Math.max(0,te-re),[ce,Y]=c.useState([]),[ne,xe]=c.useState([]),[he,j]=c.useState([]),[O,y]=c.useState(null);c.useEffect(()=>(m(v,n),()=>o()),[]),c.useEffect(()=>{m(v,n),v===2&&s(n,D)},[v]);const u=F=>{w(F),window.scrollTo({top:0,behavior:"smooth"})},k={privacy_policy:"Políticas de privacidad",terms_conditions:"Términos y condiciones",saleback_policy:"Políticas de devolucion y cambio"},[R,H]=c.useState(null),se=F=>H(F),I=()=>H(null);return e.jsxs("div",{className:"min-h-screen bg-[#F7F9FB] py-4 md:py-12 px-2 sm:px-primary 2xl:px-0 2xl:max-w-7xl mx-auto",children:[e.jsxs("div",{className:"bg-white p-3 md:p-8 rounded-lg md:rounded-xl shadow-sm",children:[e.jsx("div",{className:"mb-4 md:mb-8",children:e.jsxs("div",{className:"flex items-center justify-between gap-1 md:gap-4 max-w-3xl mx-auto",children:[e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${v===1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:" bg-primary text-white w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm",children:"1"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Carrito"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:v>1?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${v>1?"customtext-primary font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${v>1?"bg-primary text-white":"bg-white customtext-primary"}`,children:"2"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Envío"})]}),e.jsx("div",{className:"mb-4 lg:mb-0  flex-1 h-[2px] bg-gray-200 relative",children:e.jsx("div",{className:"absolute inset-0 bg-primary transition-all duration-500",style:{width:v>2?"100%":"0%"}})}),e.jsxs("div",{className:`flex flex-col items-center md:flex-row md:items-center gap-1 md:gap-2 ${v===3?"customtext-primary  font-medium":"customtext-neutral-dark"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs md:text-sm ${v===3?"bg-primary text-white":"bg-white customtext-primary"}`,children:"3"}),e.jsx("span",{className:"text-[10px] md:text-sm text-center",children:"Confirmación"})]})]})}),v===1&&e.jsx(vt,{cart:n,setCart:S,onContinue:()=>u(2),subTotal:r,envio:M,igv:q,totalFinal:D,openModal:se,automaticDiscounts:K,setAutomaticDiscounts:X,automaticDiscountTotal:W,setAutomaticDiscountTotal:Q,totalWithoutDiscounts:te}),v===2&&e.jsx(Ct,{items:P,setCode:xe,setDelivery:j,cart:n,setSale:Y,setCart:S,onContinue:()=>u(3),noContinue:()=>u(1),subTotal:r,envio:M,setEnvio:U,igv:q,totalFinal:D,user:h,ubigeos:g,openModal:se,setCouponDiscount:J,setCouponCode:Z,automaticDiscounts:K,automaticDiscountTotal:W,totalWithoutDiscounts:te,conversionScripts:O,setConversionScripts:y,onPurchaseComplete:(F,ee)=>{f(F,ee)}}),v===3&&e.jsx(St,{code:ne,delivery:he,cart:ce,subTotal:r,envio:M,igv:q,totalFinal:D,couponDiscount:A,couponCode:le,automaticDiscounts:K,automaticDiscountTotal:W,totalWithoutDiscounts:te,conversionScripts:O,setConversionScripts:y,onPurchaseComplete:(F,ee)=>{f(F,ee)}})]}),Object.keys(k).map((F,ee)=>{var V;const _e=k[F],_=((V=E.find(Ee=>Ee.correlative==F))==null?void 0:V.description)??"";return e.jsx(ht,{isOpen:R===ee,onRequestClose:I,contentLabel:_e,className:"fixed top-0 left-0 right-0 bottom-0 flex items-center justify-center p-4 z-50",overlayClassName:"fixed inset-0 bg-black bg-opacity-50 z-[999]",ariaHideApp:!1,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 pr-4",children:_e}),e.jsx("button",{onClick:I,className:"flex-shrink-0 text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 hover:bg-gray-100 rounded-full","aria-label":"Cerrar modal",children:e.jsx(Ge,{size:24,strokeWidth:2})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsx("div",{className:"prose prose-gray max-w-none",children:e.jsx(ft,{html:_})})}),e.jsx("div",{className:"flex justify-end p-6 border-t border-gray-200",children:e.jsx("button",{onClick:I,className:"px-6 py-2 bg-primary text-white rounded-lg  transition-colors duration-200 font-medium",children:"Cerrar"})})]})},ee)})]})}export{Ns as default};
