const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as ga}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as c,R as vt}from"./index-BH53Isel.js";import{T as Rs,l as re,i as zs,D as ma,H as ha,U as fa,R as pa,B as Ze,F as xa,E as Is}from"./EditableCell-DehGgdxe.js";import{h as Ps}from"./thumbnailGenerator-B4goYG9Y.js";import{L as st}from"./layers-6oegOx-p.js";import{C as ba}from"./chevron-down-DS-mdh9v.js";import{C as ya}from"./chevron-right-Ckt5D2ka.js";import{E as va}from"./eye-CKCH9ORv.js";import{c as ye}from"./createLucideIcon-Cy5Ya80P.js";import{T as Fs}from"./trash-2-DK1wnsDn.js";import{S as wa}from"./star-wPQTHY_n.js";import{I as Oe}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as Y,T as Ea}from"./index-BZYhE2TF.js";import{m as Ms}from"./main-6DCdASTx.js";import{B as ja}from"./V1Edit-DTUIljRj.js";import{G as Os}from"./Global-ErywZRdd.js";import{S as Vs}from"./save-BvSyoVHO.js";import{C as Na}from"./clock-BTrEpQej.js";import{T as Sa}from"./triangle-alert-vFMqKi4t.js";import{C as Ca}from"./check-DQ7QoS0v.js";import{L as ka}from"./loader-circle-CrvBvIt1.js";import{B as et}from"./dom-to-image-more.min-Cey65QPP.js";import{C as Aa}from"./chevron-left-B2s3ZsB7.js";import{U as Ta}from"./user-BvYmyGTY.js";import{F as $s}from"./filter-Ci9tsc_e.js";import{P as tt}from"./plus-Bot15Khs.js";import{C as Ia}from"./copy-6OEekgvq.js";import{C as Pa}from"./circle-check-big-D6DM3vPb.js";import{u as Ma}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=ye("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=ye("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ua=ye("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const La=ye("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=ye("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=ye("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ra=ye("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const za=ye("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Us=ye("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fa=ye("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Va=({pages:n,currentPage:f,selectedCell:m,selectedElement:k,onSelectCell:l,onSelectElement:y,onUpdateElement:E,onDeleteElement:S,onMoveElement:U})=>{var G;if(!n||!n[f])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(st,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const x=n[f],W=((G=x==null?void 0:x.cells)==null?void 0:G.filter(A=>A.elements&&A.elements.length>0))||[],[z,M]=c.useState(()=>{const A={};return W.forEach(_=>{A[_.id]=!0}),A}),O=A=>{M(_=>({..._,[A]:!_[A]}))},j=A=>{switch(A){case"image":return e.jsx(Oe,{className:"h-4 w-4"});case"text":return e.jsx(Rs,{className:"h-4 w-4"});case"shape":return e.jsx(za,{className:"h-4 w-4"});case"sticker":return e.jsx(wa,{className:"h-4 w-4"});default:return e.jsx(Ua,{className:"h-4 w-4"})}},R=(A,_)=>{switch(A.type){case"text":return A.content?A.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${_+1}`;case"shape":return A.shape||"Shape";case"sticker":return`Sticker ${_+1}`;default:return`Element ${_+1}`}},F=(A,_,ee)=>{E(A,_,{visible:ee})},Q=(A,_)=>{l(A),y(_)};return e.jsx("div",{className:"space-y-2",children:W.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(st,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):W.map(A=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${m===A.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{O(A.id),l(A.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:z[A.id]?e.jsx(ba,{className:"h-4 w-4"}):e.jsx(ya,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",A.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[A.elements.length," element",A.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[A.x,", ",A.y]})]}),z[A.id]&&e.jsx("div",{className:"border-t border-gray-100",children:A.elements.map((_,ee)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${k===_.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>Q(A.id,_.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:j(_.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:R(_,ee)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[_.type," ‚Ä¢ Layer ",ee+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:X=>{X.stopPropagation(),F(A.id,_.id,!_.visible)},className:"p-1 hover:bg-gray-200 rounded",title:_.visible?"Hide element":"Show element",children:_.visible!==!1?e.jsx(va,{className:"h-3 w-3 text-gray-500"}):e.jsx(_a,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:X=>{X.stopPropagation(),U(A.id,_.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:ee===A.elements.length-1,children:e.jsx($a,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:X=>{X.stopPropagation(),U(A.id,_.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:ee===0,children:e.jsx(Oa,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:X=>{X.stopPropagation(),S(A.id,_.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(Fs,{className:"h-3 w-3"})})]})]},_.id))})]},A.id))})};function Ba({currentLayoutId:n,onLayoutChange:f}){const[m,k]=c.useState("all"),l={all:{name:"Todos",layouts:re},hero:{name:"Hero",layouts:re.filter(y=>y.category==="hero")},editorial:{name:"Editorial",layouts:re.filter(y=>y.category==="editorial")},storytelling:{name:"Historia",layouts:re.filter(y=>y.category==="storytelling")},minimal:{name:"Minimal",layouts:re.filter(y=>y.category==="minimal")},creative:{name:"Creativo",layouts:re.filter(y=>y.category==="creative")},classic:{name:"Cl√°sico",layouts:re.filter(y=>y.category==="classic")}};return Object.keys(l).filter(y=>y==="all"||l[y].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:l[m].layouts.map(y=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>f(y.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${y.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:y.cells}).map((E,S)=>{var U,x;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(x=(U=y.cellStyles)==null?void 0:U[S])!=null&&x.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},S)})}),n===y.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:y.name}),y.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:y.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[y.cells," ",y.cells===1?"celda":"celdas"]})})]})]},y.id))}),l[m].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categor√≠a."})})]})}const Ga=({selectedMask:n,onSelect:f,availableMasks:m=[],selectedImage:k})=>{var S,U;const[l,y]=c.useState("B√°sicas"),E={};return zs.forEach(x=>{E[x.category]||(E[x.category]=[]),(m.includes(x.id)||x.id==="none")&&E[x.category].push(x)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(E).slice(0,2).map(x=>E[x].length>0&&e.jsx("button",{onClick:()=>y(x),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${l===x?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:x},x))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(S=E[l])==null?void 0:S.slice(0,6).map(x=>e.jsxs("div",{onClick:()=>f(x.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${n===x.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:k!=null&&k.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:k.content,alt:x.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:x.id==="circle"?"circle(50%)":x.id==="rounded"||x.id==="rounded-sm"?"inset(0 round 8%)":x.id==="rounded-lg"?"inset(0 round 16%)":x.id==="rounded-rect"?"inset(0 round 12%)":x.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":x.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":x.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":x.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":x.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":x.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":x.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":x.id==="frame"?"inset(10% round 10%)":x.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':x.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':x.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:x.name})]},x.id))}),((U=E[l])==null?void 0:U.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver m√°s m√°scaras (",E[l].length-6," m√°s)"]})]})},Se=new Map,$e=new Map;async function Bs(n){return Se.has(n)?Se.get(n):new Promise((f,m)=>{const k=new Image;k.crossOrigin="anonymous",k.onload=()=>{Se.set(n,k),f(k)},k.onerror=()=>{console.warn(`‚ö†Ô∏è No se pudo cargar imagen: ${n}`),f(null)},setTimeout(()=>{Se.has(n)||(console.warn(`‚è∞ Timeout cargando imagen: ${n}`),f(null))},3e3),k.src=n})}function Gs(n,f,m){var O,j,R,F;const{x:k,y:l,width:y,height:E}=m,S=((O=f.position)==null?void 0:O.x)||0,U=((j=f.position)==null?void 0:j.y)||0,x=k+(S<=1?S*y:S),W=l+(U<=1?U*E:U),z=(R=f.size)!=null&&R.width?f.size.width<=1?f.size.width*y:f.size.width:y,M=(F=f.size)!=null&&F.height?f.size.height<=1?f.size.height*E:f.size.height:E;if(f.type==="image"&&f.content){const Q=Se.get(f.content);if(Q){if(n.save(),f.filters){const{brightness:ie=100,contrast:Ce=100,saturation:r=100,opacity:te=100}=f.filters;(ie!==100||Ce!==100||r!==100||te!==100)&&(n.filter=`brightness(${ie/100}) contrast(${Ce/100}) saturate(${r/100}) opacity(${te/100})`)}const G=Q.width/Q.height,A=z/M;let _=0,ee=0,X=Q.width,de=Q.height;G>A?(X=Q.height*A,_=(Q.width-X)/2):(de=Q.width/A,ee=(Q.height-de)/2),n.drawImage(Q,_,ee,X,de,x,W,z,M),n.restore()}}else if(f.type==="text"&&f.content){n.save();const Q=f.style||{},G=Math.max(8,parseInt(Q.fontSize)||16),A=Q.color||"#000000";n.font=`${G}px Arial, sans-serif`,n.fillStyle=A,n.textBaseline="top";let _=f.content.split(`
`)[0]||"";_.length>50&&(_=_.substring(0,50)+"..."),n.fillText(_,x+4,W+4),n.restore()}}async function Ha({page:n,workspaceDimensions:f,onProgress:m=null}){console.log(`‚ö° Generando thumbnail para p√°gina: ${n.id}`);const l=(y,E,S="")=>{const U=Math.round(y/E*100);console.log(`üìä Progreso p√°gina ${n.id}: ${y}/${E} (${U}%) ${S}`),m&&m({current:y,total:E,percentage:U,message:S,pageId:n.id})};try{const y=300/Math.max(f.width,f.height),E=Math.round(f.width*y),S=Math.round(f.height*y),U=`${n.id}-${E}x${S}`;if($e.has(U))return console.log(`üì¶ Thumbnail encontrado en cache: ${n.id}`),l(4,4,"Cargado desde cache"),$e.get(U);l(1,4,"Iniciando generaci√≥n...");const x=new Set;n.backgroundImage&&x.add(n.backgroundImage),n.cells&&n.cells.forEach(j=>{j.elements&&j.elements.forEach(R=>{R.type==="image"&&R.content&&x.add(R.content)})}),l(2,4,"Cargando im√°genes...");const W=Array.from(x).map(async j=>{try{const R=new Promise((Q,G)=>setTimeout(()=>G(new Error("Timeout")),3e3)),F=Bs(j);await Promise.race([F,R])}catch{console.warn(`‚ö†Ô∏è Error/timeout cargando imagen: ${j}`)}});await Promise.all(W),l(3,4,"Renderizando thumbnail...");const z=document.createElement("canvas"),M=z.getContext("2d",{alpha:!1,willReadFrequently:!1});if(z.width=E,z.height=S,M.fillStyle=n.backgroundColor||"#ffffff",M.fillRect(0,0,z.width,z.height),n.backgroundImage){const j=Se.get(n.backgroundImage);j&&M.drawImage(j,0,0,z.width,z.height)}if(n.cells&&n.cells.length>0){const j=Math.ceil(Math.sqrt(Math.min(n.cells.length,9))),R=z.width/j,F=z.height/Math.ceil(Math.min(n.cells.length,9)/j);n.cells.slice(0,9).forEach((Q,G)=>{const A=G%j,_=Math.floor(G/j),ee=A*R,X=_*F;Q.elements&&Q.elements.filter(ie=>ie.type==="image"||ie.type==="text").slice(0,3).forEach(ie=>{Gs(M,ie,{x:ee,y:X,width:R,height:F})})})}l(4,4,"Guardando thumbnail...");const O=z.toDataURL("image/jpeg",.7);return $e.set(U,O),console.log(`‚úÖ Thumbnail generado para p√°gina: ${n.id}`),O}catch(y){return console.error(`‚ùå Error generando thumbnail para p√°gina ${n.id}:`,y),l(4,4,"Error en generaci√≥n"),null}}async function Ls({pages:n,workspaceDimensions:f,onProgress:m=null}){const k={};console.log(`‚ö° Generando ${n.length} thumbnails r√°pidos...`);const y=(M,O,j="")=>{const R=Math.round(M/O*100);console.log(`üìä Progreso: ${M}/${O} (${R}%) ${j}`),m&&m({current:M,total:O,percentage:R,message:j})},E=new Set;n.forEach(M=>{M.backgroundImage&&E.add(M.backgroundImage),M.cells&&M.cells.forEach(O=>{O.elements&&O.elements.forEach(j=>{j.type==="image"&&j.content&&E.add(j.content)})})});const S=Array.from(E),U=5;y(0,S.length,"Cargando im√°genes...");for(let M=0;M<S.length;M+=U){const O=S.slice(M,M+U);await Promise.all(O.map(Bs)),y(Math.min(M+U,S.length),S.length,"Cargando im√°genes...")}console.log(`üì∏ Im√°genes cargadas: ${Se.size}`);const x=300/Math.max(f.width,f.height),W=Math.round(f.width*x),z=Math.round(f.height*x);y(0,n.length,"Generando thumbnails...");for(let M=0;M<n.length;M++){const O=n[M];try{const j=`${O.id}-${W}x${z}`;if($e.has(j)){k[O.id]=$e.get(j),y(M+1,n.length,`Thumbnail ${O.id} (cached)`);continue}const R=document.createElement("canvas"),F=R.getContext("2d",{alpha:!1,willReadFrequently:!1});if(R.width=W,R.height=z,F.fillStyle=O.backgroundColor||"#ffffff",F.fillRect(0,0,R.width,R.height),O.backgroundImage){const G=Se.get(O.backgroundImage);G&&F.drawImage(G,0,0,R.width,R.height)}if(O.cells&&O.cells.length>0){const G=Math.ceil(Math.sqrt(O.cells.length)),A=R.width/G,_=R.height/Math.ceil(O.cells.length/G);O.cells.forEach((ee,X)=>{if(X>=9)return;const de=X%G,ie=Math.floor(X/G),Ce=de*A,r=ie*_;ee.elements&&ee.elements.filter(d=>d.type==="image"||d.type==="text").slice(0,3).forEach(d=>{Gs(F,d,{x:Ce,y:r,width:A,height:_})})})}const Q=R.toDataURL("image/jpeg",.7);k[O.id]=Q,$e.set(j,Q),y(M+1,n.length,`Thumbnail ${O.id} generado`)}catch(j){console.error(`‚ùå Error generando thumbnail r√°pido para ${O.id}:`,j),k[O.id]=null,y(M+1,n.length,`Error en ${O.id}`)}}return console.log(`‚ö° ¬°${Object.keys(k).length} thumbnails generados en modo r√°pido!`),k}function Wa(){Se.clear(),$e.clear(),console.log("üßπ Caches de thumbnails limpiados")}const qa=async(n,f,m)=>{var k;try{console.log("üì§ [SAVE] Subiendo imagen al backend:",f);const[l,y]=n.split(","),E=((k=l.match(/data:image\/(\w+)/))==null?void 0:k[1])||"png",S=new FormData,U=atob(y),x=new Array(U.length);for(let j=0;j<U.length;j++)x[j]=U.charCodeAt(j);const W=new Uint8Array(x),z=new Blob([W],{type:`image/${E}`});S.append("image",z,`element_${f}.${E}`),S.append("project_id",m),S.append("element_id",f);const M=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:S});if(!M.ok)throw new Error("Error al subir imagen al servidor");const O=await M.json();return console.log("‚úÖ [SAVE] Imagen subida exitosamente:",O.url),O.url}catch(l){throw console.error("‚ùå [SAVE] Error subiendo imagen:",l),l}},Qa=async(n,f)=>{var y,E;console.log("üîÑ [SAVE] Procesando im√°genes para guardado...");const m=[];let k=0,l=0;for(const S of n)for(const U of S.cells||[])for(const x of U.elements||[])x.type==="image"&&((y=x.content)!=null&&y.startsWith("data:image/"))&&k++;console.log(`üìä [SAVE] Total de im√°genes base64 a procesar: ${k}`);for(const S of n){const U={...S};U.cells=[];for(const x of S.cells||[]){const W={...x};W.elements=[];for(const z of x.elements||[]){const M={...z};if(z.type==="image"&&((E=z.content)!=null&&E.startsWith("data:image/")))try{const O=await qa(z.content,z.id,f);M.content=O,M.isUploaded=!0,l++,console.log(`‚úÖ [SAVE] Imagen ${l}/${k} procesada`)}catch(O){console.error("‚ùå [SAVE] Error procesando imagen:",z.id,O),M.uploadError=O.message}W.elements.push(M)}U.cells.push(W)}m.push(U)}return console.log(`‚úÖ [SAVE] Procesamiento completado: ${l}/${k} im√°genes subidas`),m},Ja=async(n,f)=>{var m;try{console.log("üîç [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:n,thumbnailsCount:Object.keys(f).length});const k=[];for(const[E,S]of Object.entries(f))console.log(`üîç [DEBUG] Procesando thumbnail para p√°gina ${E}:`,{hasData:!!S,isBase64:S&&S.startsWith("data:image/"),dataLength:S?S.length:0}),S&&S.startsWith("data:image/")&&k.push({page_id:E,thumbnail_data:S});if(k.length===0){console.log("‚ÑπÔ∏è [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`üñºÔ∏è [THUMBNAILS] Guardando ${k.length} thumbnails como archivos...`),console.log(`üîç [DEBUG] URL del endpoint: /api/thumbnails/${n}/save-as-files`);const l=await fetch(`/api/thumbnails/${n}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((m=document.querySelector('meta[name="csrf-token"]'))==null?void 0:m.content)||""},credentials:"include",body:JSON.stringify({thumbnails:k})});if(console.log("üîç [DEBUG] Respuesta del servidor:",{status:l.status,statusText:l.statusText,ok:l.ok}),!l.ok){const E=await l.text();throw console.error("‚ùå [THUMBNAILS] Error respuesta del servidor:",E),new Error(`Error al guardar thumbnails: ${l.status} ${l.statusText}`)}const y=await l.json();return console.log("‚úÖ [THUMBNAILS] Thumbnails guardados como archivos:",y),y}catch(k){throw console.error("‚ùå [THUMBNAILS] Error guardando thumbnails:",k),k}},_s=async(n,f,m,k,l,y,E=!1)=>{try{if(!(f!=null&&f.id))throw new Error("No se encontr√≥ el ID del proyecto");console.log(`üíæ [SAVE] Iniciando ${E?"auto-guardado":"guardado manual"}...`);let S=n;E||(S=await Qa(n,f.id));const U={pages:S,projectInfo:{id:f.id,item_id:m==null?void 0:m.id,title:m==null?void 0:m.title,preset_id:k==null?void 0:k.id},workspace:{width:l.width,height:l.height,scale:l.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:E,totalPages:n.length}},x=E?"save-progress":"save",W=await fetch(`/api/canvas/projects/${f.id}/${x}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:U,thumbnails:y})});if(!W.ok){const M=await W.json().catch(()=>({}));throw new Error(M.message||"Error al guardar el proyecto")}const z=await W.json();if(console.log(`‚úÖ [SAVE] ${E?"Auto-guardado":"Guardado"} exitoso:`,z),!E&&y&&Object.keys(y).length>0){console.log("üñºÔ∏è [SAVE] Guardando thumbnails como archivos...");try{await Ja(f.id,y),console.log("‚úÖ [SAVE] Thumbnails guardados como archivos")}catch(M){console.warn("‚ö†Ô∏è [SAVE] Error guardando thumbnails como archivos:",M)}}return{success:!0,data:z}}catch(S){return console.error(`‚ùå [SAVE] Error en ${E?"auto-guardado":"guardado"}:`,S),{success:!1,error:S.message}}},Ka=(n,f,m,k,l,y)=>{const[E,S]=c.useState("saved"),[U,x]=c.useState(null),[W,z]=c.useState(null),[M,O]=c.useState(null),[j,R]=c.useState(!1),[F,Q]=c.useState(navigator.onLine),G=c.useRef(null),A=c.useRef(null),_=c.useRef(null),ee=c.useRef(!1),X=c.useRef(null),de=15e3,ie=2e3,Ce=5e3,r=c.useCallback((I,K)=>{try{const L={pages:I.map(ne=>{var V;return{id:ne.id,layout:ne.layout,cells:((V=ne.cells)==null?void 0:V.map(ge=>{var at;return{id:ge.id,elements:((at=ge.elements)==null?void 0:at.map(me=>{var xe;return{id:me.id,type:me.type,content:me.type==="image"&&((xe=me.content)!=null&&xe.startsWith("data:image/"))?`[IMAGE_${me.content.length}]`:me.content,position:me.position,size:me.size,style:me.style,filters:me.filters,rotation:me.rotation}}))||[]}}))||[]}})||[],workspace:{width:K==null?void 0:K.width,height:K==null?void 0:K.height}};return btoa(JSON.stringify(L)).substring(0,32)}catch(L){return console.warn("‚ö†Ô∏è [AUTO-SAVE] Error generando hash:",L),Date.now().toString()}},[]),te=c.useCallback(()=>`album_editor_autosave_${(f==null?void 0:f.id)||"draft"}`,[f==null?void 0:f.id]),d=c.useCallback(I=>{try{const K=te(),L={...I,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(K,JSON.stringify(L)),console.log("üíæ [AUTO-SAVE] Guardado en localStorage"),!0}catch(K){return console.error("‚ùå [AUTO-SAVE] Error guardando en localStorage:",K),!1}},[te]),le=c.useCallback(()=>{var I;try{const K=te(),L=localStorage.getItem(K);if(L){const ne=JSON.parse(L);return console.log("üìÇ [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(I=ne.pages)==null?void 0:I.length,savedAt:new Date(ne.savedAt).toLocaleString()}),ne}}catch(K){console.error("‚ùå [AUTO-SAVE] Error cargando desde localStorage:",K)}return null},[te]),ue=c.useCallback(async(I=!1)=>{if(ee.current&&!I){console.log("‚è≥ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(f!=null&&f.id)||!n||n.length===0){console.log("‚ö†Ô∏è [AUTO-SAVE] Datos insuficientes para guardar");return}const K=r(n,l);if(!I&&K===_.current){console.log("üìä [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{ee.current=!0,S("saving"),O(null);const L={pages:n,projectInfo:{id:f.id,item_id:m==null?void 0:m.id,title:m==null?void 0:m.title,preset_id:k==null?void 0:k.id},workspace:l,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:K}};if(d(L),F){const ne=await _s(n,f,m,k,l,y,!0);if(ne.success)_.current=K,z(new Date),S("saved"),R(!1),console.log("‚úÖ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(ne.error)}else console.log("ÔøΩ [AUTO-SAVE] Sin conexi√≥n, solo guardado en localStorage"),S("pending"),R(!0)}catch(L){console.error("‚ùå [AUTO-SAVE] Error:",L),O(L.message),S("error"),F&&(X.current=setTimeout(()=>{console.log("üîÑ [AUTO-SAVE] Reintentando guardado..."),ue(!0)},Ce))}finally{ee.current=!1}},[n,f,m,k,l,y,r,d,F]),He=c.useCallback(async()=>{try{S("saving");const I=await _s(n,f,m,k,l,y,!1);if(I.success){const K=r(n,l);_.current=K,x(new Date),S("saved"),R(!1),Y.success("üíæ Proyecto guardado exitosamente"),console.log("‚úÖ [MANUAL-SAVE] Guardado manual exitoso")}else O(I.error),S("error"),Y.error(`‚ùå Error al guardar: ${I.error}`);return I.success}catch(I){return console.error("‚ùå [MANUAL-SAVE] Error:",I),O(I.message),S("error"),Y.error(`‚ùå Error inesperado: ${I.message}`),!1}},[n,f,m,k,l,y,r]);return c.useEffect(()=>{if(!(f!=null&&f.id)||!n||n.length===0)return;const I=r(n,l);return _.current&&I!==_.current?(console.log("üîÑ [AUTO-SAVE] Cambios detectados, programando guardado..."),R(!0),S("pending"),A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{ue()},ie)):_.current||(_.current=I),()=>{A.current&&clearTimeout(A.current)}},[n,l,f==null?void 0:f.id,r,ue]),c.useEffect(()=>{if(f!=null&&f.id)return G.current&&clearInterval(G.current),G.current=setInterval(()=>{j&&(console.log("‚è∞ [AUTO-SAVE] Auto-save peri√≥dico activado"),ue())},de),()=>{G.current&&clearInterval(G.current)}},[f==null?void 0:f.id,j,ue]),c.useEffect(()=>{const I=()=>{console.log("üåê [AUTO-SAVE] Conexi√≥n restaurada"),Q(!0),j&&setTimeout(()=>ue(!0),1e3)},K=()=>{console.log("üì¥ [AUTO-SAVE] Conexi√≥n perdida"),Q(!1)};return window.addEventListener("online",I),window.addEventListener("offline",K),()=>{window.removeEventListener("online",I),window.removeEventListener("offline",K)}},[j,ue]),c.useEffect(()=>{const I=K=>{if(j){const L={pages:n,projectInfo:{id:f.id},workspace:l,meta:{savedAt:new Date().toISOString()}};return d(L),K.preventDefault(),K.returnValue="¬øEst√°s seguro de salir? Hay cambios sin guardar.","¬øEst√°s seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",I),()=>window.removeEventListener("beforeunload",I)},[j,n,f==null?void 0:f.id,l,d]),c.useEffect(()=>()=>{A.current&&clearTimeout(A.current),G.current&&clearInterval(G.current),X.current&&clearTimeout(X.current)},[]),c.useEffect(()=>{M&&(M.includes("max_allowed_packet")||M.includes("data_too_large")?Y.error("‚ùå El proyecto es demasiado grande para guardar autom√°ticamente. Reduce el n√∫mero o tama√±o de im√°genes."):Y.error(`‚ùå Error de auto-guardado: ${M}`))},[M]),{saveStatus:E,lastSaved:U,lastAutoSaved:W,saveError:M,hasUnsavedChanges:j,isOnline:F,saveManually:He,performAutoSave:()=>ue(!0),loadFromLocalStorage:le,getStorageKey:te,autoSaveInterval:de,debounceDelay:ie}},Xa=({saveStatus:n,lastSaved:f,lastAutoSaved:m,hasUnsavedChanges:k,isOnline:l,saveError:y,onManualSave:E,className:S=""})=>{const U=z=>{if(!z)return null;const O=new Date-z,j=Math.floor(O/(1e3*60)),R=Math.floor(O/1e3);if(R<30)return"hace unos segundos";if(j<1)return`hace ${R}s`;if(j<60)return`hace ${j}m`;const F=Math.floor(j/60);return F<24?`hace ${F}h`:z.toLocaleDateString()},W=(()=>{if(!l)return{icon:e.jsx(Us,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexi√≥n",detail:"Guardado local activo"};switch(n){case"saving":return{icon:e.jsx(ka,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(Ca,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:m?`Auto-guardado ${U(m)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(Sa,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:y||"Error desconocido"};case"pending":return{icon:e.jsx(Na,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:k?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(Vs,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${S}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${W.bg} ${W.color}
                    hover:shadow-md
                `,onClick:()=>n!=="saving"&&(E==null?void 0:E()),children:[W.icon,e.jsx("span",{className:"text-sm font-medium",children:W.text}),k&&n!=="saving"&&e.jsx("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-pulse"}),e.jsx("div",{className:"flex items-center",children:l?e.jsx(Fa,{className:"w-3 h-3 text-green-500"}):e.jsx(Us,{className:"w-3 h-3 text-orange-500"})})]}),e.jsxs("div",{className:`
                absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2
                bg-gray-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg
                opacity-0 group-hover:opacity-100 pointer-events-none
                transition-opacity duration-200 z-50 whitespace-nowrap
            `,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:W.text}),e.jsx("div",{className:"text-gray-300",children:W.detail}),f&&e.jsxs("div",{className:"text-gray-400 text-xs",children:["√öltimo guardado manual: ",U(f)]}),e.jsxs("div",{className:"text-gray-400 text-xs",children:[l?"üåê En l√≠nea":"üì¥ Sin conexi√≥n",n!=="saving"&&" ‚Ä¢ Click para guardar"]})]}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"})]}),n==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})};function De(n,f){let m;return function(...l){const y=()=>{clearTimeout(m),n(...l)};clearTimeout(m),m=setTimeout(y,f)}}const yt=vt.memo(({pageId:n,thumbnail:f,altText:m,type:k})=>{const[l,y]=c.useState(!1),[E,S]=c.useState(!1);if(f&&!E)return e.jsxs("div",{className:"relative w-full h-full",children:[!l&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:f,alt:m,className:`w-full h-full object-contain transition-opacity duration-200 ${l?"opacity-100":"opacity-0"}`,onLoad:()=>y(!0),onError:()=>S(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const U=k==="cover"||k==="final"?et:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((x,W)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},W))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(U,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(n,f)=>n.pageId===f.pageId&&n.thumbnail===f.thumbnail&&n.altText===f.altText&&n.type===f.type),Ya=vt.memo(({images:n,onImageSelect:f,isLoading:m})=>{const k=vt.memo(({image:l})=>{const[y,E]=c.useState(!1),[S,U]=c.useState(!1),[x,W]=c.useState(!1),[{isDragging:z},M]=Ma(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:l.url},collect:Q=>({isDragging:!!Q.isDragging()}),end:()=>{setTimeout(()=>W(!1),100)}})),O=l.thumbnail_url||l.url,j=l.url,R=Q=>{W(!0),setTimeout(()=>W(!1),500)},F=Q=>{if(x||z)return Q.preventDefault(),Q.stopPropagation(),!1;f(j)};return e.jsxs("div",{ref:M,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${z?"opacity-50 scale-95":""}`,onMouseDown:R,onClick:F,children:[e.jsxs("div",{className:"aspect-square relative",children:[!y&&!S&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),S?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Oe,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:O,alt:l.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${y?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>E(!0),onError:()=>U(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(tt,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:l.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),l.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return m?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((l,y)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},y))}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Oe,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay im√°genes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:n.map((l,y)=>e.jsx(k,{image:l},`${l.id||l.url}-${y}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[n.filter(l=>l.has_thumbnail).length," de ",n.length," im√°genes optimizadas"]})})]})});function so(){var Bt,Gt,Ht,Wt,qt,Qt,Jt,Kt,Xt,Yt,Zt,Dt,es,ts,ss,as,ns,os,rs,is,ls,cs,ds,us,gs,ms,hs,fs,ps,xs,bs,ys,vs,ws,Es,js,Ns,Ss,Cs,ks;const[n,f]=c.useState(null),[m,k]=c.useState(null),[l,y]=c.useState(null),[E,S]=c.useState(null),[U,x]=c.useState(!0),[W,z]=c.useState(null),[M,O]=c.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[j,R]=c.useState(new Map),[F,Q]=c.useState([]),[G,A]=c.useState(!1),_=c.useRef(F),ee=c.useRef(j);c.useRef(null);const X=c.useRef(null),de=c.useRef(null);c.useEffect(()=>{_.current=F},[F]),c.useEffect(()=>{ee.current=j},[j]),c.useEffect(()=>{(async()=>{var s;try{const o=new URLSearchParams(window.location.search).get("project");if(!o){z("No se encontr√≥ el ID del proyecto en la URL"),x(!1);return}const i=await fetch(`/api/canvas/projects/${o}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!i.ok)throw new Error("Error al cargar el proyecto");const u=await i.json();f(u.project),k(u.item),y(u.canvasPreset),S(u.initialProject),x(!1)}catch(a){console.error("‚ùå Error cargando proyecto:",a),z(a.message),x(!1)}})()},[]);const[ie,Ce]=c.useState(Ms.Local.get(`${Os.APP_CORRELATIVE}_cart`)??[]);c.useEffect(()=>{Ms.Local.set(`${Os.APP_CORRELATIVE}_cart`,ie)},[ie]);const[r,te]=c.useState([]),[d,le]=c.useState(0),[ue,He]=c.useState("preset"),[I,K]=c.useState(null),[L,ne]=c.useState(null),[V,ge]=c.useState("pages"),[at,me]=c.useState("basic"),[xe,Le]=c.useState([JSON.stringify(r)]),[he,Te]=c.useState(0),[Hs,Za]=c.useState(!1),[Da,wt]=c.useState(null),[D,ae]=c.useState({}),[en,tn]=c.useState(!1),[ve,Ie]=c.useState([]),[nt,Et]=c.useState(!1),[We,Ws]=c.useState(new Map),[_e,qs]=c.useState(()=>new Map),[Re,qe]=c.useState(null),[jt,Nt]=c.useState(!1);c.useEffect(()=>{console.log("‚úÖ [FILTERS] Tab actual:",V)},[V]),c.useCallback((t,s="manual")=>{if(console.log(`üîÑ [ACTIVE_TAB] Cambiando de "${V}" a "${t}" - Raz√≥n: ${s}`),t==="filters"&&s!=="manual"){console.warn("üö® [ACTIVE_TAB] Cambio autom√°tico a filters bloqueado!");return}ge(t)},[V]),console.log("üéâ [FILTERS FIX] Editor cargado - Fix del problema de filtros ACTIVADO");const[Qe,ze]=c.useState(!1),St=c.useRef(),[$,Ct]=c.useState({width:800,height:600}),ot=c.useCallback(async()=>{if(n!=null&&n.id)try{const t=await fetch(`/api/thumbnails/${n.id}`);if(t.ok){const s=await t.json();if(s.success&&s.thumbnails&&s.thumbnails.length>0){const a={};s.thumbnails.forEach(o=>{o.page_id&&o.thumbnail_url&&(a[o.page_id]=o.thumbnail_url)}),Object.keys(a).length>0?(ae(o=>({...o,...a})),console.log("‚úÖ Thumbnails cargados desde storage:",Object.keys(a).length)):console.log("‚ÑπÔ∏è No hay thumbnails guardados, usando generaci√≥n local")}else console.log("‚ÑπÔ∏è No hay thumbnails guardados para este proyecto")}}catch(t){console.warn("‚ö†Ô∏è Error cargando thumbnails guardados (usando locales):",t)}},[n==null?void 0:n.id]),fe=c.useCallback(async()=>{if(!r[d]||!$)return;const t=r[d];if(D[t.id]){console.log(`‚úÖ Thumbnail ya existe para p√°gina: ${t.id}`);return}if(we.current){console.log("‚è≥ Ya se est√° generando un thumbnail...");return}we.current=!0;try{console.log(`üì∏ Generando thumbnail para p√°gina actual: ${t.id}`);const s=await Ha({page:t,workspaceDimensions:$,onProgress:a=>{qe(a)}});s&&(ae(a=>({...a,[t.id]:s})),console.log(`‚úÖ Thumbnail generado para p√°gina: ${t.id}`))}catch(s){console.warn("‚ö†Ô∏è Error generando thumbnail de p√°gina actual:",s)}finally{we.current=!1,qe(null)}},[r,d,$,D]),rt=c.useCallback(De(async()=>{if(!(!(r!=null&&r.length)||!$)){if(we.current){console.log("‚è≥ Thumbnails ya se est√°n generando, saltando...");return}we.current=!0;try{const t=r.filter(a=>!D[a.id]);if(t.length===0){console.log("‚úÖ Todos los thumbnails ya existen");return}console.log(`üì∏ Generando ${t.length} thumbnails r√°pidos...`);const s=await Ls({pages:t,workspaceDimensions:$,onProgress:a=>{qe(a)}});s&&Object.keys(s).length>0&&(ae(a=>({...a,...s})),console.log("‚úÖ Thumbnails r√°pidos generados:",Object.keys(s).length))}catch(t){console.warn("‚ö†Ô∏è Error generando thumbnails r√°pidos:",t)}finally{we.current=!1,qe(null)}}},300),[r,$,D]),we=c.useRef(!1);c.useCallback(async(t=[])=>{if(!we.current)try{if(we.current=!0,t.length>0){const s=r.filter(a=>t.includes(a.id));if(s.length>0){console.log(`üéØ Generando ${s.length} thumbnails prioritarios...`);const a=await Ls({pages:s,workspaceDimensions:$});a&&Object.keys(a).length>0&&ae(o=>({...o,...a}))}}}catch(s){console.warn("‚ö†Ô∏è Error en generaci√≥n prioritaria:",s)}finally{we.current=!1}},[r,$,rt]);const kt=c.useCallback(t=>{if(_e.has&&_e.has(t))return;const s=new Image;s.crossOrigin="anonymous",s.onload=()=>{if(s.width>1200||s.height>1200){const o=document.createElement("canvas"),i=o.getContext("2d"),u=1200,h=Math.min(u/s.width,u/s.height),g=s.width*h,p=s.height*h;o.width=g,o.height=p,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(s,0,0,g,p),o.toBlob(b=>{if(b){const w=URL.createObjectURL(b);qs(N=>{const T=new Map(N);if(T.set(t,w),T.size>15){const v=T.keys().next().value,C=T.get(v);URL.revokeObjectURL(C),T.delete(v)}return T})}},"image/webp",.85)}},s.onerror=()=>{console.warn("‚ùå Error pre-cargando imagen:",t)},s.src=t},[]);c.useEffect(()=>{ve.length>0&&ve.slice(0,10).forEach((s,a)=>{setTimeout(()=>{kt(s.url)},a*100)})},[ve,kt]),c.useEffect(()=>()=>{_e&&_e.forEach&&_e.forEach(t=>URL.revokeObjectURL(t))},[]),c.useEffect(()=>()=>{Wa()},[]);const At=c.useCallback(async()=>{var t;if(!(!(n!=null&&n.id)||!(r!=null&&r.length))){if(jt){console.log("‚è≥ Ya hay una carga de thumbnails en progreso, omitiendo...");return}try{Nt(!0),console.log("üîÑ Iniciando carga de thumbnails existentes...");const s=await fetch(`/api/thumbnails/${n.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:r})});if(s.ok){const a=await s.json();a&&Object.keys(a).length>0?(ae(o=>({...o,...a})),console.log("‚úÖ Thumbnails existentes cargados:",Object.keys(a).length)):(console.log("üì∏ No hay thumbnails existentes, generando para p√°gina actual..."),setTimeout(()=>fe(),200))}}catch(s){console.warn("‚ö†Ô∏è Error cargando thumbnails existentes:",s),setTimeout(()=>fe(),200)}finally{Nt(!1)}}},[n==null?void 0:n.id,r,fe,jt]);c.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(r!=null&&r.length)))try{const t=r[d];if(!t)return;const s=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(s.ok){const a=await s.json();if(a.success&&a.thumbnails){const o={};a.thumbnails.forEach(i=>{i.page_id&&i.thumbnail_url&&(o[i.page_id]=i.thumbnail_url)}),ae(i=>({...i,...o})),console.log("‚úÖ Thumbnail generado y guardado en storage para p√°gina actual:",a.thumbnails.length)}}}catch(t){console.warn("‚ö†Ô∏è Error generando thumbnail:",t)}},[n==null?void 0:n.id,r,d,$]),c.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(r!=null&&r.length)))try{const t=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:r,width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(t.ok){const s=await t.json();if(s.success&&s.thumbnails){const a={};s.thumbnails.forEach(o=>{o.page_id&&o.thumbnail_url&&(a[o.page_id]=o.thumbnail_url)}),ae(o=>({...o,...a})),console.log("‚úÖ Todos los thumbnails generados y guardados en storage:",s.thumbnails.length)}}}catch(t){console.warn("‚ö†Ô∏è Error generando todos los thumbnails:",t)}},[n==null?void 0:n.id,r,$]);const Qs=c.useCallback(async(t=null)=>{if(!(n!=null&&n.id)||!(r!=null&&r.length))return{};try{console.log("üìñ [ALBUM-MODAL] Cargando thumbnails PDF existentes...");const s={},a={};let o=0;const i=async(h,g)=>new Promise(p=>{const b=new Image;b.onload=()=>{a[g]=h,o++,t==null||t(o,r.length),p(!0)},b.onerror=()=>{console.warn(`‚ö†Ô∏è [ALBUM-MODAL] Thumbnail no encontrado: ${h}`),o++,t==null||t(o,r.length),p(!1)},b.src=h}),u=r.map(async(h,g)=>{const p=`/storage/images/thumbnails/${n.id}/page-${g}-pdf.png`,b=h.id||`page-${g}`;return s[b]=p,i(p,b)});return await Promise.all(u),console.log(`‚úÖ [ALBUM-MODAL] Thumbnails verificados: ${Object.keys(a).length}/${r.length}`),s}catch(s){return console.warn("‚ö†Ô∏è [ALBUM-MODAL] Error cargando thumbnails PDF:",s),{}}},[n==null?void 0:n.id,r]);c.useEffect(()=>{if(E&&m&&l){if(E.pages&&Array.isArray(E.pages)){const t=E.pages.map(s=>{let a=null,o=l.background_color||"#ffffff";return s.type==="cover"?m.cover_image&&(a=`/storage/images/item/${m.cover_image}`):s.type==="content"?m.content_image&&(a=`/storage/images/item/${m.content_image}`):(s.type==="final"||s.type==="contraportada")&&m.back_cover_image&&(a=`/storage/images/item/${m.back_cover_image}`),{...s,backgroundImage:a,backgroundColor:o}});te(s=>s.length>0?(console.log("‚ö†Ô∏è P√°ginas ya existentes, preservando cambios del usuario"),s.map((a,o)=>{const i=t[o];return i?{...a,backgroundImage:a.backgroundImage||i.backgroundImage,backgroundColor:a.backgroundColor||i.backgroundColor}:a})):(console.log("üìÑ Carga inicial de p√°ginas desde la base de datos"),t)),Le(s=>s.length<=1?[JSON.stringify(t)]:s),Te(s=>s===0&&xe.length<=1?0:s),setTimeout(()=>{ot()},100)}else{const t=_t(l,m);te(t),Le([JSON.stringify(t)]),Te(0),setTimeout(()=>{ot()},100)}typeof E.currentPage=="number"&&le(E.currentPage),E.workspaceSize&&He(E.workspaceSize)}},[E,m,l,ot]);const Ee=Ka(r,n,m,l,$,D),Tt=()=>{if(l!=null&&l.width&&(l!=null&&l.height)){let g=l.width,p=l.height,b=g*37.8,w=p*37.8;if(b&&w){const N=window.innerWidth*.6,T=window.innerHeight*.7,v=N/b,C=T/w,P=Math.min(v,C,1);return{width:Math.round(b*P),height:Math.round(w*P),originalWidth:g,originalHeight:p,scale:P,unit:"cm",originalWidthPx:Math.round(b),originalHeightPx:Math.round(w)}}}if(l!=null&&l.extra_settings)try{const g=typeof l.extra_settings=="string"?JSON.parse(l.extra_settings):l.extra_settings;if(g!=null&&g.canvas_config){const p=g.canvas_config;let b=p.width,w=p.height,N=b*37.8,T=w*37.8;if(N&&T){const v=window.innerWidth*.6,C=window.innerHeight*.7,P=v/N,B=C/T,Z=Math.min(P,B,1);return{width:Math.round(N*Z),height:Math.round(T*Z),originalWidth:b,originalHeight:w,scale:Z,unit:"cm",originalWidthPx:Math.round(N),originalHeightPx:Math.round(T)}}}}catch(g){console.warn("Error parsing extra_settings:",g)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},s=t[ue]||t.preset,a=window.innerWidth*.6,o=window.innerHeight*.7,i=a/s.width,u=o/s.height,h=Math.min(i,u,1);return{width:Math.round(s.width*h),height:Math.round(s.height*h),originalWidth:s.width,originalHeight:s.height,scale:h,unit:"px"}},je=c.useCallback(async(t={type:"thumbnail"})=>{if(!r[d])return null;try{let s=document.querySelector(`#page-${r[d].id}`);if(!s)return console.warn("‚ùå THUMBNAIL: No se encontr√≥ el elemento de p√°gina espec√≠fico"),null;const a=r[d],o=t.type==="pdf",i=o?11.81:3,u=1,h=getComputedStyle(s);let g=(a==null?void 0:a.backgroundColor)||"#ffffff";h.backgroundColor&&h.backgroundColor!=="rgba(0, 0, 0, 0)"&&(g=h.backgroundColor);const p={scale:i,useCORS:!0,allowTaint:!1,backgroundColor:g,width:$.width,height:$.height,x:0,y:0,scrollX:0,scrollY:0,foreignObjectRendering:!!o,removeContainer:!1,logging:!1,imageTimeout:o?6e4:15e3,pixelRatio:o?3:window.devicePixelRatio||1,canvas:o?document.createElement("canvas"):null,windowWidth:o?$.width*i:null,windowHeight:o?$.height*i:null,onclone:async N=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(v=>{try{N.querySelectorAll(v).forEach(P=>P.remove())}catch(C){console.warn("Error removing selector:",v,C)}});try{const v=N.querySelector(`#page-${r[d].id}`);v&&(v.style.width=$.width+"px",v.style.height=$.height+"px",v.style.position="relative",v.style.overflow="hidden",a!=null&&a.backgroundImage&&(v.style.backgroundImage=`url(${a.backgroundImage})`,v.style.backgroundSize="cover",v.style.backgroundPosition="center",v.style.backgroundRepeat="no-repeat"),a!=null&&a.backgroundColor&&(v.style.backgroundColor=a.backgroundColor))}catch(v){console.error("‚ùå [THUMBNAIL-FIX] Error configurando elemento de p√°gina:",v)}try{const v=new Map;s.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((q,Ne)=>{if(q.complete&&q.naturalWidth>0){const ce=(q.closest('[data-element-type="image"]')||q.parentElement).getBoundingClientRect(),be=q.getBoundingClientRect();v.set(q.src,{src:q.src,naturalWidth:q.naturalWidth,naturalHeight:q.naturalHeight,containerWidth:ce.width,containerHeight:ce.height,objectFit:getComputedStyle(q).objectFit||"cover",objectPosition:getComputedStyle(q).objectPosition||"center",crossOrigin:q.crossOrigin})}});const P=async(q,Ne,oe,ce,be)=>new Promise(Pe=>{try{const Me=Ne/oe,ht=ce/be;let Ke,Xe,ft,pt,As,Ts;ht>Me?(Ts=oe,As=oe*ht,Xe=be,Ke=be*Me,ft=(ce-Ke)/2,pt=0):(As=Ne,Ts=Ne/ht,Ke=ce,Xe=ce/Me,ft=0,pt=(be-Xe)/2);const Ye=N.createElement("canvas");Ye.width=Ne,Ye.height=oe;const ua=Ye.getContext("2d"),Ge=new Image;Ge.crossOrigin="anonymous",Ge.onload=()=>{try{ua.drawImage(Ge,ft,pt,Ke,Xe,0,0,Ne,oe);const xt=Ye.toDataURL("image/png",1);q.src=xt,q.style.objectFit="fill",q.style.objectPosition="center",q.style.width="100%",q.style.height="100%",Pe()}catch(xt){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en canvas processing:",xt),Pe()}},Ge.onerror=()=>{console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),Pe()},Ge.src=q.src}catch(Me){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",Me),Pe()}}),B=N.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),Z=[];B.forEach((q,Ne)=>{if(q.src&&v.has(q.src)){const oe=v.get(q.src),ce=q.closest('[data-element-type="image"]')||q.parentElement;if(ce&&(ce.style.overflow="hidden",ce.style.position="relative"),oe.objectFit==="cover"||q.classList.contains("object-cover")||q.classList.contains("workspace-image")){const be=P(q,oe.containerWidth,oe.containerHeight,oe.naturalWidth,oe.naturalHeight);Z.push(be)}else q.style.width="100%",q.style.height="100%",q.style.objectFit="fill"}}),Z.length>0&&await Promise.all(Z);const H=N.createElement("style");H.textContent=`
                            /* CORRECCI√ìN THUMBNAIL: Estructura del elemento de p√°gina */
                            #page-${r[d].id} {
                                width: ${$.width}px !important;
                                height: ${$.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* üñ®Ô∏è IM√ÅGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya est√°n recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${o?`
                                /* üñ®Ô∏è IMPRESI√ìN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de p√°gina */
                            #page-${r[d].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* üñ®Ô∏è OPTIMIZACIONES GENERALES PARA PDF DE IMPRESI√ìN */
                            ${o?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,N.head.appendChild(H)}catch(v){console.error("‚ùå [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",v);const C=N.createElement("style");C.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,N.head.appendChild(C)}}},b=await Ps(s,p);if(o&&b){const N=b.getContext("2d");if(N){N.imageSmoothingEnabled=!1,N.imageSmoothingQuality="high";const T=N.getImageData(0,0,b.width,b.height),v=T.data;for(let C=0;C<v.length;C+=4)v[C]=Math.min(255,v[C]*1.05),v[C+1]=Math.min(255,v[C+1]*1.05),v[C+2]=Math.min(255,v[C+2]*1.05);N.putImageData(T,0,0)}}if(!b)throw new Error("html2canvas no devolvi√≥ un canvas v√°lido para el elemento de p√°gina");if(b.width===0||b.height===0)throw new Error("Canvas del elemento de p√°gina tiene dimensiones inv√°lidas");const w=b.toDataURL("image/png",u);if(!w||w==="data:,")throw new Error("No se pudo generar dataURL del elemento de p√°gina");return o?b:w}catch(s){console.error("‚ùå [THUMBNAIL-FIX] Error capturando elemento de p√°gina:",s);try{const a=document.createElement("canvas"),o=t.type==="pdf"?11.81:1;a.width=$.width*o,a.height=$.height*o;const i=a.getContext("2d"),u=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return i.fillStyle=u,i.fillRect(0,0,a.width,a.height),i.fillStyle=u==="#ffffff"||u.includes("white")?"#374151":"#666666",i.font=`${14*o}px Arial`,i.textAlign="center",i.fillText("P√°gina "+(d+1),a.width/2,a.height/2),t.type==="pdf"?a:a.toDataURL("image/png",1)}catch{return null}}},[d,r]);c.useCallback(async()=>{if(!r[d])return;const t=await je({type:"thumbnail"});t&&ae(s=>({...s,[r[d].id]:t}))},[je,d,r]),c.useCallback(()=>{clearTimeout(St.current),St.current=setTimeout(()=>{r[d]&&(ae(t=>{const s={...t};return delete s[r[d].id],s}),setTimeout(()=>{fe()},200))},1e3)},[r,d,fe]);const Js=c.useCallback(()=>{r[d]&&(ae(t=>{const s={...t};return delete s[r[d].id],s}),setTimeout(()=>{fe()},300))},[r,d,fe]),Ks=c.useCallback(async(t=d,s={width:800,height:600})=>{var a,o;if(!r[t])return null;try{const i=d;t!==d&&(le(t),await new Promise(p=>setTimeout(p,100)));const u=document.querySelector(`#page-${r[t].id}`);if(!u)return console.warn("Workspace element not found for page:",r[t].id),null;const h={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((a=r[t])==null?void 0:a.backgroundColor)||"#ffffff",width:u.offsetWidth,height:u.offsetHeight,removeContainer:!0,logging:!1,onclone:p=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(v=>{p.querySelectorAll(v).forEach(P=>P.remove())});const w=p.querySelector(`#page-${r[t].id}`);if(w){const v=r[t];v!=null&&v.backgroundImage&&(w.style.backgroundImage=`url(${v.backgroundImage})`,w.style.backgroundSize="cover",w.style.backgroundPosition="center",w.style.backgroundRepeat="no-repeat"),v!=null&&v.backgroundColor&&(w.style.backgroundColor=v.backgroundColor)}try{const v=u.querySelectorAll("img"),C=new Map;v.forEach((B,Z)=>{const H=getComputedStyle(B);C.set(Z,{objectFit:H.objectFit,objectPosition:H.objectPosition,width:H.width,height:H.height,borderRadius:H.borderRadius,transform:H.transform})}),p.querySelectorAll("img").forEach((B,Z)=>{const H=C.get(Z);H&&(B.style.objectFit=H.objectFit||"cover",B.style.objectPosition=H.objectPosition||"center",B.style.width=H.width,B.style.height=H.height,B.style.borderRadius=H.borderRadius,B.style.transform=H.transform)})}catch(v){console.warn("Error preservando estilos de im√°genes:",v),p.querySelectorAll("img").forEach(P=>{P.style.objectFit="cover",P.style.objectPosition="center",P.style.width||(P.style.width="100%"),P.style.height||(P.style.height="100%")})}p.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(v=>{const C=v.className;C&&(v.className=C);const P=getComputedStyle?getComputedStyle(v):null;P&&(P.fontFamily&&P.fontFamily!=="Arial"&&(v.style.fontFamily=P.fontFamily),P.fontSize&&(v.style.fontSize=P.fontSize),P.fontWeight&&(v.style.fontWeight=P.fontWeight),P.fontStyle&&(v.style.fontStyle=P.fontStyle))});const T=p.createElement("style");T.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CR√çTICO: Asegurar que las im√°genes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CR√çTICO: Asegurar que los backgrounds de p√°gina se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,p.head.appendChild(T)}},g=await Ps(u,h);if(s.width!==g.width||s.height!==g.height){const p=document.createElement("canvas");p.width=s.width,p.height=s.height;const b=p.getContext("2d"),w=g.width/g.height,N=s.width/s.height;let T,v,C=0,P=0;w>N?(T=s.width,v=s.width/w,P=(s.height-v)/2):(v=s.height,T=s.height*w,C=(s.width-T)/2),b.fillStyle=((o=r[t])==null?void 0:o.backgroundColor)||"#ffffff",b.fillRect(0,0,s.width,s.height),b.drawImage(g,C,P,T,v);const B=p.toDataURL("image/png",1);return t!==i&&le(i),B}return t!==i&&le(i),g.toDataURL("image/png",1)}catch(i){return console.error("‚ùå Error generando thumbnail de alta calidad:",i),null}},[r,d,le]);c.useEffect(()=>{const t=Tt();Ct(t)},[l,ue]),c.useEffect(()=>{const t=()=>{const s=Tt();Ct(s)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[l,ue]),c.useEffect(()=>{if(r[d]&&!D[r[d].id]){const t=setTimeout(()=>{fe()},500);return()=>clearTimeout(t)}},[d,r,D,fe]),c.useEffect(()=>{const t=r[d];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(s=>{s.ok?console.log("‚úÖ [WORKSPACE] Imagen existe en el servidor"):console.error("‚ùå [WORKSPACE] Imagen NO existe en el servidor. Status:",s.status)}).catch(s=>{console.error("‚ùå [WORKSPACE] Error verificando imagen:",s)})},[d,(Bt=r[d])==null?void 0:Bt.backgroundImage]),c.useEffect(()=>{const t=`${$.width}x${$.height}`,s=sessionStorage.getItem("lastWorkspaceDimensions");s&&s!==t&&r.length>0&&(ae({}),setTimeout(()=>{r[d]&&Js()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[$.width,$.height]),c.useEffect(()=>{if(!(n!=null&&n.id)||r.length===0)return;let t,s=Date.now(),a=!1;const o=()=>{a=!0,s=Date.now()},i=async()=>{if(a)try{console.log("üîÑ [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(p=>({...p,saveStatus:"saving"}));const h=await fetch(`/api/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:r,force:!1})}),g=await h.json();if(h.ok&&g.success)a=!1,O(p=>({...p,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("‚úÖ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado fall√≥")}catch(h){console.error("‚ùå [AUTO-SAVE] Error en guardado silencioso:",h),O(g=>({...g,saveStatus:"error",saveError:h.message}))}},u=()=>{t=setInterval(()=>{const h=Date.now()-s;a&&h>6e4&&(console.log("‚è∞ [AUTO-SAVE] Condiciones cumplidas para guardado autom√°tico"),i())},3*60*1e3)};return JSON.stringify(r),r[d],o(),u(),()=>{t&&clearInterval(t)}},[r,d,n==null?void 0:n.id]),c.useEffect(()=>{var s;if(!r[d])return;const t=((s=r[d].cells)==null?void 0:s.flatMap(a=>a.elements))||[];JSON.stringify(t),O(a=>({...a,hasUnsavedChanges:!0}))},[(Gt=r[d])==null?void 0:Gt.cells,d]);const[sn,it]=c.useState(!1),[an,Xs]=c.useState({elementId:null,cellId:null}),[Ys,It]=c.useState(!1),[nn,Zs]=c.useState(!1),[on,rn]=c.useState(null),[Ds,ea]=c.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[ke,pe]=c.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de √°lbum...",subMessage:"Preparando tu vista previa personalizada"}),lt=c.useRef(null),Pt=t=>{var o,i,u,h;const s=L||((i=(o=r[d])==null?void 0:o.cells[0])==null?void 0:i.id);if(!s)return;const a={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((h=(u=r[d].cells.find(g=>g.id===s))==null?void 0:u.elements)==null?void 0:h.length)||0)+1};Be(s,a),Y.success("Imagen a√±adida correctamente")},ct=c.useCallback(De(async(t=!1)=>{if(!(n!=null&&n.id))return;const s=We.get(n.id);if(!t&&s&&s.length>0){console.log("üîÑ Usando im√°genes desde cache"),ve.length===0&&Ie(s);return}if(X.current&&clearTimeout(X.current),nt&&!t){console.log("‚è≥ Carga de im√°genes ya en progreso");return}Et(!0);try{const a=new AbortController,o=setTimeout(()=>a.abort(),1e4),i=await fetch(`/api/canvas/projects/${n.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:a.signal});if(clearTimeout(o),!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const u=await i.json();if(u.success){const h=u.images||[],g=JSON.stringify(ve),p=JSON.stringify(h);g!==p&&(Ie(h),Ws(b=>{const w=new Map(b);if(w.set(n.id,h),w.size>5){const N=w.keys().next().value;w.delete(N)}return w}))}else console.error("Error cargando im√°genes:",u.message),Y.error("Error cargando galer√≠a de im√°genes")}catch(a){a.name==="AbortError"?console.warn("‚ö†Ô∏è Carga de im√°genes cancelada por timeout"):(console.error("Error cargando im√°genes del proyecto:",a),Y.error("Error de conexi√≥n al cargar im√°genes"))}finally{Et(!1)}},200),[n==null?void 0:n.id,We,ve,nt]),ta=c.useCallback(async t=>{const s=t.target.files[0];if(!s||!(n!=null&&n.id))return;const a=Y.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),o=URL.createObjectURL(s),i={id:`temp-${Date.now()}`,filename:s.name,url:o,thumbnail_url:o,has_thumbnail:!1,size:s.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Ie(h=>[i,...h]),Pt(o);const u=new FormData;u.append("image",s),u.append("projectId",n.id);try{const g=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:u})).json();if(g.success){const p={id:g.id||Date.now(),filename:s.name,url:g.url,thumbnail_url:g.thumbnail_url||g.url,has_thumbnail:g.has_thumbnail||!1,size:s.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Ie(b=>[p,...b.filter(w=>w.id!==i.id)]),setTimeout(()=>{te(b=>{const w=[...b];return w[d].cells.forEach(T=>{T.elements.forEach(v=>{v.type==="image"&&v.content===o&&(v.content=g.url)})}),w})},100),Y.dismiss(a),Y.success(g.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{ct(!0)},2e3)}else Ie(p=>p.filter(b=>b.id!==i.id)),URL.revokeObjectURL(o),Y.dismiss(a),Y.error(g.message||"Error al subir la imagen")}catch(h){console.error("Error subiendo la imagen:",h),Ie(g=>g.filter(p=>p.id!==i.id)),URL.revokeObjectURL(o),Y.dismiss(a),Y.error("Error de red al subir la imagen")}},[n==null?void 0:n.id,d,Pt,ct]);c.useEffect(()=>{if(n!=null&&n.id){const t=We.get(n.id);if(t&&t.length>0){Ie(t);return}return X.current=setTimeout(()=>{ct(!1)},150),()=>{X.current&&clearTimeout(X.current)}}},[n==null?void 0:n.id,We]),c.useEffect(()=>()=>{X.current&&clearTimeout(X.current)},[]);const Mt=(t,s)=>{if(console.log("üñºÔ∏è [ADD-IMAGE] Agregando imagen sin selecci√≥n autom√°tica"),!r||r.length===0||!r[d]){console.error("‚ùå [ADD-IMAGE] No hay p√°ginas v√°lidas para agregar imagen");return}const a=JSON.parse(JSON.stringify(r));let o=!1;for(let i=0;i<a[d].cells.length;i++)if(a[d].cells[i].id===t){a[d].cells[i].elements.push(s),o=!0,console.log("‚úÖ [ADD-IMAGE] Imagen agregada a la celda:",t);break}if(!o){console.error("‚ùå [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{Ve(a),console.log("‚úÖ [ADD-IMAGE] Estado actualizado sin selecci√≥n autom√°tica")},0)},sa=c.useCallback(t=>{var h,g,p,b;console.log("üñºÔ∏è [ADD-FROM-GALLERY] Iniciando proceso de agregar imagen:",t);const s=Qe;ze(!0);const a=V==="images",o=L||((g=(h=r[d])==null?void 0:h.cells[0])==null?void 0:g.id);if(!o){console.error("‚ùå [ADD-FROM-GALLERY] No hay celda disponible"),Y.error("No hay celda disponible para agregar la imagen"),ze(s);return}if(!t||typeof t!="string"){console.error("‚ùå [ADD-FROM-GALLERY] URL de imagen inv√°lida"),Y.error("URL de imagen no v√°lida"),ze(s);return}const i=JSON.parse(JSON.stringify(r));console.log("üì∏ [ADD-FROM-GALLERY] Snapshot del estado actual capturado");const u={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((b=(p=i[d].cells.find(w=>w.id===o))==null?void 0:p.elements)==null?void 0:b.length)||0)+1};console.log("üìù [ADD-FROM-GALLERY] Elemento creado:",u),setTimeout(()=>{Mt(o,u),setTimeout(()=>{a&&(ge("images"),console.log("üîÑ [ADD-FROM-GALLERY] Tab restaurado a images")),setTimeout(()=>{ze(s),Y.success("‚úÖ Imagen a√±adida desde la galer√≠a"),console.log("‚úÖ [ADD-FROM-GALLERY] Proceso completado exitosamente")},50)},50)},50)},[V,L,r,d,Qe,Mt]),Ot=c.useCallback(async(t,s)=>{var i,u;const a=[],o=[];for(const h of t){const g={...h};if(h.cells){g.cells=[];for(const p of h.cells){const b={...p};if(p.elements){b.elements=[];for(const w of p.elements)if(w.type==="image"&&((i=w.content)!=null&&i.startsWith("data:image/"))){const N=`${w.id}_${Date.now()}`,T=w.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(T){const v=T[1],C=T[2],B=`${N}.${v==="jpeg"?"jpg":v}`;o.push({filename:B,data:C,type:v,elementId:w.id}),b.elements.push({...w,content:w.content,_wasBase64:!0,_originalSize:w.content.length,_elementId:w.id})}else b.elements.push(w)}else b.elements.push(w)}g.cells.push(b)}}a.push(g)}if(o.length>0)try{const h=await fetch(`/api/canvas/projects/${s}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((u=document.querySelector('meta[name="csrf-token"]'))==null?void 0:u.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:o})});if(h.ok){const g=await h.json();if(g.uploadedImages){const p=new Map;g.uploadedImages.forEach(b=>{p.set(b.elementId,b.url)});for(const b of a)if(b.cells){for(const w of b.cells)if(w.elements)for(const N of w.elements)N._wasBase64&&N._elementId&&p.has(N._elementId)&&(N.content=p.get(N._elementId),delete N._elementId)}}}else{const g=await h.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("‚ùå [IMAGE-UPLOAD] Error subiendo im√°genes:",g),t}}catch(h){return console.error("‚ùå [IMAGE-UPLOAD] Error de red subiendo im√°genes:",h),t}return a},[]),Fe=c.useCallback(async(t=r,s=!1)=>{var a;if(!(!(n!=null&&n.id)||!s&&t.length===0))try{const u={design_data:{pages:await Ot(t,n.id),currentPage:d,workspaceDimensions:$,workspaceSize:ue,selectedElement:I,selectedCell:L,history:xe.slice(-5),historyIndex:Math.min(he,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:n.id,name:(m==null?void 0:m.name)||"√Ålbum Personalizado",item_id:m==null?void 0:m.id,preset_id:l==null?void 0:l.id}},thumbnails:D},g=JSON.stringify(u).length/(1024*1024),p=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(u)});if(p.ok){const b=await p.json(),w=`editor_progress_project_${n.id}`;return localStorage.removeItem(w),R(N=>{const T=new Map(N);return s?T.clear():T.delete(d),T}),r&&r.length>0&&setTimeout(()=>{fe().catch(N=>{console.warn("‚ö†Ô∏è Error regenerando thumbnail de p√°gina actual:",N)})},300),!0}else{const b=await p.json().catch(()=>({message:"Error desconocido"}));return console.error("‚ùå [AUTO-SAVE] Error guardando en BD:",b),!1}}catch(o){return console.error("‚ùå [AUTO-SAVE] Error en auto-save con procesamiento de im√°genes:",o),!1}},[r,d,$,ue,I,L,xe,he,n==null?void 0:n.id,m==null?void 0:m.name,m==null?void 0:m.id,l==null?void 0:l.id,D,Ot,rt]);c.useEffect(()=>{if(!(n!=null&&n.id))return;const t=setInterval(()=>{r.length>0&&Fe(r,!1)},5*60*1e3);return()=>clearInterval(t)},[Fe,r,n==null?void 0:n.id]),c.useCallback(async()=>{if(!r.length)return{};console.log("üì∏ [THUMBNAILS] Capturando thumbnails de todas las p√°ginas...");const t={},s=d;try{for(let a=0;a<r.length;a++){const o=r[a];if(o!=null&&o.id)try{a!==d&&(le(a),await new Promise(u=>setTimeout(u,300)));const i=await je({type:"thumbnail"});i&&(t[o.id]=i,console.log(`‚úÖ [THUMBNAILS] Thumbnail capturado para p√°gina ${a+1}: ${o.id}`))}catch(i){console.warn(`‚ö†Ô∏è [THUMBNAILS] Error capturando thumbnail para p√°gina ${o.id}:`,i),D[o.id]&&(t[o.id]=D[o.id])}}return s!==d&&le(s),console.log(`‚úÖ [THUMBNAILS] Capturados ${Object.keys(t).length} thumbnails de ${r.length} p√°ginas`),t}catch(a){return console.error("‚ùå [THUMBNAILS] Error capturando thumbnails:",a),s!==d&&le(s),D}},[r,d,le,je,D]);const aa=c.useCallback(async()=>{if(!(n!=null&&n.id)||r.length===0)return Y.error("No hay datos para guardar"),!1;try{return console.log("üì∏ [SAVE] Generando thumbnail de p√°gina actual..."),await fe(),await At(),await Fe(r,!0)?(Y.success("Progreso guardado exitosamente"),!0):(Y.error("Error al guardar el progreso"),!1)}catch(t){return console.error("‚ùå [SAVE] Error al guardar el progreso:",t),Y.error("Error al guardar el progreso"),!1}},[Fe,r,n==null?void 0:n.id,$,l,rt]),$t=c.useCallback(async t=>{var s;if(console.log("üíæ [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("üîç [QUEUE-SAVE] Datos disponibles:",{projectId:n==null?void 0:n.id,pagesCount:t==null?void 0:t.length,currentPage:d,hasDimensions:!!$,hasThumbnails:!!D}),!(n!=null&&n.id))return console.error("‚ùå [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return console.error("‚ùå [QUEUE-SAVE] No hay p√°ginas para guardar"),!1;try{const o={design_data:{pages:t,currentPage:d,workspaceDimensions:$,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:D};console.log("üì§ [QUEUE-SAVE] Enviando petici√≥n al servidor...");const i=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(o)});if(console.log("üì• [QUEUE-SAVE] Respuesta del servidor:",i.status,i.statusText),i.ok){const u=await i.json();return console.log("‚úÖ [QUEUE-SAVE] Guardado exitoso desde cola:",u),!0}else{const u=await i.text();return console.error("‚ùå [QUEUE-SAVE] Error en respuesta del servidor:",i.status,u),!1}}catch(a){return console.error("‚ùå [QUEUE-SAVE] Error guardando desde cola:",a),!1}},[n==null?void 0:n.id,d,$,D]),dt=c.useCallback(async()=>{if(console.log("üîç [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:G,saveQueueLength:F.length}),G){console.log("‚ö†Ô∏è [SAVE-QUEUE] Ya se est√° procesando, saltando...");return}if(F.length===0){console.log("‚ö†Ô∏è [SAVE-QUEUE] Cola vac√≠a, no hay nada que procesar");return}console.log("üöÄ [SAVE-QUEUE] Iniciando procesamiento de cola..."),A(!0);try{const t=F.slice();console.log("ÔøΩ [SAVE-QUEUE] Cola capturada para procesamiento:",t.length,"elementos"),Q([]),console.log("üßπ [SAVE-QUEUE] Cola limpiada");for(const s of t)console.log("üíæ [SAVE-QUEUE] Guardando p√°gina:",s.pageIndex),await $t(s.pages)?(R(o=>{const i=new Map(o);return i.delete(s.pageIndex),i}),console.log("‚úÖ [SAVE-QUEUE] P√°gina guardada exitosamente:",s.pageIndex)):(console.error("‚ùå [SAVE-QUEUE] Error guardando p√°gina:",s.pageIndex),Q(o=>[...o,s]));console.log("‚úÖ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(t){console.error("‚ùå [SAVE-QUEUE] Error procesando cola:",t)}finally{A(!1),console.log("üîì [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[G,F,$t]);c.useEffect(()=>{console.log("üîÑ [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:F.length,isProcessingQueue:G,shouldProcess:F.length>0&&!G}),F.length>0&&!G&&(console.log("‚è∞ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{dt()},100))},[F.length,G,dt]),c.useEffect(()=>{console.log("üìä [SAVE-QUEUE] Estado de cola actualizado:",{longitud:F.length,elementos:F.map(t=>`p√°gina ${t.pageIndex}`),procesando:G})},[F,G]);const Ut=c.useCallback((t,s)=>{console.log("üîç [SAVE-QUEUE] Intentando agregar p√°gina a cola:",t),R(a=>{const o=Array.from(a.keys());return console.log("üîç [SAVE-QUEUE] Cambios actuales:",o.join(", ")||"ninguno"),a.has(t)?(console.log("‚úÖ [SAVE-QUEUE] P√°gina tiene cambios, agregando a cola:",t),Q(i=>{console.log("üîç [SAVE-QUEUE] Cola actual antes de agregar:",i.length,"elementos");const u=i.findIndex(h=>h.pageIndex===t);if(u!==-1){const h=[...i];return h[u]={pageIndex:t,pages:s,timestamp:Date.now()},console.log("üîÑ [SAVE-QUEUE] Actualizando elemento existente en cola"),h}else{const h=[...i,{pageIndex:t,pages:s,timestamp:Date.now()}];return console.log("‚ûï [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",h.length),h}}),console.log("üì§ [SAVE-QUEUE] P√°gina agregada a cola:",t),a):(console.log("‚ö†Ô∏è [SAVE-QUEUE] No hay cambios para la p√°gina:",t,"- No se agregar√° a cola"),a)})},[]),ut=c.useCallback(async t=>{if(console.log("üîÑ [PAGE-CHANGE] Iniciando cambio de p√°gina de",d,"a",t),t===d){console.log("‚ö†Ô∏è [PAGE-CHANGE] Misma p√°gina, no se hace nada");return}R(s=>{console.log("üîç [PAGE-CHANGE] Verificando cambios en p√°gina actual:",d);const a=Array.from(s.keys());return console.log("üîç [PAGE-CHANGE] P√°ginas con cambios:",a.join(", ")||"ninguna"),s.has(d)?(console.log("üíæ [PAGE-CHANGE] ‚úÖ P√°gina actual tiene cambios, guardando antes del cambio:",d),Ut(d,r)):console.log("‚ÑπÔ∏è [PAGE-CHANGE] No hay cambios en la p√°gina actual:",d),s}),le(t),console.log("üìÑ [PAGE-CHANGE] ‚úÖ P√°gina cambiada a:",t)},[d,r,Ut]),Ue=()=>`editor_progress_project_${n==null?void 0:n.id}`,Lt=c.useCallback(async()=>{var s,a,o,i;if(!(n!=null&&n.id))return;if(r.some(u=>{var h;return(h=u.cells)==null?void 0:h.some(g=>{var p;return((p=g.elements)==null?void 0:p.length)>0})})){console.log("‚ö†Ô∏è [RECOVERY] Ya hay contenido en el workspace, saltando recuperaci√≥n autom√°tica");return}try{const u=Ee.loadFromLocalStorage(),h=await fetch(`/api/canvas/projects/${n.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let g=null;if(h.ok){const b=await h.json();b.success&&((s=b.data)!=null&&s.design_data)&&(g=b.data)}let p=null;if(u&&g){const b=new Date(u.savedAt).getTime(),w=new Date(g.saved_at).getTime();p=b>w?u:g}else u?p=u:g&&(p=g);if(p&&(((a=p.pages)==null?void 0:a.length)>0||((i=(o=p.design_data)==null?void 0:o.pages)==null?void 0:i.length)>0)){const b=new Date(p.savedAt||p.saved_at).getTime();Date.now()-b<30*60*1e3?(console.log("üîÑ [AUTO-RECOVERY] Cargando autom√°ticamente el progreso m√°s reciente"),Y.info("üîÑ Cargando progreso guardado autom√°ticamente..."),na(p)):console.log("üìÖ [RECOVERY] Progreso muy antiguo, ignorando autom√°ticamente")}}catch(u){console.error("‚ùå [RECOVERY] Error verificando progreso guardado:",u)}},[n==null?void 0:n.id,Ee,r]),na=c.useCallback(async t=>{var s;try{let a=[];if(t.pages?a=t.pages:(s=t.design_data)!=null&&s.pages&&(a=t.design_data.pages),a.length>0){te(a);const o=[JSON.stringify(a)];Le(o),Te(0),setTimeout(()=>{ae({})},100),Y.success("‚úÖ Progreso cargado exitosamente"),Zs(!1)}}catch(a){console.error("‚ùå [RECOVERY] Error cargando progreso:",a),Y.error("Error al cargar el progreso guardado")}},[te,Le,Te,ae]);c.useCallback(async()=>{try{const t=Ee.getStorageKey();localStorage.removeItem(t),Y.success("Progreso anterior eliminado")}catch(t){console.error("‚ùå [RECOVERY] Error descartando progreso:",t)}},[Ee]),c.useEffect(()=>{n&&m&&l&&(!(E!=null&&E.pages)||E.pages.length===0)&&_t(l,m)},[n,m,l,E]),c.useEffect(()=>{n!=null&&n.id&&!U&&r.length===0&&!Qe&&(ze(!0),setTimeout(()=>{Lt()},500))},[n==null?void 0:n.id,U,r.length,Lt,Qe]),c.useEffect(()=>(de.current&&clearTimeout(de.current),n!=null&&n.id&&r.length>0&&(de.current=setTimeout(()=>{At()},500)),()=>{de.current&&clearTimeout(de.current)}),[n==null?void 0:n.id,r.length]);const _t=(t,s)=>{try{const a=[],o=s.pages||t.pages||20,i=s.cover_image?`/storage/images/item/${s.cover_image}`:null,u=s.cover_image?null:t.background_color||"#ffffff",h={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:i,backgroundColor:u,cells:[{id:"cell-cover-1",elements:[]}]};a.push(h);const g=s.content_image?`/storage/images/item/${s.content_image}`:null,p=s.content_image?null:t.background_color||"#ffffff";for(let T=1;T<=o;T++){const v={id:`page-content-${T}`,type:"content",pageNumber:T,layout:"layout-1",backgroundImage:g,backgroundColor:p,cells:[{id:`cell-content-${T}-1`,elements:[]}]};a.push(v)}const b=s.back_cover_image?`/storage/images/item/${s.back_cover_image}`:null,w=s.back_cover_image?null:t.background_color||"#ffffff",N={id:"page-final",type:"final",layout:"layout-1",backgroundImage:b,backgroundColor:w,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};a.push(N),te(a),le(0),t.width&&t.height&&He("preset")}catch(a){console.error("‚ùå Error creating pages:",a),z(a.message)}},gt=c.useMemo(()=>({cover:r.filter(t=>t.type==="cover"),content:r.filter(t=>t.type==="content"),final:r.filter(t=>t.type==="final")}),[r]),J=c.useCallback(()=>{if(!I||!L||r.length===0)return null;const t=r[d];if(!t)return null;const s=t.cells.find(a=>a.id===L);return s?s.elements.find(a=>a.id===I):null},[I,L,r,d]),Rt=(t,s)=>{if(s){const a=r[d].cells.find(i=>i.id===s),o=a==null?void 0:a.elements.find(i=>i.id===t);if(o!=null&&o.locked){const i=document.createElement("div");i.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",i.textContent="Este elemento es parte del dise√±o base y no se puede editar",document.body.appendChild(i),setTimeout(()=>{document.body.contains(i)&&document.body.removeChild(i)},3e3);return}}if(s&&ne(s),K(t),t){const a=r[d].cells.find(i=>i.id===(s||L)),o=a==null?void 0:a.elements.find(i=>i.id===t);(o==null?void 0:o.type)==="image"?(wt(o),console.log("üñºÔ∏è Imagen seleccionada:",o.id,"- Tab actual mantenido:",V),V==="filters"?console.log("‚úÖ Usuario ya est√° en filtros, manteniendo"):console.log("‚úÖ Imagen seleccionada, pero manteniendo tab actual:",V)):(o==null?void 0:o.type)==="text"?(it(!0),Xs({elementId:t,cellId:s||L}),V!=="filters"&&V!=="images"&&ge("text")):it(!1)}else it(!1),wt(null)},Ae=()=>{if(r.length===0)return re[0];const t=r[d];return t?re.find(s=>s.id===t.layout)||re[0]:re[0]},zt=c.useCallback(De(t=>{try{const s=Ue(),a={pages:t,currentPage:d,savedAt:Date.now()},o=JSON.stringify(a),i=Math.round(o.length/1024);i<2048?localStorage.setItem(s,o):(console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${i} KB)`),localStorage.removeItem(s))}catch(s){if(console.error("‚ùå Error guardando en localStorage:",s),s.name==="QuotaExceededError")try{localStorage.removeItem(Ue())}catch(a){console.error("Error limpiando localStorage:",a)}}},300),[d,Ue]),Ve=c.useCallback(t=>{te(s=>{if(s===t)return s;const a=JSON.stringify(s),o=JSON.stringify(t);return a===o?(console.log("üîÑ [UPDATE-PAGES] Sin cambios, evitando actualizaci√≥n"),s):(console.log("üìù [UPDATE-PAGES] Aplicando cambios..."),requestAnimationFrame(()=>{if(R(i=>{const u=new Map(i);return u.set(d,Date.now()),u}),t[d]){const i=t[d].id;ae(u=>{if(u[i]){const h={...u};return delete h[i],h}return u})}}),setTimeout(()=>{Le(i=>{const u=[...i.slice(0,he+1),o];return u.length>50?u.slice(-50):u}),Te(i=>{const u=i+1;return u>50?49:u})},0),t)}),zt(t)},[d,he,zt]);c.useEffect(()=>{try{const t=Ue(),s={pages:r,currentPage:d,savedAt:Date.now()},a=JSON.stringify(s),o=Math.round(a.length/1024);o<2048?localStorage.setItem(t,a):console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${o} KB), saltando guardado`)}catch(t){if(console.error("‚ùå Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const s=Ue();localStorage.removeItem(s)}catch(s){console.error("Error limpiando localStorage:",s)}}},[d,r,Ue]);const oa=t=>{const s=re.find(u=>u.id===t);if(!s)return;const a=[...r],o=a[d],i=Array.from({length:s.cells}).map((u,h)=>o.cells[h]||{id:`cell-${o.id}-${h+1}`,elements:[]});a[d]={...o,layout:t,cells:i},Ve(a),K(null),ne(null)},Be=(t,s)=>{const a=[...r];for(let o=0;o<a[d].cells.length;o++)a[d].cells[o].id===t&&a[d].cells[o].elements.push(s);Ve(a),K(s.id),ne(t)},Ft=c.useCallback(De(()=>{R(t=>{const s=new Map(t);return s.set(d,Date.now()),s})},100),[d]),se=c.useCallback((t,s,a,o=!1)=>{te(i=>{const u=[...i],h=u[d].cells.findIndex(g=>g.id===t);if(h===-1)return i;if(o){const g=u[d].cells[h].elements.find(p=>p.id===s);if(!g)return i;u[d].cells[h].elements.push({...g,...a})}else{const g=u[d].cells[h].elements.findIndex(w=>w.id===s);if(g===-1)return i;const p=u[d].cells[h].elements[g];if(!Object.keys(a).some(w=>{const N=p[w],T=a[w];return typeof T=="object"&&typeof N=="object"?JSON.stringify(N)!==JSON.stringify(T):N!==T}))return i;u[d].cells[h].elements[g]={...p,...a}}return u}),a.position||a.size?requestAnimationFrame(()=>{R(i=>{if(i.has(d))return i;const u=new Map(i);return u.set(d,Date.now()),u})}):Ft()},[d,Ft]),Je=(t,s)=>{const a=[...r],o=a[d].cells.findIndex(i=>i.id===t);o!==-1&&(a[d].cells[o].elements=a[d].cells[o].elements.filter(i=>i.id!==s),Ve(a),I===s&&K(null))},ra=(t,s,a)=>{const o=[...r],i=o[d].cells.findIndex(u=>u.id===t);if(i!==-1){const u=o[d].cells[i].elements,h=u.findIndex(g=>g.id===s);if(h!==-1){const g=a==="up"?h+1:h-1;if(g>=0&&g<u.length){const p=u[h];u[h]=u[g],u[g]=p,Ve(o)}}}},ia=()=>{he>0&&(Te(he-1),te(JSON.parse(xe[he-1])),K(null),ne(null))},la=()=>{he<xe.length-1&&(Te(he+1),te(JSON.parse(xe[he+1])),K(null),ne(null))},mt=(t="body")=>{const s=`text-${Date.now()}`,a={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},o={heading:"T√≠tulo Principal",subheading:"Subt√≠tulo",body:"Haz clic para editar"},i={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},u={id:s,type:"text",content:o[t],position:{x:.05,y:.05},size:i[t],style:a[t]};L?Be(L,u):console.log("Selecciona una celda primero")},Vt=c.useMemo(()=>{var i;const t=r[d];if(!t)return null;const s=((i=t.cells)==null?void 0:i.flatMap(u=>u.elements||[]))||[],a=s.map(u=>({id:u.id,type:u.type,position:u.position,size:u.size}));return{pageId:t.id,elementsCount:s.length,contentHash:JSON.stringify(a).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[r,d]);c.useEffect(()=>{if(r.length===0||U||!Vt)return;let t=!1;const s=async()=>{try{const o=r[d];if(!o||!o.id)return;const i=o.id;if(ae(h=>{const g={...h};return delete g[i],g}),await new Promise(h=>setTimeout(h,100)),t)return;const u=await je();u&&!t?ae(h=>({...h,[i]:u})):console.warn("‚ö†Ô∏è [DEBUG] No se pudo generar miniatura para:",i)}catch(o){t||console.error("‚ùå [DEBUG] Error regenerando miniatura:",o)}},a=setTimeout(()=>{s()},500);return()=>{t=!0,clearTimeout(a)}},[d,Vt,U,je]),c.useEffect(()=>{if(r.length===0||U)return;const t=async()=>{const a=r.filter(o=>!D[o.id]);if(a.length!==0)for(const o of a)try{const i=document.createElement("canvas");i.width=200,i.height=150;const u=i.getContext("2d");if(u.fillStyle=o.backgroundColor||"#ffffff",u.fillRect(0,0,200,150),o.backgroundImage)try{const g=new Image;g.crossOrigin="anonymous",await new Promise((p,b)=>{g.onload=p,g.onerror=b,g.src=o.backgroundImage}),u.drawImage(g,0,0,200,150)}catch(g){console.warn("No se pudo cargar imagen de fondo para miniatura:",g)}o.cells&&o.cells.forEach(g=>{g.elements&&g.elements.forEach(p=>{var b;p.type==="text"&&p.content&&(u.fillStyle=((b=p.style)==null?void 0:b.color)||"#000000",u.font="12px Arial",u.fillText(p.content.substring(0,20)+(p.content.length>20?"...":""),10,30))})});const h=i.toDataURL("image/jpeg",.7);ae(g=>({...g,[o.id]:h})),await new Promise(g=>setTimeout(g,300))}catch(i){console.error("‚ùå Error generando miniatura de fondo para:",o.id,i)}},s=setTimeout(()=>{t()},2e3);return()=>clearTimeout(s)},[r,D,U]),c.useEffect(()=>{const t=s=>{const a=_.current,o=ee.current;if(a.length>0||o.size>0)return s.preventDefault(),s.returnValue="Hay cambios sin guardar. ¬øEst√°s seguro de que quieres salir?",s.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),c.useEffect(()=>()=>{console.log("üßπ [CLEANUP] Componente desmontado")},[]);const ca=async()=>{var t;try{if(!m||!l||!(n!=null&&n.id))return!1;await Fe(r,!0)||console.warn("‚ö†Ô∏è No se pudo guardar el progreso, pero continuando...");const a={design_data:{id:n.id,title:(m==null?void 0:m.name)||"√Ålbum Personalizado",pages:r,workspace_dimensions:$,created_at:new Date().toISOString()},item_data:{id:m==null?void 0:m.id,name:(m==null?void 0:m.name)||(m==null?void 0:m.title),price:m==null?void 0:m.price,user_id:m==null?void 0:m.user_id,width:m==null?void 0:m.width,height:m==null?void 0:m.height},preset_data:{id:l==null?void 0:l.id,width:l==null?void 0:l.width,height:l==null?void 0:l.height,cover_image:l==null?void 0:l.cover_image,content_layer_image:l==null?void 0:l.content_layer_image,final_layer_image:l==null?void 0:l.final_layer_image},dimensions:{width_mm:(l==null?void 0:l.width)||(m==null?void 0:m.width)||210,height_mm:(l==null?void 0:l.height)||(m==null?void 0:m.height)||297,workspace_width:($==null?void 0:$.width)||800,workspace_height:($==null?void 0:$.height)||600}};try{const w=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:n.id,status:"ready_for_pdf",pdf_data:a,completed_at:new Date().toISOString()})});if(w.ok){const N=await w.json()}else console.warn("‚ö†Ô∏è Error marcando proyecto como completado")}catch(w){console.warn("‚ö†Ô∏è Error en marcado de completado:",w)}const o=Date.now(),i=n.id;window.currentProjectId=i,window.albumProjectId=i;let u=l.cover_image;D&&D["page-cover"]&&(u=D["page-cover"]);let h=u;u&&u.startsWith("data:image/")&&u.length>1e5&&(h=l.cover_image||"/assets/img/default-album.jpg");const g={...m,project_id:i,canvas_project_id:n.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:l.width,height_mm:l.height,pages_count:r.length,workspace_dimensions:$,requires_pdf_generation:!0}},p=structuredClone(ie),b=p.findIndex(w=>w.id==g.id);return b==-1?p.push({...g,quantity:1}):p[b].quantity++,Ce(p),Y.success("√Ålbum agregado al carrito",{description:`${g.name} se ha a√±adido al carrito. El PDF se generar√° en el backend.`,icon:e.jsx(Pa,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:p,action:"add",product:g}})),!0}catch(s){return console.error("‚ùå === ERROR EN addAlbumToCart ==="),console.error("Error completo:",s),console.error("Stack trace:",s.stack),console.error("Mensaje del error:",s.message),Y.error("Error al agregar al carrito",{description:`Error espec√≠fico: ${s.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!r||r.length===0)throw new Error("No hay p√°ginas para finalizar");const a={design_data:{pages:(N=>N.map(T=>({id:T.id,type:T.type,pageNumber:T.pageNumber,layout:T.layout,cells:T.cells.map(v=>({id:v.id,elements:v.elements.map(C=>{const P={id:C.id,type:C.type,position:C.position,zIndex:C.zIndex||1};if(C.type==="image"){if(C.content.startsWith("data:image/")){const B=btoa(C.content.substring(0,100)).substring(0,20);P.content=`[BASE64_IMAGE_${B}]`,P.contentType=C.content.split(";")[0].split(":")[1],P.originalSize=C.content.length}else P.content=C.content;if(C.filters){const B=Object.entries(C.filters).filter(([Z,H])=>H!==0&&H!==!1&&H!==null).reduce((Z,[H,q])=>(Z[H]=q,Z),{});Object.keys(B).length>0&&(P.filters=B)}C.mask&&C.mask!=="none"&&(P.mask=C.mask),C.size&&(P.size=C.size),C.locked&&(P.locked=C.locked)}else if(C.type==="text"&&(P.content=C.content,C.style)){const B=Object.entries(C.style).filter(([Z,H])=>!(Z==="fontSize"&&H==="16px"||Z==="color"&&H==="#000000"||Z==="fontFamily"&&H==="Arial")).reduce((Z,[H,q])=>(Z[H]=q,Z),{});Object.keys(B).length>0&&(P.style=B)}return P})}))})))(r),projectInfo:{id:n==null?void 0:n.id,item_id:m==null?void 0:m.id,title:m==null?void 0:m.title,preset_id:l==null?void 0:l.id},presetInfo:{id:l==null?void 0:l.id,name:l==null?void 0:l.name,cover_image:l==null?void 0:l.cover_image,content_image:l==null?void 0:l.content_image,back_cover_image:l==null?void 0:l.back_cover_image},workspace:{width:$.width,height:$.height,scale:$.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(D).map(([N,T])=>[N,T]))},o=JSON.stringify(a),i=Math.round(o.length/1024),u=Math.round(i/1024*100)/100;let h=0,g=0;r.forEach(N=>{var T;(T=N.cells)==null||T.forEach(v=>{var C;(C=v.elements)==null||C.forEach(P=>{P.type==="image"&&P.content&&P.content.startsWith("data:image/")&&(h++,g+=P.content.length)})})});const p=Math.round(g/(1024*1024)*100)/100;if(i>1024&&!confirm(`El dise√±o contiene ${h} im√°genes (${p} MB en im√°genes). Payload completo: ${u} MB. Esto podr√≠a causar problemas al guardarlo. ¬øDesea continuar de todos modos?`))return!1;const b=await fetch(`/api/canvas/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:o});if(!b.ok){let N="Error al finalizar el dise√±o";try{N=(await b.json()).message||N}catch{b.status===413?N="El dise√±o es demasiado grande para ser guardado. Intente simplificar las im√°genes.":b.status>=500&&(N="Error del servidor. Intente nuevamente m√°s tarde.")}throw new Error(N)}const w=await b.json();return!0}catch(t){console.error("Error al finalizar dise√±o:",t);let s=t.message;return t.message.includes("Failed to fetch")?s="Error de conexi√≥n. Verifique su conexi√≥n a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(s="Error de red. Intente nuevamente m√°s tarde."),alert("Error al finalizar el dise√±o: "+s),!1}};const da=c.useCallback(async()=>{try{const{jsPDF:t}=await ga(async()=>{const{jsPDF:B}=await import("./jspdf.es.min-D3plwuQr.js").then(Z=>Z.j);return{jsPDF:B}},__vite__mapDeps([0,1,2,3,4]));let s=(l==null?void 0:l.width)||21,a=(l==null?void 0:l.height)||29.7;const o=.3,i=s+o*2,u=a+o*2,h=i*28.35,g=u*28.35,p=new t({orientation:h>g?"landscape":"portrait",unit:"pt",format:[h,g],compress:!1}),b=r.length;let w=0;const N=document.createElement("div");N.id="pdf-progress",N.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",N.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${b} p√°ginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(N);const T=B=>{const Z=B/b*100;document.getElementById("pdf-progress-bar").style.width=`${Z}%`,document.getElementById("current-page").textContent=B},v=d;for(let B=0;B<r.length;B++){const Z=r[B];le(B),await new Promise(H=>setTimeout(H,500));try{const H=await je({type:"pdf"});if(H){const q=H.width/H.height,Ne=h/g;let oe,ce,be=0,Pe=0;q>Ne?(oe=h,ce=h/q,Pe=(g-ce)/2):(ce=g,oe=g*q,be=(h-oe)/2);const Me=H.toDataURL("image/png",1);B>0&&p.addPage([h,g]),p.addImage(Me,"PNG",be,Pe,oe,ce)}else console.warn(`‚ö†Ô∏è No se pudo capturar la p√°gina ${B+1}`),B>0&&p.addPage([h,g]),p.setFontSize(12),p.text(`Error al renderizar p√°gina ${B+1}`,h/2,g/2,{align:"center"})}catch(H){console.error(`‚ùå Error procesando p√°gina ${B+1}:`,H),B>0&&p.addPage([h,g]),p.setFontSize(12),p.text(`Error al procesar p√°gina ${B+1}`,h/2,g/2,{align:"center"})}w++,T(w),await new Promise(H=>setTimeout(H,200))}le(v);const C=`${(m==null?void 0:m.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;p.save(C),document.body.removeChild(N);const P=document.createElement("div");return P.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",P.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${C}</span>
                </div>
            `,document.body.appendChild(P),setTimeout(()=>{document.body.contains(P)&&document.body.removeChild(P)},5e3),C}catch(t){console.error("‚ùå Error generando PDF:",t);const s=document.getElementById("pdf-progress");s&&document.body.removeChild(s);const a=document.createElement("div");throw a.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",a.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(a),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},7e3),t}},[r,d,le,je,l,m]);return window.generateAlbumPDF=da,window.generateHighQualityThumbnail=Ks,window.captureCurrentWorkspace=je,e.jsxs(ma,{backend:ha,className:"!h-screen !w-screen overflow-hidden",children:[U?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu √°lbum personalizado..."})]})}):W?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:W}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):r.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando p√°ginas del √°lbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx(ja,{isOpen:Ys,onRequestClose:()=>{It(!1),ea({isLoading:!1,loadedImages:0,totalImages:0,message:""}),pe({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:r.map(t=>({...t,layout:re.find(s=>s.id===t.layout)||re[0]})),pageThumbnails:D,workspaceDimensions:$,getCurrentLayout:t=>t?re.find(s=>s.id===t.layout)||re[0]:re[0],presetData:l,addAlbumToCart:ca,projectData:n,itemData:m,albumLoadingState:Ds}),ke.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-ke.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:ke.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:ke.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${ke.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[ke.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(Aa,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:ia,disabled:he<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(fa,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:la,disabled:he>=xe.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(pa,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(n==null?void 0:n.name)||"√Ålbum Sin T√≠tulo",onChange:t=>f({...n,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del dise√±o"})}),e.jsxs("div",{className:"flex items-center gap-4",children:[(F.length>0||G)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:G?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",F.length]})]})}),e.jsx(Xa,{saveStatus:Ee.saveStatus,lastSaved:Ee.lastSaved,lastAutoSaved:Ee.lastAutoSaved,hasUnsavedChanges:M.hasUnsavedChanges||!!(j instanceof Map&&j.has(d)),isOnline:Ee.isOnline,saveError:Ee.saveError,onManualSave:aa,saveQueueSize:F.length,isProcessingQueue:G,pageChangesCount:j instanceof Map?j.size:0}),F.length>0&&e.jsxs("button",{onClick:()=>{console.log("üîß [DEBUG] Procesando cola manualmente"),dt()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(Vs,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsxs("div",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:["P",d,": ",j instanceof Map&&j.has(d)?"üî¥":"üü¢"]}),e.jsx("button",{onClick:()=>{console.log("üîß [DEBUG] Marcando p√°gina actual como modificada"),R(t=>{const s=new Map(t);return s.set(d,Date.now()),s})},className:"text-xs text-white bg-green-500 hover:bg-green-600 px-2 py-1 rounded",children:"Marcar Modificada"}),e.jsx(Ze,{variant:"secondary",size:"sm",onClick:async t=>{t.preventDefault(),t.stopPropagation();try{console.log("üé≠ [ALBUM-EXPERIENCE] Iniciando experiencia √∫nica de √°lbum..."),pe({isOpen:!0,phase:"preparing",progress:0,message:"‚ú® Creando tu experiencia",subMessage:"Preparando la magia de tu √°lbum personalizado..."});for(let a=0;a<=30;a+=5)await new Promise(o=>setTimeout(o,100)),pe(o=>({...o,progress:a,message:"üîß Construyendo previsualizaci√≥n",subMessage:"Optimizando cada detalle para ti..."}));pe(a=>({...a,phase:"processing",message:"Cargando el proyecto",subMessage:"Procesando cada p√°gina con calidad profesional..."}));const s=await Qs((a,o)=>{const i=30+a/o*50;pe(u=>({...u,progress:Math.round(i),subMessage:`Procesando imagen ${a} de ${o}...`}))});pe(a=>({...a,phase:"finalizing",message:"üé® Aplicando toques finales",subMessage:"Perfeccionando tu vista previa..."}));for(let a=80;a<=100;a+=4)await new Promise(o=>setTimeout(o,80)),pe(o=>({...o,progress:a}));pe(a=>({...a,phase:"ready",progress:100,message:"üéâ ¬°Tu √°lbum est√° listo!",subMessage:"Experiencia premium creada especialmente para ti"})),await new Promise(a=>setTimeout(a,1e3)),pe(a=>({...a,isOpen:!1})),ae(a=>({...a,...s})),setTimeout(()=>{It(!0),console.log("‚úÖ [ALBUM-EXPERIENCE] Experiencia √∫nica completada")},300)}catch(s){console.error("‚ùå [ALBUM-EXPERIENCE] Error en experiencia:",s),pe(a=>({...a,message:"‚ö†Ô∏è Ups, algo sali√≥ mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{pe(a=>({...a,isOpen:!1}))},2e3)}},disabled:ke.isOpen,icon:e.jsx(et,{className:"h-4 w-4"}),children:ke.isOpen?"Creando experiencia...":"Vista de √Ålbum"}),e.jsx("div",{className:"relative",children:e.jsx("button",{className:"h-8 w-8 rounded-full bg-[#af5cb8] flex items-center justify-center text-white font-medium",children:e.jsx(Ta,{className:"h-4 w-4"})})})]})]})}),e.jsxs("div",{className:`flex h-full ${I?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{onClick:()=>ge("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${V==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(et,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"P√°ginas"})]}),e.jsxs("button",{onClick:()=>ge("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${V==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(bt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Dise√±os"})]}),e.jsxs("button",{onClick:()=>ge("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${V==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(st,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{onClick:()=>ge("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${V==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Rs,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]}),e.jsxs("button",{onClick:()=>ge("filters"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${V==="filters"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx($s,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Filtros"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[V==="templates"&&"Templates",V==="images"&&"Images",V==="text"&&"Text",V==="shapes"&&"Shapes",V==="stickers"&&"Stickers",V==="pages"&&"Pages",V==="panel"&&"Layers Panel",V==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[V==="templates"&&"Choose a template to get started",V==="images"&&"Search for images",V==="text"&&"Add and edit text",V==="shapes"&&"Add shapes and graphics",V==="stickers"&&"Add fun stickers",V==="pages"&&"Manage your pages",V==="panel"&&"Organize layers and z-index",V==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(La,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[V==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(bt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Ba,{currentLayoutId:(Ht=r[d])==null?void 0:Ht.layout,onLayoutChange:oa})]}),V==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Oe,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Im√°genes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[ve.length," imagen",ve.length!==1?"s":""]})]}),e.jsx(Ya,{images:ve,onImageSelect:sa,isLoading:nt})]}),V==="text"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>mt("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"T√≠tulo Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(tt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>mt("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subt√≠tulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(tt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>mt("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(tt,{className:"h-4 w-4"})})]})})]}),V==="text"&&I&&((Wt=J())==null?void 0:Wt.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(Ra,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=J();se(L,I,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((Qt=(qt=J())==null?void 0:qt.style)==null?void 0:Qt.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=J();se(L,I,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((Kt=(Jt=J())==null?void 0:Jt.style)==null?void 0:Kt.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=J();se(L,I,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((Yt=(Xt=J())==null?void 0:Xt.style)==null?void 0:Yt.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipograf√≠a:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Dt=(Zt=J())==null?void 0:Zt.style)==null?void 0:Dt.fontFamily)||"Arial",onChange:t=>{const s=J();se(L,I,{style:{...s.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tama√±o:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((ts=(es=J())==null?void 0:es.style)==null?void 0:ts.fontSize)||"16px",onChange:t=>{const s=J();se(L,I,{style:{...s.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((as=(ss=J())==null?void 0:ss.style)==null?void 0:as.color)||"#000000",onChange:t=>{const s=J();se(L,I,{style:{...s.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((os=(ns=J())==null?void 0:ns.style)==null?void 0:os.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((is=(rs=J())==null?void 0:rs.style)==null?void 0:is.backgroundColor)||"#ffffff",onChange:t=>{const s=J();se(L,I,{style:{...s.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=J();se(L,I,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"üö´"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var s,a;return e.jsxs("button",{onClick:()=>{const o=J();se(L,I,{style:{...o.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((a=(s=J())==null?void 0:s.style)==null?void 0:a.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"‚¨Ö",t==="center"&&"‚¨å",t==="right"&&"‚û°",t==="justify"&&"‚¨ç"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((cs=(ls=J())==null?void 0:ls.style)==null?void 0:cs.lineHeight)||"1.5",onChange:t=>{const s=J();se(L,I,{style:{...s.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((us=(ds=J())==null?void 0:ds.style)==null?void 0:us.letterSpacing)||"normal",onChange:t=>{const s=J();se(L,I,{style:{...s.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=J();se(L,I,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((ms=(gs=J())==null?void 0:gs.style)==null?void 0:ms.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAY√öS"]}),e.jsxs("button",{onClick:()=>{const t=J();se(L,I,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((fs=(hs=J())==null?void 0:hs.style)==null?void 0:fs.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"min√∫s"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((xs=(ps=J())==null?void 0:ps.style)==null?void 0:xs.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((ys=(bs=J())==null?void 0:bs.style)==null?void 0:ys.opacity)||"1",onChange:t=>{const s=J();se(L,I,{style:{...s.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((ws=(vs=J())==null?void 0:vs.style)==null?void 0:ws.opacity)||1)*100}%, #e5e7eb ${(((js=(Es=J())==null?void 0:Es.style)==null?void 0:js.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),V==="pages"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(et,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[r.length," total"]})]})}),Re&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Re.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Re.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Re.message||`P√°gina: ${Re.pageId||"actual"}`})]}),r.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando p√°ginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),gt.cover.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${d===r.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>ut(r.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(yt,{pageId:t.id,thumbnail:D[t.id],altText:"Cover",type:"cover"}),j instanceof Map&&j.has&&j.has(r.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:gt.content.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${d===r.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>ut(r.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(yt,{pageId:t.id,thumbnail:D[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),j instanceof Map&&j.has&&j.has(r.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),gt.final.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${d===r.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>ut(r.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(yt,{pageId:t.id,thumbnail:D[t.id],altText:"Back Cover",type:"final"}),j instanceof Map&&j.has&&j.has(r.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),V==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Va,{pages:r,currentPage:d,selectedCell:L,selectedElement:I,onSelectCell:ne,onSelectElement:K,onUpdateElement:(t,s,a)=>{se(t,s,a)},onDeleteElement:(t,s)=>{Je(t,s)},onMoveElement:(t,s,a)=>{ra(t,s,a)}})}),V==="filters"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx($s,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=J();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Oe,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Ga,{selectedMask:t.mask||"none",onSelect:s=>{se(L,I,{mask:s})},availableMasks:zs.map(s=>s.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(xa,{filters:t.filters||{},onFilterChange:s=>{se(L,I,{filters:s})},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(Oe,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:J()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>ge("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(bt,{className:"h-4 w-4"}),"Dise√±o de p√°gina"]}),e.jsxs("button",{onClick:()=>ge("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(st,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(Ze,{variant:"ghost",tooltip:"A√±adir Imagen",onClick:()=>lt.current&&lt.current.click(),children:e.jsx(Oe,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:lt,onChange:ta,className:"hidden",accept:"image/*"})]}),I&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(Ze,{variant:"ghost",size:"sm",onClick:()=>{if(I&&L){const t=J();if(t){const s={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};Be(L,s)}}},className:"h-8 px-2",icon:e.jsx(Ia,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(Ze,{variant:"ghost",size:"sm",onClick:()=>{I&&L&&Je(L,I)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(Fs,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{className:"flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100",children:Hs?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:$.width,height:$.height},children:e.jsx("div",{id:`page-${r[d].id}`,className:`grid ${Ae().template} gap-6`,style:{width:"100%",height:"100%"},children:r[d].cells.map((t,s)=>{var a;return e.jsx(Is,{id:t.id,elements:t.elements.filter(o=>!o.locked),workspaceSize:$,cellStyle:(a=Ae().cellStyles)==null?void 0:a[r[d].cells.indexOf(t)],selectedElement:L===t.id?I:null,onSelectElement:Rt,onAddElement:(o,i)=>Be(i,o),onUpdateElement:(o,i,u)=>se(t.id,o,i,u),onDeleteElement:o=>Je(t.id,o),availableMasks:Ae().maskCategories.flatMap(o=>o.masks),projectData:n},t.id)})})})}):e.jsxs("div",{id:`page-${r[d].id}`,className:" shadow-xl overflow-hidden",style:{width:$.width,height:$.height,position:"relative",backgroundColor:((Ns=r[d])==null?void 0:Ns.backgroundColor)||"#ffffff",backgroundImage:(Ss=r[d])!=null&&Ss.backgroundImage?`url(${r[d].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=r[d];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${Ae().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((Cs=Ae().style)==null?void 0:Cs.gap)||"16px",padding:((ks=Ae().style)==null?void 0:ks.padding)||"16px"},children:r[d].cells.map(t=>{var s;return e.jsx(Is,{id:t.id,elements:t.elements.filter(a=>!a.locked),workspaceSize:$,cellStyle:(s=Ae().cellStyles)==null?void 0:s[r[d].cells.indexOf(t)],selectedElement:L===t.id?I:null,onSelectElement:Rt,onAddElement:(a,o)=>Be(o,a),onUpdateElement:(a,o,i)=>se(t.id,a,o,i),onDeleteElement:a=>Je(t.id,a),availableMasks:Ae().maskCategories.flatMap(a=>a.masks),projectData:n},t.id)})})]})})]})]})]}),e.jsx(Ea,{})]})}export{so as default};
