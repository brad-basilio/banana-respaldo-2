import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as j}from"./index-BH53Isel.js";import"./EditorLayout-CkCvwqGw.js";import"./thumbnailGenerator-B4goYG9Y.js";import"./index-BZYhE2TF.js";import"./TextElement-_pvTHO57.js";import{R as V}from"./PaymentModal-BB1JXzaZ.js";import{H as ce}from"./jspdf.es.min-D3plwuQr.js";import{X as q}from"./x-DBMwyD6F.js";import{C as de}from"./chevron-left-B2s3ZsB7.js";import{C as ge}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./preload-helper-BfFHrpNk.js";import"./typeof-QjJsDpFa.js";import"./createLucideIcon-Cy5Ya80P.js";const Q={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},he=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;V.setAppElement("#app");const $e=({isOpen:b,onRequestClose:v,pages:c,pageThumbnails:y={},addAlbumToCart:K,workspaceDimensions:m={width:800,height:600},layouts:X=[],presetData:M=null,projectData:h=null,itemData:d=null,albumLoadingState:C={isLoading:!1,loadedImages:0,totalImages:0,message:""}})=>{const[G,D]=j.useState(0),[A,E]=j.useState(!1),[I,Z]=j.useState(!1),[ee,$]=j.useState({}),[te,J]=j.useState(!1),B=j.useRef();function re(t,o,a,r,g,l){const n=o.width,s=o.height,u=g/l,x=n/s;let f=0,w=0,p=n,i=s;u>x?(i=n/u,w=(s-i)/2):(p=s*u,f=(n-p)/2),t.drawImage(o,f,w,p,i,a,r,g,l)}function oe(t){const o=t.match(/grid-cols-(\d+)/),a=t.match(/grid-rows-(\d+)/),r=t.match(/gap-(\d+)/);return{cols:o?parseInt(o[1],10):1,rows:a?parseInt(a[1],10):1,gap:r?parseInt(r[1],10)*4:0}}function U(t,o,a=1){const r=t&&t.match(new RegExp(`${o}-span-(\\d+)`));return r?parseInt(r[1],10):a}function ne(t,o,a){const{cols:r,rows:g,gap:l}=oe(t.template),n=t.style&&t.style.padding?parseInt(t.style.padding):0,s=o.width-2*n,u=o.height-2*n,x=(s-l*(r-1))/r,f=(u-l*(g-1))/g,w=Array.from({length:g},()=>Array(r).fill(!1)),p={};for(let i=0;i<t.cells;i++){const F=t.cellStyles&&t.cellStyles[i]?t.cellStyles[i]:"",k=U(F,"col",1),R=U(F,"row",1);let H=!1;for(let P=0;P<=g-R&&!H;P++)for(let O=0;O<=r-k&&!H;O++){let z=!0;for(let N=P;N<P+R;N++){for(let _=O;_<O+k;_++)if(w[N][_]){z=!1;break}if(!z)break}if(z){for(let _=P;_<P+R;_++)for(let L=O;L<O+k;L++)w[_][L]=!0;const N=a&&a[i]?a[i].id:i;p[N]={x:n+O*(x+l),y:n+P*(f+l),width:x*k+l*(k-1),height:f*R+l*(R-1)},console.log(`[GRID-PLACEMENT] cellId:${N} col-span:${k} row-span:${R} => x:${p[N].x} y:${p[N].y} w:${p[N].width} h:${p[N].height}`),H=!0}}if(!H){const P=a&&a[i]?a[i].id:i;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${P}`),p[P]={x:0,y:0,width:x,height:f}}}return p}j.useCallback(async()=>{if(!c||c.length===0||!b)return;console.log("üöÄ Iniciando generaci√≥n de thumbnails para BookPreview..."),J(!0),$({});const t={},o=4,a=(n,s,u,x)=>{if(!s||!s.image)return;const f=new Image;f.src=s.image,f.onload=()=>{const w=u.x+s.x*x,p=u.y+s.y*x,i=s.width*x,F=s.height*x;re(n,f,w,p,i,F)}},r=async(n,s)=>{const u=document.createElement("canvas"),x=u.getContext("2d");if(u.width=m.width*o,u.height=m.height*o,M&&M.final_layer_image){const i=new Image;i.src=M.final_layer_image,i.onload=()=>{x.drawImage(i,0,0,u.width,u.height)}}const f=X.find(i=>i.id===n.layoutId);if(!f)return;const w=ne(f,m,n.cells);n.cells.forEach(i=>{const F=w[i.id];F&&i.elements.forEach(k=>{a(x,k,F,o)})});const p=u.toDataURL("image/jpeg",.9);return{[s]:p}},g=c.map((n,s)=>r(n,s));(await Promise.all(g)).forEach(n=>{Object.assign(t,n)}),$(t),J(!1)},[c,b,m,X,M]);const se=async()=>{var t,o,a;if(!(h!=null&&h.id)){alert("No se ha cargado ning√∫n proyecto.");return}Z(!0);try{const r=c.map((n,s)=>({id:n.id||`page-${s}`,index:s})),g={...m,originalWidth:m.originalWidth||((t=d==null?void 0:d.dimensions)!=null&&t.width?parseFloat(d.dimensions.width):297),originalHeight:m.originalHeight||((o=d==null?void 0:d.dimensions)!=null&&o.height?parseFloat(d.dimensions.height):210),width:parseInt(m.width||800),height:parseInt(m.height||600)};console.log("üìê Enviando dimensiones exactas para PDF:",g);const l=await fetch(`/api/customer/projects/${h.id}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content)||""},body:JSON.stringify({format:(h==null?void 0:h.format)||"album",quality:"high",pages:r,pages_count:c.length,workspace_dimensions:g,product_dimensions:(d==null?void 0:d.dimensions)||{},use_pdf_thumbnails:!0})});if(l.ok){const n=await l.blob();if(n.type==="application/pdf")saveAs(n,`proyecto-${h.id}.pdf`),alert("PDF generado y descargado exitosamente.");else{const s=await l.json();alert(s.message||"Error al generar el PDF.")}}else{const n=await l.json();alert(n.message||"No se pudo generar el PDF.")}}catch(r){console.error("Error al exportar el PDF:",r),alert("Ocurri√≥ un error de red al generar el PDF.")}finally{Z(!1)}};j.useEffect(()=>{b&&(console.log("üìñ [BOOK-MODAL] Modal abierto"),console.log("üìä [BOOK-MODAL] Thumbnails recibidos:",Object.keys(y).length,"de",c.length,"p√°ginas"),Object.keys(y).length>0?(console.log("‚úÖ [BOOK-MODAL] Usando thumbnails del Editor"),$(y)):(console.log("‚ÑπÔ∏è [BOOK-MODAL] No se recibieron thumbnails, usando placeholders"),$({})))},[b,y]),j.useEffect(()=>{b||$({})},[b]);const Y=Object.keys(y).length>0?y:ee;if(!c||!Array.isArray(c)||c.length===0)return e.jsx(V,{isOpen:b,onRequestClose:v,style:Q,contentLabel:"Vista previa del √°lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del √°lbum"}),e.jsx("button",{onClick:v,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:e.jsx(q,{size:24})})]}),e.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay p√°ginas disponibles para mostrar."})]})});const ae=()=>{B.current&&B.current.pageFlip().flipPrev()},ie=()=>{B.current&&B.current.pageFlip().flipNext()},le=m.width/m.height,S=600,T=Math.round(S*le),W=(()=>{const t=[],o=[...c.filter(r=>r.type==="cover"),...c.filter(r=>r.type==="content"),...c.filter(r=>r.type==="final")];o.length>0&&(t.push(o[0]),t.push({...o[0],isBack:!0}));for(let r=1;r<o.length-1;r++)t.push(o[r]),r+1<o.length-1?(t.push(o[r+1]),r++):t.push({...o[r],isBack:!0,isEmpty:!0});const a=o.find(r=>r.type==="final");return a&&(t.push({...a,isBack:!0,isEmpty:!0}),t.push(a)),t})();return e.jsxs(V,{isOpen:b,onRequestClose:v,style:Q,contentLabel:"Vista previa del √°lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[e.jsx("style",{dangerouslySetInnerHTML:{__html:he}}),(te||I||C.isLoading)&&e.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center max-w-md mx-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),C.isLoading?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700 text-center",children:C.message||"Cargando √°lbum..."}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mt-3",children:e.jsx("div",{className:"bg-purple-600 h-2 rounded-full transition-all duration-300",style:{width:`${C.totalImages>0?C.loadedImages/C.totalImages*100:0}%`}})}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:[C.loadedImages," de ",C.totalImages," im√°genes"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700",children:I?"Generando PDF de alta calidad...":"Generando vistas previas de alta calidad..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})]})}),e.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[e.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del √°lbum"}),e.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las p√°ginas de su √°lbum usando los controles de navegaci√≥n o teclado. Puede cerrar esta ventana presionando Escape o el bot√≥n de cerrar."}),e.jsx("button",{onClick:v,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del √°lbum",children:e.jsx(q,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[e.jsx("button",{onClick:ae,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"P√°gina anterior",children:e.jsx(de,{className:"h-6 w-6"})}),e.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const t=W[G];return t?t.isBack&&t.isEmpty?"Reverso":t.isBack?"Reverso de la p√°gina":t.type==="cover"?"Portada":t.type==="final"?"Contraportada":`P√°gina ${t.pageNumber||Math.ceil((G+1)/2)}`:"Cargando..."})(),e.jsx("span",{className:"mx-2 text-gray-400",children:"‚Ä¢"}),Math.ceil((G+1)/2)," / ",Math.ceil(W.length/2)," hojas"]}),e.jsx("button",{onClick:ie,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"P√°gina siguiente",children:e.jsx(ge,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ce,{ref:B,width:T,height:S,size:"stretch",minWidth:T*.7,maxWidth:T*1.3,minHeight:S*.7,maxHeight:S*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:t=>D(t.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:W.map((t,o)=>e.jsx("div",{id:`page-${t.id}`,className:"page-container",style:{width:T,height:S,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:e.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:t.isEmpty||t.isBack?e.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:t.isBack?"Reverso":""}):Y[t.id]?e.jsx("img",{src:Y[t.id],alt:`${t.type==="cover"?"Portada":t.type==="final"?"Contraportada":`P√°gina ${t.pageNumber||o+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):e.jsx(me,{page:t,pageIdx:o})})},`page-${o}`))})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-2xl mx-auto",children:[e.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center 
                        ${I?"bg-blue-400 text-white cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,onClick:se,disabled:I||A,children:I?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Generando PDF..."]}):"Descargar PDF"}),e.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${A?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var t,o,a,r;if(!A){E(!0),console.log("üöÄ === INICIO PROCESO COMPRA CON GENERACI√ìN PDF BACKEND ===");try{if(!(h!=null&&h.id)){console.error("‚ùå No hay datos del proyecto"),alert("Error: No se encontr√≥ informaci√≥n del proyecto."),E(!1);return}if(console.log("üìÑ Generando PDF en el backend usando thumbnails existentes..."),console.log("ÔøΩ Proyecto ID:",h.id),console.log("üõí Procesando √°lbum usando sistema de carrito..."),console.log("üÜî Proyecto ID:",h.id),console.log("üõí Agregando √°lbum al carrito..."),typeof K!="function"){console.error("‚ùå addAlbumToCart no es una funci√≥n"),alert("Error: Funci√≥n de carrito no disponible. Int√©ntelo nuevamente."),E(!1);return}console.log("üõí Agregando √°lbum al carrito...");const g=K({project_id:h.id,pages:c,workspace_dimensions:m,quality:"high",format:"album",generate_pdf:!0});let l;if(g&&typeof g.then=="function"?l=await g:l=g,console.log("‚úÖ √Ålbum agregado al carrito:",l),!l){console.error("‚ùå No se pudo agregar al carrito"),alert("Error al agregar el √°lbum al carrito. Revise la consola para m√°s detalles."),E(!1);return}console.log("‚úÖ √Ålbum agregado al carrito exitosamente"),console.log("üìÑ Iniciando generaci√≥n de PDF...");try{console.log("üìÑ Generando PDF directamente...");const n=c.map((f,w)=>({id:f.id||`page-${w}`,index:w})),s={...m,originalWidth:m.originalWidth||((t=d==null?void 0:d.dimensions)!=null&&t.width?parseFloat(d.dimensions.width):297),originalHeight:m.originalHeight||((o=d==null?void 0:d.dimensions)!=null&&o.height?parseFloat(d.dimensions.height):210),width:parseInt(m.width||800),height:parseInt(m.height||600)};console.log("üìê Enviando dimensiones exactas para PDF en compra:",s);const u={format:(h==null?void 0:h.format)||"album",quality:"high",pages:n,pages_count:c.length,workspace_dimensions:s,product_dimensions:(d==null?void 0:d.dimensions)||{},use_pdf_thumbnails:!0};(await fetch(`/api/customer/projects/${h.id}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content)||""},body:JSON.stringify(u)})).ok?console.log("‚úÖ PDF generado correctamente en el backend"):console.warn("‚ö†Ô∏è Error generando PDF, pero continuando con el proceso de compra...")}catch(n){console.warn("‚ö†Ô∏è Error al generar PDF (continuando):",n.message)}console.log("‚úÖ Proceso completo"),alert(`¬°√Ålbum agregado al carrito exitosamente!

El PDF se est√° generando en segundo plano.
Puedes continuar editando o ir al carrito cuando termines.`),setTimeout(()=>{v(),E(!1)},1e3)}catch(g){console.error("‚ùå === ERROR GENERAL EN PROCESO COMPRA ==="),console.error("Tipo:",g.name),console.error("Mensaje:",g.message),console.error("Stack:",g.stack);try{const l=`${((r=window.Global)==null?void 0:r.APP_CORRELATIVE)||"bananalab"}_cart`;if(JSON.parse(localStorage.getItem(l)||"[]").length>0){console.log("‚úÖ Hay items en carrito, mostrando √©xito..."),alert("¬°√Ålbum agregado al carrito! Puedes continuar editando o ir al carrito manualmente."),setTimeout(()=>{v(),E(!1)},1e3);return}}catch(l){console.error("‚ùå Error en recuperaci√≥n:",l)}alert(`Error: ${g.message}. Si el √°lbum se agreg√≥, puede ir manualmente al carrito.`)}finally{E(!1)}}},disabled:A||I,children:A?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Generando PDF..."]}):"Comprar ahora"}),e.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:v,disabled:A||I,children:"Continuar editando"})]}),"        "]})},me=({page:b,pageIdx:v})=>{let c="",y="";switch(b.type){case"cover":c="Portada",y="üìö";break;case"final":c="Contraportada",y="üìñ";break;case"content":c=`P√°gina ${b.pageNumber||v+1}`,y="üìÑ";break;default:c=`P√°gina ${v+1}`,y="üìÑ"}return e.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[e.jsx("div",{className:"text-6xl mb-4",children:y}),e.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:c}),e.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),b.layout&&e.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",b.layout.name||"Personalizado"]})]})};export{$e as B};
