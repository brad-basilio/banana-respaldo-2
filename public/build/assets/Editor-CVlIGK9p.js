const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as Ks}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as u,R as it}from"./index-BH53Isel.js";import{T as ys,l as re,i as vs,a as Qs,D as Xs,H as Js,U as Ys,R as Zs,B as us,F as Ds,E as hs}from"./EditableCell-Cu-5czkC.js";import{h as ms}from"./thumbnailGenerator-B4goYG9Y.js";import{L as Ve}from"./layers-6oegOx-p.js";import{C as ea}from"./chevron-down-DS-mdh9v.js";import{C as ta}from"./chevron-right-Ckt5D2ka.js";import{E as sa}from"./eye-CKCH9ORv.js";import{c as ge}from"./createLucideIcon-Cy5Ya80P.js";import{T as ws}from"./trash-2-DK1wnsDn.js";import{S as aa}from"./star-wPQTHY_n.js";import{I as je}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as ae,T as oa}from"./index-BZYhE2TF.js";import{m as ps}from"./main-6DCdASTx.js";import{B as ra}from"./V1Edit-CNtDxOEt.js";import{G as fs}from"./Global-ErywZRdd.js";import{S as js,F as na}from"./save-BfW-kI1U.js";import{C as ia}from"./clock-BTrEpQej.js";import{C as Es}from"./check-DQ7QoS0v.js";import{L as la}from"./loader-circle-CrvBvIt1.js";import"./dom-to-image-more.min-BAoslaO8.js";import{C as ca}from"./chevron-left-B2s3ZsB7.js";import{U as da}from"./user-BvYmyGTY.js";import{P as Ue}from"./plus-Bot15Khs.js";import{F as ga}from"./filter-Ci9tsc_e.js";import{C as ua}from"./circle-check-big-D6DM3vPb.js";import{u as ha}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./copy-6OEekgvq.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-Bxx5p2o_.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./download-Dh5rRDOT.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ma=ge("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pa=ge("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ot=ge("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=ge("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xa=ge("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ba=ge("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ya=ge("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=ge("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const va=ge("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wa=ge("Shapes",[["path",{d:"M8.3 10a.7.7 0 0 1-.626-1.079L11.4 3a.7.7 0 0 1 1.198-.043L16.3 8.9a.7.7 0 0 1-.572 1.1Z",key:"1bo67w"}],["rect",{x:"3",y:"14",width:"7",height:"7",rx:"1",key:"1bkyp8"}],["circle",{cx:"17.5",cy:"17.5",r:"3.5",key:"w3z12y"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ja=ge("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=ge("Sticker",[["path",{d:"M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z",key:"1wis1t"}],["path",{d:"M14 3v4a2 2 0 0 0 2 2h4",key:"36rjfy"}],["path",{d:"M8 13h.01",key:"1sbv64"}],["path",{d:"M16 13h.01",key:"wip0gl"}],["path",{d:"M10 16s.8 1 2 1c1.3 0 2-1 2-1",key:"1vvgv3"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=ge("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=ge("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Na=ge("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Sa=({pages:a,currentPage:d,selectedCell:c,selectedElement:j,onSelectCell:n,onSelectElement:m,onUpdateElement:x,onDeleteElement:b,onMoveElement:T})=>{var F;if(!a||!a[d])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ve,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const w=a[d],E=((F=w==null?void 0:w.cells)==null?void 0:F.filter(S=>S.elements&&S.elements.length>0))||[],[A,V]=u.useState(()=>{const S={};return E.forEach(U=>{S[U.id]=!0}),S}),q=S=>{V(U=>({...U,[S]:!U[S]}))},_=S=>{switch(S){case"image":return e.jsx(je,{className:"h-4 w-4"});case"text":return e.jsx(ys,{className:"h-4 w-4"});case"shape":return e.jsx(ja,{className:"h-4 w-4"});case"sticker":return e.jsx(aa,{className:"h-4 w-4"});default:return e.jsx(xa,{className:"h-4 w-4"})}},L=(S,U)=>{switch(S.type){case"text":return S.content?S.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${U+1}`;case"shape":return S.shape||"Shape";case"sticker":return`Sticker ${U+1}`;default:return`Element ${U+1}`}},O=(S,U,te)=>{x(S,U,{visible:te})},X=(S,U)=>{n(S),m(U)};return e.jsx("div",{className:"space-y-2",children:E.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ve,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):E.map(S=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${c===S.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{q(S.id),n(S.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:A[S.id]?e.jsx(ea,{className:"h-4 w-4"}):e.jsx(ta,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",S.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[S.elements.length," element",S.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[S.x,", ",S.y]})]}),A[S.id]&&e.jsx("div",{className:"border-t border-gray-100",children:S.elements.map((U,te)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${j===U.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>X(S.id,U.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:_(U.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:L(U,te)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[U.type," ‚Ä¢ Layer ",te+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:se=>{se.stopPropagation(),O(S.id,U.id,!U.visible)},className:"p-1 hover:bg-gray-200 rounded",title:U.visible?"Hide element":"Show element",children:U.visible!==!1?e.jsx(sa,{className:"h-3 w-3 text-gray-500"}):e.jsx(ya,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:se=>{se.stopPropagation(),T(S.id,U.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:te===S.elements.length-1,children:e.jsx(pa,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:se=>{se.stopPropagation(),T(S.id,U.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:te===0,children:e.jsx(ma,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:se=>{se.stopPropagation(),b(S.id,U.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(ws,{className:"h-3 w-3"})})]})]},U.id))})]},S.id))})};function Ca({currentLayoutId:a,onLayoutChange:d}){const[c,j]=u.useState("all"),n={all:{name:"Todos",layouts:re},hero:{name:"Hero",layouts:re.filter(m=>m.category==="hero")},editorial:{name:"Editorial",layouts:re.filter(m=>m.category==="editorial")},storytelling:{name:"Historia",layouts:re.filter(m=>m.category==="storytelling")},minimal:{name:"Minimal",layouts:re.filter(m=>m.category==="minimal")},creative:{name:"Creativo",layouts:re.filter(m=>m.category==="creative")},classic:{name:"Cl√°sico",layouts:re.filter(m=>m.category==="classic")}};return Object.keys(n).filter(m=>m==="all"||n[m].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:n[c].layouts.map(m=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>d(m.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${m.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:m.cells}).map((x,b)=>{var T,w;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(w=(T=m.cellStyles)==null?void 0:T[b])!=null&&w.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},b)})}),a===m.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:m.name}),m.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:m.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[m.cells," ",m.cells===1?"celda":"celdas"]})})]})]},m.id))}),n[c].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categor√≠a."})})]})}const ka=({selectedMask:a,onSelect:d,availableMasks:c=[],selectedImage:j})=>{var b,T;const[n,m]=u.useState("B√°sicas"),x={};return vs.forEach(w=>{x[w.category]||(x[w.category]=[]),(c.includes(w.id)||w.id==="none")&&x[w.category].push(w)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(x).slice(0,2).map(w=>x[w].length>0&&e.jsx("button",{onClick:()=>m(w),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${n===w?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:w},w))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(b=x[n])==null?void 0:b.slice(0,6).map(w=>e.jsxs("div",{onClick:()=>d(w.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${a===w.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1",children:j!=null&&j.content?e.jsx("img",{src:j.content,alt:w.name,className:`w-full h-full object-cover ${w.class}`}):e.jsx("div",{className:`w-full h-full bg-gray-200 ${w.class}`})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:w.name})]},w.id))}),((T=x[n])==null?void 0:T.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver m√°s m√°scaras (",x[n].length-6," m√°s)"]})]})};function Aa(a,d){var A,V,q,_;const c=parseInt((V=(A=a.style)==null?void 0:A.gap)==null?void 0:V.replace("px",""))||16,j=parseInt((_=(q=a.style)==null?void 0:q.padding)==null?void 0:_.replace("px",""))||16,n=L=>{const O=L.match(/grid-cols-(\d+)/),X=L.match(/grid-rows-(\d+)/),F=O?parseInt(O[1]):1,S=X?parseInt(X[1]):1;return{cols:F,rows:S}},{cols:m,rows:x}=n(a.template),b=d.width-2*j,T=d.height-2*j,w=(b-c*(m-1))/m,E=(T-c*(x-1))/x;return console.log("üéØ [WORKSPACE REPLICA] Grid simulation:",{template:a.template,cols:m,rows:x,gap:c,padding:j,workspace:d,cellSize:{width:w,height:E}}),{cols:m,rows:x,gap:c,padding:j,cellWidth:w,cellHeight:E,contentX:j,contentY:j}}function Ss(a,d,c,j,n,m){if(!d||!a||n<=0||m<=0)return;const x=d.width/d.height,b=n/m;let T,w,E,A;x>b?(A=d.height,E=A*b,T=(d.width-E)/2,w=0):(E=d.width,A=E/b,T=0,w=(d.height-A)/2),a.save(),a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high";try{a.drawImage(d,Math.max(0,T),Math.max(0,w),Math.min(E,d.width-Math.max(0,T)),Math.min(A,d.height-Math.max(0,w)),c,j,n,m)}catch(V){console.error("Error dibujando imagen:",V)}a.restore()}function Pa(a,d,c,j,n,m){return new Promise(async x=>{try{const b=new Image;b.crossOrigin="anonymous",b.onload=()=>{var O,X,F,S;const T=((O=d.position)==null?void 0:O.x)||0,w=((X=d.position)==null?void 0:X.y)||0,E=T>=0&&T<=1,A=w>=0&&w<=1,V=c+(E?T*n:T),q=j+(A?w*m:w),_=(F=d.size)!=null&&F.width?d.size.width<=1?d.size.width*n:d.size.width:n,L=(S=d.size)!=null&&S.height?d.size.height<=1?d.size.height*m:d.size.height:m;console.log("üñºÔ∏è [WORKSPACE REPLICA] Imagen:",{id:d.id,cellPos:{x:c,y:j,width:n,height:m},elementPos:{x:V,y:q,width:_,height:L},originalPos:{x:T,y:w},isRelative:{x:E,y:A}}),d.filters&&(a.filter=`
                        brightness(${(d.filters.brightness||100)/100})
                        contrast(${(d.filters.contrast||100)/100})
                        saturate(${(d.filters.saturation||100)/100})
                        blur(${d.filters.blur||0}px)
                        opacity(${(d.filters.opacity||100)/100})
                    `),Ss(a,b,V,q,_,L),a.filter="none",x()},b.onerror=()=>{console.error("Error cargando imagen:",d.content),x()},b.src=d.content}catch(b){console.error("Error en renderImageElement:",b),x()}})}function Ia(a,d,c,j,n,m){var x,b,T,w;try{const E=((x=d.position)==null?void 0:x.x)||0,A=((b=d.position)==null?void 0:b.y)||0,V=E>=0&&E<=1,q=A>=0&&A<=1,_=c+(V?E*n:E),L=j+(q?A*m:A),O=(T=d.size)!=null&&T.width?d.size.width<=1?d.size.width*n:d.size.width:n*.8,X=(w=d.size)!=null&&w.height?d.size.height<=1?d.size.height*m:d.size.height:m*.2;console.log("üìù [WORKSPACE REPLICA] Texto:",{id:d.id,content:d.content,cellPos:{x:c,y:j,width:n,height:m},elementPos:{x:_,y:L,width:O,height:X}});const F=d.style||{},S=parseInt(F.fontSize)||16,U=F.fontFamily||"Arial, sans-serif",te=F.fontWeight||"normal",se=F.fontStyle||"normal",Z=F.color||"#000000",i=F.textAlign||"left",ue=F.backgroundColor,g=parseInt(F.padding)||8;a.save(),a.font=`${te} ${se} ${S}px ${U}`,a.fillStyle=Z,a.textBaseline="top",ue&&ue!=="transparent"&&(a.fillStyle=ue,a.fillRect(_,L,O,X),a.fillStyle=Z);const D=d.content.split(`
`),me=S*1.2;D.forEach((Ee,G)=>{if(Ee.trim()){let ce=_+g;const C=L+g+G*me;i==="center"?(ce=_+O/2,a.textAlign="center"):i==="right"?(ce=_+O-g,a.textAlign="right"):a.textAlign="left",ce>=0&&C>=0&&ce<a.canvas.width&&C<a.canvas.height&&a.fillText(Ee,ce,C)}}),a.restore()}catch(E){console.error("Error en renderTextElement:",E)}}async function Ta({pages:a,workspaceDimensions:d,presetData:c}){var n;const j={};console.log("üéØ [WORKSPACE REPLICA] Iniciando generaci√≥n ID√âNTICA al workspace..."),console.log("üìê [WORKSPACE REPLICA] Dimensiones:",d);for(const m of a)try{console.log(`üîÑ [WORKSPACE REPLICA] Procesando p√°gina: ${m.id} (${m.type})`);const x=document.createElement("canvas"),b=x.getContext("2d",{willReadFrequently:!0});x.width=d.width,x.height=d.height,b.imageSmoothingEnabled=!0,b.imageSmoothingQuality="high",b.textRendering="geometricPrecision",console.log("üé® [WORKSPACE REPLICA] Renderizando background...");const T=m.backgroundColor||"#ffffff";if(b.fillStyle=T,b.fillRect(0,0,x.width,x.height),console.log("üé® [WORKSPACE REPLICA] Background color aplicado:",T),m.backgroundImage)try{console.log("üñºÔ∏è [WORKSPACE REPLICA] Cargando background image:",m.backgroundImage);const L=new Image;L.crossOrigin="anonymous",await new Promise((O,X)=>{L.onload=O,L.onerror=X,L.src=m.backgroundImage}),Ss(b,L,0,0,x.width,x.height),console.log("‚úÖ [WORKSPACE REPLICA] Background image aplicada")}catch(L){console.error("‚ùå [WORKSPACE REPLICA] Error con background image:",L)}console.log("üóÇÔ∏è [WORKSPACE REPLICA] Renderizando grid layout...");const w=re.find(L=>L.id===m.layout)||re[0];console.log("üìã [WORKSPACE REPLICA] Layout actual:",w.name,w.template);const E=Aa(w,d);if(m.cells&&Array.isArray(m.cells)){console.log(`üì¶ [WORKSPACE REPLICA] Renderizando ${m.cells.length} celdas...`);const L=[...m.cells].sort((O,X)=>{const F=m.cells.indexOf(O),S=m.cells.indexOf(X);return F-S});for(let O=0;O<L.length;O++){const X=L[O],F=Math.floor(O/E.cols),S=O%E.cols,U=E.contentX+S*(E.cellWidth+E.gap),te=E.contentY+F*(E.cellHeight+E.gap);if(console.log(`üì¶ [WORKSPACE REPLICA] Celda ${O} (${X.id}):`,{gridPos:{row:F,col:S},realPos:{x:U,y:te,width:E.cellWidth,height:E.cellHeight}}),b.save(),b.fillStyle="transparent",b.fillRect(U,te,E.cellWidth,E.cellHeight),b.restore(),X.elements&&Array.isArray(X.elements)){const se=[...X.elements].sort((Z,i)=>(Z.zIndex||0)-(i.zIndex||0));console.log(`üîπ [WORKSPACE REPLICA] Renderizando ${se.length} elementos en celda ${X.id}`);for(const Z of se){if(Z.id==="cover-base"||Z.id==="final-base"||(n=Z.id)!=null&&n.startsWith("content-base-")){console.log("‚è≠Ô∏è [WORKSPACE REPLICA] Saltando elemento base:",Z.id);continue}console.log(`üî∏ [WORKSPACE REPLICA] Renderizando elemento: ${Z.id} (${Z.type})`),Z.type==="image"&&Z.content?await Pa(b,Z,U,te,E.cellWidth,E.cellHeight):Z.type==="text"&&Z.content&&Ia(b,Z,U,te,E.cellWidth,E.cellHeight)}}}}console.log("üñºÔ∏è [WORKSPACE REPLICA] Generando thumbnail final...");const A=document.createElement("canvas"),V=A.getContext("2d"),q=1200,_=Math.min(q/x.width,q/x.height);A.width=Math.round(x.width*_),A.height=Math.round(x.height*_),V.imageSmoothingEnabled=!0,V.imageSmoothingQuality="high",V.drawImage(x,0,0,x.width,x.height,0,0,A.width,A.height),j[m.id]=A.toDataURL("image/png",.9),console.log(`‚úÖ [WORKSPACE REPLICA] Thumbnail generado para ${m.id} (${m.type}): ${A.width}x${A.height}`),console.log(`üìã [WORKSPACE REPLICA] ID de la p√°gina: ${m.id}, Tipo: ${m.type}`)}catch(x){console.error(`‚ùå [WORKSPACE REPLICA] Error generando thumbnail para p√°gina ${m.id}:`,x),j[m.id]=null}return console.log("üéØ [WORKSPACE REPLICA] ¬°Generaci√≥n COMPLETADA! Thumbnails id√©nticos al workspace."),console.log("üìã [WORKSPACE REPLICA] Thumbnails generados:",Object.keys(j)),console.log("üìä [WORKSPACE REPLICA] Total de thumbnails:",Object.keys(j).length),j}const Oa=async(a,d,c)=>{var j;try{console.log("üì§ [SAVE] Subiendo imagen al backend:",d);const[n,m]=a.split(","),x=((j=n.match(/data:image\/(\w+)/))==null?void 0:j[1])||"png",b=new FormData,T=atob(m),w=new Array(T.length);for(let _=0;_<T.length;_++)w[_]=T.charCodeAt(_);const E=new Uint8Array(w),A=new Blob([E],{type:`image/${x}`});b.append("image",A,`element_${d}.${x}`),b.append("project_id",c),b.append("element_id",d);const V=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:b});if(!V.ok)throw new Error("Error al subir imagen al servidor");const q=await V.json();return console.log("‚úÖ [SAVE] Imagen subida exitosamente:",q.url),q.url}catch(n){throw console.error("‚ùå [SAVE] Error subiendo imagen:",n),n}},Ra=async(a,d)=>{var m,x;console.log("üîÑ [SAVE] Procesando im√°genes para guardado...");const c=[];let j=0,n=0;for(const b of a)for(const T of b.cells||[])for(const w of T.elements||[])w.type==="image"&&((m=w.content)!=null&&m.startsWith("data:image/"))&&j++;console.log(`üìä [SAVE] Total de im√°genes base64 a procesar: ${j}`);for(const b of a){const T={...b};T.cells=[];for(const w of b.cells||[]){const E={...w};E.elements=[];for(const A of w.elements||[]){const V={...A};if(A.type==="image"&&((x=A.content)!=null&&x.startsWith("data:image/")))try{const q=await Oa(A.content,A.id,d);V.content=q,V.isUploaded=!0,n++,console.log(`‚úÖ [SAVE] Imagen ${n}/${j} procesada`)}catch(q){console.error("‚ùå [SAVE] Error procesando imagen:",A.id,q),V.uploadError=q.message}E.elements.push(V)}T.cells.push(E)}c.push(T)}return console.log(`‚úÖ [SAVE] Procesamiento completado: ${n}/${j} im√°genes subidas`),c},Ma=async(a,d)=>{var c;try{console.log("üîç [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:a,thumbnailsCount:Object.keys(d).length});const j=[];for(const[x,b]of Object.entries(d))console.log(`üîç [DEBUG] Procesando thumbnail para p√°gina ${x}:`,{hasData:!!b,isBase64:b&&b.startsWith("data:image/"),dataLength:b?b.length:0}),b&&b.startsWith("data:image/")&&j.push({page_id:x,thumbnail_data:b});if(j.length===0){console.log("‚ÑπÔ∏è [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`üñºÔ∏è [THUMBNAILS] Guardando ${j.length} thumbnails como archivos...`),console.log(`üîç [DEBUG] URL del endpoint: /api/thumbnails/${a}/save-as-files`);const n=await fetch(`/api/thumbnails/${a}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.content)||""},credentials:"include",body:JSON.stringify({thumbnails:j})});if(console.log("üîç [DEBUG] Respuesta del servidor:",{status:n.status,statusText:n.statusText,ok:n.ok}),!n.ok){const x=await n.text();throw console.error("‚ùå [THUMBNAILS] Error respuesta del servidor:",x),new Error(`Error al guardar thumbnails: ${n.status} ${n.statusText}`)}const m=await n.json();return console.log("‚úÖ [THUMBNAILS] Thumbnails guardados como archivos:",m),m}catch(j){throw console.error("‚ùå [THUMBNAILS] Error guardando thumbnails:",j),j}},bs=async(a,d,c,j,n,m,x=!1)=>{try{if(!(d!=null&&d.id))throw new Error("No se encontr√≥ el ID del proyecto");console.log(`üíæ [SAVE] Iniciando ${x?"auto-guardado":"guardado manual"}...`);let b=a;x||(b=await Ra(a,d.id));const T={pages:b,projectInfo:{id:d.id,item_id:c==null?void 0:c.id,title:c==null?void 0:c.title,preset_id:j==null?void 0:j.id},workspace:{width:n.width,height:n.height,scale:n.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:x,totalPages:a.length}},w=x?"save-progress":"save",E=await fetch(`/api/canvas/projects/${d.id}/${w}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:T,thumbnails:m})});if(!E.ok){const V=await E.json().catch(()=>({}));throw new Error(V.message||"Error al guardar el proyecto")}const A=await E.json();if(console.log(`‚úÖ [SAVE] ${x?"Auto-guardado":"Guardado"} exitoso:`,A),!x&&m&&Object.keys(m).length>0){console.log("üñºÔ∏è [SAVE] Guardando thumbnails como archivos...");try{await Ma(d.id,m),console.log("‚úÖ [SAVE] Thumbnails guardados como archivos")}catch(V){console.warn("‚ö†Ô∏è [SAVE] Error guardando thumbnails como archivos:",V)}}return{success:!0,data:A}}catch(b){return console.error(`‚ùå [SAVE] Error en ${x?"auto-guardado":"guardado"}:`,b),{success:!1,error:b.message}}},$a=(a,d,c,j,n,m)=>{const[x,b]=u.useState("saved"),[T,w]=u.useState(null),[E,A]=u.useState(null),[V,q]=u.useState(null),[_,L]=u.useState(!1),[O,X]=u.useState(navigator.onLine),F=u.useRef(null),S=u.useRef(null),U=u.useRef(null),te=u.useRef(!1),se=u.useRef(null),Z=15e3,i=2e3,ue=5e3,g=u.useCallback((C,K)=>{try{const z={pages:C.map(ee=>{var Fe;return{id:ee.id,layout:ee.layout,cells:((Fe=ee.cells)==null?void 0:Fe.map(We=>{var pe;return{id:We.id,elements:((pe=We.elements)==null?void 0:pe.map(ne=>{var de;return{id:ne.id,type:ne.type,content:ne.type==="image"&&((de=ne.content)!=null&&de.startsWith("data:image/"))?`[IMAGE_${ne.content.length}]`:ne.content,position:ne.position,size:ne.size,style:ne.style,filters:ne.filters,rotation:ne.rotation}}))||[]}}))||[]}})||[],workspace:{width:K==null?void 0:K.width,height:K==null?void 0:K.height}};return btoa(JSON.stringify(z)).substring(0,32)}catch(z){return console.warn("‚ö†Ô∏è [AUTO-SAVE] Error generando hash:",z),Date.now().toString()}},[]),D=u.useCallback(()=>`album_editor_autosave_${(d==null?void 0:d.id)||"draft"}`,[d==null?void 0:d.id]),me=u.useCallback(C=>{try{const K=D(),z={...C,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(K,JSON.stringify(z)),console.log("üíæ [AUTO-SAVE] Guardado en localStorage"),!0}catch(K){return console.error("‚ùå [AUTO-SAVE] Error guardando en localStorage:",K),!1}},[D]),Ee=u.useCallback(()=>{var C;try{const K=D(),z=localStorage.getItem(K);if(z){const ee=JSON.parse(z);return console.log("üìÇ [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(C=ee.pages)==null?void 0:C.length,savedAt:new Date(ee.savedAt).toLocaleString()}),ee}}catch(K){console.error("‚ùå [AUTO-SAVE] Error cargando desde localStorage:",K)}return null},[D]),G=u.useCallback(async(C=!1)=>{if(te.current&&!C){console.log("‚è≥ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(d!=null&&d.id)||!a||a.length===0){console.log("‚ö†Ô∏è [AUTO-SAVE] Datos insuficientes para guardar");return}const K=g(a,n);if(!C&&K===U.current){console.log("üìä [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{te.current=!0,b("saving"),q(null);const z={pages:a,projectInfo:{id:d.id,item_id:c==null?void 0:c.id,title:c==null?void 0:c.title,preset_id:j==null?void 0:j.id},workspace:n,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:K}};if(me(z),O){const ee=await bs(a,d,c,j,n,m,!0);if(ee.success)U.current=K,A(new Date),b("saved"),L(!1),console.log("‚úÖ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(ee.error)}else console.log("ÔøΩ [AUTO-SAVE] Sin conexi√≥n, solo guardado en localStorage"),b("pending"),L(!0)}catch(z){console.error("‚ùå [AUTO-SAVE] Error:",z),q(z.message),b("error"),O&&(se.current=setTimeout(()=>{console.log("üîÑ [AUTO-SAVE] Reintentando guardado..."),G(!0)},ue))}finally{te.current=!1}},[a,d,c,j,n,m,g,me,O]),ce=u.useCallback(async()=>{try{b("saving");const C=await bs(a,d,c,j,n,m,!1);if(C.success){const K=g(a,n);U.current=K,w(new Date),b("saved"),L(!1),ae.success("üíæ Proyecto guardado exitosamente"),console.log("‚úÖ [MANUAL-SAVE] Guardado manual exitoso")}else q(C.error),b("error"),ae.error(`‚ùå Error al guardar: ${C.error}`);return C.success}catch(C){return console.error("‚ùå [MANUAL-SAVE] Error:",C),q(C.message),b("error"),ae.error(`‚ùå Error inesperado: ${C.message}`),!1}},[a,d,c,j,n,m,g]);return u.useEffect(()=>{if(!(d!=null&&d.id)||!a||a.length===0)return;const C=g(a,n);return U.current&&C!==U.current?(console.log("üîÑ [AUTO-SAVE] Cambios detectados, programando guardado..."),L(!0),b("pending"),S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{G()},i)):U.current||(U.current=C),()=>{S.current&&clearTimeout(S.current)}},[a,n,d==null?void 0:d.id,g,G]),u.useEffect(()=>{if(d!=null&&d.id)return F.current&&clearInterval(F.current),F.current=setInterval(()=>{_&&(console.log("‚è∞ [AUTO-SAVE] Auto-save peri√≥dico activado"),G())},Z),()=>{F.current&&clearInterval(F.current)}},[d==null?void 0:d.id,_,G]),u.useEffect(()=>{const C=()=>{console.log("üåê [AUTO-SAVE] Conexi√≥n restaurada"),X(!0),_&&setTimeout(()=>G(!0),1e3)},K=()=>{console.log("üì¥ [AUTO-SAVE] Conexi√≥n perdida"),X(!1)};return window.addEventListener("online",C),window.addEventListener("offline",K),()=>{window.removeEventListener("online",C),window.removeEventListener("offline",K)}},[_,G]),u.useEffect(()=>{const C=K=>{if(_){const z={pages:a,projectInfo:{id:d.id},workspace:n,meta:{savedAt:new Date().toISOString()}};return me(z),K.preventDefault(),K.returnValue="¬øEst√°s seguro de salir? Hay cambios sin guardar.","¬øEst√°s seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",C),()=>window.removeEventListener("beforeunload",C)},[_,a,d==null?void 0:d.id,n,me]),u.useEffect(()=>()=>{S.current&&clearTimeout(S.current),F.current&&clearInterval(F.current),se.current&&clearTimeout(se.current)},[]),u.useEffect(()=>{V&&(V.includes("max_allowed_packet")||V.includes("data_too_large")?ae.error("‚ùå El proyecto es demasiado grande para guardar autom√°ticamente. Reduce el n√∫mero o tama√±o de im√°genes."):ae.error(`‚ùå Error de auto-guardado: ${V}`))},[V]),{saveStatus:x,lastSaved:T,lastAutoSaved:E,saveError:V,hasUnsavedChanges:_,isOnline:O,saveManually:ce,performAutoSave:()=>G(!0),loadFromLocalStorage:Ee,getStorageKey:D,autoSaveInterval:Z,debounceDelay:i}},_a=({saveStatus:a,lastSaved:d,lastAutoSaved:c,hasUnsavedChanges:j,isOnline:n,saveError:m,onManualSave:x,className:b=""})=>{const T=A=>{if(!A)return null;const q=new Date-A,_=Math.floor(q/(1e3*60)),L=Math.floor(q/1e3);if(L<30)return"hace unos segundos";if(_<1)return`hace ${L}s`;if(_<60)return`hace ${_}m`;const O=Math.floor(_/60);return O<24?`hace ${O}h`:A.toLocaleDateString()},E=(()=>{if(!n)return{icon:e.jsx(xs,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexi√≥n",detail:"Guardado local activo"};switch(a){case"saving":return{icon:e.jsx(la,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(Es,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:c?`Auto-guardado ${T(c)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(Ns,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:m||"Error desconocido"};case"pending":return{icon:e.jsx(ia,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:j?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(js,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${b}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${E.bg} ${E.color}
                    hover:shadow-md
                `,onClick:()=>a!=="saving"&&(x==null?void 0:x()),children:[E.icon,e.jsx("span",{className:"text-sm font-medium",children:E.text}),j&&a!=="saving"&&e.jsx("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-pulse"}),e.jsx("div",{className:"flex items-center",children:n?e.jsx(Na,{className:"w-3 h-3 text-green-500"}):e.jsx(xs,{className:"w-3 h-3 text-orange-500"})})]}),e.jsxs("div",{className:`
                absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2
                bg-gray-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg
                opacity-0 group-hover:opacity-100 pointer-events-none
                transition-opacity duration-200 z-50 whitespace-nowrap
            `,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:E.text}),e.jsx("div",{className:"text-gray-300",children:E.detail}),d&&e.jsxs("div",{className:"text-gray-400 text-xs",children:["√öltimo guardado manual: ",T(d)]}),e.jsxs("div",{className:"text-gray-400 text-xs",children:[n?"üåê En l√≠nea":"üì¥ Sin conexi√≥n",a!=="saving"&&" ‚Ä¢ Click para guardar"]})]}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"})]}),a==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},La=({isOpen:a,onClose:d,savedProgress:c,onLoadProgress:j,onDiscardProgress:n})=>{var E;const[m,x]=u.useState(!1);if(!a||!c)return null;const b=async()=>{x(!0);try{await j(c),d()}catch(A){console.error("Error cargando progreso:",A)}finally{x(!1)}},T=async()=>{x(!0);try{await n(),d()}catch(A){console.error("Error descartando progreso:",A)}finally{x(!1)}},w=A=>{const V=new Date(A),_=new Date-V,L=Math.floor(_/(1e3*60)),O=Math.floor(L/60),X=Math.floor(O/24);return L<1?"hace unos segundos":L<60?`hace ${L} minutos`:O<24?`hace ${O} horas`:X===1?"ayer":X<7?`hace ${X} d√≠as`:V.toLocaleDateString()};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 p-6 border-b border-gray-200",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(Qs,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Progreso Guardado Encontrado"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Se encontr√≥ un trabajo sin finalizar"})]})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(fa,{className:"w-4 h-4 text-gray-400 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Guardado autom√°ticamente"}),e.jsx("div",{className:"text-xs text-gray-500",children:w(c.savedAt)})]})]}),c.pages&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(na,{className:"w-4 h-4 text-gray-400 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[c.pages.length," p√°ginas en progreso"]}),e.jsx("div",{className:"text-xs text-gray-500",children:((E=c.meta)==null?void 0:E.version)||"Versi√≥n no especificada"})]})]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ns,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-amber-800",children:[e.jsx("div",{className:"font-medium mb-1",children:"¬øQu√© te gustar√≠a hacer?"}),e.jsx("div",{className:"text-amber-700",children:"Puedes continuar desde donde lo dejaste o comenzar un nuevo dise√±o."})]})]})})]}),e.jsxs("div",{className:"flex gap-3 p-6 border-t border-gray-200",children:[e.jsxs("button",{onClick:b,disabled:m,className:`flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium 
                                 flex items-center justify-center gap-2 transition-colors disabled:opacity-50`,children:[m?e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}):e.jsx(Es,{className:"w-4 h-4"}),"Continuar Editando"]}),e.jsxs("button",{onClick:T,disabled:m,className:`flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2.5 rounded-lg font-medium 
                                 flex items-center justify-center gap-2 transition-colors disabled:opacity-50`,children:[e.jsx(ws,{className:"w-4 h-4"}),"Comenzar de Nuevo"]})]}),e.jsx("button",{onClick:d,className:"absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors",disabled:m,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})},nt=it.memo(({pageId:a,thumbnail:d,altText:c,type:j})=>d?e.jsx("img",{src:d,alt:c,className:"w-full h-full object-contain",loading:"lazy",style:{transition:"opacity 0.2s ease-in-out",imageRendering:"optimizeQuality"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center"})),za=it.memo(({images:a,onImageSelect:d,isLoading:c})=>{const j=it.memo(({image:n})=>{const[m,x]=u.useState(!1),[b,T]=u.useState(!1),[{isDragging:w},E]=ha(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:n.url},collect:q=>({isDragging:!!q.isDragging()})})),A=n.thumbnail_url||n.url,V=n.url;return e.jsxs("div",{ref:E,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${w?"opacity-50 scale-95":""}`,onClick:()=>d(V),children:[e.jsxs("div",{className:"aspect-square relative",children:[!m&&!b&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),b?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(je,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:A,alt:n.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${m?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>x(!0),onError:()=>T(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(Ue,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:n.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),n.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return c?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((n,m)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},m))}):a.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(je,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay im√°genes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:a.map((n,m)=>e.jsx(j,{image:n},`${n.id||n.url}-${m}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[a.filter(n=>n.has_thumbnail).length," de ",a.length," im√°genes optimizadas"]})})]})});function Vo(){var Nt,St,Ct,kt,At,Pt,It,Tt,Ot,Rt,Mt,$t,_t,Lt,zt,Ut,Vt,Ft,Wt,Bt,Ht,Gt,qt,Kt,Qt,Xt,Jt,Yt,Zt,Dt,es,ts,ss,as,os,rs,ns,is,ls,cs;const[a,d]=u.useState(null),[c,j]=u.useState(null),[n,m]=u.useState(null),[x,b]=u.useState(null),[T,w]=u.useState(!0),[E,A]=u.useState(null),[V,q]=u.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[_,L]=u.useState(new Map),[O,X]=u.useState([]),[F,S]=u.useState(!1),U=u.useRef(O),te=u.useRef(_);u.useRef(null),u.useEffect(()=>{U.current=O},[O]),u.useEffect(()=>{te.current=_},[_]),u.useEffect(()=>{(async()=>{var s;try{const r=new URLSearchParams(window.location.search).get("project");if(!r){A("No se encontr√≥ el ID del proyecto en la URL"),w(!1);return}const l=await fetch(`/api/canvas/projects/${r}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!l.ok)throw new Error("Error al cargar el proyecto");const h=await l.json();d(h.project),j(h.item),m(h.canvasPreset),b(h.initialProject),w(!1)}catch(o){console.error("‚ùå Error cargando proyecto:",o),A(o.message),w(!1)}})()},[]);const[se,Z]=u.useState(ps.Local.get(`${fs.APP_CORRELATIVE}_cart`)??[]);u.useEffect(()=>{ps.Local.set(`${fs.APP_CORRELATIVE}_cart`,se)},[se]);const[i,ue]=u.useState([]),[g,D]=u.useState(0),[me,Ee]=u.useState("preset"),[G,ce]=u.useState(null),[C,K]=u.useState(null),[z,ee]=u.useState("pages"),[Fe,We]=u.useState("basic"),[pe,ne]=u.useState([JSON.stringify(i)]),[de,Ne]=u.useState(0),[Cs,Ua]=u.useState(!1),[Va,lt]=u.useState(null),[Y,he]=u.useState({}),[Fa,Wa]=u.useState(!1),[Pe,Be]=u.useState([]),[He,ct]=u.useState(!1),[Me,ks]=u.useState(new Map),ve=u.useRef(null),dt=u.useRef(),[M,gt]=u.useState({width:800,height:600}),Ge=u.useCallback(async()=>{if(a!=null&&a.id)try{const t=await fetch(`/api/thumbnails/${a.id}`);if(t.ok){const s=await t.json();if(s.success&&s.thumbnails&&s.thumbnails.length>0){const o={};s.thumbnails.forEach(r=>{r.page_id&&r.thumbnail_url&&(o[r.page_id]=r.thumbnail_url)}),Object.keys(o).length>0?(he(r=>({...r,...o})),console.log("‚úÖ Thumbnails cargados desde storage:",Object.keys(o).length)):console.log("‚ÑπÔ∏è No hay thumbnails guardados, usando generaci√≥n local")}else console.log("‚ÑπÔ∏è No hay thumbnails guardados para este proyecto")}}catch(t){console.warn("‚ö†Ô∏è Error cargando thumbnails guardados (usando locales):",t)}},[a==null?void 0:a.id]),Se=u.useCallback(async()=>{if(!(!(i!=null&&i.length)||!M||!n))try{const t=await Ta({pages:i,workspaceDimensions:M,presetData:n});t&&Object.keys(t).length>0&&(he(s=>({...s,...t})),console.log("‚úÖ Thumbnails locales generados:",Object.keys(t).length))}catch(t){console.warn("‚ö†Ô∏è Error generando thumbnails locales:",t)}},[i,M,n]),qe=u.useCallback(async()=>{var t;if(!(!(a!=null&&a.id)||!(i!=null&&i.length)))try{const s=await fetch(`/api/thumbnails/${a.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:i})});if(s.ok){const o=await s.json();o&&Object.keys(o).length>0?(he(r=>({...r,...o})),console.log("‚úÖ Thumbnails existentes cargados:",Object.keys(o).length)):(console.log("üì∏ No hay thumbnails existentes, generando nuevos..."),await Se())}}catch(s){console.warn("‚ö†Ô∏è Error cargando thumbnails existentes:",s),await Se()}},[a==null?void 0:a.id,i,Se]);u.useCallback(async()=>{if(!(!(a!=null&&a.id)||!(i!=null&&i.length)))try{const t=i[g];if(!t)return;const s=await fetch(`/api/thumbnails/${a.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:M.width,height:M.height,quality:95,scale:4,dpi:300})});if(s.ok){const o=await s.json();if(o.success&&o.thumbnails){const r={};o.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(r[l.page_id]=l.thumbnail_url)}),he(l=>({...l,...r})),console.log("‚úÖ Thumbnail generado y guardado en storage para p√°gina actual:",o.thumbnails.length)}}}catch(t){console.warn("‚ö†Ô∏è Error generando thumbnail:",t)}},[a==null?void 0:a.id,i,g,M]),u.useCallback(async()=>{if(!(!(a!=null&&a.id)||!(i!=null&&i.length)))try{const t=await fetch(`/api/thumbnails/${a.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:i,width:M.width,height:M.height,quality:95,scale:4,dpi:300})});if(t.ok){const s=await t.json();if(s.success&&s.thumbnails){const o={};s.thumbnails.forEach(r=>{r.page_id&&r.thumbnail_url&&(o[r.page_id]=r.thumbnail_url)}),he(r=>({...r,...o})),console.log("‚úÖ Todos los thumbnails generados y guardados en storage:",s.thumbnails.length)}}}catch(t){console.warn("‚ö†Ô∏è Error generando todos los thumbnails:",t)}},[a==null?void 0:a.id,i,M]),u.useEffect(()=>{if(x&&c&&n){if(x.pages&&Array.isArray(x.pages)){const t=x.pages.map(s=>{let o=null,r=n.background_color||"#ffffff";return s.type==="cover"?c.cover_image&&(o=`/storage/images/item/${c.cover_image}`):s.type==="content"?c.content_image&&(o=`/storage/images/item/${c.content_image}`):(s.type==="final"||s.type==="contraportada")&&c.back_cover_image&&(o=`/storage/images/item/${c.back_cover_image}`),{...s,backgroundImage:o,backgroundColor:r}});ue(t),ne([JSON.stringify(t)]),Ne(0),setTimeout(()=>{Ge()},100)}else{const t=wt(n,c);ue(t),ne([JSON.stringify(t)]),Ne(0),setTimeout(()=>{Ge()},100)}typeof x.currentPage=="number"&&D(x.currentPage),x.workspaceSize&&Ee(x.workspaceSize)}},[x,c,n,Ge]);const xe=$a(i,a,c,n,M,Y),ut=()=>{if(n!=null&&n.width&&(n!=null&&n.height)){let p=n.width,y=n.height,P=p*37.8,R=y*37.8;if(P&&R){const k=window.innerWidth*.6,$=window.innerHeight*.7,v=k/P,N=$/R,I=Math.min(v,N,1);return{width:Math.round(P*I),height:Math.round(R*I),originalWidth:p,originalHeight:y,scale:I,unit:"cm",originalWidthPx:Math.round(P),originalHeightPx:Math.round(R)}}}if(n!=null&&n.extra_settings)try{const p=typeof n.extra_settings=="string"?JSON.parse(n.extra_settings):n.extra_settings;if(p!=null&&p.canvas_config){const y=p.canvas_config;let P=y.width,R=y.height,k=P*37.8,$=R*37.8;if(k&&$){const v=window.innerWidth*.6,N=window.innerHeight*.7,I=v/k,W=N/$,J=Math.min(I,W,1);return{width:Math.round(k*J),height:Math.round($*J),originalWidth:P,originalHeight:R,scale:J,unit:"cm",originalWidthPx:Math.round(k),originalHeightPx:Math.round($)}}}}catch(p){console.warn("Error parsing extra_settings:",p)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},s=t[me]||t.preset,o=window.innerWidth*.6,r=window.innerHeight*.7,l=o/s.width,h=r/s.height,f=Math.min(l,h,1);return{width:Math.round(s.width*f),height:Math.round(s.height*f),originalWidth:s.width,originalHeight:s.height,scale:f,unit:"px"}},be=u.useCallback(async(t={type:"thumbnail"})=>{if(!i[g])return null;try{let s=document.querySelector(`#page-${i[g].id}`);if(!s)return console.warn("‚ùå THUMBNAIL: No se encontr√≥ el elemento de p√°gina espec√≠fico"),null;const o=i[g],r=t.type==="pdf",l=r?11.81:3,h=1,f=getComputedStyle(s);let p=(o==null?void 0:o.backgroundColor)||"#ffffff";f.backgroundColor&&f.backgroundColor!=="rgba(0, 0, 0, 0)"&&(p=f.backgroundColor);const y={scale:l,useCORS:!0,allowTaint:!1,backgroundColor:p,width:M.width,height:M.height,x:0,y:0,scrollX:0,scrollY:0,foreignObjectRendering:!!r,removeContainer:!1,logging:!1,imageTimeout:r?6e4:15e3,pixelRatio:r?3:window.devicePixelRatio||1,canvas:r?document.createElement("canvas"):null,windowWidth:r?M.width*l:null,windowHeight:r?M.height*l:null,onclone:async k=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(v=>{try{k.querySelectorAll(v).forEach(I=>I.remove())}catch(N){console.warn("Error removing selector:",v,N)}});try{const v=k.querySelector(`#page-${i[g].id}`);v&&(v.style.width=M.width+"px",v.style.height=M.height+"px",v.style.position="relative",v.style.overflow="hidden",o!=null&&o.backgroundImage&&(v.style.backgroundImage=`url(${o.backgroundImage})`,v.style.backgroundSize="cover",v.style.backgroundPosition="center",v.style.backgroundRepeat="no-repeat"),o!=null&&o.backgroundColor&&(v.style.backgroundColor=o.backgroundColor))}catch(v){console.error("‚ùå [THUMBNAIL-FIX] Error configurando elemento de p√°gina:",v)}try{const v=new Map;s.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((H,ye)=>{if(H.complete&&H.naturalWidth>0){const le=(H.closest('[data-element-type="image"]')||H.parentElement).getBoundingClientRect(),fe=H.getBoundingClientRect();v.set(H.src,{src:H.src,naturalWidth:H.naturalWidth,naturalHeight:H.naturalHeight,containerWidth:le.width,containerHeight:le.height,objectFit:getComputedStyle(H).objectFit||"cover",objectPosition:getComputedStyle(H).objectPosition||"center",crossOrigin:H.crossOrigin})}});const I=async(H,ye,ie,le,fe)=>new Promise(Ce=>{try{const ke=ye/ie,et=le/fe;let _e,Le,tt,st,ds,gs;et>ke?(gs=ie,ds=ie*et,Le=fe,_e=fe*ke,tt=(le-_e)/2,st=0):(ds=ye,gs=ye/et,_e=le,Le=le/ke,tt=0,st=(fe-Le)/2);const ze=k.createElement("canvas");ze.width=ye,ze.height=ie;const qs=ze.getContext("2d"),Re=new Image;Re.crossOrigin="anonymous",Re.onload=()=>{try{qs.drawImage(Re,tt,st,_e,Le,0,0,ye,ie);const at=ze.toDataURL("image/png",1);H.src=at,H.style.objectFit="fill",H.style.objectPosition="center",H.style.width="100%",H.style.height="100%",Ce()}catch(at){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en canvas processing:",at),Ce()}},Re.onerror=()=>{console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),Ce()},Re.src=H.src}catch(ke){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",ke),Ce()}}),W=k.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),J=[];W.forEach((H,ye)=>{if(H.src&&v.has(H.src)){const ie=v.get(H.src),le=H.closest('[data-element-type="image"]')||H.parentElement;if(le&&(le.style.overflow="hidden",le.style.position="relative"),ie.objectFit==="cover"||H.classList.contains("object-cover")||H.classList.contains("workspace-image")){const fe=I(H,ie.containerWidth,ie.containerHeight,ie.naturalWidth,ie.naturalHeight);J.push(fe)}else H.style.width="100%",H.style.height="100%",H.style.objectFit="fill"}}),J.length>0&&await Promise.all(J);const B=k.createElement("style");B.textContent=`
                            /* CORRECCI√ìN THUMBNAIL: Estructura del elemento de p√°gina */
                            #page-${i[g].id} {
                                width: ${M.width}px !important;
                                height: ${M.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* üñ®Ô∏è IM√ÅGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya est√°n recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${r?`
                                /* üñ®Ô∏è IMPRESI√ìN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de p√°gina */
                            #page-${i[g].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* üñ®Ô∏è OPTIMIZACIONES GENERALES PARA PDF DE IMPRESI√ìN */
                            ${r?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,k.head.appendChild(B)}catch(v){console.error("‚ùå [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",v);const N=k.createElement("style");N.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,k.head.appendChild(N)}}},P=await ms(s,y);if(r&&P){const k=P.getContext("2d");if(k){k.imageSmoothingEnabled=!1,k.imageSmoothingQuality="high";const $=k.getImageData(0,0,P.width,P.height),v=$.data;for(let N=0;N<v.length;N+=4)v[N]=Math.min(255,v[N]*1.05),v[N+1]=Math.min(255,v[N+1]*1.05),v[N+2]=Math.min(255,v[N+2]*1.05);k.putImageData($,0,0)}}if(!P)throw new Error("html2canvas no devolvi√≥ un canvas v√°lido para el elemento de p√°gina");if(P.width===0||P.height===0)throw new Error("Canvas del elemento de p√°gina tiene dimensiones inv√°lidas");const R=P.toDataURL("image/png",h);if(!R||R==="data:,")throw new Error("No se pudo generar dataURL del elemento de p√°gina");return r?P:R}catch(s){console.error("‚ùå [THUMBNAIL-FIX] Error capturando elemento de p√°gina:",s);try{const o=document.createElement("canvas"),r=t.type==="pdf"?11.81:1;o.width=M.width*r,o.height=M.height*r;const l=o.getContext("2d"),h=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return l.fillStyle=h,l.fillRect(0,0,o.width,o.height),l.fillStyle=h==="#ffffff"||h.includes("white")?"#374151":"#666666",l.font=`${14*r}px Arial`,l.textAlign="center",l.fillText("P√°gina "+(g+1),o.width/2,o.height/2),t.type==="pdf"?o:o.toDataURL("image/png",1)}catch{return null}}},[g,i]),$e=u.useCallback(async()=>{if(!i[g])return;const t=await be({type:"thumbnail"});t&&he(s=>({...s,[i[g].id]:t}))},[be,g,i]);u.useCallback(()=>{clearTimeout(dt.current),dt.current=setTimeout(()=>{i[g]&&!Y[i[g].id]&&$e()},1200)},[$e,i,g,Y]);const ht=u.useCallback(()=>{i[g]&&!Y[i[g].id]&&setTimeout(()=>{$e()},300)},[$e,i,g,Y]),As=u.useCallback(async(t=g,s={width:800,height:600})=>{var o,r;if(!i[t])return null;try{const l=g;t!==g&&(D(t),await new Promise(y=>setTimeout(y,100)));const h=document.querySelector(`#page-${i[t].id}`);if(!h)return console.warn("Workspace element not found for page:",i[t].id),null;const f={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((o=i[t])==null?void 0:o.backgroundColor)||"#ffffff",width:h.offsetWidth,height:h.offsetHeight,removeContainer:!0,logging:!1,onclone:y=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(v=>{y.querySelectorAll(v).forEach(I=>I.remove())});const R=y.querySelector(`#page-${i[t].id}`);if(R){const v=i[t];v!=null&&v.backgroundImage&&(R.style.backgroundImage=`url(${v.backgroundImage})`,R.style.backgroundSize="cover",R.style.backgroundPosition="center",R.style.backgroundRepeat="no-repeat"),v!=null&&v.backgroundColor&&(R.style.backgroundColor=v.backgroundColor)}try{const v=h.querySelectorAll("img"),N=new Map;v.forEach((W,J)=>{const B=getComputedStyle(W);N.set(J,{objectFit:B.objectFit,objectPosition:B.objectPosition,width:B.width,height:B.height,borderRadius:B.borderRadius,transform:B.transform})}),y.querySelectorAll("img").forEach((W,J)=>{const B=N.get(J);B&&(W.style.objectFit=B.objectFit||"cover",W.style.objectPosition=B.objectPosition||"center",W.style.width=B.width,W.style.height=B.height,W.style.borderRadius=B.borderRadius,W.style.transform=B.transform)})}catch(v){console.warn("Error preservando estilos de im√°genes:",v),y.querySelectorAll("img").forEach(I=>{I.style.objectFit="cover",I.style.objectPosition="center",I.style.width||(I.style.width="100%"),I.style.height||(I.style.height="100%")})}y.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(v=>{const N=v.className;N&&(v.className=N);const I=getComputedStyle?getComputedStyle(v):null;I&&(I.fontFamily&&I.fontFamily!=="Arial"&&(v.style.fontFamily=I.fontFamily),I.fontSize&&(v.style.fontSize=I.fontSize),I.fontWeight&&(v.style.fontWeight=I.fontWeight),I.fontStyle&&(v.style.fontStyle=I.fontStyle))});const $=y.createElement("style");$.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CR√çTICO: Asegurar que las im√°genes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CR√çTICO: Asegurar que los backgrounds de p√°gina se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,y.head.appendChild($)}},p=await ms(h,f);if(s.width!==p.width||s.height!==p.height){const y=document.createElement("canvas");y.width=s.width,y.height=s.height;const P=y.getContext("2d"),R=p.width/p.height,k=s.width/s.height;let $,v,N=0,I=0;R>k?($=s.width,v=s.width/R,I=(s.height-v)/2):(v=s.height,$=s.height*R,N=(s.width-$)/2),P.fillStyle=((r=i[t])==null?void 0:r.backgroundColor)||"#ffffff",P.fillRect(0,0,s.width,s.height),P.drawImage(p,N,I,$,v);const W=y.toDataURL("image/png",1);return t!==l&&D(l),W}return t!==l&&D(l),p.toDataURL("image/png",1)}catch(l){return console.error("‚ùå Error generando thumbnail de alta calidad:",l),null}},[i,g,D]);u.useEffect(()=>{const t=ut();gt(t)},[n,me]),u.useEffect(()=>{const t=()=>{const s=ut();gt(s)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[n,me]),u.useEffect(()=>{if(i[g]&&!Y[i[g].id]){const t=setTimeout(()=>{ht()},400);return()=>clearTimeout(t)}},[g]),u.useEffect(()=>{const t=i[g];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(s=>{s.ok?console.log("‚úÖ [WORKSPACE] Imagen existe en el servidor"):console.error("‚ùå [WORKSPACE] Imagen NO existe en el servidor. Status:",s.status)}).catch(s=>{console.error("‚ùå [WORKSPACE] Error verificando imagen:",s)})},[g,(Nt=i[g])==null?void 0:Nt.backgroundImage]),u.useEffect(()=>{const t=`${M.width}x${M.height}`,s=sessionStorage.getItem("lastWorkspaceDimensions");s&&s!==t&&i.length>0&&(he({}),setTimeout(()=>{i[g]&&ht()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[M.width,M.height]),u.useEffect(()=>{if(!(a!=null&&a.id)||i.length===0)return;let t,s=Date.now(),o=!1;const r=()=>{o=!0,s=Date.now()},l=async()=>{if(o)try{console.log("üîÑ [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(y=>({...y,saveStatus:"saving"}));const f=await fetch(`/api/projects/${a.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:i,force:!1})}),p=await f.json();if(f.ok&&p.success)o=!1,q(y=>({...y,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("‚úÖ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado fall√≥")}catch(f){console.error("‚ùå [AUTO-SAVE] Error en guardado silencioso:",f),q(p=>({...p,saveStatus:"error",saveError:f.message}))}},h=()=>{t=setInterval(()=>{const f=Date.now()-s;o&&f>6e4&&(console.log("‚è∞ [AUTO-SAVE] Condiciones cumplidas para guardado autom√°tico"),l())},3*60*1e3)};return JSON.stringify(i),i[g],r(),h(),()=>{t&&clearInterval(t)}},[i,g,a==null?void 0:a.id]),u.useEffect(()=>{var s;if(!i[g])return;const t=((s=i[g].cells)==null?void 0:s.flatMap(o=>o.elements))||[];JSON.stringify(t),q(o=>({...o,hasUnsavedChanges:!0}))},[(St=i[g])==null?void 0:St.cells,g]);const[Ba,Ke]=u.useState(!1),[Ha,Ps]=u.useState({elementId:null,cellId:null}),[Is,mt]=u.useState(!1),[Ts,pt]=u.useState(!1),[Os,Rs]=u.useState(null),Qe=u.useRef(null),Ms=async t=>{const s=t.target.files[0];if(!s||!(a!=null&&a.id))return;const o=new FormData;o.append("image",s),o.append("projectId",a.id);try{const l=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:o})).json();if(l.success){const h={id:Date.now(),filename:s.name,url:l.url,thumbnail_url:l.thumbnail_url,has_thumbnail:l.has_thumbnail,size:s.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Be(f=>[h,...f]),$s(l.url),l.has_thumbnail?ae.success("Imagen subida y optimizada correctamente"):ae.success("Imagen subida correctamente"),ve.current=setTimeout(()=>{ft(!0)},1e3)}else ae.error(l.message||"Error al subir la imagen")}catch(r){console.error("Error subiendo la imagen:",r),ae.error("Error de red al subir la imagen")}},$s=t=>{var r,l,h,f;const s=C||((l=(r=i[g])==null?void 0:r.cells[0])==null?void 0:l.id);if(!s)return;const o={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((f=(h=i[g].cells.find(p=>p.id===s))==null?void 0:h.elements)==null?void 0:f.length)||0)+1};Oe(s,o),ae.success("Imagen a√±adida correctamente")},ft=u.useCallback(async(t=!1)=>{if(a!=null&&a.id&&(ve.current&&clearTimeout(ve.current),!(!t&&Me.has(a.id)&&Pe.length>0)&&!(He&&!t))){ct(!0);try{const o=await(await fetch(`/api/canvas/projects/${a.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"}})).json();if(o.success){const r=o.images||[];Be(r),ks(l=>{const h=new Map(l);return h.set(a.id,r),h})}else console.error("Error cargando im√°genes:",o.message)}catch(s){console.error("Error cargando im√°genes del proyecto:",s)}finally{ct(!1)}}},[a==null?void 0:a.id,Me,Pe.length,He]);u.useEffect(()=>{if(a!=null&&a.id){const t=Me.get(a.id);if(t&&t.length>0){Be(t);return}return ve.current=setTimeout(()=>{ft(!1)},150),()=>{ve.current&&clearTimeout(ve.current)}}},[a==null?void 0:a.id,Me]),u.useEffect(()=>()=>{ve.current&&clearTimeout(ve.current)},[]);const _s=t=>{var r,l,h,f;const s=C||((l=(r=i[g])==null?void 0:r.cells[0])==null?void 0:l.id);if(!s)return;const o={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((f=(h=i[g].cells.find(p=>p.id===s))==null?void 0:h.elements)==null?void 0:f.length)||0)+1};Oe(s,o),ae.success("Imagen a√±adida desde la galer√≠a")},xt=u.useCallback(async(t,s)=>{var l,h;const o=[],r=[];for(const f of t){const p={...f};if(f.cells){p.cells=[];for(const y of f.cells){const P={...y};if(y.elements){P.elements=[];for(const R of y.elements)if(R.type==="image"&&((l=R.content)!=null&&l.startsWith("data:image/"))){const k=`${R.id}_${Date.now()}`,$=R.content.match(/^data:image\/([^;]+);base64,(.+)$/);if($){const v=$[1],N=$[2],W=`${k}.${v==="jpeg"?"jpg":v}`;r.push({filename:W,data:N,type:v,elementId:R.id}),P.elements.push({...R,content:R.content,_wasBase64:!0,_originalSize:R.content.length,_elementId:R.id})}else P.elements.push(R)}else P.elements.push(R)}p.cells.push(P)}}o.push(p)}if(r.length>0)try{const f=await fetch(`/api/canvas/projects/${s}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((h=document.querySelector('meta[name="csrf-token"]'))==null?void 0:h.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:r})});if(f.ok){const p=await f.json();if(p.uploadedImages){const y=new Map;p.uploadedImages.forEach(P=>{y.set(P.elementId,P.url)});for(const P of o)if(P.cells){for(const R of P.cells)if(R.elements)for(const k of R.elements)k._wasBase64&&k._elementId&&y.has(k._elementId)&&(k.content=y.get(k._elementId),delete k._elementId)}}}else{const p=await f.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("‚ùå [IMAGE-UPLOAD] Error subiendo im√°genes:",p),t}}catch(f){return console.error("‚ùå [IMAGE-UPLOAD] Error de red subiendo im√°genes:",f),t}return o},[]),Ie=u.useCallback(async(t=i,s=!1)=>{var o;if(!(!(a!=null&&a.id)||!s&&t.length===0))try{const h={design_data:{pages:await xt(t,a.id),currentPage:g,workspaceDimensions:M,workspaceSize:me,selectedElement:G,selectedCell:C,history:pe.slice(-5),historyIndex:Math.min(de,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:a.id,name:(c==null?void 0:c.name)||"√Ålbum Personalizado",item_id:c==null?void 0:c.id,preset_id:n==null?void 0:n.id}},thumbnails:Y},p=JSON.stringify(h).length/(1024*1024),y=await fetch(`/api/canvas/projects/${a.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(h)});if(y.ok){const P=await y.json(),R=`editor_progress_project_${a.id}`;return localStorage.removeItem(R),L(k=>{const $=new Map(k);return s?$.clear():$.delete(g),$}),i&&i.length>0&&Se().catch(k=>{console.warn("‚ö†Ô∏è Error generando thumbnails locales:",k)}),!0}else{const P=await y.json().catch(()=>({message:"Error desconocido"}));return console.error("‚ùå [AUTO-SAVE] Error guardando en BD:",P),!1}}catch(r){return console.error("‚ùå [AUTO-SAVE] Error en auto-save con procesamiento de im√°genes:",r),!1}},[i,g,M,me,G,C,pe,de,a==null?void 0:a.id,c==null?void 0:c.name,c==null?void 0:c.id,n==null?void 0:n.id,Y,xt,Se,L]);u.useEffect(()=>{if(!(a!=null&&a.id))return;const t=setInterval(()=>{i.length>0&&Ie(i,!1)},5*60*1e3);return()=>clearInterval(t)},[Ie,i,a==null?void 0:a.id]),u.useCallback(async()=>{if(!i.length)return{};console.log("üì∏ [THUMBNAILS] Capturando thumbnails de todas las p√°ginas...");const t={},s=g;try{for(let o=0;o<i.length;o++){const r=i[o];if(r!=null&&r.id)try{o!==g&&(D(o),await new Promise(h=>setTimeout(h,300)));const l=await be({type:"thumbnail"});l&&(t[r.id]=l,console.log(`‚úÖ [THUMBNAILS] Thumbnail capturado para p√°gina ${o+1}: ${r.id}`))}catch(l){console.warn(`‚ö†Ô∏è [THUMBNAILS] Error capturando thumbnail para p√°gina ${r.id}:`,l),Y[r.id]&&(t[r.id]=Y[r.id])}}return s!==g&&D(s),console.log(`‚úÖ [THUMBNAILS] Capturados ${Object.keys(t).length} thumbnails de ${i.length} p√°ginas`),t}catch(o){return console.error("‚ùå [THUMBNAILS] Error capturando thumbnails:",o),s!==g&&D(s),Y}},[i,g,D,be,Y]);const Ls=u.useCallback(async()=>{if(!(a!=null&&a.id)||i.length===0)return ae.error("No hay datos para guardar"),!1;try{return console.log("üì∏ [SAVE] Generando thumbnails localmente..."),await Se(),await qe(),await Ie(i,!0)?(ae.success("Progreso guardado exitosamente"),!0):(ae.error("Error al guardar el progreso"),!1)}catch(t){return console.error("‚ùå [SAVE] Error al guardar el progreso:",t),ae.error("Error al guardar el progreso"),!1}},[Ie,i,a==null?void 0:a.id,M,n,Se]),bt=u.useCallback(async t=>{var s;if(console.log("üíæ [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("üîç [QUEUE-SAVE] Datos disponibles:",{projectId:a==null?void 0:a.id,pagesCount:t==null?void 0:t.length,currentPage:g,hasDimensions:!!M,hasThumbnails:!!Y}),!(a!=null&&a.id))return console.error("‚ùå [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return console.error("‚ùå [QUEUE-SAVE] No hay p√°ginas para guardar"),!1;try{const r={design_data:{pages:t,currentPage:g,workspaceDimensions:M,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:Y};console.log("üì§ [QUEUE-SAVE] Enviando petici√≥n al servidor...");const l=await fetch(`/api/canvas/projects/${a.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(r)});if(console.log("üì• [QUEUE-SAVE] Respuesta del servidor:",l.status,l.statusText),l.ok){const h=await l.json();return console.log("‚úÖ [QUEUE-SAVE] Guardado exitoso desde cola:",h),!0}else{const h=await l.text();return console.error("‚ùå [QUEUE-SAVE] Error en respuesta del servidor:",l.status,h),!1}}catch(o){return console.error("‚ùå [QUEUE-SAVE] Error guardando desde cola:",o),!1}},[a==null?void 0:a.id,g,M,Y]),Xe=u.useCallback(async()=>{if(console.log("üîç [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:F,saveQueueLength:O.length}),F){console.log("‚ö†Ô∏è [SAVE-QUEUE] Ya se est√° procesando, saltando...");return}if(O.length===0){console.log("‚ö†Ô∏è [SAVE-QUEUE] Cola vac√≠a, no hay nada que procesar");return}console.log("üöÄ [SAVE-QUEUE] Iniciando procesamiento de cola..."),S(!0);try{const t=O.slice();console.log("ÔøΩ [SAVE-QUEUE] Cola capturada para procesamiento:",t.length,"elementos"),X([]),console.log("üßπ [SAVE-QUEUE] Cola limpiada");for(const s of t)console.log("üíæ [SAVE-QUEUE] Guardando p√°gina:",s.pageIndex),await bt(s.pages)?(L(r=>{const l=new Map(r);return l.delete(s.pageIndex),l}),console.log("‚úÖ [SAVE-QUEUE] P√°gina guardada exitosamente:",s.pageIndex)):(console.error("‚ùå [SAVE-QUEUE] Error guardando p√°gina:",s.pageIndex),X(r=>[...r,s]));console.log("‚úÖ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(t){console.error("‚ùå [SAVE-QUEUE] Error procesando cola:",t)}finally{S(!1),console.log("üîì [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[F,O,bt]);u.useEffect(()=>{console.log("üîÑ [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:O.length,isProcessingQueue:F,shouldProcess:O.length>0&&!F}),O.length>0&&!F&&(console.log("‚è∞ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{Xe()},100))},[O.length,F,Xe]),u.useEffect(()=>{console.log("üìä [SAVE-QUEUE] Estado de cola actualizado:",{longitud:O.length,elementos:O.map(t=>`p√°gina ${t.pageIndex}`),procesando:F})},[O,F]);const yt=u.useCallback((t,s)=>{console.log("üîç [SAVE-QUEUE] Intentando agregar p√°gina a cola:",t),L(o=>(console.log("üîç [SAVE-QUEUE] Cambios actuales:",Array.from(o.keys())),o.has(t)?(console.log("‚úÖ [SAVE-QUEUE] P√°gina tiene cambios, agregando a cola:",t),X(r=>{console.log("üîç [SAVE-QUEUE] Cola actual antes de agregar:",r.length,"elementos");const l=r.findIndex(h=>h.pageIndex===t);if(l!==-1){const h=[...r];return h[l]={pageIndex:t,pages:s,timestamp:Date.now()},console.log("üîÑ [SAVE-QUEUE] Actualizando elemento existente en cola"),h}else{const h=[...r,{pageIndex:t,pages:s,timestamp:Date.now()}];return console.log("‚ûï [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",h.length),h}}),console.log("üì§ [SAVE-QUEUE] P√°gina agregada a cola:",t),o):(console.log("‚ö†Ô∏è [SAVE-QUEUE] No hay cambios para la p√°gina:",t,"- No se agregar√° a cola"),o)))},[]),Je=u.useCallback(async t=>{if(console.log("üîÑ [PAGE-CHANGE] Iniciando cambio de p√°gina de",g,"a",t),t===g){console.log("‚ö†Ô∏è [PAGE-CHANGE] Misma p√°gina, no se hace nada");return}L(s=>(console.log("üîç [PAGE-CHANGE] Verificando cambios en p√°gina actual:",g),console.log("üîç [PAGE-CHANGE] P√°ginas con cambios:",Array.from(s.keys())),s.has(g)?(console.log("üíæ [PAGE-CHANGE] ‚úÖ P√°gina actual tiene cambios, guardando antes del cambio:",g),yt(g,i)):console.log("‚ÑπÔ∏è [PAGE-CHANGE] No hay cambios en la p√°gina actual:",g),s)),D(t),console.log("üìÑ [PAGE-CHANGE] ‚úÖ P√°gina cambiada a:",t)},[g,i,yt]),Ae=()=>`editor_progress_project_${a==null?void 0:a.id}`,vt=u.useCallback(async()=>{var t,s,o,r;if(a!=null&&a.id)try{const l=xe.loadFromLocalStorage(),h=await fetch(`/api/canvas/projects/${a.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let f=null;if(h.ok){const y=await h.json();y.success&&((t=y.data)!=null&&t.design_data)&&(f=y.data)}let p=null;if(l&&f){const y=new Date(l.savedAt).getTime(),P=new Date(f.saved_at).getTime();p=y>P?l:f}else l?p=l:f&&(p=f);p&&(((s=p.pages)==null?void 0:s.length)>0||((r=(o=p.design_data)==null?void 0:o.pages)==null?void 0:r.length)>0)&&(Rs(p),pt(!0))}catch(l){console.error("‚ùå [RECOVERY] Error verificando progreso guardado:",l)}},[a==null?void 0:a.id,xe]),zs=u.useCallback(async t=>{var s;try{let o=[];if(t.pages?o=t.pages:(s=t.design_data)!=null&&s.pages&&(o=t.design_data.pages),o.length>0){ue(o);const r=[JSON.stringify(o)];ne(r),Ne(0),setTimeout(()=>{he({})},100),ae.success("‚úÖ Progreso cargado exitosamente")}}catch(o){console.error("‚ùå [RECOVERY] Error cargando progreso:",o),ae.error("Error al cargar el progreso guardado")}},[ue,ne,Ne,he]),Us=u.useCallback(async()=>{try{const t=xe.getStorageKey();localStorage.removeItem(t),ae.success("Progreso anterior eliminado")}catch(t){console.error("‚ùå [RECOVERY] Error descartando progreso:",t)}},[xe]);u.useEffect(()=>{a&&c&&n&&(!(x!=null&&x.pages)||x.pages.length===0)&&wt(n,c)},[a,c,n,x]),u.useEffect(()=>{a!=null&&a.id&&!T&&i.length===0&&setTimeout(()=>{vt()},500)},[a==null?void 0:a.id,T,i.length,vt]),u.useEffect(()=>{a!=null&&a.id&&i.length>0&&setTimeout(()=>{qe()},100)},[a==null?void 0:a.id,i.length,qe]);const wt=(t,s)=>{try{const o=[],r=s.pages||t.pages||20,l=s.cover_image?`/storage/images/item/${s.cover_image}`:null,h=s.cover_image?null:t.background_color||"#ffffff",f={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:l,backgroundColor:h,cells:[{id:"cell-cover-1",elements:[{id:"cover-title",type:"text",content:s.name||"Mi √Ålbum Personalizado",position:{x:10,y:20},size:{width:80,height:15},style:{fontSize:"28px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center",backgroundColor:"transparent",padding:"8px"},zIndex:2},...s.image?[{id:"cover-image",type:"image",content:`/storage/images/item/${s.image}`,position:{x:25,y:40},size:{width:50,height:40},filters:{},mask:"none",zIndex:1}]:[]]}]};o.push(f);const p=s.content_image?`/storage/images/item/${s.content_image}`:null,y=s.content_image?null:t.background_color||"#ffffff";for(let $=1;$<=r;$++){const v={id:`page-content-${$}`,type:"content",pageNumber:$,layout:"layout-1",backgroundImage:p,backgroundColor:y,cells:[{id:`cell-content-${$}-1`,elements:[]}]};o.push(v)}const P=s.back_cover_image?`/storage/images/item/${s.back_cover_image}`:null,R=s.back_cover_image?null:t.background_color||"#ffffff",k={id:"page-final",type:"final",layout:"layout-1",backgroundImage:P,backgroundColor:R,cells:[{id:"cell-final-1",elements:[]}]};o.push(k),ue(o),D(0),t.width&&t.height&&Ee("preset")}catch(o){console.error("‚ùå Error creating pages:",o),A(o.message)}},Ye=u.useMemo(()=>({cover:i.filter(t=>t.type==="cover"),content:i.filter(t=>t.type==="content"),final:i.filter(t=>t.type==="final")}),[i]),Q=u.useCallback(()=>{if(!G||!C||i.length===0)return null;const t=i[g];if(!t)return null;const s=t.cells.find(o=>o.id===C);return s?s.elements.find(o=>o.id===G):null},[G,C,i,g]),jt=(t,s)=>{if(s){const o=i[g].cells.find(l=>l.id===s),r=o==null?void 0:o.elements.find(l=>l.id===t);if(r!=null&&r.locked){const l=document.createElement("div");l.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",l.textContent="Este elemento es parte del dise√±o base y no se puede editar",document.body.appendChild(l),setTimeout(()=>{document.body.contains(l)&&document.body.removeChild(l)},3e3);return}}if(s&&K(s),ce(t),t){const o=i[g].cells.find(l=>l.id===(s||C)),r=o==null?void 0:o.elements.find(l=>l.id===t);(r==null?void 0:r.type)==="image"?lt(r):(r==null?void 0:r.type)==="text"?(Ke(!0),Ps({elementId:t,cellId:s||C}),ee("text")):Ke(!1)}else Ke(!1),lt(null)},we=()=>{if(i.length===0)return re[0];const t=i[g];return t?re.find(s=>s.id===t.layout)||re[0]:re[0]},Te=u.useCallback(t=>{ue(t),L(o=>{const r=new Map(o);return r.set(g,Date.now()),console.log("üìù [PAGE-CHANGES] P√°gina marcada como modificada:",g),r});const s=[...pe.slice(0,de+1),JSON.stringify(t)];ne(s),Ne(s.length-1);try{const o=Ae(),r={pages:t,currentPage:g,savedAt:Date.now()},l=JSON.stringify(r),h=Math.round(l.length/1024);if(h<2048)localStorage.setItem(o,l);else{console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${h} KB), saltando guardado local`);try{localStorage.removeItem(o)}catch(f){console.error("Error limpiando localStorage:",f)}}}catch(o){if(console.error("‚ùå Error guardando en localStorage:",o),o.name==="QuotaExceededError")try{const r=Ae();localStorage.removeItem(r)}catch(r){console.error("Error limpiando localStorage:",r)}}if(t[g]){const o=t[g].id;he(r=>{const l={...r};return delete l[o],l})}},[pe,de,Ae,g,L]);u.useEffect(()=>{try{const t=Ae(),s={pages:i,currentPage:g,savedAt:Date.now()},o=JSON.stringify(s),r=Math.round(o.length/1024);r<2048?localStorage.setItem(t,o):console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${r} KB), saltando guardado`)}catch(t){if(console.error("‚ùå Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const s=Ae();localStorage.removeItem(s)}catch(s){console.error("Error limpiando localStorage:",s)}}},[g,i,Ae]);const Vs=t=>{const s=re.find(h=>h.id===t);if(!s)return;const o=[...i],r=o[g],l=Array.from({length:s.cells}).map((h,f)=>r.cells[f]||{id:`cell-${r.id}-${f+1}`,elements:[]});o[g]={...r,layout:t,cells:l},Te(o),ce(null),K(null)},Oe=(t,s)=>{const o=[...i];for(let r=0;r<o[g].cells.length;r++)o[g].cells[r].id===t&&o[g].cells[r].elements.push(s);Te(o),ce(s.id),K(t)},oe=(t,s,o,r=!1)=>{const l=[...i],h=l[g].cells.findIndex(f=>f.id===t);if(h!==-1){if(r)l[g].cells[h].elements.push({...l[g].cells[h].elements.find(f=>f.id===s),...o});else{const f=l[g].cells[h].elements.findIndex(p=>p.id===s);f!==-1&&(l[g].cells[h].elements[f]={...l[g].cells[h].elements[f],...o})}Te(l)}},Ze=(t,s)=>{const o=[...i],r=o[g].cells.findIndex(l=>l.id===t);r!==-1&&(o[g].cells[r].elements=o[g].cells[r].elements.filter(l=>l.id!==s),Te(o),G===s&&ce(null))},Fs=(t,s,o)=>{const r=[...i],l=r[g].cells.findIndex(h=>h.id===t);if(l!==-1){const h=r[g].cells[l].elements,f=h.findIndex(p=>p.id===s);if(f!==-1){const p=o==="up"?f+1:f-1;if(p>=0&&p<h.length){const y=h[f];h[f]=h[p],h[p]=y,Te(r)}}}},Ws=()=>{de>0&&(Ne(de-1),ue(JSON.parse(pe[de-1])),ce(null),K(null))},Bs=()=>{de<pe.length-1&&(Ne(de+1),ue(JSON.parse(pe[de+1])),ce(null),K(null))},De=(t="body")=>{const s=`text-${Date.now()}`,o={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},r={heading:"T√≠tulo Principal",subheading:"Subt√≠tulo",body:"Haz clic para editar"},l={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},h={id:s,type:"text",content:r[t],position:{x:.05,y:.05},size:l[t],style:o[t]};C?Oe(C,h):console.log("Selecciona una celda primero")},Et=u.useMemo(()=>{var l;const t=i[g];if(!t)return null;const s=((l=t.cells)==null?void 0:l.flatMap(h=>h.elements||[]))||[],o=s.map(h=>({id:h.id,type:h.type,position:h.position,size:h.size}));return{pageId:t.id,elementsCount:s.length,contentHash:JSON.stringify(o).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[i,g]);u.useEffect(()=>{if(i.length===0||T||!Et)return;let t=!1;const s=async()=>{try{const r=i[g];if(!r||!r.id)return;const l=r.id;if(he(f=>{const p={...f};return delete p[l],p}),await new Promise(f=>setTimeout(f,100)),t)return;const h=await be();h&&!t?he(f=>({...f,[l]:h})):console.warn("‚ö†Ô∏è [DEBUG] No se pudo generar miniatura para:",l)}catch(r){t||console.error("‚ùå [DEBUG] Error regenerando miniatura:",r)}},o=setTimeout(()=>{s()},500);return()=>{t=!0,clearTimeout(o)}},[g,Et,T,be]),u.useEffect(()=>{if(i.length===0||T)return;const t=async()=>{const o=i.filter(r=>!Y[r.id]);if(o.length!==0)for(const r of o)try{const l=document.createElement("canvas");l.width=200,l.height=150;const h=l.getContext("2d");if(h.fillStyle=r.backgroundColor||"#ffffff",h.fillRect(0,0,200,150),r.backgroundImage)try{const p=new Image;p.crossOrigin="anonymous",await new Promise((y,P)=>{p.onload=y,p.onerror=P,p.src=r.backgroundImage}),h.drawImage(p,0,0,200,150)}catch(p){console.warn("No se pudo cargar imagen de fondo para miniatura:",p)}r.cells&&r.cells.forEach(p=>{p.elements&&p.elements.forEach(y=>{var P;y.type==="text"&&y.content&&(h.fillStyle=((P=y.style)==null?void 0:P.color)||"#000000",h.font="12px Arial",h.fillText(y.content.substring(0,20)+(y.content.length>20?"...":""),10,30))})});const f=l.toDataURL("image/jpeg",.7);he(p=>({...p,[r.id]:f})),await new Promise(p=>setTimeout(p,300))}catch(l){console.error("‚ùå Error generando miniatura de fondo para:",r.id,l)}},s=setTimeout(()=>{t()},2e3);return()=>clearTimeout(s)},[i,Y,T]),u.useEffect(()=>{const t=s=>{const o=U.current,r=te.current;if(o.length>0||r.size>0)return s.preventDefault(),s.returnValue="Hay cambios sin guardar. ¬øEst√°s seguro de que quieres salir?",s.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),u.useEffect(()=>()=>{console.log("üßπ [CLEANUP] Componente desmontado")},[]);const Hs=async()=>{var t;try{if(!c||!n||!(a!=null&&a.id))return!1;await Ie(i,!0)||console.warn("‚ö†Ô∏è No se pudo guardar el progreso, pero continuando...");const o={design_data:{id:a.id,title:(c==null?void 0:c.name)||"√Ålbum Personalizado",pages:i,workspace_dimensions:M,created_at:new Date().toISOString()},item_data:{id:c==null?void 0:c.id,name:(c==null?void 0:c.name)||(c==null?void 0:c.title),price:c==null?void 0:c.price,user_id:c==null?void 0:c.user_id,width:c==null?void 0:c.width,height:c==null?void 0:c.height},preset_data:{id:n==null?void 0:n.id,width:n==null?void 0:n.width,height:n==null?void 0:n.height,cover_image:n==null?void 0:n.cover_image,content_layer_image:n==null?void 0:n.content_layer_image,final_layer_image:n==null?void 0:n.final_layer_image},dimensions:{width_mm:(n==null?void 0:n.width)||(c==null?void 0:c.width)||210,height_mm:(n==null?void 0:n.height)||(c==null?void 0:c.height)||297,workspace_width:(M==null?void 0:M.width)||800,workspace_height:(M==null?void 0:M.height)||600}};try{const R=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:a.id,status:"ready_for_pdf",pdf_data:o,completed_at:new Date().toISOString()})});if(R.ok){const k=await R.json()}else console.warn("‚ö†Ô∏è Error marcando proyecto como completado")}catch(R){console.warn("‚ö†Ô∏è Error en marcado de completado:",R)}const r=Date.now(),l=a.id;window.currentProjectId=l,window.albumProjectId=l;let h=n.cover_image;Y&&Y["page-cover"]&&(h=Y["page-cover"]);let f=h;h&&h.startsWith("data:image/")&&h.length>1e5&&(f=n.cover_image||"/assets/img/default-album.jpg");const p={...c,project_id:l,canvas_project_id:a.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:n.width,height_mm:n.height,pages_count:i.length,workspace_dimensions:M,requires_pdf_generation:!0}},y=structuredClone(se),P=y.findIndex(R=>R.id==p.id);return P==-1?y.push({...p,quantity:1}):y[P].quantity++,Z(y),ae.success("√Ålbum agregado al carrito",{description:`${p.name} se ha a√±adido al carrito. El PDF se generar√° en el backend.`,icon:e.jsx(ua,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:y,action:"add",product:p}})),!0}catch(s){return console.error("‚ùå === ERROR EN addAlbumToCart ==="),console.error("Error completo:",s),console.error("Stack trace:",s.stack),console.error("Mensaje del error:",s.message),ae.error("Error al agregar al carrito",{description:`Error espec√≠fico: ${s.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!i||i.length===0)throw new Error("No hay p√°ginas para finalizar");const o={design_data:{pages:(k=>k.map($=>({id:$.id,type:$.type,pageNumber:$.pageNumber,layout:$.layout,cells:$.cells.map(v=>({id:v.id,elements:v.elements.map(N=>{const I={id:N.id,type:N.type,position:N.position,zIndex:N.zIndex||1};if(N.type==="image"){if(N.content.startsWith("data:image/")){const W=btoa(N.content.substring(0,100)).substring(0,20);I.content=`[BASE64_IMAGE_${W}]`,I.contentType=N.content.split(";")[0].split(":")[1],I.originalSize=N.content.length}else I.content=N.content;if(N.filters){const W=Object.entries(N.filters).filter(([J,B])=>B!==0&&B!==!1&&B!==null).reduce((J,[B,H])=>(J[B]=H,J),{});Object.keys(W).length>0&&(I.filters=W)}N.mask&&N.mask!=="none"&&(I.mask=N.mask),N.size&&(I.size=N.size),N.locked&&(I.locked=N.locked)}else if(N.type==="text"&&(I.content=N.content,N.style)){const W=Object.entries(N.style).filter(([J,B])=>!(J==="fontSize"&&B==="16px"||J==="color"&&B==="#000000"||J==="fontFamily"&&B==="Arial")).reduce((J,[B,H])=>(J[B]=H,J),{});Object.keys(W).length>0&&(I.style=W)}return I})}))})))(i),projectInfo:{id:a==null?void 0:a.id,item_id:c==null?void 0:c.id,title:c==null?void 0:c.title,preset_id:n==null?void 0:n.id},presetInfo:{id:n==null?void 0:n.id,name:n==null?void 0:n.name,cover_image:n==null?void 0:n.cover_image,content_image:n==null?void 0:n.content_image,back_cover_image:n==null?void 0:n.back_cover_image},workspace:{width:M.width,height:M.height,scale:M.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(Y).map(([k,$])=>[k,$]))},r=JSON.stringify(o),l=Math.round(r.length/1024),h=Math.round(l/1024*100)/100;let f=0,p=0;i.forEach(k=>{var $;($=k.cells)==null||$.forEach(v=>{var N;(N=v.elements)==null||N.forEach(I=>{I.type==="image"&&I.content&&I.content.startsWith("data:image/")&&(f++,p+=I.content.length)})})});const y=Math.round(p/(1024*1024)*100)/100;if(l>1024&&!confirm(`El dise√±o contiene ${f} im√°genes (${y} MB en im√°genes). Payload completo: ${h} MB. Esto podr√≠a causar problemas al guardarlo. ¬øDesea continuar de todos modos?`))return!1;const P=await fetch(`/api/canvas/projects/${a.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:r});if(!P.ok){let k="Error al finalizar el dise√±o";try{k=(await P.json()).message||k}catch{P.status===413?k="El dise√±o es demasiado grande para ser guardado. Intente simplificar las im√°genes.":P.status>=500&&(k="Error del servidor. Intente nuevamente m√°s tarde.")}throw new Error(k)}const R=await P.json();return!0}catch(t){console.error("Error al finalizar dise√±o:",t);let s=t.message;return t.message.includes("Failed to fetch")?s="Error de conexi√≥n. Verifique su conexi√≥n a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(s="Error de red. Intente nuevamente m√°s tarde."),alert("Error al finalizar el dise√±o: "+s),!1}};const Gs=u.useCallback(async()=>{try{const{jsPDF:t}=await Ks(async()=>{const{jsPDF:W}=await import("./jspdf.es.min-D3plwuQr.js").then(J=>J.j);return{jsPDF:W}},__vite__mapDeps([0,1,2,3,4]));let s=(n==null?void 0:n.width)||21,o=(n==null?void 0:n.height)||29.7;const r=.3,l=s+r*2,h=o+r*2,f=l*28.35,p=h*28.35,y=new t({orientation:f>p?"landscape":"portrait",unit:"pt",format:[f,p],compress:!1}),P=i.length;let R=0;const k=document.createElement("div");k.id="pdf-progress",k.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",k.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${P} p√°ginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(k);const $=W=>{const J=W/P*100;document.getElementById("pdf-progress-bar").style.width=`${J}%`,document.getElementById("current-page").textContent=W},v=g;for(let W=0;W<i.length;W++){const J=i[W];D(W),await new Promise(B=>setTimeout(B,500));try{const B=await be({type:"pdf"});if(B){const H=B.width/B.height,ye=f/p;let ie,le,fe=0,Ce=0;H>ye?(ie=f,le=f/H,Ce=(p-le)/2):(le=p,ie=p*H,fe=(f-ie)/2);const ke=B.toDataURL("image/png",1);W>0&&y.addPage([f,p]),y.addImage(ke,"PNG",fe,Ce,ie,le)}else console.warn(`‚ö†Ô∏è No se pudo capturar la p√°gina ${W+1}`),W>0&&y.addPage([f,p]),y.setFontSize(12),y.text(`Error al renderizar p√°gina ${W+1}`,f/2,p/2,{align:"center"})}catch(B){console.error(`‚ùå Error procesando p√°gina ${W+1}:`,B),W>0&&y.addPage([f,p]),y.setFontSize(12),y.text(`Error al procesar p√°gina ${W+1}`,f/2,p/2,{align:"center"})}R++,$(R),await new Promise(B=>setTimeout(B,200))}D(v);const N=`${(c==null?void 0:c.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;y.save(N),document.body.removeChild(k);const I=document.createElement("div");return I.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",I.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${N}</span>
                </div>
            `,document.body.appendChild(I),setTimeout(()=>{document.body.contains(I)&&document.body.removeChild(I)},5e3),N}catch(t){console.error("‚ùå Error generando PDF:",t);const s=document.getElementById("pdf-progress");s&&document.body.removeChild(s);const o=document.createElement("div");throw o.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",o.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(o),setTimeout(()=>{document.body.contains(o)&&document.body.removeChild(o)},7e3),t}},[i,g,D,be,n,c]);return window.generateAlbumPDF=Gs,window.generateHighQualityThumbnail=As,window.captureCurrentWorkspace=be,e.jsxs(Xs,{backend:Js,className:"!h-screen !w-screen overflow-hidden",children:[T?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu √°lbum personalizado..."})]})}):E?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:E}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):i.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando p√°ginas del √°lbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx(ra,{isOpen:Is,onRequestClose:()=>mt(!1),pages:i.map(t=>({...t,layout:re.find(s=>s.id===t.layout)||re[0]})),workspaceDimensions:M,getCurrentLayout:t=>t?re.find(s=>s.id===t.layout)||re[0]:re[0],presetData:n,pageThumbnails:Y,addAlbumToCart:Hs,projectData:a,itemData:c}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(ca,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Ws,disabled:de<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(Ys,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:Bs,disabled:de>=pe.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(Zs,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(a==null?void 0:a.name)||"√Ålbum Sin T√≠tulo",onChange:t=>d({...a,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del dise√±o"})}),e.jsxs("div",{className:"flex items-center gap-4",children:[(O.length>0||F)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",O.length]})]})}),e.jsx(_a,{saveStatus:xe.saveStatus,lastSaved:xe.lastSaved,lastAutoSaved:xe.lastAutoSaved,hasUnsavedChanges:V.hasUnsavedChanges||_.has(g),isOnline:xe.isOnline,saveError:xe.saveError,onManualSave:Ls,saveQueueSize:O.length,isProcessingQueue:F,pageChangesCount:_.size}),O.length>0&&e.jsxs("button",{onClick:()=>{console.log("üîß [DEBUG] Procesando cola manualmente"),Xe()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(js,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsxs("div",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:["P",g,": ",_.has(g)?"üî¥":"üü¢"]}),e.jsx("button",{onClick:()=>{console.log("üîß [DEBUG] Marcando p√°gina actual como modificada"),L(t=>{const s=new Map(t);return s.set(g,Date.now()),s})},className:"text-xs text-white bg-green-500 hover:bg-green-600 px-2 py-1 rounded",children:"Marcar Modificada"}),e.jsx(us,{variant:"secondary",size:"sm",onClick:()=>mt(!0),icon:e.jsx(ot,{className:"h-4 w-4"}),children:"Vista de √Ålbum"}),e.jsx("div",{className:"relative",children:e.jsx("button",{className:"h-8 w-8 rounded-full bg-[#af5cb8] flex items-center justify-center text-white font-medium",children:e.jsx(da,{className:"h-4 w-4"})})})]})]})}),e.jsxs("div",{className:`flex h-full ${G?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{onClick:()=>ee("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${z==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(ot,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"P√°ginas"})]}),e.jsxs("button",{onClick:()=>ee("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${z==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(rt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Dise√±os"})]}),e.jsxs("button",{onClick:()=>ee("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${z==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ve,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{onClick:()=>ee("images"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${z==="images"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(je,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Imagenes"})]}),e.jsxs("button",{onClick:()=>ee("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${z==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(ys,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]}),e.jsxs("button",{onClick:()=>ee("shapes"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${z==="shapes"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(wa,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Formas"})]}),e.jsxs("button",{onClick:()=>ee("stickers"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${z==="stickers"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ea,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Stickers"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[z==="templates"&&"Templates",z==="images"&&"Images",z==="text"&&"Text",z==="shapes"&&"Shapes",z==="stickers"&&"Stickers",z==="pages"&&"Pages",z==="panel"&&"Layers Panel"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[z==="templates"&&"Choose a template to get started",z==="images"&&"Search for images",z==="text"&&"Add and edit text",z==="shapes"&&"Add shapes and graphics",z==="stickers"&&"Add fun stickers",z==="pages"&&"Manage your pages",z==="panel"&&"Organize layers and z-index"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(ba,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[z==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(rt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Ca,{currentLayoutId:(Ct=i[g])==null?void 0:Ct.layout,onLayoutChange:Vs})]}),z==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(je,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Im√°genes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[Pe.length," imagen",Pe.length!==1?"s":""]})]}),e.jsx(za,{images:Pe,onImageSelect:_s,isLoading:He})]}),z==="text"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>De("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"T√≠tulo Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Ue,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>De("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subt√≠tulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Ue,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>De("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Ue,{className:"h-4 w-4"})})]})})]}),z==="text"&&G&&((kt=Q())==null?void 0:kt.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(va,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=Q();oe(C,G,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((Pt=(At=Q())==null?void 0:At.style)==null?void 0:Pt.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=Q();oe(C,G,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((Tt=(It=Q())==null?void 0:It.style)==null?void 0:Tt.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=Q();oe(C,G,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((Rt=(Ot=Q())==null?void 0:Ot.style)==null?void 0:Rt.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipograf√≠a:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:(($t=(Mt=Q())==null?void 0:Mt.style)==null?void 0:$t.fontFamily)||"Arial",onChange:t=>{const s=Q();oe(C,G,{style:{...s.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tama√±o:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Lt=(_t=Q())==null?void 0:_t.style)==null?void 0:Lt.fontSize)||"16px",onChange:t=>{const s=Q();oe(C,G,{style:{...s.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Ut=(zt=Q())==null?void 0:zt.style)==null?void 0:Ut.color)||"#000000",onChange:t=>{const s=Q();oe(C,G,{style:{...s.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((Ft=(Vt=Q())==null?void 0:Vt.style)==null?void 0:Ft.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Bt=(Wt=Q())==null?void 0:Wt.style)==null?void 0:Bt.backgroundColor)||"#ffffff",onChange:t=>{const s=Q();oe(C,G,{style:{...s.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=Q();oe(C,G,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"üö´"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var s,o;return e.jsxs("button",{onClick:()=>{const r=Q();oe(C,G,{style:{...r.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((o=(s=Q())==null?void 0:s.style)==null?void 0:o.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"‚¨Ö",t==="center"&&"‚¨å",t==="right"&&"‚û°",t==="justify"&&"‚¨ç"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Gt=(Ht=Q())==null?void 0:Ht.style)==null?void 0:Gt.lineHeight)||"1.5",onChange:t=>{const s=Q();oe(C,G,{style:{...s.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Kt=(qt=Q())==null?void 0:qt.style)==null?void 0:Kt.letterSpacing)||"normal",onChange:t=>{const s=Q();oe(C,G,{style:{...s.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=Q();oe(C,G,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Xt=(Qt=Q())==null?void 0:Qt.style)==null?void 0:Xt.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAY√öS"]}),e.jsxs("button",{onClick:()=>{const t=Q();oe(C,G,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Yt=(Jt=Q())==null?void 0:Jt.style)==null?void 0:Yt.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"min√∫s"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((Dt=(Zt=Q())==null?void 0:Zt.style)==null?void 0:Dt.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((ts=(es=Q())==null?void 0:es.style)==null?void 0:ts.opacity)||"1",onChange:t=>{const s=Q();oe(C,G,{style:{...s.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((as=(ss=Q())==null?void 0:ss.style)==null?void 0:as.opacity)||1)*100}%, #e5e7eb ${(((rs=(os=Q())==null?void 0:os.style)==null?void 0:rs.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),z==="shapes"&&e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"grid grid-cols-3 gap-3",children:Array.from({length:9}).map((t,s)=>e.jsx("button",{className:"aspect-square bg-gray-50 border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-[#af5cb8] rounded-lg"})},s))})}),z==="stickers"&&e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((t,s)=>e.jsx("button",{className:"aspect-square bg-gray-50 border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-[#f6a4b2] rounded-full"})},s))})}),z==="pages"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ot,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[i.length," total"]})]}),i.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando p√°ginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),Ye.cover.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${g===i.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>Je(i.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(nt,{pageId:t.id,thumbnail:Y[t.id],altText:"Cover",type:"cover"}),_.has(i.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:Ye.content.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${g===i.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>Je(i.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(nt,{pageId:t.id,thumbnail:Y[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),_.has(i.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),Ye.final.map((t,s)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                ${g===i.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                mb-2`,onClick:()=>Je(i.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(nt,{pageId:t.id,thumbnail:Y[t.id],altText:"Back Cover",type:"final"}),_.has(i.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),z==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Sa,{pages:i,currentPage:g,selectedCell:C,selectedElement:G,onSelectCell:K,onSelectElement:ce,onUpdateElement:(t,s,o)=>{oe(t,s,o)},onDeleteElement:(t,s)=>{Ze(t,s)},onMoveElement:(t,s,o)=>{Fs(t,s,o)}})}),z==="filters"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ga,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=Q();return t?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(je,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(ka,{selectedMask:t.mask||"none",onSelect:s=>{oe(C,G,{mask:s})},availableMasks:vs.map(s=>s.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(Ds,{filters:t.filters||{},onFilterChange:s=>{oe(C,G,{filters:s})},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(je,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an element"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Choose an image or text element to apply filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>ee("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(rt,{className:"h-4 w-4"}),"Dise√±o de p√°gina"]}),e.jsxs("button",{onClick:()=>ee("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Ve,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(us,{variant:"ghost",tooltip:"A√±adir Imagen",onClick:()=>Qe.current&&Qe.current.click(),children:e.jsx(je,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:Qe,onChange:Ms,className:"hidden",accept:"image/*"})]})]})})}),e.jsx("div",{className:"flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100",children:Cs?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:M.width,height:M.height},children:e.jsx("div",{id:`page-${i[g].id}`,className:`grid ${we().template} gap-6`,style:{width:"100%",height:"100%"},children:i[g].cells.map((t,s)=>{var o;return e.jsx(hs,{id:t.id,elements:t.elements.filter(r=>!r.locked),workspaceSize:M,cellStyle:(o=we().cellStyles)==null?void 0:o[i[g].cells.indexOf(t)],selectedElement:C===t.id?G:null,onSelectElement:jt,onAddElement:(r,l)=>Oe(l,r),onUpdateElement:(r,l,h)=>oe(t.id,r,l,h),onDeleteElement:r=>Ze(t.id,r),availableMasks:we().maskCategories.flatMap(r=>r.masks),projectData:a},t.id)})})})}):e.jsxs("div",{id:`page-${i[g].id}`,className:" shadow-xl overflow-hidden",style:{width:M.width,height:M.height,position:"relative",backgroundColor:((ns=i[g])==null?void 0:ns.backgroundColor)||"#ffffff",backgroundImage:(is=i[g])!=null&&is.backgroundImage?`url(${i[g].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=i[g];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${we().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((ls=we().style)==null?void 0:ls.gap)||"16px",padding:((cs=we().style)==null?void 0:cs.padding)||"16px"},children:i[g].cells.map(t=>{var s;return e.jsx(hs,{id:t.id,elements:t.elements.filter(o=>!o.locked),workspaceSize:M,cellStyle:(s=we().cellStyles)==null?void 0:s[i[g].cells.indexOf(t)],selectedElement:C===t.id?G:null,onSelectElement:jt,onAddElement:(o,r)=>Oe(r,o),onUpdateElement:(o,r,l)=>oe(t.id,o,r,l),onDeleteElement:o=>Ze(t.id,o),availableMasks:we().maskCategories.flatMap(o=>o.masks),projectData:a},t.id)})})]})})]})]})]}),e.jsx(oa,{}),e.jsx(La,{isOpen:Ts,onClose:()=>pt(!1),savedProgress:Os,onLoadProgress:zs,onDiscardProgress:Us})]})}export{Vo as default};
