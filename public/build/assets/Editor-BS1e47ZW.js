const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as Cn}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as b,R as Gt}from"./index-BH53Isel.js";import{T as Tn,l as ce,i as Nn,D as co,H as uo,U as go,R as ho,B as pt,F as mo,E as dn}from"./EditableCell-upyYeQZg.js";import{h as un}from"./thumbnailGenerator-B4goYG9Y.js";import{g as ft,B as yt}from"./dom-to-image-more.min-CtP51zX5.js";import{L as Ct}from"./layers-6oegOx-p.js";import{C as po}from"./chevron-down-DS-mdh9v.js";import{C as fo}from"./chevron-right-Ckt5D2ka.js";import{E as bo}from"./eye-CKCH9ORv.js";import{c as Ie}from"./createLucideIcon-Cy5Ya80P.js";import{T as Sn}from"./trash-2-DK1wnsDn.js";import{S as xo}from"./star-wPQTHY_n.js";import{I as De}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as ae,T as wo}from"./index-BZYhE2TF.js";import{m as gn}from"./main-6DCdASTx.js";import{B as vo}from"./V1Edit-CK-6qWWx.js";import{G as hn}from"./Global-D6eBBAMK.js";import{S as jn}from"./save-BvSyoVHO.js";import{C as yo}from"./clock-BTrEpQej.js";import{T as Eo}from"./triangle-alert-vFMqKi4t.js";import{C as Co}from"./check-DQ7QoS0v.js";import{L as To}from"./loader-circle-CrvBvIt1.js";import{C as No}from"./chevron-left-B2s3ZsB7.js";import{P as Et}from"./plus-Bot15Khs.js";import{F as So}from"./filter-Ci9tsc_e.js";import{C as jo}from"./copy-6OEekgvq.js";import{C as ko}from"./circle-check-big-D6DM3vPb.js";import{u as Ao}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _o=Ie("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Io=Ie("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ro=Ie("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Po=Ie("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oo=Ie("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lo=Ie("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=Ie("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mo=Ie("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $o=Ie("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mn=Ie("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fo=Ie("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Bo=({pages:t,currentPage:n,selectedCell:s,selectedElement:h,onSelectCell:i,onSelectElement:f,onUpdateElement:T,onDeleteElement:N,onMoveElement:v})=>{var O;if(!t||!t[n])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ct,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const y=t[n],I=((O=y==null?void 0:y.cells)==null?void 0:O.filter(R=>R.elements&&R.elements.length>0))||[],[j,w]=b.useState(()=>{const R={};return I.forEach($=>{R[$.id]=!0}),R}),C=R=>{w($=>({...$,[R]:!$[R]}))},S=R=>{switch(R){case"image":return e.jsx(De,{className:"h-4 w-4"});case"text":return e.jsx(Tn,{className:"h-4 w-4"});case"shape":return e.jsx($o,{className:"h-4 w-4"});case"sticker":return e.jsx(xo,{className:"h-4 w-4"});default:return e.jsx(Po,{className:"h-4 w-4"})}},P=(R,$)=>{switch(R.type){case"text":return R.content?R.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${$+1}`;case"shape":return R.shape||"Shape";case"sticker":return`Sticker ${$+1}`;default:return`Element ${$+1}`}},k=(R,$,J)=>{T(R,$,{visible:J})},B=(R,$)=>{i(R),f($)};return e.jsx("div",{className:"space-y-2",children:I.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ct,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):I.map(R=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${s===R.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{C(R.id),i(R.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:j[R.id]?e.jsx(po,{className:"h-4 w-4"}):e.jsx(fo,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",R.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[R.elements.length," element",R.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[R.x,", ",R.y]})]}),j[R.id]&&e.jsx("div",{className:"border-t border-gray-100",children:R.elements.map(($,J)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${h===$.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>B(R.id,$.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:S($.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:P($,J)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[$.type," • Layer ",J+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:W=>{W.stopPropagation(),k(R.id,$.id,!$.visible)},className:"p-1 hover:bg-gray-200 rounded",title:$.visible?"Hide element":"Show element",children:$.visible!==!1?e.jsx(bo,{className:"h-3 w-3 text-gray-500"}):e.jsx(Lo,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:W=>{W.stopPropagation(),v(R.id,$.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:J===R.elements.length-1,children:e.jsx(Io,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:W=>{W.stopPropagation(),v(R.id,$.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:J===0,children:e.jsx(_o,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:W=>{W.stopPropagation(),N(R.id,$.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(Sn,{className:"h-3 w-3"})})]})]},$.id))})]},R.id))})};function zo({currentLayoutId:t,onLayoutChange:n}){const[s,h]=b.useState("all"),i={all:{name:"Todos",layouts:ce},hero:{name:"Hero",layouts:ce.filter(f=>f.category==="hero")},editorial:{name:"Editorial",layouts:ce.filter(f=>f.category==="editorial")},storytelling:{name:"Historia",layouts:ce.filter(f=>f.category==="storytelling")},minimal:{name:"Minimal",layouts:ce.filter(f=>f.category==="minimal")},creative:{name:"Creativo",layouts:ce.filter(f=>f.category==="creative")},classic:{name:"Clásico",layouts:ce.filter(f=>f.category==="classic")}};return Object.keys(i).filter(f=>f==="all"||i[f].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:i[s].layouts.map(f=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>n(f.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${f.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:f.cells}).map((T,N)=>{var v,y;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(y=(v=f.cellStyles)==null?void 0:v[N])!=null&&y.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},N)})}),t===f.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:f.name}),f.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:f.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[f.cells," ",f.cells===1?"celda":"celdas"]})})]})]},f.id))}),i[s].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categoría."})})]})}const Uo=({selectedMask:t,onSelect:n,availableMasks:s=[],selectedImage:h})=>{var N,v;const[i,f]=b.useState("Básicas"),T={};return Nn.forEach(y=>{T[y.category]||(T[y.category]=[]),(s.includes(y.id)||y.id==="none")&&T[y.category].push(y)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(T).slice(0,2).map(y=>T[y].length>0&&e.jsx("button",{onClick:()=>f(y),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${i===y?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:y},y))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(N=T[i])==null?void 0:N.slice(0,6).map(y=>e.jsxs("div",{onClick:()=>n(y.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${t===y.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:h!=null&&h.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:y.id==="circle"?"circle(50%)":y.id==="rounded"||y.id==="rounded-sm"?"inset(0 round 8%)":y.id==="rounded-lg"?"inset(0 round 16%)":y.id==="rounded-rect"?"inset(0 round 12%)":y.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":y.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":y.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":y.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":y.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":y.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":y.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":y.id==="frame"?"inset(10% round 10%)":y.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':y.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':y.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:h.content,alt:y.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:y.id==="circle"?"circle(50%)":y.id==="rounded"||y.id==="rounded-sm"?"inset(0 round 8%)":y.id==="rounded-lg"?"inset(0 round 16%)":y.id==="rounded-rect"?"inset(0 round 12%)":y.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":y.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":y.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":y.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":y.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":y.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":y.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":y.id==="frame"?"inset(10% round 10%)":y.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':y.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':y.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:y.name})]},y.id))}),((v=T[i])==null?void 0:v.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver más máscaras (",T[i].length-6," más)"]})]})};let Wt={},kn;function Ut(t={}){Wt={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...t}}function G(t){return t?Wt[t]:Wt}function Ho(t){kn=t}function je(){return kn}let Tt={};function bt(t,n){Tt[t]=n}function Ke(t){var n;(n=Tt[t])==null||n.call(Tt)}function Vo(){Tt={}}function xt(t,n,s,h){return(t/=h/2)<1?s/2*t*t+n:-s/2*(--t*(t-2)-1)+n}function An(t){const n='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return t.flatMap(s=>{const h=s.matches(n),i=Array.from(s.querySelectorAll(n));return[...h?[s]:[],...i]}).filter(s=>getComputedStyle(s).pointerEvents!=="none"&&qo(s))}function _n(t){if(!t||Wo(t))return;const n=G("smoothScroll"),s=t.offsetHeight>window.innerHeight;t.scrollIntoView({behavior:!n||Go(t)?"auto":"smooth",inline:"center",block:s?"start":"center"})}function Go(t){if(!t||!t.parentElement)return;const n=t.parentElement;return n.scrollHeight>n.clientHeight}function Wo(t){const n=t.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&n.right<=(window.innerWidth||document.documentElement.clientWidth)}function qo(t){return!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length)}let Nt={};function pe(t,n){Nt[t]=n}function K(t){return t?Nt[t]:Nt}function pn(){Nt={}}function Do(t,n,s,h){let i=K("__activeStagePosition");const f=i||s.getBoundingClientRect(),T=h.getBoundingClientRect(),N=xt(t,f.x,T.x-f.x,n),v=xt(t,f.y,T.y-f.y,n),y=xt(t,f.width,T.width-f.width,n),I=xt(t,f.height,T.height-f.height,n);i={x:N,y:v,width:y,height:I},Rn(i),pe("__activeStagePosition",i)}function In(t){if(!t)return;const n=t.getBoundingClientRect(),s={x:n.x,y:n.y,width:n.width,height:n.height};pe("__activeStagePosition",s),Rn(s)}function Ko(){const t=K("__activeStagePosition"),n=K("__overlaySvg");if(!t)return;if(!n){console.warn("No stage svg found.");return}const s=window.innerWidth,h=window.innerHeight;n.setAttribute("viewBox",`0 0 ${s} ${h}`)}function Jo(t){const n=Yo(t);document.body.appendChild(n),Ln(n,s=>{s.target.tagName==="path"&&Ke("overlayClick")}),pe("__overlaySvg",n)}function Rn(t){const n=K("__overlaySvg");if(!n){Jo(t);return}const s=n.firstElementChild;if((s==null?void 0:s.tagName)!=="path")throw new Error("no path element found in stage svg");s.setAttribute("d",Pn(t))}function Yo(t){const n=window.innerWidth,s=window.innerHeight,h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.classList.add("driver-overlay","driver-overlay-animated"),h.setAttribute("viewBox",`0 0 ${n} ${s}`),h.setAttribute("xmlSpace","preserve"),h.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),h.setAttribute("version","1.1"),h.setAttribute("preserveAspectRatio","xMinYMin slice"),h.style.fillRule="evenodd",h.style.clipRule="evenodd",h.style.strokeLinejoin="round",h.style.strokeMiterlimit="2",h.style.zIndex="10000",h.style.position="fixed",h.style.top="0",h.style.left="0",h.style.width="100%",h.style.height="100%";const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d",Pn(t)),i.style.fill=G("overlayColor")||"rgb(0,0,0)",i.style.opacity=`${G("overlayOpacity")}`,i.style.pointerEvents="auto",i.style.cursor="auto",h.appendChild(i),h}function Pn(t){const n=window.innerWidth,s=window.innerHeight,h=G("stagePadding")||0,i=G("stageRadius")||0,f=t.width+h*2,T=t.height+h*2,N=Math.min(i,f/2,T/2),v=Math.floor(Math.max(N,0)),y=t.x-h+v,I=t.y-h,j=f-v*2,w=T-v*2;return`M${n},0L0,0L0,${s}L${n},${s}L${n},0Z
    M${y},${I} h${j} a${v},${v} 0 0 1 ${v},${v} v${w} a${v},${v} 0 0 1 -${v},${v} h-${j} a${v},${v} 0 0 1 -${v},-${v} v-${w} a${v},${v} 0 0 1 ${v},-${v} z`}function Xo(){const t=K("__overlaySvg");t&&t.remove()}function Qo(){const t=document.getElementById("driver-dummy-element");if(t)return t;let n=document.createElement("div");return n.id="driver-dummy-element",n.style.width="0",n.style.height="0",n.style.pointerEvents="none",n.style.opacity="0",n.style.position="fixed",n.style.top="50%",n.style.left="50%",document.body.appendChild(n),n}function fn(t){const{element:n}=t;let s=typeof n=="function"?n():typeof n=="string"?document.querySelector(n):n;s||(s=Qo()),ea(s,t)}function Zo(){const t=K("__activeElement"),n=K("__activeStep");t&&(In(t),Ko(),$n(t,n))}function ea(t,n){var s;const h=Date.now(),i=K("__activeStep"),f=K("__activeElement")||t,T=!f||f===t,N=t.id==="driver-dummy-element",v=f.id==="driver-dummy-element",y=G("animate"),I=n.onHighlightStarted||G("onHighlightStarted"),j=(n==null?void 0:n.onHighlighted)||G("onHighlighted"),w=(i==null?void 0:i.onDeselected)||G("onDeselected"),C=G(),S=K();!T&&w&&w(v?void 0:f,i,{config:C,state:S,driver:je()}),I&&I(N?void 0:t,n,{config:C,state:S,driver:je()});const P=!T&&y;let k=!1;aa(),pe("previousStep",i),pe("previousElement",f),pe("activeStep",n),pe("activeElement",t);const B=()=>{if(K("__transitionCallback")!==B)return;const O=Date.now()-h,R=400-O<=400/2;n.popover&&R&&!k&&P&&(bn(t,n),k=!0),G("animate")&&O<400?Do(O,400,f,t):(In(t),j&&j(N?void 0:t,n,{config:G(),state:K(),driver:je()}),pe("__transitionCallback",void 0),pe("__previousStep",i),pe("__previousElement",f),pe("__activeStep",n),pe("__activeElement",t)),window.requestAnimationFrame(B)};pe("__transitionCallback",B),window.requestAnimationFrame(B),_n(t),!P&&n.popover&&bn(t,n),f.classList.remove("driver-active-element","driver-no-interaction"),f.removeAttribute("aria-haspopup"),f.removeAttribute("aria-expanded"),f.removeAttribute("aria-controls"),((s=n.disableActiveInteraction)!=null?s:G("disableActiveInteraction"))&&t.classList.add("driver-no-interaction"),t.classList.add("driver-active-element"),t.setAttribute("aria-haspopup","dialog"),t.setAttribute("aria-expanded","true"),t.setAttribute("aria-controls","driver-popover-content")}function ta(){var t;(t=document.getElementById("driver-dummy-element"))==null||t.remove(),document.querySelectorAll(".driver-active-element").forEach(n=>{n.classList.remove("driver-active-element","driver-no-interaction"),n.removeAttribute("aria-haspopup"),n.removeAttribute("aria-expanded"),n.removeAttribute("aria-controls")})}function st(){const t=K("__resizeTimeout");t&&window.cancelAnimationFrame(t),pe("__resizeTimeout",window.requestAnimationFrame(Zo))}function ra(t){var n;if(!K("isInitialized")||!(t.key==="Tab"||t.keyCode===9))return;const s=K("__activeElement"),h=(n=K("popover"))==null?void 0:n.wrapper,i=An([...h?[h]:[],...s?[s]:[]]),f=i[0],T=i[i.length-1];if(t.preventDefault(),t.shiftKey){const N=i[i.indexOf(document.activeElement)-1]||T;N==null||N.focus()}else{const N=i[i.indexOf(document.activeElement)+1]||f;N==null||N.focus()}}function On(t){var n;((n=G("allowKeyboardControl"))==null||n)&&(t.key==="Escape"?Ke("escapePress"):t.key==="ArrowRight"?Ke("arrowRightPress"):t.key==="ArrowLeft"&&Ke("arrowLeftPress"))}function Ln(t,n,s){const h=(i,f)=>{const T=i.target;t.contains(T)&&((!s||s(T))&&(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation()),f==null||f(i))};document.addEventListener("pointerdown",h,!0),document.addEventListener("mousedown",h,!0),document.addEventListener("pointerup",h,!0),document.addEventListener("mouseup",h,!0),document.addEventListener("click",i=>{h(i,n)},!0)}function na(){window.addEventListener("keyup",On,!1),window.addEventListener("keydown",ra,!1),window.addEventListener("resize",st),window.addEventListener("scroll",st)}function oa(){window.removeEventListener("keyup",On),window.removeEventListener("resize",st),window.removeEventListener("scroll",st)}function aa(){const t=K("popover");t&&(t.wrapper.style.display="none")}function bn(t,n){var s,h;let i=K("popover");i&&document.body.removeChild(i.wrapper),i=ia(),document.body.appendChild(i.wrapper);const{title:f,description:T,showButtons:N,disableButtons:v,showProgress:y,nextBtnText:I=G("nextBtnText")||"Next &rarr;",prevBtnText:j=G("prevBtnText")||"&larr; Previous",progressText:w=G("progressText")||"{current} of {total}"}=n.popover||{};i.nextButton.innerHTML=I,i.previousButton.innerHTML=j,i.progress.innerHTML=w,f?(i.title.innerHTML=f,i.title.style.display="block"):i.title.style.display="none",T?(i.description.innerHTML=T,i.description.style.display="block"):i.description.style.display="none";const C=N||G("showButtons"),S=y||G("showProgress")||!1,P=(C==null?void 0:C.includes("next"))||(C==null?void 0:C.includes("previous"))||S;i.closeButton.style.display=C.includes("close")?"block":"none",P?(i.footer.style.display="flex",i.progress.style.display=S?"block":"none",i.nextButton.style.display=C.includes("next")?"block":"none",i.previousButton.style.display=C.includes("previous")?"block":"none"):i.footer.style.display="none";const k=v||G("disableButtons")||[];k!=null&&k.includes("next")&&(i.nextButton.disabled=!0,i.nextButton.classList.add("driver-popover-btn-disabled")),k!=null&&k.includes("previous")&&(i.previousButton.disabled=!0,i.previousButton.classList.add("driver-popover-btn-disabled")),k!=null&&k.includes("close")&&(i.closeButton.disabled=!0,i.closeButton.classList.add("driver-popover-btn-disabled"));const B=i.wrapper;B.style.display="block",B.style.left="",B.style.top="",B.style.bottom="",B.style.right="",B.id="driver-popover-content",B.setAttribute("role","dialog"),B.setAttribute("aria-labelledby","driver-popover-title"),B.setAttribute("aria-describedby","driver-popover-description");const O=i.arrow;O.className="driver-popover-arrow";const R=((s=n.popover)==null?void 0:s.popoverClass)||G("popoverClass")||"";B.className=`driver-popover ${R}`.trim(),Ln(i.wrapper,ne=>{var ue,ye,c;const ee=ne.target,x=((ue=n.popover)==null?void 0:ue.onNextClick)||G("onNextClick"),Q=((ye=n.popover)==null?void 0:ye.onPrevClick)||G("onPrevClick"),ie=((c=n.popover)==null?void 0:c.onCloseClick)||G("onCloseClick");if(ee.closest(".driver-popover-next-btn"))return x?x(t,n,{config:G(),state:K(),driver:je()}):Ke("nextClick");if(ee.closest(".driver-popover-prev-btn"))return Q?Q(t,n,{config:G(),state:K(),driver:je()}):Ke("prevClick");if(ee.closest(".driver-popover-close-btn"))return ie?ie(t,n,{config:G(),state:K(),driver:je()}):Ke("closeClick")},ne=>!(i!=null&&i.description.contains(ne))&&!(i!=null&&i.title.contains(ne))&&typeof ne.className=="string"&&ne.className.includes("driver-popover")),pe("popover",i);const $=((h=n.popover)==null?void 0:h.onPopoverRender)||G("onPopoverRender");$&&$(i,{config:G(),state:K(),driver:je()}),$n(t,n),_n(B);const J=t.classList.contains("driver-dummy-element"),W=An([B,...J?[]:[t]]);W.length>0&&W[0].focus()}function Mn(){const t=K("popover");if(!(t!=null&&t.wrapper))return;const n=t.wrapper.getBoundingClientRect(),s=G("stagePadding")||0,h=G("popoverOffset")||0;return{width:n.width+s+h,height:n.height+s+h,realWidth:n.width,realHeight:n.height}}function xn(t,n){const{elementDimensions:s,popoverDimensions:h,popoverPadding:i,popoverArrowDimensions:f}=n;return t==="start"?Math.max(Math.min(s.top-i,window.innerHeight-h.realHeight-f.width),f.width):t==="end"?Math.max(Math.min(s.top-(h==null?void 0:h.realHeight)+s.height+i,window.innerHeight-(h==null?void 0:h.realHeight)-f.width),f.width):t==="center"?Math.max(Math.min(s.top+s.height/2-(h==null?void 0:h.realHeight)/2,window.innerHeight-(h==null?void 0:h.realHeight)-f.width),f.width):0}function wn(t,n){const{elementDimensions:s,popoverDimensions:h,popoverPadding:i,popoverArrowDimensions:f}=n;return t==="start"?Math.max(Math.min(s.left-i,window.innerWidth-h.realWidth-f.width),f.width):t==="end"?Math.max(Math.min(s.left-(h==null?void 0:h.realWidth)+s.width+i,window.innerWidth-(h==null?void 0:h.realWidth)-f.width),f.width):t==="center"?Math.max(Math.min(s.left+s.width/2-(h==null?void 0:h.realWidth)/2,window.innerWidth-(h==null?void 0:h.realWidth)-f.width),f.width):0}function $n(t,n){const s=K("popover");if(!s)return;const{align:h="start",side:i="left"}=(n==null?void 0:n.popover)||{},f=h,T=t.id==="driver-dummy-element"?"over":i,N=G("stagePadding")||0,v=Mn(),y=s.arrow.getBoundingClientRect(),I=t.getBoundingClientRect(),j=I.top-v.height;let w=j>=0;const C=window.innerHeight-(I.bottom+v.height);let S=C>=0;const P=I.left-v.width;let k=P>=0;const B=window.innerWidth-(I.right+v.width);let O=B>=0;const R=!w&&!S&&!k&&!O;let $=T;if(T==="top"&&w?O=k=S=!1:T==="bottom"&&S?O=k=w=!1:T==="left"&&k?O=w=S=!1:T==="right"&&O&&(k=w=S=!1),T==="over"){const J=window.innerWidth/2-v.realWidth/2,W=window.innerHeight/2-v.realHeight/2;s.wrapper.style.left=`${J}px`,s.wrapper.style.right="auto",s.wrapper.style.top=`${W}px`,s.wrapper.style.bottom="auto"}else if(R){const J=window.innerWidth/2-(v==null?void 0:v.realWidth)/2,W=10;s.wrapper.style.left=`${J}px`,s.wrapper.style.right="auto",s.wrapper.style.bottom=`${W}px`,s.wrapper.style.top="auto"}else if(k){const J=Math.min(P,window.innerWidth-(v==null?void 0:v.realWidth)-y.width),W=xn(f,{elementDimensions:I,popoverDimensions:v,popoverPadding:N,popoverArrowDimensions:y});s.wrapper.style.left=`${J}px`,s.wrapper.style.top=`${W}px`,s.wrapper.style.bottom="auto",s.wrapper.style.right="auto",$="left"}else if(O){const J=Math.min(B,window.innerWidth-(v==null?void 0:v.realWidth)-y.width),W=xn(f,{elementDimensions:I,popoverDimensions:v,popoverPadding:N,popoverArrowDimensions:y});s.wrapper.style.right=`${J}px`,s.wrapper.style.top=`${W}px`,s.wrapper.style.bottom="auto",s.wrapper.style.left="auto",$="right"}else if(w){const J=Math.min(j,window.innerHeight-v.realHeight-y.width);let W=wn(f,{elementDimensions:I,popoverDimensions:v,popoverPadding:N,popoverArrowDimensions:y});s.wrapper.style.top=`${J}px`,s.wrapper.style.left=`${W}px`,s.wrapper.style.bottom="auto",s.wrapper.style.right="auto",$="top"}else if(S){const J=Math.min(C,window.innerHeight-(v==null?void 0:v.realHeight)-y.width);let W=wn(f,{elementDimensions:I,popoverDimensions:v,popoverPadding:N,popoverArrowDimensions:y});s.wrapper.style.left=`${W}px`,s.wrapper.style.bottom=`${J}px`,s.wrapper.style.top="auto",s.wrapper.style.right="auto",$="bottom"}R?s.arrow.classList.add("driver-popover-arrow-none"):sa(f,$,t)}function sa(t,n,s){const h=K("popover");if(!h)return;const i=s.getBoundingClientRect(),f=Mn(),T=h.arrow,N=f.width,v=window.innerWidth,y=i.width,I=i.left,j=f.height,w=window.innerHeight,C=i.top,S=i.height;T.className="driver-popover-arrow";let P=n,k=t;if(n==="top"?(I+y<=0?(P="right",k="end"):I+y-N<=0&&(P="top",k="start"),I>=v?(P="left",k="end"):I+N>=v&&(P="top",k="end")):n==="bottom"?(I+y<=0?(P="right",k="start"):I+y-N<=0&&(P="bottom",k="start"),I>=v?(P="left",k="start"):I+N>=v&&(P="bottom",k="end")):n==="left"?(C+S<=0?(P="bottom",k="end"):C+S-j<=0&&(P="left",k="start"),C>=w?(P="top",k="end"):C+j>=w&&(P="left",k="end")):n==="right"&&(C+S<=0?(P="bottom",k="start"):C+S-j<=0&&(P="right",k="start"),C>=w?(P="top",k="start"):C+j>=w&&(P="right",k="end")),!P)T.classList.add("driver-popover-arrow-none");else{T.classList.add(`driver-popover-arrow-side-${P}`),T.classList.add(`driver-popover-arrow-align-${k}`);const B=s.getBoundingClientRect(),O=T.getBoundingClientRect(),R=G("stagePadding")||0,$=B.left-R<window.innerWidth&&B.right+R>0&&B.top-R<window.innerHeight&&B.bottom+R>0;n==="bottom"&&$&&(O.x>B.x&&O.x+O.width<B.x+B.width?h.wrapper.style.transform="translateY(0)":(T.classList.remove(`driver-popover-arrow-align-${k}`),T.classList.add("driver-popover-arrow-none"),h.wrapper.style.transform=`translateY(-${R/2}px)`))}}function ia(){const t=document.createElement("div");t.classList.add("driver-popover");const n=document.createElement("div");n.classList.add("driver-popover-arrow");const s=document.createElement("header");s.id="driver-popover-title",s.classList.add("driver-popover-title"),s.style.display="none",s.innerText="Popover Title";const h=document.createElement("div");h.id="driver-popover-description",h.classList.add("driver-popover-description"),h.style.display="none",h.innerText="Popover description is here";const i=document.createElement("button");i.type="button",i.classList.add("driver-popover-close-btn"),i.setAttribute("aria-label","Close"),i.innerHTML="&times;";const f=document.createElement("footer");f.classList.add("driver-popover-footer");const T=document.createElement("span");T.classList.add("driver-popover-progress-text"),T.innerText="";const N=document.createElement("span");N.classList.add("driver-popover-navigation-btns");const v=document.createElement("button");v.type="button",v.classList.add("driver-popover-prev-btn"),v.innerHTML="&larr; Previous";const y=document.createElement("button");return y.type="button",y.classList.add("driver-popover-next-btn"),y.innerHTML="Next &rarr;",N.appendChild(v),N.appendChild(y),f.appendChild(T),f.appendChild(N),t.appendChild(i),t.appendChild(n),t.appendChild(s),t.appendChild(h),t.appendChild(f),{wrapper:t,arrow:n,title:s,description:h,footer:f,previousButton:v,nextButton:y,closeButton:i,footerButtons:N,progress:T}}function la(){var t;const n=K("popover");n&&((t=n.wrapper.parentElement)==null||t.removeChild(n.wrapper))}function ca(t={}){Ut(t);function n(){G("allowClose")&&I()}function s(){const w=G("overlayClickBehavior");if(G("allowClose")&&w==="close"){I();return}w==="nextStep"&&h()}function h(){const w=K("activeIndex"),C=G("steps")||[];if(typeof w>"u")return;const S=w+1;C[S]?y(S):I()}function i(){const w=K("activeIndex"),C=G("steps")||[];if(typeof w>"u")return;const S=w-1;C[S]?y(S):I()}function f(w){(G("steps")||[])[w]?y(w):I()}function T(){var w;if(K("__transitionCallback"))return;const C=K("activeIndex"),S=K("__activeStep"),P=K("__activeElement");if(typeof C>"u"||typeof S>"u"||typeof K("activeIndex")>"u")return;const k=((w=S.popover)==null?void 0:w.onPrevClick)||G("onPrevClick");if(k)return k(P,S,{config:G(),state:K(),driver:je()});i()}function N(){var w;if(K("__transitionCallback"))return;const C=K("activeIndex"),S=K("__activeStep"),P=K("__activeElement");if(typeof C>"u"||typeof S>"u")return;const k=((w=S.popover)==null?void 0:w.onNextClick)||G("onNextClick");if(k)return k(P,S,{config:G(),state:K(),driver:je()});h()}function v(){K("isInitialized")||(pe("isInitialized",!0),document.body.classList.add("driver-active",G("animate")?"driver-fade":"driver-simple"),na(),bt("overlayClick",s),bt("escapePress",n),bt("arrowLeftPress",T),bt("arrowRightPress",N))}function y(w=0){var C,S,P,k,B,O,R,$;const J=G("steps");if(!J){console.error("No steps to drive through"),I();return}if(!J[w]){I();return}pe("__activeOnDestroyed",document.activeElement),pe("activeIndex",w);const W=J[w],ne=J[w+1],ue=J[w-1],ye=((C=W.popover)==null?void 0:C.doneBtnText)||G("doneBtnText")||"Done",c=G("allowClose"),ee=typeof((S=W.popover)==null?void 0:S.showProgress)<"u"?(P=W.popover)==null?void 0:P.showProgress:G("showProgress"),x=(((k=W.popover)==null?void 0:k.progressText)||G("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${w+1}`).replace("{{total}}",`${J.length}`),Q=((B=W.popover)==null?void 0:B.showButtons)||G("showButtons"),ie=["next","previous",...c?["close"]:[]].filter(q=>!(Q!=null&&Q.length)||Q.includes(q)),Se=((O=W.popover)==null?void 0:O.onNextClick)||G("onNextClick"),z=((R=W.popover)==null?void 0:R.onPrevClick)||G("onPrevClick"),Z=(($=W.popover)==null?void 0:$.onCloseClick)||G("onCloseClick");fn({...W,popover:{showButtons:ie,nextBtnText:ne?void 0:ye,disableButtons:[...ue?[]:["previous"]],showProgress:ee,progressText:x,onNextClick:Se||(()=>{ne?y(w+1):I()}),onPrevClick:z||(()=>{y(w-1)}),onCloseClick:Z||(()=>{I()}),...(W==null?void 0:W.popover)||{}}})}function I(w=!0){const C=K("__activeElement"),S=K("__activeStep"),P=K("__activeOnDestroyed"),k=G("onDestroyStarted");if(w&&k){const R=!C||(C==null?void 0:C.id)==="driver-dummy-element";k(R?void 0:C,S,{config:G(),state:K(),driver:je()});return}const B=(S==null?void 0:S.onDeselected)||G("onDeselected"),O=G("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),oa(),la(),ta(),Xo(),Vo(),pn(),C&&S){const R=C.id==="driver-dummy-element";B&&B(R?void 0:C,S,{config:G(),state:K(),driver:je()}),O&&O(R?void 0:C,S,{config:G(),state:K(),driver:je()})}P&&P.focus()}const j={isActive:()=>K("isInitialized")||!1,refresh:st,drive:(w=0)=>{v(),y(w)},setConfig:Ut,setSteps:w=>{pn(),Ut({...G(),steps:w})},getConfig:G,getState:K,getActiveIndex:()=>K("activeIndex"),isFirstStep:()=>K("activeIndex")===0,isLastStep:()=>{const w=G("steps")||[],C=K("activeIndex");return C!==void 0&&C===w.length-1},getActiveStep:()=>K("activeStep"),getActiveElement:()=>K("activeElement"),getPreviousElement:()=>K("previousElement"),getPreviousStep:()=>K("previousStep"),moveNext:h,movePrevious:i,moveTo:f,hasNextStep:()=>{const w=G("steps")||[],C=K("activeIndex");return C!==void 0&&!!w[C+1]},hasPreviousStep:()=>{const w=G("steps")||[],C=K("activeIndex");return C!==void 0&&!!w[C-1]},highlight:w=>{v(),fn({...w,popover:w.popover?{showButtons:[],showProgress:!1,progressText:"",...w.popover}:void 0})},destroy:()=>{I(!1)}};return Ho(j),j}const Be=new Map,ze=new Map;function da(t){if(typeof document>"u"||document.getElementById("filter-emergency-button-"+t))return;console.log(`🚨 [EMERGENCIA] Creando botón específico para página ${t}`);const n=document.createElement("button");n.id="filter-emergency-button-"+t,n.innerText="🎨 Regenerar filtros",n.style.cssText=`
        position: fixed;
        bottom: 70px;
        right: 20px;
        background: linear-gradient(135deg, #8844ee 0%, #6366f1 100%);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 12px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.2s ease;
    `,n.onmouseover=()=>{n.style.transform="translateY(-2px)",n.style.boxShadow="0 6px 16px rgba(0,0,0,0.25)"},n.onmouseout=()=>{n.style.transform="translateY(0)",n.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)"},n.onclick=()=>{n.style.transform="scale(0.95)",setTimeout(()=>n.style.transform="scale(1)",150),n.innerText="⚙️ Regenerando...",window.FORCE_FILTER_APPLICATION=!0,window.PRESERVE_FILTERS_FOR_PAGE=t,ze.has(`${t}-300x300`)&&ze.delete(`${t}-300x300`),setTimeout(()=>{try{console.log(`🔄 [EMERGENCIA-FILTROS] Regenerando miniatura para página ${t}`),typeof window.regenerateCurrentThumbnailNow=="function"?window.regenerateCurrentThumbnailNow():typeof window.forceRegenerateThumbnail=="function"&&window.forceRegenerateThumbnail();const s=Date.now();window._lastFilterRegeneration=s,setTimeout(()=>{n.innerText="✅ ¡Filtros aplicados!",setTimeout(()=>{n.innerText="🎨 Regenerar filtros",setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1,window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},2e3)},500)}catch(s){console.error("❌ [EMERGENCIA-FILTROS] Error regenerando miniatura:",s),n.innerText="❌ Error",setTimeout(()=>{n.innerText="🎨 Regenerar filtros"},2e3)}},100)},document.body.appendChild(n)}function ua(t,n,s,h,i,f){if(!n||!n.type)return;console.log("🎭 [Mask] Aplicando máscara:",n.type),t.save(),t.beginPath();const T=s+i/2,N=h+f/2;switch(n.type){case"circle":const v=Math.min(i,f)/2;t.arc(T,N,v,0,2*Math.PI);break;case"ellipse":t.ellipse(T,N,i/2,f/2,0,0,2*Math.PI);break;case"star":const y=5,I=Math.min(i,f)/2,j=I*.4;for(let C=0;C<y*2;C++){const S=C*Math.PI/y,P=C%2===0?I:j,k=T+Math.cos(S)*P,B=N+Math.sin(S)*P;C===0?t.moveTo(k,B):t.lineTo(k,B)}t.closePath();break;case"hexagon":const w=Math.min(i,f)/2;for(let C=0;C<6;C++){const S=C*Math.PI/3,P=T+Math.cos(S)*w,k=N+Math.sin(S)*w;C===0?t.moveTo(P,k):t.lineTo(P,k)}t.closePath();break;case"triangle":t.moveTo(T,h),t.lineTo(s,h+f),t.lineTo(s+i,h+f),t.closePath();break;default:t.rect(s,h,i,f)}t.clip()}async function Fn(t){return Be.has(t)?Be.get(t):new Promise((n,s)=>{const h=new Image;h.crossOrigin="anonymous",h.onload=()=>{Be.set(t,h),n(h)},h.onerror=()=>{console.warn(`⚠️ No se pudo cargar imagen: ${t}`),n(null)},setTimeout(()=>{Be.has(t)||(console.warn(`⏰ Timeout cargando imagen: ${t}`),n(null))},3e3),h.src=t})}function Bn(t,n,s){var S,P,k,B;const{x:h,y:i,width:f,height:T}=s,N=((S=n.position)==null?void 0:S.x)||0,v=((P=n.position)==null?void 0:P.y)||0,y=h+(N<=1?N*f:N),I=i+(v<=1?v*T:v),j=(k=n.size)!=null&&k.width?n.size.width<=1?n.size.width*f:n.size.width:f,w=(B=n.size)!=null&&B.height?n.size.height<=1?n.size.height*T:n.size.height:T,C=window.PRESERVE_FILTERS_FOR_PAGE===!0||window.PRESERVE_FILTERS_FOR_PAGE===n.pageId;if(console.log(`🎨 [FastThumbnail] Renderizando elemento ${n.id}:`,{type:n.type,hasFilters:!!n.filters,hasMask:!!n.mask,filters:n.filters,mask:n.mask,preserveFilters:C}),n.type==="image"&&n.content){const O=Be.get(n.content);if(O){if(t.save(),t.translate(y,I),n.filters){console.log("🎨 [FastThumbnail] APLICANDO FILTROS COMPLETOS:",n.filters);const c=n.filters.brightness!==void 0&&n.filters.brightness!==100||n.filters.contrast!==void 0&&n.filters.contrast!==100||n.filters.saturation!==void 0&&n.filters.saturation!==100||n.filters.tint!==void 0&&n.filters.tint!==0||n.filters.hue!==void 0&&n.filters.hue!==0||n.filters.blur!==void 0&&n.filters.blur>0||n.filters.gaussianBlur!==void 0&&n.filters.gaussianBlur>0||n.filters.opacity!==void 0&&n.filters.opacity!==100||n.filters.scale!==void 0&&n.filters.scale!==1||n.filters.rotate!==void 0&&n.filters.rotate!==0||n.filters.flipHorizontal||n.filters.flipVertical;c&&(console.log("✅ [FastThumbnail] Filtros reales detectados, aplicando..."),n._hasRealFilters=!0,n.pageId&&!window._pagesWithFilters&&(window._pagesWithFilters=new Set,window._pagesWithFilters.add(n.pageId)));const ee=`
                    brightness(${(n.filters.brightness??100)/100})
                    contrast(${(n.filters.contrast??100)/100})
                    saturate(${(n.filters.saturation??100)/100})
                    sepia(${(n.filters.tint??0)/100})
                    hue-rotate(${n.filters.hue??0}deg)
                    blur(${Math.max(n.filters.blur??0,n.filters.gaussianBlur??0)}px)
                    opacity(${(n.filters.opacity??100)/100})
                `.replace(/\s+/g," ").trim();console.log("🎨 [FastThumbnail] Filter string:",ee);const x=c||window.FORCE_FILTER_APPLICATION;if(x&&n.type==="image"&&O){console.log("🚀 [FastThumbnail] Usando método avanzado de dos pasos para filtros");try{const Q=O.width/O.height,ie=j/w;let Se=0,z=0,Z=O.width,q=O.height;Q>ie?(Z=O.height*ie,Se=(O.width-Z)/2):(q=O.width/ie,z=(O.height-q)/2);const de=document.createElement("canvas");de.width=j,de.height=w;const X=de.getContext("2d",{alpha:!0});if(X.filter=ee,X.drawImage(O,Se,z,Z,q,0,0,j,w),n.filters.scale!==1||n.filters.rotate!==0||n.filters.flipHorizontal||n.filters.flipVertical){console.log("⚙️ [FastThumbnail] Aplicando transformaciones avanzadas");const he=document.createElement("canvas");he.width=j,he.height=w;const Re=he.getContext("2d",{alpha:!0});Re.save(),Re.translate(j/2,w/2);const we=(n.filters.flipHorizontal?-1:1)*(n.filters.scale||1),ke=(n.filters.flipVertical?-1:1)*(n.filters.scale||1);Re.scale(we,ke),n.filters.rotate&&Re.rotate(n.filters.rotate*Math.PI/180),Re.drawImage(de,-j/2,-w/2),Re.restore(),t.drawImage(he,0,0)}else t.drawImage(de,0,0);console.log("✅ [FastThumbnail] Filtros aplicados exitosamente con método avanzado");return}catch(Q){console.error("⚠️ Error en método avanzado de filtros:",Q)}}else try{if(t.filter=ee,window.FORCE_FILTER_APPLICATION){console.log("🔥 [FastThumbnail] Forzando aplicación con método alternativo");const Q=t.globalAlpha;t.globalAlpha=.9999,setTimeout(()=>{t&&(t.globalAlpha=Q)},0)}}catch(Q){console.error("⚠️ Error al aplicar filtros estándar:",Q)}if(!x&&n.type==="image"&&O){const Q=n.filters.scale??1,ie=n.filters.rotate??0,Se=n.filters.flipHorizontal??!1,z=n.filters.flipVertical??!1;(Q!==1||ie!==0||Se||z)&&(console.log("⚙️ [FastThumbnail] Aplicando transformaciones estándar"),t.translate(j/2,w/2),t.scale(Q*(Se?-1:1),Q*(z?-1:1)),t.rotate(ie*Math.PI/180),t.translate(-j/2,-w/2))}}n.mask&&(console.log("🎭 [FastThumbnail] APLICANDO MÁSCARA:",n.mask),ua(t,n.mask,y,I,j,w));const R=O.width/O.height,$=j/w;let J=0,W=0,ne=O.width,ue=O.height;if(R>$?(ne=O.height*$,J=(O.width-ne)/2):(ue=O.width/$,W=(O.height-ue)/2),(n._hasRealFilters||n.filters&&window.ENABLE_ADVANCED_FILTER_RENDERING||window.FORCE_FILTER_APPLICATION)&&typeof vn=="function"){console.log("🌟 [MÉTODO ULTRA] Usando técnica especializada para garantizar filtros");try{const c=document.createElement("canvas");c.width=j,c.height=w,c.getContext("2d",{alpha:!0}).drawImage(O,J,W,ne,ue,0,0,j,w);const x=vn(c,n.filters,j,w);t.drawImage(x,0,0,j,w),console.log("✅ [FastThumbnail] Imagen procesada con método ultra garantizado"),window._successfulFilterRenderings||(window._successfulFilterRenderings={}),n.id&&(window._successfulFilterRenderings[n.id]={timestamp:Date.now(),method:"ultra",hasRealFilters:!!n._hasRealFilters})}catch(c){console.error("⚠️ Error en método ultra avanzado, usando fallback:",c);const ee=document.createElement("canvas");ee.width=j,ee.height=w;const x=ee.getContext("2d",{alpha:!0});if(t.filter)try{x.filter=t.filter}catch(Q){console.warn("⚠️ Error copiando filtros al canvas temporal:",Q)}x.drawImage(O,J,W,ne,ue,0,0,j,w),t.drawImage(ee,0,0),console.log("🔄 [FastThumbnail] Imagen procesada con método de fallback")}}else t.drawImage(O,J,W,ne,ue,0,0,j,w),console.log("🖼️ [FastThumbnail] Imagen dibujada con método estándar");t.restore()}}else if(n.type==="text"&&n.content){t.save();const O=n.style||{},R=Math.max(8,parseInt(O.fontSize)||16),$=O.color||"#000000";t.font=`${R}px Arial, sans-serif`,t.fillStyle=$,t.textBaseline="top";let J=n.content.split(`
`)[0]||"";J.length>50&&(J=J.substring(0,50)+"..."),t.fillText(J,y+4,I+4),t.restore()}}function vn(t,n,s,h){if(console.log("🔥 [FilterHelper] Aplicando filtros avanzados a imagen:",{sourceImgWidth:t.width,sourceImgHeight:t.height,targetWidth:s,targetHeight:h,filters:n}),!(n&&(n.brightness!==void 0&&n.brightness!==100||n.contrast!==void 0&&n.contrast!==100||n.saturation!==void 0&&n.saturation!==100||n.tint!==void 0&&n.tint!==0||n.hue!==void 0&&n.hue!==0||n.blur!==void 0&&n.blur>0||n.gaussianBlur!==void 0&&n.gaussianBlur>0||n.opacity!==void 0&&n.opacity!==100||n.scale!==void 0&&n.scale!==1||n.rotate!==void 0&&n.rotate!==0||n.flipHorizontal||n.flipVertical))&&!window.FORCE_FILTER_APPLICATION){console.log("⏩ [FilterHelper] No hay filtros reales que aplicar, retornando imagen simple");const v=document.createElement("canvas");return v.width=s,v.height=h,v.getContext("2d").drawImage(t,0,0,s,h),v}const f=document.createElement("canvas");f.width=s,f.height=h;const T=f.getContext("2d",{alpha:!0}),N=`
        brightness(${((n==null?void 0:n.brightness)??100)/100})
        contrast(${((n==null?void 0:n.contrast)??100)/100})
        saturate(${((n==null?void 0:n.saturation)??100)/100})
        sepia(${((n==null?void 0:n.tint)??0)/100})
        hue-rotate(${(n==null?void 0:n.hue)??0}deg)
        blur(${Math.max((n==null?void 0:n.blur)??0,(n==null?void 0:n.gaussianBlur)??0)}px)
        opacity(${((n==null?void 0:n.opacity)??100)/100})
    `.replace(/\s+/g," ").trim();console.log("🎨 [FilterHelper] Aplicando filtro CSS:",N);try{T.filter=N}catch(v){console.error("⚠️ Error aplicando filtros CSS:",v)}if(T.drawImage(t,0,0,s,h),n&&(n.scale!==void 0&&n.scale!==1||n.rotate!==void 0&&n.rotate!==0||n.flipHorizontal||n.flipVertical)){console.log("🔄 [FilterHelper] Aplicando transformaciones:",{scale:n.scale,rotate:n.rotate,flipH:n.flipHorizontal,flipV:n.flipVertical});const v=document.createElement("canvas");v.width=s,v.height=h;const y=v.getContext("2d",{alpha:!0});y.save(),y.translate(s/2,h/2);const I=(n.flipHorizontal?-1:1)*(n.scale??1),j=(n.flipVertical?-1:1)*(n.scale??1);return y.scale(I,j),n.rotate&&y.rotate(n.rotate*Math.PI/180),y.drawImage(f,-s/2,-h/2,s,h),y.restore(),console.log("✅ [FilterHelper] Filtros y transformaciones aplicados exitosamente"),v}return console.log("✅ [FilterHelper] Filtros aplicados exitosamente (sin transformaciones)"),f}async function qt({page:t,workspaceDimensions:n,onProgress:s=null,preserveFilters:h=!1}){var y;console.log(`⚡ Generando thumbnail para página: ${t.id}${h?" (CON PRESERVACIÓN DE FILTROS)":""}`),window.ENABLE_ADVANCED_FILTER_RENDERING=!0;let f=!1,T=0;t.cells&&t.cells.forEach(I=>{I.elements&&I.elements.forEach(j=>{j.filters&&(j.filters.brightness!==void 0&&j.filters.brightness!==100||j.filters.contrast!==void 0&&j.filters.contrast!==100||j.filters.saturation!==void 0&&j.filters.saturation!==100||j.filters.tint!==void 0&&j.filters.tint!==0||j.filters.hue!==void 0&&j.filters.hue!==0||j.filters.blur!==void 0&&j.filters.blur>0||j.filters.gaussianBlur!==void 0&&j.filters.gaussianBlur>0||j.filters.opacity!==void 0&&j.filters.opacity!==100||j.filters.scale!==void 0&&j.filters.scale!==1||j.filters.rotate!==void 0&&j.filters.rotate!==0||j.filters.flipHorizontal||j.filters.flipVertical)&&(f=!0,T++,j._hasRealFilters=!0,j.pageId=t.id,console.log(`🔍 [FILTROS] Detectado elemento ${j.id} con filtros:`,j.filters))})}),(h||f||window.FORCE_FILTER_APPLICATION)&&(console.log(`🎭 [FILTROS] Activando preservación de filtros para página ${t.id} (${T} elementos con filtros)`),window.PRESERVE_FILTERS_FOR_PAGE=t.id,window.FORCE_FILTER_APPLICATION=!0,window._pagesWithFiltersProtected||(window._pagesWithFiltersProtected=new Set),window._pagesWithFiltersProtected.add(t.id),f&&typeof document<"u"&&setTimeout(()=>{document.getElementById("filter-emergency-button-"+t.id)||da(t.id)},500));const v=(I,j,w="")=>{const C=Math.round(I/j*100);console.log(`📊 Progreso página ${t.id}: ${I}/${j} (${C}%) ${w}`),s&&s({current:I,total:j,percentage:C,message:w,pageId:t.id})};try{const I=300/Math.max(n.width,n.height),j=Math.round(n.width*I),w=Math.round(n.height*I),C=`${t.id}-${j}x${w}`;if(ze.has(C))return console.log(`📦 Thumbnail encontrado en cache: ${t.id}`),v(4,4,"Cargado desde cache"),ze.get(C);v(1,4,"Iniciando generación...");const S=new Set;t.backgroundImage&&S.add(t.backgroundImage),t.cells&&t.cells.forEach(R=>{R.elements&&R.elements.forEach($=>{$.type==="image"&&$.content&&S.add($.content)})}),v(2,4,"Cargando imágenes...");const P=Array.from(S).map(async R=>{try{const $=new Promise((W,ne)=>setTimeout(()=>ne(new Error("Timeout")),3e3)),J=Fn(R);await Promise.race([J,$])}catch{console.warn(`⚠️ Error/timeout cargando imagen: ${R}`)}});await Promise.all(P),v(3,4,"Renderizando thumbnail...");const k=document.createElement("canvas"),B=k.getContext("2d",{alpha:!1,willReadFrequently:!1});if(k.width=j,k.height=w,B.fillStyle=t.backgroundColor||"#ffffff",B.fillRect(0,0,k.width,k.height),t.backgroundImage){const R=Be.get(t.backgroundImage);R&&B.drawImage(R,0,0,k.width,k.height)}if(t.cells&&t.cells.length>0){const R=Math.ceil(Math.sqrt(Math.min(t.cells.length,9))),$=k.width/R,J=k.height/Math.ceil(Math.min(t.cells.length,9)/R);t.cells.slice(0,9).forEach((W,ne)=>{const ue=ne%R,ye=Math.floor(ne/R),c=ue*$,ee=ye*J;W.elements&&W.elements.filter(Q=>Q.type==="image"||Q.type==="text").slice(0,3).forEach(Q=>{Bn(B,Q,{x:c,y:ee,width:$,height:J})})})}v(4,4,"Guardando thumbnail...");const O=k.toDataURL("image/jpeg",.7);if(ze.set(C,O),window.PRESERVE_FILTERS_FOR_PAGE===t.id){console.log("🔍 [VERIFICACIÓN] Comprobando si el thumbnail tiene los filtros aplicados...");let R=0,$=0;(y=t.cells)==null||y.forEach(J=>{var W;(W=J.elements)==null||W.forEach(ne=>{ne._hasRealFilters&&(R++,$++)})}),console.log(`📊 [RESULTADO] Elementos con filtros: ${R}`),console.log(`🧹 [FastThumbnail] Limpiando banderas de filtros para página ${t.id}`),window.PRESERVE_FILTERS_FOR_PAGE=null,window.FORCE_FILTER_APPLICATION=!1,window._filteredThumbnails||(window._filteredThumbnails={}),window._filteredThumbnails[t.id]={timestamp:Date.now(),elementsWithFilters:R},console.log(`🔒 [PROTECCIÓN] Thumbnail con filtros registrado y protegido: ${t.id}`)}return console.log(`✅ Thumbnail generado para página: ${t.id}`),O}catch(I){return console.error(`❌ Error generando thumbnail para página ${t.id}:`,I),v(4,4,"Error en generación"),null}}async function yn({pages:t,workspaceDimensions:n,onProgress:s=null}){const h={};console.log(`⚡ Generando ${t.length} thumbnails rápidos...`);const f=(w,C,S="")=>{const P=Math.round(w/C*100);console.log(`📊 Progreso: ${w}/${C} (${P}%) ${S}`),s&&s({current:w,total:C,percentage:P,message:S})},T=new Set;t.forEach(w=>{w.backgroundImage&&T.add(w.backgroundImage),w.cells&&w.cells.forEach(C=>{C.elements&&C.elements.forEach(S=>{S.type==="image"&&S.content&&T.add(S.content)})})});const N=Array.from(T),v=5;f(0,N.length,"Cargando imágenes...");for(let w=0;w<N.length;w+=v){const C=N.slice(w,w+v);await Promise.all(C.map(Fn)),f(Math.min(w+v,N.length),N.length,"Cargando imágenes...")}console.log(`📸 Imágenes cargadas: ${Be.size}`);const y=300/Math.max(n.width,n.height),I=Math.round(n.width*y),j=Math.round(n.height*y);f(0,t.length,"Generando thumbnails...");for(let w=0;w<t.length;w++){const C=t[w];try{const S=`${C.id}-${I}x${j}`;if(ze.has(S)){h[C.id]=ze.get(S),f(w+1,t.length,`Thumbnail ${C.id} (cached)`);continue}const P=document.createElement("canvas"),k=P.getContext("2d",{alpha:!1,willReadFrequently:!1});if(P.width=I,P.height=j,k.fillStyle=C.backgroundColor||"#ffffff",k.fillRect(0,0,P.width,P.height),C.backgroundImage){const O=Be.get(C.backgroundImage);O&&k.drawImage(O,0,0,P.width,P.height)}if(C.cells&&C.cells.length>0){const O=Math.ceil(Math.sqrt(C.cells.length)),R=P.width/O,$=P.height/Math.ceil(C.cells.length/O);C.cells.forEach((J,W)=>{if(W>=9)return;const ne=W%O,ue=Math.floor(W/O),ye=ne*R,c=ue*$;J.elements&&J.elements.filter(x=>x.type==="image"||x.type==="text").slice(0,3).forEach(x=>{Bn(k,x,{x:ye,y:c,width:R,height:$})})})}const B=P.toDataURL("image/jpeg",.7);h[C.id]=B,ze.set(S,B),f(w+1,t.length,`Thumbnail ${C.id} generado`)}catch(S){console.error(`❌ Error generando thumbnail rápido para ${C.id}:`,S),h[C.id]=null,f(w+1,t.length,`Error en ${C.id}`)}}return console.log(`⚡ ¡${Object.keys(h).length} thumbnails generados en modo rápido!`),h}function Ht(){Be.clear(),ze.clear(),console.log("🧹 Caches de thumbnails limpiados")}const ga=async(t,n,s)=>{var h;try{console.log("📤 [SAVE] Subiendo imagen al backend:",n);const[i,f]=t.split(","),T=((h=i.match(/data:image\/(\w+)/))==null?void 0:h[1])||"png",N=new FormData,v=atob(f),y=new Array(v.length);for(let S=0;S<v.length;S++)y[S]=v.charCodeAt(S);const I=new Uint8Array(y),j=new Blob([I],{type:`image/${T}`});N.append("image",j,`element_${n}.${T}`),N.append("project_id",s),N.append("element_id",n);const w=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:N});if(!w.ok)throw new Error("Error al subir imagen al servidor");const C=await w.json();return console.log("✅ [SAVE] Imagen subida exitosamente:",C.url),C.url}catch(i){throw console.error("❌ [SAVE] Error subiendo imagen:",i),i}},ha=async(t,n)=>{var f,T;console.log("🔄 [SAVE] Procesando imágenes para guardado...");const s=[];let h=0,i=0;for(const N of t)for(const v of N.cells||[])for(const y of v.elements||[])y.type==="image"&&((f=y.content)!=null&&f.startsWith("data:image/"))&&h++;console.log(`📊 [SAVE] Total de imágenes base64 a procesar: ${h}`);for(const N of t){const v={...N};v.cells=[];for(const y of N.cells||[]){const I={...y};I.elements=[];for(const j of y.elements||[]){const w={...j};if(j.type==="image"&&((T=j.content)!=null&&T.startsWith("data:image/")))try{const C=await ga(j.content,j.id,n);w.content=C,w.isUploaded=!0,i++,console.log(`✅ [SAVE] Imagen ${i}/${h} procesada`)}catch(C){console.error("❌ [SAVE] Error procesando imagen:",j.id,C),w.uploadError=C.message}I.elements.push(w)}v.cells.push(I)}s.push(v)}return console.log(`✅ [SAVE] Procesamiento completado: ${i}/${h} imágenes subidas`),s},ma=async(t,n)=>{var s;try{console.log("🔍 [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:t,thumbnailsCount:Object.keys(n).length});const h=[];for(const[T,N]of Object.entries(n))console.log(`🔍 [DEBUG] Procesando thumbnail para página ${T}:`,{hasData:!!N,isBase64:N&&N.startsWith("data:image/"),dataLength:N?N.length:0}),N&&N.startsWith("data:image/")&&h.push({page_id:T,thumbnail_data:N});if(h.length===0){console.log("ℹ️ [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`🖼️ [THUMBNAILS] Guardando ${h.length} thumbnails como archivos...`),console.log(`🔍 [DEBUG] URL del endpoint: /api/thumbnails/${t}/save-as-files`);const i=await fetch(`/api/thumbnails/${t}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content)||""},credentials:"include",body:JSON.stringify({thumbnails:h})});if(console.log("🔍 [DEBUG] Respuesta del servidor:",{status:i.status,statusText:i.statusText,ok:i.ok}),!i.ok){const T=await i.text();throw console.error("❌ [THUMBNAILS] Error respuesta del servidor:",T),new Error(`Error al guardar thumbnails: ${i.status} ${i.statusText}`)}const f=await i.json();return console.log("✅ [THUMBNAILS] Thumbnails guardados como archivos:",f),f}catch(h){throw console.error("❌ [THUMBNAILS] Error guardando thumbnails:",h),h}},En=async(t,n,s,h,i,f,T=!1)=>{try{if(!(n!=null&&n.id))throw new Error("No se encontró el ID del proyecto");console.log(`💾 [SAVE] Iniciando ${T?"auto-guardado":"guardado manual"}...`);let N=t;T||(N=await ha(t,n.id));const v={pages:N,projectInfo:{id:n.id,item_id:s==null?void 0:s.id,title:s==null?void 0:s.title,preset_id:h==null?void 0:h.id},workspace:{width:i.width,height:i.height,scale:i.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:T,totalPages:t.length}},y=T?"save-progress":"save",I=await fetch(`/api/canvas/projects/${n.id}/${y}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:v,thumbnails:f})});if(!I.ok){const w=await I.json().catch(()=>({}));throw new Error(w.message||"Error al guardar el proyecto")}const j=await I.json();if(console.log(`✅ [SAVE] ${T?"Auto-guardado":"Guardado"} exitoso:`,j),!T&&f&&Object.keys(f).length>0){console.log("🖼️ [SAVE] Guardando thumbnails como archivos...");try{await ma(n.id,f),console.log("✅ [SAVE] Thumbnails guardados como archivos")}catch(w){console.warn("⚠️ [SAVE] Error guardando thumbnails como archivos:",w)}}return{success:!0,data:j}}catch(N){return console.error(`❌ [SAVE] Error en ${T?"auto-guardado":"guardado"}:`,N),{success:!1,error:N.message}}},pa=(t,n,s,h,i,f)=>{const[T,N]=b.useState("saved"),[v,y]=b.useState(null),[I,j]=b.useState(null),[w,C]=b.useState(null),[S,P]=b.useState(!1),[k,B]=b.useState(navigator.onLine),O=b.useRef(null),R=b.useRef(null),$=b.useRef(null),J=b.useRef(!1),W=b.useRef(null),ne=15e3,ue=2e3,ye=5e3,c=b.useCallback((z,Z)=>{try{const q={pages:z.map(de=>{var X;return{id:de.id,layout:de.layout,cells:((X=de.cells)==null?void 0:X.map(he=>{var Re;return{id:he.id,elements:((Re=he.elements)==null?void 0:Re.map(we=>{var ke;return{id:we.id,type:we.type,content:we.type==="image"&&((ke=we.content)!=null&&ke.startsWith("data:image/"))?`[IMAGE_${we.content.length}]`:we.content,position:we.position,size:we.size,style:we.style,filters:we.filters,rotation:we.rotation}}))||[]}}))||[]}})||[],workspace:{width:Z==null?void 0:Z.width,height:Z==null?void 0:Z.height}};return btoa(JSON.stringify(q)).substring(0,32)}catch(q){return console.warn("⚠️ [AUTO-SAVE] Error generando hash:",q),Date.now().toString()}},[]),ee=b.useCallback(()=>`album_editor_autosave_${(n==null?void 0:n.id)||"draft"}`,[n==null?void 0:n.id]),x=b.useCallback(z=>{try{const Z=ee(),q={...z,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(Z,JSON.stringify(q)),console.log("💾 [AUTO-SAVE] Guardado en localStorage"),!0}catch(Z){return console.error("❌ [AUTO-SAVE] Error guardando en localStorage:",Z),!1}},[ee]),Q=b.useCallback(()=>{var z;try{const Z=ee(),q=localStorage.getItem(Z);if(q){const de=JSON.parse(q);return console.log("📂 [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(z=de.pages)==null?void 0:z.length,savedAt:new Date(de.savedAt).toLocaleString()}),de}}catch(Z){console.error("❌ [AUTO-SAVE] Error cargando desde localStorage:",Z)}return null},[ee]),ie=b.useCallback(async(z=!1)=>{if(J.current&&!z){console.log("⏳ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(n!=null&&n.id)||!t||t.length===0){console.log("⚠️ [AUTO-SAVE] Datos insuficientes para guardar");return}const Z=c(t,i);if(!z&&Z===$.current){console.log("📊 [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{J.current=!0,N("saving"),C(null);const q={pages:t,projectInfo:{id:n.id,item_id:s==null?void 0:s.id,title:s==null?void 0:s.title,preset_id:h==null?void 0:h.id},workspace:i,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:Z}};if(x(q),k){const de=await En(t,n,s,h,i,f,!0);if(de.success)$.current=Z,j(new Date),N("saved"),P(!1),console.log("✅ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(de.error)}else console.log("� [AUTO-SAVE] Sin conexión, solo guardado en localStorage"),N("pending"),P(!0)}catch(q){console.error("❌ [AUTO-SAVE] Error:",q),C(q.message),N("error"),k&&(W.current=setTimeout(()=>{console.log("🔄 [AUTO-SAVE] Reintentando guardado..."),ie(!0)},ye))}finally{J.current=!1}},[t,n,s,h,i,f,c,x,k]),Se=b.useCallback(async()=>{try{N("saving");const z=await En(t,n,s,h,i,f,!1);if(z.success){const Z=c(t,i);$.current=Z,y(new Date),N("saved"),P(!1),ae.success("💾 Proyecto guardado exitosamente"),console.log("✅ [MANUAL-SAVE] Guardado manual exitoso")}else C(z.error),N("error"),ae.error(`❌ Error al guardar: ${z.error}`);return z.success}catch(z){return console.error("❌ [MANUAL-SAVE] Error:",z),C(z.message),N("error"),ae.error(`❌ Error inesperado: ${z.message}`),!1}},[t,n,s,h,i,f,c]);return b.useEffect(()=>{if(!(n!=null&&n.id)||!t||t.length===0)return;const z=c(t,i);return $.current&&z!==$.current?(console.log("🔄 [AUTO-SAVE] Cambios detectados, programando guardado..."),P(!0),N("pending"),R.current&&clearTimeout(R.current),R.current=setTimeout(()=>{ie()},ue)):$.current||($.current=z),()=>{R.current&&clearTimeout(R.current)}},[t,i,n==null?void 0:n.id,c,ie]),b.useEffect(()=>{if(n!=null&&n.id)return O.current&&clearInterval(O.current),O.current=setInterval(()=>{S&&(console.log("⏰ [AUTO-SAVE] Auto-save periódico activado"),ie())},ne),()=>{O.current&&clearInterval(O.current)}},[n==null?void 0:n.id,S,ie]),b.useEffect(()=>{const z=()=>{console.log("🌐 [AUTO-SAVE] Conexión restaurada"),B(!0),S&&setTimeout(()=>ie(!0),1e3)},Z=()=>{console.log("📴 [AUTO-SAVE] Conexión perdida"),B(!1)};return window.addEventListener("online",z),window.addEventListener("offline",Z),()=>{window.removeEventListener("online",z),window.removeEventListener("offline",Z)}},[S,ie]),b.useEffect(()=>{const z=Z=>{if(S){const q={pages:t,projectInfo:{id:n.id},workspace:i,meta:{savedAt:new Date().toISOString()}};return x(q),Z.preventDefault(),Z.returnValue="¿Estás seguro de salir? Hay cambios sin guardar.","¿Estás seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",z),()=>window.removeEventListener("beforeunload",z)},[S,t,n==null?void 0:n.id,i,x]),b.useEffect(()=>()=>{R.current&&clearTimeout(R.current),O.current&&clearInterval(O.current),W.current&&clearTimeout(W.current)},[]),b.useEffect(()=>{w&&(w.includes("max_allowed_packet")||w.includes("data_too_large")?ae.error("❌ El proyecto es demasiado grande para guardar automáticamente. Reduce el número o tamaño de imágenes."):ae.error(`❌ Error de auto-guardado: ${w}`))},[w]),{saveStatus:T,lastSaved:v,lastAutoSaved:I,saveError:w,hasUnsavedChanges:S,isOnline:k,saveManually:Se,performAutoSave:()=>ie(!0),loadFromLocalStorage:Q,getStorageKey:ee,autoSaveInterval:ne,debounceDelay:ue}},fa=({saveStatus:t,lastSaved:n,lastAutoSaved:s,hasUnsavedChanges:h,isOnline:i,saveError:f,onManualSave:T,className:N=""})=>{const v=j=>{if(!j)return null;const C=new Date-j,S=Math.floor(C/(1e3*60)),P=Math.floor(C/1e3);if(P<30)return"hace unos segundos";if(S<1)return`hace ${P}s`;if(S<60)return`hace ${S}m`;const k=Math.floor(S/60);return k<24?`hace ${k}h`:j.toLocaleDateString()},I=(()=>{if(!i)return{icon:e.jsx(mn,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexión",detail:"Guardado local activo"};switch(t){case"saving":return{icon:e.jsx(To,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(Co,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:s?`Auto-guardado ${v(s)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(Eo,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:f||"Error desconocido"};case"pending":return{icon:e.jsx(yo,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:h?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(jn,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${N}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${I.bg} ${I.color}
                    hover:shadow-md
                `,onClick:()=>t!=="saving"&&(T==null?void 0:T()),children:[I.icon,e.jsx("span",{className:"text-sm font-medium",children:I.text}),e.jsx("div",{className:"flex items-center",children:i?e.jsx(Fo,{className:"w-3 h-3 text-green-500"}):e.jsx(mn,{className:"w-3 h-3 text-orange-500"})})]}),t==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},Fe=typeof window>"u",wt=()=>{},ba=()=>{},Ye=console.error,Ne=console.log,xa=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const t=document.createElement("style");t.textContent=xa,document.head.appendChild(t)}function vt(t,n){let s;return function(...i){const f=()=>{clearTimeout(s),t(...i)};clearTimeout(s),s=setTimeout(f,n)}}const wa=async(t,n,s)=>{try{const h=document.querySelector(`#page-${t.id}`);if(!h)return console.warn(`❌ [COMPLEX-LAYOUT] No se encontró elemento para página: ${t.id}`),null;if(!(s.cellStyles&&Object.values(s.cellStyles).some(N=>N.includes("col-span-")||N.includes("row-span-"))))return await qt({page:t,workspaceDimensions:n,preserveFilters:!0});const{default:f}=await Cn(async()=>{const{default:N}=await import("./thumbnailGenerator-B4goYG9Y.js").then(v=>v.a);return{default:N}},[]),T=await f(h,{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:t.backgroundColor||"#ffffff",width:n.width,height:n.height,logging:!1,onclone:N=>{var y,I,j;const v=N.querySelector(`#page-${t.id}`);if(v){v.style.display="grid",v.style.gridTemplateColumns=((y=s.template.match(/grid-cols-(\d+)/))==null?void 0:y[0])||"repeat(1, 1fr)",v.style.gridTemplateRows=((I=s.template.match(/grid-rows-(\d+)/))==null?void 0:I[0])||"repeat(1, 1fr)";const w=s.template.match(/gap-(\d+)/);w?v.style.gap=`${parseInt(w[1])*4}px`:(j=s.style)!=null&&j.gap&&(v.style.gap=s.style.gap),v.querySelectorAll("[data-cell-id]").forEach((S,P)=>{if(s.cellStyles&&s.cellStyles[P]){const k=s.cellStyles[P],B=k.match(/col-span-(\d+)/),O=k.match(/row-span-(\d+)/);B&&(S.style.gridColumn=`span ${B[1]}`),O&&(S.style.gridRow=`span ${O[1]}`)}})}}});return T?T.toDataURL("image/png",.9):null}catch(h){return console.error("❌ [COMPLEX-LAYOUT] Error generando thumbnail:",h),null}},va=(t,n,s)=>{var P,k;if(!t||!t.template)return s;const h=t.template;let i=1,f=1;const T=h.match(/grid-cols-(\d+)/),N=h.match(/grid-rows-(\d+)/);T&&(i=parseInt(T[1])),N&&(f=parseInt(N[1]));let v=16;const y=h.match(/gap-(\d+)/);y?v=parseInt(y[1])*4:(P=t.style)!=null&&P.gap&&(v=parseInt(t.style.gap));let I=0;(k=t.style)!=null&&k.padding&&(I=parseInt(t.style.padding)*2);const j=s.width-I-v*(i-1),w=s.height-I-v*(f-1);let C=Math.floor(j/i),S=Math.floor(w/f);if(t.cellStyles&&t.cellStyles[n]){const B=t.cellStyles[n],O=B.match(/col-span-(\d+)/),R=B.match(/row-span-(\d+)/);if(O){const $=parseInt(O[1]);C=Math.floor((j+v*($-1))/i*$)}if(R){const $=parseInt(R[1]);S=Math.floor((w+v*($-1))/f*$)}}return Ne(`🔧 [CELL-DIMENSIONS] Layout: ${t.id}, Celda: ${n}, Grid: ${i}x${f}, Gap: ${v}px, Dims: ${C}x${S}`),{width:C,height:S}},Vt=Gt.memo(({pageId:t,thumbnail:n,altText:s,type:h})=>{const[i,f]=b.useState(!1),[T,N]=b.useState(!1);if(n&&!T)return e.jsxs("div",{className:"relative w-full h-full",children:[!i&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:n,alt:s,className:`w-full h-full object-contain transition-opacity duration-200 ${i?"opacity-100":"opacity-0"}`,onLoad:()=>f(!0),onError:()=>N(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const v=h==="cover"||h==="final"?yt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((y,I)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},I))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(v,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(t,n)=>t.pageId===n.pageId&&t.thumbnail===n.thumbnail&&t.altText===n.altText&&t.type===n.type),ya=Gt.memo(({images:t,onImageSelect:n,isLoading:s})=>{const h=Gt.memo(({image:i})=>{const[f,T]=b.useState(!1),[N,v]=b.useState(!1),[y,I]=b.useState(!1),[{isDragging:j},w]=Ao(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:i.url},collect:B=>({isDragging:!!B.isDragging()}),end:()=>{setTimeout(()=>I(!1),100)}})),C=i.thumbnail_url||i.url,S=i.url,P=B=>{I(!0),setTimeout(()=>I(!1),500)},k=B=>{if(y||j)return B.preventDefault(),B.stopPropagation(),!1;n(S)};return e.jsxs("div",{ref:w,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${j?"opacity-50 scale-95":""}`,onMouseDown:P,onClick:k,children:[e.jsxs("div",{className:"aspect-square relative",children:[!f&&!N&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),N?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(De,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:C,alt:i.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${f?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>T(!0),onError:()=>v(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(Et,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:i.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),i.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return s?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((i,f)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},f))}):t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(De,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay imágenes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:t.map((i,f)=>e.jsx(h,{image:i},`${i.id||i.url}-${f}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[t.filter(i=>i.has_thumbnail).length," de ",t.length," imágenes optimizadas"]})})]})});function Ns(){var vr,yr,Er,Cr,Tr,Nr,Sr,jr,kr,Ar,_r,Ir,Rr,Pr,Or,Lr,Mr,$r,Fr,Br,zr,Ur,Hr,Vr,Gr,Wr,qr,Dr,Kr,Jr,Yr,Xr,Qr,Zr,en,tn,rn,nn,on,an,sn;const[t,n]=b.useState(null),[s,h]=b.useState(null),[i,f]=b.useState(null),[T,N]=b.useState(null),[v,y]=b.useState(!0),[I,j]=b.useState(null),[w,C]=b.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[S,P]=b.useState(new Map),[k,B]=b.useState([]),[O,R]=b.useState(!1),$=b.useRef(k),J=b.useRef(S);b.useRef(null);const W=b.useRef(null),ne=b.useRef(null);b.useEffect(()=>{$.current=k},[k]),b.useEffect(()=>{J.current=S},[S]),b.useEffect(()=>{(async()=>{var o;try{const l=new URLSearchParams(window.location.search).get("project");if(!l){j("No se encontró el ID del proyecto en la URL"),y(!1);return}const u=await fetch(`/api/canvas/projects/${l}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!u.ok)throw new Error("Error al cargar el proyecto");const d=await u.json();n(d.project),h(d.item),f(d.canvasPreset),N(d.initialProject),y(!1)}catch(a){console.error("❌ Error cargando proyecto:",a),j(a.message),y(!1)}})()},[]);const[ue,ye]=b.useState(gn.Local.get(`${hn.APP_CORRELATIVE}_cart`)??[]);b.useEffect(()=>{gn.Local.set(`${hn.APP_CORRELATIVE}_cart`,ue)},[ue]);const[c,ee]=b.useState([]),[x,Q]=b.useState(0),[ie,Se]=b.useState("preset"),[z,Z]=b.useState(null),[q,de]=b.useState(null),[X,he]=b.useState("pages"),[Re,we]=b.useState("basic"),[ke,Xe]=b.useState([JSON.stringify(c)]),[Ae,Ve]=b.useState(0),[Dt,Ea]=b.useState(!1),[Ca,Kt]=b.useState(null),[oe,se]=b.useState({}),[Ta,Na]=b.useState(!1),[Pe,Ge]=b.useState([]),[St,Jt]=b.useState(!1),[it,zn]=b.useState(new Map),[Qe,Un]=b.useState(()=>new Map),[Ze,Yt]=b.useState(null),[Xt,Qt]=b.useState(!1);b.useEffect(()=>{Ne("✅ [FILTERS] Tab actual:",X)},[X]),b.useCallback((r,o="manual")=>{if(Ne(`🔄 [ACTIVE_TAB] Cambiando de "${X}" a "${r}" - Razón: ${o}`),r==="filters"&&o!=="manual"){console.warn("🚨 [ACTIVE_TAB] Cambio automático a filters bloqueado!");return}he(r)},[X]),Fe||(window.FORCE_THUMBNAIL_REGENERATION=!0,window.PREVENT_THUMBNAIL_RESET=!1,window._protectedThumbnailIds=[],window.THUMBNAIL_PROTECTED=!1,window.PRESERVE_FILTERS=!0),b.useEffect(()=>{Fe||(window.forceRegenerateAllThumbnails=()=>{Ne("💣 [EMERGENCIA-GLOBAL] Forzando regeneración de TODOS los thumbnails"),window.thumbnailCache={},P(r=>{const o=new Map(r);return c.forEach((a,l)=>{o.set(l,Date.now())}),o}),Ne("1️⃣ Regenerando página actual"),le(!0).then(()=>{Ne("✅ Primera regeneración completa"),window.BLOCK_AUTO_REGENERATION=!0,setTimeout(()=>{Ne("2️⃣ Ejecutando segunda regeneración forzada"),window.forceRegenerateThumbnail&&window.forceRegenerateThumbnail(),window.THUMBNAIL_PROTECTED=!0,setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,Ne("🔓 Regeneración automática desbloqueada")},5e3)},200)}).catch(r=>{console.error("❌ Error en regeneración de emergencia:",r)})})},[c]),b.useEffect(()=>{window._protectedThumbnails||(window._protectedThumbnails=new Set),window.protectThumbnail=r=>{window._protectedThumbnails.add(r),Ne(`🛡️ [PROTECT] Thumbnail ${r} marcado como protegido`)},window.unprotectThumbnail=r=>{window._protectedThumbnails.delete(r),Ne(`🔓 [UNPROTECT] Thumbnail ${r} desprotegido`)},window.isThumbnailProtected=r=>{var o;return((o=window._protectedThumbnails)==null?void 0:o.has(r))||!1},window.blockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!0,Ne("🚫 [BLOCK AUTO] Regeneraciones automáticas BLOQUEADAS")},window.unblockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!1,Ne("✅ [UNBLOCK AUTO] Regeneraciones automáticas DESBLOQUEADAS")},window.isAutoRegenerationBlocked=()=>window._blockAutoRegeneration||!1,window._thumbnailWatchdog||(window._thumbnailWatchdog=setInterval(()=>{window._protectedThumbnailData&&window._protectedThumbnails&&Array.from(window._protectedThumbnails).forEach(o=>{const a=window._protectedThumbnailData[o];a&&se(l=>l[o]&&l[o]!==a?(console.error(`🚨 [WATCHDOG] ¡SOBRESCRITURA DETECTADA! Restaurando ${o}`),{...l,[o]:a}):l)})},100)),window._interceptorInstalled||(window._interceptorInstalled=!0)},[]);const[lt,et]=b.useState(!1),Zt=b.useRef(),[V,er]=b.useState({width:800,height:600}),Hn=b.useCallback((r,o,a="unknown")=>{var l;return(l=window.isThumbnailProtected)!=null&&l.call(window,r)?(console.error(`� [PROTECTION BLOCK] ¡BLOQUEADO! Intento de sobrescribir thumbnail protegido ${r} desde: ${a}`),console.error("🚨 [PROTECTION BLOCK] Stack trace:",new Error().stack),!1):(se(u=>(u[r],{...u,[r]:o})),!0)},[]),tr=b.useMemo(()=>ca({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¡Bienvenido al Editor de BananaLab! 🍌",description:"Este es tu lienzo de trabajo donde crearás diseños increíbles. Aquí puedes ver y editar la página actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"🎯 Navegación Principal",description:"En la barra lateral izquierda encontrarás todas las herramientas organizadas por categorías. Cada ícono te lleva a una sección específica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"📄 Sección Páginas",description:"Gestiona todas las páginas de tu proyecto: portada, páginas de contenido y contraportada. Haz clic en cualquier página para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"🎨 Sección Diseños",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu página. Cada diseño tiene una distribución única.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"📚 Sección Capas",description:"Organiza y controla la superposición de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posición.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"✍️ Sección Textos",description:"Agrega y personaliza textos: títulos, subtítulos y párrafos. Cambia fuentes, colores, tamaños y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"🎭 Sección Filtros",description:"Aplica efectos visuales a tus imágenes: brillo, contraste, saturación, máscaras y más filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"⚡ Acciones Rápidas",description:"Herramientas de acceso rápido: cambiar diseño de página, gestionar capas, agregar imágenes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"💾 Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso automáticamente y acceder a la vista previa de tu álbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"👁️ Vista de Álbum",description:"Visualiza tu proyecto completo como un álbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"🎉 ¡Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una página y agregando elementos. ¡Diviértete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente →",prevBtnText:"← Anterior",doneBtnText:"¡Empezar a crear! 🚀",closeBtnText:"✕",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(r,o)=>{var l;const a=(l=r==null?void 0:r.getAttribute)==null?void 0:l.call(r,"data-tab");a&&X!==a&&he(a)},onDeselected:()=>{ae.success("¡Guía completada! Ya puedes empezar a crear tu diseño.",{duration:3e3})}}),[X,he]),Vn=b.useCallback(()=>{tr.drive()},[tr]),jt=b.useCallback(async()=>{if(t!=null&&t.id)try{const r=await fetch(`/api/thumbnails/${t.id}`);if(r.ok){const o=await r.json();if(o.success&&o.thumbnails&&o.thumbnails.length>0){const a={};o.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(a[l.page_id]=l.thumbnail_url)}),Object.keys(a).length>0&&se(l=>{var d;console.warn("🚨 [STORAGE LOAD] ¡ALERTA! Cargando thumbnails desde storage - POSIBLE CULPABLE DE SOBRESCRITURA"),console.warn("🚨 [STORAGE LOAD] Thumbnails protegidos:",Array.from(window._protectedThumbnails||[])),console.warn("🚨 [STORAGE LOAD] Stack trace:",new Error().stack);const u={};for(const[p,g]of Object.entries(a))(d=window.isThumbnailProtected)!=null&&d.call(window,p)?console.warn(`🛡️ [STORAGE PROTECTION] NO sobrescribiendo thumbnail protegido: ${p}`):u[p]=g;return{...l,...u}})}}}catch(r){console.warn("⚠️ Error cargando thumbnails guardados (usando locales):",r)}},[t==null?void 0:t.id]),ct=b.useRef(new Map),Ue=b.useRef(new Map),kt=b.useRef(null);b.useEffect(()=>(kt.current=setInterval(()=>{const r=Date.now(),o=10*60*1e3;for(const[a,l]of Ue.current.entries())r-l.timestamp>o&&Ue.current.delete(a);if(window.thumbnailCache&&typeof window.thumbnailCache=="object"){const a=Object.keys(window.thumbnailCache);if(a.length>100){const l=a.sort().slice(-60),u={};l.forEach(d=>{u[d]=window.thumbnailCache[d]}),window.thumbnailCache=u}}},3e5),()=>{kt.current&&clearInterval(kt.current)}),[]);const rr=b.useMemo(()=>JSON.stringify(V),[V]),le=b.useCallback(async(r=!1)=>{var d,p,g;if(window.BLOCK_AUTO_REGENERATION&&!r)return;const o=c[x];if(!o||!V)return;console.log("pagina current actual",o);const a=o.id;if(!r){ct.current.has(a)&&clearTimeout(ct.current.get(a));const m=setTimeout(()=>{ct.current.delete(a),le(!0)},300);ct.current.set(a,m);return}const l=`${a}-${rr}`;if(!r&&Ue.current.has(l)){const m=Ue.current.get(l);if(m&&Date.now()-m.timestamp<6e4)return}let u=!1;if(o.cells&&o.cells.forEach(m=>{m.elements&&m.elements.forEach(E=>{E.filters&&(E.filters.brightness!==void 0&&E.filters.brightness!==100&&E.filters.brightness!==1||E.filters.contrast!==void 0&&E.filters.contrast!==100&&E.filters.contrast!==1||E.filters.saturation!==void 0&&E.filters.saturation!==100&&E.filters.saturation!==1||E.filters.tint!==void 0&&E.filters.tint!==0||E.filters.hue!==void 0&&E.filters.hue!==0||E.filters.blur!==void 0&&E.filters.blur>0||E.filters.opacity!==void 0&&E.filters.opacity!==100&&E.filters.opacity!==1||E.filters.scale!==void 0&&E.filters.scale!==1||E.filters.rotate!==void 0&&E.filters.rotate!==0||E.filters.flipHorizontal||E.filters.flipVertical)&&(u=!0,E._hasRealFilters=!0)})}),!r&&!u&&oe[a]){const m=((d=window._thumbnailGenTimes)==null?void 0:d[a])||0;if(Date.now()-m<3e5)return}if(!Oe.current){Oe.current=!0;try{window._currentPageData=o,window._workspaceDimensions=V,window._updateThumbnailInUI=(L,U)=>{var _;if((_=window.isThumbnailProtected)!=null&&_.call(window,L)){console.error(`🚨 [UPDATE BLOCKED] ¡BLOQUEADO! Intento de actualizar thumbnail protegido ${L} via _updateThumbnailInUI`),console.error("🚨 [UPDATE BLOCKED] Stack trace:",new Error().stack);return}se(H=>({...H,[L]:U}))},window._thumbnailGenTimes||(window._thumbnailGenTimes={}),window._thumbnailGenTimes[a]=Date.now();let m=null;const E=ce.find(L=>L.id===o.layout)||ce[0];if(E.cellStyles&&Object.values(E.cellStyles).some(L=>L.includes("col-span-")||L.includes("row-span-"))){console.log("🏗️ [LAYOUT COMPLEJO] Usando generador especializado para layout:",E.id);try{m=await wa(o,V,E),console.log("✅ [LAYOUT COMPLEJO] Thumbnail generado exitosamente")}catch(L){console.error("❌ [LAYOUT COMPLEJO] Error, usando fallback:",L),m=await ft(o,V)}}else if(u||r)try{m=await ft(o,V)}catch(L){console.error("❌ [MÉTODO RADICAL] Error, usando fallback:",L),m=await qt({page:o,workspaceDimensions:V,preserveFilters:!0})}else m=await qt({page:o,workspaceDimensions:V,preserveFilters:!1});if(m){if(u){(p=window.protectThumbnail)==null||p.call(window,a),(g=window.blockAutomaticRegeneration)==null||g.call(window),se(_=>({..._,[a]:m})),setTimeout(()=>{se(_=>_[a]!==m?(ba(`🚨 [PROTECTION RESTORE] Restaurando thumbnail protegido para ${a}`),{..._,[a]:m}):_)},100);const U=()=>{se(_=>_[a]!==m?(Ye(`🚨 [EMERGENCY RESTORE] ¡PARPADEO DETECTADO! Restaurando thumbnail para ${a}`),{..._,[a]:m}):_)};setTimeout(U,200),setTimeout(U,500),setTimeout(U,1e3),setTimeout(U,2e3),window._protectedThumbnailData||(window._protectedThumbnailData={}),window._protectedThumbnailData[a]=m}else Hn(a,m,"generateCurrentPageThumbnail");u&&!r&&(window._filterVerificationDone||(window._filterVerificationDone=new Set),window._filterVerificationDone.has(a)||(window._filterVerificationDone.add(a),setTimeout(async()=>{var U;try{const _=await ft(o,V);_&&((U=window.protectThumbnail)==null||U.call(window,a),se(H=>({...H,[a]:_})))}catch(_){console.warn("⚠️ [RADICAL FALLBACK] Error en método radical:",_)}},1e3))),u&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(a)||window._protectedThumbnailIds.push(a));const L=`${a}-${rr}`;if(Ue.current.set(L,{data:m,timestamp:Date.now(),hasFilters:u}),Ue.current.size>50){const U=Ue.current.keys().next().value;Ue.current.delete(U)}}else console.error(`❌ [ERROR] No se pudo generar thumbnail para página: ${a}`)}catch(m){console.error(`❌ [CRITICAL ERROR] Error generando thumbnail para página ${a}:`,m)}finally{Oe.current=!1}}},[c,x,V,oe]),At=b.useCallback(vt(async()=>{var r;if(!window.BLOCK_AUTO_REGENERATION&&!window.THUMBNAIL_PROTECTED&&!(!(c!=null&&c.length)||!V)&&!Oe.current){Oe.current=!0;try{const o=c.filter(l=>!oe[l.id]);if(o.length===0)return;if((r=window.isAutoRegenerationBlocked)!=null&&r.call(window)){console.warn("🚫 [BLOCKED] Regeneración automática bloqueada, saltando generateFastThumbnails");return}const a=await yn({pages:o,workspaceDimensions:V,onProgress:l=>{Yt(l)}});a&&Object.keys(a).length>0&&se(l=>{var d;console.warn("🚨 [FAST THUMBNAILS] ¡ALERTA! generateFastThumbnails sobrescribiendo thumbnails - POSIBLE CULPABLE"),console.warn("🚨 [FAST THUMBNAILS] Stack trace:",new Error().stack);const u={};for(const[p,g]of Object.entries(a))(d=window.isThumbnailProtected)!=null&&d.call(window,p)?console.warn(`🛡️ [FAST PROTECTION] NO sobrescribiendo thumbnail protegido: ${p}`):u[p]=g;return{...l,...u}})}catch(o){console.warn("⚠️ Error generando thumbnails rápidos:",o)}finally{Oe.current=!1,Yt(null)}}},300),[c,V,oe]),Oe=b.useRef(!1);b.useCallback(async(r=[])=>{var o;if(!Oe.current)try{if(Oe.current=!0,r.length>0){const a=c.filter(l=>r.includes(l.id));if(a.length>0)if((o=window.isAutoRegenerationBlocked)!=null&&o.call(window))console.warn("🚫 [BLOCKED] Regeneración de prioridad bloqueada, saltando generateFastThumbnails");else{const l=await yn({pages:a,workspaceDimensions:V});l&&Object.keys(l).length>0&&se(u=>{var p;console.warn("🚨 [PRIORITY THUMBNAILS] ¡ALERTA! generateFastThumbnails de prioridad sobrescribiendo - POSIBLE CULPABLE"),console.warn("🚨 [PRIORITY THUMBNAILS] Stack trace:",new Error().stack);const d={};for(const[g,m]of Object.entries(l))(p=window.isThumbnailProtected)!=null&&p.call(window,g)?console.warn(`🛡️ [PRIORITY PROTECTION] NO sobrescribiendo thumbnail protegido: ${g}`):d[g]=m;return{...u,...d}})}}}catch(a){console.warn("⚠️ Error en generación prioritaria:",a)}finally{Oe.current=!1}},[c,V,At]);const nr=b.useCallback(r=>{if(Qe.has&&Qe.has(r))return;const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{if(o.width>1200||o.height>1200){const l=document.createElement("canvas"),u=l.getContext("2d"),d=1200,p=Math.min(d/o.width,d/o.height),g=o.width*p,m=o.height*p;l.width=g,l.height=m,u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(o,0,0,g,m),l.toBlob(E=>{if(E){const M=URL.createObjectURL(E);Un(L=>{const U=new Map(L);if(U.set(r,M),U.size>15){const _=U.keys().next().value,H=U.get(_);URL.revokeObjectURL(H),U.delete(_)}return U})}},"image/webp",.85)}},o.onerror=()=>{console.warn("❌ Error pre-cargando imagen:",r)},o.src=r},[]);b.useEffect(()=>{Pe.length>0&&Pe.slice(0,10).forEach((o,a)=>{setTimeout(()=>{nr(o.url)},a*100)})},[Pe,nr]),b.useEffect(()=>()=>{Qe&&Qe.forEach&&Qe.forEach(r=>URL.revokeObjectURL(r))},[]),b.useEffect(()=>()=>{Ht()},[]);const or=b.useCallback(async()=>{var r;if(!(!(t!=null&&t.id)||!(c!=null&&c.length))&&!Xt)try{Qt(!0);const o=await fetch(`/api/thumbnails/${t.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:c})});if(o.ok){const a=await o.json();a&&Object.keys(a).length>0?se(l=>({...l,...a})):setTimeout(()=>le(),200)}}catch(o){console.warn("⚠️ Error cargando thumbnails existentes:",o),setTimeout(()=>le(),200)}finally{Qt(!1)}},[t==null?void 0:t.id,c,le,Xt]);b.useCallback(async()=>{if(!(!(t!=null&&t.id)||!(c!=null&&c.length)))try{const r=c[x];if(!r)return;const o=await fetch(`/api/thumbnails/${t.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[r],width:V.width,height:V.height,quality:95,scale:4,dpi:300})});if(o.ok){const a=await o.json();if(a.success&&a.thumbnails){const l={};a.thumbnails.forEach(u=>{u.page_id&&u.thumbnail_url&&(l[u.page_id]=u.thumbnail_url)}),se(u=>({...u,...l}))}}}catch(r){console.warn("⚠️ Error generando thumbnail:",r)}},[t==null?void 0:t.id,c,x,V]),b.useCallback(async()=>{if(!(!(t!=null&&t.id)||!(c!=null&&c.length)))try{const r=await fetch(`/api/thumbnails/${t.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:c,width:V.width,height:V.height,quality:95,scale:4,dpi:300})});if(r.ok){const o=await r.json();if(o.success&&o.thumbnails){const a={};o.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(a[l.page_id]=l.thumbnail_url)}),se(l=>({...l,...a}))}}}catch(r){console.warn("⚠️ Error generando todos los thumbnails:",r)}},[t==null?void 0:t.id,c,V]);const Gn=b.useCallback(async(r=null)=>{if(!(t!=null&&t.id)||!(c!=null&&c.length))return{};try{const o={},a={};let l=0;const u=async(p,g)=>new Promise(m=>{const E=new Image;E.onload=()=>{a[g]=p,l++,r==null||r(l,c.length),m(!0)},E.onerror=()=>{console.warn(`⚠️ [ALBUM-MODAL] Thumbnail no encontrado: ${p}`),l++,r==null||r(l,c.length),m(!1)},E.src=p}),d=c.map(async(p,g)=>{let m;const E=s&&(s.has_cover_image===!0||s.has_cover_image===1),M=s&&(s.has_back_cover_image===!0||s.has_back_cover_image===1),L=E&&c.some(A=>A.type==="cover"),U=M&&c.some(A=>A.type==="final");if(p.type==="cover")m=0;else if(p.type==="content")L?m=c.filter(F=>F.type==="content").findIndex(F=>F.id===p.id)+1:m=c.filter(F=>F.type==="content").findIndex(F=>F.id===p.id)+1;else if(p.type==="final"){const A=c.filter(F=>F.type==="content");m=A.length+1}else m=g;const _=`/storage/images/thumbnails/${t.id}/page-${m}-pdf.png`,H=p.id||`page-${g}`;return o[H]=_,u(_,H)});return await Promise.all(d),o}catch(o){return console.warn("⚠️ [ALBUM-MODAL] Error cargando thumbnails PDF:",o),{}}},[t==null?void 0:t.id,c,s]);b.useEffect(()=>{if(T&&s&&i){if(T.pages&&Array.isArray(T.pages)){const r=T.pages.map(o=>{let a=null,l=i.background_color||"#ffffff";return o.type==="cover"&&(s.has_cover_image===!0||s.has_cover_image===1)?s.cover_image&&(a=`/storage/images/item/${s.cover_image}`):o.type==="content"?s.content_image&&(a=`/storage/images/item/${s.content_image}`):(o.type==="final"||o.type==="contraportada")&&(s.has_back_cover_image===!0||s.has_back_cover_image===1)&&s.back_cover_image&&(a=`/storage/images/item/${s.back_cover_image}`),{...o,backgroundImage:a,backgroundColor:l}}).filter(o=>!(o.type==="cover"&&(s.has_cover_image===!1||s.has_cover_image===0)||(o.type==="final"||o.type==="contraportada")&&(s.has_back_cover_image===!1||s.has_back_cover_image===0)));ee(o=>o.length>0?o.map((a,l)=>{const u=r[l];return u?{...a,backgroundImage:a.backgroundImage||u.backgroundImage,backgroundColor:a.backgroundColor||u.backgroundColor}:a}):r),Xe(o=>o.length<=1?[JSON.stringify(r)]:o),Ve(o=>o===0&&ke.length<=1?0:o),setTimeout(()=>{jt()},100)}else{const r=mr(i,s);ee(r),Xe([JSON.stringify(r)]),Ve(0),setTimeout(()=>{jt()},100)}typeof T.currentPage=="number"&&Q(T.currentPage),T.workspaceSize&&Se(T.workspaceSize)}},[T,s,i,jt]);const Le=pa(c,t,s,i,V,oe),ar=()=>{if(i!=null&&i.width&&(i!=null&&i.height)){let g=i.width,m=i.height,E=g*37.8,M=m*37.8;if(E&&M){const L=window.innerWidth*.6,U=window.innerHeight*.7,_=L/E,H=U/M,A=Math.min(_,H,1);return{width:Math.round(E*A),height:Math.round(M*A),originalWidth:g,originalHeight:m,scale:A,unit:"cm",originalWidthPx:Math.round(E),originalHeightPx:Math.round(M)}}}if(i!=null&&i.extra_settings)try{const g=typeof i.extra_settings=="string"?JSON.parse(i.extra_settings):i.extra_settings;if(g!=null&&g.canvas_config){const m=g.canvas_config;let E=m.width,M=m.height,L=E*37.8,U=M*37.8;if(L&&U){const _=window.innerWidth*.6,H=window.innerHeight*.7,A=_/L,D=H/U,F=Math.min(A,D,1);return{width:Math.round(L*F),height:Math.round(U*F),originalWidth:E,originalHeight:M,scale:F,unit:"cm",originalWidthPx:Math.round(L),originalHeightPx:Math.round(U)}}}}catch(g){console.warn("Error parsing extra_settings:",g)}const r={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},o=r[ie]||r.preset,a=Fe?1200:window.innerWidth*.6,l=Fe?800:window.innerHeight*.7,u=a/o.width,d=l/o.height,p=Math.min(u,d,1);return{width:Math.round(o.width*p),height:Math.round(o.height*p),originalWidth:o.width,originalHeight:o.height,scale:p,unit:"px"}},Me=b.useCallback(async(r={type:"thumbnail"})=>{var o;if(Fe)return Ye("🚫 [VPS-PROTECTION] captureCurrentWorkspace bloqueado en servidor"),null;if(!c[x])return null;try{let a=document.querySelector(`#page-${c[x].id}`);if(!a)return console.warn("❌ THUMBNAIL: No se encontró el elemento de página específico"),null;const l=c[x],d=(l==null?void 0:l.cells)&&l.cells.length>0&&a.classList.contains("grid");Ne(`🔧 [CAPTURE-MODE] Página ${x}: ${d?"LAYOUT":"LIBRE"}, Celdas: ${((o=l==null?void 0:l.cells)==null?void 0:o.length)||0}`),d&&await new Promise(D=>{requestAnimationFrame(()=>{const F=a.querySelectorAll("[data-cell-id]");D()})});const p=r.type==="pdf",g=!0,m=p?11.81:g?2:3,E=1,M=getComputedStyle(a);let L=(l==null?void 0:l.backgroundColor)||"#ffffff";M.backgroundColor&&M.backgroundColor!=="rgba(0, 0, 0, 0)"&&(L=M.backgroundColor);const U={scale:m,useCORS:!0,allowTaint:!1,backgroundColor:L,width:V.width,height:V.height,x:0,y:0,scrollX:0,scrollY:0,...d&&{windowWidth:V.width,windowHeight:V.height,ignoreElements:A=>{var D;return A.style&&A.style.filter&&r.preserveFilters?!1:(D=A.classList)==null?void 0:D.contains("exclude-from-capture")}},...!d&&{ignoreElements:A=>{var D;return A.style&&A.style.filter&&r.preserveFilters?!1:(D=A.classList)==null?void 0:D.contains("exclude-from-capture")}},foreignObjectRendering:!!(p||d),removeContainer:!1,logging:!!(d&&!g),imageTimeout:p?6e4:d?g?15e3:3e4:15e3,pixelRatio:p?3:g||Fe?1:window.devicePixelRatio||1,...d&&{allowTaint:!0,useCORS:!0,letterRendering:!g,ignoreElements:A=>{var D,F;return((D=A.classList)==null?void 0:D.contains("exclude-from-capture"))||((F=A.classList)==null?void 0:F.contains("ui-element"))}},canvas:p?document.createElement("canvas"):null,windowWidth:p?V.width*m:null,windowHeight:p?V.height*m:null,onclone:async A=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(F=>{try{A.querySelectorAll(F).forEach(Ee=>Ee.remove())}catch(Y){console.warn("Error removing selector:",F,Y)}});try{const F=A.querySelector(`#page-${c[x].id}`);if(F){if(F.style.width=V.width+"px",F.style.height=V.height+"px",d||(F.style.position="relative"),F.style.overflow="hidden",l!=null&&l.backgroundImage&&(F.style.backgroundImage=`url(${l.backgroundImage})`,F.style.backgroundSize="cover",F.style.backgroundPosition="center",F.style.backgroundRepeat="no-repeat"),F.querySelectorAll('[style*="filter"]').forEach(Ee=>{}),d){const Ee=F.className,We=getComputedStyle(a);F.style.display="grid",F.style.gridTemplateColumns=We.gridTemplateColumns,F.style.gridTemplateRows=We.gridTemplateRows,F.style.gap=We.gap,F.querySelectorAll("[data-cell-id]").forEach((Ce,re)=>{const Te=a.querySelector(`[data-cell-id="${Ce.getAttribute("data-cell-id")}"]`);if(Te){const be=getComputedStyle(Te);Ce.style.gridColumn=be.gridColumn,Ce.style.gridRow=be.gridRow,Ce.style.position="relative"}Ce.querySelectorAll('img, [data-element-type="image"]').forEach(be=>{be.style.position==="absolute"&&(be.style.position="absolute")})})}l!=null&&l.backgroundColor&&(F.style.backgroundColor=l.backgroundColor)}}catch(F){console.error("❌ [THUMBNAIL-FIX] Error configurando elemento de página:",F)}try{const F=new Map;a.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((re,Te)=>{if(re.complete&&re.naturalWidth>0){const be=(re.closest('[data-element-type="image"]')||re.parentElement).getBoundingClientRect(),qe=re.getBoundingClientRect();F.set(re.src,{src:re.src,naturalWidth:re.naturalWidth,naturalHeight:re.naturalHeight,containerWidth:be.width,containerHeight:be.height,objectFit:getComputedStyle(re).objectFit||"cover",objectPosition:getComputedStyle(re).objectPosition||"center",crossOrigin:re.crossOrigin})}});const Ee=async(re,Te,xe,be,qe)=>new Promise(ut=>{try{const ot=Te/xe,Mt=be/qe;let gt,ht,$t,Ft,ln,cn;Mt>ot?(cn=xe,ln=xe*Mt,ht=qe,gt=qe*ot,$t=(be-gt)/2,Ft=0):(ln=Te,cn=Te/Mt,gt=be,ht=be/ot,$t=0,Ft=(qe-ht)/2);const mt=A.createElement("canvas");mt.width=Te,mt.height=xe;const lo=mt.getContext("2d"),at=new Image;at.crossOrigin="anonymous",at.onload=()=>{try{lo.drawImage(at,$t,Ft,gt,ht,0,0,Te,xe);const Bt=mt.toDataURL("image/png",1);re.src=Bt,re.style.objectFit="fill",re.style.objectPosition="center",re.style.width="100%",re.style.height="100%",ut()}catch(Bt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en canvas processing:",Bt),ut()}},at.onerror=()=>{console.warn("⚠️ [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),ut()},at.src=re.src}catch(ot){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",ot),ut()}}),We=A.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),$e=[];We.forEach((re,Te)=>{if(re.src&&F.has(re.src)){const xe=F.get(re.src),be=re.closest('[data-element-type="image"]')||re.parentElement;if(be&&(be.style.overflow="hidden",be.style.position="relative"),xe.objectFit==="cover"||re.classList.contains("object-cover")||re.classList.contains("workspace-image")){const qe=Ee(re,xe.containerWidth,xe.containerHeight,xe.naturalWidth,xe.naturalHeight);$e.push(qe)}else re.style.width="100%",re.style.height="100%",re.style.objectFit="fill"}}),$e.length>0&&await Promise.all($e);const Ce=A.createElement("style");Ce.textContent=`
                            /* CORRECCIÓN THUMBNAIL: Estructura del elemento de página */
                            #page-${c[x].id} {
                                width: ${V.width}px !important;
                                height: ${V.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* 🖨️ IMÁGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya están recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${p?`
                                /* 🖨️ IMPRESIÓN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de página */
                            #page-${c[x].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* 🖨️ OPTIMIZACIONES GENERALES PARA PDF DE IMPRESIÓN */
                            ${p?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,A.head.appendChild(Ce)}catch(F){console.error("❌ [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",F);const Y=A.createElement("style");Y.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,A.head.appendChild(Y)}}};let _=null,H="";try{if(_=await un(a,U),p&&_){const A=_.getContext("2d");if(A){A.imageSmoothingEnabled=!1,A.imageSmoothingQuality="high";const D=A.getImageData(0,0,_.width,_.height),F=D.data;for(let Y=0;Y<F.length;Y+=4)F[Y]=Math.min(255,F[Y]*1.05),F[Y+1]=Math.min(255,F[Y+1]*1.05),F[Y+2]=Math.min(255,F[Y+2]*1.05);A.putImageData(D,0,0)}}if(!_)throw new Error("html2canvas no devolvió un canvas válido para el elemento de página");if(_.width===0||_.height===0)throw new Error("Canvas del elemento de página tiene dimensiones inválidas");H=_.toDataURL("image/png",E)}catch(A){throw console.error("❌ [ERROR-CAPTURA]:",A),A}finally{if(_){const A=_.getContext("2d");A&&A.clearRect(0,0,_.width,_.height),_.width=0,_.height=0,_=null}if(g&&window.gc)try{window.gc()}catch{}}if(!H||H==="data:,")throw new Error("No se pudo generar dataURL del elemento de página");return p?_:H}catch(a){console.error("❌ [THUMBNAIL-FIX] Error capturando elemento de página:",a);try{const l=document.createElement("canvas"),u=r.type==="pdf"?11.81:1;l.width=V.width*u,l.height=V.height*u;const d=l.getContext("2d"),p=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return d.fillStyle=p,d.fillRect(0,0,l.width,l.height),d.fillStyle=p==="#ffffff"||p.includes("white")?"#374151":"#666666",d.font=`${14*u}px Arial`,d.textAlign="center",d.fillText("Página "+(x+1),l.width/2,l.height/2),r.type==="pdf"?l:l.toDataURL("image/png",1)}catch{return null}}},[x,c]);b.useCallback(async()=>{if(!c[x])return;const r=await Me({type:"thumbnail"});r&&se(o=>({...o,[c[x].id]:r}))},[Me,x,c]),b.useCallback(()=>{clearTimeout(Zt.current),Zt.current=setTimeout(()=>{c[x]&&(se(r=>{const o={...r};return delete o[c[x].id],o}),setTimeout(()=>{le()},200))},1e3)},[c,x,le]);const Wn=b.useCallback(()=>{c[x]&&(se(r=>{const o={...r};return delete o[c[x].id],o}),setTimeout(()=>{le()},300))},[c,x,le]),qn=b.useCallback(async(r=x,o={width:800,height:600})=>{var a,l;if(!c[r])return null;try{const u=x;r!==x&&(Q(r),await new Promise(m=>setTimeout(m,100)));const d=document.querySelector(`#page-${c[r].id}`);if(!d)return console.warn("Workspace element not found for page:",c[r].id),null;const p={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((a=c[r])==null?void 0:a.backgroundColor)||"#ffffff",width:d.offsetWidth,height:d.offsetHeight,removeContainer:!0,logging:!1,onclone:m=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(_=>{m.querySelectorAll(_).forEach(A=>A.remove())});const M=m.querySelector(`#page-${c[r].id}`);if(M){const _=c[r];_!=null&&_.backgroundImage&&(M.style.backgroundImage=`url(${_.backgroundImage})`,M.style.backgroundSize="cover",M.style.backgroundPosition="center",M.style.backgroundRepeat="no-repeat"),_!=null&&_.backgroundColor&&(M.style.backgroundColor=_.backgroundColor)}try{const _=d.querySelectorAll("img"),H=new Map;_.forEach((D,F)=>{const Y=getComputedStyle(D);H.set(F,{objectFit:Y.objectFit,objectPosition:Y.objectPosition,width:Y.width,height:Y.height,borderRadius:Y.borderRadius,transform:Y.transform})}),m.querySelectorAll("img").forEach((D,F)=>{const Y=H.get(F);Y&&(D.style.objectFit=Y.objectFit||"cover",D.style.objectPosition=Y.objectPosition||"center",D.style.width=Y.width,D.style.height=Y.height,D.style.borderRadius=Y.borderRadius,D.style.transform=Y.transform)})}catch(_){console.warn("Error preservando estilos de imágenes:",_),m.querySelectorAll("img").forEach(A=>{A.style.objectFit="cover",A.style.objectPosition="center",A.style.width||(A.style.width="100%"),A.style.height||(A.style.height="100%")})}m.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(_=>{const H=_.className;H&&(_.className=H);const A=getComputedStyle?getComputedStyle(_):null;A&&(A.fontFamily&&A.fontFamily!=="Arial"&&(_.style.fontFamily=A.fontFamily),A.fontSize&&(_.style.fontSize=A.fontSize),A.fontWeight&&(_.style.fontWeight=A.fontWeight),A.fontStyle&&(_.style.fontStyle=A.fontStyle))});const U=m.createElement("style");U.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CRÍTICO: Asegurar que las imágenes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CRÍTICO: Asegurar que los backgrounds de página se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,m.head.appendChild(U)}},g=await un(d,p);if(o.width!==g.width||o.height!==g.height){const m=document.createElement("canvas");m.width=o.width,m.height=o.height;const E=m.getContext("2d"),M=g.width/g.height,L=o.width/o.height;let U,_,H=0,A=0;M>L?(U=o.width,_=o.width/M,A=(o.height-_)/2):(_=o.height,U=o.height*M,H=(o.width-U)/2),E.fillStyle=((l=c[r])==null?void 0:l.backgroundColor)||"#ffffff",E.fillRect(0,0,o.width,o.height),E.drawImage(g,H,A,U,_);const D=m.toDataURL("image/png",1);return r!==u&&Q(u),D}return r!==u&&Q(u),g.toDataURL("image/png",1)}catch(u){return console.error("❌ Error generando thumbnail de alta calidad:",u),null}},[c,x,Q]);b.useEffect(()=>{const r=ar();er(r)},[i,ie]),b.useEffect(()=>{const r=()=>{const o=ar();er(o)};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[i,ie]),b.useEffect(()=>{if(!Fe&&c[x]&&!oe[c[x].id]){const r=setTimeout(()=>{le()},500);return()=>clearTimeout(r)}},[x,c,oe,le]),b.useEffect(()=>{const r=c[x];r!=null&&r.backgroundImage&&fetch(r.backgroundImage,{method:"HEAD"}).then(o=>{o.ok||console.error("❌ [WORKSPACE] Imagen NO existe en el servidor. Status:",o.status)}).catch(o=>{console.error("❌ [WORKSPACE] Error verificando imagen:",o)})},[x,(vr=c[x])==null?void 0:vr.backgroundImage]),b.useEffect(()=>{const r=`${V.width}x${V.height}`,o=sessionStorage.getItem("lastWorkspaceDimensions");o&&o!==r&&c.length>0&&(se({}),setTimeout(()=>{c[x]&&Wn()},800)),sessionStorage.setItem("lastWorkspaceDimensions",r)},[V.width,V.height]),b.useEffect(()=>{if(!(t!=null&&t.id)||c.length===0)return;let r,o=Date.now(),a=!1;const l=()=>{a=!0,o=Date.now()},u=async()=>{if(a)try{setAutoSave(m=>({...m,saveStatus:"saving"}));const p=await fetch(`/api/projects/${t.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:c,force:!1})}),g=await p.json();if(p.ok&&g.success)a=!1,C(m=>({...m,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1}));else throw new Error("Guardado falló")}catch(p){console.error("❌ [AUTO-SAVE] Error en guardado silencioso:",p),C(g=>({...g,saveStatus:"error",saveError:p.message}))}},d=()=>{r=setInterval(()=>{const p=Date.now()-o;a&&p>6e4&&u()},3*60*1e3)};return JSON.stringify(c),c[x],l(),d(),()=>{r&&clearInterval(r)}},[c,x,t==null?void 0:t.id]),b.useEffect(()=>{var o;if(!c[x])return;const r=((o=c[x].cells)==null?void 0:o.flatMap(a=>a.elements))||[];JSON.stringify(r),C(a=>({...a,hasUnsavedChanges:!0}))},[(yr=c[x])==null?void 0:yr.cells,x]);const[Sa,_t]=b.useState(!1),[ja,Dn]=b.useState({elementId:null,cellId:null}),[Kn,sr]=b.useState(!1),[ka,Jn]=b.useState(!1),[Aa,_a]=b.useState(null),[Yn,Xn]=b.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[He,ve]=b.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de álbum...",subMessage:"Preparando tu vista previa personalizada"}),It=b.useRef(null),ir=r=>{var l,u,d,p;const o=q||((u=(l=c[x])==null?void 0:l.cells[0])==null?void 0:u.id);if(!o)return;const a={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:r,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((p=(d=c[x].cells.find(g=>g.id===o))==null?void 0:d.elements)==null?void 0:p.length)||0)+1};nt(o,a),ae.success("Imagen añadida correctamente")},Rt=b.useCallback(vt(async(r=!1)=>{if(!(t!=null&&t.id))return;const o=it.get(t.id);if(!r&&o&&o.length>0){Pe.length===0&&Ge(o);return}if(W.current&&clearTimeout(W.current),!(St&&!r)){Jt(!0);try{const a=new AbortController,l=setTimeout(()=>a.abort(),1e4),u=await fetch(`/api/canvas/projects/${t.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:a.signal});if(clearTimeout(l),!u.ok)throw new Error(`HTTP ${u.status}: ${u.statusText}`);const d=await u.json();if(d.success){const p=d.images||[],g=JSON.stringify(Pe),m=JSON.stringify(p);g!==m&&(Ge(p),zn(E=>{const M=new Map(E);if(M.set(t.id,p),M.size>5){const L=M.keys().next().value;M.delete(L)}return M}))}else console.error("Error cargando imágenes:",d.message),ae.error("Error cargando galería de imágenes")}catch(a){a.name==="AbortError"?console.warn("⚠️ Carga de imágenes cancelada por timeout"):(console.error("Error cargando imágenes del proyecto:",a),ae.error("Error de conexión al cargar imágenes"))}finally{Jt(!1)}}},200),[t==null?void 0:t.id,it,Pe,St]),Qn=b.useCallback(async r=>{const o=r.target.files[0];if(!o||!(t!=null&&t.id))return;const a=ae.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),l=URL.createObjectURL(o),u={id:`temp-${Date.now()}`,filename:o.name,url:l,thumbnail_url:l,has_thumbnail:!1,size:o.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Ge(p=>[u,...p]),ir(l);const d=new FormData;d.append("image",o),d.append("projectId",t.id);try{const g=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:d})).json();if(g.success){const m={id:g.id||Date.now(),filename:o.name,url:g.url,thumbnail_url:g.thumbnail_url||g.url,has_thumbnail:g.has_thumbnail||!1,size:o.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Ge(E=>[m,...E.filter(M=>M.id!==u.id)]),setTimeout(()=>{ee(E=>{const M=[...E];return M[x].cells.forEach(U=>{U.elements.forEach(_=>{_.type==="image"&&_.content===l&&(_.content=g.url)})}),M})},100),ae.dismiss(a),ae.success(g.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{Rt(!0)},2e3)}else Ge(m=>m.filter(E=>E.id!==u.id)),URL.revokeObjectURL(l),ae.dismiss(a),ae.error(g.message||"Error al subir la imagen")}catch(p){console.error("Error subiendo la imagen:",p),Ge(g=>g.filter(m=>m.id!==u.id)),URL.revokeObjectURL(l),ae.dismiss(a),ae.error("Error de red al subir la imagen")}},[t==null?void 0:t.id,x,ir,Rt]);b.useEffect(()=>{if(t!=null&&t.id){const r=it.get(t.id);if(r&&r.length>0){Ge(r);return}return W.current=setTimeout(()=>{Rt(!1)},150),()=>{W.current&&clearTimeout(W.current)}}},[t==null?void 0:t.id,it]),b.useEffect(()=>()=>{W.current&&clearTimeout(W.current)},[]);const lr=(r,o)=>{if(!c||c.length===0||!c[x]){console.error("❌ [ADD-IMAGE] No hay páginas válidas para agregar imagen");return}const a=JSON.parse(JSON.stringify(c));let l=!1;for(let u=0;u<a[x].cells.length;u++)if(a[x].cells[u].id===r){a[x].cells[u].elements.push(o),l=!0;break}if(!l){console.error("❌ [ADD-IMAGE] Celda no encontrada:",r);return}setTimeout(()=>{rt(a)},0)},Zn=b.useCallback(r=>{var p,g,m,E;const o=lt;et(!0);const a=X==="images",l=q||((g=(p=c[x])==null?void 0:p.cells[0])==null?void 0:g.id);if(!l){console.error("❌ [ADD-FROM-GALLERY] No hay celda disponible"),ae.error("No hay celda disponible para agregar la imagen"),et(o);return}if(!r||typeof r!="string"){console.error("❌ [ADD-FROM-GALLERY] URL de imagen inválida"),ae.error("URL de imagen no válida"),et(o);return}const u=JSON.parse(JSON.stringify(c)),d={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:r,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((E=(m=u[x].cells.find(M=>M.id===l))==null?void 0:m.elements)==null?void 0:E.length)||0)+1};setTimeout(()=>{lr(l,d),setTimeout(()=>{a&&he("images"),setTimeout(()=>{et(o),ae.success("✅ Imagen añadida desde la galería")},50)},50)},50)},[X,q,c,x,lt,lr]),cr=b.useCallback(async(r,o)=>{var u,d;const a=[],l=[];for(const p of r){const g={...p};if(p.cells){g.cells=[];for(const m of p.cells){const E={...m};if(m.elements){E.elements=[];for(const M of m.elements)if(M.type==="image"&&((u=M.content)!=null&&u.startsWith("data:image/"))){const L=`${M.id}_${Date.now()}`,U=M.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(U){const _=U[1],H=U[2],D=`${L}.${_==="jpeg"?"jpg":_}`;l.push({filename:D,data:H,type:_,elementId:M.id}),E.elements.push({...M,content:M.content,_wasBase64:!0,_originalSize:M.content.length,_elementId:M.id})}else E.elements.push(M)}else E.elements.push(M)}g.cells.push(E)}}a.push(g)}if(l.length>0)try{const p=await fetch(`/api/canvas/projects/${o}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((d=document.querySelector('meta[name="csrf-token"]'))==null?void 0:d.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:l})});if(p.ok){const g=await p.json();if(g.uploadedImages){const m=new Map;g.uploadedImages.forEach(E=>{m.set(E.elementId,E.url)});for(const E of a)if(E.cells){for(const M of E.cells)if(M.elements)for(const L of M.elements)L._wasBase64&&L._elementId&&m.has(L._elementId)&&(L.content=m.get(L._elementId),delete L._elementId)}}}else{const g=await p.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("❌ [IMAGE-UPLOAD] Error subiendo imágenes:",g),r}}catch(p){return console.error("❌ [IMAGE-UPLOAD] Error de red subiendo imágenes:",p),r}return a},[]),tt=b.useCallback(async(r=c,o=!1)=>{var a;if(!(!(t!=null&&t.id)||!o&&r.length===0))try{const d={design_data:{pages:await cr(r,t.id),currentPage:x,workspaceDimensions:V,workspaceSize:ie,selectedElement:z,selectedCell:q,history:ke.slice(-5),historyIndex:Math.min(Ae,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:t.id,name:(s==null?void 0:s.name)||"Álbum Personalizado",item_id:s==null?void 0:s.id,preset_id:i==null?void 0:i.id}},thumbnails:oe},g=JSON.stringify(d).length/(1024*1024),m=await fetch(`/api/canvas/projects/${t.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(d)});if(m.ok){const E=await m.json(),M=`editor_progress_project_${t.id}`;return localStorage.removeItem(M),P(L=>{const U=new Map(L);return o?U.clear():U.delete(x),U}),c&&c.length>0&&setTimeout(()=>{le().catch(L=>{console.warn("⚠️ Error regenerando thumbnail de página actual:",L)})},300),!0}else{const E=await m.json().catch(()=>({message:"Error desconocido"}));return console.error("❌ [AUTO-SAVE] Error guardando en BD:",E),!1}}catch(l){return console.error("❌ [AUTO-SAVE] Error en auto-save con procesamiento de imágenes:",l),!1}},[c,x,V,ie,t==null?void 0:t.id,s==null?void 0:s.name,s==null?void 0:s.id,i==null?void 0:i.id,cr,At]);b.useEffect(()=>{if(!(t!=null&&t.id))return;const r=setInterval(()=>{c.length>0&&tt(c,!1)},10*60*1e3);return()=>clearInterval(r)},[tt,c,t==null?void 0:t.id]),b.useCallback(async()=>{if(!c.length)return{};const r={},o=x;try{for(let a=0;a<c.length;a++){const l=c[a];if(l!=null&&l.id)try{a!==x&&(Q(a),await new Promise(d=>setTimeout(d,300)));const u=await Me({type:"thumbnail"});u&&(r[l.id]=u)}catch(u){console.warn(`⚠️ [THUMBNAILS] Error capturando thumbnail para página ${l.id}:`,u),oe[l.id]&&(r[l.id]=oe[l.id])}}return o!==x&&Q(o),r}catch(a){return console.error("❌ [THUMBNAILS] Error capturando thumbnails:",a),o!==x&&Q(o),oe}},[c,x,Q,Me,oe]);const dr=b.useCallback(async()=>{if(!(t!=null&&t.id)||c.length===0)return ae.error("No hay datos para guardar"),!1;try{return await le(),await or(),await tt(c,!0)?(ae.success("Progreso guardado exitosamente"),!0):(ae.error("Error al guardar el progreso"),!1)}catch(r){return console.error("❌ [SAVE] Error al guardar el progreso:",r),ae.error("Error al guardar el progreso"),!1}},[tt,c,t==null?void 0:t.id,V,i,At]),ur=b.useCallback(async r=>{var o;if(!(t!=null&&t.id))return Ye("❌ [QUEUE-SAVE] No hay project ID"),!1;if(!r||r.length===0)return Ye("❌ [QUEUE-SAVE] No hay páginas para guardar"),!1;try{const l={design_data:{pages:r,currentPage:x,workspaceDimensions:V,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:oe};wt("📤 [QUEUE-SAVE] Enviando petición al servidor...");const u=await fetch(`/api/canvas/projects/${t.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(l)});if(wt("📥 [QUEUE-SAVE] Respuesta del servidor:",u.status,u.statusText),u.ok){const d=await u.json();return wt("✅ [QUEUE-SAVE] Guardado exitoso desde cola:",d),!0}else{const d=await u.text();return Ye("❌ [QUEUE-SAVE] Error en respuesta del servidor:",u.status,d),!1}}catch(a){return a("❌ [QUEUE-SAVE] Error guardando desde cola:",a),!1}},[t==null?void 0:t.id,x,V,oe]),Pt=b.useCallback(async()=>{if(!O&&k.length!==0){R(!0);try{const r=k.slice();B([]);for(const o of r)await ur(o.pages)?P(l=>{const u=new Map(l);return u.delete(o.pageIndex),u}):(console.error("❌ [SAVE-QUEUE] Error guardando página:",o.pageIndex),B(l=>[...l,o]))}catch(r){console.error("❌ [SAVE-QUEUE] Error procesando cola:",r)}finally{R(!1)}}},[O,k,ur]);b.useEffect(()=>{k.length>0&&!O&&setTimeout(()=>{Pt()},100)},[k.length,O,Pt]),b.useEffect(()=>{},[k,O]);const gr=b.useCallback((r,o)=>{P(a=>(Array.from(a.keys()),a.has(r)&&B(l=>{const u=l.findIndex(d=>d.pageIndex===r);if(u!==-1){const d=[...l];return d[u]={pageIndex:r,pages:o,timestamp:Date.now()},d}else return[...l,{pageIndex:r,pages:o,timestamp:Date.now()}]}),a))},[]),Ot=b.useCallback(async r=>{r!==x&&(P(o=>{const a=Array.from(o.keys());return wt("🔍 [PAGE-CHANGE] Páginas con cambios:",a.join(", ")||"ninguna"),o.has(x)&&gr(x,c),o}),Q(r))},[x,c,gr]),Je=()=>`editor_progress_project_${t==null?void 0:t.id}`,hr=b.useCallback(async()=>{var o,a,l,u;if(!(!(t!=null&&t.id)||c.some(d=>{var p;return(p=d.cells)==null?void 0:p.some(g=>{var m;return((m=g.elements)==null?void 0:m.length)>0})})))try{const d=Le.loadFromLocalStorage(),p=await fetch(`/api/canvas/projects/${t.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let g=null;if(p.ok){const E=await p.json();E.success&&((o=E.data)!=null&&o.design_data)&&(g=E.data)}let m=null;if(d&&g){const E=new Date(d.savedAt).getTime(),M=new Date(g.saved_at).getTime();m=E>M?d:g}else d?m=d:g&&(m=g);if(m&&(((a=m.pages)==null?void 0:a.length)>0||((u=(l=m.design_data)==null?void 0:l.pages)==null?void 0:u.length)>0)){const E=new Date(m.savedAt||m.saved_at).getTime();Date.now()-E<30*60*1e3&&(ae.info("🔄 Cargando progreso guardado automáticamente..."),eo(m))}}catch(d){console.error("❌ [RECOVERY] Error verificando progreso guardado:",d)}},[t==null?void 0:t.id,Le,c]),eo=b.useCallback(async r=>{var o;try{let a=[];if(r.pages?a=r.pages:(o=r.design_data)!=null&&o.pages&&(a=r.design_data.pages),a.length>0){ee(a);const l=[JSON.stringify(a)];Xe(l),Ve(0),setTimeout(()=>{se({})},100),ae.success("✅ Progreso cargado exitosamente"),Jn(!1)}}catch(a){console.error("❌ [RECOVERY] Error cargando progreso:",a),ae.error("Error al cargar el progreso guardado")}},[ee,Xe,Ve,se]);b.useCallback(async()=>{try{const r=Le.getStorageKey();localStorage.removeItem(r),ae.success("Progreso anterior eliminado")}catch(r){console.error("❌ [RECOVERY] Error descartando progreso:",r)}},[Le]),b.useEffect(()=>{t&&s&&i&&(!(T!=null&&T.pages)||T.pages.length===0)&&mr(i,s)},[t,s,i,T]),b.useEffect(()=>{t!=null&&t.id&&!v&&c.length===0&&!lt&&(et(!0),setTimeout(()=>{hr()},500))},[t==null?void 0:t.id,v,c.length,hr,lt]),b.useEffect(()=>(ne.current&&clearTimeout(ne.current),t!=null&&t.id&&c.length>0&&(ne.current=setTimeout(()=>{or()},500)),()=>{ne.current&&clearTimeout(ne.current)}),[t==null?void 0:t.id,c.length]);const mr=(r,o)=>{try{const a=[],l=o.pages||r.pages||20;if(o.has_cover_image===!0||o.has_cover_image===1){const p=o.cover_image?`/storage/images/item/${o.cover_image}`:null,g=o.cover_image?null:r.background_color||"#ffffff",m={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:p,backgroundColor:g,cells:[{id:"cell-cover-1",elements:[]}]};a.push(m)}const u=o.content_image?`/storage/images/item/${o.content_image}`:null,d=o.content_image?null:r.background_color||"#ffffff";for(let p=1;p<=l;p++){const g={id:`page-content-${p}`,type:"content",pageNumber:p,layout:"layout-1",backgroundImage:u,backgroundColor:d,cells:[{id:`cell-content-${p}-1`,elements:[]}]};a.push(g)}if(o.has_back_cover_image===!0||o.has_back_cover_image===1){const p=o.back_cover_image?`/storage/images/item/${o.back_cover_image}`:null,g=o.back_cover_image?null:r.background_color||"#ffffff",m={id:"page-final",type:"final",layout:"layout-1",backgroundImage:p,backgroundColor:g,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};a.push(m)}ee(a),Q(0),r.width&&r.height&&Se("preset")}catch(a){console.error("❌ Error creating pages:",a),j(a.message)}},pr=b.useCallback(r=>{var d,p;if(!r||r.length===0)return[];const o=r.filter(g=>g.type==="cover"),a=r.filter(g=>g.type==="content"),l=r.filter(g=>g.type==="final");if(o.length===0&&l.length===0)return r;const u=[];return o.length>0&&(u.push(...o),u.push({id:`blank-page-cover-back-${Date.now()}`,type:"blank",isBlankPage:!0,hasLogo:!0,logoUrl:"/assets/resources/logo.png",cells:[],backgroundColor:"#ffffff",layout:((d=ce[0])==null?void 0:d.id)||"layout1"})),a.length>0&&u.push(...a),l.length>0&&(u.length%2===1&&u.push({id:`blank-page-before-back-${Date.now()}`,type:"blank",isBlankPage:!0,cells:[],backgroundColor:"#ffffff",layout:((p=ce[0])==null?void 0:p.id)||"layout1"}),u.push(...l)),u},[ce]),me=b.useMemo(()=>s?{cover:c.filter(r=>r.type==="cover"&&(s.has_cover_image===!0||s.has_cover_image===1)),content:c.filter(r=>r.type==="content"),final:c.filter(r=>r.type==="final"&&(s.has_back_cover_image===!0||s.has_back_cover_image===1))}:{cover:c.filter(r=>r.type==="cover"),content:c.filter(r=>r.type==="content"),final:c.filter(r=>r.type==="final")},[c,s]),fe=b.useCallback(()=>{if(!s)return console.warn("⚠️ [CONTENT-TYPE] itemData no disponible, usando tipo por defecto"),{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"};const r=s.has_cover_image===!0||s.has_cover_image===1,o=s.has_back_cover_image===!0||s.has_back_cover_image===1,a=r&&me.cover.length>0,l=o&&me.final.length>0,u=me.content.length;return a&&l?{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"}:a||l?{type:"booklet",name:"Folleto",description:"Vista de Folleto",icon:"📋",experience:"booklet"}:u>1?{type:"catalog",name:"Catálogo",description:"Vista de Catálogo",icon:"📑",experience:"catalog"}:{type:"card",name:"Diseño",description:"Vista Previa",icon:"🎨",experience:"single"}},[me,s])(),te=b.useCallback(()=>{if(!z||!q||c.length===0)return null;const r=c[x];if(!r)return null;const o=r.cells.find(a=>a.id===q);return o?o.elements.find(a=>a.id===z):null},[z,q,c,x]),fr=(r,o)=>{if(o){const a=c[x].cells.find(u=>u.id===o),l=a==null?void 0:a.elements.find(u=>u.id===r);if(l!=null&&l.locked){const u=document.createElement("div");u.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",u.textContent="Este elemento es parte del diseño base y no se puede editar",document.body.appendChild(u),setTimeout(()=>{document.body.contains(u)&&document.body.removeChild(u)},3e3);return}}if(o&&de(o),Z(r),r){const a=c[x].cells.find(u=>u.id===(o||q)),l=a==null?void 0:a.elements.find(u=>u.id===r);(l==null?void 0:l.type)==="image"?Kt(l):(l==null?void 0:l.type)==="text"?(_t(!0),Dn({elementId:r,cellId:o||q}),X!=="filters"&&X!=="images"&&he("text")):_t(!1)}else _t(!1),Kt(null)},_e=()=>{if(c.length===0)return ce[0];const r=c[x];if(!r)return ce[0];const o=ce.find(l=>l.id===r.layout)||ce[0],a=o.cellStyles&&Object.values(o.cellStyles).some(l=>l.includes("col-span-")||l.includes("row-span-"));return{...o,isComplex:a,pageId:r.id}},br=b.useCallback(vt(r=>{try{const o=Je(),a={pages:r,currentPage:x,savedAt:Date.now()},l=JSON.stringify(a),u=Math.round(l.length/1024);u<2048?localStorage.setItem(o,l):(console.warn(`⚠️ Datos demasiado grandes para localStorage (${u} KB)`),localStorage.removeItem(o))}catch(o){if(console.error("❌ Error guardando en localStorage:",o),o.name==="QuotaExceededError")try{localStorage.removeItem(Je())}catch(a){console.error("Error limpiando localStorage:",a)}}},300),[x,Je]),rt=b.useCallback(r=>{ee(o=>{if(o===r)return o;const a=JSON.stringify(o),l=JSON.stringify(r);return a===l?o:(requestAnimationFrame(()=>{if(P(u=>{const d=new Map(u);return d.set(x,Date.now()),d}),r[x]){const u=r[x].id;se(d=>{if(d[u]){const p={...d};return delete p[u],p}return d})}}),setTimeout(()=>{Xe(u=>{const d=[...u.slice(0,Ae+1),l];return d.length>50?d.slice(-50):d}),Ve(u=>{const d=u+1;return d>50?49:d})},0),r)}),br(r)},[x,Ae,br]);b.useEffect(()=>{try{const r=Je(),o={pages:c,currentPage:x,savedAt:Date.now()},a=JSON.stringify(o),l=Math.round(a.length/1024);l<2048?localStorage.setItem(r,a):console.warn(`⚠️ Datos demasiado grandes para localStorage (${l} KB), saltando guardado`)}catch(r){if(console.error("❌ Error guardando currentPage en localStorage:",r),r.name==="QuotaExceededError")try{const o=Je();localStorage.removeItem(o)}catch(o){console.error("Error limpiando localStorage:",o)}}},[x,c,Je]);const to=r=>{const o=ce.find(d=>d.id===r);if(!o)return;const a=[...c],l=a[x],u=Array.from({length:o.cells}).map((d,p)=>l.cells[p]||{id:`cell-${l.id}-${p+1}`,elements:[]});a[x]={...l,layout:r,cells:u},rt(a),Z(null),de(null)},nt=(r,o)=>{const a=[...c];for(let l=0;l<a[x].cells.length;l++)a[x].cells[l].id===r&&a[x].cells[l].elements.push(o);rt(a),Z(o.id),de(r)},xr=b.useCallback(vt(()=>{P(r=>{const o=new Map(r);return o.set(x,Date.now()),o})},100),[x]),ge=b.useCallback((r,o,a,l=!1)=>{ee(u=>{const d=[...u],p=d[x].cells.findIndex(g=>g.id===r);if(p===-1)return u;if(l){const g=d[x].cells[p].elements.find(m=>m.id===o);if(!g)return u;d[x].cells[p].elements.push({...g,...a})}else{const g=d[x].cells[p].elements.findIndex(L=>L.id===o);if(g===-1)return u;const m=d[x].cells[p].elements[g];if(!Object.keys(a).some(L=>{const U=m[L],_=a[L];return typeof _=="object"&&typeof U=="object"?JSON.stringify(U)!==JSON.stringify(_):U!==_}))return u;const M={...m,...a};d[x].cells[p].elements[g]=M,(a.filters||a.mask)&&(window.FORCE_THUMBNAIL_REGENERATION&&(window.thumbnailCache={}),le(!0).then(()=>{window.FORCE_THUMBNAIL_REGENERATION&&window.forceRegenerateThumbnail&&setTimeout(()=>{try{window.forceRegenerateThumbnail()}catch(L){console.error("❌ [FORZADO-EMERGENCIA] Error en regeneración secundaria:",L)}},150)}).catch(L=>{console.error("❌ [AUTO-REGEN] Error regenerando thumbnail:",L)}))}return d}),a.position||a.size?requestAnimationFrame(()=>{P(u=>{if(u.has(x))return u;const d=new Map(u);return d.set(x,Date.now()),d})}):xr()},[x,xr]),ro=b.useCallback(()=>{const r=_e();return console.log("🧪 [TEST] Layout actual:",r),console.log("🧪 [TEST] Es complejo:",r.isComplex),console.log("🧪 [TEST] CellStyles:",r.cellStyles),le(!0),`✅ Test ejecutado para layout: ${r.id} (complejo: ${r.isComplex})`},[_e,le]);window.testComplexLayoutThumbnail=ro,b.useCallback(()=>{var o;if(Fe){Ye("🚫 [VPS-PROTECTION] forceRegenerateThumbnail bloqueado en servidor");return}window.thumbnailCache&&(window.thumbnailCache={}),window.THUMBNAIL_PROTECTED=!0,window._protectedThumbnailIds||(window._protectedThumbnailIds=[]);const r=(o=c[x])==null?void 0:o.id;r&&!window._protectedThumbnailIds.includes(r)&&window._protectedThumbnailIds.push(r),window.BLOCK_AUTO_REGENERATION=!0,le(!0),setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1},1e4)},[le]),b.useCallback(()=>{z&&q&&ge(q,z,{filters:{brightness:100,contrast:100,saturation:0,opacity:100}})},[z,q,ge]),b.useCallback(()=>{window.THUMBNAIL_PROTECTED=!0,window.PERMANENT_THUMBNAIL_LOCK=!0,window.BLOCK_AUTO_REGENERATION=!1,window._protectedThumbnailIds=Object.keys(oe);const r=window.forceRegenerateThumbnail;window.forceRegenerateThumbnail=(...o)=>window._userInitiated?(window._userInitiated=!1,r(...o)):!1,window._allowNextRegeneration=()=>{window._userInitiated=!0},window.safeRegenerateThumbnail=()=>{window._allowNextRegeneration(),window.forceRegenerateThumbnail()},window._thumbnailBackup={...oe},alert(`🔒 Miniaturas protegidas exitosamente!

Si necesitas regenerar una miniatura específica, usa window.safeRegenerateThumbnail() en la consola.`)},[oe]),b.useCallback(()=>{window.FORCE_FILTER_APPLICATION=!0,window.ENABLE_ADVANCED_FILTER_RENDERING=!0,window.thumbnailCache&&window.thumbnailCache.clear(),Ht&&Ht();const r=c[x];r&&r.cells&&r.cells.forEach(o=>{o.elements&&o.elements.forEach(a=>{a.filters&&(a._hasRealFilters=!0,a.pageId=r.id)})}),le(!0)},[c,x,le]);const dt=(r,o)=>{const a=[...c],l=a[x].cells.findIndex(u=>u.id===r);l!==-1&&(a[x].cells[l].elements=a[x].cells[l].elements.filter(u=>u.id!==o),rt(a),z===o&&Z(null))},no=(r,o,a)=>{const l=[...c],u=l[x].cells.findIndex(d=>d.id===r);if(u!==-1){const d=l[x].cells[u].elements,p=d.findIndex(g=>g.id===o);if(p!==-1){const g=a==="up"?p+1:p-1;if(g>=0&&g<d.length){const m=d[p];d[p]=d[g],d[g]=m,rt(l)}}}},oo=()=>{Ae>0&&(Ve(Ae-1),ee(JSON.parse(ke[Ae-1])),Z(null),de(null))},ao=()=>{Ae<ke.length-1&&(Ve(Ae+1),ee(JSON.parse(ke[Ae+1])),Z(null),de(null))},Lt=(r="body")=>{const o=`text-${Date.now()}`,a={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},l={heading:"Título Principal",subheading:"Subtítulo",body:"Haz clic para editar"},u={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},d={id:o,type:"text",content:l[r],position:{x:.05,y:.05},size:u[r],style:a[r]};q&&nt(q,d)},wr=b.useMemo(()=>{var u;const r=c[x];if(!r)return null;const o=((u=r.cells)==null?void 0:u.flatMap(d=>d.elements||[]))||[],a=o.map(d=>({id:d.id,type:d.type,position:d.position,size:d.size}));return{pageId:r.id,elementsCount:o.length,contentHash:JSON.stringify(a).substring(0,100),backgroundImage:r.backgroundImage,backgroundColor:r.backgroundColor,layout:r.layout}},[c,x]);b.useEffect(()=>{var p;if(Fe)return;const r=c[x];if(!r)return;const o=r.id;if(((p=r==null?void 0:r.cells)==null?void 0:p.some(g=>{var m;return(m=g.elements)==null?void 0:m.some(E=>E.filters&&(E.filters.brightness!==100||E.filters.contrast!==100||E.filters.saturation!==100||E.filters.tint!==0||E.filters.hue!==0))}))&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(o)||window._protectedThumbnailIds.push(o)),c.length===0||v||!wr)return;let l=!1;const u=async()=>{var g;if(!(window.PREVENT_THUMBNAIL_RESET||window.THUMBNAIL_PROTECTED))try{const m=c[x];if(!m||!m.id)return;const E=m.id;if(!window.PREVENT_THUMBNAIL_RESET&&!window.THUMBNAIL_PROTECTED&&se(_=>{const H={..._};return delete H[E],H}),await new Promise(_=>setTimeout(_,100)),l)return;const M=(g=m==null?void 0:m.cells)==null?void 0:g.some(_=>{var H;return(H=_.elements)==null?void 0:H.some(A=>A.filters&&(A.filters.brightness!==100||A.filters.contrast!==100||A.filters.saturation!==100||A.filters.tint!==0||A.filters.hue!==0))}),U=await Me(M?{type:"thumbnail",preserveFilters:!0}:{type:"thumbnail"});U&&!l?(se(_=>({..._,[E]:U})),M&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(E)||window._protectedThumbnailIds.push(E))):console.warn("⚠️ [DEBUG] No se pudo generar miniatura para:",E)}catch(m){l||console.error("❌ [DEBUG] Error regenerando miniatura:",m)}},d=setTimeout(()=>{u()},500);return()=>{l=!0,clearTimeout(d)}},[x,wr,v,Me]),b.useEffect(()=>{if(window.BLOCK_AUTO_REGENERATION||c.length===0||v)return;const r=async()=>{if(window.BLOCK_AUTO_REGENERATION)return;const a=c.filter(l=>!oe[l.id]);if(a.length!==0)for(const l of a)try{const u=document.createElement("canvas");u.width=200,u.height=150;const d=u.getContext("2d");if(d.fillStyle=l.backgroundColor||"#ffffff",d.fillRect(0,0,200,150),l.backgroundImage)try{const g=new Image;g.crossOrigin="anonymous",await new Promise((m,E)=>{g.onload=m,g.onerror=E,g.src=l.backgroundImage}),d.drawImage(g,0,0,200,150)}catch(g){console.warn("No se pudo cargar imagen de fondo para miniatura:",g)}l.cells&&l.cells.forEach(g=>{g.elements&&g.elements.forEach(m=>{var E;m.type==="text"&&m.content&&(d.fillStyle=((E=m.style)==null?void 0:E.color)||"#000000",d.font="12px Arial",d.fillText(m.content.substring(0,20)+(m.content.length>20?"...":""),10,30))})});const p=u.toDataURL("image/jpeg",.7);se(g=>({...g,[l.id]:p})),await new Promise(g=>setTimeout(g,300))}catch(u){console.error("❌ Error generando miniatura de fondo para:",l.id,u)}},o=setTimeout(()=>{r()},2e3);return()=>clearTimeout(o)},[c,oe,v]),b.useEffect(()=>{const r=o=>{const a=$.current,l=J.current;if(a.length>0||l.size>0)return o.preventDefault(),o.returnValue="Hay cambios sin guardar. ¿Estás seguro de que quieres salir?",o.returnValue};return window.addEventListener("beforeunload",r),()=>{window.removeEventListener("beforeunload",r)}},[]),b.useEffect(()=>()=>{},[]);const so=async()=>{var r;try{if(!s||!i||!(t!=null&&t.id))return!1;await tt(c,!0)||console.warn("⚠️ No se pudo guardar el progreso, pero continuando...");const a={design_data:{id:t.id,title:(s==null?void 0:s.name)||"Álbum Personalizado",pages:c,workspace_dimensions:V,created_at:new Date().toISOString()},item_data:{id:s==null?void 0:s.id,name:(s==null?void 0:s.name)||(s==null?void 0:s.title),price:s==null?void 0:s.price,user_id:s==null?void 0:s.user_id,width:s==null?void 0:s.width,height:s==null?void 0:s.height},preset_data:{id:i==null?void 0:i.id,width:i==null?void 0:i.width,height:i==null?void 0:i.height,cover_image:i==null?void 0:i.cover_image,content_layer_image:i==null?void 0:i.content_layer_image,final_layer_image:i==null?void 0:i.final_layer_image},dimensions:{width_mm:(i==null?void 0:i.width)||(s==null?void 0:s.width)||210,height_mm:(i==null?void 0:i.height)||(s==null?void 0:s.height)||297,workspace_width:(V==null?void 0:V.width)||800,workspace_height:(V==null?void 0:V.height)||600}};try{const M=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:t.id,status:"ready_for_pdf",pdf_data:a,completed_at:new Date().toISOString()})});if(M.ok){const L=await M.json()}else console.warn("⚠️ Error marcando proyecto como completado")}catch(M){console.warn("⚠️ Error en marcado de completado:",M)}const l=Date.now(),u=t.id;window.currentProjectId=u,window.albumProjectId=u;let d=i.cover_image;oe&&oe["page-cover"]&&(d=oe["page-cover"]);let p=d;d&&d.startsWith("data:image/")&&d.length>1e5&&(p=i.cover_image||"/assets/img/default-album.jpg");const g={...s,project_id:u,canvas_project_id:t.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:i.width,height_mm:i.height,pages_count:c.length,workspace_dimensions:V,requires_pdf_generation:!0}},m=structuredClone(ue),E=m.findIndex(M=>M.id==g.id);return E==-1?m.push({...g,quantity:1}):m[E].quantity++,ye(m),ae.success("Álbum agregado al carrito",{description:`${g.name} se ha añadido al carrito. El PDF se generará en el backend.`,icon:e.jsx(ko,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:m,action:"add",product:g}})),!0}catch(o){return console.error("❌ === ERROR EN addAlbumToCart ==="),console.error("Error completo:",o),console.error("Stack trace:",o.stack),console.error("Mensaje del error:",o.message),ae.error("Error al agregar al carrito",{description:`Error específico: ${o.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!c||c.length===0)throw new Error("No hay páginas para finalizar");const a={design_data:{pages:(L=>L.map(U=>({id:U.id,type:U.type,pageNumber:U.pageNumber,layout:U.layout,cells:U.cells.map(_=>({id:_.id,elements:_.elements.map(H=>{const A={id:H.id,type:H.type,position:H.position,zIndex:H.zIndex||1};if(H.type==="image"){if(H.content.startsWith("data:image/")){const D=btoa(H.content.substring(0,100)).substring(0,20);A.content=`[BASE64_IMAGE_${D}]`,A.contentType=H.content.split(";")[0].split(":")[1],A.originalSize=H.content.length}else A.content=H.content;if(H.filters){const D=Object.entries(H.filters).filter(([F,Y])=>Y!==0&&Y!==!1&&Y!==null).reduce((F,[Y,Ee])=>(F[Y]=Ee,F),{});Object.keys(D).length>0&&(A.filters=D)}H.mask&&H.mask!=="none"&&(A.mask=H.mask),H.size&&(A.size=H.size),H.locked&&(A.locked=H.locked)}else if(H.type==="text"&&(A.content=H.content,H.style)){const D=Object.entries(H.style).filter(([F,Y])=>!(F==="fontSize"&&Y==="16px"||F==="color"&&Y==="#000000"||F==="fontFamily"&&Y==="Arial")).reduce((F,[Y,Ee])=>(F[Y]=Ee,F),{});Object.keys(D).length>0&&(A.style=D)}return A})}))})))(c),projectInfo:{id:t==null?void 0:t.id,item_id:s==null?void 0:s.id,title:s==null?void 0:s.title,preset_id:i==null?void 0:i.id},presetInfo:{id:i==null?void 0:i.id,name:i==null?void 0:i.name,cover_image:i==null?void 0:i.cover_image,content_image:i==null?void 0:i.content_image,back_cover_image:i==null?void 0:i.back_cover_image},workspace:{width:V.width,height:V.height,scale:V.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(oe).map(([L,U])=>[L,U]))},l=JSON.stringify(a),u=Math.round(l.length/1024),d=Math.round(u/1024*100)/100;let p=0,g=0;c.forEach(L=>{var U;(U=L.cells)==null||U.forEach(_=>{var H;(H=_.elements)==null||H.forEach(A=>{A.type==="image"&&A.content&&A.content.startsWith("data:image/")&&(p++,g+=A.content.length)})})});const m=Math.round(g/(1024*1024)*100)/100;if(u>1024&&!confirm(`El diseño contiene ${p} imágenes (${m} MB en imágenes). Payload completo: ${d} MB. Esto podría causar problemas al guardarlo. ¿Desea continuar de todos modos?`))return!1;const E=await fetch(`/api/canvas/projects/${t.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:l});if(!E.ok){let L="Error al finalizar el diseño";try{L=(await E.json()).message||L}catch{E.status===413?L="El diseño es demasiado grande para ser guardado. Intente simplificar las imágenes.":E.status>=500&&(L="Error del servidor. Intente nuevamente más tarde.")}throw new Error(L)}const M=await E.json();return!0}catch(r){console.error("Error al finalizar diseño:",r);let o=r.message;return r.message.includes("Failed to fetch")?o="Error de conexión. Verifique su conexión a internet e intente nuevamente.":(r.message.includes("NetworkError")||r.message.includes("net::"))&&(o="Error de red. Intente nuevamente más tarde."),alert("Error al finalizar el diseño: "+o),!1}};const io=b.useCallback(async()=>{try{const{jsPDF:r}=await Cn(async()=>{const{jsPDF:D}=await import("./jspdf.es.min-D3plwuQr.js").then(F=>F.j);return{jsPDF:D}},__vite__mapDeps([0,1,2,3,4]));let o=(i==null?void 0:i.width)||21,a=(i==null?void 0:i.height)||29.7;const l=.3,u=o+l*2,d=a+l*2,p=u*28.35,g=d*28.35,m=new r({orientation:p>g?"landscape":"portrait",unit:"pt",format:[p,g],compress:!1}),E=c.length;let M=0;const L=document.createElement("div");L.id="pdf-progress",L.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",L.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${E} páginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(L);const U=D=>{const F=D/E*100;document.getElementById("pdf-progress-bar").style.width=`${F}%`,document.getElementById("current-page").textContent=D},_=x;for(let D=0;D<c.length;D++){const F=c[D];Q(D),await new Promise(Y=>setTimeout(Y,500));try{const Y=await Me({type:"pdf"});if(Y){const Ee=Y.width/Y.height,We=p/g;let $e,Ce,re=0,Te=0;Ee>We?($e=p,Ce=p/Ee,Te=(g-Ce)/2):(Ce=g,$e=g*Ee,re=(p-$e)/2);const xe=Y.toDataURL("image/png",1);D>0&&m.addPage([p,g]),m.addImage(xe,"PNG",re,Te,$e,Ce)}else console.warn(`⚠️ No se pudo capturar la página ${D+1}`),D>0&&m.addPage([p,g]),m.setFontSize(12),m.text(`Error al renderizar página ${D+1}`,p/2,g/2,{align:"center"})}catch(Y){console.error(`❌ Error procesando página ${D+1}:`,Y),D>0&&m.addPage([p,g]),m.setFontSize(12),m.text(`Error al procesar página ${D+1}`,p/2,g/2,{align:"center"})}M++,U(M),await new Promise(Y=>setTimeout(Y,200))}Q(_);const H=`${(s==null?void 0:s.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;m.save(H),document.body.removeChild(L);const A=document.createElement("div");return A.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",A.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${H}</span>
                </div>
            `,document.body.appendChild(A),setTimeout(()=>{document.body.contains(A)&&document.body.removeChild(A)},5e3),H}catch(r){console.error("❌ Error generando PDF:",r);const o=document.getElementById("pdf-progress");o&&document.body.removeChild(o);const a=document.createElement("div");throw a.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",a.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${r.message}</span>
                </div>
            `,document.body.appendChild(a),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},7e3),r}},[c,x,Q,Me,i,s]);return window.generateAlbumPDF=io,window.generateHighQualityThumbnail=qn,window.captureCurrentWorkspace=Me,window.regenerateCurrentThumbnailNow=()=>{var o;const r=(o=c[x])==null?void 0:o.id;if(r){const a=c[x];let l=!1;a&&a.cells&&a.cells.forEach(u=>{u.elements&&u.elements.forEach(d=>{d.filters&&(d.filters.brightness!==100||d.filters.contrast!==100||d.filters.saturation!==100||d.filters.tint!==0||d.filters.hue!==0||d.filters.blur>0||d.filters.opacity!==100||d.filters.scale!==1||d.filters.rotate!==0||d.filters.flipHorizontal||d.filters.flipVertical)&&(l=!0,d._hasRealFilters=!0)})}),l&&(window.PRESERVE_FILTERS_FOR_PAGE=r,window.FORCE_FILTER_APPLICATION=!0),se(u=>{const d={...u};return delete d[r],d})}return setTimeout(()=>{le(!0),setTimeout(()=>{window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},100),"✅ Miniatura regenerada con éxito!"},window.generateThumbnailWithFilters=()=>{window.FORCE_FILTER_APPLICATION=!0;const r=Date.now();return window._filterCacheBreaker=r,window.regenerateCurrentThumbnailNow(),setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1},1e3),"✅ Miniatura con filtros regenerada exitosamente"},window.forceRegenerateWithGuaranteedFilters=async()=>{var o,a;const r=c[x];if(!r||!V)return console.error("❌ [RADICAL] Datos no disponibles"),!1;try{window._filterVerificationDone&&window._filterVerificationDone.clear(),window._currentPageData=r,window._workspaceDimensions=V,window._updateThumbnailInUI=(u,d)=>{se(p=>({...p,[u]:d}))};const l=await ft(r,V);return l?(((o=r.elements)==null?void 0:o.some(d=>d.filters?Object.keys(d.filters).some(p=>p==="flipHorizontal"||p==="flipVertical"?d.filters[p]:p==="brightness"||p==="contrast"||p==="saturation"||p==="opacity"||p==="scale"?d.filters[p]!==1:p==="tint"||p==="hue"||p==="blur"||p==="rotate"?d.filters[p]!==0:!1):!1))&&((a=window.protectThumbnail)==null||a.call(window,r.id)),se(d=>({...d,[r.id]:l})),!0):!1}catch(l){return console.error("❌ [RADICAL] Error:",l),!1}},window.safeRegenerateThumbnail=()=>(window._filterVerificationDone&&window._filterVerificationDone.clear(),le(!0),"✅ Regeneración segura completada"),e.jsxs(co,{backend:uo,className:"!h-screen !w-screen overflow-hidden",children:[v?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu álbum personalizado..."})]})}):I?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:I}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):c.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando páginas del álbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx("style",{children:`
                        /* Solo aplicar overflow visible en modo edición (no en preview ni captura) */
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] {
                            overflow: visible !important;
                        }
                        
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] > div {
                            overflow: visible !important;
                        }
                        
                        /* Mantener overflow hidden solo para el contenedor principal para evitar scroll */
                        .editor-workspace:not(.preview-mode) #page-${(Er=c[x])==null?void 0:Er.id} {
                            overflow: visible !important;
                        }
                        
                        /* En preview mode y captura, mantener overflow hidden para el resultado final */
                        .preview-mode [data-element-type="image"],
                        .capture-mode [data-element-type="image"] {
                            overflow: hidden !important;
                        }
                    `}),e.jsx(vo,{isOpen:Kn,onRequestClose:()=>{sr(!1),Xn({isLoading:!1,loadedImages:0,totalImages:0,message:""}),ve({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:(()=>{if(!s){console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible, enviando todas las páginas");const a=me.cover.concat(me.content,me.final).map(l=>({...l,layout:ce.find(u=>u.id===l.layout)||ce[0]}));return pr(a)}let r=[];(s.has_cover_image===!0||s.has_cover_image===1)&&(r=r.concat(me.cover)),r=r.concat(me.content),(s.has_back_cover_image===!0||s.has_back_cover_image===1)&&(r=r.concat(me.final));const o=r.map(a=>({...a,layout:ce.find(l=>l.id===a.layout)||ce[0]}));return pr(o)})(),pageThumbnails:(()=>{if(!s)return console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible para filtrar thumbnails"),oe;const r={};let o=[];return(s.has_cover_image===!0||s.has_cover_image===1)&&(o=o.concat(me.cover.map(a=>a.id))),o=o.concat(me.content.map(a=>a.id)),(s.has_back_cover_image===!0||s.has_back_cover_image===1)&&(o=o.concat(me.final.map(a=>a.id))),o.forEach(a=>{oe[a]&&(r[a]=oe[a])}),r})(),workspaceDimensions:V,getCurrentLayout:r=>r?ce.find(o=>o.id===r.layout)||ce[0]:ce[0],presetData:i,addAlbumToCart:so,projectData:t,itemData:s,contentType:fe,categorizedPages:me,albumLoadingState:Yn}),He.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-He.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:He.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:He.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${He.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[He.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(No,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:oo,disabled:Ae<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(go,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:ao,disabled:Ae>=ke.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(ho,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(t==null?void 0:t.name)||"Álbum Sin Título",onChange:r=>n({...t,name:r.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del diseño"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(k.length>0||O)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:O?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",k.length]})]})}),e.jsx(fa,{saveStatus:Le.saveStatus,lastSaved:Le.lastSaved,lastAutoSaved:Le.lastAutoSaved,hasUnsavedChanges:w.hasUnsavedChanges||!!(S instanceof Map&&S.has(x)),isOnline:Le.isOnline,saveError:Le.saveError,onManualSave:dr,saveQueueSize:k.length,isProcessingQueue:O,pageChangesCount:S instanceof Map?S.size:0}),k.length>0&&e.jsxs("button",{onClick:()=>{Pt()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(jn,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(pt,{id:"preview-button",variant:"secondary",size:"sm",onClick:async r=>{r.preventDefault(),r.stopPropagation();try{ve({isOpen:!0,phase:"saving",progress:0,message:"💾 Guardando cambios",subMessage:"Asegurando que todo esté actualizado..."});try{await dr(),ve(g=>({...g,progress:15,message:"✅ Cambios guardados",subMessage:"Preparando vista previa..."})),await new Promise(g=>setTimeout(g,500))}catch(g){console.error("❌ [AUTO-SAVE] Error al guardar:",g),ve(m=>({...m,progress:10,message:"⚠️ Guardado parcial",subMessage:"Continuando con vista previa..."})),await new Promise(m=>setTimeout(m,300))}ve(g=>({...g,phase:"preparing",progress:15,message:`${fe.icon} Creando tu ${fe.name.toLowerCase()}`,subMessage:fe.type==="album"?"Preparando la experiencia completa de tu álbum...":fe.type==="catalog"?"Organizando tu catálogo de contenido...":fe.type==="booklet"?"Preparando tu folleto personalizado...":"Optimizando tu diseño único..."}));const o=fe.type==="album"?["🔧 Encuadernando páginas","📖 Ajustando tapas","✨ Puliendo detalles"]:fe.type==="catalog"?["📑 Organizando contenido","🎨 Optimizando diseño","⚡ Finalizando catálogo"]:fe.type==="booklet"?["📋 Preparando folleto","🖼️ Ajustando formato","✨ Aplicando estilo"]:["🎨 Procesando diseño","⚡ Optimizando calidad","✨ Finalizando vista"];for(let g=15;g<=30;g+=3){await new Promise(E=>setTimeout(E,fe.type==="card"?50:100));const m=Math.floor((g-15)/15*o.length);ve(E=>({...E,progress:g,message:o[Math.min(m,o.length-1)],subMessage:`Progreso: ${g}% - Optimizando para mejor experiencia...`}))}ve(g=>({...g,phase:"processing",message:`📷 Procesando ${fe.name.toLowerCase()}`,subMessage:"Generando vistas de alta calidad..."}));const a=await Gn((g,m)=>{const E=30+g/m*50;ve(M=>({...M,progress:Math.round(E),subMessage:`Procesando imagen ${g} de ${m}...`}))}),u={album:{message:"📖 Encuadernando álbum",sub:"Creando experiencia premium de lectura..."},catalog:{message:"📑 Organizando catálogo",sub:"Preparando navegación fluida..."},booklet:{message:"📋 Finalizando folleto",sub:"Ajustando formato profesional..."},card:{message:"🎨 Puliendo diseño",sub:"Aplicando toques finales..."}}[fe.type];ve(g=>({...g,phase:"finalizing",message:u.message,subMessage:u.sub}));for(let g=80;g<=100;g+=4)await new Promise(m=>setTimeout(m,fe.type==="card"?40:80)),ve(m=>({...m,progress:g}));const p={album:{message:"📖 ¡Tu álbum está listo!",sub:"Experiencia completa de lectura preparada"},catalog:{message:"📑 ¡Tu catálogo está listo!",sub:"Navegación profesional activada"},booklet:{message:"📋 ¡Tu folleto está listo!",sub:"Formato profesional completado"},card:{message:"🎨 ¡Tu diseño está listo!",sub:"Vista previa perfecta creada"}}[fe.type];ve(g=>({...g,phase:"ready",progress:100,message:p.message,subMessage:p.sub})),await new Promise(g=>setTimeout(g,1e3)),ve(g=>({...g,isOpen:!1})),se(g=>({...g,...a})),setTimeout(()=>{sr(!0)},300)}catch(o){console.error(`❌ [${fe.type.toUpperCase()}-EXPERIENCE] Error en experiencia:`,o),ve(a=>({...a,message:"⚠️ Ups, algo salió mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{ve(a=>({...a,isOpen:!1}))},2e3)}},disabled:He.isOpen,icon:e.jsx(yt,{className:"h-4 w-4"}),children:He.isOpen?`Creando ${fe.name.toLowerCase()}...`:fe.description}),e.jsxs("button",{onClick:Vn,className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200",title:"Inicia la guía paso a paso",children:[e.jsx(Ro,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"})]})]})]})}),e.jsxs("div",{className:`flex h-full ${z?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>he("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${X==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(yt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Páginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>he("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${X==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(zt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Diseños"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>he("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${X==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ct,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>he("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${X==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Tn,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[X==="templates"&&"Templates",X==="images"&&"Images",X==="text"&&"Text",X==="shapes"&&"Shapes",X==="stickers"&&"Stickers",X==="pages"&&"Pages",X==="panel"&&"Layers Panel",X==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[X==="templates"&&"Choose a template to get started",X==="images"&&"Search for images",X==="text"&&"Add and edit text",X==="shapes"&&"Add shapes and graphics",X==="stickers"&&"Add fun stickers",X==="pages"&&"Manage your pages",X==="panel"&&"Organize layers and z-index",X==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(Oo,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[X==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(zt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(zo,{currentLayoutId:(Cr=c[x])==null?void 0:Cr.layout,onLayoutChange:to})]}),X==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(De,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Imágenes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[Pe.length," imagen",Pe.length!==1?"s":""]})]}),e.jsx(ya,{images:Pe,onImageSelect:Zn,isLoading:St})]}),X==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>Lt("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"Título Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Et,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Lt("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subtítulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Et,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Lt("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(Et,{className:"h-4 w-4"})})]})})]}),X==="text"&&z&&((Tr=te())==null?void 0:Tr.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(Mo,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const r=te();ge(q,z,{style:{...r.style,fontWeight:r.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((Sr=(Nr=te())==null?void 0:Nr.style)==null?void 0:Sr.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const r=te();ge(q,z,{style:{...r.style,fontStyle:r.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((kr=(jr=te())==null?void 0:jr.style)==null?void 0:kr.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const r=te();ge(q,z,{style:{...r.style,textDecoration:r.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((_r=(Ar=te())==null?void 0:Ar.style)==null?void 0:_r.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipografía:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Rr=(Ir=te())==null?void 0:Ir.style)==null?void 0:Rr.fontFamily)||"Arial",onChange:r=>{const o=te();ge(q,z,{style:{...o.style,fontFamily:r.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tamaño:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Or=(Pr=te())==null?void 0:Pr.style)==null?void 0:Or.fontSize)||"16px",onChange:r=>{const o=te();ge(q,z,{style:{...o.style,fontSize:r.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Mr=(Lr=te())==null?void 0:Lr.style)==null?void 0:Mr.color)||"#000000",onChange:r=>{const o=te();ge(q,z,{style:{...o.style,color:r.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((Fr=($r=te())==null?void 0:$r.style)==null?void 0:Fr.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((zr=(Br=te())==null?void 0:Br.style)==null?void 0:zr.backgroundColor)||"#ffffff",onChange:r=>{const o=te();ge(q,z,{style:{...o.style,backgroundColor:r.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const r=te();ge(q,z,{style:{...r.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"🚫"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(r=>{var o,a;return e.jsxs("button",{onClick:()=>{const l=te();ge(q,z,{style:{...l.style,textAlign:r}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((a=(o=te())==null?void 0:o.style)==null?void 0:a.textAlign)===r?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[r==="left"&&"⬅",r==="center"&&"⬌",r==="right"&&"➡",r==="justify"&&"⬍"]},r)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Hr=(Ur=te())==null?void 0:Ur.style)==null?void 0:Hr.lineHeight)||"1.5",onChange:r=>{const o=te();ge(q,z,{style:{...o.style,lineHeight:r.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Gr=(Vr=te())==null?void 0:Vr.style)==null?void 0:Gr.letterSpacing)||"normal",onChange:r=>{const o=te();ge(q,z,{style:{...o.style,letterSpacing:r.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const r=te();ge(q,z,{style:{...r.style,textTransform:r.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((qr=(Wr=te())==null?void 0:Wr.style)==null?void 0:qr.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAYÚS"]}),e.jsxs("button",{onClick:()=>{const r=te();ge(q,z,{style:{...r.style,textTransform:r.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Kr=(Dr=te())==null?void 0:Dr.style)==null?void 0:Kr.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"minús"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((Yr=(Jr=te())==null?void 0:Jr.style)==null?void 0:Yr.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((Qr=(Xr=te())==null?void 0:Xr.style)==null?void 0:Qr.opacity)||"1",onChange:r=>{const o=te();ge(q,z,{style:{...o.style,opacity:r.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((en=(Zr=te())==null?void 0:Zr.style)==null?void 0:en.opacity)||1)*100}%, #e5e7eb ${(((rn=(tn=te())==null?void 0:tn.style)==null?void 0:rn.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),X==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[c.length," total"]})]})}),Ze&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Ze.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Ze.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Ze.message||`Página: ${Ze.pageId||"actual"}`})]}),c.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando páginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[me.cover.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),me.cover.map((r,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===c.indexOf(r)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Ot(c.indexOf(r)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Vt,{pageId:r.id,thumbnail:oe[r.id],altText:"Cover",type:"cover"}),S instanceof Map&&S.has&&S.has(c.indexOf(r))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},r.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:me.content.map((r,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===c.indexOf(r)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>Ot(c.indexOf(r)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Vt,{pageId:r.id,thumbnail:oe[r.id],altText:`Page ${r.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:r.pageNumber}),S instanceof Map&&S.has&&S.has(c.indexOf(r))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},r.id))})]}),me.final.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),me.final.map((r,o)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===c.indexOf(r)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Ot(c.indexOf(r)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(Vt,{pageId:r.id,thumbnail:oe[r.id],altText:"Back Cover",type:"final"}),S instanceof Map&&S.has&&S.has(c.indexOf(r))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},r.id))]})]})]}),X==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Bo,{pages:c,currentPage:x,selectedCell:q,selectedElement:z,onSelectCell:de,onSelectElement:Z,onUpdateElement:(r,o,a)=>{ge(r,o,a)},onDeleteElement:(r,o)=>{dt(r,o)},onMoveElement:(r,o,a)=>{no(r,o,a)}})}),X==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(So,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const r=te();return r&&r.type==="image"?e.jsxs(e.Fragment,{children:[r.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(De,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:r.content,alt:"",className:"w-full h-full object-cover"})})]}),r.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Uo,{selectedMask:r.mask||"none",onSelect:o=>{ge(q,z,{mask:o})},availableMasks:Nn.map(o=>o.id),selectedImage:r})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(mo,{filters:r.filters||{},onFilterChange:o=>{ge(q,z,{filters:o}),setTimeout(()=>{le(!0)},50),setTimeout(()=>{le(!0)},200),setTimeout(()=>{le(!0)},500)},selectedElement:r})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(De,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:te()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>he("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(zt,{className:"h-4 w-4"}),"Diseño de página"]}),e.jsxs("button",{onClick:()=>he("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Ct,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(pt,{variant:"ghost",tooltip:"Añadir Imagen",onClick:()=>It.current&&It.current.click(),children:e.jsx(De,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:It,onChange:Qn,className:"hidden",accept:"image/*"})]}),z&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(pt,{variant:"ghost",size:"sm",onClick:()=>{if(z&&q){const r=te();if(r){const o={...r,id:`${r.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:r.position.x+.05,y:r.position.y+.05}};nt(q,o)}}},className:"h-8 px-2",icon:e.jsx(jo,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(pt,{variant:"ghost",size:"sm",onClick:()=>{z&&q&&dt(q,z)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(Sn,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:`editor-workspace flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100 ${Dt?"preview-mode":""}`,children:Dt?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:V.width,height:V.height},children:e.jsx("div",{id:`page-${c[x].id}`,className:`grid ${_e().template} gap-6`,style:{width:"100%",height:"100%"},children:c[x].cells.map((r,o)=>{var u;const a=_e(),l=va(a,o,V);return e.jsx(dn,{id:r.id,elements:r.elements.filter(d=>!d.locked),workspaceSize:l,cellStyle:(u=_e().cellStyles)==null?void 0:u[c[x].cells.indexOf(r)],selectedElement:q===r.id?z:null,onSelectElement:fr,onAddElement:(d,p)=>nt(p,d),onUpdateElement:(d,p,g)=>ge(r.id,d,p,g),onDeleteElement:d=>dt(r.id,d),availableMasks:_e().maskCategories.flatMap(d=>d.masks),projectData:t},r.id)})})})}):e.jsxs("div",{id:`page-${c[x].id}`,className:" shadow-xl overflow-hidden",style:{width:V.width,height:V.height,position:"relative",backgroundColor:((nn=c[x])==null?void 0:nn.backgroundColor)||"#ffffff",backgroundImage:(on=c[x])!=null&&on.backgroundImage?`url(${c[x].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const r=c[x];return r!=null&&r.backgroundImage?e.jsx("img",{src:r.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):r!=null&&r.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:r.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${_e().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((an=_e().style)==null?void 0:an.gap)||"16px",padding:((sn=_e().style)==null?void 0:sn.padding)||"16px"},children:c[x].cells.map(r=>{var o;return e.jsx(dn,{id:r.id,elements:r.elements.filter(a=>!a.locked),workspaceSize:V,cellStyle:(o=_e().cellStyles)==null?void 0:o[c[x].cells.indexOf(r)],selectedElement:q===r.id?z:null,onSelectElement:fr,onAddElement:(a,l)=>nt(l,a),onUpdateElement:(a,l,u)=>ge(r.id,a,l,u),onDeleteElement:a=>dt(r.id,a),availableMasks:_e().maskCategories.flatMap(a=>a.masks),projectData:t},r.id)})})]})})]})]})]}),e.jsx(wo,{})]})}export{Ns as default};
