import{h as F}from"./thumbnailGenerator-B4goYG9Y.js";const I={preview:{scale:.5,width:200,height:150,quality:.8},high_quality:{scale:4,width:1e3,height:800,quality:1},pdf:{scale:4,width:1e3,height:800,quality:1}},U=(e,o=2e3)=>new Promise(n=>{const t=Date.now(),i=()=>{const r=getComputedStyle(e).gridTemplateColumns!=="none",a=e.children.length>0,l=e.offsetWidth>0&&e.offsetHeight>0;(r||a)&&l?requestAnimationFrame(()=>n(!0)):Date.now()-t>o?(console.warn("‚ö†Ô∏è Timeout esperando renderizado completo"),n(!1)):requestAnimationFrame(i)};i()}),z=(e,o)=>{var t,i;const n={};return n.position=e.style.position,n.transform=e.style.transform,n.zIndex=e.style.zIndex,e.style.position="relative",e.style.transform="translateZ(0)",e.style.zIndex="1",o&&o.template&&(e.style.display="grid",e.style.gridTemplateColumns=o.template.includes("grid-cols-1")?"1fr":o.template.includes("grid-cols-2")?"1fr 1fr":o.template.includes("grid-cols-3")?"1fr 1fr 1fr":o.template.includes("grid-cols-4")?"1fr 1fr 1fr 1fr":o.template.includes("grid-cols-5")?"1fr 1fr 1fr 1fr 1fr":"1fr",e.style.gridTemplateRows=o.template.includes("grid-rows-1")?"1fr":o.template.includes("grid-rows-2")?"1fr 1fr":o.template.includes("grid-rows-3")?"1fr 1fr 1fr":"1fr",(t=o.style)!=null&&t.gap&&(e.style.gap=o.style.gap),(i=o.style)!=null&&i.padding&&(e.style.padding=o.style.padding)),n},O=(e,o)=>{Object.keys(o).forEach(n=>{o[n]?e.style[n]=o[n]:e.style.removeProperty(n)})},j=async e=>{console.log("üßπ [UI-CLEANUP] Removiendo elementos de UI del editor...");const o=["script","iframe","video","audio",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".resize-corner",".resize-edge",".resize-point",".resize-dot",".resize-grip",".resizer",".handle",".drag-handle",".corner-handle",".edge-handle",".element-controls",".element-selector",".element-border",".element-outline",".element-highlight",".selection-box",".selection-outline",".selection-border",".selected-element",".element-overlay",".toolbar",".text-toolbar",".image-toolbar",".element-toolbar",".floating-toolbar",".context-menu",".dropdown",".popover",".tooltip",".menu",".submenu",".overlay",".modal",".dialog",".popup",".floating",".floating-panel",".ui-overlay",".editor-overlay",".sidebar",".panel",".side-panel",".control-panel",".properties-panel",".layers-panel",".btn",".button",".control",".ui-control",".editor-control",".action-button",".icon-button",".indicator",".badge",".label",".tag",".status",".loading",".spinner",".editor-ui",".ui-element",".workspace-ui",".canvas-ui",".edit-mode",".editor-only",".ui-only",'[data-ui="true"]','[data-editor-ui="true"]','[data-exclude-thumbnail="true"]','[data-no-capture="true"]','[data-ui-element="true"]',".dragging",".resizing",".editing",".selected",".active",".hover",".focus",".react-draggable",".react-resizable",".react-grid-item",".absolute.top-0",".absolute.bottom-0",".absolute.left-0",".absolute.right-0",".fixed",".sticky"];let n=0;o.forEach(r=>{try{e.querySelectorAll(r).forEach(l=>{R(l)||(l.remove(),n++)})}catch(a){console.warn(`‚ö†Ô∏è [UI-CLEANUP] Error con selector ${r}:`,a)}}),e.querySelectorAll("*").forEach(r=>{try{const a=r.style,l=getComputedStyle?getComputedStyle(r):null;if(l&&l.cursor==="pointer"&&!["IMG","A","BUTTON"].includes(r.tagName)&&!r.closest("[data-element-type]")){r.remove(),n++;return}if(a.zIndex&&parseInt(a.zIndex)>1e3){r.remove(),n++;return}if(l&&["fixed","sticky"].includes(l.position)){r.remove(),n++;return}}catch{}}),e.querySelectorAll("*").forEach(r=>{try{["onclick","onmouseover","onmouseout","onmousedown","onmouseup","ondrag","ondrop"].forEach(g=>{r.hasAttribute(g)&&r.removeAttribute(g)}),["data-reactid","data-react-checksum","data-reactroot"].forEach(g=>{r.hasAttribute(g)&&r.removeAttribute(g)}),["hover","focus","active","selected","dragging","resizing"].forEach(g=>{r.classList.remove(g)})}catch{}}),e.querySelectorAll("*").forEach(r=>{try{const a=r.getBoundingClientRect(),l=getComputedStyle(r);a.width>0&&a.height>0&&(a.width<10||a.height<10)&&!["IMG","SVG","PATH","CIRCLE"].includes(r.tagName)&&!r.closest("[data-element-type]")&&(r.remove(),n++),l.borderRadius&&(l.borderRadius.includes("50%")||parseInt(l.borderRadius)>20)&&a.width<50&&a.height<50&&!r.closest("[data-element-type]")&&(r.remove(),n++)}catch{}}),console.log(`‚úÖ [UI-CLEANUP] Removidos ${n} elementos de UI del editor`)},R=e=>['[data-element-type="image"]','[data-element-type="text"]','[data-element-type="shape"]',".workspace-content",".page-content",".cell-content","img[src]","[contenteditable]","p","span","div[data-text]","h1","h2","h3","h4","h5","h6"].some(n=>{try{return e.matches(n)||e.closest(n)}catch{return!1}}),$=async(e,o)=>{const n=o.querySelectorAll("img"),t=e.querySelectorAll("img");console.log(`üñºÔ∏è [COVER-FIX] Procesando ${t.length} im√°genes para simular object-fit: cover`),n.length!==t.length&&console.warn(`‚ö†Ô∏è [COVER-FIX] Mismatch: ${n.length} originales vs ${t.length} clonadas`);const i=new Map;n.forEach((s,r)=>{const a=getComputedStyle(s),m=s.parentElement.getBoundingClientRect();i.set(r,{objectFit:a.objectFit,objectPosition:a.objectPosition,containerWidth:m.width,containerHeight:m.height,naturalWidth:s.naturalWidth,naturalHeight:s.naturalHeight,src:s.src})});for(let s=0;s<t.length;s++){const r=t[s],a=i.get(s);if(a)try{a.objectFit==="cover"||r.classList.contains("object-cover")||r.className.includes("object-cover")||r.style.objectFit==="cover"||r.closest('[data-element-type="image"]')||r.closest(".workspace-image")||r.closest(".element-image")?(console.log(`üîß [COVER-FIX] Procesando imagen ${s} con object-fit: cover`),await x(r,a,e)):(r.style.imageRendering="optimizeQuality",r.style.width="100%",r.style.height="100%",a.objectFit&&a.objectFit!=="fill"&&(r.style.objectFit=a.objectFit),a.objectPosition&&(r.style.objectPosition=a.objectPosition))}catch(l){console.warn(`‚ö†Ô∏è [COVER-FIX] Error procesando imagen ${s}:`,l),r.style.imageRendering="optimizeQuality",r.style.objectFit="cover",r.style.width="100%",r.style.height="100%"}}},x=async(e,o,n)=>new Promise(t=>{try{const{containerWidth:i,containerHeight:s,naturalWidth:r,naturalHeight:a}=o;if(!i||!s||!r||!a){console.warn("‚ö†Ô∏è [COVER-FIX] Dimensiones inv√°lidas:",o),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t();return}const l=i/s,m=r/a;let g=0,c=0,h=r,p=a;m>l?(h=a*l,g=(r-h)/2):(p=r/l,c=(a-p)/2);const d=n.createElement("canvas");d.width=i,d.height=s;const u=d.getContext("2d"),y=new Image;y.crossOrigin="anonymous",y.onload=()=>{try{u.drawImage(y,g,c,h,p,0,0,i,s);const f=d.toDataURL("image/png",1);e.src=f,e.style.objectFit="fill",e.style.objectPosition="center",e.style.width="100%",e.style.height="100%",e.style.imageRendering="optimizeQuality",console.log("‚úÖ [COVER-FIX] Imagen simulada con object-fit: cover exitosamente"),t()}catch(f){console.warn("‚ö†Ô∏è [COVER-FIX] Error en canvas processing:",f),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t()}},y.onerror=()=>{console.warn("‚ö†Ô∏è [COVER-FIX] Error cargando imagen temporal"),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t()},y.src=e.src}catch(i){console.warn("‚ö†Ô∏è [COVER-FIX] Error en simulateObjectFitCover:",i),e.style.objectFit="cover",e.style.width="100%",e.style.height="100%",t()}}),b=async(e,o,n={})=>{const t=I[n.type||"preview"];try{const i=document.querySelector(`#page-${e}`);if(!i)return console.error(`‚ùå No se encontr√≥ el elemento de p√°gina: #page-${e}`),null;console.log(`üì∏ Generando thumbnail para p√°gina ${e} con layout:`,o==null?void 0:o.id);const s=z(i,o);await U(i);const r={allowTaint:!0,useCORS:!0,scale:t.scale,width:i.offsetWidth,height:i.offsetHeight,backgroundColor:null,logging:!1,imageTimeout:15e3,removeContainer:!0,ignoreElements:c=>{var f,w,v,C;const p=["resize-handle","resize-control-handle","resize-manipulation-indicator","element-controls","element-selector","toolbar","ui-element","editor-ui","floating","overlay","modal","popup"].some(T=>{var S;return(S=c.classList)==null?void 0:S.contains(T)}),d=((f=c.hasAttribute)==null?void 0:f.call(c,"data-ui"))||((w=c.hasAttribute)==null?void 0:w.call(c,"data-exclude-thumbnail"))||((v=c.hasAttribute)==null?void 0:v.call(c,"data-editor-ui")),u=(C=c.getBoundingClientRect)==null?void 0:C.call(c),y=u&&(u.width<5||u.height<5);return p||d||y},onclone:async c=>{const h=c.querySelector(`#page-${e}`);if(h&&o&&(h.className=`${h.className} grid ${o.template}`,o.style&&Object.keys(o.style).forEach(d=>{h.style[d]=o.style[d]}),o.cellStyles)){const d=h.children;Object.keys(o.cellStyles).forEach(u=>{d[u]&&(d[u].className+=` ${o.cellStyles[u]}`)})}await j(c),await $(c,i);const p=c.createElement("style");p.textContent=`
                    /* üßπ OCULTAR ELEMENTOS DE UI RESTANTES */
                    .resize-handle,
                    .resize-control-handle,
                    .resize-manipulation-indicator,
                    .element-controls,
                    .element-selector,
                    .toolbar,
                    .ui-element,
                    .editor-ui,
                    [data-ui="true"],
                    [data-exclude-thumbnail="true"] {
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                        pointer-events: none !important;
                    }
                    
                    /* üñºÔ∏è OPTIMIZACI√ìN DE IM√ÅGENES */
                    img {
                        image-rendering: optimizeQuality !important;
                        image-rendering: -webkit-optimize-contrast !important;
                        image-rendering: crisp-edges !important;
                        pointer-events: none !important;
                    }
                    
                    /* üì¶ CONTENEDORES DE IMAGEN */
                    [data-element-type="image"] {
                        overflow: hidden !important;
                        position: relative !important;
                    }
                    
                    [data-element-type="image"] img,
                    .workspace-image,
                    .element-image {
                        width: 100% !important;
                        height: 100% !important;
                        display: block !important;
                        pointer-events: none !important;
                    }
                    
                    /* üéØ ELEMENTOS DE TEXTO */
                    [data-element-type="text"],
                    [contenteditable],
                    .text-element {
                        pointer-events: none !important;
                        user-select: none !important;
                        -webkit-user-select: none !important;
                        -moz-user-select: none !important;
                        -ms-user-select: none !important;
                    }
                    
                    /* üìê GRID LAYOUT ESPEC√çFICO */
                    .grid {
                        display: grid !important;
                    }
                    
                    /* üö´ FORZAR OCULTACI√ìN DE ELEMENTOS PROBLEM√ÅTICOS */
                    * {
                        outline: none !important;
                        box-shadow: none !important;
                    }
                    
                    *:hover,
                    *:focus,
                    *:active {
                        outline: none !important;
                        box-shadow: none !important;
                    }
                    
                    /* üé® ASEGURAR CALIDAD VISUAL */
                    * {
                        -webkit-font-smoothing: antialiased !important;
                        -moz-osx-font-smoothing: grayscale !important;
                        text-rendering: optimizeLegibility !important;
                    }
                `,c.head.appendChild(p)}},a=i.querySelectorAll(".resize-handle, .element-controls, .toolbar, .ui-element");a.length>0&&(console.warn(`‚ö†Ô∏è [FINAL-CHECK] Encontrados ${a.length} elementos de UI que podr√≠an aparecer en thumbnail`),a.forEach(c=>{c.style.display="none",c.style.visibility="hidden",c.style.opacity="0"}));const l=await F(i,r);if(O(i,s),!l||l.width===0||l.height===0)throw new Error("Canvas inv√°lido generado");let m=l;if(t.width&&t.height&&(l.width!==t.width||l.height!==t.height)){m=document.createElement("canvas"),m.width=t.width,m.height=t.height;const c=m.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high";const h=l.width/l.height,p=t.width/t.height;let d,u,y=0,f=0;h>p?(d=t.width,u=t.width/h,f=(t.height-u)/2):(u=t.height,d=t.height*h,y=(t.width-d)/2),c.fillStyle="#ffffff",c.fillRect(0,0,t.width,t.height),c.drawImage(l,y,f,d,u)}const g=m.toDataURL("image/png",t.quality);return console.log(`‚úÖ Thumbnail generado exitosamente para p√°gina ${e}`),g}catch(i){return console.error(`‚ùå Error generando thumbnail para p√°gina ${e}:`,i),null}},E=(e,o,n={width:200,height:150})=>{const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const i=t.getContext("2d"),s={cover:"#8B5CF6",content:"#3B82F6",final:"#10B981"};return i.fillStyle=s[o]||"#6B7280",i.fillRect(0,0,n.width,n.height),i.fillStyle="#FFFFFF",i.font="14px Arial",i.textAlign="center",i.fillText(o==="cover"?"Portada":o==="final"?"Contraportada":"P√°gina",n.width/2,n.height/2),t.toDataURL("image/png",.8)},N=async(e,o={width:800,height:600})=>{const n={};console.log(`üì∏ [COMPAT] Generando ${e.length} thumbnails con nueva API...`);try{for(const t of e)try{const i={id:t.layout||"layout-1",template:"grid-cols-1 grid-rows-1",cells:1,style:{gap:"0px",padding:"0px"}},s=await b(t.id,i,{type:"preview",workspaceDimensions:o});if(s)n[t.id]=s,console.log(`‚úÖ [COMPAT] Thumbnail generado para p√°gina ${t.id}`);else{const r=E(t.id,t.type||"content");n[t.id]=r,console.log(`üîÑ [COMPAT] Fallback generado para p√°gina ${t.id}`)}}catch(i){console.error(`‚ùå [COMPAT] Error en p√°gina ${t.id}:`,i);const s=E(t.id,t.type||"content");n[t.id]=s}return console.log(`‚úÖ [COMPAT] Proceso completado. ${Object.keys(n).length}/${e.length} thumbnails generados`),n}catch(t){console.error("‚ùå [COMPAT] Error general en generateAccurateThumbnails:",t);for(const i of e)n[i.id]||(n[i.id]=E(i.id,i.type||"content"));return n}},B=async(e,o)=>(console.log("üîÑ [STUB] generateFastThumbnails llamada, redirigiendo a generateAccurateThumbnails"),N(e,o)),L=async(e,o,n={})=>(console.log(`üîÑ [STUB] generateSingleThumbnail llamada para p√°gina ${e}`),b(e,o,n)),H=()=>{console.log("üßπ [STUB] clearThumbnailCaches llamada")},G=async(e,o,n={})=>(console.log(`üé® [STUB] generateThumbnailWithGuaranteedFilters llamada para p√°gina ${e}`),b(e,o,{...n,type:"high_quality"})),P=e=>{console.log(`üîç [DEBUG] Analizando im√°genes en p√°gina ${e}...`);const o=document.querySelector(`#page-${e}`);if(!o){console.error(`‚ùå [DEBUG] No se encontr√≥ p√°gina ${e}`);return}const n=o.querySelectorAll("img");console.log(`üìä [DEBUG] Encontradas ${n.length} im√°genes en p√°gina ${e}`),n.forEach((t,i)=>{const s=getComputedStyle(t),r=t.parentElement,a=r?r.getBoundingClientRect():null;console.log(`üñºÔ∏è [DEBUG] Imagen ${i}:`,{src:t.src.substring(0,50)+"...",objectFit:s.objectFit,objectPosition:s.objectPosition,naturalWidth:t.naturalWidth,naturalHeight:t.naturalHeight,displayWidth:t.offsetWidth,displayHeight:t.offsetHeight,containerWidth:a==null?void 0:a.width,containerHeight:a==null?void 0:a.height,classes:t.className,parentClasses:r==null?void 0:r.className,hasObjectCover:t.classList.contains("object-cover")||t.className.includes("object-cover"),computedObjectFit:s.objectFit,inlineObjectFit:t.style.objectFit})})};typeof window<"u"&&(window.debugImageCover=P);const A=e=>{console.log(`üîç [DEBUG-UI] Analizando elementos de UI en p√°gina ${e}...`);const o=document.querySelector(`#page-${e}`);if(!o){console.error(`‚ùå [DEBUG-UI] No se encontr√≥ p√°gina ${e}`);return}const n={resizeHandles:o.querySelectorAll(".resize-handle, .resize-control-handle, .resize-manipulation-indicator"),controls:o.querySelectorAll(".element-controls, .element-selector, .toolbar"),overlays:o.querySelectorAll(".overlay, .modal, .popup, .floating"),buttons:o.querySelectorAll(".btn, .button, .control"),uiElements:o.querySelectorAll('.ui-element, .editor-ui, [data-ui="true"]')};return console.log("üìä [DEBUG-UI] Elementos de UI encontrados:",{resizeHandles:n.resizeHandles.length,controls:n.controls.length,overlays:n.overlays.length,buttons:n.buttons.length,uiElements:n.uiElements.length}),Object.entries(n).forEach(([t,i])=>{i.length>0&&console.log(`‚ö†Ô∏è [DEBUG-UI] ${t}:`,Array.from(i).map(s=>({tagName:s.tagName,className:s.className,id:s.id,visible:getComputedStyle(s).display!=="none"})))}),n};typeof window<"u"&&(window.debugUICleanup=A);const k=async e=>{console.log(`üß™ [TEST] Probando limpieza de thumbnail para p√°gina ${e}...`);try{const o=A(e),t=await b(e,{id:"layout-1",template:"grid-cols-1 grid-rows-1"},{type:"preview"});return t?(console.log("‚úÖ [TEST] Thumbnail generado exitosamente"),console.log("üìä [TEST] Elementos de UI encontrados antes de limpieza:",{resizeHandles:o.resizeHandles.length,controls:o.controls.length,overlays:o.overlays.length,buttons:o.buttons.length,uiElements:o.uiElements.length}),{success:!0,thumbnail:t,uiElementsFound:Object.values(o).reduce((i,s)=>i+s.length,0)}):(console.error("‚ùå [TEST] Error generando thumbnail"),{success:!1,error:"No se pudo generar thumbnail"})}catch(o){return console.error("‚ùå [TEST] Error en prueba:",o),{success:!1,error:o.message}}};typeof window<"u"&&(window.testThumbnailCleanup=k);export{L as a,B as b,H as c,G as g};
