const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as io}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as p,R as Wt}from"./index-BH53Isel.js";import{l as ae,D as lo,H as co,U as uo,R as mo,B as pt,F as po}from"./FilterControls-DiQ2YtQP.js";import{h as dn}from"./thumbnailGenerator-B4goYG9Y.js";import{d as go,r as ho,a as un,g as fo,c as bo}from"./dataUrlToBlobUrl-Dt_VdBHQ.js";import{L as yt}from"./layers-6oegOx-p.js";import{C as xo}from"./chevron-down-DS-mdh9v.js";import{C as vo}from"./chevron-right-Ckt5D2ka.js";import{E as wo}from"./eye-CKCH9ORv.js";import{c as ke}from"./createLucideIcon-Cy5Ya80P.js";import{T as Nn}from"./trash-2-DK1wnsDn.js";import{S as yo}from"./star-wPQTHY_n.js";import{T as jn,i as Sn,E as mn,u as Eo}from"./EditorMain-TzD4oLUa.js";import{I as We}from"./image-BEA0kkBS.js";import"./EditorLayout-CbVT4hVv.js";import"./jspdf.es.min-D3plwuQr.js";import{t as re,T as Co}from"./index-BZYhE2TF.js";import{m as pn}from"./main-6DCdASTx.js";import{B as No}from"./V1Edit-DxCbUNhQ.js";import{G as gn}from"./Global-D6eBBAMK.js";import{g as gt,a as hn,b as fn,c as zt}from"./thumbnailGenerator-CvzbIndF.js";import{S as Tn}from"./save-BvSyoVHO.js";import{C as jo}from"./clock-BTrEpQej.js";import{T as So}from"./triangle-alert-vFMqKi4t.js";import{C as To}from"./check-DQ7QoS0v.js";import{L as ko}from"./loader-circle-CrvBvIt1.js";import{C as Ao}from"./chevron-left-B2s3ZsB7.js";import{B as vt}from"./book-BuHIVa2d.js";import{P as wt}from"./plus-Bot15Khs.js";import{F as _o}from"./filter-Ci9tsc_e.js";import{C as Io}from"./copy-6OEekgvq.js";import{C as Oo}from"./circle-check-big-D6DM3vPb.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./index-BSWw-p5k.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Po=ke("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ro=ke("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lo=ke("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mo=ke("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $o=ke("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bo=ke("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=ke("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zo=ke("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uo=ke("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bn=ke("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fo=ke("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Ho=({pages:n,currentPage:l,selectedCell:a,selectedElement:f,onSelectCell:s,onSelectElement:x,onUpdateElement:C,onDeleteElement:T,onMoveElement:y})=>{var J;if(!n||!n[l])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(yt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const v=n[l],k=((J=v==null?void 0:v.cells)==null?void 0:J.filter(R=>R.elements&&R.elements.length>0))||[],[U,N]=p.useState(()=>{const R={};return k.forEach(H=>{R[H.id]=!0}),R}),S=R=>{N(H=>({...H,[R]:!H[R]}))},A=R=>{switch(R){case"image":return e.jsx(We,{className:"h-4 w-4"});case"text":return e.jsx(jn,{className:"h-4 w-4"});case"shape":return e.jsx(Uo,{className:"h-4 w-4"});case"sticker":return e.jsx(yo,{className:"h-4 w-4"});default:return e.jsx(Mo,{className:"h-4 w-4"})}},F=(R,H)=>{switch(R.type){case"text":return R.content?R.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${H+1}`;case"shape":return R.shape||"Shape";case"sticker":return`Sticker ${H+1}`;default:return`Element ${H+1}`}},O=(R,H,ee)=>{C(R,H,{visible:ee})},K=(R,H)=>{s(R),x(H)};return e.jsx("div",{className:"space-y-2",children:k.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(yt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):k.map(R=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${a===R.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{S(R.id),s(R.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:U[R.id]?e.jsx(xo,{className:"h-4 w-4"}):e.jsx(vo,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",R.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[R.elements.length," element",R.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[R.x,", ",R.y]})]}),U[R.id]&&e.jsx("div",{className:"border-t border-gray-100",children:R.elements.map((H,ee)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${f===H.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>K(R.id,H.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:A(H.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:F(H,ee)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[H.type," • Layer ",ee+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:D=>{D.stopPropagation(),O(R.id,H.id,!H.visible)},className:"p-1 hover:bg-gray-200 rounded",title:H.visible?"Hide element":"Show element",children:H.visible!==!1?e.jsx(wo,{className:"h-3 w-3 text-gray-500"}):e.jsx(Bo,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),y(R.id,H.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:ee===R.elements.length-1,children:e.jsx(Ro,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),y(R.id,H.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:ee===0,children:e.jsx(Po,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),T(R.id,H.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(Nn,{className:"h-3 w-3"})})]})]},H.id))})]},R.id))})};function Wo({currentLayoutId:n,onLayoutChange:l}){const[a,f]=p.useState("all"),s={all:{name:"Todos",layouts:ae},hero:{name:"Hero",layouts:ae.filter(x=>x.category==="hero")},editorial:{name:"Editorial",layouts:ae.filter(x=>x.category==="editorial")},storytelling:{name:"Historia",layouts:ae.filter(x=>x.category==="storytelling")},minimal:{name:"Minimal",layouts:ae.filter(x=>x.category==="minimal")},creative:{name:"Creativo",layouts:ae.filter(x=>x.category==="creative")},classic:{name:"Clásico",layouts:ae.filter(x=>x.category==="classic")}};return Object.keys(s).filter(x=>x==="all"||s[x].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:s[a].layouts.map(x=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>l(x.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${x.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:x.cells}).map((C,T)=>{var y,v;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(v=(y=x.cellStyles)==null?void 0:y[T])!=null&&v.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},T)})}),n===x.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:x.name}),x.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:x.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[x.cells," ",x.cells===1?"celda":"celdas"]})})]})]},x.id))}),s[a].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categoría."})})]})}const Vo=({selectedMask:n,onSelect:l,availableMasks:a=[],selectedImage:f})=>{var T,y;const[s,x]=p.useState("Básicas"),C={};return Sn.forEach(v=>{C[v.category]||(C[v.category]=[]),(a.includes(v.id)||v.id==="none")&&C[v.category].push(v)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(C).slice(0,2).map(v=>C[v].length>0&&e.jsx("button",{onClick:()=>x(v),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${s===v?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:v},v))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(T=C[s])==null?void 0:T.slice(0,6).map(v=>e.jsxs("div",{onClick:()=>l(v.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${n===v.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:f!=null&&f.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:v.id==="circle"?"circle(50%)":v.id==="rounded"||v.id==="rounded-sm"?"inset(0 round 8%)":v.id==="rounded-lg"?"inset(0 round 16%)":v.id==="rounded-rect"?"inset(0 round 12%)":v.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":v.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":v.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":v.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":v.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":v.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":v.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":v.id==="frame"?"inset(10% round 10%)":v.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':v.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':v.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:f.content,alt:v.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:v.id==="circle"?"circle(50%)":v.id==="rounded"||v.id==="rounded-sm"?"inset(0 round 8%)":v.id==="rounded-lg"?"inset(0 round 16%)":v.id==="rounded-rect"?"inset(0 round 12%)":v.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":v.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":v.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":v.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":v.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":v.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":v.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":v.id==="frame"?"inset(10% round 10%)":v.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':v.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':v.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:v.name})]},v.id))}),((y=C[s])==null?void 0:y.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver más máscaras (",C[s].length-6," más)"]})]})};let Vt={},kn;function Ft(n={}){Vt={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...n}}function B(n){return n?Vt[n]:Vt}function Go(n){kn=n}function Ne(){return kn}let Et={};function ht(n,l){Et[n]=l}function Ve(n){var l;(l=Et[n])==null||l.call(Et)}function qo(){Et={}}function ft(n,l,a,f){return(n/=f/2)<1?a/2*n*n+l:-a/2*(--n*(n-2)-1)+l}function An(n){const l='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return n.flatMap(a=>{const f=a.matches(l),s=Array.from(a.querySelectorAll(l));return[...f?[a]:[],...s]}).filter(a=>getComputedStyle(a).pointerEvents!=="none"&&Jo(a))}function _n(n){if(!n||Do(n))return;const l=B("smoothScroll"),a=n.offsetHeight>window.innerHeight;n.scrollIntoView({behavior:!l||Ko(n)?"auto":"smooth",inline:"center",block:a?"start":"center"})}function Ko(n){if(!n||!n.parentElement)return;const l=n.parentElement;return l.scrollHeight>l.clientHeight}function Do(n){const l=n.getBoundingClientRect();return l.top>=0&&l.left>=0&&l.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&l.right<=(window.innerWidth||document.documentElement.clientWidth)}function Jo(n){return!!(n.offsetWidth||n.offsetHeight||n.getClientRects().length)}let Ct={};function me(n,l){Ct[n]=l}function V(n){return n?Ct[n]:Ct}function xn(){Ct={}}function Qo(n,l,a,f){let s=V("__activeStagePosition");const x=s||a.getBoundingClientRect(),C=f.getBoundingClientRect(),T=ft(n,x.x,C.x-x.x,l),y=ft(n,x.y,C.y-x.y,l),v=ft(n,x.width,C.width-x.width,l),k=ft(n,x.height,C.height-x.height,l);s={x:T,y,width:v,height:k},On(s),me("__activeStagePosition",s)}function In(n){if(!n)return;const l=n.getBoundingClientRect(),a={x:l.x,y:l.y,width:l.width,height:l.height};me("__activeStagePosition",a),On(a)}function Yo(){const n=V("__activeStagePosition"),l=V("__overlaySvg");if(!n)return;if(!l){console.warn("No stage svg found.");return}const a=window.innerWidth,f=window.innerHeight;l.setAttribute("viewBox",`0 0 ${a} ${f}`)}function Xo(n){const l=Zo(n);document.body.appendChild(l),Ln(l,a=>{a.target.tagName==="path"&&Ve("overlayClick")}),me("__overlaySvg",l)}function On(n){const l=V("__overlaySvg");if(!l){Xo(n);return}const a=l.firstElementChild;if((a==null?void 0:a.tagName)!=="path")throw new Error("no path element found in stage svg");a.setAttribute("d",Pn(n))}function Zo(n){const l=window.innerWidth,a=window.innerHeight,f=document.createElementNS("http://www.w3.org/2000/svg","svg");f.classList.add("driver-overlay","driver-overlay-animated"),f.setAttribute("viewBox",`0 0 ${l} ${a}`),f.setAttribute("xmlSpace","preserve"),f.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),f.setAttribute("version","1.1"),f.setAttribute("preserveAspectRatio","xMinYMin slice"),f.style.fillRule="evenodd",f.style.clipRule="evenodd",f.style.strokeLinejoin="round",f.style.strokeMiterlimit="2",f.style.zIndex="10000",f.style.position="fixed",f.style.top="0",f.style.left="0",f.style.width="100%",f.style.height="100%";const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",Pn(n)),s.style.fill=B("overlayColor")||"rgb(0,0,0)",s.style.opacity=`${B("overlayOpacity")}`,s.style.pointerEvents="auto",s.style.cursor="auto",f.appendChild(s),f}function Pn(n){const l=window.innerWidth,a=window.innerHeight,f=B("stagePadding")||0,s=B("stageRadius")||0,x=n.width+f*2,C=n.height+f*2,T=Math.min(s,x/2,C/2),y=Math.floor(Math.max(T,0)),v=n.x-f+y,k=n.y-f,U=x-y*2,N=C-y*2;return`M${l},0L0,0L0,${a}L${l},${a}L${l},0Z
    M${v},${k} h${U} a${y},${y} 0 0 1 ${y},${y} v${N} a${y},${y} 0 0 1 -${y},${y} h-${U} a${y},${y} 0 0 1 -${y},-${y} v-${N} a${y},${y} 0 0 1 ${y},-${y} z`}function ea(){const n=V("__overlaySvg");n&&n.remove()}function ta(){const n=document.getElementById("driver-dummy-element");if(n)return n;let l=document.createElement("div");return l.id="driver-dummy-element",l.style.width="0",l.style.height="0",l.style.pointerEvents="none",l.style.opacity="0",l.style.position="fixed",l.style.top="50%",l.style.left="50%",document.body.appendChild(l),l}function vn(n){const{element:l}=n;let a=typeof l=="function"?l():typeof l=="string"?document.querySelector(l):l;a||(a=ta()),na(a,n)}function ra(){const n=V("__activeElement"),l=V("__activeStep");n&&(In(n),Yo(),$n(n,l))}function na(n,l){var a;const f=Date.now(),s=V("__activeStep"),x=V("__activeElement")||n,C=!x||x===n,T=n.id==="driver-dummy-element",y=x.id==="driver-dummy-element",v=B("animate"),k=l.onHighlightStarted||B("onHighlightStarted"),U=(l==null?void 0:l.onHighlighted)||B("onHighlighted"),N=(s==null?void 0:s.onDeselected)||B("onDeselected"),S=B(),A=V();!C&&N&&N(y?void 0:x,s,{config:S,state:A,driver:Ne()}),k&&k(T?void 0:n,l,{config:S,state:A,driver:Ne()});const F=!C&&v;let O=!1;la(),me("previousStep",s),me("previousElement",x),me("activeStep",l),me("activeElement",n);const K=()=>{if(V("__transitionCallback")!==K)return;const J=Date.now()-f,R=400-J<=400/2;l.popover&&R&&!O&&F&&(wn(n,l),O=!0),B("animate")&&J<400?Qo(J,400,x,n):(In(n),U&&U(T?void 0:n,l,{config:B(),state:V(),driver:Ne()}),me("__transitionCallback",void 0),me("__previousStep",s),me("__previousElement",x),me("__activeStep",l),me("__activeElement",n)),window.requestAnimationFrame(K)};me("__transitionCallback",K),window.requestAnimationFrame(K),_n(n),!F&&l.popover&&wn(n,l),x.classList.remove("driver-active-element","driver-no-interaction"),x.removeAttribute("aria-haspopup"),x.removeAttribute("aria-expanded"),x.removeAttribute("aria-controls"),((a=l.disableActiveInteraction)!=null?a:B("disableActiveInteraction"))&&n.classList.add("driver-no-interaction"),n.classList.add("driver-active-element"),n.setAttribute("aria-haspopup","dialog"),n.setAttribute("aria-expanded","true"),n.setAttribute("aria-controls","driver-popover-content")}function oa(){var n;(n=document.getElementById("driver-dummy-element"))==null||n.remove(),document.querySelectorAll(".driver-active-element").forEach(l=>{l.classList.remove("driver-active-element","driver-no-interaction"),l.removeAttribute("aria-haspopup"),l.removeAttribute("aria-expanded"),l.removeAttribute("aria-controls")})}function ot(){const n=V("__resizeTimeout");n&&window.cancelAnimationFrame(n),me("__resizeTimeout",window.requestAnimationFrame(ra))}function aa(n){var l;if(!V("isInitialized")||!(n.key==="Tab"||n.keyCode===9))return;const a=V("__activeElement"),f=(l=V("popover"))==null?void 0:l.wrapper,s=An([...f?[f]:[],...a?[a]:[]]),x=s[0],C=s[s.length-1];if(n.preventDefault(),n.shiftKey){const T=s[s.indexOf(document.activeElement)-1]||C;T==null||T.focus()}else{const T=s[s.indexOf(document.activeElement)+1]||x;T==null||T.focus()}}function Rn(n){var l;((l=B("allowKeyboardControl"))==null||l)&&(n.key==="Escape"?Ve("escapePress"):n.key==="ArrowRight"?Ve("arrowRightPress"):n.key==="ArrowLeft"&&Ve("arrowLeftPress"))}function Ln(n,l,a){const f=(s,x)=>{const C=s.target;n.contains(C)&&((!a||a(C))&&(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation()),x==null||x(s))};document.addEventListener("pointerdown",f,!0),document.addEventListener("mousedown",f,!0),document.addEventListener("pointerup",f,!0),document.addEventListener("mouseup",f,!0),document.addEventListener("click",s=>{f(s,l)},!0)}function sa(){window.addEventListener("keyup",Rn,!1),window.addEventListener("keydown",aa,!1),window.addEventListener("resize",ot),window.addEventListener("scroll",ot)}function ia(){window.removeEventListener("keyup",Rn),window.removeEventListener("resize",ot),window.removeEventListener("scroll",ot)}function la(){const n=V("popover");n&&(n.wrapper.style.display="none")}function wn(n,l){var a,f;let s=V("popover");s&&document.body.removeChild(s.wrapper),s=da(),document.body.appendChild(s.wrapper);const{title:x,description:C,showButtons:T,disableButtons:y,showProgress:v,nextBtnText:k=B("nextBtnText")||"Next &rarr;",prevBtnText:U=B("prevBtnText")||"&larr; Previous",progressText:N=B("progressText")||"{current} of {total}"}=l.popover||{};s.nextButton.innerHTML=k,s.previousButton.innerHTML=U,s.progress.innerHTML=N,x?(s.title.innerHTML=x,s.title.style.display="block"):s.title.style.display="none",C?(s.description.innerHTML=C,s.description.style.display="block"):s.description.style.display="none";const S=T||B("showButtons"),A=v||B("showProgress")||!1,F=(S==null?void 0:S.includes("next"))||(S==null?void 0:S.includes("previous"))||A;s.closeButton.style.display=S.includes("close")?"block":"none",F?(s.footer.style.display="flex",s.progress.style.display=A?"block":"none",s.nextButton.style.display=S.includes("next")?"block":"none",s.previousButton.style.display=S.includes("previous")?"block":"none"):s.footer.style.display="none";const O=y||B("disableButtons")||[];O!=null&&O.includes("next")&&(s.nextButton.disabled=!0,s.nextButton.classList.add("driver-popover-btn-disabled")),O!=null&&O.includes("previous")&&(s.previousButton.disabled=!0,s.previousButton.classList.add("driver-popover-btn-disabled")),O!=null&&O.includes("close")&&(s.closeButton.disabled=!0,s.closeButton.classList.add("driver-popover-btn-disabled"));const K=s.wrapper;K.style.display="block",K.style.left="",K.style.top="",K.style.bottom="",K.style.right="",K.id="driver-popover-content",K.setAttribute("role","dialog"),K.setAttribute("aria-labelledby","driver-popover-title"),K.setAttribute("aria-describedby","driver-popover-description");const J=s.arrow;J.className="driver-popover-arrow";const R=((a=l.popover)==null?void 0:a.popoverClass)||B("popoverClass")||"";K.className=`driver-popover ${R}`.trim(),Ln(s.wrapper,ue=>{var je,Me,m;const ie=ue.target,b=((je=l.popover)==null?void 0:je.onNextClick)||B("onNextClick"),se=((Me=l.popover)==null?void 0:Me.onPrevClick)||B("onPrevClick"),ce=((m=l.popover)==null?void 0:m.onCloseClick)||B("onCloseClick");if(ie.closest(".driver-popover-next-btn"))return b?b(n,l,{config:B(),state:V(),driver:Ne()}):Ve("nextClick");if(ie.closest(".driver-popover-prev-btn"))return se?se(n,l,{config:B(),state:V(),driver:Ne()}):Ve("prevClick");if(ie.closest(".driver-popover-close-btn"))return ce?ce(n,l,{config:B(),state:V(),driver:Ne()}):Ve("closeClick")},ue=>!(s!=null&&s.description.contains(ue))&&!(s!=null&&s.title.contains(ue))&&typeof ue.className=="string"&&ue.className.includes("driver-popover")),me("popover",s);const H=((f=l.popover)==null?void 0:f.onPopoverRender)||B("onPopoverRender");H&&H(s,{config:B(),state:V(),driver:Ne()}),$n(n,l),_n(K);const ee=n.classList.contains("driver-dummy-element"),D=An([K,...ee?[]:[n]]);D.length>0&&D[0].focus()}function Mn(){const n=V("popover");if(!(n!=null&&n.wrapper))return;const l=n.wrapper.getBoundingClientRect(),a=B("stagePadding")||0,f=B("popoverOffset")||0;return{width:l.width+a+f,height:l.height+a+f,realWidth:l.width,realHeight:l.height}}function yn(n,l){const{elementDimensions:a,popoverDimensions:f,popoverPadding:s,popoverArrowDimensions:x}=l;return n==="start"?Math.max(Math.min(a.top-s,window.innerHeight-f.realHeight-x.width),x.width):n==="end"?Math.max(Math.min(a.top-(f==null?void 0:f.realHeight)+a.height+s,window.innerHeight-(f==null?void 0:f.realHeight)-x.width),x.width):n==="center"?Math.max(Math.min(a.top+a.height/2-(f==null?void 0:f.realHeight)/2,window.innerHeight-(f==null?void 0:f.realHeight)-x.width),x.width):0}function En(n,l){const{elementDimensions:a,popoverDimensions:f,popoverPadding:s,popoverArrowDimensions:x}=l;return n==="start"?Math.max(Math.min(a.left-s,window.innerWidth-f.realWidth-x.width),x.width):n==="end"?Math.max(Math.min(a.left-(f==null?void 0:f.realWidth)+a.width+s,window.innerWidth-(f==null?void 0:f.realWidth)-x.width),x.width):n==="center"?Math.max(Math.min(a.left+a.width/2-(f==null?void 0:f.realWidth)/2,window.innerWidth-(f==null?void 0:f.realWidth)-x.width),x.width):0}function $n(n,l){const a=V("popover");if(!a)return;const{align:f="start",side:s="left"}=(l==null?void 0:l.popover)||{},x=f,C=n.id==="driver-dummy-element"?"over":s,T=B("stagePadding")||0,y=Mn(),v=a.arrow.getBoundingClientRect(),k=n.getBoundingClientRect(),U=k.top-y.height;let N=U>=0;const S=window.innerHeight-(k.bottom+y.height);let A=S>=0;const F=k.left-y.width;let O=F>=0;const K=window.innerWidth-(k.right+y.width);let J=K>=0;const R=!N&&!A&&!O&&!J;let H=C;if(C==="top"&&N?J=O=A=!1:C==="bottom"&&A?J=O=N=!1:C==="left"&&O?J=N=A=!1:C==="right"&&J&&(O=N=A=!1),C==="over"){const ee=window.innerWidth/2-y.realWidth/2,D=window.innerHeight/2-y.realHeight/2;a.wrapper.style.left=`${ee}px`,a.wrapper.style.right="auto",a.wrapper.style.top=`${D}px`,a.wrapper.style.bottom="auto"}else if(R){const ee=window.innerWidth/2-(y==null?void 0:y.realWidth)/2,D=10;a.wrapper.style.left=`${ee}px`,a.wrapper.style.right="auto",a.wrapper.style.bottom=`${D}px`,a.wrapper.style.top="auto"}else if(O){const ee=Math.min(F,window.innerWidth-(y==null?void 0:y.realWidth)-v.width),D=yn(x,{elementDimensions:k,popoverDimensions:y,popoverPadding:T,popoverArrowDimensions:v});a.wrapper.style.left=`${ee}px`,a.wrapper.style.top=`${D}px`,a.wrapper.style.bottom="auto",a.wrapper.style.right="auto",H="left"}else if(J){const ee=Math.min(K,window.innerWidth-(y==null?void 0:y.realWidth)-v.width),D=yn(x,{elementDimensions:k,popoverDimensions:y,popoverPadding:T,popoverArrowDimensions:v});a.wrapper.style.right=`${ee}px`,a.wrapper.style.top=`${D}px`,a.wrapper.style.bottom="auto",a.wrapper.style.left="auto",H="right"}else if(N){const ee=Math.min(U,window.innerHeight-y.realHeight-v.width);let D=En(x,{elementDimensions:k,popoverDimensions:y,popoverPadding:T,popoverArrowDimensions:v});a.wrapper.style.top=`${ee}px`,a.wrapper.style.left=`${D}px`,a.wrapper.style.bottom="auto",a.wrapper.style.right="auto",H="top"}else if(A){const ee=Math.min(S,window.innerHeight-(y==null?void 0:y.realHeight)-v.width);let D=En(x,{elementDimensions:k,popoverDimensions:y,popoverPadding:T,popoverArrowDimensions:v});a.wrapper.style.left=`${D}px`,a.wrapper.style.bottom=`${ee}px`,a.wrapper.style.top="auto",a.wrapper.style.right="auto",H="bottom"}R?a.arrow.classList.add("driver-popover-arrow-none"):ca(x,H,n)}function ca(n,l,a){const f=V("popover");if(!f)return;const s=a.getBoundingClientRect(),x=Mn(),C=f.arrow,T=x.width,y=window.innerWidth,v=s.width,k=s.left,U=x.height,N=window.innerHeight,S=s.top,A=s.height;C.className="driver-popover-arrow";let F=l,O=n;if(l==="top"?(k+v<=0?(F="right",O="end"):k+v-T<=0&&(F="top",O="start"),k>=y?(F="left",O="end"):k+T>=y&&(F="top",O="end")):l==="bottom"?(k+v<=0?(F="right",O="start"):k+v-T<=0&&(F="bottom",O="start"),k>=y?(F="left",O="start"):k+T>=y&&(F="bottom",O="end")):l==="left"?(S+A<=0?(F="bottom",O="end"):S+A-U<=0&&(F="left",O="start"),S>=N?(F="top",O="end"):S+U>=N&&(F="left",O="end")):l==="right"&&(S+A<=0?(F="bottom",O="start"):S+A-U<=0&&(F="right",O="start"),S>=N?(F="top",O="start"):S+U>=N&&(F="right",O="end")),!F)C.classList.add("driver-popover-arrow-none");else{C.classList.add(`driver-popover-arrow-side-${F}`),C.classList.add(`driver-popover-arrow-align-${O}`);const K=a.getBoundingClientRect(),J=C.getBoundingClientRect(),R=B("stagePadding")||0,H=K.left-R<window.innerWidth&&K.right+R>0&&K.top-R<window.innerHeight&&K.bottom+R>0;l==="bottom"&&H&&(J.x>K.x&&J.x+J.width<K.x+K.width?f.wrapper.style.transform="translateY(0)":(C.classList.remove(`driver-popover-arrow-align-${O}`),C.classList.add("driver-popover-arrow-none"),f.wrapper.style.transform=`translateY(-${R/2}px)`))}}function da(){const n=document.createElement("div");n.classList.add("driver-popover");const l=document.createElement("div");l.classList.add("driver-popover-arrow");const a=document.createElement("header");a.id="driver-popover-title",a.classList.add("driver-popover-title"),a.style.display="none",a.innerText="Popover Title";const f=document.createElement("div");f.id="driver-popover-description",f.classList.add("driver-popover-description"),f.style.display="none",f.innerText="Popover description is here";const s=document.createElement("button");s.type="button",s.classList.add("driver-popover-close-btn"),s.setAttribute("aria-label","Close"),s.innerHTML="&times;";const x=document.createElement("footer");x.classList.add("driver-popover-footer");const C=document.createElement("span");C.classList.add("driver-popover-progress-text"),C.innerText="";const T=document.createElement("span");T.classList.add("driver-popover-navigation-btns");const y=document.createElement("button");y.type="button",y.classList.add("driver-popover-prev-btn"),y.innerHTML="&larr; Previous";const v=document.createElement("button");return v.type="button",v.classList.add("driver-popover-next-btn"),v.innerHTML="Next &rarr;",T.appendChild(y),T.appendChild(v),x.appendChild(C),x.appendChild(T),n.appendChild(s),n.appendChild(l),n.appendChild(a),n.appendChild(f),n.appendChild(x),{wrapper:n,arrow:l,title:a,description:f,footer:x,previousButton:y,nextButton:v,closeButton:s,footerButtons:T,progress:C}}function ua(){var n;const l=V("popover");l&&((n=l.wrapper.parentElement)==null||n.removeChild(l.wrapper))}function ma(n={}){Ft(n);function l(){B("allowClose")&&k()}function a(){const N=B("overlayClickBehavior");if(B("allowClose")&&N==="close"){k();return}N==="nextStep"&&f()}function f(){const N=V("activeIndex"),S=B("steps")||[];if(typeof N>"u")return;const A=N+1;S[A]?v(A):k()}function s(){const N=V("activeIndex"),S=B("steps")||[];if(typeof N>"u")return;const A=N-1;S[A]?v(A):k()}function x(N){(B("steps")||[])[N]?v(N):k()}function C(){var N;if(V("__transitionCallback"))return;const S=V("activeIndex"),A=V("__activeStep"),F=V("__activeElement");if(typeof S>"u"||typeof A>"u"||typeof V("activeIndex")>"u")return;const O=((N=A.popover)==null?void 0:N.onPrevClick)||B("onPrevClick");if(O)return O(F,A,{config:B(),state:V(),driver:Ne()});s()}function T(){var N;if(V("__transitionCallback"))return;const S=V("activeIndex"),A=V("__activeStep"),F=V("__activeElement");if(typeof S>"u"||typeof A>"u")return;const O=((N=A.popover)==null?void 0:N.onNextClick)||B("onNextClick");if(O)return O(F,A,{config:B(),state:V(),driver:Ne()});f()}function y(){V("isInitialized")||(me("isInitialized",!0),document.body.classList.add("driver-active",B("animate")?"driver-fade":"driver-simple"),sa(),ht("overlayClick",a),ht("escapePress",l),ht("arrowLeftPress",C),ht("arrowRightPress",T))}function v(N=0){var S,A,F,O,K,J,R,H;const ee=B("steps");if(!ee){console.error("No steps to drive through"),k();return}if(!ee[N]){k();return}me("__activeOnDestroyed",document.activeElement),me("activeIndex",N);const D=ee[N],ue=ee[N+1],je=ee[N-1],Me=((S=D.popover)==null?void 0:S.doneBtnText)||B("doneBtnText")||"Done",m=B("allowClose"),ie=typeof((A=D.popover)==null?void 0:A.showProgress)<"u"?(F=D.popover)==null?void 0:F.showProgress:B("showProgress"),b=(((O=D.popover)==null?void 0:O.progressText)||B("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${N+1}`).replace("{{total}}",`${ee.length}`),se=((K=D.popover)==null?void 0:K.showButtons)||B("showButtons"),ce=["next","previous",...m?["close"]:[]].filter(G=>!(se!=null&&se.length)||se.includes(G)),Ge=((J=D.popover)==null?void 0:J.onNextClick)||B("onNextClick"),z=((R=D.popover)==null?void 0:R.onPrevClick)||B("onPrevClick"),Y=((H=D.popover)==null?void 0:H.onCloseClick)||B("onCloseClick");vn({...D,popover:{showButtons:ce,nextBtnText:ue?void 0:Me,disableButtons:[...je?[]:["previous"]],showProgress:ie,progressText:b,onNextClick:Ge||(()=>{ue?v(N+1):k()}),onPrevClick:z||(()=>{v(N-1)}),onCloseClick:Y||(()=>{k()}),...(D==null?void 0:D.popover)||{}}})}function k(N=!0){const S=V("__activeElement"),A=V("__activeStep"),F=V("__activeOnDestroyed"),O=B("onDestroyStarted");if(N&&O){const R=!S||(S==null?void 0:S.id)==="driver-dummy-element";O(R?void 0:S,A,{config:B(),state:V(),driver:Ne()});return}const K=(A==null?void 0:A.onDeselected)||B("onDeselected"),J=B("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),ia(),ua(),oa(),ea(),qo(),xn(),S&&A){const R=S.id==="driver-dummy-element";K&&K(R?void 0:S,A,{config:B(),state:V(),driver:Ne()}),J&&J(R?void 0:S,A,{config:B(),state:V(),driver:Ne()})}F&&F.focus()}const U={isActive:()=>V("isInitialized")||!1,refresh:ot,drive:(N=0)=>{y(),v(N)},setConfig:Ft,setSteps:N=>{xn(),Ft({...B(),steps:N})},getConfig:B,getState:V,getActiveIndex:()=>V("activeIndex"),isFirstStep:()=>V("activeIndex")===0,isLastStep:()=>{const N=B("steps")||[],S=V("activeIndex");return S!==void 0&&S===N.length-1},getActiveStep:()=>V("activeStep"),getActiveElement:()=>V("activeElement"),getPreviousElement:()=>V("previousElement"),getPreviousStep:()=>V("previousStep"),moveNext:f,movePrevious:s,moveTo:x,hasNextStep:()=>{const N=B("steps")||[],S=V("activeIndex");return S!==void 0&&!!N[S+1]},hasPreviousStep:()=>{const N=B("steps")||[],S=V("activeIndex");return S!==void 0&&!!N[S-1]},highlight:N=>{y(),vn({...N,popover:N.popover?{showButtons:[],showProgress:!1,progressText:"",...N.popover}:void 0})},destroy:()=>{k(!1)}};return Go(U),U}const pa=async(n,l,a)=>{var f;try{console.log("📤 [SAVE] Subiendo imagen al backend:",l);const[s,x]=n.split(","),C=((f=s.match(/data:image\/(\w+)/))==null?void 0:f[1])||"png",T=new FormData,y=atob(x),v=new Array(y.length);for(let A=0;A<y.length;A++)v[A]=y.charCodeAt(A);const k=new Uint8Array(v),U=new Blob([k],{type:`image/${C}`});T.append("image",U,`element_${l}.${C}`),T.append("project_id",a),T.append("element_id",l);const N=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:T});if(!N.ok)throw new Error("Error al subir imagen al servidor");const S=await N.json();return console.log("✅ [SAVE] Imagen subida exitosamente:",S.url),S.url}catch(s){throw console.error("❌ [SAVE] Error subiendo imagen:",s),s}},ga=async(n,l)=>{var x,C;console.log("🔄 [SAVE] Procesando imágenes para guardado...");const a=[];let f=0,s=0;for(const T of n)for(const y of T.cells||[])for(const v of y.elements||[])v.type==="image"&&((x=v.content)!=null&&x.startsWith("data:image/"))&&f++;console.log(`📊 [SAVE] Total de imágenes base64 a procesar: ${f}`);for(const T of n){const y={...T};y.cells=[];for(const v of T.cells||[]){const k={...v};k.elements=[];for(const U of v.elements||[]){const N={...U};if(U.type==="image"&&((C=U.content)!=null&&C.startsWith("data:image/")))try{const S=await pa(U.content,U.id,l);N.content=S,N.isUploaded=!0,s++,console.log(`✅ [SAVE] Imagen ${s}/${f} procesada`)}catch(S){console.error("❌ [SAVE] Error procesando imagen:",U.id,S),N.uploadError=S.message}k.elements.push(N)}y.cells.push(k)}a.push(y)}return console.log(`✅ [SAVE] Procesamiento completado: ${s}/${f} imágenes subidas`),a},ha=async(n,l)=>{var a;try{console.log("🔍 [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:n,thumbnailsCount:Object.keys(l).length});const f=[];for(const[C,T]of Object.entries(l))console.log(`🔍 [DEBUG] Procesando thumbnail para página ${C}:`,{hasData:!!T,isBase64:T&&T.startsWith("data:image/"),dataLength:T?T.length:0}),T&&T.startsWith("data:image/")&&f.push({page_id:C,thumbnail_data:T});if(f.length===0){console.log("ℹ️ [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`🖼️ [THUMBNAILS] Guardando ${f.length} thumbnails como archivos...`),console.log(`🔍 [DEBUG] URL del endpoint: /api/thumbnails/${n}/save-as-files`);const s=await fetch(`/api/thumbnails/${n}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content)||""},credentials:"include",body:JSON.stringify({thumbnails:f})});if(console.log("🔍 [DEBUG] Respuesta del servidor:",{status:s.status,statusText:s.statusText,ok:s.ok}),!s.ok){const C=await s.text();throw console.error("❌ [THUMBNAILS] Error respuesta del servidor:",C),new Error(`Error al guardar thumbnails: ${s.status} ${s.statusText}`)}const x=await s.json();return console.log("✅ [THUMBNAILS] Thumbnails guardados como archivos:",x),x}catch(f){throw console.error("❌ [THUMBNAILS] Error guardando thumbnails:",f),f}},Cn=async(n,l,a,f,s,x,C=!1)=>{try{if(!(l!=null&&l.id))throw new Error("No se encontró el ID del proyecto");console.log(`💾 [SAVE] Iniciando ${C?"auto-guardado":"guardado manual"}...`);let T=n;C||(T=await ga(n,l.id));const y={pages:T,projectInfo:{id:l.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:f==null?void 0:f.id},workspace:{width:s.width,height:s.height,scale:s.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:C,totalPages:n.length}},v=C?"save-progress":"save",k=await fetch(`/api/canvas/projects/${l.id}/${v}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:y,thumbnails:x})});if(!k.ok){const N=await k.json().catch(()=>({}));throw new Error(N.message||"Error al guardar el proyecto")}const U=await k.json();if(console.log(`✅ [SAVE] ${C?"Auto-guardado":"Guardado"} exitoso:`,U),!C&&x&&Object.keys(x).length>0){console.log("🖼️ [SAVE] Guardando thumbnails como archivos...");try{await ha(l.id,x),console.log("✅ [SAVE] Thumbnails guardados como archivos")}catch(N){console.warn("⚠️ [SAVE] Error guardando thumbnails como archivos:",N)}}return{success:!0,data:U}}catch(T){return console.error(`❌ [SAVE] Error en ${C?"auto-guardado":"guardado"}:`,T),{success:!1,error:T.message}}},fa=(n,l,a,f,s,x)=>{const[C,T]=p.useState("saved"),[y,v]=p.useState(null),[k,U]=p.useState(null),[N,S]=p.useState(null),[A,F]=p.useState(!1),[O,K]=p.useState(navigator.onLine),J=p.useRef(null),R=p.useRef(null),H=p.useRef(null),ee=p.useRef(!1),D=p.useRef(null),ue=15e3,je=2e3,Me=5e3,m=p.useCallback((z,Y)=>{try{const G={pages:z.map(pe=>{var Q;return{id:pe.id,layout:pe.layout,cells:((Q=pe.cells)==null?void 0:Q.map(be=>{var Nt;return{id:be.id,elements:((Nt=be.elements)==null?void 0:Nt.map(Ce=>{var Ae;return{id:Ce.id,type:Ce.type,content:Ce.type==="image"&&((Ae=Ce.content)!=null&&Ae.startsWith("data:image/"))?`[IMAGE_${Ce.content.length}]`:Ce.content,position:Ce.position,size:Ce.size,style:Ce.style,filters:Ce.filters,rotation:Ce.rotation}}))||[]}}))||[]}})||[],workspace:{width:Y==null?void 0:Y.width,height:Y==null?void 0:Y.height}};return btoa(JSON.stringify(G)).substring(0,32)}catch(G){return console.warn("⚠️ [AUTO-SAVE] Error generando hash:",G),Date.now().toString()}},[]),ie=p.useCallback(()=>`album_editor_autosave_${(l==null?void 0:l.id)||"draft"}`,[l==null?void 0:l.id]),b=p.useCallback(z=>{try{const Y=ie(),G={...z,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(Y,JSON.stringify(G)),console.log("💾 [AUTO-SAVE] Guardado en localStorage"),!0}catch(Y){return console.error("❌ [AUTO-SAVE] Error guardando en localStorage:",Y),!1}},[ie]),se=p.useCallback(()=>{var z;try{const Y=ie(),G=localStorage.getItem(Y);if(G){const pe=JSON.parse(G);return console.log("📂 [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(z=pe.pages)==null?void 0:z.length,savedAt:new Date(pe.savedAt).toLocaleString()}),pe}}catch(Y){console.error("❌ [AUTO-SAVE] Error cargando desde localStorage:",Y)}return null},[ie]),ce=p.useCallback(async(z=!1)=>{if(ee.current&&!z){console.log("⏳ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(l!=null&&l.id)||!n||n.length===0){console.log("⚠️ [AUTO-SAVE] Datos insuficientes para guardar");return}const Y=m(n,s);if(!z&&Y===H.current){console.log("📊 [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{ee.current=!0,T("saving"),S(null);const G={pages:n,projectInfo:{id:l.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:f==null?void 0:f.id},workspace:s,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:Y}};if(b(G),O){const pe=await Cn(n,l,a,f,s,x,!0);if(pe.success)H.current=Y,U(new Date),T("saved"),F(!1),console.log("✅ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(pe.error)}else console.log("� [AUTO-SAVE] Sin conexión, solo guardado en localStorage"),T("pending"),F(!0)}catch(G){console.error("❌ [AUTO-SAVE] Error:",G),S(G.message),T("error"),O&&(D.current=setTimeout(()=>{console.log("🔄 [AUTO-SAVE] Reintentando guardado..."),ce(!0)},Me))}finally{ee.current=!1}},[n,l,a,f,s,x,m,b,O]),Ge=p.useCallback(async()=>{try{T("saving");const z=await Cn(n,l,a,f,s,x,!1);if(z.success){const Y=m(n,s);H.current=Y,v(new Date),T("saved"),F(!1),re.success("💾 Proyecto guardado exitosamente"),console.log("✅ [MANUAL-SAVE] Guardado manual exitoso")}else S(z.error),T("error"),re.error(`❌ Error al guardar: ${z.error}`);return z.success}catch(z){return console.error("❌ [MANUAL-SAVE] Error:",z),S(z.message),T("error"),re.error(`❌ Error inesperado: ${z.message}`),!1}},[n,l,a,f,s,x,m]);return p.useEffect(()=>{if(!(l!=null&&l.id)||!n||n.length===0)return;const z=m(n,s);return H.current&&z!==H.current?(console.log("🔄 [AUTO-SAVE] Cambios detectados, programando guardado..."),F(!0),T("pending"),R.current&&clearTimeout(R.current),R.current=setTimeout(()=>{ce()},je)):H.current||(H.current=z),()=>{R.current&&clearTimeout(R.current)}},[n,s,l==null?void 0:l.id,m,ce]),p.useEffect(()=>{if(l!=null&&l.id)return J.current&&clearInterval(J.current),J.current=setInterval(()=>{A&&(console.log("⏰ [AUTO-SAVE] Auto-save periódico activado"),ce())},ue),()=>{J.current&&clearInterval(J.current)}},[l==null?void 0:l.id,A,ce]),p.useEffect(()=>{const z=()=>{console.log("🌐 [AUTO-SAVE] Conexión restaurada"),K(!0),A&&setTimeout(()=>ce(!0),1e3)},Y=()=>{console.log("📴 [AUTO-SAVE] Conexión perdida"),K(!1)};return window.addEventListener("online",z),window.addEventListener("offline",Y),()=>{window.removeEventListener("online",z),window.removeEventListener("offline",Y)}},[A,ce]),p.useEffect(()=>{const z=Y=>{if(A){const G={pages:n,projectInfo:{id:l.id},workspace:s,meta:{savedAt:new Date().toISOString()}};return b(G),Y.preventDefault(),Y.returnValue="¿Estás seguro de salir? Hay cambios sin guardar.","¿Estás seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",z),()=>window.removeEventListener("beforeunload",z)},[A,n,l==null?void 0:l.id,s,b]),p.useEffect(()=>()=>{R.current&&clearTimeout(R.current),J.current&&clearInterval(J.current),D.current&&clearTimeout(D.current)},[]),p.useEffect(()=>{N&&(N.includes("max_allowed_packet")||N.includes("data_too_large")?re.error("❌ El proyecto es demasiado grande para guardar automáticamente. Reduce el número o tamaño de imágenes."):re.error(`❌ Error de auto-guardado: ${N}`))},[N]),{saveStatus:C,lastSaved:y,lastAutoSaved:k,saveError:N,hasUnsavedChanges:A,isOnline:O,saveManually:Ge,performAutoSave:()=>ce(!0),loadFromLocalStorage:se,getStorageKey:ie,autoSaveInterval:ue,debounceDelay:je}},ba=({saveStatus:n,lastSaved:l,lastAutoSaved:a,hasUnsavedChanges:f,isOnline:s,saveError:x,onManualSave:C,className:T=""})=>{const y=U=>{if(!U)return null;const S=new Date-U,A=Math.floor(S/(1e3*60)),F=Math.floor(S/1e3);if(F<30)return"hace unos segundos";if(A<1)return`hace ${F}s`;if(A<60)return`hace ${A}m`;const O=Math.floor(A/60);return O<24?`hace ${O}h`:U.toLocaleDateString()},k=(()=>{if(!s)return{icon:e.jsx(bn,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexión",detail:"Guardado local activo"};switch(n){case"saving":return{icon:e.jsx(ko,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(To,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:a?`Auto-guardado ${y(a)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(So,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:x||"Error desconocido"};case"pending":return{icon:e.jsx(jo,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:f?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(Tn,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${T}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${k.bg} ${k.color}
                    hover:shadow-md
                `,onClick:()=>n!=="saving"&&(C==null?void 0:C()),children:[k.icon,e.jsx("span",{className:"text-sm font-medium",children:k.text}),e.jsx("div",{className:"flex items-center",children:s?e.jsx(Fo,{className:"w-3 h-3 text-green-500"}):e.jsx(bn,{className:"w-3 h-3 text-orange-500"})})]}),n==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},xa=n=>{const[l,a]=p.useState({}),[f,s]=p.useState(!1);p.useEffect(()=>{if(!n||Object.keys(n).length===0)return;s(!0);const v=async()=>{try{const k={},U={};if(Object.entries(n).forEach(([N,S])=>{S&&S.startsWith("data:image/")?k[N]=S:U[N]=S}),Object.keys(k).length>0){console.log(`🔄 [BLOB-HOOK] Convirtiendo ${Object.keys(k).length} data URLs a Blob URLs...`);const N=bo(k);a({...U,...N})}else a(U)}catch(k){console.error("❌ [BLOB-HOOK] Error en conversión:",k),a(n)}finally{s(!1)}};requestAnimationFrame(()=>{v()})},[n]);const x=p.useCallback((v,k)=>{if(!v||!v.startsWith("data:image/"))return v;const U=go(v,k);return a(N=>({...N,[k]:U})),U},[]),C=p.useCallback(v=>{ho(v),a(k=>{const U={...k};return delete U[v],U})},[]),T=p.useCallback(()=>{un(),a({})},[]),y=p.useCallback(()=>{const v=fo(),k=Object.keys(n||{}).length,U=Object.values(l).filter(S=>S==null?void 0:S.startsWith("blob:")).length,N=Object.values(n||{}).filter(S=>S==null?void 0:S.startsWith("data:")).length;return{...v,totalThumbnails:k,blobCount:U,dataCount:N,conversionRate:k>0?(U/k*100).toFixed(1):0}},[n,l]);return p.useEffect(()=>()=>{un()},[]),{thumbnails:l,isConverting:f,convertSingle:x,cleanup:C,cleanupAll:T,getStats:y}},Le=typeof window>"u",bt=()=>{},va=()=>{},Ke=console.error,Ee=console.log,wa=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const n=document.createElement("style");n.textContent=wa,document.head.appendChild(n)}function xt(n,l){let a;return function(...s){const x=()=>{clearTimeout(a),n(...s)};clearTimeout(a),a=setTimeout(x,l)}}const ya=(n,l,a)=>{var F,O;if(!n||!n.template)return a;const f=n.template;let s=1,x=1;const C=f.match(/grid-cols-(\d+)/),T=f.match(/grid-rows-(\d+)/);C&&(s=parseInt(C[1])),T&&(x=parseInt(T[1]));let y=16;const v=f.match(/gap-(\d+)/);v?y=parseInt(v[1])*4:(F=n.style)!=null&&F.gap&&(y=parseInt(n.style.gap));let k=0;(O=n.style)!=null&&O.padding&&(k=parseInt(n.style.padding)*2);const U=a.width-k-y*(s-1),N=a.height-k-y*(x-1);let S=Math.floor(U/s),A=Math.floor(N/x);if(n.cellStyles&&n.cellStyles[l]){const K=n.cellStyles[l],J=K.match(/col-span-(\d+)/),R=K.match(/row-span-(\d+)/);if(J){const H=parseInt(J[1]);S=Math.floor((U+y*(H-1))/s*H)}if(R){const H=parseInt(R[1]);A=Math.floor((N+y*(H-1))/x*H)}}return Ee(`🔧 [CELL-DIMENSIONS] Layout: ${n.id}, Celda: ${l}, Grid: ${s}x${x}, Gap: ${y}px, Dims: ${S}x${A}`),{width:S,height:A}},Ht=Wt.memo(({pageId:n,thumbnail:l,altText:a,type:f})=>{const[s,x]=p.useState(!1),[C,T]=p.useState(!1);if(l&&!C)return e.jsxs("div",{className:"relative w-full h-full",children:[!s&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:l,alt:a,className:`w-full h-full object-contain transition-opacity duration-200 ${s?"opacity-100":"opacity-0"}`,onLoad:()=>x(!0),onError:()=>T(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}}),!1]});const y=f==="cover"||f==="final"?vt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((v,k)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},k))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(y,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(n,l)=>n.pageId===l.pageId&&n.thumbnail===l.thumbnail&&n.altText===l.altText&&n.type===l.type),Ea=Wt.memo(({images:n,onImageSelect:l,isLoading:a})=>{const f=Wt.memo(({image:s})=>{const[x,C]=p.useState(!1),[T,y]=p.useState(!1),[v,k]=p.useState(!1),[{isDragging:U},N]=Eo(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:s.url},collect:K=>({isDragging:!!K.isDragging()}),end:()=>{setTimeout(()=>k(!1),100)}})),S=s.thumbnail_url||s.url,A=s.url,F=K=>{k(!0),setTimeout(()=>k(!1),500)},O=K=>{if(v||U)return K.preventDefault(),K.stopPropagation(),!1;l(A)};return e.jsxs("div",{ref:N,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${U?"opacity-50 scale-95":""}`,onMouseDown:F,onClick:O,children:[e.jsxs("div",{className:"aspect-square relative",children:[!x&&!T&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),T?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(We,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:S,alt:s.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${x?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>C(!0),onError:()=>y(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(wt,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:s.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),s.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return a?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((s,x)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},x))}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(We,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay imágenes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:n.map((s,x)=>e.jsx(f,{image:s},`${s.id||s.url}-${x}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[n.filter(s=>s.has_thumbnail).length," de ",n.length," imágenes optimizadas"]})})]})});function ks(){var wr,yr,Er,Cr,Nr,jr,Sr,Tr,kr,Ar,_r,Ir,Or,Pr,Rr,Lr,Mr,$r,Br,zr,Ur,Fr,Hr,Wr,Vr,Gr,qr,Kr,Dr,Jr,Qr,Yr,Xr,Zr,en,tn,rn,nn,on,an,sn;const[n,l]=p.useState(null),[a,f]=p.useState(null),[s,x]=p.useState(null),[C,T]=p.useState(null),[y,v]=p.useState(!0),[k,U]=p.useState(null),[N,S]=p.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[A,F]=p.useState(new Map),[O,K]=p.useState([]),[J,R]=p.useState(!1),H=p.useRef(O),ee=p.useRef(A);p.useRef(null);const D=p.useRef(null),ue=p.useRef(null);p.useEffect(()=>{H.current=O},[O]),p.useEffect(()=>{ee.current=A},[A]),p.useEffect(()=>{(async()=>{var r;try{const i=new URLSearchParams(window.location.search).get("project");if(!i){U("No se encontró el ID del proyecto en la URL"),v(!1);return}const c=await fetch(`/api/canvas/projects/${i}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!c.ok)throw new Error("Error al cargar el proyecto");const d=await c.json();l(d.project),f(d.item),x(d.canvasPreset),T(d.initialProject),v(!1)}catch(o){console.error("❌ Error cargando proyecto:",o),U(o.message),v(!1)}})()},[]);const[je,Me]=p.useState(pn.Local.get(`${gn.APP_CORRELATIVE}_cart`)??[]);p.useEffect(()=>{pn.Local.set(`${gn.APP_CORRELATIVE}_cart`,je)},[je]);const[m,ie]=p.useState([]),[b,se]=p.useState(0),[ce,Ge]=p.useState("preset"),[z,Y]=p.useState(null),[G,pe]=p.useState(null),[Q,be]=p.useState("pages"),[Nt,Ce]=p.useState("basic"),[Ae,De]=p.useState([JSON.stringify(m)]),[Se,ze]=p.useState(0),[Gt,Ca]=p.useState(!1),[Na,qt]=p.useState(null),[te,ne]=p.useState({}),{thumbnails:Je,isConverting:Kt,getStats:Dt}=xa(te);p.useEffect(()=>{typeof window<"u"&&(window.checkBlobOptimization=()=>{const t=Dt();return console.log("📊 [BLOB-OPTIMIZATION] Estadísticas del sistema:"),console.log(`📄 Data URLs originales: ${t.dataCount}`),console.log(`🔗 Blob URLs optimizados: ${t.blobCount}`),console.log(`📈 Tasa de conversión: ${t.conversionRate}%`),console.log(`💾 Memoria liberada: ~${t.totalSizeMB} MB`),console.log(`⚡ Convirtiendo: ${Kt?"Sí":"No"}`),console.log(`
🔍 [COMPARISON] Comparación de thumbnails:`),Object.entries(te).forEach(([r,o])=>{const i=Je[r];if(o&&i){const c=i.startsWith("blob:");console.log(`📄 ${r}: ${c?"✅ OPTIMIZADO":"❌ SIN OPTIMIZAR"}`)}}),t},window.forceBlobConversion=()=>{console.log("🔄 [FORCE-CONVERSION] Forzando conversión de todos los thumbnails..."),ne(t=>({...t}))})},[te,Je,Dt,Kt]);const[ja,Sa]=p.useState(!1),[_e,Ue]=p.useState([]),[jt,Jt]=p.useState(!1),[at,Bn]=p.useState(new Map),[Qe,zn]=p.useState(()=>new Map),[Ye,Qt]=p.useState(null),[Yt,Xt]=p.useState(!1);p.useEffect(()=>{Ee("✅ [FILTERS] Tab actual:",Q)},[Q]),p.useCallback((t,r="manual")=>{if(Ee(`🔄 [ACTIVE_TAB] Cambiando de "${Q}" a "${t}" - Razón: ${r}`),t==="filters"&&r!=="manual"){console.warn("🚨 [ACTIVE_TAB] Cambio automático a filters bloqueado!");return}be(t)},[Q]),Le||(window.FORCE_THUMBNAIL_REGENERATION=!0,window.PREVENT_THUMBNAIL_RESET=!1,window._protectedThumbnailIds=[],window.THUMBNAIL_PROTECTED=!1,window.PRESERVE_FILTERS=!0),p.useEffect(()=>{Le||(window.forceRegenerateAllThumbnails=()=>{Ee("💣 [EMERGENCIA-GLOBAL] Forzando regeneración de TODOS los thumbnails"),window.thumbnailCache={},F(t=>{const r=new Map(t);return m.forEach((o,i)=>{r.set(i,Date.now())}),r}),Ee("1️⃣ Regenerando página actual"),oe(!0).then(()=>{Ee("✅ Primera regeneración completa"),window.BLOCK_AUTO_REGENERATION=!0,setTimeout(()=>{Ee("2️⃣ Ejecutando segunda regeneración forzada"),window.forceRegenerateThumbnail&&window.forceRegenerateThumbnail(),window.THUMBNAIL_PROTECTED=!0,setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,Ee("🔓 Regeneración automática desbloqueada")},5e3)},200)}).catch(t=>{console.error("❌ Error en regeneración de emergencia:",t)})})},[m]),p.useEffect(()=>{window._protectedThumbnails||(window._protectedThumbnails=new Set),window.protectThumbnail=t=>{window._protectedThumbnails.add(t),Ee(`🛡️ [PROTECT] Thumbnail ${t} marcado como protegido`)},window.unprotectThumbnail=t=>{window._protectedThumbnails.delete(t),Ee(`🔓 [UNPROTECT] Thumbnail ${t} desprotegido`)},window.isThumbnailProtected=t=>{var r;return((r=window._protectedThumbnails)==null?void 0:r.has(t))||!1},window.blockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!0,Ee("🚫 [BLOCK AUTO] Regeneraciones automáticas BLOQUEADAS")},window.unblockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!1,Ee("✅ [UNBLOCK AUTO] Regeneraciones automáticas DESBLOQUEADAS")},window.isAutoRegenerationBlocked=()=>window._blockAutoRegeneration||!1,window._thumbnailWatchdog||(window._thumbnailWatchdog=setInterval(()=>{window._protectedThumbnailData&&window._protectedThumbnails&&Array.from(window._protectedThumbnails).forEach(r=>{const o=window._protectedThumbnailData[r];o&&ne(i=>i[r]&&i[r]!==o?(console.error(`🚨 [WATCHDOG] ¡SOBRESCRITURA DETECTADA! Restaurando ${r}`),{...i,[r]:o}):i)})},100)),window._interceptorInstalled||(window._interceptorInstalled=!0)},[]);const[st,Xe]=p.useState(!1),Zt=p.useRef(),[$,er]=p.useState({width:800,height:600}),Un=p.useCallback((t,r,o="unknown")=>{var i;return(i=window.isThumbnailProtected)!=null&&i.call(window,t)?(console.error(`� [PROTECTION BLOCK] ¡BLOQUEADO! Intento de sobrescribir thumbnail protegido ${t} desde: ${o}`),console.error("🚨 [PROTECTION BLOCK] Stack trace:",new Error().stack),!1):(ne(c=>(c[t],{...c,[t]:r})),!0)},[]),tr=p.useMemo(()=>ma({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¡Bienvenido al Editor de BananaLab! 🍌",description:"Este es tu lienzo de trabajo donde crearás diseños increíbles. Aquí puedes ver y editar la página actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"🎯 Navegación Principal",description:"En la barra lateral izquierda encontrarás todas las herramientas organizadas por categorías. Cada ícono te lleva a una sección específica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"📄 Sección Páginas",description:"Gestiona todas las páginas de tu proyecto: portada, páginas de contenido y contraportada. Haz clic en cualquier página para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"🎨 Sección Diseños",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu página. Cada diseño tiene una distribución única.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"📚 Sección Capas",description:"Organiza y controla la superposición de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posición.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"✍️ Sección Textos",description:"Agrega y personaliza textos: títulos, subtítulos y párrafos. Cambia fuentes, colores, tamaños y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"🎭 Sección Filtros",description:"Aplica efectos visuales a tus imágenes: brillo, contraste, saturación, máscaras y más filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"⚡ Acciones Rápidas",description:"Herramientas de acceso rápido: cambiar diseño de página, gestionar capas, agregar imágenes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"💾 Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso automáticamente y acceder a la vista previa de tu álbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"👁️ Vista de Álbum",description:"Visualiza tu proyecto completo como un álbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"🎉 ¡Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una página y agregando elementos. ¡Diviértete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente →",prevBtnText:"← Anterior",doneBtnText:"¡Empezar a crear! 🚀",closeBtnText:"✕",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(t,r)=>{var i;const o=(i=t==null?void 0:t.getAttribute)==null?void 0:i.call(t,"data-tab");o&&Q!==o&&be(o)},onDeselected:()=>{re.success("¡Guía completada! Ya puedes empezar a crear tu diseño.",{duration:3e3})}}),[Q,be]),Fn=p.useCallback(()=>{tr.drive()},[tr]),St=p.useCallback(async()=>{if(n!=null&&n.id)try{const t=await fetch(`/api/thumbnails/${n.id}`);if(t.ok){const r=await t.json();if(r.success&&r.thumbnails&&r.thumbnails.length>0){const o={};r.thumbnails.forEach(i=>{i.page_id&&i.thumbnail_url&&(o[i.page_id]=i.thumbnail_url)}),Object.keys(o).length>0&&ne(i=>{var d;console.warn("🚨 [STORAGE LOAD] ¡ALERTA! Cargando thumbnails desde storage - POSIBLE CULPABLE DE SOBRESCRITURA"),console.warn("🚨 [STORAGE LOAD] Thumbnails protegidos:",Array.from(window._protectedThumbnails||[])),console.warn("🚨 [STORAGE LOAD] Stack trace:",new Error().stack);const c={};for(const[g,u]of Object.entries(o))(d=window.isThumbnailProtected)!=null&&d.call(window,g)?console.warn(`🛡️ [STORAGE PROTECTION] NO sobrescribiendo thumbnail protegido: ${g}`):c[g]=u;return{...i,...c}})}}}catch(t){console.warn("⚠️ Error cargando thumbnails guardados (usando locales):",t)}},[n==null?void 0:n.id]),it=p.useRef(new Map),$e=p.useRef(new Map),Tt=p.useRef(null);p.useEffect(()=>(Tt.current=setInterval(()=>{const t=Date.now(),r=10*60*1e3;for(const[o,i]of $e.current.entries())t-i.timestamp>r&&$e.current.delete(o);if(window.thumbnailCache&&typeof window.thumbnailCache=="object"){const o=Object.keys(window.thumbnailCache);if(o.length>100){const i=o.sort().slice(-60),c={};i.forEach(d=>{c[d]=window.thumbnailCache[d]}),window.thumbnailCache=c}}},3e5),()=>{Tt.current&&clearInterval(Tt.current)}),[]);const rr=p.useMemo(()=>JSON.stringify($),[$]),oe=p.useCallback(async(t=!1)=>{var d,g,u;if(window.BLOCK_AUTO_REGENERATION&&!t)return;const r=m[b];if(!r||!$)return;console.log("pagina current actual",r);const o=r.id;if(!t){it.current.has(o)&&clearTimeout(it.current.get(o));const h=setTimeout(()=>{it.current.delete(o),oe(!0)},300);it.current.set(o,h);return}const i=`${o}-${rr}`;if(!t&&$e.current.has(i)){const h=$e.current.get(i);if(h&&Date.now()-h.timestamp<6e4)return}let c=!1;if(r.cells&&r.cells.forEach(h=>{h.elements&&h.elements.forEach(w=>{w.filters&&(w.filters.brightness!==void 0&&w.filters.brightness!==100&&w.filters.brightness!==1||w.filters.contrast!==void 0&&w.filters.contrast!==100&&w.filters.contrast!==1||w.filters.saturation!==void 0&&w.filters.saturation!==100&&w.filters.saturation!==1||w.filters.tint!==void 0&&w.filters.tint!==0||w.filters.hue!==void 0&&w.filters.hue!==0||w.filters.blur!==void 0&&w.filters.blur>0||w.filters.opacity!==void 0&&w.filters.opacity!==100&&w.filters.opacity!==1||w.filters.scale!==void 0&&w.filters.scale!==1||w.filters.rotate!==void 0&&w.filters.rotate!==0||w.filters.flipHorizontal||w.filters.flipVertical)&&(c=!0,w._hasRealFilters=!0)})}),!t&&!c&&te[o]){const h=((d=window._thumbnailGenTimes)==null?void 0:d[o])||0;if(Date.now()-h<3e5)return}if(!Ie.current){Ie.current=!0;try{window._currentPageData=r,window._workspaceDimensions=$,window._updateThumbnailInUI=(_,L)=>{var j;if((j=window.isThumbnailProtected)!=null&&j.call(window,_)){console.error(`🚨 [UPDATE BLOCKED] ¡BLOQUEADO! Intento de actualizar thumbnail protegido ${_} via _updateThumbnailInUI`),console.error("🚨 [UPDATE BLOCKED] Stack trace:",new Error().stack);return}ne(M=>({...M,[_]:L}))},window._thumbnailGenTimes||(window._thumbnailGenTimes={}),window._thumbnailGenTimes[o]=Date.now();let h=null;const w=ae.find(_=>_.id===r.layout)||ae[0];if(w.cellStyles&&Object.values(w.cellStyles).some(_=>_.includes("col-span-")||_.includes("row-span-"))){console.log("🏗️ [LAYOUT COMPLEJO] Usando generador especializado para layout:",w.id);try{console.log("✅ [LAYOUT COMPLEJO] Thumbnail generado exitosamente")}catch(_){console.error("❌ [LAYOUT COMPLEJO] Error, usando fallback:",_),h=await gt(r,$)}}else if(c||t)try{h=await gt(r,$)}catch(_){console.error("❌ [MÉTODO RADICAL] Error, usando fallback:",_),h=await hn({page:r,workspaceDimensions:$,preserveFilters:!0})}else h=await hn({page:r,workspaceDimensions:$,preserveFilters:!1});if(h){if(c){(g=window.protectThumbnail)==null||g.call(window,o),(u=window.blockAutomaticRegeneration)==null||u.call(window),ne(j=>({...j,[o]:h})),setTimeout(()=>{ne(j=>j[o]!==h?(va(`🚨 [PROTECTION RESTORE] Restaurando thumbnail protegido para ${o}`),{...j,[o]:h}):j)},100);const L=()=>{ne(j=>j[o]!==h?(Ke(`🚨 [EMERGENCY RESTORE] ¡PARPADEO DETECTADO! Restaurando thumbnail para ${o}`),{...j,[o]:h}):j)};setTimeout(L,200),setTimeout(L,500),setTimeout(L,1e3),setTimeout(L,2e3),window._protectedThumbnailData||(window._protectedThumbnailData={}),window._protectedThumbnailData[o]=h}else Un(o,h,"generateCurrentPageThumbnail");c&&!t&&(window._filterVerificationDone||(window._filterVerificationDone=new Set),window._filterVerificationDone.has(o)||(window._filterVerificationDone.add(o),setTimeout(async()=>{var L;try{const j=await gt(r,$);j&&((L=window.protectThumbnail)==null||L.call(window,o),ne(M=>({...M,[o]:j})))}catch(j){console.warn("⚠️ [RADICAL FALLBACK] Error en método radical:",j)}},1e3))),c&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(o)||window._protectedThumbnailIds.push(o));const _=`${o}-${rr}`;if($e.current.set(_,{data:h,timestamp:Date.now(),hasFilters:c}),$e.current.size>50){const L=$e.current.keys().next().value;$e.current.delete(L)}}else console.error(`❌ [ERROR] No se pudo generar thumbnail para página: ${o}`)}catch(h){console.error(`❌ [CRITICAL ERROR] Error generando thumbnail para página ${o}:`,h)}finally{Ie.current=!1}}},[m,b,$,te]),kt=p.useCallback(xt(async()=>{var t;if(!window.BLOCK_AUTO_REGENERATION&&!window.THUMBNAIL_PROTECTED&&!(!(m!=null&&m.length)||!$)&&!Ie.current){Ie.current=!0;try{const r=m.filter(i=>!te[i.id]);if(r.length===0)return;if((t=window.isAutoRegenerationBlocked)!=null&&t.call(window)){console.warn("🚫 [BLOCKED] Regeneración automática bloqueada, saltando generateFastThumbnails");return}const o=await fn({pages:r,workspaceDimensions:$,onProgress:i=>{Qt(i)}});o&&Object.keys(o).length>0&&ne(i=>{var d;console.warn("🚨 [FAST THUMBNAILS] ¡ALERTA! generateFastThumbnails sobrescribiendo thumbnails - POSIBLE CULPABLE"),console.warn("🚨 [FAST THUMBNAILS] Stack trace:",new Error().stack);const c={};for(const[g,u]of Object.entries(o))(d=window.isThumbnailProtected)!=null&&d.call(window,g)?console.warn(`🛡️ [FAST PROTECTION] NO sobrescribiendo thumbnail protegido: ${g}`):c[g]=u;return{...i,...c}})}catch(r){console.warn("⚠️ Error generando thumbnails rápidos:",r)}finally{Ie.current=!1,Qt(null)}}},300),[m,$,te]),Ie=p.useRef(!1);p.useCallback(async(t=[])=>{var r;if(!Ie.current)try{if(Ie.current=!0,t.length>0){const o=m.filter(i=>t.includes(i.id));if(o.length>0)if((r=window.isAutoRegenerationBlocked)!=null&&r.call(window))console.warn("🚫 [BLOCKED] Regeneración de prioridad bloqueada, saltando generateFastThumbnails");else{const i=await fn({pages:o,workspaceDimensions:$});i&&Object.keys(i).length>0&&ne(c=>{var g;console.warn("🚨 [PRIORITY THUMBNAILS] ¡ALERTA! generateFastThumbnails de prioridad sobrescribiendo - POSIBLE CULPABLE"),console.warn("🚨 [PRIORITY THUMBNAILS] Stack trace:",new Error().stack);const d={};for(const[u,h]of Object.entries(i))(g=window.isThumbnailProtected)!=null&&g.call(window,u)?console.warn(`🛡️ [PRIORITY PROTECTION] NO sobrescribiendo thumbnail protegido: ${u}`):d[u]=h;return{...c,...d}})}}}catch(o){console.warn("⚠️ Error en generación prioritaria:",o)}finally{Ie.current=!1}},[m,$,kt]);const nr=p.useCallback(t=>{if(Qe.has&&Qe.has(t))return;const r=new Image;r.crossOrigin="anonymous",r.onload=()=>{if(r.width>1200||r.height>1200){const i=document.createElement("canvas"),c=i.getContext("2d"),d=1200,g=Math.min(d/r.width,d/r.height),u=r.width*g,h=r.height*g;i.width=u,i.height=h,c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(r,0,0,u,h),i.toBlob(w=>{if(w){const I=URL.createObjectURL(w);zn(_=>{const L=new Map(_);if(L.set(t,I),L.size>15){const j=L.keys().next().value,M=L.get(j);URL.revokeObjectURL(M),L.delete(j)}return L})}},"image/webp",.85)}},r.onerror=()=>{console.warn("❌ Error pre-cargando imagen:",t)},r.src=t},[]);p.useEffect(()=>{_e.length>0&&_e.slice(0,10).forEach((r,o)=>{setTimeout(()=>{nr(r.url)},o*100)})},[_e,nr]),p.useEffect(()=>()=>{Qe&&Qe.forEach&&Qe.forEach(t=>URL.revokeObjectURL(t))},[]),p.useEffect(()=>()=>{zt()},[]);const or=p.useCallback(async()=>{var t;if(!(!(n!=null&&n.id)||!(m!=null&&m.length))&&!Yt)try{Xt(!0);const r=await fetch(`/api/thumbnails/${n.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:m})});if(r.ok){const o=await r.json();o&&Object.keys(o).length>0?ne(i=>({...i,...o})):setTimeout(()=>oe(),200)}}catch(r){console.warn("⚠️ Error cargando thumbnails existentes:",r),setTimeout(()=>oe(),200)}finally{Xt(!1)}},[n==null?void 0:n.id,m,oe,Yt]);p.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(m!=null&&m.length)))try{const t=m[b];if(!t)return;const r=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(r.ok){const o=await r.json();if(o.success&&o.thumbnails){const i={};o.thumbnails.forEach(c=>{c.page_id&&c.thumbnail_url&&(i[c.page_id]=c.thumbnail_url)}),ne(c=>({...c,...i}))}}}catch(t){console.warn("⚠️ Error generando thumbnail:",t)}},[n==null?void 0:n.id,m,b,$]),p.useCallback(async()=>{if(!(!(n!=null&&n.id)||!(m!=null&&m.length)))try{const t=await fetch(`/api/thumbnails/${n.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:m,width:$.width,height:$.height,quality:95,scale:4,dpi:300})});if(t.ok){const r=await t.json();if(r.success&&r.thumbnails){const o={};r.thumbnails.forEach(i=>{i.page_id&&i.thumbnail_url&&(o[i.page_id]=i.thumbnail_url)}),ne(i=>({...i,...o}))}}}catch(t){console.warn("⚠️ Error generando todos los thumbnails:",t)}},[n==null?void 0:n.id,m,$]);const Hn=p.useCallback(async(t=null)=>{if(!(n!=null&&n.id)||!(m!=null&&m.length))return{};try{const r={},o={};let i=0;const c=async(g,u)=>new Promise(h=>{const w=new Image;w.onload=()=>{o[u]=g,i++,t==null||t(i,m.length),h(!0)},w.onerror=()=>{console.warn(`⚠️ [ALBUM-MODAL] Thumbnail no encontrado: ${g}`),i++,t==null||t(i,m.length),h(!1)},w.src=g}),d=m.map(async(g,u)=>{let h;const w=a&&(a.has_cover_image===!0||a.has_cover_image===1),I=a&&(a.has_back_cover_image===!0||a.has_back_cover_image===1),_=w&&m.some(E=>E.type==="cover"),L=I&&m.some(E=>E.type==="final");if(g.type==="cover")h=0;else if(g.type==="content")_?h=m.filter(P=>P.type==="content").findIndex(P=>P.id===g.id)+1:h=m.filter(P=>P.type==="content").findIndex(P=>P.id===g.id)+1;else if(g.type==="final"){const E=m.filter(P=>P.type==="content");h=E.length+1}else h=u;const j=`/storage/images/thumbnails/${n.id}/page-${h}-pdf.png`,M=g.id||`page-${u}`;return r[M]=j,c(j,M)});return await Promise.all(d),r}catch(r){return console.warn("⚠️ [ALBUM-MODAL] Error cargando thumbnails PDF:",r),{}}},[n==null?void 0:n.id,m,a]);p.useEffect(()=>{if(C&&a&&s){if(C.pages&&Array.isArray(C.pages)){const t=C.pages.map(r=>{let o=null,i=s.background_color||"#ffffff";return r.type==="cover"&&(a.has_cover_image===!0||a.has_cover_image===1)?a.cover_image&&(o=`/storage/images/item/${a.cover_image}`):r.type==="content"?a.content_image&&(o=`/storage/images/item/${a.content_image}`):(r.type==="final"||r.type==="contraportada")&&(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&a.back_cover_image&&(o=`/storage/images/item/${a.back_cover_image}`),{...r,backgroundImage:o,backgroundColor:i}}).filter(r=>!(r.type==="cover"&&(a.has_cover_image===!1||a.has_cover_image===0)||(r.type==="final"||r.type==="contraportada")&&(a.has_back_cover_image===!1||a.has_back_cover_image===0)));ie(r=>r.length>0?r.map((o,i)=>{const c=t[i];return c?{...o,backgroundImage:o.backgroundImage||c.backgroundImage,backgroundColor:o.backgroundColor||c.backgroundColor}:o}):t),De(r=>r.length<=1?[JSON.stringify(t)]:r),ze(r=>r===0&&Ae.length<=1?0:r),setTimeout(()=>{St()},100)}else{const t=gr(s,a);ie(t),De([JSON.stringify(t)]),ze(0),setTimeout(()=>{St()},100)}typeof C.currentPage=="number"&&se(C.currentPage),C.workspaceSize&&Ge(C.workspaceSize)}},[C,a,s,St]);const Oe=fa(m,n,a,s,$,te),ar=()=>{if(s!=null&&s.width&&(s!=null&&s.height)){let u=s.width,h=s.height,w=u*37.8,I=h*37.8;if(w&&I){const _=window.innerWidth*.6,L=window.innerHeight*.7,j=_/w,M=L/I,E=Math.min(j,M,1);return{width:Math.round(w*E),height:Math.round(I*E),originalWidth:u,originalHeight:h,scale:E,unit:"cm",originalWidthPx:Math.round(w),originalHeightPx:Math.round(I)}}}if(s!=null&&s.extra_settings)try{const u=typeof s.extra_settings=="string"?JSON.parse(s.extra_settings):s.extra_settings;if(u!=null&&u.canvas_config){const h=u.canvas_config;let w=h.width,I=h.height,_=w*37.8,L=I*37.8;if(_&&L){const j=window.innerWidth*.6,M=window.innerHeight*.7,E=j/_,W=M/L,P=Math.min(E,W,1);return{width:Math.round(_*P),height:Math.round(L*P),originalWidth:w,originalHeight:I,scale:P,unit:"cm",originalWidthPx:Math.round(_),originalHeightPx:Math.round(L)}}}}catch(u){console.warn("Error parsing extra_settings:",u)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},r=t[ce]||t.preset,o=Le?1200:window.innerWidth*.6,i=Le?800:window.innerHeight*.7,c=o/r.width,d=i/r.height,g=Math.min(c,d,1);return{width:Math.round(r.width*g),height:Math.round(r.height*g),originalWidth:r.width,originalHeight:r.height,scale:g,unit:"px"}},Pe=p.useCallback(async(t={type:"thumbnail"})=>{var r;if(Le)return Ke("🚫 [VPS-PROTECTION] captureCurrentWorkspace bloqueado en servidor"),null;if(!m[b])return null;try{let o=document.querySelector(`#page-${m[b].id}`);if(!o)return console.warn("❌ THUMBNAIL: No se encontró el elemento de página específico"),null;const i=m[b],d=(i==null?void 0:i.cells)&&i.cells.length>0&&o.classList.contains("grid");Ee(`🔧 [CAPTURE-MODE] Página ${b}: ${d?"LAYOUT":"LIBRE"}, Celdas: ${((r=i==null?void 0:i.cells)==null?void 0:r.length)||0}`),d&&await new Promise(W=>{requestAnimationFrame(()=>{const P=o.querySelectorAll("[data-cell-id]");W()})});const g=t.type==="pdf",u=!0,h=g?11.81:u?2:3,w=1,I=getComputedStyle(o);let _=(i==null?void 0:i.backgroundColor)||"#ffffff";I.backgroundColor&&I.backgroundColor!=="rgba(0, 0, 0, 0)"&&(_=I.backgroundColor);const L={scale:h,useCORS:!0,allowTaint:!1,backgroundColor:_,width:$.width,height:$.height,x:0,y:0,scrollX:0,scrollY:0,...d&&{windowWidth:$.width,windowHeight:$.height,ignoreElements:E=>{var W;return E.style&&E.style.filter&&t.preserveFilters?!1:(W=E.classList)==null?void 0:W.contains("exclude-from-capture")}},...!d&&{ignoreElements:E=>{var W;return E.style&&E.style.filter&&t.preserveFilters?!1:(W=E.classList)==null?void 0:W.contains("exclude-from-capture")}},foreignObjectRendering:!!(g||d),removeContainer:!1,logging:!!(d&&!u),imageTimeout:g?6e4:d?u?15e3:3e4:15e3,pixelRatio:g?3:u||Le?1:window.devicePixelRatio||1,...d&&{allowTaint:!0,useCORS:!0,letterRendering:!u,ignoreElements:E=>{var W,P;return((W=E.classList)==null?void 0:W.contains("exclude-from-capture"))||((P=E.classList)==null?void 0:P.contains("ui-element"))}},canvas:g?document.createElement("canvas"):null,windowWidth:g?$.width*h:null,windowHeight:g?$.height*h:null,onclone:async E=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(P=>{try{E.querySelectorAll(P).forEach(ve=>ve.remove())}catch(q){console.warn("Error removing selector:",P,q)}});try{const P=E.querySelector(`#page-${m[b].id}`);if(P){if(P.style.width=$.width+"px",P.style.height=$.height+"px",d||(P.style.position="relative"),P.style.overflow="hidden",i!=null&&i.backgroundImage&&(P.style.backgroundImage=`url(${i.backgroundImage})`,P.style.backgroundSize="cover",P.style.backgroundPosition="center",P.style.backgroundRepeat="no-repeat"),P.querySelectorAll('[style*="filter"]').forEach(ve=>{}),d){const ve=P.className,Fe=getComputedStyle(o);P.style.display="grid",P.style.gridTemplateColumns=Fe.gridTemplateColumns,P.style.gridTemplateRows=Fe.gridTemplateRows,P.style.gap=Fe.gap,P.querySelectorAll("[data-cell-id]").forEach((we,Z)=>{const ye=o.querySelector(`[data-cell-id="${we.getAttribute("data-cell-id")}"]`);if(ye){const he=getComputedStyle(ye);we.style.gridColumn=he.gridColumn,we.style.gridRow=he.gridRow,we.style.position="relative"}we.querySelectorAll('img, [data-element-type="image"]').forEach(he=>{he.style.position==="absolute"&&(he.style.position="absolute")})})}i!=null&&i.backgroundColor&&(P.style.backgroundColor=i.backgroundColor)}}catch(P){console.error("❌ [THUMBNAIL-FIX] Error configurando elemento de página:",P)}try{const P=new Map;o.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((Z,ye)=>{if(Z.complete&&Z.naturalWidth>0){const he=(Z.closest('[data-element-type="image"]')||Z.parentElement).getBoundingClientRect(),He=Z.getBoundingClientRect();P.set(Z.src,{src:Z.src,naturalWidth:Z.naturalWidth,naturalHeight:Z.naturalHeight,containerWidth:he.width,containerHeight:he.height,objectFit:getComputedStyle(Z).objectFit||"cover",objectPosition:getComputedStyle(Z).objectPosition||"center",crossOrigin:Z.crossOrigin})}});const ve=async(Z,ye,fe,he,He)=>new Promise(ct=>{try{const rt=ye/fe,Lt=he/He;let dt,ut,Mt,$t,ln,cn;Lt>rt?(cn=fe,ln=fe*Lt,ut=He,dt=He*rt,Mt=(he-dt)/2,$t=0):(ln=ye,cn=ye/Lt,dt=he,ut=he/rt,Mt=0,$t=(He-ut)/2);const mt=E.createElement("canvas");mt.width=ye,mt.height=fe;const so=mt.getContext("2d"),nt=new Image;nt.crossOrigin="anonymous",nt.onload=()=>{try{so.drawImage(nt,Mt,$t,dt,ut,0,0,ye,fe);const Bt=mt.toDataURL("image/png",1);Z.src=Bt,Z.style.objectFit="fill",Z.style.objectPosition="center",Z.style.width="100%",Z.style.height="100%",ct()}catch(Bt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en canvas processing:",Bt),ct()}},nt.onerror=()=>{console.warn("⚠️ [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),ct()},nt.src=Z.src}catch(rt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",rt),ct()}}),Fe=E.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),Re=[];Fe.forEach((Z,ye)=>{if(Z.src&&P.has(Z.src)){const fe=P.get(Z.src),he=Z.closest('[data-element-type="image"]')||Z.parentElement;if(he&&(he.style.overflow="hidden",he.style.position="relative"),fe.objectFit==="cover"||Z.classList.contains("object-cover")||Z.classList.contains("workspace-image")){const He=ve(Z,fe.containerWidth,fe.containerHeight,fe.naturalWidth,fe.naturalHeight);Re.push(He)}else Z.style.width="100%",Z.style.height="100%",Z.style.objectFit="fill"}}),Re.length>0&&await Promise.all(Re);const we=E.createElement("style");we.textContent=`
                            /* CORRECCIÓN THUMBNAIL: Estructura del elemento de página */
                            #page-${m[b].id} {
                                width: ${$.width}px !important;
                                height: ${$.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* 🖨️ IMÁGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya están recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${g?`
                                /* 🖨️ IMPRESIÓN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de página */
                            #page-${m[b].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* 🖨️ OPTIMIZACIONES GENERALES PARA PDF DE IMPRESIÓN */
                            ${g?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,E.head.appendChild(we)}catch(P){console.error("❌ [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",P);const q=E.createElement("style");q.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,E.head.appendChild(q)}}};let j=null,M="";try{if(j=await dn(o,L),g&&j){const E=j.getContext("2d");if(E){E.imageSmoothingEnabled=!1,E.imageSmoothingQuality="high";const W=E.getImageData(0,0,j.width,j.height),P=W.data;for(let q=0;q<P.length;q+=4)P[q]=Math.min(255,P[q]*1.05),P[q+1]=Math.min(255,P[q+1]*1.05),P[q+2]=Math.min(255,P[q+2]*1.05);E.putImageData(W,0,0)}}if(!j)throw new Error("html2canvas no devolvió un canvas válido para el elemento de página");if(j.width===0||j.height===0)throw new Error("Canvas del elemento de página tiene dimensiones inválidas");M=j.toDataURL("image/png",w)}catch(E){throw console.error("❌ [ERROR-CAPTURA]:",E),E}finally{if(j){const E=j.getContext("2d");E&&E.clearRect(0,0,j.width,j.height),j.width=0,j.height=0,j=null}if(u&&window.gc)try{window.gc()}catch{}}if(!M||M==="data:,")throw new Error("No se pudo generar dataURL del elemento de página");return g?j:M}catch(o){console.error("❌ [THUMBNAIL-FIX] Error capturando elemento de página:",o);try{const i=document.createElement("canvas"),c=t.type==="pdf"?11.81:1;i.width=$.width*c,i.height=$.height*c;const d=i.getContext("2d"),g=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return d.fillStyle=g,d.fillRect(0,0,i.width,i.height),d.fillStyle=g==="#ffffff"||g.includes("white")?"#374151":"#666666",d.font=`${14*c}px Arial`,d.textAlign="center",d.fillText("Página "+(b+1),i.width/2,i.height/2),t.type==="pdf"?i:i.toDataURL("image/png",1)}catch{return null}}},[b,m]);p.useCallback(async()=>{if(!m[b])return;const t=await Pe({type:"thumbnail"});t&&ne(r=>({...r,[m[b].id]:t}))},[Pe,b,m]),p.useCallback(()=>{clearTimeout(Zt.current),Zt.current=setTimeout(()=>{m[b]&&(ne(t=>{const r={...t};return delete r[m[b].id],r}),setTimeout(()=>{oe()},200))},1e3)},[m,b,oe]);const Wn=p.useCallback(()=>{m[b]&&(ne(t=>{const r={...t};return delete r[m[b].id],r}),setTimeout(()=>{oe()},300))},[m,b,oe]),Vn=p.useCallback(async(t=b,r={width:800,height:600})=>{var o,i;if(!m[t])return null;try{const c=b;t!==b&&(se(t),await new Promise(h=>setTimeout(h,100)));const d=document.querySelector(`#page-${m[t].id}`);if(!d)return console.warn("Workspace element not found for page:",m[t].id),null;const g={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((o=m[t])==null?void 0:o.backgroundColor)||"#ffffff",width:d.offsetWidth,height:d.offsetHeight,removeContainer:!0,logging:!1,onclone:h=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(j=>{h.querySelectorAll(j).forEach(E=>E.remove())});const I=h.querySelector(`#page-${m[t].id}`);if(I){const j=m[t];j!=null&&j.backgroundImage&&(I.style.backgroundImage=`url(${j.backgroundImage})`,I.style.backgroundSize="cover",I.style.backgroundPosition="center",I.style.backgroundRepeat="no-repeat"),j!=null&&j.backgroundColor&&(I.style.backgroundColor=j.backgroundColor)}try{const j=d.querySelectorAll("img"),M=new Map;j.forEach((W,P)=>{const q=getComputedStyle(W);M.set(P,{objectFit:q.objectFit,objectPosition:q.objectPosition,width:q.width,height:q.height,borderRadius:q.borderRadius,transform:q.transform})}),h.querySelectorAll("img").forEach((W,P)=>{const q=M.get(P);q&&(W.style.objectFit=q.objectFit||"cover",W.style.objectPosition=q.objectPosition||"center",W.style.width=q.width,W.style.height=q.height,W.style.borderRadius=q.borderRadius,W.style.transform=q.transform)})}catch(j){console.warn("Error preservando estilos de imágenes:",j),h.querySelectorAll("img").forEach(E=>{E.style.objectFit="cover",E.style.objectPosition="center",E.style.width||(E.style.width="100%"),E.style.height||(E.style.height="100%")})}h.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(j=>{const M=j.className;M&&(j.className=M);const E=getComputedStyle?getComputedStyle(j):null;E&&(E.fontFamily&&E.fontFamily!=="Arial"&&(j.style.fontFamily=E.fontFamily),E.fontSize&&(j.style.fontSize=E.fontSize),E.fontWeight&&(j.style.fontWeight=E.fontWeight),E.fontStyle&&(j.style.fontStyle=E.fontStyle))});const L=h.createElement("style");L.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CRÍTICO: Asegurar que las imágenes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CRÍTICO: Asegurar que los backgrounds de página se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,h.head.appendChild(L)}},u=await dn(d,g);if(r.width!==u.width||r.height!==u.height){const h=document.createElement("canvas");h.width=r.width,h.height=r.height;const w=h.getContext("2d"),I=u.width/u.height,_=r.width/r.height;let L,j,M=0,E=0;I>_?(L=r.width,j=r.width/I,E=(r.height-j)/2):(j=r.height,L=r.height*I,M=(r.width-L)/2),w.fillStyle=((i=m[t])==null?void 0:i.backgroundColor)||"#ffffff",w.fillRect(0,0,r.width,r.height),w.drawImage(u,M,E,L,j);const W=h.toDataURL("image/png",1);return t!==c&&se(c),W}return t!==c&&se(c),u.toDataURL("image/png",1)}catch(c){return console.error("❌ Error generando thumbnail de alta calidad:",c),null}},[m,b,se]);p.useEffect(()=>{const t=ar();er(t)},[s,ce]),p.useEffect(()=>{const t=()=>{const r=ar();er(r)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s,ce]),p.useEffect(()=>{if(!Le&&m[b]&&!te[m[b].id]){const t=setTimeout(()=>{oe()},500);return()=>clearTimeout(t)}},[b,m,te,oe]),p.useEffect(()=>{const t=m[b];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(r=>{r.ok||console.error("❌ [WORKSPACE] Imagen NO existe en el servidor. Status:",r.status)}).catch(r=>{console.error("❌ [WORKSPACE] Error verificando imagen:",r)})},[b,(wr=m[b])==null?void 0:wr.backgroundImage]),p.useEffect(()=>{const t=`${$.width}x${$.height}`,r=sessionStorage.getItem("lastWorkspaceDimensions");r&&r!==t&&m.length>0&&(ne({}),setTimeout(()=>{m[b]&&Wn()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[$.width,$.height]),p.useEffect(()=>{if(!(n!=null&&n.id)||m.length===0)return;let t,r=Date.now(),o=!1;const i=()=>{o=!0,r=Date.now()},c=async()=>{if(o)try{setAutoSave(h=>({...h,saveStatus:"saving"}));const g=await fetch(`/api/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:m,force:!1})}),u=await g.json();if(g.ok&&u.success)o=!1,S(h=>({...h,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1}));else throw new Error("Guardado falló")}catch(g){console.error("❌ [AUTO-SAVE] Error en guardado silencioso:",g),S(u=>({...u,saveStatus:"error",saveError:g.message}))}},d=()=>{t=setInterval(()=>{const g=Date.now()-r;o&&g>6e4&&c()},3*60*1e3)};return JSON.stringify(m),m[b],i(),d(),()=>{t&&clearInterval(t)}},[m,b,n==null?void 0:n.id]),p.useEffect(()=>{var r;if(!m[b])return;const t=((r=m[b].cells)==null?void 0:r.flatMap(o=>o.elements))||[];JSON.stringify(t),S(o=>({...o,hasUnsavedChanges:!0}))},[(yr=m[b])==null?void 0:yr.cells,b]);const[Ta,At]=p.useState(!1),[ka,Gn]=p.useState({elementId:null,cellId:null}),[qn,sr]=p.useState(!1),[Aa,Kn]=p.useState(!1),[_a,Ia]=p.useState(null),[Dn,Jn]=p.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[Be,xe]=p.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de álbum...",subMessage:"Preparando tu vista previa personalizada"}),_t=p.useRef(null),ir=t=>{var i,c,d,g;const r=G||((c=(i=m[b])==null?void 0:i.cells[0])==null?void 0:c.id);if(!r)return;const o={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((g=(d=m[b].cells.find(u=>u.id===r))==null?void 0:d.elements)==null?void 0:g.length)||0)+1};tt(r,o),re.success("Imagen añadida correctamente")},It=p.useCallback(xt(async(t=!1)=>{if(!(n!=null&&n.id))return;const r=at.get(n.id);if(!t&&r&&r.length>0){_e.length===0&&Ue(r);return}if(D.current&&clearTimeout(D.current),!(jt&&!t)){Jt(!0);try{const o=new AbortController,i=setTimeout(()=>o.abort(),1e4),c=await fetch(`/api/canvas/projects/${n.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:o.signal});if(clearTimeout(i),!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const d=await c.json();if(d.success){const g=d.images||[],u=JSON.stringify(_e),h=JSON.stringify(g);u!==h&&(Ue(g),Bn(w=>{const I=new Map(w);if(I.set(n.id,g),I.size>5){const _=I.keys().next().value;I.delete(_)}return I}))}else console.error("Error cargando imágenes:",d.message),re.error("Error cargando galería de imágenes")}catch(o){o.name==="AbortError"?console.warn("⚠️ Carga de imágenes cancelada por timeout"):(console.error("Error cargando imágenes del proyecto:",o),re.error("Error de conexión al cargar imágenes"))}finally{Jt(!1)}}},200),[n==null?void 0:n.id,at,_e,jt]),Qn=p.useCallback(async t=>{const r=t.target.files[0];if(!r||!(n!=null&&n.id))return;const o=re.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),i=URL.createObjectURL(r),c={id:`temp-${Date.now()}`,filename:r.name,url:i,thumbnail_url:i,has_thumbnail:!1,size:r.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Ue(g=>[c,...g]),ir(i);const d=new FormData;d.append("image",r),d.append("projectId",n.id);try{const u=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:d})).json();if(u.success){const h={id:u.id||Date.now(),filename:r.name,url:u.url,thumbnail_url:u.thumbnail_url||u.url,has_thumbnail:u.has_thumbnail||!1,size:r.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Ue(w=>[h,...w.filter(I=>I.id!==c.id)]),setTimeout(()=>{ie(w=>{const I=[...w];return I[b].cells.forEach(L=>{L.elements.forEach(j=>{j.type==="image"&&j.content===i&&(j.content=u.url)})}),I})},100),re.dismiss(o),re.success(u.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{It(!0)},2e3)}else Ue(h=>h.filter(w=>w.id!==c.id)),URL.revokeObjectURL(i),re.dismiss(o),re.error(u.message||"Error al subir la imagen")}catch(g){console.error("Error subiendo la imagen:",g),Ue(u=>u.filter(h=>h.id!==c.id)),URL.revokeObjectURL(i),re.dismiss(o),re.error("Error de red al subir la imagen")}},[n==null?void 0:n.id,b,ir,It]);p.useEffect(()=>{if(n!=null&&n.id){const t=at.get(n.id);if(t&&t.length>0){Ue(t);return}return D.current=setTimeout(()=>{It(!1)},150),()=>{D.current&&clearTimeout(D.current)}}},[n==null?void 0:n.id,at]),p.useEffect(()=>()=>{D.current&&clearTimeout(D.current)},[]);const lr=(t,r)=>{if(!m||m.length===0||!m[b]){console.error("❌ [ADD-IMAGE] No hay páginas válidas para agregar imagen");return}const o=JSON.parse(JSON.stringify(m));let i=!1;for(let c=0;c<o[b].cells.length;c++)if(o[b].cells[c].id===t){o[b].cells[c].elements.push(r),i=!0;break}if(!i){console.error("❌ [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{et(o)},0)},Yn=p.useCallback(t=>{var g,u,h,w;const r=st;Xe(!0);const o=Q==="images",i=G||((u=(g=m[b])==null?void 0:g.cells[0])==null?void 0:u.id);if(!i){console.error("❌ [ADD-FROM-GALLERY] No hay celda disponible"),re.error("No hay celda disponible para agregar la imagen"),Xe(r);return}if(!t||typeof t!="string"){console.error("❌ [ADD-FROM-GALLERY] URL de imagen inválida"),re.error("URL de imagen no válida"),Xe(r);return}const c=JSON.parse(JSON.stringify(m)),d={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((w=(h=c[b].cells.find(I=>I.id===i))==null?void 0:h.elements)==null?void 0:w.length)||0)+1};setTimeout(()=>{lr(i,d),setTimeout(()=>{o&&be("images"),setTimeout(()=>{Xe(r),re.success("✅ Imagen añadida desde la galería")},50)},50)},50)},[Q,G,m,b,st,lr]),cr=p.useCallback(async(t,r)=>{var c,d;const o=[],i=[];for(const g of t){const u={...g};if(g.cells){u.cells=[];for(const h of g.cells){const w={...h};if(h.elements){w.elements=[];for(const I of h.elements)if(I.type==="image"&&((c=I.content)!=null&&c.startsWith("data:image/"))){const _=`${I.id}_${Date.now()}`,L=I.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(L){const j=L[1],M=L[2],W=`${_}.${j==="jpeg"?"jpg":j}`;i.push({filename:W,data:M,type:j,elementId:I.id}),w.elements.push({...I,content:I.content,_wasBase64:!0,_originalSize:I.content.length,_elementId:I.id})}else w.elements.push(I)}else w.elements.push(I)}u.cells.push(w)}}o.push(u)}if(i.length>0)try{const g=await fetch(`/api/canvas/projects/${r}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((d=document.querySelector('meta[name="csrf-token"]'))==null?void 0:d.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:i})});if(g.ok){const u=await g.json();if(u.uploadedImages){const h=new Map;u.uploadedImages.forEach(w=>{h.set(w.elementId,w.url)});for(const w of o)if(w.cells){for(const I of w.cells)if(I.elements)for(const _ of I.elements)_._wasBase64&&_._elementId&&h.has(_._elementId)&&(_.content=h.get(_._elementId),delete _._elementId)}}}else{const u=await g.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("❌ [IMAGE-UPLOAD] Error subiendo imágenes:",u),t}}catch(g){return console.error("❌ [IMAGE-UPLOAD] Error de red subiendo imágenes:",g),t}return o},[]),Ze=p.useCallback(async(t=m,r=!1)=>{var o;if(!(!(n!=null&&n.id)||!r&&t.length===0))try{const d={design_data:{pages:await cr(t,n.id),currentPage:b,workspaceDimensions:$,workspaceSize:ce,selectedElement:z,selectedCell:G,history:Ae.slice(-5),historyIndex:Math.min(Se,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:n.id,name:(a==null?void 0:a.name)||"Álbum Personalizado",item_id:a==null?void 0:a.id,preset_id:s==null?void 0:s.id}},thumbnails:te},u=JSON.stringify(d).length/(1024*1024),h=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(d)});if(h.ok){const w=await h.json(),I=`editor_progress_project_${n.id}`;return localStorage.removeItem(I),F(_=>{const L=new Map(_);return r?L.clear():L.delete(b),L}),m&&m.length>0&&setTimeout(()=>{oe().catch(_=>{console.warn("⚠️ Error regenerando thumbnail de página actual:",_)})},300),!0}else{const w=await h.json().catch(()=>({message:"Error desconocido"}));return console.error("❌ [AUTO-SAVE] Error guardando en BD:",w),!1}}catch(i){return console.error("❌ [AUTO-SAVE] Error en auto-save con procesamiento de imágenes:",i),!1}},[m,b,$,ce,n==null?void 0:n.id,a==null?void 0:a.name,a==null?void 0:a.id,s==null?void 0:s.id,cr,kt]);p.useEffect(()=>{if(!(n!=null&&n.id))return;const t=setInterval(()=>{m.length>0&&Ze(m,!1)},10*60*1e3);return()=>clearInterval(t)},[Ze,m,n==null?void 0:n.id]),p.useCallback(async()=>{if(!m.length)return{};const t={},r=b;try{for(let o=0;o<m.length;o++){const i=m[o];if(i!=null&&i.id)try{o!==b&&(se(o),await new Promise(d=>setTimeout(d,300)));const c=await Pe({type:"thumbnail"});c&&(t[i.id]=c)}catch(c){console.warn(`⚠️ [THUMBNAILS] Error capturando thumbnail para página ${i.id}:`,c),te[i.id]&&(t[i.id]=te[i.id])}}return r!==b&&se(r),t}catch(o){return console.error("❌ [THUMBNAILS] Error capturando thumbnails:",o),r!==b&&se(r),te}},[m,b,se,Pe,te]);const dr=p.useCallback(async()=>{if(!(n!=null&&n.id)||m.length===0)return re.error("No hay datos para guardar"),!1;try{return await oe(),await or(),await Ze(m,!0)?(re.success("Progreso guardado exitosamente"),!0):(re.error("Error al guardar el progreso"),!1)}catch(t){return console.error("❌ [SAVE] Error al guardar el progreso:",t),re.error("Error al guardar el progreso"),!1}},[Ze,m,n==null?void 0:n.id,$,s,kt]),ur=p.useCallback(async t=>{var r;if(!(n!=null&&n.id))return Ke("❌ [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return Ke("❌ [QUEUE-SAVE] No hay páginas para guardar"),!1;try{const i={design_data:{pages:t,currentPage:b,workspaceDimensions:$,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:te};bt("📤 [QUEUE-SAVE] Enviando petición al servidor...");const c=await fetch(`/api/canvas/projects/${n.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(i)});if(bt("📥 [QUEUE-SAVE] Respuesta del servidor:",c.status,c.statusText),c.ok){const d=await c.json();return bt("✅ [QUEUE-SAVE] Guardado exitoso desde cola:",d),!0}else{const d=await c.text();return Ke("❌ [QUEUE-SAVE] Error en respuesta del servidor:",c.status,d),!1}}catch(o){return o("❌ [QUEUE-SAVE] Error guardando desde cola:",o),!1}},[n==null?void 0:n.id,b,$,te]),Ot=p.useCallback(async()=>{if(!J&&O.length!==0){R(!0);try{const t=O.slice();K([]);for(const r of t)await ur(r.pages)?F(i=>{const c=new Map(i);return c.delete(r.pageIndex),c}):(console.error("❌ [SAVE-QUEUE] Error guardando página:",r.pageIndex),K(i=>[...i,r]))}catch(t){console.error("❌ [SAVE-QUEUE] Error procesando cola:",t)}finally{R(!1)}}},[J,O,ur]);p.useEffect(()=>{O.length>0&&!J&&setTimeout(()=>{Ot()},100)},[O.length,J,Ot]),p.useEffect(()=>{},[O,J]);const mr=p.useCallback((t,r)=>{F(o=>(Array.from(o.keys()),o.has(t)&&K(i=>{const c=i.findIndex(d=>d.pageIndex===t);if(c!==-1){const d=[...i];return d[c]={pageIndex:t,pages:r,timestamp:Date.now()},d}else return[...i,{pageIndex:t,pages:r,timestamp:Date.now()}]}),o))},[]),Pt=p.useCallback(async t=>{t!==b&&(F(r=>{const o=Array.from(r.keys());return bt("🔍 [PAGE-CHANGE] Páginas con cambios:",o.join(", ")||"ninguna"),r.has(b)&&mr(b,m),r}),se(t))},[b,m,mr]),qe=()=>`editor_progress_project_${n==null?void 0:n.id}`,pr=p.useCallback(async()=>{var r,o,i,c;if(!(!(n!=null&&n.id)||m.some(d=>{var g;return(g=d.cells)==null?void 0:g.some(u=>{var h;return((h=u.elements)==null?void 0:h.length)>0})})))try{const d=Oe.loadFromLocalStorage(),g=await fetch(`/api/canvas/projects/${n.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let u=null;if(g.ok){const w=await g.json();w.success&&((r=w.data)!=null&&r.design_data)&&(u=w.data)}let h=null;if(d&&u){const w=new Date(d.savedAt).getTime(),I=new Date(u.saved_at).getTime();h=w>I?d:u}else d?h=d:u&&(h=u);if(h&&(((o=h.pages)==null?void 0:o.length)>0||((c=(i=h.design_data)==null?void 0:i.pages)==null?void 0:c.length)>0)){const w=new Date(h.savedAt||h.saved_at).getTime();Date.now()-w<30*60*1e3&&(re.info("🔄 Cargando progreso guardado automáticamente..."),Xn(h))}}catch(d){console.error("❌ [RECOVERY] Error verificando progreso guardado:",d)}},[n==null?void 0:n.id,Oe,m]),Xn=p.useCallback(async t=>{var r;try{let o=[];if(t.pages?o=t.pages:(r=t.design_data)!=null&&r.pages&&(o=t.design_data.pages),o.length>0){ie(o);const i=[JSON.stringify(o)];De(i),ze(0),setTimeout(()=>{ne({})},100),re.success("✅ Progreso cargado exitosamente"),Kn(!1)}}catch(o){console.error("❌ [RECOVERY] Error cargando progreso:",o),re.error("Error al cargar el progreso guardado")}},[ie,De,ze,ne]);p.useCallback(async()=>{try{const t=Oe.getStorageKey();localStorage.removeItem(t),re.success("Progreso anterior eliminado")}catch(t){console.error("❌ [RECOVERY] Error descartando progreso:",t)}},[Oe]),p.useEffect(()=>{n&&a&&s&&(!(C!=null&&C.pages)||C.pages.length===0)&&gr(s,a)},[n,a,s,C]),p.useEffect(()=>{n!=null&&n.id&&!y&&m.length===0&&!st&&(Xe(!0),setTimeout(()=>{pr()},500))},[n==null?void 0:n.id,y,m.length,pr,st]),p.useEffect(()=>(ue.current&&clearTimeout(ue.current),n!=null&&n.id&&m.length>0&&(ue.current=setTimeout(()=>{or()},500)),()=>{ue.current&&clearTimeout(ue.current)}),[n==null?void 0:n.id,m.length]);const gr=(t,r)=>{try{const o=[],i=r.pages||t.pages||20;if(r.has_cover_image===!0||r.has_cover_image===1){const g=r.cover_image?`/storage/images/item/${r.cover_image}`:null,u=r.cover_image?null:t.background_color||"#ffffff",h={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:g,backgroundColor:u,cells:[{id:"cell-cover-1",elements:[]}]};o.push(h)}const c=r.content_image?`/storage/images/item/${r.content_image}`:null,d=r.content_image?null:t.background_color||"#ffffff";for(let g=1;g<=i;g++){const u={id:`page-content-${g}`,type:"content",pageNumber:g,layout:"layout-1",backgroundImage:c,backgroundColor:d,cells:[{id:`cell-content-${g}-1`,elements:[]}]};o.push(u)}if(r.has_back_cover_image===!0||r.has_back_cover_image===1){const g=r.back_cover_image?`/storage/images/item/${r.back_cover_image}`:null,u=r.back_cover_image?null:t.background_color||"#ffffff",h={id:"page-final",type:"final",layout:"layout-1",backgroundImage:g,backgroundColor:u,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};o.push(h)}ie(o),se(0),t.width&&t.height&&Ge("preset")}catch(o){console.error("❌ Error creating pages:",o),U(o.message)}},hr=p.useCallback(t=>{var d,g;if(!t||t.length===0)return[];const r=t.filter(u=>u.type==="cover"),o=t.filter(u=>u.type==="content"),i=t.filter(u=>u.type==="final");if(r.length===0&&i.length===0)return t;const c=[];return r.length>0&&(c.push(...r),c.push({id:`blank-page-cover-back-${Date.now()}`,type:"blank",isBlankPage:!0,hasLogo:!0,logoUrl:"/assets/resources/logo.png",cells:[],backgroundColor:"#ffffff",layout:((d=ae[0])==null?void 0:d.id)||"layout1"})),o.length>0&&c.push(...o),i.length>0&&(c.length%2===1&&c.push({id:`blank-page-before-back-${Date.now()}`,type:"blank",isBlankPage:!0,cells:[],backgroundColor:"#ffffff",layout:((g=ae[0])==null?void 0:g.id)||"layout1"}),c.push(...i)),c},[ae]),de=p.useMemo(()=>a?{cover:m.filter(t=>t.type==="cover"&&(a.has_cover_image===!0||a.has_cover_image===1)),content:m.filter(t=>t.type==="content"),final:m.filter(t=>t.type==="final"&&(a.has_back_cover_image===!0||a.has_back_cover_image===1))}:{cover:m.filter(t=>t.type==="cover"),content:m.filter(t=>t.type==="content"),final:m.filter(t=>t.type==="final")},[m,a]),ge=p.useCallback(()=>{if(!a)return console.warn("⚠️ [CONTENT-TYPE] itemData no disponible, usando tipo por defecto"),{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"};const t=a.has_cover_image===!0||a.has_cover_image===1,r=a.has_back_cover_image===!0||a.has_back_cover_image===1,o=t&&de.cover.length>0,i=r&&de.final.length>0,c=de.content.length;return o&&i?{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"}:o||i?{type:"booklet",name:"Folleto",description:"Vista de Folleto",icon:"📋",experience:"booklet"}:c>1?{type:"catalog",name:"Catálogo",description:"Vista de Catálogo",icon:"📑",experience:"catalog"}:{type:"card",name:"Diseño",description:"Vista Previa",icon:"🎨",experience:"single"}},[de,a])(),X=p.useCallback(()=>{if(!z||!G||m.length===0)return null;const t=m[b];if(!t)return null;const r=t.cells.find(o=>o.id===G);return r?r.elements.find(o=>o.id===z):null},[z,G,m,b]),fr=(t,r)=>{if(r){const o=m[b].cells.find(c=>c.id===r),i=o==null?void 0:o.elements.find(c=>c.id===t);if(i!=null&&i.locked){const c=document.createElement("div");c.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",c.textContent="Este elemento es parte del diseño base y no se puede editar",document.body.appendChild(c),setTimeout(()=>{document.body.contains(c)&&document.body.removeChild(c)},3e3);return}}if(r&&pe(r),Y(t),t){const o=m[b].cells.find(c=>c.id===(r||G)),i=o==null?void 0:o.elements.find(c=>c.id===t);(i==null?void 0:i.type)==="image"?qt(i):(i==null?void 0:i.type)==="text"?(At(!0),Gn({elementId:t,cellId:r||G}),Q!=="filters"&&Q!=="images"&&be("text")):At(!1)}else At(!1),qt(null)},Te=()=>{if(m.length===0)return ae[0];const t=m[b];if(!t)return ae[0];const r=ae.find(i=>i.id===t.layout)||ae[0],o=r.cellStyles&&Object.values(r.cellStyles).some(i=>i.includes("col-span-")||i.includes("row-span-"));return{...r,isComplex:o,pageId:t.id}},br=p.useCallback(xt(t=>{try{const r=qe(),o={pages:t,currentPage:b,savedAt:Date.now()},i=JSON.stringify(o),c=Math.round(i.length/1024);c<2048?localStorage.setItem(r,i):(console.warn(`⚠️ Datos demasiado grandes para localStorage (${c} KB)`),localStorage.removeItem(r))}catch(r){if(console.error("❌ Error guardando en localStorage:",r),r.name==="QuotaExceededError")try{localStorage.removeItem(qe())}catch(o){console.error("Error limpiando localStorage:",o)}}},300),[b,qe]),et=p.useCallback(t=>{ie(r=>{if(r===t)return r;const o=JSON.stringify(r),i=JSON.stringify(t);return o===i?r:(requestAnimationFrame(()=>{if(F(c=>{const d=new Map(c);return d.set(b,Date.now()),d}),t[b]){const c=t[b].id;ne(d=>{if(d[c]){const g={...d};return delete g[c],g}return d})}}),setTimeout(()=>{De(c=>{const d=[...c.slice(0,Se+1),i];return d.length>50?d.slice(-50):d}),ze(c=>{const d=c+1;return d>50?49:d})},0),t)}),br(t)},[b,Se,br]);p.useEffect(()=>{try{const t=qe(),r={pages:m,currentPage:b,savedAt:Date.now()},o=JSON.stringify(r),i=Math.round(o.length/1024);i<2048?localStorage.setItem(t,o):console.warn(`⚠️ Datos demasiado grandes para localStorage (${i} KB), saltando guardado`)}catch(t){if(console.error("❌ Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const r=qe();localStorage.removeItem(r)}catch(r){console.error("Error limpiando localStorage:",r)}}},[b,m,qe]);const Zn=t=>{const r=ae.find(d=>d.id===t);if(!r)return;const o=[...m],i=o[b],c=Array.from({length:r.cells}).map((d,g)=>i.cells[g]||{id:`cell-${i.id}-${g+1}`,elements:[]});o[b]={...i,layout:t,cells:c},et(o),Y(null),pe(null)},tt=(t,r)=>{const o=[...m];for(let i=0;i<o[b].cells.length;i++)o[b].cells[i].id===t&&o[b].cells[i].elements.push(r);et(o),Y(r.id),pe(t)},xr=p.useCallback(xt(()=>{F(t=>{const r=new Map(t);return r.set(b,Date.now()),r})},100),[b]),le=p.useCallback((t,r,o,i=!1)=>{ie(c=>{const d=[...c],g=d[b].cells.findIndex(u=>u.id===t);if(g===-1)return c;if(i){const u=d[b].cells[g].elements.find(h=>h.id===r);if(!u)return c;d[b].cells[g].elements.push({...u,...o})}else{const u=d[b].cells[g].elements.findIndex(_=>_.id===r);if(u===-1)return c;const h=d[b].cells[g].elements[u];if(!Object.keys(o).some(_=>{const L=h[_],j=o[_];return typeof j=="object"&&typeof L=="object"?JSON.stringify(L)!==JSON.stringify(j):L!==j}))return c;const I={...h,...o};d[b].cells[g].elements[u]=I,(o.filters||o.mask)&&(window.FORCE_THUMBNAIL_REGENERATION&&(window.thumbnailCache={}),oe(!0).then(()=>{window.FORCE_THUMBNAIL_REGENERATION&&window.forceRegenerateThumbnail&&setTimeout(()=>{try{window.forceRegenerateThumbnail()}catch(_){console.error("❌ [FORZADO-EMERGENCIA] Error en regeneración secundaria:",_)}},150)}).catch(_=>{console.error("❌ [AUTO-REGEN] Error regenerando thumbnail:",_)}))}return d}),o.position||o.size?requestAnimationFrame(()=>{F(c=>{if(c.has(b))return c;const d=new Map(c);return d.set(b,Date.now()),d})}):xr()},[b,xr]),eo=p.useCallback(()=>{const t=Te();return console.log("🧪 [TEST] Layout actual:",t),console.log("🧪 [TEST] Es complejo:",t.isComplex),console.log("🧪 [TEST] CellStyles:",t.cellStyles),oe(!0),`✅ Test ejecutado para layout: ${t.id} (complejo: ${t.isComplex})`},[Te,oe]);window.testComplexLayoutThumbnail=eo,p.useCallback(()=>{var r;if(Le){Ke("🚫 [VPS-PROTECTION] forceRegenerateThumbnail bloqueado en servidor");return}window.thumbnailCache&&(window.thumbnailCache={}),window.THUMBNAIL_PROTECTED=!0,window._protectedThumbnailIds||(window._protectedThumbnailIds=[]);const t=(r=m[b])==null?void 0:r.id;t&&!window._protectedThumbnailIds.includes(t)&&window._protectedThumbnailIds.push(t),window.BLOCK_AUTO_REGENERATION=!0,oe(!0),setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1},1e4)},[oe]),p.useCallback(()=>{z&&G&&le(G,z,{filters:{brightness:100,contrast:100,saturation:0,opacity:100}})},[z,G,le]),p.useCallback(()=>{window.THUMBNAIL_PROTECTED=!0,window.PERMANENT_THUMBNAIL_LOCK=!0,window.BLOCK_AUTO_REGENERATION=!1,window._protectedThumbnailIds=Object.keys(te);const t=window.forceRegenerateThumbnail;window.forceRegenerateThumbnail=(...r)=>window._userInitiated?(window._userInitiated=!1,t(...r)):!1,window._allowNextRegeneration=()=>{window._userInitiated=!0},window.safeRegenerateThumbnail=()=>{window._allowNextRegeneration(),window.forceRegenerateThumbnail()},window._thumbnailBackup={...te},alert(`🔒 Miniaturas protegidas exitosamente!

Si necesitas regenerar una miniatura específica, usa window.safeRegenerateThumbnail() en la consola.`)},[te]),p.useCallback(()=>{window.FORCE_FILTER_APPLICATION=!0,window.ENABLE_ADVANCED_FILTER_RENDERING=!0,window.thumbnailCache&&window.thumbnailCache.clear(),zt&&zt();const t=m[b];t&&t.cells&&t.cells.forEach(r=>{r.elements&&r.elements.forEach(o=>{o.filters&&(o._hasRealFilters=!0,o.pageId=t.id)})}),oe(!0)},[m,b,oe]);const lt=(t,r)=>{const o=[...m],i=o[b].cells.findIndex(c=>c.id===t);i!==-1&&(o[b].cells[i].elements=o[b].cells[i].elements.filter(c=>c.id!==r),et(o),z===r&&Y(null))},to=(t,r,o)=>{const i=[...m],c=i[b].cells.findIndex(d=>d.id===t);if(c!==-1){const d=i[b].cells[c].elements,g=d.findIndex(u=>u.id===r);if(g!==-1){const u=o==="up"?g+1:g-1;if(u>=0&&u<d.length){const h=d[g];d[g]=d[u],d[u]=h,et(i)}}}},ro=()=>{Se>0&&(ze(Se-1),ie(JSON.parse(Ae[Se-1])),Y(null),pe(null))},no=()=>{Se<Ae.length-1&&(ze(Se+1),ie(JSON.parse(Ae[Se+1])),Y(null),pe(null))},Rt=(t="body")=>{const r=`text-${Date.now()}`,o={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},i={heading:"Título Principal",subheading:"Subtítulo",body:"Haz clic para editar"},c={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},d={id:r,type:"text",content:i[t],position:{x:.05,y:.05},size:c[t],style:o[t]};G&&tt(G,d)},vr=p.useMemo(()=>{var c;const t=m[b];if(!t)return null;const r=((c=t.cells)==null?void 0:c.flatMap(d=>d.elements||[]))||[],o=r.map(d=>({id:d.id,type:d.type,position:d.position,size:d.size}));return{pageId:t.id,elementsCount:r.length,contentHash:JSON.stringify(o).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[m,b]);p.useEffect(()=>{var g;if(Le)return;const t=m[b];if(!t)return;const r=t.id;if(((g=t==null?void 0:t.cells)==null?void 0:g.some(u=>{var h;return(h=u.elements)==null?void 0:h.some(w=>w.filters&&(w.filters.brightness!==100||w.filters.contrast!==100||w.filters.saturation!==100||w.filters.tint!==0||w.filters.hue!==0))}))&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(r)||window._protectedThumbnailIds.push(r)),m.length===0||y||!vr)return;let i=!1;const c=async()=>{var u;if(!(window.PREVENT_THUMBNAIL_RESET||window.THUMBNAIL_PROTECTED))try{const h=m[b];if(!h||!h.id)return;const w=h.id;if(!window.PREVENT_THUMBNAIL_RESET&&!window.THUMBNAIL_PROTECTED&&ne(j=>{const M={...j};return delete M[w],M}),await new Promise(j=>setTimeout(j,100)),i)return;const I=(u=h==null?void 0:h.cells)==null?void 0:u.some(j=>{var M;return(M=j.elements)==null?void 0:M.some(E=>E.filters&&(E.filters.brightness!==100||E.filters.contrast!==100||E.filters.saturation!==100||E.filters.tint!==0||E.filters.hue!==0))}),L=await Pe(I?{type:"thumbnail",preserveFilters:!0}:{type:"thumbnail"});L&&!i?(ne(j=>({...j,[w]:L})),I&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(w)||window._protectedThumbnailIds.push(w))):console.warn("⚠️ [DEBUG] No se pudo generar miniatura para:",w)}catch(h){i||console.error("❌ [DEBUG] Error regenerando miniatura:",h)}},d=setTimeout(()=>{c()},500);return()=>{i=!0,clearTimeout(d)}},[b,vr,y,Pe]),p.useEffect(()=>{if(window.BLOCK_AUTO_REGENERATION||m.length===0||y)return;const t=async()=>{if(window.BLOCK_AUTO_REGENERATION)return;const o=m.filter(i=>!te[i.id]);if(o.length!==0)for(const i of o)try{const c=document.createElement("canvas");c.width=200,c.height=150;const d=c.getContext("2d");if(d.fillStyle=i.backgroundColor||"#ffffff",d.fillRect(0,0,200,150),i.backgroundImage)try{const u=new Image;u.crossOrigin="anonymous",await new Promise((h,w)=>{u.onload=h,u.onerror=w,u.src=i.backgroundImage}),d.drawImage(u,0,0,200,150)}catch(u){console.warn("No se pudo cargar imagen de fondo para miniatura:",u)}i.cells&&i.cells.forEach(u=>{u.elements&&u.elements.forEach(h=>{var w;h.type==="text"&&h.content&&(d.fillStyle=((w=h.style)==null?void 0:w.color)||"#000000",d.font="12px Arial",d.fillText(h.content.substring(0,20)+(h.content.length>20?"...":""),10,30))})});const g=c.toDataURL("image/jpeg",.7);ne(u=>({...u,[i.id]:g})),await new Promise(u=>setTimeout(u,300))}catch(c){console.error("❌ Error generando miniatura de fondo para:",i.id,c)}},r=setTimeout(()=>{t()},2e3);return()=>clearTimeout(r)},[m,te,y]),p.useEffect(()=>{const t=r=>{const o=H.current,i=ee.current;if(o.length>0||i.size>0)return r.preventDefault(),r.returnValue="Hay cambios sin guardar. ¿Estás seguro de que quieres salir?",r.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),p.useEffect(()=>()=>{},[]);const oo=async()=>{var t;try{if(!a||!s||!(n!=null&&n.id))return!1;await Ze(m,!0)||console.warn("⚠️ No se pudo guardar el progreso, pero continuando...");const o={design_data:{id:n.id,title:(a==null?void 0:a.name)||"Álbum Personalizado",pages:m,workspace_dimensions:$,created_at:new Date().toISOString()},item_data:{id:a==null?void 0:a.id,name:(a==null?void 0:a.name)||(a==null?void 0:a.title),price:a==null?void 0:a.price,user_id:a==null?void 0:a.user_id,width:a==null?void 0:a.width,height:a==null?void 0:a.height},preset_data:{id:s==null?void 0:s.id,width:s==null?void 0:s.width,height:s==null?void 0:s.height,cover_image:s==null?void 0:s.cover_image,content_layer_image:s==null?void 0:s.content_layer_image,final_layer_image:s==null?void 0:s.final_layer_image},dimensions:{width_mm:(s==null?void 0:s.width)||(a==null?void 0:a.width)||210,height_mm:(s==null?void 0:s.height)||(a==null?void 0:a.height)||297,workspace_width:($==null?void 0:$.width)||800,workspace_height:($==null?void 0:$.height)||600}};try{const I=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:n.id,status:"ready_for_pdf",pdf_data:o,completed_at:new Date().toISOString()})});if(I.ok){const _=await I.json()}else console.warn("⚠️ Error marcando proyecto como completado")}catch(I){console.warn("⚠️ Error en marcado de completado:",I)}const i=Date.now(),c=n.id;window.currentProjectId=c,window.albumProjectId=c;let d=s.cover_image;te&&te["page-cover"]&&(d=te["page-cover"]);let g=d;d&&d.startsWith("data:image/")&&d.length>1e5&&(g=s.cover_image||"/assets/img/default-album.jpg");const u={...a,project_id:c,canvas_project_id:n.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:s.width,height_mm:s.height,pages_count:m.length,workspace_dimensions:$,requires_pdf_generation:!0}},h=structuredClone(je),w=h.findIndex(I=>I.id==u.id);return w==-1?h.push({...u,quantity:1}):h[w].quantity++,Me(h),re.success("Álbum agregado al carrito",{description:`${u.name} se ha añadido al carrito. El PDF se generará en el backend.`,icon:e.jsx(Oo,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:h,action:"add",product:u}})),!0}catch(r){return console.error("❌ === ERROR EN addAlbumToCart ==="),console.error("Error completo:",r),console.error("Stack trace:",r.stack),console.error("Mensaje del error:",r.message),re.error("Error al agregar al carrito",{description:`Error específico: ${r.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!m||m.length===0)throw new Error("No hay páginas para finalizar");const o={design_data:{pages:(_=>_.map(L=>({id:L.id,type:L.type,pageNumber:L.pageNumber,layout:L.layout,cells:L.cells.map(j=>({id:j.id,elements:j.elements.map(M=>{const E={id:M.id,type:M.type,position:M.position,zIndex:M.zIndex||1};if(M.type==="image"){if(M.content.startsWith("data:image/")){const W=btoa(M.content.substring(0,100)).substring(0,20);E.content=`[BASE64_IMAGE_${W}]`,E.contentType=M.content.split(";")[0].split(":")[1],E.originalSize=M.content.length}else E.content=M.content;if(M.filters){const W=Object.entries(M.filters).filter(([P,q])=>q!==0&&q!==!1&&q!==null).reduce((P,[q,ve])=>(P[q]=ve,P),{});Object.keys(W).length>0&&(E.filters=W)}M.mask&&M.mask!=="none"&&(E.mask=M.mask),M.size&&(E.size=M.size),M.locked&&(E.locked=M.locked)}else if(M.type==="text"&&(E.content=M.content,M.style)){const W=Object.entries(M.style).filter(([P,q])=>!(P==="fontSize"&&q==="16px"||P==="color"&&q==="#000000"||P==="fontFamily"&&q==="Arial")).reduce((P,[q,ve])=>(P[q]=ve,P),{});Object.keys(W).length>0&&(E.style=W)}return E})}))})))(m),projectInfo:{id:n==null?void 0:n.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:s==null?void 0:s.id},presetInfo:{id:s==null?void 0:s.id,name:s==null?void 0:s.name,cover_image:s==null?void 0:s.cover_image,content_image:s==null?void 0:s.content_image,back_cover_image:s==null?void 0:s.back_cover_image},workspace:{width:$.width,height:$.height,scale:$.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(te).map(([_,L])=>[_,L]))},i=JSON.stringify(o),c=Math.round(i.length/1024),d=Math.round(c/1024*100)/100;let g=0,u=0;m.forEach(_=>{var L;(L=_.cells)==null||L.forEach(j=>{var M;(M=j.elements)==null||M.forEach(E=>{E.type==="image"&&E.content&&E.content.startsWith("data:image/")&&(g++,u+=E.content.length)})})});const h=Math.round(u/(1024*1024)*100)/100;if(c>1024&&!confirm(`El diseño contiene ${g} imágenes (${h} MB en imágenes). Payload completo: ${d} MB. Esto podría causar problemas al guardarlo. ¿Desea continuar de todos modos?`))return!1;const w=await fetch(`/api/canvas/projects/${n.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:i});if(!w.ok){let _="Error al finalizar el diseño";try{_=(await w.json()).message||_}catch{w.status===413?_="El diseño es demasiado grande para ser guardado. Intente simplificar las imágenes.":w.status>=500&&(_="Error del servidor. Intente nuevamente más tarde.")}throw new Error(_)}const I=await w.json();return!0}catch(t){console.error("Error al finalizar diseño:",t);let r=t.message;return t.message.includes("Failed to fetch")?r="Error de conexión. Verifique su conexión a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(r="Error de red. Intente nuevamente más tarde."),alert("Error al finalizar el diseño: "+r),!1}};const ao=p.useCallback(async()=>{try{const{jsPDF:t}=await io(async()=>{const{jsPDF:W}=await import("./jspdf.es.min-D3plwuQr.js").then(P=>P.j);return{jsPDF:W}},__vite__mapDeps([0,1,2,3,4]));let r=(s==null?void 0:s.width)||21,o=(s==null?void 0:s.height)||29.7;const i=.3,c=r+i*2,d=o+i*2,g=c*28.35,u=d*28.35,h=new t({orientation:g>u?"landscape":"portrait",unit:"pt",format:[g,u],compress:!1}),w=m.length;let I=0;const _=document.createElement("div");_.id="pdf-progress",_.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",_.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${w} páginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(_);const L=W=>{const P=W/w*100;document.getElementById("pdf-progress-bar").style.width=`${P}%`,document.getElementById("current-page").textContent=W},j=b;for(let W=0;W<m.length;W++){const P=m[W];se(W),await new Promise(q=>setTimeout(q,500));try{const q=await Pe({type:"pdf"});if(q){const ve=q.width/q.height,Fe=g/u;let Re,we,Z=0,ye=0;ve>Fe?(Re=g,we=g/ve,ye=(u-we)/2):(we=u,Re=u*ve,Z=(g-Re)/2);const fe=q.toDataURL("image/png",1);W>0&&h.addPage([g,u]),h.addImage(fe,"PNG",Z,ye,Re,we)}else console.warn(`⚠️ No se pudo capturar la página ${W+1}`),W>0&&h.addPage([g,u]),h.setFontSize(12),h.text(`Error al renderizar página ${W+1}`,g/2,u/2,{align:"center"})}catch(q){console.error(`❌ Error procesando página ${W+1}:`,q),W>0&&h.addPage([g,u]),h.setFontSize(12),h.text(`Error al procesar página ${W+1}`,g/2,u/2,{align:"center"})}I++,L(I),await new Promise(q=>setTimeout(q,200))}se(j);const M=`${(a==null?void 0:a.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;h.save(M),document.body.removeChild(_);const E=document.createElement("div");return E.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",E.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${M}</span>
                </div>
            `,document.body.appendChild(E),setTimeout(()=>{document.body.contains(E)&&document.body.removeChild(E)},5e3),M}catch(t){console.error("❌ Error generando PDF:",t);const r=document.getElementById("pdf-progress");r&&document.body.removeChild(r);const o=document.createElement("div");throw o.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",o.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(o),setTimeout(()=>{document.body.contains(o)&&document.body.removeChild(o)},7e3),t}},[m,b,se,Pe,s,a]);return window.generateAlbumPDF=ao,window.generateHighQualityThumbnail=Vn,window.captureCurrentWorkspace=Pe,window.regenerateCurrentThumbnailNow=()=>{var r;const t=(r=m[b])==null?void 0:r.id;if(t){const o=m[b];let i=!1;o&&o.cells&&o.cells.forEach(c=>{c.elements&&c.elements.forEach(d=>{d.filters&&(d.filters.brightness!==100||d.filters.contrast!==100||d.filters.saturation!==100||d.filters.tint!==0||d.filters.hue!==0||d.filters.blur>0||d.filters.opacity!==100||d.filters.scale!==1||d.filters.rotate!==0||d.filters.flipHorizontal||d.filters.flipVertical)&&(i=!0,d._hasRealFilters=!0)})}),i&&(window.PRESERVE_FILTERS_FOR_PAGE=t,window.FORCE_FILTER_APPLICATION=!0),ne(c=>{const d={...c};return delete d[t],d})}return setTimeout(()=>{oe(!0),setTimeout(()=>{window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},100),"✅ Miniatura regenerada con éxito!"},window.generateThumbnailWithFilters=()=>{window.FORCE_FILTER_APPLICATION=!0;const t=Date.now();return window._filterCacheBreaker=t,window.regenerateCurrentThumbnailNow(),setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1},1e3),"✅ Miniatura con filtros regenerada exitosamente"},window.forceRegenerateWithGuaranteedFilters=async()=>{var r,o;const t=m[b];if(!t||!$)return console.error("❌ [RADICAL] Datos no disponibles"),!1;try{window._filterVerificationDone&&window._filterVerificationDone.clear(),window._currentPageData=t,window._workspaceDimensions=$,window._updateThumbnailInUI=(c,d)=>{ne(g=>({...g,[c]:d}))};const i=await gt(t,$);return i?(((r=t.elements)==null?void 0:r.some(d=>d.filters?Object.keys(d.filters).some(g=>g==="flipHorizontal"||g==="flipVertical"?d.filters[g]:g==="brightness"||g==="contrast"||g==="saturation"||g==="opacity"||g==="scale"?d.filters[g]!==1:g==="tint"||g==="hue"||g==="blur"||g==="rotate"?d.filters[g]!==0:!1):!1))&&((o=window.protectThumbnail)==null||o.call(window,t.id)),ne(d=>({...d,[t.id]:i})),!0):!1}catch(i){return console.error("❌ [RADICAL] Error:",i),!1}},window.safeRegenerateThumbnail=()=>(window._filterVerificationDone&&window._filterVerificationDone.clear(),oe(!0),"✅ Regeneración segura completada"),e.jsxs(lo,{backend:co,className:"!h-screen !w-screen overflow-hidden",children:[y?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu álbum personalizado..."})]})}):k?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:k}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):m.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando páginas del álbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx("style",{children:`
                        /* Solo aplicar overflow visible en modo edición (no en preview ni captura) */
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] {
                            overflow: visible !important;
                        }
                        
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] > div {
                            overflow: visible !important;
                        }
                        
                        /* Mantener overflow hidden solo para el contenedor principal para evitar scroll */
                        .editor-workspace:not(.preview-mode) #page-${(Er=m[b])==null?void 0:Er.id} {
                            overflow: visible !important;
                        }
                        
                        /* En preview mode y captura, mantener overflow hidden para el resultado final */
                        .preview-mode [data-element-type="image"],
                        .capture-mode [data-element-type="image"] {
                            overflow: hidden !important;
                        }
                    `}),e.jsx(No,{isOpen:qn,onRequestClose:()=>{sr(!1),Jn({isLoading:!1,loadedImages:0,totalImages:0,message:""}),xe({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:(()=>{if(!a){console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible, enviando todas las páginas");const o=de.cover.concat(de.content,de.final).map(i=>({...i,layout:ae.find(c=>c.id===i.layout)||ae[0]}));return hr(o)}let t=[];(a.has_cover_image===!0||a.has_cover_image===1)&&(t=t.concat(de.cover)),t=t.concat(de.content),(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&(t=t.concat(de.final));const r=t.map(o=>({...o,layout:ae.find(i=>i.id===o.layout)||ae[0]}));return hr(r)})(),pageThumbnails:(()=>{if(!a)return console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible para filtrar thumbnails"),te;const t={};let r=[];return(a.has_cover_image===!0||a.has_cover_image===1)&&(r=r.concat(de.cover.map(o=>o.id))),r=r.concat(de.content.map(o=>o.id)),(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&(r=r.concat(de.final.map(o=>o.id))),r.forEach(o=>{te[o]&&(t[o]=te[o])}),t})(),workspaceDimensions:$,getCurrentLayout:t=>t?ae.find(r=>r.id===t.layout)||ae[0]:ae[0],presetData:s,addAlbumToCart:oo,projectData:n,itemData:a,contentType:ge,categorizedPages:de,albumLoadingState:Dn}),Be.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-Be.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:Be.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:Be.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${Be.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[Be.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(Ao,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:ro,disabled:Se<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(uo,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:no,disabled:Se>=Ae.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(mo,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(n==null?void 0:n.name)||"Álbum Sin Título",onChange:t=>l({...n,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del diseño"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(O.length>0||J)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:J?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",O.length]})]})}),e.jsx(ba,{saveStatus:Oe.saveStatus,lastSaved:Oe.lastSaved,lastAutoSaved:Oe.lastAutoSaved,hasUnsavedChanges:N.hasUnsavedChanges||!!(A instanceof Map&&A.has(b)),isOnline:Oe.isOnline,saveError:Oe.saveError,onManualSave:dr,saveQueueSize:O.length,isProcessingQueue:J,pageChangesCount:A instanceof Map?A.size:0}),O.length>0&&e.jsxs("button",{onClick:()=>{Ot()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(Tn,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(pt,{id:"preview-button",variant:"secondary",size:"sm",onClick:async t=>{t.preventDefault(),t.stopPropagation();try{xe({isOpen:!0,phase:"saving",progress:0,message:"💾 Guardando cambios",subMessage:"Asegurando que todo esté actualizado..."});try{await dr(),xe(u=>({...u,progress:15,message:"✅ Cambios guardados",subMessage:"Preparando vista previa..."})),await new Promise(u=>setTimeout(u,500))}catch(u){console.error("❌ [AUTO-SAVE] Error al guardar:",u),xe(h=>({...h,progress:10,message:"⚠️ Guardado parcial",subMessage:"Continuando con vista previa..."})),await new Promise(h=>setTimeout(h,300))}xe(u=>({...u,phase:"preparing",progress:15,message:`${ge.icon} Creando tu ${ge.name.toLowerCase()}`,subMessage:ge.type==="album"?"Preparando la experiencia completa de tu álbum...":ge.type==="catalog"?"Organizando tu catálogo de contenido...":ge.type==="booklet"?"Preparando tu folleto personalizado...":"Optimizando tu diseño único..."}));const r=ge.type==="album"?["🔧 Encuadernando páginas","📖 Ajustando tapas","✨ Puliendo detalles"]:ge.type==="catalog"?["📑 Organizando contenido","🎨 Optimizando diseño","⚡ Finalizando catálogo"]:ge.type==="booklet"?["📋 Preparando folleto","🖼️ Ajustando formato","✨ Aplicando estilo"]:["🎨 Procesando diseño","⚡ Optimizando calidad","✨ Finalizando vista"];for(let u=15;u<=30;u+=3){await new Promise(w=>setTimeout(w,ge.type==="card"?50:100));const h=Math.floor((u-15)/15*r.length);xe(w=>({...w,progress:u,message:r[Math.min(h,r.length-1)],subMessage:`Progreso: ${u}% - Optimizando para mejor experiencia...`}))}xe(u=>({...u,phase:"processing",message:`📷 Procesando ${ge.name.toLowerCase()}`,subMessage:"Generando vistas de alta calidad..."}));const o=await Hn((u,h)=>{const w=30+u/h*50;xe(I=>({...I,progress:Math.round(w),subMessage:`Procesando imagen ${u} de ${h}...`}))}),c={album:{message:"📖 Encuadernando álbum",sub:"Creando experiencia premium de lectura..."},catalog:{message:"📑 Organizando catálogo",sub:"Preparando navegación fluida..."},booklet:{message:"📋 Finalizando folleto",sub:"Ajustando formato profesional..."},card:{message:"🎨 Puliendo diseño",sub:"Aplicando toques finales..."}}[ge.type];xe(u=>({...u,phase:"finalizing",message:c.message,subMessage:c.sub}));for(let u=80;u<=100;u+=4)await new Promise(h=>setTimeout(h,ge.type==="card"?40:80)),xe(h=>({...h,progress:u}));const g={album:{message:"📖 ¡Tu álbum está listo!",sub:"Experiencia completa de lectura preparada"},catalog:{message:"📑 ¡Tu catálogo está listo!",sub:"Navegación profesional activada"},booklet:{message:"📋 ¡Tu folleto está listo!",sub:"Formato profesional completado"},card:{message:"🎨 ¡Tu diseño está listo!",sub:"Vista previa perfecta creada"}}[ge.type];xe(u=>({...u,phase:"ready",progress:100,message:g.message,subMessage:g.sub})),await new Promise(u=>setTimeout(u,1e3)),xe(u=>({...u,isOpen:!1})),ne(u=>({...u,...o})),setTimeout(()=>{sr(!0)},300)}catch(r){console.error(`❌ [${ge.type.toUpperCase()}-EXPERIENCE] Error en experiencia:`,r),xe(o=>({...o,message:"⚠️ Ups, algo salió mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{xe(o=>({...o,isOpen:!1}))},2e3)}},disabled:Be.isOpen,icon:e.jsx(vt,{className:"h-4 w-4"}),children:Be.isOpen?`Creando ${ge.name.toLowerCase()}...`:ge.description}),e.jsxs("button",{onClick:Fn,className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200",title:"Inicia la guía paso a paso",children:[e.jsx(Lo,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"})]})]})]})}),e.jsxs("div",{className:`flex h-full ${z?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>be("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(vt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Páginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>be("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Ut,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Diseños"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>be("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(yt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>be("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(jn,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[Q==="templates"&&"Templates",Q==="images"&&"Images",Q==="text"&&"Text",Q==="shapes"&&"Shapes",Q==="stickers"&&"Stickers",Q==="pages"&&"Pages",Q==="panel"&&"Layers Panel",Q==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Q==="templates"&&"Choose a template to get started",Q==="images"&&"Search for images",Q==="text"&&"Add and edit text",Q==="shapes"&&"Add shapes and graphics",Q==="stickers"&&"Add fun stickers",Q==="pages"&&"Manage your pages",Q==="panel"&&"Organize layers and z-index",Q==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx($o,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[Q==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ut,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Wo,{currentLayoutId:(Cr=m[b])==null?void 0:Cr.layout,onLayoutChange:Zn})]}),Q==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(We,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Imágenes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[_e.length," imagen",_e.length!==1?"s":""]})]}),e.jsx(Ea,{images:_e,onImageSelect:Yn,isLoading:jt})]}),Q==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>Rt("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"Título Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(wt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Rt("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subtítulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(wt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Rt("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(wt,{className:"h-4 w-4"})})]})})]}),Q==="text"&&z&&((Nr=X())==null?void 0:Nr.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(zo,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=X();le(G,z,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((Sr=(jr=X())==null?void 0:jr.style)==null?void 0:Sr.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=X();le(G,z,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((kr=(Tr=X())==null?void 0:Tr.style)==null?void 0:kr.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=X();le(G,z,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((_r=(Ar=X())==null?void 0:Ar.style)==null?void 0:_r.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipografía:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Or=(Ir=X())==null?void 0:Ir.style)==null?void 0:Or.fontFamily)||"Arial",onChange:t=>{const r=X();le(G,z,{style:{...r.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tamaño:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Rr=(Pr=X())==null?void 0:Pr.style)==null?void 0:Rr.fontSize)||"16px",onChange:t=>{const r=X();le(G,z,{style:{...r.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Mr=(Lr=X())==null?void 0:Lr.style)==null?void 0:Mr.color)||"#000000",onChange:t=>{const r=X();le(G,z,{style:{...r.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((Br=($r=X())==null?void 0:$r.style)==null?void 0:Br.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Ur=(zr=X())==null?void 0:zr.style)==null?void 0:Ur.backgroundColor)||"#ffffff",onChange:t=>{const r=X();le(G,z,{style:{...r.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=X();le(G,z,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"🚫"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var r,o;return e.jsxs("button",{onClick:()=>{const i=X();le(G,z,{style:{...i.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((o=(r=X())==null?void 0:r.style)==null?void 0:o.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"⬅",t==="center"&&"⬌",t==="right"&&"➡",t==="justify"&&"⬍"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Hr=(Fr=X())==null?void 0:Fr.style)==null?void 0:Hr.lineHeight)||"1.5",onChange:t=>{const r=X();le(G,z,{style:{...r.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Vr=(Wr=X())==null?void 0:Wr.style)==null?void 0:Vr.letterSpacing)||"normal",onChange:t=>{const r=X();le(G,z,{style:{...r.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=X();le(G,z,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((qr=(Gr=X())==null?void 0:Gr.style)==null?void 0:qr.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAYÚS"]}),e.jsxs("button",{onClick:()=>{const t=X();le(G,z,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Dr=(Kr=X())==null?void 0:Kr.style)==null?void 0:Dr.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"minús"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((Qr=(Jr=X())==null?void 0:Jr.style)==null?void 0:Qr.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((Xr=(Yr=X())==null?void 0:Yr.style)==null?void 0:Xr.opacity)||"1",onChange:t=>{const r=X();le(G,z,{style:{...r.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((en=(Zr=X())==null?void 0:Zr.style)==null?void 0:en.opacity)||1)*100}%, #e5e7eb ${(((rn=(tn=X())==null?void 0:tn.style)==null?void 0:rn.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),Q==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[m.length," total"]})]})}),Ye&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Ye.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Ye.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Ye.message||`Página: ${Ye.pageId||"actual"}`})]}),m.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando páginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[de.cover.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),de.cover.map((t,r)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${b===m.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Pt(m.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Ht,{pageId:t.id,thumbnail:Je[t.id],altText:"Cover",type:"cover"}),A instanceof Map&&A.has&&A.has(m.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:de.content.map((t,r)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${b===m.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>Pt(m.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Ht,{pageId:t.id,thumbnail:Je[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),A instanceof Map&&A.has&&A.has(m.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),de.final.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),de.final.map((t,r)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${b===m.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Pt(m.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(Ht,{pageId:t.id,thumbnail:Je[t.id],altText:"Back Cover",type:"final"}),A instanceof Map&&A.has&&A.has(m.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),Q==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Ho,{pages:m,currentPage:b,selectedCell:G,selectedElement:z,onSelectCell:pe,onSelectElement:Y,onUpdateElement:(t,r,o)=>{le(t,r,o)},onDeleteElement:(t,r)=>{lt(t,r)},onMoveElement:(t,r,o)=>{to(t,r,o)}})}),Q==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(_o,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=X();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(We,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Vo,{selectedMask:t.mask||"none",onSelect:r=>{le(G,z,{mask:r})},availableMasks:Sn.map(r=>r.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(po,{filters:t.filters||{},onFilterChange:r=>{le(G,z,{filters:r}),setTimeout(()=>{oe(!0)},50),setTimeout(()=>{oe(!0)},200),setTimeout(()=>{oe(!0)},500)},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(We,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:X()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>be("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Ut,{className:"h-4 w-4"}),"Diseño de página"]}),e.jsxs("button",{onClick:()=>be("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(yt,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(pt,{variant:"ghost",tooltip:"Añadir Imagen",onClick:()=>_t.current&&_t.current.click(),children:e.jsx(We,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:_t,onChange:Qn,className:"hidden",accept:"image/*"})]}),z&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(pt,{variant:"ghost",size:"sm",onClick:()=>{if(z&&G){const t=X();if(t){const r={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};tt(G,r)}}},className:"h-8 px-2",icon:e.jsx(Io,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(pt,{variant:"ghost",size:"sm",onClick:()=>{z&&G&&lt(G,z)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(Nn,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:`editor-workspace flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100 ${Gt?"preview-mode":""}`,children:Gt?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:$.width,height:$.height},children:e.jsx("div",{id:`page-${m[b].id}`,className:`grid ${Te().template} gap-6`,style:{width:"100%",height:"100%"},children:m[b].cells.map((t,r)=>{var c;const o=Te(),i=ya(o,r,$);return e.jsx(mn,{id:t.id,elements:t.elements.filter(d=>!d.locked),workspaceSize:i,cellStyle:(c=Te().cellStyles)==null?void 0:c[m[b].cells.indexOf(t)],selectedElement:G===t.id?z:null,onSelectElement:fr,onAddElement:(d,g)=>tt(g,d),onUpdateElement:(d,g,u)=>le(t.id,d,g,u),onDeleteElement:d=>lt(t.id,d),availableMasks:Te().maskCategories.flatMap(d=>d.masks),projectData:n},t.id)})})})}):e.jsxs("div",{id:`page-${m[b].id}`,className:" shadow-xl overflow-hidden",style:{width:$.width,height:$.height,position:"relative",backgroundColor:((nn=m[b])==null?void 0:nn.backgroundColor)||"#ffffff",backgroundImage:(on=m[b])!=null&&on.backgroundImage?`url(${m[b].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=m[b];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${Te().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((an=Te().style)==null?void 0:an.gap)||"16px",padding:((sn=Te().style)==null?void 0:sn.padding)||"16px"},children:m[b].cells.map(t=>{var r;return e.jsx(mn,{id:t.id,elements:t.elements.filter(o=>!o.locked),workspaceSize:$,cellStyle:(r=Te().cellStyles)==null?void 0:r[m[b].cells.indexOf(t)],selectedElement:G===t.id?z:null,onSelectElement:fr,onAddElement:(o,i)=>tt(i,o),onUpdateElement:(o,i,c)=>le(t.id,o,i,c),onDeleteElement:o=>lt(t.id,o),availableMasks:Te().maskCategories.flatMap(o=>o.masks),projectData:n},t.id)})})]})})]})]})]}),e.jsx(Co,{})]})}export{ks as default};
