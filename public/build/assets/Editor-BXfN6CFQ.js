const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as Kn}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as p,R as Pt}from"./index-BH53Isel.js";import{T as un,l as ge,i as gn,D as Yn,H as Jn,U as Xn,R as Zn,B as st,F as ea,E as Yo}from"./EditableCell-DczCXCx2.js";import{h as Jo}from"./thumbnailGenerator-B4goYG9Y.js";import{B as dt}from"./dom-to-image-more.min-D1PIV9fo.js";import{L as gt}from"./layers-6oegOx-p.js";import{C as ta}from"./chevron-down-DS-mdh9v.js";import{C as oa}from"./chevron-right-Ckt5D2ka.js";import{E as na}from"./eye-CKCH9ORv.js";import{c as Ce}from"./createLucideIcon-Cy5Ya80P.js";import{T as mn}from"./trash-2-DK1wnsDn.js";import{S as aa}from"./star-wPQTHY_n.js";import{I as ze}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as oe,T as ra}from"./index-BZYhE2TF.js";import{m as Xo}from"./main-6DCdASTx.js";import{B as sa}from"./V1Edit-DCOfnmiw.js";import{G as Zo}from"./Global-D6eBBAMK.js";import{S as pn}from"./save-BvSyoVHO.js";import{C as ia}from"./clock-BTrEpQej.js";import{T as la}from"./triangle-alert-vFMqKi4t.js";import{C as ca}from"./check-DQ7QoS0v.js";import{L as da}from"./loader-circle-CrvBvIt1.js";import{C as ua}from"./chevron-left-B2s3ZsB7.js";import{F as en}from"./filter-Ci9tsc_e.js";import{P as ut}from"./plus-Bot15Khs.js";import{C as ga}from"./copy-6OEekgvq.js";import{C as ma}from"./circle-check-big-D6DM3vPb.js";import{u as pa}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ha=Ce("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=Ce("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ba=Ce("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xa=Ce("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const va=Ce("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ya=Ce("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=Ce("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wa=Ce("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=Ce("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tn=Ce("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Na=Ce("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Ca=({pages:o,currentPage:i,selectedCell:r,selectedElement:g,onSelectCell:s,onSelectElement:m,onUpdateElement:E,onDeleteElement:j,onMoveElement:C})=>{var F;if(!o||!o[i])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(gt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const v=o[i],I=((F=v==null?void 0:v.cells)==null?void 0:F.filter(_=>_.elements&&_.elements.length>0))||[],[M,y]=p.useState(()=>{const _={};return I.forEach(U=>{_[U.id]=!0}),_}),w=_=>{y(U=>({...U,[_]:!U[_]}))},N=_=>{switch(_){case"image":return e.jsx(ze,{className:"h-4 w-4"});case"text":return e.jsx(un,{className:"h-4 w-4"});case"shape":return e.jsx(Ea,{className:"h-4 w-4"});case"sticker":return e.jsx(aa,{className:"h-4 w-4"});default:return e.jsx(xa,{className:"h-4 w-4"})}},k=(_,U)=>{switch(_.type){case"text":return _.content?_.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${U+1}`;case"shape":return _.shape||"Shape";case"sticker":return`Sticker ${U+1}`;default:return`Element ${U+1}`}},S=(_,U,K)=>{E(_,U,{visible:K})},R=(_,U)=>{s(_),m(U)};return e.jsx("div",{className:"space-y-2",children:I.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(gt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):I.map(_=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${r===_.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{w(_.id),s(_.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:M[_.id]?e.jsx(ta,{className:"h-4 w-4"}):e.jsx(oa,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",_.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[_.elements.length," element",_.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[_.x,", ",_.y]})]}),M[_.id]&&e.jsx("div",{className:"border-t border-gray-100",children:_.elements.map((U,K)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${g===U.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>R(_.id,U.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:N(U.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:k(U,K)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[U.type," • Layer ",K+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:G=>{G.stopPropagation(),S(_.id,U.id,!U.visible)},className:"p-1 hover:bg-gray-200 rounded",title:U.visible?"Hide element":"Show element",children:U.visible!==!1?e.jsx(na,{className:"h-3 w-3 text-gray-500"}):e.jsx(ya,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:G=>{G.stopPropagation(),C(_.id,U.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:K===_.elements.length-1,children:e.jsx(fa,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:G=>{G.stopPropagation(),C(_.id,U.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:K===0,children:e.jsx(ha,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:G=>{G.stopPropagation(),j(_.id,U.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(mn,{className:"h-3 w-3"})})]})]},U.id))})]},_.id))})};function ja({currentLayoutId:o,onLayoutChange:i}){const[r,g]=p.useState("all"),s={all:{name:"Todos",layouts:ge},hero:{name:"Hero",layouts:ge.filter(m=>m.category==="hero")},editorial:{name:"Editorial",layouts:ge.filter(m=>m.category==="editorial")},storytelling:{name:"Historia",layouts:ge.filter(m=>m.category==="storytelling")},minimal:{name:"Minimal",layouts:ge.filter(m=>m.category==="minimal")},creative:{name:"Creativo",layouts:ge.filter(m=>m.category==="creative")},classic:{name:"Clásico",layouts:ge.filter(m=>m.category==="classic")}};return Object.keys(s).filter(m=>m==="all"||s[m].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:s[r].layouts.map(m=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>i(m.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${m.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:m.cells}).map((E,j)=>{var C,v;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(v=(C=m.cellStyles)==null?void 0:C[j])!=null&&v.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},j)})}),o===m.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:m.name}),m.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:m.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[m.cells," ",m.cells===1?"celda":"celdas"]})})]})]},m.id))}),s[r].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categoría."})})]})}const Sa=({selectedMask:o,onSelect:i,availableMasks:r=[],selectedImage:g})=>{var j,C;const[s,m]=p.useState("Básicas"),E={};return gn.forEach(v=>{E[v.category]||(E[v.category]=[]),(r.includes(v.id)||v.id==="none")&&E[v.category].push(v)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(E).slice(0,2).map(v=>E[v].length>0&&e.jsx("button",{onClick:()=>m(v),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${s===v?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:v},v))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(j=E[s])==null?void 0:j.slice(0,6).map(v=>e.jsxs("div",{onClick:()=>i(v.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${o===v.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:g!=null&&g.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:v.id==="circle"?"circle(50%)":v.id==="rounded"||v.id==="rounded-sm"?"inset(0 round 8%)":v.id==="rounded-lg"?"inset(0 round 16%)":v.id==="rounded-rect"?"inset(0 round 12%)":v.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":v.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":v.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":v.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":v.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":v.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":v.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":v.id==="frame"?"inset(10% round 10%)":v.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':v.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':v.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:g.content,alt:v.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:v.id==="circle"?"circle(50%)":v.id==="rounded"||v.id==="rounded-sm"?"inset(0 round 8%)":v.id==="rounded-lg"?"inset(0 round 16%)":v.id==="rounded-rect"?"inset(0 round 12%)":v.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":v.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":v.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":v.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":v.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":v.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":v.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":v.id==="frame"?"inset(10% round 10%)":v.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':v.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':v.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:v.name})]},v.id))}),((C=E[s])==null?void 0:C.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver más máscaras (",E[s].length-6," más)"]})]})};let Ot={},hn;function It(o={}){Ot={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...o}}function B(o){return o?Ot[o]:Ot}function Ta(o){hn=o}function Ee(){return hn}let mt={};function it(o,i){mt[o]=i}function Be(o){var i;(i=mt[o])==null||i.call(mt)}function ka(){mt={}}function lt(o,i,r,g){return(o/=g/2)<1?r/2*o*o+i:-r/2*(--o*(o-2)-1)+i}function fn(o){const i='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return o.flatMap(r=>{const g=r.matches(i),s=Array.from(r.querySelectorAll(i));return[...g?[r]:[],...s]}).filter(r=>getComputedStyle(r).pointerEvents!=="none"&&_a(r))}function bn(o){if(!o||Ia(o))return;const i=B("smoothScroll"),r=o.offsetHeight>window.innerHeight;o.scrollIntoView({behavior:!i||Aa(o)?"auto":"smooth",inline:"center",block:r?"start":"center"})}function Aa(o){if(!o||!o.parentElement)return;const i=o.parentElement;return i.scrollHeight>i.clientHeight}function Ia(o){const i=o.getBoundingClientRect();return i.top>=0&&i.left>=0&&i.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&i.right<=(window.innerWidth||document.documentElement.clientWidth)}function _a(o){return!!(o.offsetWidth||o.offsetHeight||o.getClientRects().length)}let pt={};function pe(o,i){pt[o]=i}function H(o){return o?pt[o]:pt}function on(){pt={}}function Pa(o,i,r,g){let s=H("__activeStagePosition");const m=s||r.getBoundingClientRect(),E=g.getBoundingClientRect(),j=lt(o,m.x,E.x-m.x,i),C=lt(o,m.y,E.y-m.y,i),v=lt(o,m.width,E.width-m.width,i),I=lt(o,m.height,E.height-m.height,i);s={x:j,y:C,width:v,height:I},vn(s),pe("__activeStagePosition",s)}function xn(o){if(!o)return;const i=o.getBoundingClientRect(),r={x:i.x,y:i.y,width:i.width,height:i.height};pe("__activeStagePosition",r),vn(r)}function Oa(){const o=H("__activeStagePosition"),i=H("__overlaySvg");if(!o)return;if(!i){console.warn("No stage svg found.");return}const r=window.innerWidth,g=window.innerHeight;i.setAttribute("viewBox",`0 0 ${r} ${g}`)}function Ra(o){const i=Ma(o);document.body.appendChild(i),En(i,r=>{r.target.tagName==="path"&&Be("overlayClick")}),pe("__overlaySvg",i)}function vn(o){const i=H("__overlaySvg");if(!i){Ra(o);return}const r=i.firstElementChild;if((r==null?void 0:r.tagName)!=="path")throw new Error("no path element found in stage svg");r.setAttribute("d",yn(o))}function Ma(o){const i=window.innerWidth,r=window.innerHeight,g=document.createElementNS("http://www.w3.org/2000/svg","svg");g.classList.add("driver-overlay","driver-overlay-animated"),g.setAttribute("viewBox",`0 0 ${i} ${r}`),g.setAttribute("xmlSpace","preserve"),g.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),g.setAttribute("version","1.1"),g.setAttribute("preserveAspectRatio","xMinYMin slice"),g.style.fillRule="evenodd",g.style.clipRule="evenodd",g.style.strokeLinejoin="round",g.style.strokeMiterlimit="2",g.style.zIndex="10000",g.style.position="fixed",g.style.top="0",g.style.left="0",g.style.width="100%",g.style.height="100%";const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",yn(o)),s.style.fill=B("overlayColor")||"rgb(0,0,0)",s.style.opacity=`${B("overlayOpacity")}`,s.style.pointerEvents="auto",s.style.cursor="auto",g.appendChild(s),g}function yn(o){const i=window.innerWidth,r=window.innerHeight,g=B("stagePadding")||0,s=B("stageRadius")||0,m=o.width+g*2,E=o.height+g*2,j=Math.min(s,m/2,E/2),C=Math.floor(Math.max(j,0)),v=o.x-g+C,I=o.y-g,M=m-C*2,y=E-C*2;return`M${i},0L0,0L0,${r}L${i},${r}L${i},0Z
    M${v},${I} h${M} a${C},${C} 0 0 1 ${C},${C} v${y} a${C},${C} 0 0 1 -${C},${C} h-${M} a${C},${C} 0 0 1 -${C},-${C} v-${y} a${C},${C} 0 0 1 ${C},-${C} z`}function La(){const o=H("__overlaySvg");o&&o.remove()}function $a(){const o=document.getElementById("driver-dummy-element");if(o)return o;let i=document.createElement("div");return i.id="driver-dummy-element",i.style.width="0",i.style.height="0",i.style.pointerEvents="none",i.style.opacity="0",i.style.position="fixed",i.style.top="50%",i.style.left="50%",document.body.appendChild(i),i}function nn(o){const{element:i}=o;let r=typeof i=="function"?i():typeof i=="string"?document.querySelector(i):i;r||(r=$a()),za(r,o)}function Ua(){const o=H("__activeElement"),i=H("__activeStep");o&&(xn(o),Oa(),Cn(o,i))}function za(o,i){var r;const g=Date.now(),s=H("__activeStep"),m=H("__activeElement")||o,E=!m||m===o,j=o.id==="driver-dummy-element",C=m.id==="driver-dummy-element",v=B("animate"),I=i.onHighlightStarted||B("onHighlightStarted"),M=(i==null?void 0:i.onHighlighted)||B("onHighlighted"),y=(s==null?void 0:s.onDeselected)||B("onDeselected"),w=B(),N=H();!E&&y&&y(C?void 0:m,s,{config:w,state:N,driver:Ee()}),I&&I(j?void 0:o,i,{config:w,state:N,driver:Ee()});const k=!E&&v;let S=!1;Va(),pe("previousStep",s),pe("previousElement",m),pe("activeStep",i),pe("activeElement",o);const R=()=>{if(H("__transitionCallback")!==R)return;const F=Date.now()-g,_=400-F<=400/2;i.popover&&_&&!S&&k&&(an(o,i),S=!0),B("animate")&&F<400?Pa(F,400,m,o):(xn(o),M&&M(j?void 0:o,i,{config:B(),state:H(),driver:Ee()}),pe("__transitionCallback",void 0),pe("__previousStep",s),pe("__previousElement",m),pe("__activeStep",i),pe("__activeElement",o)),window.requestAnimationFrame(R)};pe("__transitionCallback",R),window.requestAnimationFrame(R),bn(o),!k&&i.popover&&an(o,i),m.classList.remove("driver-active-element","driver-no-interaction"),m.removeAttribute("aria-haspopup"),m.removeAttribute("aria-expanded"),m.removeAttribute("aria-controls"),((r=i.disableActiveInteraction)!=null?r:B("disableActiveInteraction"))&&o.classList.add("driver-no-interaction"),o.classList.add("driver-active-element"),o.setAttribute("aria-haspopup","dialog"),o.setAttribute("aria-expanded","true"),o.setAttribute("aria-controls","driver-popover-content")}function Ba(){var o;(o=document.getElementById("driver-dummy-element"))==null||o.remove(),document.querySelectorAll(".driver-active-element").forEach(i=>{i.classList.remove("driver-active-element","driver-no-interaction"),i.removeAttribute("aria-haspopup"),i.removeAttribute("aria-expanded"),i.removeAttribute("aria-controls")})}function Xe(){const o=H("__resizeTimeout");o&&window.cancelAnimationFrame(o),pe("__resizeTimeout",window.requestAnimationFrame(Ua))}function Fa(o){var i;if(!H("isInitialized")||!(o.key==="Tab"||o.keyCode===9))return;const r=H("__activeElement"),g=(i=H("popover"))==null?void 0:i.wrapper,s=fn([...g?[g]:[],...r?[r]:[]]),m=s[0],E=s[s.length-1];if(o.preventDefault(),o.shiftKey){const j=s[s.indexOf(document.activeElement)-1]||E;j==null||j.focus()}else{const j=s[s.indexOf(document.activeElement)+1]||m;j==null||j.focus()}}function wn(o){var i;((i=B("allowKeyboardControl"))==null||i)&&(o.key==="Escape"?Be("escapePress"):o.key==="ArrowRight"?Be("arrowRightPress"):o.key==="ArrowLeft"&&Be("arrowLeftPress"))}function En(o,i,r){const g=(s,m)=>{const E=s.target;o.contains(E)&&((!r||r(E))&&(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation()),m==null||m(s))};document.addEventListener("pointerdown",g,!0),document.addEventListener("mousedown",g,!0),document.addEventListener("pointerup",g,!0),document.addEventListener("mouseup",g,!0),document.addEventListener("click",s=>{g(s,i)},!0)}function Ha(){window.addEventListener("keyup",wn,!1),window.addEventListener("keydown",Fa,!1),window.addEventListener("resize",Xe),window.addEventListener("scroll",Xe)}function Ga(){window.removeEventListener("keyup",wn),window.removeEventListener("resize",Xe),window.removeEventListener("scroll",Xe)}function Va(){const o=H("popover");o&&(o.wrapper.style.display="none")}function an(o,i){var r,g;let s=H("popover");s&&document.body.removeChild(s.wrapper),s=qa(),document.body.appendChild(s.wrapper);const{title:m,description:E,showButtons:j,disableButtons:C,showProgress:v,nextBtnText:I=B("nextBtnText")||"Next &rarr;",prevBtnText:M=B("prevBtnText")||"&larr; Previous",progressText:y=B("progressText")||"{current} of {total}"}=i.popover||{};s.nextButton.innerHTML=I,s.previousButton.innerHTML=M,s.progress.innerHTML=y,m?(s.title.innerHTML=m,s.title.style.display="block"):s.title.style.display="none",E?(s.description.innerHTML=E,s.description.style.display="block"):s.description.style.display="none";const w=j||B("showButtons"),N=v||B("showProgress")||!1,k=(w==null?void 0:w.includes("next"))||(w==null?void 0:w.includes("previous"))||N;s.closeButton.style.display=w.includes("close")?"block":"none",k?(s.footer.style.display="flex",s.progress.style.display=N?"block":"none",s.nextButton.style.display=w.includes("next")?"block":"none",s.previousButton.style.display=w.includes("previous")?"block":"none"):s.footer.style.display="none";const S=C||B("disableButtons")||[];S!=null&&S.includes("next")&&(s.nextButton.disabled=!0,s.nextButton.classList.add("driver-popover-btn-disabled")),S!=null&&S.includes("previous")&&(s.previousButton.disabled=!0,s.previousButton.classList.add("driver-popover-btn-disabled")),S!=null&&S.includes("close")&&(s.closeButton.disabled=!0,s.closeButton.classList.add("driver-popover-btn-disabled"));const R=s.wrapper;R.style.display="block",R.style.left="",R.style.top="",R.style.bottom="",R.style.right="",R.id="driver-popover-content",R.setAttribute("role","dialog"),R.setAttribute("aria-labelledby","driver-popover-title"),R.setAttribute("aria-describedby","driver-popover-description");const F=s.arrow;F.className="driver-popover-arrow";const _=((r=i.popover)==null?void 0:r.popoverClass)||B("popoverClass")||"";R.className=`driver-popover ${_}`.trim(),En(s.wrapper,ne=>{var se,ve,c;const ae=ne.target,h=((se=i.popover)==null?void 0:se.onNextClick)||B("onNextClick"),re=((ve=i.popover)==null?void 0:ve.onPrevClick)||B("onPrevClick"),de=((c=i.popover)==null?void 0:c.onCloseClick)||B("onCloseClick");if(ae.closest(".driver-popover-next-btn"))return h?h(o,i,{config:B(),state:H(),driver:Ee()}):Be("nextClick");if(ae.closest(".driver-popover-prev-btn"))return re?re(o,i,{config:B(),state:H(),driver:Ee()}):Be("prevClick");if(ae.closest(".driver-popover-close-btn"))return de?de(o,i,{config:B(),state:H(),driver:Ee()}):Be("closeClick")},ne=>!(s!=null&&s.description.contains(ne))&&!(s!=null&&s.title.contains(ne))&&typeof ne.className=="string"&&ne.className.includes("driver-popover")),pe("popover",s);const U=((g=i.popover)==null?void 0:g.onPopoverRender)||B("onPopoverRender");U&&U(s,{config:B(),state:H(),driver:Ee()}),Cn(o,i),bn(R);const K=o.classList.contains("driver-dummy-element"),G=fn([R,...K?[]:[o]]);G.length>0&&G[0].focus()}function Nn(){const o=H("popover");if(!(o!=null&&o.wrapper))return;const i=o.wrapper.getBoundingClientRect(),r=B("stagePadding")||0,g=B("popoverOffset")||0;return{width:i.width+r+g,height:i.height+r+g,realWidth:i.width,realHeight:i.height}}function rn(o,i){const{elementDimensions:r,popoverDimensions:g,popoverPadding:s,popoverArrowDimensions:m}=i;return o==="start"?Math.max(Math.min(r.top-s,window.innerHeight-g.realHeight-m.width),m.width):o==="end"?Math.max(Math.min(r.top-(g==null?void 0:g.realHeight)+r.height+s,window.innerHeight-(g==null?void 0:g.realHeight)-m.width),m.width):o==="center"?Math.max(Math.min(r.top+r.height/2-(g==null?void 0:g.realHeight)/2,window.innerHeight-(g==null?void 0:g.realHeight)-m.width),m.width):0}function sn(o,i){const{elementDimensions:r,popoverDimensions:g,popoverPadding:s,popoverArrowDimensions:m}=i;return o==="start"?Math.max(Math.min(r.left-s,window.innerWidth-g.realWidth-m.width),m.width):o==="end"?Math.max(Math.min(r.left-(g==null?void 0:g.realWidth)+r.width+s,window.innerWidth-(g==null?void 0:g.realWidth)-m.width),m.width):o==="center"?Math.max(Math.min(r.left+r.width/2-(g==null?void 0:g.realWidth)/2,window.innerWidth-(g==null?void 0:g.realWidth)-m.width),m.width):0}function Cn(o,i){const r=H("popover");if(!r)return;const{align:g="start",side:s="left"}=(i==null?void 0:i.popover)||{},m=g,E=o.id==="driver-dummy-element"?"over":s,j=B("stagePadding")||0,C=Nn(),v=r.arrow.getBoundingClientRect(),I=o.getBoundingClientRect(),M=I.top-C.height;let y=M>=0;const w=window.innerHeight-(I.bottom+C.height);let N=w>=0;const k=I.left-C.width;let S=k>=0;const R=window.innerWidth-(I.right+C.width);let F=R>=0;const _=!y&&!N&&!S&&!F;let U=E;if(E==="top"&&y?F=S=N=!1:E==="bottom"&&N?F=S=y=!1:E==="left"&&S?F=y=N=!1:E==="right"&&F&&(S=y=N=!1),E==="over"){const K=window.innerWidth/2-C.realWidth/2,G=window.innerHeight/2-C.realHeight/2;r.wrapper.style.left=`${K}px`,r.wrapper.style.right="auto",r.wrapper.style.top=`${G}px`,r.wrapper.style.bottom="auto"}else if(_){const K=window.innerWidth/2-(C==null?void 0:C.realWidth)/2,G=10;r.wrapper.style.left=`${K}px`,r.wrapper.style.right="auto",r.wrapper.style.bottom=`${G}px`,r.wrapper.style.top="auto"}else if(S){const K=Math.min(k,window.innerWidth-(C==null?void 0:C.realWidth)-v.width),G=rn(m,{elementDimensions:I,popoverDimensions:C,popoverPadding:j,popoverArrowDimensions:v});r.wrapper.style.left=`${K}px`,r.wrapper.style.top=`${G}px`,r.wrapper.style.bottom="auto",r.wrapper.style.right="auto",U="left"}else if(F){const K=Math.min(R,window.innerWidth-(C==null?void 0:C.realWidth)-v.width),G=rn(m,{elementDimensions:I,popoverDimensions:C,popoverPadding:j,popoverArrowDimensions:v});r.wrapper.style.right=`${K}px`,r.wrapper.style.top=`${G}px`,r.wrapper.style.bottom="auto",r.wrapper.style.left="auto",U="right"}else if(y){const K=Math.min(M,window.innerHeight-C.realHeight-v.width);let G=sn(m,{elementDimensions:I,popoverDimensions:C,popoverPadding:j,popoverArrowDimensions:v});r.wrapper.style.top=`${K}px`,r.wrapper.style.left=`${G}px`,r.wrapper.style.bottom="auto",r.wrapper.style.right="auto",U="top"}else if(N){const K=Math.min(w,window.innerHeight-(C==null?void 0:C.realHeight)-v.width);let G=sn(m,{elementDimensions:I,popoverDimensions:C,popoverPadding:j,popoverArrowDimensions:v});r.wrapper.style.left=`${G}px`,r.wrapper.style.bottom=`${K}px`,r.wrapper.style.top="auto",r.wrapper.style.right="auto",U="bottom"}_?r.arrow.classList.add("driver-popover-arrow-none"):Wa(m,U,o)}function Wa(o,i,r){const g=H("popover");if(!g)return;const s=r.getBoundingClientRect(),m=Nn(),E=g.arrow,j=m.width,C=window.innerWidth,v=s.width,I=s.left,M=m.height,y=window.innerHeight,w=s.top,N=s.height;E.className="driver-popover-arrow";let k=i,S=o;if(i==="top"?(I+v<=0?(k="right",S="end"):I+v-j<=0&&(k="top",S="start"),I>=C?(k="left",S="end"):I+j>=C&&(k="top",S="end")):i==="bottom"?(I+v<=0?(k="right",S="start"):I+v-j<=0&&(k="bottom",S="start"),I>=C?(k="left",S="start"):I+j>=C&&(k="bottom",S="end")):i==="left"?(w+N<=0?(k="bottom",S="end"):w+N-M<=0&&(k="left",S="start"),w>=y?(k="top",S="end"):w+M>=y&&(k="left",S="end")):i==="right"&&(w+N<=0?(k="bottom",S="start"):w+N-M<=0&&(k="right",S="start"),w>=y?(k="top",S="start"):w+M>=y&&(k="right",S="end")),!k)E.classList.add("driver-popover-arrow-none");else{E.classList.add(`driver-popover-arrow-side-${k}`),E.classList.add(`driver-popover-arrow-align-${S}`);const R=r.getBoundingClientRect(),F=E.getBoundingClientRect(),_=B("stagePadding")||0,U=R.left-_<window.innerWidth&&R.right+_>0&&R.top-_<window.innerHeight&&R.bottom+_>0;i==="bottom"&&U&&(F.x>R.x&&F.x+F.width<R.x+R.width?g.wrapper.style.transform="translateY(0)":(E.classList.remove(`driver-popover-arrow-align-${S}`),E.classList.add("driver-popover-arrow-none"),g.wrapper.style.transform=`translateY(-${_/2}px)`))}}function qa(){const o=document.createElement("div");o.classList.add("driver-popover");const i=document.createElement("div");i.classList.add("driver-popover-arrow");const r=document.createElement("header");r.id="driver-popover-title",r.classList.add("driver-popover-title"),r.style.display="none",r.innerText="Popover Title";const g=document.createElement("div");g.id="driver-popover-description",g.classList.add("driver-popover-description"),g.style.display="none",g.innerText="Popover description is here";const s=document.createElement("button");s.type="button",s.classList.add("driver-popover-close-btn"),s.setAttribute("aria-label","Close"),s.innerHTML="&times;";const m=document.createElement("footer");m.classList.add("driver-popover-footer");const E=document.createElement("span");E.classList.add("driver-popover-progress-text"),E.innerText="";const j=document.createElement("span");j.classList.add("driver-popover-navigation-btns");const C=document.createElement("button");C.type="button",C.classList.add("driver-popover-prev-btn"),C.innerHTML="&larr; Previous";const v=document.createElement("button");return v.type="button",v.classList.add("driver-popover-next-btn"),v.innerHTML="Next &rarr;",j.appendChild(C),j.appendChild(v),m.appendChild(E),m.appendChild(j),o.appendChild(s),o.appendChild(i),o.appendChild(r),o.appendChild(g),o.appendChild(m),{wrapper:o,arrow:i,title:r,description:g,footer:m,previousButton:C,nextButton:v,closeButton:s,footerButtons:j,progress:E}}function Qa(){var o;const i=H("popover");i&&((o=i.wrapper.parentElement)==null||o.removeChild(i.wrapper))}function Da(o={}){It(o);function i(){B("allowClose")&&I()}function r(){const y=B("overlayClickBehavior");if(B("allowClose")&&y==="close"){I();return}y==="nextStep"&&g()}function g(){const y=H("activeIndex"),w=B("steps")||[];if(typeof y>"u")return;const N=y+1;w[N]?v(N):I()}function s(){const y=H("activeIndex"),w=B("steps")||[];if(typeof y>"u")return;const N=y-1;w[N]?v(N):I()}function m(y){(B("steps")||[])[y]?v(y):I()}function E(){var y;if(H("__transitionCallback"))return;const w=H("activeIndex"),N=H("__activeStep"),k=H("__activeElement");if(typeof w>"u"||typeof N>"u"||typeof H("activeIndex")>"u")return;const S=((y=N.popover)==null?void 0:y.onPrevClick)||B("onPrevClick");if(S)return S(k,N,{config:B(),state:H(),driver:Ee()});s()}function j(){var y;if(H("__transitionCallback"))return;const w=H("activeIndex"),N=H("__activeStep"),k=H("__activeElement");if(typeof w>"u"||typeof N>"u")return;const S=((y=N.popover)==null?void 0:y.onNextClick)||B("onNextClick");if(S)return S(k,N,{config:B(),state:H(),driver:Ee()});g()}function C(){H("isInitialized")||(pe("isInitialized",!0),document.body.classList.add("driver-active",B("animate")?"driver-fade":"driver-simple"),Ha(),it("overlayClick",r),it("escapePress",i),it("arrowLeftPress",E),it("arrowRightPress",j))}function v(y=0){var w,N,k,S,R,F,_,U;const K=B("steps");if(!K){console.error("No steps to drive through"),I();return}if(!K[y]){I();return}pe("__activeOnDestroyed",document.activeElement),pe("activeIndex",y);const G=K[y],ne=K[y+1],se=K[y-1],ve=((w=G.popover)==null?void 0:w.doneBtnText)||B("doneBtnText")||"Done",c=B("allowClose"),ae=typeof((N=G.popover)==null?void 0:N.showProgress)<"u"?(k=G.popover)==null?void 0:k.showProgress:B("showProgress"),h=(((S=G.popover)==null?void 0:S.progressText)||B("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${y+1}`).replace("{{total}}",`${K.length}`),re=((R=G.popover)==null?void 0:R.showButtons)||B("showButtons"),de=["next","previous",...c?["close"]:[]].filter(V=>!(re!=null&&re.length)||re.includes(V)),He=((F=G.popover)==null?void 0:F.onNextClick)||B("onNextClick"),z=((_=G.popover)==null?void 0:_.onPrevClick)||B("onPrevClick"),Z=((U=G.popover)==null?void 0:U.onCloseClick)||B("onCloseClick");nn({...G,popover:{showButtons:de,nextBtnText:ne?void 0:ve,disableButtons:[...se?[]:["previous"]],showProgress:ae,progressText:h,onNextClick:He||(()=>{ne?v(y+1):I()}),onPrevClick:z||(()=>{v(y-1)}),onCloseClick:Z||(()=>{I()}),...(G==null?void 0:G.popover)||{}}})}function I(y=!0){const w=H("__activeElement"),N=H("__activeStep"),k=H("__activeOnDestroyed"),S=B("onDestroyStarted");if(y&&S){const _=!w||(w==null?void 0:w.id)==="driver-dummy-element";S(_?void 0:w,N,{config:B(),state:H(),driver:Ee()});return}const R=(N==null?void 0:N.onDeselected)||B("onDeselected"),F=B("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),Ga(),Qa(),Ba(),La(),ka(),on(),w&&N){const _=w.id==="driver-dummy-element";R&&R(_?void 0:w,N,{config:B(),state:H(),driver:Ee()}),F&&F(_?void 0:w,N,{config:B(),state:H(),driver:Ee()})}k&&k.focus()}const M={isActive:()=>H("isInitialized")||!1,refresh:Xe,drive:(y=0)=>{C(),v(y)},setConfig:It,setSteps:y=>{on(),It({...B(),steps:y})},getConfig:B,getState:H,getActiveIndex:()=>H("activeIndex"),isFirstStep:()=>H("activeIndex")===0,isLastStep:()=>{const y=B("steps")||[],w=H("activeIndex");return w!==void 0&&w===y.length-1},getActiveStep:()=>H("activeStep"),getActiveElement:()=>H("activeElement"),getPreviousElement:()=>H("previousElement"),getPreviousStep:()=>H("previousStep"),moveNext:g,movePrevious:s,moveTo:m,hasNextStep:()=>{const y=B("steps")||[],w=H("activeIndex");return w!==void 0&&!!y[w+1]},hasPreviousStep:()=>{const y=B("steps")||[],w=H("activeIndex");return w!==void 0&&!!y[w-1]},highlight:y=>{C(),nn({...y,popover:y.popover?{showButtons:[],showProgress:!1,progressText:"",...y.popover}:void 0})},destroy:()=>{I(!1)}};return Ta(M),M}const Pe=new Map,Fe=new Map;function Ka(o,i,r,g,s,m){if(!i||!i.type)return;console.log("🎭 [Mask] Aplicando máscara:",i.type),o.save(),o.beginPath();const E=r+s/2,j=g+m/2;switch(i.type){case"circle":const C=Math.min(s,m)/2;o.arc(E,j,C,0,2*Math.PI);break;case"ellipse":o.ellipse(E,j,s/2,m/2,0,0,2*Math.PI);break;case"star":const v=5,I=Math.min(s,m)/2,M=I*.4;for(let w=0;w<v*2;w++){const N=w*Math.PI/v,k=w%2===0?I:M,S=E+Math.cos(N)*k,R=j+Math.sin(N)*k;w===0?o.moveTo(S,R):o.lineTo(S,R)}o.closePath();break;case"hexagon":const y=Math.min(s,m)/2;for(let w=0;w<6;w++){const N=w*Math.PI/3,k=E+Math.cos(N)*y,S=j+Math.sin(N)*y;w===0?o.moveTo(k,S):o.lineTo(k,S)}o.closePath();break;case"triangle":o.moveTo(E,g),o.lineTo(r,g+m),o.lineTo(r+s,g+m),o.closePath();break;default:o.rect(r,g,s,m)}o.clip()}async function jn(o){return Pe.has(o)?Pe.get(o):new Promise((i,r)=>{const g=new Image;g.crossOrigin="anonymous",g.onload=()=>{Pe.set(o,g),i(g)},g.onerror=()=>{console.warn(`⚠️ No se pudo cargar imagen: ${o}`),i(null)},setTimeout(()=>{Pe.has(o)||(console.warn(`⏰ Timeout cargando imagen: ${o}`),i(null))},3e3),g.src=o})}function Sn(o,i,r){var w,N,k,S;const{x:g,y:s,width:m,height:E}=r,j=((w=i.position)==null?void 0:w.x)||0,C=((N=i.position)==null?void 0:N.y)||0,v=g+(j<=1?j*m:j),I=s+(C<=1?C*E:C),M=(k=i.size)!=null&&k.width?i.size.width<=1?i.size.width*m:i.size.width:m,y=(S=i.size)!=null&&S.height?i.size.height<=1?i.size.height*E:i.size.height:E;if(console.log(`🎨 [FastThumbnail] Renderizando elemento ${i.id}:`,{type:i.type,hasFilters:!!i.filters,hasMask:!!i.mask,filters:i.filters,mask:i.mask}),i.type==="image"&&i.content){const R=Pe.get(i.content);if(R){if(o.save(),o.translate(v,I),i.filters){console.log("🎨 [FastThumbnail] APLICANDO FILTROS COMPLETOS:",i.filters);const se=`
                    brightness(${(i.filters.brightness??100)/100})
                    contrast(${(i.filters.contrast??100)/100})
                    saturate(${(i.filters.saturation??100)/100})
                    sepia(${(i.filters.tint??0)/100})
                    hue-rotate(${i.filters.hue??0}deg)
                    blur(${Math.max(i.filters.blur??0,i.filters.gaussianBlur??0)}px)
                    opacity(${(i.filters.opacity??100)/100})
                `.replace(/\s+/g," ").trim();if(console.log("🎨 [FastThumbnail] Filter string:",se),o.filter=se,i.filters.scale!==void 0||i.filters.rotate!==void 0||i.filters.flipHorizontal||i.filters.flipVertical){const ve=i.filters.scale??1,c=i.filters.rotate??0,ae=i.filters.flipHorizontal??!1,h=i.filters.flipVertical??!1;o.translate(M/2,y/2),o.scale(ve*(ae?-1:1),ve*(h?-1:1)),o.rotate(c*Math.PI/180),o.translate(-M/2,-y/2)}}i.mask&&(console.log("🎭 [FastThumbnail] APLICANDO MÁSCARA:",i.mask),Ka(o,i.mask,v,I,M,y));const F=R.width/R.height,_=M/y;let U=0,K=0,G=R.width,ne=R.height;F>_?(G=R.height*_,U=(R.width-G)/2):(ne=R.width/_,K=(R.height-ne)/2),o.drawImage(R,U,K,G,ne,0,0,M,y),console.log("🖼️ [FastThumbnail] Imagen dibujada con filtros y máscaras"),o.restore()}}else if(i.type==="text"&&i.content){o.save();const R=i.style||{},F=Math.max(8,parseInt(R.fontSize)||16),_=R.color||"#000000";o.font=`${F}px Arial, sans-serif`,o.fillStyle=_,o.textBaseline="top";let U=i.content.split(`
`)[0]||"";U.length>50&&(U=U.substring(0,50)+"..."),o.fillText(U,v+4,I+4),o.restore()}}async function Ya({page:o,workspaceDimensions:i,onProgress:r=null}){console.log(`⚡ Generando thumbnail para página: ${o.id}`);const s=(m,E,j="")=>{const C=Math.round(m/E*100);console.log(`📊 Progreso página ${o.id}: ${m}/${E} (${C}%) ${j}`),r&&r({current:m,total:E,percentage:C,message:j,pageId:o.id})};try{const m=300/Math.max(i.width,i.height),E=Math.round(i.width*m),j=Math.round(i.height*m),C=`${o.id}-${E}x${j}`;if(Fe.has(C))return console.log(`📦 Thumbnail encontrado en cache: ${o.id}`),s(4,4,"Cargado desde cache"),Fe.get(C);s(1,4,"Iniciando generación...");const v=new Set;o.backgroundImage&&v.add(o.backgroundImage),o.cells&&o.cells.forEach(N=>{N.elements&&N.elements.forEach(k=>{k.type==="image"&&k.content&&v.add(k.content)})}),s(2,4,"Cargando imágenes...");const I=Array.from(v).map(async N=>{try{const k=new Promise((R,F)=>setTimeout(()=>F(new Error("Timeout")),3e3)),S=jn(N);await Promise.race([S,k])}catch{console.warn(`⚠️ Error/timeout cargando imagen: ${N}`)}});await Promise.all(I),s(3,4,"Renderizando thumbnail...");const M=document.createElement("canvas"),y=M.getContext("2d",{alpha:!1,willReadFrequently:!1});if(M.width=E,M.height=j,y.fillStyle=o.backgroundColor||"#ffffff",y.fillRect(0,0,M.width,M.height),o.backgroundImage){const N=Pe.get(o.backgroundImage);N&&y.drawImage(N,0,0,M.width,M.height)}if(o.cells&&o.cells.length>0){const N=Math.ceil(Math.sqrt(Math.min(o.cells.length,9))),k=M.width/N,S=M.height/Math.ceil(Math.min(o.cells.length,9)/N);o.cells.slice(0,9).forEach((R,F)=>{const _=F%N,U=Math.floor(F/N),K=_*k,G=U*S;R.elements&&R.elements.filter(se=>se.type==="image"||se.type==="text").slice(0,3).forEach(se=>{Sn(y,se,{x:K,y:G,width:k,height:S})})})}s(4,4,"Guardando thumbnail...");const w=M.toDataURL("image/jpeg",.7);return Fe.set(C,w),console.log(`✅ Thumbnail generado para página: ${o.id}`),w}catch(m){return console.error(`❌ Error generando thumbnail para página ${o.id}:`,m),s(4,4,"Error en generación"),null}}async function ln({pages:o,workspaceDimensions:i,onProgress:r=null}){const g={};console.log(`⚡ Generando ${o.length} thumbnails rápidos...`);const m=(y,w,N="")=>{const k=Math.round(y/w*100);console.log(`📊 Progreso: ${y}/${w} (${k}%) ${N}`),r&&r({current:y,total:w,percentage:k,message:N})},E=new Set;o.forEach(y=>{y.backgroundImage&&E.add(y.backgroundImage),y.cells&&y.cells.forEach(w=>{w.elements&&w.elements.forEach(N=>{N.type==="image"&&N.content&&E.add(N.content)})})});const j=Array.from(E),C=5;m(0,j.length,"Cargando imágenes...");for(let y=0;y<j.length;y+=C){const w=j.slice(y,y+C);await Promise.all(w.map(jn)),m(Math.min(y+C,j.length),j.length,"Cargando imágenes...")}console.log(`📸 Imágenes cargadas: ${Pe.size}`);const v=300/Math.max(i.width,i.height),I=Math.round(i.width*v),M=Math.round(i.height*v);m(0,o.length,"Generando thumbnails...");for(let y=0;y<o.length;y++){const w=o[y];try{const N=`${w.id}-${I}x${M}`;if(Fe.has(N)){g[w.id]=Fe.get(N),m(y+1,o.length,`Thumbnail ${w.id} (cached)`);continue}const k=document.createElement("canvas"),S=k.getContext("2d",{alpha:!1,willReadFrequently:!1});if(k.width=I,k.height=M,S.fillStyle=w.backgroundColor||"#ffffff",S.fillRect(0,0,k.width,k.height),w.backgroundImage){const F=Pe.get(w.backgroundImage);F&&S.drawImage(F,0,0,k.width,k.height)}if(w.cells&&w.cells.length>0){const F=Math.ceil(Math.sqrt(w.cells.length)),_=k.width/F,U=k.height/Math.ceil(w.cells.length/F);w.cells.forEach((K,G)=>{if(G>=9)return;const ne=G%F,se=Math.floor(G/F),ve=ne*_,c=se*U;K.elements&&K.elements.filter(h=>h.type==="image"||h.type==="text").slice(0,3).forEach(h=>{Sn(S,h,{x:ve,y:c,width:_,height:U})})})}const R=k.toDataURL("image/jpeg",.7);g[w.id]=R,Fe.set(N,R),m(y+1,o.length,`Thumbnail ${w.id} generado`)}catch(N){console.error(`❌ Error generando thumbnail rápido para ${w.id}:`,N),g[w.id]=null,m(y+1,o.length,`Error en ${w.id}`)}}return console.log(`⚡ ¡${Object.keys(g).length} thumbnails generados en modo rápido!`),g}function cn(){Pe.clear(),Fe.clear(),console.log("🧹 Caches de thumbnails limpiados")}const Ja=async(o,i,r)=>{var g;try{console.log("📤 [SAVE] Subiendo imagen al backend:",i);const[s,m]=o.split(","),E=((g=s.match(/data:image\/(\w+)/))==null?void 0:g[1])||"png",j=new FormData,C=atob(m),v=new Array(C.length);for(let N=0;N<C.length;N++)v[N]=C.charCodeAt(N);const I=new Uint8Array(v),M=new Blob([I],{type:`image/${E}`});j.append("image",M,`element_${i}.${E}`),j.append("project_id",r),j.append("element_id",i);const y=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:j});if(!y.ok)throw new Error("Error al subir imagen al servidor");const w=await y.json();return console.log("✅ [SAVE] Imagen subida exitosamente:",w.url),w.url}catch(s){throw console.error("❌ [SAVE] Error subiendo imagen:",s),s}},Xa=async(o,i)=>{var m,E;console.log("🔄 [SAVE] Procesando imágenes para guardado...");const r=[];let g=0,s=0;for(const j of o)for(const C of j.cells||[])for(const v of C.elements||[])v.type==="image"&&((m=v.content)!=null&&m.startsWith("data:image/"))&&g++;console.log(`📊 [SAVE] Total de imágenes base64 a procesar: ${g}`);for(const j of o){const C={...j};C.cells=[];for(const v of j.cells||[]){const I={...v};I.elements=[];for(const M of v.elements||[]){const y={...M};if(M.type==="image"&&((E=M.content)!=null&&E.startsWith("data:image/")))try{const w=await Ja(M.content,M.id,i);y.content=w,y.isUploaded=!0,s++,console.log(`✅ [SAVE] Imagen ${s}/${g} procesada`)}catch(w){console.error("❌ [SAVE] Error procesando imagen:",M.id,w),y.uploadError=w.message}I.elements.push(y)}C.cells.push(I)}r.push(C)}return console.log(`✅ [SAVE] Procesamiento completado: ${s}/${g} imágenes subidas`),r},Za=async(o,i)=>{var r;try{console.log("🔍 [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:o,thumbnailsCount:Object.keys(i).length});const g=[];for(const[E,j]of Object.entries(i))console.log(`🔍 [DEBUG] Procesando thumbnail para página ${E}:`,{hasData:!!j,isBase64:j&&j.startsWith("data:image/"),dataLength:j?j.length:0}),j&&j.startsWith("data:image/")&&g.push({page_id:E,thumbnail_data:j});if(g.length===0){console.log("ℹ️ [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`🖼️ [THUMBNAILS] Guardando ${g.length} thumbnails como archivos...`),console.log(`🔍 [DEBUG] URL del endpoint: /api/thumbnails/${o}/save-as-files`);const s=await fetch(`/api/thumbnails/${o}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content)||""},credentials:"include",body:JSON.stringify({thumbnails:g})});if(console.log("🔍 [DEBUG] Respuesta del servidor:",{status:s.status,statusText:s.statusText,ok:s.ok}),!s.ok){const E=await s.text();throw console.error("❌ [THUMBNAILS] Error respuesta del servidor:",E),new Error(`Error al guardar thumbnails: ${s.status} ${s.statusText}`)}const m=await s.json();return console.log("✅ [THUMBNAILS] Thumbnails guardados como archivos:",m),m}catch(g){throw console.error("❌ [THUMBNAILS] Error guardando thumbnails:",g),g}},dn=async(o,i,r,g,s,m,E=!1)=>{try{if(!(i!=null&&i.id))throw new Error("No se encontró el ID del proyecto");console.log(`💾 [SAVE] Iniciando ${E?"auto-guardado":"guardado manual"}...`);let j=o;E||(j=await Xa(o,i.id));const C={pages:j,projectInfo:{id:i.id,item_id:r==null?void 0:r.id,title:r==null?void 0:r.title,preset_id:g==null?void 0:g.id},workspace:{width:s.width,height:s.height,scale:s.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:E,totalPages:o.length}},v=E?"save-progress":"save",I=await fetch(`/api/canvas/projects/${i.id}/${v}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:C,thumbnails:m})});if(!I.ok){const y=await I.json().catch(()=>({}));throw new Error(y.message||"Error al guardar el proyecto")}const M=await I.json();if(console.log(`✅ [SAVE] ${E?"Auto-guardado":"Guardado"} exitoso:`,M),!E&&m&&Object.keys(m).length>0){console.log("🖼️ [SAVE] Guardando thumbnails como archivos...");try{await Za(i.id,m),console.log("✅ [SAVE] Thumbnails guardados como archivos")}catch(y){console.warn("⚠️ [SAVE] Error guardando thumbnails como archivos:",y)}}return{success:!0,data:M}}catch(j){return console.error(`❌ [SAVE] Error en ${E?"auto-guardado":"guardado"}:`,j),{success:!1,error:j.message}}},er=(o,i,r,g,s,m)=>{const[E,j]=p.useState("saved"),[C,v]=p.useState(null),[I,M]=p.useState(null),[y,w]=p.useState(null),[N,k]=p.useState(!1),[S,R]=p.useState(navigator.onLine),F=p.useRef(null),_=p.useRef(null),U=p.useRef(null),K=p.useRef(!1),G=p.useRef(null),ne=15e3,se=2e3,ve=5e3,c=p.useCallback((z,Z)=>{try{const V={pages:z.map(he=>{var Q;return{id:he.id,layout:he.layout,cells:((Q=he.cells)==null?void 0:Q.map(xe=>{var ht;return{id:xe.id,elements:((ht=xe.elements)==null?void 0:ht.map(ye=>{var je;return{id:ye.id,type:ye.type,content:ye.type==="image"&&((je=ye.content)!=null&&je.startsWith("data:image/"))?`[IMAGE_${ye.content.length}]`:ye.content,position:ye.position,size:ye.size,style:ye.style,filters:ye.filters,rotation:ye.rotation}}))||[]}}))||[]}})||[],workspace:{width:Z==null?void 0:Z.width,height:Z==null?void 0:Z.height}};return btoa(JSON.stringify(V)).substring(0,32)}catch(V){return console.warn("⚠️ [AUTO-SAVE] Error generando hash:",V),Date.now().toString()}},[]),ae=p.useCallback(()=>`album_editor_autosave_${(i==null?void 0:i.id)||"draft"}`,[i==null?void 0:i.id]),h=p.useCallback(z=>{try{const Z=ae(),V={...z,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(Z,JSON.stringify(V)),console.log("💾 [AUTO-SAVE] Guardado en localStorage"),!0}catch(Z){return console.error("❌ [AUTO-SAVE] Error guardando en localStorage:",Z),!1}},[ae]),re=p.useCallback(()=>{var z;try{const Z=ae(),V=localStorage.getItem(Z);if(V){const he=JSON.parse(V);return console.log("📂 [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(z=he.pages)==null?void 0:z.length,savedAt:new Date(he.savedAt).toLocaleString()}),he}}catch(Z){console.error("❌ [AUTO-SAVE] Error cargando desde localStorage:",Z)}return null},[ae]),de=p.useCallback(async(z=!1)=>{if(K.current&&!z){console.log("⏳ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(i!=null&&i.id)||!o||o.length===0){console.log("⚠️ [AUTO-SAVE] Datos insuficientes para guardar");return}const Z=c(o,s);if(!z&&Z===U.current){console.log("📊 [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{K.current=!0,j("saving"),w(null);const V={pages:o,projectInfo:{id:i.id,item_id:r==null?void 0:r.id,title:r==null?void 0:r.title,preset_id:g==null?void 0:g.id},workspace:s,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:Z}};if(h(V),S){const he=await dn(o,i,r,g,s,m,!0);if(he.success)U.current=Z,M(new Date),j("saved"),k(!1),console.log("✅ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(he.error)}else console.log("� [AUTO-SAVE] Sin conexión, solo guardado en localStorage"),j("pending"),k(!0)}catch(V){console.error("❌ [AUTO-SAVE] Error:",V),w(V.message),j("error"),S&&(G.current=setTimeout(()=>{console.log("🔄 [AUTO-SAVE] Reintentando guardado..."),de(!0)},ve))}finally{K.current=!1}},[o,i,r,g,s,m,c,h,S]),He=p.useCallback(async()=>{try{j("saving");const z=await dn(o,i,r,g,s,m,!1);if(z.success){const Z=c(o,s);U.current=Z,v(new Date),j("saved"),k(!1),oe.success("💾 Proyecto guardado exitosamente"),console.log("✅ [MANUAL-SAVE] Guardado manual exitoso")}else w(z.error),j("error"),oe.error(`❌ Error al guardar: ${z.error}`);return z.success}catch(z){return console.error("❌ [MANUAL-SAVE] Error:",z),w(z.message),j("error"),oe.error(`❌ Error inesperado: ${z.message}`),!1}},[o,i,r,g,s,m,c]);return p.useEffect(()=>{if(!(i!=null&&i.id)||!o||o.length===0)return;const z=c(o,s);return U.current&&z!==U.current?(console.log("🔄 [AUTO-SAVE] Cambios detectados, programando guardado..."),k(!0),j("pending"),_.current&&clearTimeout(_.current),_.current=setTimeout(()=>{de()},se)):U.current||(U.current=z),()=>{_.current&&clearTimeout(_.current)}},[o,s,i==null?void 0:i.id,c,de]),p.useEffect(()=>{if(i!=null&&i.id)return F.current&&clearInterval(F.current),F.current=setInterval(()=>{N&&(console.log("⏰ [AUTO-SAVE] Auto-save periódico activado"),de())},ne),()=>{F.current&&clearInterval(F.current)}},[i==null?void 0:i.id,N,de]),p.useEffect(()=>{const z=()=>{console.log("🌐 [AUTO-SAVE] Conexión restaurada"),R(!0),N&&setTimeout(()=>de(!0),1e3)},Z=()=>{console.log("📴 [AUTO-SAVE] Conexión perdida"),R(!1)};return window.addEventListener("online",z),window.addEventListener("offline",Z),()=>{window.removeEventListener("online",z),window.removeEventListener("offline",Z)}},[N,de]),p.useEffect(()=>{const z=Z=>{if(N){const V={pages:o,projectInfo:{id:i.id},workspace:s,meta:{savedAt:new Date().toISOString()}};return h(V),Z.preventDefault(),Z.returnValue="¿Estás seguro de salir? Hay cambios sin guardar.","¿Estás seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",z),()=>window.removeEventListener("beforeunload",z)},[N,o,i==null?void 0:i.id,s,h]),p.useEffect(()=>()=>{_.current&&clearTimeout(_.current),F.current&&clearInterval(F.current),G.current&&clearTimeout(G.current)},[]),p.useEffect(()=>{y&&(y.includes("max_allowed_packet")||y.includes("data_too_large")?oe.error("❌ El proyecto es demasiado grande para guardar automáticamente. Reduce el número o tamaño de imágenes."):oe.error(`❌ Error de auto-guardado: ${y}`))},[y]),{saveStatus:E,lastSaved:C,lastAutoSaved:I,saveError:y,hasUnsavedChanges:N,isOnline:S,saveManually:He,performAutoSave:()=>de(!0),loadFromLocalStorage:re,getStorageKey:ae,autoSaveInterval:ne,debounceDelay:se}},tr=({saveStatus:o,lastSaved:i,lastAutoSaved:r,hasUnsavedChanges:g,isOnline:s,saveError:m,onManualSave:E,className:j=""})=>{const C=M=>{if(!M)return null;const w=new Date-M,N=Math.floor(w/(1e3*60)),k=Math.floor(w/1e3);if(k<30)return"hace unos segundos";if(N<1)return`hace ${k}s`;if(N<60)return`hace ${N}m`;const S=Math.floor(N/60);return S<24?`hace ${S}h`:M.toLocaleDateString()},I=(()=>{if(!s)return{icon:e.jsx(tn,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexión",detail:"Guardado local activo"};switch(o){case"saving":return{icon:e.jsx(da,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(ca,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:r?`Auto-guardado ${C(r)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(la,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:m||"Error desconocido"};case"pending":return{icon:e.jsx(ia,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:g?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(pn,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${j}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${I.bg} ${I.color}
                    hover:shadow-md
                `,onClick:()=>o!=="saving"&&(E==null?void 0:E()),children:[I.icon,e.jsx("span",{className:"text-sm font-medium",children:I.text}),g&&o!=="saving"&&e.jsx("div",{className:"w-2 h-2 bg-orange-500 rounded-full animate-pulse"}),e.jsx("div",{className:"flex items-center",children:s?e.jsx(Na,{className:"w-3 h-3 text-green-500"}):e.jsx(tn,{className:"w-3 h-3 text-orange-500"})})]}),e.jsxs("div",{className:`
                absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2
                bg-gray-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg
                opacity-0 group-hover:opacity-100 pointer-events-none
                transition-opacity duration-200 z-50 whitespace-nowrap
            `,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:I.text}),e.jsx("div",{className:"text-gray-300",children:I.detail}),i&&e.jsxs("div",{className:"text-gray-400 text-xs",children:["Último guardado manual: ",C(i)]}),e.jsxs("div",{className:"text-gray-400 text-xs",children:[s?"🌐 En línea":"📴 Sin conexión",o!=="saving"&&" • Click para guardar"]})]}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"})]}),o==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},or=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const o=document.createElement("style");o.textContent=or,document.head.appendChild(o)}function ct(o,i){let r;return function(...s){const m=()=>{clearTimeout(r),o(...s)};clearTimeout(r),r=setTimeout(m,i)}}const _t=Pt.memo(({pageId:o,thumbnail:i,altText:r,type:g})=>{const[s,m]=p.useState(!1),[E,j]=p.useState(!1);if(i&&!E)return e.jsxs("div",{className:"relative w-full h-full",children:[!s&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:i,alt:r,className:`w-full h-full object-contain transition-opacity duration-200 ${s?"opacity-100":"opacity-0"}`,onLoad:()=>m(!0),onError:()=>j(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const C=g==="cover"||g==="final"?dt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((v,I)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},I))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(C,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(o,i)=>o.pageId===i.pageId&&o.thumbnail===i.thumbnail&&o.altText===i.altText&&o.type===i.type),nr=Pt.memo(({images:o,onImageSelect:i,isLoading:r})=>{const g=Pt.memo(({image:s})=>{const[m,E]=p.useState(!1),[j,C]=p.useState(!1),[v,I]=p.useState(!1),[{isDragging:M},y]=pa(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:s.url},collect:R=>({isDragging:!!R.isDragging()}),end:()=>{setTimeout(()=>I(!1),100)}})),w=s.thumbnail_url||s.url,N=s.url,k=R=>{I(!0),setTimeout(()=>I(!1),500)},S=R=>{if(v||M)return R.preventDefault(),R.stopPropagation(),!1;i(N)};return e.jsxs("div",{ref:y,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${M?"opacity-50 scale-95":""}`,onMouseDown:k,onClick:S,children:[e.jsxs("div",{className:"aspect-square relative",children:[!m&&!j&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),j?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(ze,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:w,alt:s.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${m?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>E(!0),onError:()=>C(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(ut,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:s.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),s.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return r?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((s,m)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},m))}):o.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ze,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay imágenes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:o.map((s,m)=>e.jsx(g,{image:s},`${s.id||s.url}-${m}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[o.filter(s=>s.has_thumbnail).length," de ",o.length," imágenes optimizadas"]})})]})});function is(){var so,io,lo,co,uo,go,mo,po,ho,fo,bo,xo,vo,yo,wo,Eo,No,Co,jo,So,To,ko,Ao,Io,_o,Po,Oo,Ro,Mo,Lo,$o,Uo,zo,Bo,Fo,Ho,Go,Vo,Wo,qo,Qo;const[o,i]=p.useState(null),[r,g]=p.useState(null),[s,m]=p.useState(null),[E,j]=p.useState(null),[C,v]=p.useState(!0),[I,M]=p.useState(null),[y,w]=p.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[N,k]=p.useState(new Map),[S,R]=p.useState([]),[F,_]=p.useState(!1),U=p.useRef(S),K=p.useRef(N);p.useRef(null);const G=p.useRef(null),ne=p.useRef(null);p.useEffect(()=>{U.current=S},[S]),p.useEffect(()=>{K.current=N},[N]),p.useEffect(()=>{(async()=>{var n,a;try{const d=new URLSearchParams(window.location.search).get("project");if(!d){M("No se encontró el ID del proyecto en la URL"),v(!1);return}const b=await fetch(`/api/canvas/projects/${d}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!b.ok)throw new Error("Error al cargar el proyecto");const f=await b.json();console.log("📊 ===== DATOS DEL PROYECTO CARGADOS ====="),console.log("🔍 PROJECT ID desde URL:",d),console.log("🔍 PROJECT DATA completo:",f),console.log("🔍 PROJECT DATA ID:",(a=f==null?void 0:f.project)==null?void 0:a.id),console.log("========================================"),i(f.project),g(f.item),m(f.canvasPreset),j(f.initialProject),v(!1)}catch(l){console.error("❌ Error cargando proyecto:",l),M(l.message),v(!1)}})()},[]);const[se,ve]=p.useState(Xo.Local.get(`${Zo.APP_CORRELATIVE}_cart`)??[]);p.useEffect(()=>{Xo.Local.set(`${Zo.APP_CORRELATIVE}_cart`,se)},[se]);const[c,ae]=p.useState([]),[h,re]=p.useState(0),[de,He]=p.useState("preset"),[z,Z]=p.useState(null),[V,he]=p.useState(null),[Q,xe]=p.useState("pages"),[ht,ye]=p.useState("basic"),[je,Ve]=p.useState([JSON.stringify(c)]),[we,Me]=p.useState(0),[Rt,ar]=p.useState(!1),[rr,Mt]=p.useState(null),[te,ue]=p.useState({}),[sr,ir]=p.useState(!1),[Te,Le]=p.useState([]),[ft,Lt]=p.useState(!1),[Ze,Tn]=p.useState(new Map),[We,kn]=p.useState(()=>new Map),[qe,et]=p.useState(null),[$t,Ut]=p.useState(!1);p.useEffect(()=>{console.log("✅ [FILTERS] Tab actual:",Q)},[Q]),p.useCallback((t,n="manual")=>{if(console.log(`🔄 [ACTIVE_TAB] Cambiando de "${Q}" a "${t}" - Razón: ${n}`),t==="filters"&&n!=="manual"){console.warn("🚨 [ACTIVE_TAB] Cambio automático a filters bloqueado!");return}xe(t)},[Q]),console.log("🎉 [FILTERS FIX] Editor cargado - Fix del problema de filtros ACTIVADO"),window.FORCE_THUMBNAIL_REGENERATION=!0,window.PREVENT_THUMBNAIL_RESET=!1,p.useEffect(()=>{window.forceRegenerateAllThumbnails=()=>{console.log("💣 [EMERGENCIA-GLOBAL] Forzando regeneración de TODOS los thumbnails"),window.thumbnailCache={},k(t=>{const n=new Map(t);return c.forEach((a,l)=>{n.set(l,Date.now())}),n}),console.log("1️⃣ Regenerando página actual"),me(!0).then(()=>{console.log("✅ Primera regeneración completa"),window.BLOCK_AUTO_REGENERATION=!0,setTimeout(()=>{console.log("2️⃣ Ejecutando segunda regeneración forzada"),window.forceRegenerateThumbnail&&window.forceRegenerateThumbnail(),window.THUMBNAIL_PROTECTED=!0,setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,console.log("🔓 Regeneración automática desbloqueada")},5e3)},200)}).catch(t=>{console.error("❌ Error en regeneración de emergencia:",t)})},console.log("📢 Puedes forzar la regeneración de thumbnails usando window.forceRegenerateAllThumbnails()")},[c]);const[tt,Qe]=p.useState(!1),zt=p.useRef(),[q,Bt]=p.useState({width:800,height:600}),Ft=p.useMemo(()=>Da({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¡Bienvenido al Editor de BananaLab! 🍌",description:"Este es tu lienzo de trabajo donde crearás diseños increíbles. Aquí puedes ver y editar la página actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"🎯 Navegación Principal",description:"En la barra lateral izquierda encontrarás todas las herramientas organizadas por categorías. Cada ícono te lleva a una sección específica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"📄 Sección Páginas",description:"Gestiona todas las páginas de tu proyecto: portada, páginas de contenido y contraportada. Haz clic en cualquier página para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"🎨 Sección Diseños",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu página. Cada diseño tiene una distribución única.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"📚 Sección Capas",description:"Organiza y controla la superposición de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posición.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"✍️ Sección Textos",description:"Agrega y personaliza textos: títulos, subtítulos y párrafos. Cambia fuentes, colores, tamaños y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"🎭 Sección Filtros",description:"Aplica efectos visuales a tus imágenes: brillo, contraste, saturación, máscaras y más filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"⚡ Acciones Rápidas",description:"Herramientas de acceso rápido: cambiar diseño de página, gestionar capas, agregar imágenes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"💾 Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso automáticamente y acceder a la vista previa de tu álbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"👁️ Vista de Álbum",description:"Visualiza tu proyecto completo como un álbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"🎉 ¡Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una página y agregando elementos. ¡Diviértete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente →",prevBtnText:"← Anterior",doneBtnText:"¡Empezar a crear! 🚀",closeBtnText:"✕",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(t,n)=>{var l,d;console.log("🎯 Mostrando paso:",(l=n.popover)==null?void 0:l.title);const a=(d=t==null?void 0:t.getAttribute)==null?void 0:d.call(t,"data-tab");a&&Q!==a&&xe(a)},onDeselected:()=>{console.log("✅ Guía completada"),oe.success("¡Guía completada! Ya puedes empezar a crear tu diseño.",{duration:3e3})}}),[Q,xe]),An=p.useCallback(()=>{console.log("🚀 Iniciando tour guiado"),Ft.drive()},[Ft]),bt=p.useCallback(async()=>{if(o!=null&&o.id)try{const t=await fetch(`/api/thumbnails/${o.id}`);if(t.ok){const n=await t.json();if(n.success&&n.thumbnails&&n.thumbnails.length>0){const a={};n.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(a[l.page_id]=l.thumbnail_url)}),Object.keys(a).length>0?(ue(l=>({...l,...a})),console.log("✅ Thumbnails cargados desde storage:",Object.keys(a).length)):console.log("ℹ️ No hay thumbnails guardados, usando generación local")}else console.log("ℹ️ No hay thumbnails guardados para este proyecto")}}catch(t){console.warn("⚠️ Error cargando thumbnails guardados (usando locales):",t)}},[o==null?void 0:o.id]),me=p.useCallback(async(t=!1)=>{var b;if(window.BLOCK_AUTO_REGENERATION&&!t){console.log("🛡️ [PROTECCIÓN] Bloqueando regeneración automática mientras los filtros están aplicándose");return}const n=c[h],a=n==null?void 0:n.id;if((a&&window._protectedThumbnailIds&&((b=window._protectedThumbnailIds)==null?void 0:b.includes(a))||window.THUMBNAIL_PROTECTED)&&te[a]&&!t){console.log("🔒 [PROTECCIÓN SELECTIVA] Thumbnail con filtros protegido contra regeneración");return}if(!c[h]||!q)return;const d=c[h];if(te[d.id]&&!t){console.log(`✅ Thumbnail ya existe para página: ${d.id}`);return}if(ke.current){console.log("⏳ Ya se está generando un thumbnail...");return}ke.current=!0;try{console.log(`📸 Generando thumbnail para página actual: ${d.id} (forzado: ${t})`),t&&(console.log("🧹 [FORCE-REGEN] Limpiando cache antes de regenerar"),cn(),ue(u=>{const x={...u};return delete x[d.id],x})),console.log(`📸 [FORCE-GENERATION] Generando thumbnail FORZADO para: ${d.id}`);const f=await Ya({page:d,workspaceDimensions:q,onProgress:u=>{et(u)}});f&&(ue(u=>({...u,[d.id]:f})),console.log(`✅ Thumbnail generado para página: ${d.id}`))}catch(f){console.warn("⚠️ Error generando thumbnail de página actual:",f)}finally{ke.current=!1,et(null)}},[c,h,q,te]),xt=p.useCallback(ct(async()=>{if(window.BLOCK_AUTO_REGENERATION){console.log("🛡️ [PROTECCIÓN-GLOBAL] Bloqueando generación masiva mientras los filtros están protegidos");return}if(window.THUMBNAIL_PROTECTED){console.log("🔒 [PROTECCIÓN-GLOBAL] Generación masiva bloqueada, thumbnails protegidos");return}if(!(!(c!=null&&c.length)||!q)){if(ke.current){console.log("⏳ Thumbnails ya se están generando, saltando...");return}ke.current=!0;try{const t=c.filter(a=>!te[a.id]);if(t.length===0){console.log("✅ Todos los thumbnails ya existen");return}console.log(`📸 Generando ${t.length} thumbnails rápidos...`);const n=await ln({pages:t,workspaceDimensions:q,onProgress:a=>{et(a)}});n&&Object.keys(n).length>0&&(ue(a=>({...a,...n})),console.log("✅ Thumbnails rápidos generados:",Object.keys(n).length))}catch(t){console.warn("⚠️ Error generando thumbnails rápidos:",t)}finally{ke.current=!1,et(null)}}},300),[c,q,te]),ke=p.useRef(!1);p.useCallback(async(t=[])=>{if(!ke.current)try{if(ke.current=!0,t.length>0){const n=c.filter(a=>t.includes(a.id));if(n.length>0){console.log(`🎯 Generando ${n.length} thumbnails prioritarios...`);const a=await ln({pages:n,workspaceDimensions:q});a&&Object.keys(a).length>0&&ue(l=>({...l,...a}))}}}catch(n){console.warn("⚠️ Error en generación prioritaria:",n)}finally{ke.current=!1}},[c,q,xt]);const Ht=p.useCallback(t=>{if(We.has&&We.has(t))return;const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{if(n.width>1200||n.height>1200){const l=document.createElement("canvas"),d=l.getContext("2d"),b=1200,f=Math.min(b/n.width,b/n.height),u=n.width*f,x=n.height*f;l.width=u,l.height=x,d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.drawImage(n,0,0,u,x),l.toBlob(T=>{if(T){const P=URL.createObjectURL(T);kn(O=>{const W=new Map(O);if(W.set(t,P),W.size>15){const A=W.keys().next().value,L=W.get(A);URL.revokeObjectURL(L),W.delete(A)}return W})}},"image/webp",.85)}},n.onerror=()=>{console.warn("❌ Error pre-cargando imagen:",t)},n.src=t},[]);p.useEffect(()=>{Te.length>0&&Te.slice(0,10).forEach((n,a)=>{setTimeout(()=>{Ht(n.url)},a*100)})},[Te,Ht]),p.useEffect(()=>()=>{We&&We.forEach&&We.forEach(t=>URL.revokeObjectURL(t))},[]),p.useEffect(()=>()=>{cn()},[]);const Gt=p.useCallback(async()=>{var t;if(!(!(o!=null&&o.id)||!(c!=null&&c.length))){if($t){console.log("⏳ Ya hay una carga de thumbnails en progreso, omitiendo...");return}try{Ut(!0),console.log("🔄 Iniciando carga de thumbnails existentes...");const n=await fetch(`/api/thumbnails/${o.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:c})});if(n.ok){const a=await n.json();a&&Object.keys(a).length>0?(ue(l=>({...l,...a})),console.log("✅ Thumbnails existentes cargados:",Object.keys(a).length)):(console.log("📸 No hay thumbnails existentes, generando para página actual..."),setTimeout(()=>me(),200))}}catch(n){console.warn("⚠️ Error cargando thumbnails existentes:",n),setTimeout(()=>me(),200)}finally{Ut(!1)}}},[o==null?void 0:o.id,c,me,$t]);p.useCallback(async()=>{if(!(!(o!=null&&o.id)||!(c!=null&&c.length)))try{const t=c[h];if(!t)return;const n=await fetch(`/api/thumbnails/${o.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:q.width,height:q.height,quality:95,scale:4,dpi:300})});if(n.ok){const a=await n.json();if(a.success&&a.thumbnails){const l={};a.thumbnails.forEach(d=>{d.page_id&&d.thumbnail_url&&(l[d.page_id]=d.thumbnail_url)}),ue(d=>({...d,...l})),console.log("✅ Thumbnail generado y guardado en storage para página actual:",a.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando thumbnail:",t)}},[o==null?void 0:o.id,c,h,q]),p.useCallback(async()=>{if(!(!(o!=null&&o.id)||!(c!=null&&c.length)))try{const t=await fetch(`/api/thumbnails/${o.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:c,width:q.width,height:q.height,quality:95,scale:4,dpi:300})});if(t.ok){const n=await t.json();if(n.success&&n.thumbnails){const a={};n.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(a[l.page_id]=l.thumbnail_url)}),ue(l=>({...l,...a})),console.log("✅ Todos los thumbnails generados y guardados en storage:",n.thumbnails.length)}}}catch(t){console.warn("⚠️ Error generando todos los thumbnails:",t)}},[o==null?void 0:o.id,c,q]);const In=p.useCallback(async(t=null)=>{if(!(o!=null&&o.id)||!(c!=null&&c.length))return{};try{console.log("📖 [ALBUM-MODAL] Cargando thumbnails PDF existentes...");const n={},a={};let l=0;const d=async(f,u)=>new Promise(x=>{const T=new Image;T.onload=()=>{a[u]=f,l++,t==null||t(l,c.length),x(!0)},T.onerror=()=>{console.warn(`⚠️ [ALBUM-MODAL] Thumbnail no encontrado: ${f}`),l++,t==null||t(l,c.length),x(!1)},T.src=f}),b=c.map(async(f,u)=>{let x;const T=r&&(r.has_cover_image===!0||r.has_cover_image===1),P=r&&(r.has_back_cover_image===!0||r.has_back_cover_image===1),O=T&&c.some($=>$.type==="cover"),W=P&&c.some($=>$.type==="final");if(f.type==="cover")x=0;else if(f.type==="content")O?x=c.filter(X=>X.type==="content").findIndex(X=>X.id===f.id)+1:x=c.filter(X=>X.type==="content").findIndex(X=>X.id===f.id)+1;else if(f.type==="final"){const $=c.filter(X=>X.type==="content");x=$.length+1}else x=u;const A=`/storage/images/thumbnails/${o.id}/page-${x}-pdf.png`,L=f.id||`page-${u}`;return n[L]=A,console.log(`🔍 [THUMBNAIL-MAP] Página ${u}:`,{tipo:f.type,pageNumber:f.pageNumber,realPageNumber:x,url:A,pageId:f.id,hasCover:O,hasBackCover:W,coverEnabled:T,backCoverEnabled:P}),d(A,L)});return await Promise.all(b),console.log(`✅ [ALBUM-MODAL] Thumbnails verificados: ${Object.keys(a).length}/${c.length}`),n}catch(n){return console.warn("⚠️ [ALBUM-MODAL] Error cargando thumbnails PDF:",n),{}}},[o==null?void 0:o.id,c,r]);p.useEffect(()=>{if(E&&r&&s){if(E.pages&&Array.isArray(E.pages)){const t=E.pages.map(n=>{let a=null,l=s.background_color||"#ffffff";return n.type==="cover"&&(r.has_cover_image===!0||r.has_cover_image===1)?r.cover_image&&(a=`/storage/images/item/${r.cover_image}`):n.type==="content"?r.content_image&&(a=`/storage/images/item/${r.content_image}`):(n.type==="final"||n.type==="contraportada")&&(r.has_back_cover_image===!0||r.has_back_cover_image===1)&&r.back_cover_image&&(a=`/storage/images/item/${r.back_cover_image}`),{...n,backgroundImage:a,backgroundColor:l}}).filter(n=>!(n.type==="cover"&&(r.has_cover_image===!1||r.has_cover_image===0)||(n.type==="final"||n.type==="contraportada")&&(r.has_back_cover_image===!1||r.has_back_cover_image===0)));ae(n=>n.length>0?(console.log("⚠️ Páginas ya existentes, preservando cambios del usuario"),n.map((a,l)=>{const d=t[l];return d?{...a,backgroundImage:a.backgroundImage||d.backgroundImage,backgroundColor:a.backgroundColor||d.backgroundColor}:a})):(console.log("📄 Carga inicial de páginas desde la base de datos"),t)),Ve(n=>n.length<=1?[JSON.stringify(t)]:n),Me(n=>n===0&&je.length<=1?0:n),setTimeout(()=>{bt()},100)}else{const t=Xt(s,r);ae(t),Ve([JSON.stringify(t)]),Me(0),setTimeout(()=>{bt()},100)}typeof E.currentPage=="number"&&re(E.currentPage),E.workspaceSize&&He(E.workspaceSize)}},[E,r,s,bt]);const Ae=er(c,o,r,s,q,te),Vt=()=>{if(s!=null&&s.width&&(s!=null&&s.height)){let u=s.width,x=s.height,T=u*37.8,P=x*37.8;if(T&&P){const O=window.innerWidth*.6,W=window.innerHeight*.7,A=O/T,L=W/P,$=Math.min(A,L,1);return{width:Math.round(T*$),height:Math.round(P*$),originalWidth:u,originalHeight:x,scale:$,unit:"cm",originalWidthPx:Math.round(T),originalHeightPx:Math.round(P)}}}if(s!=null&&s.extra_settings)try{const u=typeof s.extra_settings=="string"?JSON.parse(s.extra_settings):s.extra_settings;if(u!=null&&u.canvas_config){const x=u.canvas_config;let T=x.width,P=x.height,O=T*37.8,W=P*37.8;if(O&&W){const A=window.innerWidth*.6,L=window.innerHeight*.7,$=A/O,D=L/W,X=Math.min($,D,1);return{width:Math.round(O*X),height:Math.round(W*X),originalWidth:T,originalHeight:P,scale:X,unit:"cm",originalWidthPx:Math.round(O),originalHeightPx:Math.round(W)}}}}catch(u){console.warn("Error parsing extra_settings:",u)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},n=t[de]||t.preset,a=window.innerWidth*.6,l=window.innerHeight*.7,d=a/n.width,b=l/n.height,f=Math.min(d,b,1);return{width:Math.round(n.width*f),height:Math.round(n.height*f),originalWidth:n.width,originalHeight:n.height,scale:f,unit:"px"}},Ie=p.useCallback(async(t={type:"thumbnail"})=>{if(!c[h])return null;try{let n=document.querySelector(`#page-${c[h].id}`);if(!n)return console.warn("❌ THUMBNAIL: No se encontró el elemento de página específico"),null;const a=c[h],l=t.type==="pdf",d=l?11.81:3,b=1,f=getComputedStyle(n);let u=(a==null?void 0:a.backgroundColor)||"#ffffff";f.backgroundColor&&f.backgroundColor!=="rgba(0, 0, 0, 0)"&&(u=f.backgroundColor);const x={scale:d,useCORS:!0,allowTaint:!1,backgroundColor:u,width:q.width,height:q.height,x:0,y:0,scrollX:0,scrollY:0,foreignObjectRendering:!!l,removeContainer:!1,logging:!1,imageTimeout:l?6e4:15e3,pixelRatio:l?3:window.devicePixelRatio||1,canvas:l?document.createElement("canvas"):null,windowWidth:l?q.width*d:null,windowHeight:l?q.height*d:null,onclone:async O=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(A=>{try{O.querySelectorAll(A).forEach($=>$.remove())}catch(L){console.warn("Error removing selector:",A,L)}});try{const A=O.querySelector(`#page-${c[h].id}`);A&&(A.style.width=q.width+"px",A.style.height=q.height+"px",A.style.position="relative",A.style.overflow="hidden",a!=null&&a.backgroundImage&&(A.style.backgroundImage=`url(${a.backgroundImage})`,A.style.backgroundSize="cover",A.style.backgroundPosition="center",A.style.backgroundRepeat="no-repeat"),a!=null&&a.backgroundColor&&(A.style.backgroundColor=a.backgroundColor))}catch(A){console.error("❌ [THUMBNAIL-FIX] Error configurando elemento de página:",A)}try{const A=new Map;n.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((J,_e)=>{if(J.complete&&J.naturalWidth>0){const be=(J.closest('[data-element-type="image"]')||J.parentElement).getBoundingClientRect(),Se=J.getBoundingClientRect();A.set(J.src,{src:J.src,naturalWidth:J.naturalWidth,naturalHeight:J.naturalHeight,containerWidth:be.width,containerHeight:be.height,objectFit:getComputedStyle(J).objectFit||"cover",objectPosition:getComputedStyle(J).objectPosition||"center",crossOrigin:J.crossOrigin})}});const $=async(J,_e,fe,be,Se)=>new Promise($e=>{try{const Ue=_e/fe,jt=be/Se;let nt,at,St,Tt,Do,Ko;jt>Ue?(Ko=fe,Do=fe*jt,at=Se,nt=Se*Ue,St=(be-nt)/2,Tt=0):(Do=_e,Ko=_e/jt,nt=be,at=be/Ue,St=0,Tt=(Se-at)/2);const rt=O.createElement("canvas");rt.width=_e,rt.height=fe;const Dn=rt.getContext("2d"),Je=new Image;Je.crossOrigin="anonymous",Je.onload=()=>{try{Dn.drawImage(Je,St,Tt,nt,at,0,0,_e,fe);const kt=rt.toDataURL("image/png",1);J.src=kt,J.style.objectFit="fill",J.style.objectPosition="center",J.style.width="100%",J.style.height="100%",$e()}catch(kt){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en canvas processing:",kt),$e()}},Je.onerror=()=>{console.warn("⚠️ [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),$e()},Je.src=J.src}catch(Ue){console.warn("⚠️ [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",Ue),$e()}}),D=O.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),X=[];D.forEach((J,_e)=>{if(J.src&&A.has(J.src)){const fe=A.get(J.src),be=J.closest('[data-element-type="image"]')||J.parentElement;if(be&&(be.style.overflow="hidden",be.style.position="relative"),fe.objectFit==="cover"||J.classList.contains("object-cover")||J.classList.contains("workspace-image")){const Se=$(J,fe.containerWidth,fe.containerHeight,fe.naturalWidth,fe.naturalHeight);X.push(Se)}else J.style.width="100%",J.style.height="100%",J.style.objectFit="fill"}}),X.length>0&&await Promise.all(X);const Y=O.createElement("style");Y.textContent=`
                            /* CORRECCIÓN THUMBNAIL: Estructura del elemento de página */
                            #page-${c[h].id} {
                                width: ${q.width}px !important;
                                height: ${q.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* 🖨️ IMÁGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya están recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${l?`
                                /* 🖨️ IMPRESIÓN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de página */
                            #page-${c[h].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* 🖨️ OPTIMIZACIONES GENERALES PARA PDF DE IMPRESIÓN */
                            ${l?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,O.head.appendChild(Y)}catch(A){console.error("❌ [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",A);const L=O.createElement("style");L.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,O.head.appendChild(L)}}},T=await Jo(n,x);if(l&&T){const O=T.getContext("2d");if(O){O.imageSmoothingEnabled=!1,O.imageSmoothingQuality="high";const W=O.getImageData(0,0,T.width,T.height),A=W.data;for(let L=0;L<A.length;L+=4)A[L]=Math.min(255,A[L]*1.05),A[L+1]=Math.min(255,A[L+1]*1.05),A[L+2]=Math.min(255,A[L+2]*1.05);O.putImageData(W,0,0)}}if(!T)throw new Error("html2canvas no devolvió un canvas válido para el elemento de página");if(T.width===0||T.height===0)throw new Error("Canvas del elemento de página tiene dimensiones inválidas");const P=T.toDataURL("image/png",b);if(!P||P==="data:,")throw new Error("No se pudo generar dataURL del elemento de página");return l?T:P}catch(n){console.error("❌ [THUMBNAIL-FIX] Error capturando elemento de página:",n);try{const a=document.createElement("canvas"),l=t.type==="pdf"?11.81:1;a.width=q.width*l,a.height=q.height*l;const d=a.getContext("2d"),b=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return d.fillStyle=b,d.fillRect(0,0,a.width,a.height),d.fillStyle=b==="#ffffff"||b.includes("white")?"#374151":"#666666",d.font=`${14*l}px Arial`,d.textAlign="center",d.fillText("Página "+(h+1),a.width/2,a.height/2),t.type==="pdf"?a:a.toDataURL("image/png",1)}catch{return null}}},[h,c]);p.useCallback(async()=>{if(!c[h])return;const t=await Ie({type:"thumbnail"});t&&ue(n=>({...n,[c[h].id]:t}))},[Ie,h,c]),p.useCallback(()=>{clearTimeout(zt.current),zt.current=setTimeout(()=>{c[h]&&(ue(t=>{const n={...t};return delete n[c[h].id],n}),setTimeout(()=>{me()},200))},1e3)},[c,h,me]);const _n=p.useCallback(()=>{c[h]&&(ue(t=>{const n={...t};return delete n[c[h].id],n}),setTimeout(()=>{me()},300))},[c,h,me]),Pn=p.useCallback(async(t=h,n={width:800,height:600})=>{var a,l;if(!c[t])return null;try{const d=h;t!==h&&(re(t),await new Promise(x=>setTimeout(x,100)));const b=document.querySelector(`#page-${c[t].id}`);if(!b)return console.warn("Workspace element not found for page:",c[t].id),null;const f={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((a=c[t])==null?void 0:a.backgroundColor)||"#ffffff",width:b.offsetWidth,height:b.offsetHeight,removeContainer:!0,logging:!1,onclone:x=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(A=>{x.querySelectorAll(A).forEach($=>$.remove())});const P=x.querySelector(`#page-${c[t].id}`);if(P){const A=c[t];A!=null&&A.backgroundImage&&(P.style.backgroundImage=`url(${A.backgroundImage})`,P.style.backgroundSize="cover",P.style.backgroundPosition="center",P.style.backgroundRepeat="no-repeat"),A!=null&&A.backgroundColor&&(P.style.backgroundColor=A.backgroundColor)}try{const A=b.querySelectorAll("img"),L=new Map;A.forEach((D,X)=>{const Y=getComputedStyle(D);L.set(X,{objectFit:Y.objectFit,objectPosition:Y.objectPosition,width:Y.width,height:Y.height,borderRadius:Y.borderRadius,transform:Y.transform})}),x.querySelectorAll("img").forEach((D,X)=>{const Y=L.get(X);Y&&(D.style.objectFit=Y.objectFit||"cover",D.style.objectPosition=Y.objectPosition||"center",D.style.width=Y.width,D.style.height=Y.height,D.style.borderRadius=Y.borderRadius,D.style.transform=Y.transform)})}catch(A){console.warn("Error preservando estilos de imágenes:",A),x.querySelectorAll("img").forEach($=>{$.style.objectFit="cover",$.style.objectPosition="center",$.style.width||($.style.width="100%"),$.style.height||($.style.height="100%")})}x.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(A=>{const L=A.className;L&&(A.className=L);const $=getComputedStyle?getComputedStyle(A):null;$&&($.fontFamily&&$.fontFamily!=="Arial"&&(A.style.fontFamily=$.fontFamily),$.fontSize&&(A.style.fontSize=$.fontSize),$.fontWeight&&(A.style.fontWeight=$.fontWeight),$.fontStyle&&(A.style.fontStyle=$.fontStyle))});const W=x.createElement("style");W.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CRÍTICO: Asegurar que las imágenes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CRÍTICO: Asegurar que los backgrounds de página se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,x.head.appendChild(W)}},u=await Jo(b,f);if(n.width!==u.width||n.height!==u.height){const x=document.createElement("canvas");x.width=n.width,x.height=n.height;const T=x.getContext("2d"),P=u.width/u.height,O=n.width/n.height;let W,A,L=0,$=0;P>O?(W=n.width,A=n.width/P,$=(n.height-A)/2):(A=n.height,W=n.height*P,L=(n.width-W)/2),T.fillStyle=((l=c[t])==null?void 0:l.backgroundColor)||"#ffffff",T.fillRect(0,0,n.width,n.height),T.drawImage(u,L,$,W,A);const D=x.toDataURL("image/png",1);return t!==d&&re(d),D}return t!==d&&re(d),u.toDataURL("image/png",1)}catch(d){return console.error("❌ Error generando thumbnail de alta calidad:",d),null}},[c,h,re]);p.useEffect(()=>{const t=Vt();Bt(t)},[s,de]),p.useEffect(()=>{const t=()=>{const n=Vt();Bt(n)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s,de]),p.useEffect(()=>{if(c[h]&&!te[c[h].id]){const t=setTimeout(()=>{me()},500);return()=>clearTimeout(t)}},[h,c,te,me]),p.useEffect(()=>{const t=c[h];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(n=>{n.ok?console.log("✅ [WORKSPACE] Imagen existe en el servidor"):console.error("❌ [WORKSPACE] Imagen NO existe en el servidor. Status:",n.status)}).catch(n=>{console.error("❌ [WORKSPACE] Error verificando imagen:",n)})},[h,(so=c[h])==null?void 0:so.backgroundImage]),p.useEffect(()=>{const t=`${q.width}x${q.height}`,n=sessionStorage.getItem("lastWorkspaceDimensions");n&&n!==t&&c.length>0&&(ue({}),setTimeout(()=>{c[h]&&_n()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[q.width,q.height]),p.useEffect(()=>{if(!(o!=null&&o.id)||c.length===0)return;let t,n=Date.now(),a=!1;const l=()=>{a=!0,n=Date.now()},d=async()=>{if(a)try{console.log("🔄 [AUTO-SAVE] Iniciando guardado silencioso en segundo plano..."),setAutoSave(x=>({...x,saveStatus:"saving"}));const f=await fetch(`/api/projects/${o.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:c,force:!1})}),u=await f.json();if(f.ok&&u.success)a=!1,w(x=>({...x,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1})),console.log("✅ [AUTO-SAVE] Guardado silencioso completado");else throw new Error("Guardado falló")}catch(f){console.error("❌ [AUTO-SAVE] Error en guardado silencioso:",f),w(u=>({...u,saveStatus:"error",saveError:f.message}))}},b=()=>{t=setInterval(()=>{const f=Date.now()-n;a&&f>6e4&&(console.log("⏰ [AUTO-SAVE] Condiciones cumplidas para guardado automático"),d())},3*60*1e3)};return JSON.stringify(c),c[h],l(),b(),()=>{t&&clearInterval(t)}},[c,h,o==null?void 0:o.id]),p.useEffect(()=>{var n;if(!c[h])return;const t=((n=c[h].cells)==null?void 0:n.flatMap(a=>a.elements))||[];JSON.stringify(t),w(a=>({...a,hasUnsavedChanges:!0}))},[(io=c[h])==null?void 0:io.cells,h]);const[lr,vt]=p.useState(!1),[cr,On]=p.useState({elementId:null,cellId:null}),[Rn,Wt]=p.useState(!1),[dr,Mn]=p.useState(!1),[ur,gr]=p.useState(null),[Ln,$n]=p.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[Oe,Ne]=p.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de álbum...",subMessage:"Preparando tu vista previa personalizada"}),yt=p.useRef(null),qt=t=>{var l,d,b,f;const n=V||((d=(l=c[h])==null?void 0:l.cells[0])==null?void 0:d.id);if(!n)return;const a={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((f=(b=c[h].cells.find(u=>u.id===n))==null?void 0:b.elements)==null?void 0:f.length)||0)+1};Ye(n,a),oe.success("Imagen añadida correctamente")},wt=p.useCallback(ct(async(t=!1)=>{if(!(o!=null&&o.id))return;const n=Ze.get(o.id);if(!t&&n&&n.length>0){console.log("🔄 Usando imágenes desde cache"),Te.length===0&&Le(n);return}if(G.current&&clearTimeout(G.current),ft&&!t){console.log("⏳ Carga de imágenes ya en progreso");return}Lt(!0);try{const a=new AbortController,l=setTimeout(()=>a.abort(),1e4),d=await fetch(`/api/canvas/projects/${o.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:a.signal});if(clearTimeout(l),!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const b=await d.json();if(b.success){const f=b.images||[],u=JSON.stringify(Te),x=JSON.stringify(f);u!==x&&(Le(f),Tn(T=>{const P=new Map(T);if(P.set(o.id,f),P.size>5){const O=P.keys().next().value;P.delete(O)}return P}))}else console.error("Error cargando imágenes:",b.message),oe.error("Error cargando galería de imágenes")}catch(a){a.name==="AbortError"?console.warn("⚠️ Carga de imágenes cancelada por timeout"):(console.error("Error cargando imágenes del proyecto:",a),oe.error("Error de conexión al cargar imágenes"))}finally{Lt(!1)}},200),[o==null?void 0:o.id,Ze,Te,ft]),Un=p.useCallback(async t=>{const n=t.target.files[0];if(!n||!(o!=null&&o.id))return;const a=oe.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),l=URL.createObjectURL(n),d={id:`temp-${Date.now()}`,filename:n.name,url:l,thumbnail_url:l,has_thumbnail:!1,size:n.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Le(f=>[d,...f]),qt(l);const b=new FormData;b.append("image",n),b.append("projectId",o.id);try{const u=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:b})).json();if(u.success){const x={id:u.id||Date.now(),filename:n.name,url:u.url,thumbnail_url:u.thumbnail_url||u.url,has_thumbnail:u.has_thumbnail||!1,size:n.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Le(T=>[x,...T.filter(P=>P.id!==d.id)]),setTimeout(()=>{ae(T=>{const P=[...T];return P[h].cells.forEach(W=>{W.elements.forEach(A=>{A.type==="image"&&A.content===l&&(A.content=u.url)})}),P})},100),oe.dismiss(a),oe.success(u.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{wt(!0)},2e3)}else Le(x=>x.filter(T=>T.id!==d.id)),URL.revokeObjectURL(l),oe.dismiss(a),oe.error(u.message||"Error al subir la imagen")}catch(f){console.error("Error subiendo la imagen:",f),Le(u=>u.filter(x=>x.id!==d.id)),URL.revokeObjectURL(l),oe.dismiss(a),oe.error("Error de red al subir la imagen")}},[o==null?void 0:o.id,h,qt,wt]);p.useEffect(()=>{if(o!=null&&o.id){const t=Ze.get(o.id);if(t&&t.length>0){Le(t);return}return G.current=setTimeout(()=>{wt(!1)},150),()=>{G.current&&clearTimeout(G.current)}}},[o==null?void 0:o.id,Ze]),p.useEffect(()=>()=>{G.current&&clearTimeout(G.current)},[]);const Qt=(t,n)=>{if(console.log("🖼️ [ADD-IMAGE] Agregando imagen sin selección automática"),!c||c.length===0||!c[h]){console.error("❌ [ADD-IMAGE] No hay páginas válidas para agregar imagen");return}const a=JSON.parse(JSON.stringify(c));let l=!1;for(let d=0;d<a[h].cells.length;d++)if(a[h].cells[d].id===t){a[h].cells[d].elements.push(n),l=!0,console.log("✅ [ADD-IMAGE] Imagen agregada a la celda:",t);break}if(!l){console.error("❌ [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{Ke(a),console.log("✅ [ADD-IMAGE] Estado actualizado sin selección automática")},0)},zn=p.useCallback(t=>{var f,u,x,T;console.log("🖼️ [ADD-FROM-GALLERY] Iniciando proceso de agregar imagen:",t);const n=tt;Qe(!0);const a=Q==="images",l=V||((u=(f=c[h])==null?void 0:f.cells[0])==null?void 0:u.id);if(!l){console.error("❌ [ADD-FROM-GALLERY] No hay celda disponible"),oe.error("No hay celda disponible para agregar la imagen"),Qe(n);return}if(!t||typeof t!="string"){console.error("❌ [ADD-FROM-GALLERY] URL de imagen inválida"),oe.error("URL de imagen no válida"),Qe(n);return}const d=JSON.parse(JSON.stringify(c));console.log("📸 [ADD-FROM-GALLERY] Snapshot del estado actual capturado");const b={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((T=(x=d[h].cells.find(P=>P.id===l))==null?void 0:x.elements)==null?void 0:T.length)||0)+1};console.log("📝 [ADD-FROM-GALLERY] Elemento creado:",b),setTimeout(()=>{Qt(l,b),setTimeout(()=>{a&&(xe("images"),console.log("🔄 [ADD-FROM-GALLERY] Tab restaurado a images")),setTimeout(()=>{Qe(n),oe.success("✅ Imagen añadida desde la galería"),console.log("✅ [ADD-FROM-GALLERY] Proceso completado exitosamente")},50)},50)},50)},[Q,V,c,h,tt,Qt]),Dt=p.useCallback(async(t,n)=>{var d,b;const a=[],l=[];for(const f of t){const u={...f};if(f.cells){u.cells=[];for(const x of f.cells){const T={...x};if(x.elements){T.elements=[];for(const P of x.elements)if(P.type==="image"&&((d=P.content)!=null&&d.startsWith("data:image/"))){const O=`${P.id}_${Date.now()}`,W=P.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(W){const A=W[1],L=W[2],D=`${O}.${A==="jpeg"?"jpg":A}`;l.push({filename:D,data:L,type:A,elementId:P.id}),T.elements.push({...P,content:P.content,_wasBase64:!0,_originalSize:P.content.length,_elementId:P.id})}else T.elements.push(P)}else T.elements.push(P)}u.cells.push(T)}}a.push(u)}if(l.length>0)try{const f=await fetch(`/api/canvas/projects/${n}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((b=document.querySelector('meta[name="csrf-token"]'))==null?void 0:b.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:l})});if(f.ok){const u=await f.json();if(u.uploadedImages){const x=new Map;u.uploadedImages.forEach(T=>{x.set(T.elementId,T.url)});for(const T of a)if(T.cells){for(const P of T.cells)if(P.elements)for(const O of P.elements)O._wasBase64&&O._elementId&&x.has(O._elementId)&&(O.content=x.get(O._elementId),delete O._elementId)}}}else{const u=await f.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("❌ [IMAGE-UPLOAD] Error subiendo imágenes:",u),t}}catch(f){return console.error("❌ [IMAGE-UPLOAD] Error de red subiendo imágenes:",f),t}return a},[]),De=p.useCallback(async(t=c,n=!1)=>{var a;if(!(!(o!=null&&o.id)||!n&&t.length===0))try{const b={design_data:{pages:await Dt(t,o.id),currentPage:h,workspaceDimensions:q,workspaceSize:de,selectedElement:z,selectedCell:V,history:je.slice(-5),historyIndex:Math.min(we,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:o.id,name:(r==null?void 0:r.name)||"Álbum Personalizado",item_id:r==null?void 0:r.id,preset_id:s==null?void 0:s.id}},thumbnails:te},u=JSON.stringify(b).length/(1024*1024),x=await fetch(`/api/canvas/projects/${o.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(b)});if(x.ok){const T=await x.json(),P=`editor_progress_project_${o.id}`;return localStorage.removeItem(P),k(O=>{const W=new Map(O);return n?W.clear():W.delete(h),W}),c&&c.length>0&&setTimeout(()=>{me().catch(O=>{console.warn("⚠️ Error regenerando thumbnail de página actual:",O)})},300),!0}else{const T=await x.json().catch(()=>({message:"Error desconocido"}));return console.error("❌ [AUTO-SAVE] Error guardando en BD:",T),!1}}catch(l){return console.error("❌ [AUTO-SAVE] Error en auto-save con procesamiento de imágenes:",l),!1}},[c,h,q,de,z,V,je,we,o==null?void 0:o.id,r==null?void 0:r.name,r==null?void 0:r.id,s==null?void 0:s.id,te,Dt,xt]);p.useEffect(()=>{if(!(o!=null&&o.id))return;const t=setInterval(()=>{c.length>0&&De(c,!1)},5*60*1e3);return()=>clearInterval(t)},[De,c,o==null?void 0:o.id]),p.useCallback(async()=>{if(!c.length)return{};console.log("📸 [THUMBNAILS] Capturando thumbnails de todas las páginas...");const t={},n=h;try{for(let a=0;a<c.length;a++){const l=c[a];if(l!=null&&l.id)try{a!==h&&(re(a),await new Promise(b=>setTimeout(b,300)));const d=await Ie({type:"thumbnail"});d&&(t[l.id]=d,console.log(`✅ [THUMBNAILS] Thumbnail capturado para página ${a+1}: ${l.id}`))}catch(d){console.warn(`⚠️ [THUMBNAILS] Error capturando thumbnail para página ${l.id}:`,d),te[l.id]&&(t[l.id]=te[l.id])}}return n!==h&&re(n),console.log(`✅ [THUMBNAILS] Capturados ${Object.keys(t).length} thumbnails de ${c.length} páginas`),t}catch(a){return console.error("❌ [THUMBNAILS] Error capturando thumbnails:",a),n!==h&&re(n),te}},[c,h,re,Ie,te]);const Bn=p.useCallback(async()=>{if(!(o!=null&&o.id)||c.length===0)return oe.error("No hay datos para guardar"),!1;try{return console.log("📸 [SAVE] Generando thumbnail de página actual..."),await me(),await Gt(),await De(c,!0)?(oe.success("Progreso guardado exitosamente"),!0):(oe.error("Error al guardar el progreso"),!1)}catch(t){return console.error("❌ [SAVE] Error al guardar el progreso:",t),oe.error("Error al guardar el progreso"),!1}},[De,c,o==null?void 0:o.id,q,s,xt]),Kt=p.useCallback(async t=>{var n;if(console.log("💾 [QUEUE-SAVE] Iniciando guardado desde cola..."),console.log("🔍 [QUEUE-SAVE] Datos disponibles:",{projectId:o==null?void 0:o.id,pagesCount:t==null?void 0:t.length,currentPage:h,hasDimensions:!!q,hasThumbnails:!!te}),!(o!=null&&o.id))return console.error("❌ [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return console.error("❌ [QUEUE-SAVE] No hay páginas para guardar"),!1;try{const l={design_data:{pages:t,currentPage:h,workspaceDimensions:q,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:te};console.log("📤 [QUEUE-SAVE] Enviando petición al servidor...");const d=await fetch(`/api/canvas/projects/${o.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(l)});if(console.log("📥 [QUEUE-SAVE] Respuesta del servidor:",d.status,d.statusText),d.ok){const b=await d.json();return console.log("✅ [QUEUE-SAVE] Guardado exitoso desde cola:",b),!0}else{const b=await d.text();return console.error("❌ [QUEUE-SAVE] Error en respuesta del servidor:",d.status,b),!1}}catch(a){return console.error("❌ [QUEUE-SAVE] Error guardando desde cola:",a),!1}},[o==null?void 0:o.id,h,q,te]),Et=p.useCallback(async()=>{if(console.log("🔍 [SAVE-QUEUE] Verificando condiciones de procesamiento...",{isProcessingQueue:F,saveQueueLength:S.length}),F){console.log("⚠️ [SAVE-QUEUE] Ya se está procesando, saltando...");return}if(S.length===0){console.log("⚠️ [SAVE-QUEUE] Cola vacía, no hay nada que procesar");return}console.log("🚀 [SAVE-QUEUE] Iniciando procesamiento de cola..."),_(!0);try{const t=S.slice();console.log("� [SAVE-QUEUE] Cola capturada para procesamiento:",t.length,"elementos"),R([]),console.log("🧹 [SAVE-QUEUE] Cola limpiada");for(const n of t)console.log("💾 [SAVE-QUEUE] Guardando página:",n.pageIndex),await Kt(n.pages)?(k(l=>{const d=new Map(l);return d.delete(n.pageIndex),d}),console.log("✅ [SAVE-QUEUE] Página guardada exitosamente:",n.pageIndex)):(console.error("❌ [SAVE-QUEUE] Error guardando página:",n.pageIndex),R(l=>[...l,n]));console.log("✅ [SAVE-QUEUE] Cola de guardado procesada completamente")}catch(t){console.error("❌ [SAVE-QUEUE] Error procesando cola:",t)}finally{_(!1),console.log("🔓 [SAVE-QUEUE] Procesamiento finalizado, isProcessingQueue = false")}},[F,S,Kt]);p.useEffect(()=>{console.log("🔄 [SAVE-QUEUE] useEffect trigger:",{saveQueueLength:S.length,isProcessingQueue:F,shouldProcess:S.length>0&&!F}),S.length>0&&!F&&(console.log("⏰ [SAVE-QUEUE] Cola detectada, procesando inmediatamente..."),setTimeout(()=>{Et()},100))},[S.length,F,Et]),p.useEffect(()=>{console.log("📊 [SAVE-QUEUE] Estado de cola actualizado:",{longitud:S.length,elementos:S.map(t=>`página ${t.pageIndex}`),procesando:F})},[S,F]);const Yt=p.useCallback((t,n)=>{console.log("🔍 [SAVE-QUEUE] Intentando agregar página a cola:",t),k(a=>{const l=Array.from(a.keys());return console.log("🔍 [SAVE-QUEUE] Cambios actuales:",l.join(", ")||"ninguno"),a.has(t)?(console.log("✅ [SAVE-QUEUE] Página tiene cambios, agregando a cola:",t),R(d=>{console.log("🔍 [SAVE-QUEUE] Cola actual antes de agregar:",d.length,"elementos");const b=d.findIndex(f=>f.pageIndex===t);if(b!==-1){const f=[...d];return f[b]={pageIndex:t,pages:n,timestamp:Date.now()},console.log("🔄 [SAVE-QUEUE] Actualizando elemento existente en cola"),f}else{const f=[...d,{pageIndex:t,pages:n,timestamp:Date.now()}];return console.log("➕ [SAVE-QUEUE] Agregando nuevo elemento a cola. Nueva longitud:",f.length),f}}),console.log("📤 [SAVE-QUEUE] Página agregada a cola:",t),a):(console.log("⚠️ [SAVE-QUEUE] No hay cambios para la página:",t,"- No se agregará a cola"),a)})},[]),Nt=p.useCallback(async t=>{if(console.log("🔄 [PAGE-CHANGE] Iniciando cambio de página de",h,"a",t),t===h){console.log("⚠️ [PAGE-CHANGE] Misma página, no se hace nada");return}k(n=>{console.log("🔍 [PAGE-CHANGE] Verificando cambios en página actual:",h);const a=Array.from(n.keys());return console.log("🔍 [PAGE-CHANGE] Páginas con cambios:",a.join(", ")||"ninguna"),n.has(h)?(console.log("💾 [PAGE-CHANGE] ✅ Página actual tiene cambios, guardando antes del cambio:",h),Yt(h,c)):console.log("ℹ️ [PAGE-CHANGE] No hay cambios en la página actual:",h),n}),re(t),console.log("📄 [PAGE-CHANGE] ✅ Página cambiada a:",t)},[h,c,Yt]),Ge=()=>`editor_progress_project_${o==null?void 0:o.id}`,Jt=p.useCallback(async()=>{var n,a,l,d;if(!(o!=null&&o.id))return;if(c.some(b=>{var f;return(f=b.cells)==null?void 0:f.some(u=>{var x;return((x=u.elements)==null?void 0:x.length)>0})})){console.log("⚠️ [RECOVERY] Ya hay contenido en el workspace, saltando recuperación automática");return}try{const b=Ae.loadFromLocalStorage(),f=await fetch(`/api/canvas/projects/${o.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let u=null;if(f.ok){const T=await f.json();T.success&&((n=T.data)!=null&&n.design_data)&&(u=T.data)}let x=null;if(b&&u){const T=new Date(b.savedAt).getTime(),P=new Date(u.saved_at).getTime();x=T>P?b:u}else b?x=b:u&&(x=u);if(x&&(((a=x.pages)==null?void 0:a.length)>0||((d=(l=x.design_data)==null?void 0:l.pages)==null?void 0:d.length)>0)){const T=new Date(x.savedAt||x.saved_at).getTime();Date.now()-T<30*60*1e3?(console.log("🔄 [AUTO-RECOVERY] Cargando automáticamente el progreso más reciente"),oe.info("🔄 Cargando progreso guardado automáticamente..."),Fn(x)):console.log("📅 [RECOVERY] Progreso muy antiguo, ignorando automáticamente")}}catch(b){console.error("❌ [RECOVERY] Error verificando progreso guardado:",b)}},[o==null?void 0:o.id,Ae,c]),Fn=p.useCallback(async t=>{var n;try{let a=[];if(t.pages?a=t.pages:(n=t.design_data)!=null&&n.pages&&(a=t.design_data.pages),a.length>0){ae(a);const l=[JSON.stringify(a)];Ve(l),Me(0),setTimeout(()=>{ue({})},100),oe.success("✅ Progreso cargado exitosamente"),Mn(!1)}}catch(a){console.error("❌ [RECOVERY] Error cargando progreso:",a),oe.error("Error al cargar el progreso guardado")}},[ae,Ve,Me,ue]);p.useCallback(async()=>{try{const t=Ae.getStorageKey();localStorage.removeItem(t),oe.success("Progreso anterior eliminado")}catch(t){console.error("❌ [RECOVERY] Error descartando progreso:",t)}},[Ae]),p.useEffect(()=>{o&&r&&s&&(!(E!=null&&E.pages)||E.pages.length===0)&&Xt(s,r)},[o,r,s,E]),p.useEffect(()=>{o!=null&&o.id&&!C&&c.length===0&&!tt&&(Qe(!0),setTimeout(()=>{Jt()},500))},[o==null?void 0:o.id,C,c.length,Jt,tt]),p.useEffect(()=>(ne.current&&clearTimeout(ne.current),o!=null&&o.id&&c.length>0&&(ne.current=setTimeout(()=>{Gt()},500)),()=>{ne.current&&clearTimeout(ne.current)}),[o==null?void 0:o.id,c.length]);const Xt=(t,n)=>{try{const a=[],l=n.pages||t.pages||20;if(n.has_cover_image===!0||n.has_cover_image===1){const f=n.cover_image?`/storage/images/item/${n.cover_image}`:null,u=n.cover_image?null:t.background_color||"#ffffff",x={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:f,backgroundColor:u,cells:[{id:"cell-cover-1",elements:[]}]};a.push(x)}const d=n.content_image?`/storage/images/item/${n.content_image}`:null,b=n.content_image?null:t.background_color||"#ffffff";for(let f=1;f<=l;f++){const u={id:`page-content-${f}`,type:"content",pageNumber:f,layout:"layout-1",backgroundImage:d,backgroundColor:b,cells:[{id:`cell-content-${f}-1`,elements:[]}]};a.push(u)}if(n.has_back_cover_image===!0||n.has_back_cover_image===1){const f=n.back_cover_image?`/storage/images/item/${n.back_cover_image}`:null,u=n.back_cover_image?null:t.background_color||"#ffffff",x={id:"page-final",type:"final",layout:"layout-1",backgroundImage:f,backgroundColor:u,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};a.push(x)}ae(a),re(0),t.width&&t.height&&He("preset")}catch(a){console.error("❌ Error creating pages:",a),M(a.message)}},ie=p.useMemo(()=>r?{cover:c.filter(t=>t.type==="cover"&&(r.has_cover_image===!0||r.has_cover_image===1)),content:c.filter(t=>t.type==="content"),final:c.filter(t=>t.type==="final"&&(r.has_back_cover_image===!0||r.has_back_cover_image===1))}:{cover:c.filter(t=>t.type==="cover"),content:c.filter(t=>t.type==="content"),final:c.filter(t=>t.type==="final")},[c,r]),le=p.useCallback(()=>{if(!r)return console.warn("⚠️ [CONTENT-TYPE] itemData no disponible, usando tipo por defecto"),{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"};const t=r.has_cover_image===!0||r.has_cover_image===1,n=r.has_back_cover_image===!0||r.has_back_cover_image===1,a=t&&ie.cover.length>0,l=n&&ie.final.length>0,d=ie.content.length;return console.log("🎯 [CONTENT-TYPE] Análisis de contenido:",{coverEnabled:t,backCoverEnabled:n,coverPagesExist:ie.cover.length>0,finalPagesExist:ie.final.length>0,hasCover:a,hasBackCover:l,contentPages:d,itemConfig:{has_cover_image:r.has_cover_image,has_back_cover_image:r.has_back_cover_image}}),a&&l?{type:"album",name:"Álbum",description:"Vista de Álbum",icon:"📖",experience:"book"}:a||l?{type:"booklet",name:"Folleto",description:"Vista de Folleto",icon:"📋",experience:"booklet"}:d>1?{type:"catalog",name:"Catálogo",description:"Vista de Catálogo",icon:"📑",experience:"catalog"}:{type:"card",name:"Diseño",description:"Vista Previa",icon:"🎨",experience:"single"}},[ie,r])(),ee=p.useCallback(()=>{if(!z||!V||c.length===0)return null;const t=c[h];if(!t)return null;const n=t.cells.find(a=>a.id===V);return n?n.elements.find(a=>a.id===z):null},[z,V,c,h]),Zt=(t,n)=>{if(n){const a=c[h].cells.find(d=>d.id===n),l=a==null?void 0:a.elements.find(d=>d.id===t);if(l!=null&&l.locked){const d=document.createElement("div");d.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",d.textContent="Este elemento es parte del diseño base y no se puede editar",document.body.appendChild(d),setTimeout(()=>{document.body.contains(d)&&document.body.removeChild(d)},3e3);return}}if(n&&he(n),Z(t),t){const a=c[h].cells.find(d=>d.id===(n||V)),l=a==null?void 0:a.elements.find(d=>d.id===t);(l==null?void 0:l.type)==="image"?(Mt(l),console.log("🖼️ Imagen seleccionada:",l.id,"- Tab actual mantenido:",Q),Q==="filters"?console.log("✅ Usuario ya está en filtros, manteniendo"):console.log("✅ Imagen seleccionada, pero manteniendo tab actual:",Q)):(l==null?void 0:l.type)==="text"?(vt(!0),On({elementId:t,cellId:n||V}),Q!=="filters"&&Q!=="images"&&xe("text")):vt(!1)}else vt(!1),Mt(null)},Re=()=>{if(c.length===0)return ge[0];const t=c[h];return t?ge.find(n=>n.id===t.layout)||ge[0]:ge[0]},eo=p.useCallback(ct(t=>{try{const n=Ge(),a={pages:t,currentPage:h,savedAt:Date.now()},l=JSON.stringify(a),d=Math.round(l.length/1024);d<2048?localStorage.setItem(n,l):(console.warn(`⚠️ Datos demasiado grandes para localStorage (${d} KB)`),localStorage.removeItem(n))}catch(n){if(console.error("❌ Error guardando en localStorage:",n),n.name==="QuotaExceededError")try{localStorage.removeItem(Ge())}catch(a){console.error("Error limpiando localStorage:",a)}}},300),[h,Ge]),Ke=p.useCallback(t=>{ae(n=>{if(n===t)return n;const a=JSON.stringify(n),l=JSON.stringify(t);return a===l?(console.log("🔄 [UPDATE-PAGES] Sin cambios, evitando actualización"),n):(console.log("📝 [UPDATE-PAGES] Aplicando cambios..."),requestAnimationFrame(()=>{if(k(d=>{const b=new Map(d);return b.set(h,Date.now()),b}),t[h]){const d=t[h].id;ue(b=>{if(b[d]){const f={...b};return delete f[d],f}return b})}}),setTimeout(()=>{Ve(d=>{const b=[...d.slice(0,we+1),l];return b.length>50?b.slice(-50):b}),Me(d=>{const b=d+1;return b>50?49:b})},0),t)}),eo(t)},[h,we,eo]);p.useEffect(()=>{try{const t=Ge(),n={pages:c,currentPage:h,savedAt:Date.now()},a=JSON.stringify(n),l=Math.round(a.length/1024);l<2048?localStorage.setItem(t,a):console.warn(`⚠️ Datos demasiado grandes para localStorage (${l} KB), saltando guardado`)}catch(t){if(console.error("❌ Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const n=Ge();localStorage.removeItem(n)}catch(n){console.error("Error limpiando localStorage:",n)}}},[h,c,Ge]);const Hn=t=>{const n=ge.find(b=>b.id===t);if(!n)return;const a=[...c],l=a[h],d=Array.from({length:n.cells}).map((b,f)=>l.cells[f]||{id:`cell-${l.id}-${f+1}`,elements:[]});a[h]={...l,layout:t,cells:d},Ke(a),Z(null),he(null)},Ye=(t,n)=>{const a=[...c];for(let l=0;l<a[h].cells.length;l++)a[h].cells[l].id===t&&a[h].cells[l].elements.push(n);Ke(a),Z(n.id),he(t)},to=p.useCallback(ct(()=>{k(t=>{const n=new Map(t);return n.set(h,Date.now()),n})},100),[h]),ce=p.useCallback((t,n,a,l=!1)=>{console.log("🔄 [updateElementInCell] Actualizando elemento:",{cellId:t,elementId:n,updates:a,isDuplicate:l}),console.log("🔍 [updateElementInCell] Verificando si hay cambios en filtros/máscaras:",{hasFilters:!!a.filters,hasMask:!!a.mask,filtersData:a.filters,maskData:a.mask}),ae(d=>{const b=[...d],f=b[h].cells.findIndex(u=>u.id===t);if(f===-1)return d;if(l){const u=b[h].cells[f].elements.find(x=>x.id===n);if(!u)return d;b[h].cells[f].elements.push({...u,...a})}else{const u=b[h].cells[f].elements.findIndex(O=>O.id===n);if(u===-1)return d;const x=b[h].cells[f].elements[u];if(!Object.keys(a).some(O=>{const W=x[O],A=a[O];return typeof A=="object"&&typeof W=="object"?JSON.stringify(W)!==JSON.stringify(A):W!==A}))return console.log("🚫 [updateElementInCell] No hay cambios reales, saltando actualización"),d;const P={...x,...a};console.log("✅ [updateElementInCell] Elemento actualizado:",P),b[h].cells[f].elements[u]=P,a.filters||a.mask?(console.log("🔄 [AUTO-REGEN] Cambios en filtros/máscaras detectados, regenerando thumbnail..."),console.log("🔄 [AUTO-REGEN] Datos de cambios:",{filters:a.filters,mask:a.mask}),window.FORCE_THUMBNAIL_REGENERATION&&(console.log("💥 [FORZADO-EMERGENCIA] Limpiando caché de thumbnails completamente"),window.thumbnailCache={}),me(!0).then(()=>{console.log("✅ [AUTO-REGEN] Thumbnail regenerado exitosamente"),window.FORCE_THUMBNAIL_REGENERATION&&window.forceRegenerateThumbnail&&setTimeout(()=>{console.log("🔄 [FORZADO-EMERGENCIA] Ejecutando regeneración forzada secundaria");try{window.forceRegenerateThumbnail()}catch(O){console.error("❌ [FORZADO-EMERGENCIA] Error en regeneración secundaria:",O)}},150)}).catch(O=>{console.error("❌ [AUTO-REGEN] Error regenerando thumbnail:",O)})):console.log("🚫 [AUTO-REGEN] No hay cambios en filtros/máscaras, saltando regeneración")}return b}),a.position||a.size?requestAnimationFrame(()=>{k(d=>{if(d.has(h))return d;const b=new Map(d);return b.set(h,Date.now()),b})}):to()},[h,to]),oo=p.useCallback(()=>{var n;console.log("🚨 [FORCE-REGEN] Iniciando regeneración forzada..."),window.thumbnailCache&&(window.thumbnailCache={}),window.THUMBNAIL_PROTECTED=!0,window._protectedThumbnailIds||(window._protectedThumbnailIds=[]);const t=(n=c[h])==null?void 0:n.id;t&&!window._protectedThumbnailIds.includes(t)&&window._protectedThumbnailIds.push(t),window.BLOCK_AUTO_REGENERATION=!0,me(!0),setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,console.log("🔓 Regeneración automática desbloqueada después de protección")},1e4)},[me]),no=p.useCallback(()=>{z&&V?(console.log("🧪 [TEST] Aplicando filtro grayscale de prueba..."),ce(V,z,{filters:{brightness:100,contrast:100,saturation:0,opacity:100}})):console.log("⚠️ [TEST] No hay elemento seleccionado")},[z,V,ce]),ao=p.useCallback(()=>{console.log("🔒 [BLOQUEO-SELECTIVO] Activando protección para thumbnails con filtros"),window.THUMBNAIL_PROTECTED=!0,window.PERMANENT_THUMBNAIL_LOCK=!0,window.BLOCK_AUTO_REGENERATION=!1,window._protectedThumbnailIds=Object.keys(te);const t=window.forceRegenerateThumbnail;window.forceRegenerateThumbnail=(...n)=>window._userInitiated?(console.log("✅ [REGENERACIÓN AUTORIZADA] Permitiendo regeneración solicitada por usuario"),window._userInitiated=!1,t(...n)):(console.log("🛑 [REGENERACIÓN BLOQUEADA] Intento de regeneración no autorizado bloqueado"),!1),window._allowNextRegeneration=()=>{window._userInitiated=!0},window.safeRegenerateThumbnail=()=>{window._allowNextRegeneration(),window.forceRegenerateThumbnail()},window._thumbnailBackup={...te},alert(`🔒 Miniaturas protegidas exitosamente!

Si necesitas regenerar una miniatura específica, usa window.safeRegenerateThumbnail() en la consola.`),console.log("🔒 [BLOQUEO-PERMANENTE] Thumbnails protegidos:",window._protectedThumbnailIds),console.log("🔒 [BLOQUEO-PERMANENTE] No se permitirán más regeneraciones automáticas"),console.log("📢 [INSTRUCCIONES] Para regenerar manualmente una miniatura, ejecuta window.safeRegenerateThumbnail() en la consola")},[te]);p.useEffect(()=>(window.forceRegenerateThumbnail=oo,window.testFilterApplication=no,window.lockThumbnailsForever=ao,console.log("📢 [AYUDA] Funciones disponibles:"),console.log("- window.forceRegenerateThumbnail(): Regenera la miniatura actual con filtros"),console.log("- window.forceRegenerateAllThumbnails(): Regenera todas las miniaturas"),console.log("- window.lockThumbnailsForever(): Bloquea permanentemente las regeneraciones automáticas"),()=>{delete window.forceRegenerateThumbnail,delete window.testFilterApplication,delete window.lockThumbnailsForever}),[oo,no,ao]);const ot=(t,n)=>{const a=[...c],l=a[h].cells.findIndex(d=>d.id===t);l!==-1&&(a[h].cells[l].elements=a[h].cells[l].elements.filter(d=>d.id!==n),Ke(a),z===n&&Z(null))},Gn=(t,n,a)=>{const l=[...c],d=l[h].cells.findIndex(b=>b.id===t);if(d!==-1){const b=l[h].cells[d].elements,f=b.findIndex(u=>u.id===n);if(f!==-1){const u=a==="up"?f+1:f-1;if(u>=0&&u<b.length){const x=b[f];b[f]=b[u],b[u]=x,Ke(l)}}}},Vn=()=>{we>0&&(Me(we-1),ae(JSON.parse(je[we-1])),Z(null),he(null))},Wn=()=>{we<je.length-1&&(Me(we+1),ae(JSON.parse(je[we+1])),Z(null),he(null))},Ct=(t="body")=>{const n=`text-${Date.now()}`,a={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},l={heading:"Título Principal",subheading:"Subtítulo",body:"Haz clic para editar"},d={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},b={id:n,type:"text",content:l[t],position:{x:.05,y:.05},size:d[t],style:a[t]};V?Ye(V,b):console.log("Selecciona una celda primero")},ro=p.useMemo(()=>{var d;const t=c[h];if(!t)return null;const n=((d=t.cells)==null?void 0:d.flatMap(b=>b.elements||[]))||[],a=n.map(b=>({id:b.id,type:b.type,position:b.position,size:b.size}));return{pageId:t.id,elementsCount:n.length,contentHash:JSON.stringify(a).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[c,h]);p.useEffect(()=>{const t=c[h],n=t==null?void 0:t.id;if((n&&window._protectedThumbnailIds&&window._protectedThumbnailIds.includes(n)||window.THUMBNAIL_PROTECTED)&&te[n]){console.log("🛡️ [PROTECCIÓN SELECTIVA] Saltando regeneración para miniatura con filtros");return}if(c.length===0||C||!ro)return;let l=!1;const d=async()=>{if(window.PREVENT_THUMBNAIL_RESET||window.THUMBNAIL_PROTECTED){console.log("🛡️ [PROTECCIÓN ACTIVA] Regeneración cancelada");return}try{const f=c[h];if(!f||!f.id)return;const u=f.id;if(!window.PREVENT_THUMBNAIL_RESET&&!window.THUMBNAIL_PROTECTED&&ue(T=>{const P={...T};return delete P[u],P}),await new Promise(T=>setTimeout(T,100)),l)return;const x=await Ie();x&&!l?ue(T=>({...T,[u]:x})):console.warn("⚠️ [DEBUG] No se pudo generar miniatura para:",u)}catch(f){l||console.error("❌ [DEBUG] Error regenerando miniatura:",f)}},b=setTimeout(()=>{d()},500);return()=>{l=!0,clearTimeout(b)}},[h,ro,C,Ie]),p.useEffect(()=>{if(window.BLOCK_AUTO_REGENERATION){console.log("🛡️ [PROTECCIÓN PARCIAL] Bloqueando generación temporal en segundo plano");return}if(c.length===0||C)return;const t=async()=>{if(window.BLOCK_AUTO_REGENERATION){console.log("🛡️ [PROTECCIÓN TEMPORAL] Generación en segundo plano pausada");return}const a=c.filter(l=>!te[l.id]);if(a.length!==0)for(const l of a)try{const d=document.createElement("canvas");d.width=200,d.height=150;const b=d.getContext("2d");if(b.fillStyle=l.backgroundColor||"#ffffff",b.fillRect(0,0,200,150),l.backgroundImage)try{const u=new Image;u.crossOrigin="anonymous",await new Promise((x,T)=>{u.onload=x,u.onerror=T,u.src=l.backgroundImage}),b.drawImage(u,0,0,200,150)}catch(u){console.warn("No se pudo cargar imagen de fondo para miniatura:",u)}l.cells&&l.cells.forEach(u=>{u.elements&&u.elements.forEach(x=>{var T;x.type==="text"&&x.content&&(b.fillStyle=((T=x.style)==null?void 0:T.color)||"#000000",b.font="12px Arial",b.fillText(x.content.substring(0,20)+(x.content.length>20?"...":""),10,30))})});const f=d.toDataURL("image/jpeg",.7);ue(u=>({...u,[l.id]:f})),await new Promise(u=>setTimeout(u,300))}catch(d){console.error("❌ Error generando miniatura de fondo para:",l.id,d)}},n=setTimeout(()=>{t()},2e3);return()=>clearTimeout(n)},[c,te,C]),p.useEffect(()=>{const t=n=>{const a=U.current,l=K.current;if(a.length>0||l.size>0)return n.preventDefault(),n.returnValue="Hay cambios sin guardar. ¿Estás seguro de que quieres salir?",n.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),p.useEffect(()=>()=>{console.log("🧹 [CLEANUP] Componente desmontado")},[]);const qn=async()=>{var t;try{if(console.log("🚀 ===== INICIANDO addAlbumToCart ====="),console.log("📦 itemData:",r),console.log("🎨 presetData:",s),console.log("📋 projectData:",o),console.log("🆔 projectData?.id:",o==null?void 0:o.id),console.log("====================================="),!r||!s||!(o!=null&&o.id))return!1;await De(c,!0)||console.warn("⚠️ No se pudo guardar el progreso, pero continuando...");const a={design_data:{id:o.id,title:(r==null?void 0:r.name)||"Álbum Personalizado",pages:c,workspace_dimensions:q,created_at:new Date().toISOString()},item_data:{id:r==null?void 0:r.id,name:(r==null?void 0:r.name)||(r==null?void 0:r.title),price:r==null?void 0:r.price,user_id:r==null?void 0:r.user_id,width:r==null?void 0:r.width,height:r==null?void 0:r.height},preset_data:{id:s==null?void 0:s.id,width:s==null?void 0:s.width,height:s==null?void 0:s.height,cover_image:s==null?void 0:s.cover_image,content_layer_image:s==null?void 0:s.content_layer_image,final_layer_image:s==null?void 0:s.final_layer_image},dimensions:{width_mm:(s==null?void 0:s.width)||(r==null?void 0:r.width)||210,height_mm:(s==null?void 0:s.height)||(r==null?void 0:r.height)||297,workspace_width:(q==null?void 0:q.width)||800,workspace_height:(q==null?void 0:q.height)||600}};try{const P=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:o.id,status:"ready_for_pdf",pdf_data:a,completed_at:new Date().toISOString()})});if(P.ok){const O=await P.json()}else console.warn("⚠️ Error marcando proyecto como completado")}catch(P){console.warn("⚠️ Error en marcado de completado:",P)}const l=Date.now(),d=o.id;window.currentProjectId=d,window.albumProjectId=d;let b=s.cover_image;te&&te["page-cover"]&&(b=te["page-cover"]);let f=b;b&&b.startsWith("data:image/")&&b.length>1e5&&(f=s.cover_image||"/assets/img/default-album.jpg");const u={...r,project_id:d,canvas_project_id:o.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:s.width,height_mm:s.height,pages_count:c.length,workspace_dimensions:q,requires_pdf_generation:!0}};console.log("📦 PRODUCTO ÁLBUM CREADO:",u),console.log("🎯 PROJECT IDS:",{project_id:d,canvas_project_id:o.id,item_id:r==null?void 0:r.id});const x=structuredClone(se),T=x.findIndex(P=>P.id==u.id);return T==-1?x.push({...u,quantity:1}):x[T].quantity++,ve(x),oe.success("Álbum agregado al carrito",{description:`${u.name} se ha añadido al carrito. El PDF se generará en el backend.`,icon:e.jsx(ma,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:x,action:"add",product:u}})),!0}catch(n){return console.error("❌ === ERROR EN addAlbumToCart ==="),console.error("Error completo:",n),console.error("Stack trace:",n.stack),console.error("Mensaje del error:",n.message),oe.error("Error al agregar al carrito",{description:`Error específico: ${n.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!c||c.length===0)throw new Error("No hay páginas para finalizar");const a={design_data:{pages:(O=>O.map(W=>({id:W.id,type:W.type,pageNumber:W.pageNumber,layout:W.layout,cells:W.cells.map(A=>({id:A.id,elements:A.elements.map(L=>{const $={id:L.id,type:L.type,position:L.position,zIndex:L.zIndex||1};if(L.type==="image"){if(L.content.startsWith("data:image/")){const D=btoa(L.content.substring(0,100)).substring(0,20);$.content=`[BASE64_IMAGE_${D}]`,$.contentType=L.content.split(";")[0].split(":")[1],$.originalSize=L.content.length}else $.content=L.content;if(L.filters){const D=Object.entries(L.filters).filter(([X,Y])=>Y!==0&&Y!==!1&&Y!==null).reduce((X,[Y,J])=>(X[Y]=J,X),{});Object.keys(D).length>0&&($.filters=D)}L.mask&&L.mask!=="none"&&($.mask=L.mask),L.size&&($.size=L.size),L.locked&&($.locked=L.locked)}else if(L.type==="text"&&($.content=L.content,L.style)){const D=Object.entries(L.style).filter(([X,Y])=>!(X==="fontSize"&&Y==="16px"||X==="color"&&Y==="#000000"||X==="fontFamily"&&Y==="Arial")).reduce((X,[Y,J])=>(X[Y]=J,X),{});Object.keys(D).length>0&&($.style=D)}return $})}))})))(c),projectInfo:{id:o==null?void 0:o.id,item_id:r==null?void 0:r.id,title:r==null?void 0:r.title,preset_id:s==null?void 0:s.id},presetInfo:{id:s==null?void 0:s.id,name:s==null?void 0:s.name,cover_image:s==null?void 0:s.cover_image,content_image:s==null?void 0:s.content_image,back_cover_image:s==null?void 0:s.back_cover_image},workspace:{width:q.width,height:q.height,scale:q.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(te).map(([O,W])=>[O,W]))},l=JSON.stringify(a),d=Math.round(l.length/1024),b=Math.round(d/1024*100)/100;let f=0,u=0;c.forEach(O=>{var W;(W=O.cells)==null||W.forEach(A=>{var L;(L=A.elements)==null||L.forEach($=>{$.type==="image"&&$.content&&$.content.startsWith("data:image/")&&(f++,u+=$.content.length)})})});const x=Math.round(u/(1024*1024)*100)/100;if(d>1024&&!confirm(`El diseño contiene ${f} imágenes (${x} MB en imágenes). Payload completo: ${b} MB. Esto podría causar problemas al guardarlo. ¿Desea continuar de todos modos?`))return!1;const T=await fetch(`/api/canvas/projects/${o.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:l});if(!T.ok){let O="Error al finalizar el diseño";try{O=(await T.json()).message||O}catch{T.status===413?O="El diseño es demasiado grande para ser guardado. Intente simplificar las imágenes.":T.status>=500&&(O="Error del servidor. Intente nuevamente más tarde.")}throw new Error(O)}const P=await T.json();return!0}catch(t){console.error("Error al finalizar diseño:",t);let n=t.message;return t.message.includes("Failed to fetch")?n="Error de conexión. Verifique su conexión a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(n="Error de red. Intente nuevamente más tarde."),alert("Error al finalizar el diseño: "+n),!1}};const Qn=p.useCallback(async()=>{try{const{jsPDF:t}=await Kn(async()=>{const{jsPDF:D}=await import("./jspdf.es.min-D3plwuQr.js").then(X=>X.j);return{jsPDF:D}},__vite__mapDeps([0,1,2,3,4]));let n=(s==null?void 0:s.width)||21,a=(s==null?void 0:s.height)||29.7;const l=.3,d=n+l*2,b=a+l*2,f=d*28.35,u=b*28.35,x=new t({orientation:f>u?"landscape":"portrait",unit:"pt",format:[f,u],compress:!1}),T=c.length;let P=0;const O=document.createElement("div");O.id="pdf-progress",O.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",O.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${T} páginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(O);const W=D=>{const X=D/T*100;document.getElementById("pdf-progress-bar").style.width=`${X}%`,document.getElementById("current-page").textContent=D},A=h;for(let D=0;D<c.length;D++){const X=c[D];re(D),await new Promise(Y=>setTimeout(Y,500));try{const Y=await Ie({type:"pdf"});if(Y){const J=Y.width/Y.height,_e=f/u;let fe,be,Se=0,$e=0;J>_e?(fe=f,be=f/J,$e=(u-be)/2):(be=u,fe=u*J,Se=(f-fe)/2);const Ue=Y.toDataURL("image/png",1);D>0&&x.addPage([f,u]),x.addImage(Ue,"PNG",Se,$e,fe,be)}else console.warn(`⚠️ No se pudo capturar la página ${D+1}`),D>0&&x.addPage([f,u]),x.setFontSize(12),x.text(`Error al renderizar página ${D+1}`,f/2,u/2,{align:"center"})}catch(Y){console.error(`❌ Error procesando página ${D+1}:`,Y),D>0&&x.addPage([f,u]),x.setFontSize(12),x.text(`Error al procesar página ${D+1}`,f/2,u/2,{align:"center"})}P++,W(P),await new Promise(Y=>setTimeout(Y,200))}re(A);const L=`${(r==null?void 0:r.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;x.save(L),document.body.removeChild(O);const $=document.createElement("div");return $.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",$.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${L}</span>
                </div>
            `,document.body.appendChild($),setTimeout(()=>{document.body.contains($)&&document.body.removeChild($)},5e3),L}catch(t){console.error("❌ Error generando PDF:",t);const n=document.getElementById("pdf-progress");n&&document.body.removeChild(n);const a=document.createElement("div");throw a.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",a.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(a),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},7e3),t}},[c,h,re,Ie,s,r]);return window.generateAlbumPDF=Qn,window.generateHighQualityThumbnail=Pn,window.captureCurrentWorkspace=Ie,e.jsxs(Yn,{backend:Jn,className:"!h-screen !w-screen overflow-hidden",children:[C?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu álbum personalizado..."})]})}):I?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:I}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):c.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando páginas del álbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx("style",{children:`
                        /* Solo aplicar overflow visible en modo edición (no en preview ni captura) */
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] {
                            overflow: visible !important;
                        }
                        
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] > div {
                            overflow: visible !important;
                        }
                        
                        /* Mantener overflow hidden solo para el contenedor principal para evitar scroll */
                        .editor-workspace:not(.preview-mode) #page-${(lo=c[h])==null?void 0:lo.id} {
                            overflow: visible !important;
                        }
                        
                        /* En preview mode y captura, mantener overflow hidden para el resultado final */
                        .preview-mode [data-element-type="image"],
                        .capture-mode [data-element-type="image"] {
                            overflow: hidden !important;
                        }
                    `}),e.jsx(sa,{isOpen:Rn,onRequestClose:()=>{Wt(!1),$n({isLoading:!1,loadedImages:0,totalImages:0,message:""}),Ne({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:(()=>{if(!r)return console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible, enviando todas las páginas"),ie.cover.concat(ie.content,ie.final).map(n=>({...n,layout:ge.find(a=>a.id===n.layout)||ge[0]}));let t=[];return(r.has_cover_image===!0||r.has_cover_image===1)&&(t=t.concat(ie.cover)),t=t.concat(ie.content),(r.has_back_cover_image===!0||r.has_back_cover_image===1)&&(t=t.concat(ie.final)),console.log("📤 [EDITOR-TO-MODAL] Enviando páginas filtradas:",{total:t.length,types:t.map(n=>n.type),itemConfig:{has_cover_image:r.has_cover_image,has_back_cover_image:r.has_back_cover_image}}),t.map(n=>({...n,layout:ge.find(a=>a.id===n.layout)||ge[0]}))})(),pageThumbnails:(()=>{if(!r)return console.warn("⚠️ [EDITOR-TO-MODAL] itemData no disponible para filtrar thumbnails"),te;const t={};let n=[];return(r.has_cover_image===!0||r.has_cover_image===1)&&(n=n.concat(ie.cover.map(a=>a.id))),n=n.concat(ie.content.map(a=>a.id)),(r.has_back_cover_image===!0||r.has_back_cover_image===1)&&(n=n.concat(ie.final.map(a=>a.id))),n.forEach(a=>{te[a]&&(t[a]=te[a])}),console.log("🖼️ [EDITOR-TO-MODAL] Enviando thumbnails filtrados:",{totalThumbnails:Object.keys(t).length,availableThumbnails:Object.keys(te).length,enabledPageIds:n,filteredThumbnailIds:Object.keys(t)}),t})(),workspaceDimensions:q,getCurrentLayout:t=>t?ge.find(n=>n.id===t.layout)||ge[0]:ge[0],presetData:s,addAlbumToCart:qn,projectData:o,itemData:r,contentType:le,categorizedPages:ie,albumLoadingState:Ln}),Oe.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-Oe.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:Oe.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:Oe.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${Oe.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[Oe.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(ua,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Vn,disabled:we<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(Xn,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:Wn,disabled:we>=je.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(Zn,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(o==null?void 0:o.name)||"Álbum Sin Título",onChange:t=>i({...o,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del diseño"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(S.length>0||F)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",S.length]})]})}),e.jsx(tr,{saveStatus:Ae.saveStatus,lastSaved:Ae.lastSaved,lastAutoSaved:Ae.lastAutoSaved,hasUnsavedChanges:y.hasUnsavedChanges||!!(N instanceof Map&&N.has(h)),isOnline:Ae.isOnline,saveError:Ae.saveError,onManualSave:Bn,saveQueueSize:S.length,isProcessingQueue:F,pageChangesCount:N instanceof Map?N.size:0}),S.length>0&&e.jsxs("button",{onClick:()=>{console.log("🔧 [DEBUG] Procesando cola manualmente"),Et()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(pn,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(st,{id:"preview-button",variant:"secondary",size:"sm",onClick:async t=>{t.preventDefault(),t.stopPropagation();try{console.log(`🎭 [${le.type.toUpperCase()}-EXPERIENCE] Iniciando experiencia de ${le.name.toLowerCase()}...`),Ne({isOpen:!0,phase:"preparing",progress:0,message:`${le.icon} Creando tu ${le.name.toLowerCase()}`,subMessage:le.type==="album"?"Preparando la experiencia completa de tu álbum...":le.type==="catalog"?"Organizando tu catálogo de contenido...":le.type==="booklet"?"Preparando tu folleto personalizado...":"Optimizando tu diseño único..."});const n=le.type==="album"?["🔧 Encuadernando páginas","📖 Ajustando tapas","✨ Puliendo detalles"]:le.type==="catalog"?["📑 Organizando contenido","🎨 Optimizando diseño","⚡ Finalizando catálogo"]:le.type==="booklet"?["📋 Preparando folleto","🖼️ Ajustando formato","✨ Aplicando estilo"]:["🎨 Procesando diseño","⚡ Optimizando calidad","✨ Finalizando vista"];for(let u=0;u<=30;u+=5){await new Promise(T=>setTimeout(T,le.type==="card"?50:100));const x=Math.floor(u/30*n.length);Ne(T=>({...T,progress:u,message:n[Math.min(x,n.length-1)],subMessage:`Progreso: ${u}% - Optimizando para mejor experiencia...`}))}Ne(u=>({...u,phase:"processing",message:`📷 Procesando ${le.name.toLowerCase()}`,subMessage:"Generando vistas de alta calidad..."}));const a=await In((u,x)=>{const T=30+u/x*50;Ne(P=>({...P,progress:Math.round(T),subMessage:`Procesando imagen ${u} de ${x}...`}))}),d={album:{message:"📖 Encuadernando álbum",sub:"Creando experiencia premium de lectura..."},catalog:{message:"📑 Organizando catálogo",sub:"Preparando navegación fluida..."},booklet:{message:"📋 Finalizando folleto",sub:"Ajustando formato profesional..."},card:{message:"🎨 Puliendo diseño",sub:"Aplicando toques finales..."}}[le.type];Ne(u=>({...u,phase:"finalizing",message:d.message,subMessage:d.sub}));for(let u=80;u<=100;u+=4)await new Promise(x=>setTimeout(x,le.type==="card"?40:80)),Ne(x=>({...x,progress:u}));const f={album:{message:"📖 ¡Tu álbum está listo!",sub:"Experiencia completa de lectura preparada"},catalog:{message:"📑 ¡Tu catálogo está listo!",sub:"Navegación profesional activada"},booklet:{message:"📋 ¡Tu folleto está listo!",sub:"Formato profesional completado"},card:{message:"🎨 ¡Tu diseño está listo!",sub:"Vista previa perfecta creada"}}[le.type];Ne(u=>({...u,phase:"ready",progress:100,message:f.message,subMessage:f.sub})),await new Promise(u=>setTimeout(u,1e3)),Ne(u=>({...u,isOpen:!1})),ue(u=>({...u,...a})),setTimeout(()=>{Wt(!0),console.log(`✅ [${le.type.toUpperCase()}-EXPERIENCE] Experiencia de ${le.name.toLowerCase()} completada`)},300)}catch(n){console.error(`❌ [${le.type.toUpperCase()}-EXPERIENCE] Error en experiencia:`,n),Ne(a=>({...a,message:"⚠️ Ups, algo salió mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{Ne(a=>({...a,isOpen:!1}))},2e3)}},disabled:Oe.isOpen,icon:e.jsx(dt,{className:"h-4 w-4"}),children:Oe.isOpen?`Creando ${le.name.toLowerCase()}...`:le.description}),e.jsxs("button",{onClick:An,className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200",title:"Inicia la guía paso a paso",children:[e.jsx(ba,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"})]})]})]})}),e.jsxs("div",{className:`flex h-full ${z?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>xe("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(dt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Páginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>xe("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(At,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Diseños"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>xe("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(gt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>xe("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(un,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]}),e.jsxs("button",{"data-tab":"filters",onClick:()=>xe("filters"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="filters"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(en,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Filtros"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[Q==="templates"&&"Templates",Q==="images"&&"Images",Q==="text"&&"Text",Q==="shapes"&&"Shapes",Q==="stickers"&&"Stickers",Q==="pages"&&"Pages",Q==="panel"&&"Layers Panel",Q==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Q==="templates"&&"Choose a template to get started",Q==="images"&&"Search for images",Q==="text"&&"Add and edit text",Q==="shapes"&&"Add shapes and graphics",Q==="stickers"&&"Add fun stickers",Q==="pages"&&"Manage your pages",Q==="panel"&&"Organize layers and z-index",Q==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(va,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[Q==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(At,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(ja,{currentLayoutId:(co=c[h])==null?void 0:co.layout,onLayoutChange:Hn})]}),Q==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ze,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Imágenes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[Te.length," imagen",Te.length!==1?"s":""]})]}),e.jsx(nr,{images:Te,onImageSelect:zn,isLoading:ft})]}),Q==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>Ct("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"Título Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(ut,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Ct("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subtítulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(ut,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Ct("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(ut,{className:"h-4 w-4"})})]})})]}),Q==="text"&&z&&((uo=ee())==null?void 0:uo.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(wa,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=ee();ce(V,z,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((mo=(go=ee())==null?void 0:go.style)==null?void 0:mo.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=ee();ce(V,z,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((ho=(po=ee())==null?void 0:po.style)==null?void 0:ho.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=ee();ce(V,z,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((bo=(fo=ee())==null?void 0:fo.style)==null?void 0:bo.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipografía:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((vo=(xo=ee())==null?void 0:xo.style)==null?void 0:vo.fontFamily)||"Arial",onChange:t=>{const n=ee();ce(V,z,{style:{...n.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tamaño:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((wo=(yo=ee())==null?void 0:yo.style)==null?void 0:wo.fontSize)||"16px",onChange:t=>{const n=ee();ce(V,z,{style:{...n.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((No=(Eo=ee())==null?void 0:Eo.style)==null?void 0:No.color)||"#000000",onChange:t=>{const n=ee();ce(V,z,{style:{...n.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((jo=(Co=ee())==null?void 0:Co.style)==null?void 0:jo.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((To=(So=ee())==null?void 0:So.style)==null?void 0:To.backgroundColor)||"#ffffff",onChange:t=>{const n=ee();ce(V,z,{style:{...n.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=ee();ce(V,z,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"🚫"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var n,a;return e.jsxs("button",{onClick:()=>{const l=ee();ce(V,z,{style:{...l.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((a=(n=ee())==null?void 0:n.style)==null?void 0:a.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"⬅",t==="center"&&"⬌",t==="right"&&"➡",t==="justify"&&"⬍"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Ao=(ko=ee())==null?void 0:ko.style)==null?void 0:Ao.lineHeight)||"1.5",onChange:t=>{const n=ee();ce(V,z,{style:{...n.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((_o=(Io=ee())==null?void 0:Io.style)==null?void 0:_o.letterSpacing)||"normal",onChange:t=>{const n=ee();ce(V,z,{style:{...n.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=ee();ce(V,z,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Oo=(Po=ee())==null?void 0:Po.style)==null?void 0:Oo.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAYÚS"]}),e.jsxs("button",{onClick:()=>{const t=ee();ce(V,z,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Mo=(Ro=ee())==null?void 0:Ro.style)==null?void 0:Mo.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"minús"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round(((($o=(Lo=ee())==null?void 0:Lo.style)==null?void 0:$o.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((zo=(Uo=ee())==null?void 0:Uo.style)==null?void 0:zo.opacity)||"1",onChange:t=>{const n=ee();ce(V,z,{style:{...n.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((Fo=(Bo=ee())==null?void 0:Bo.style)==null?void 0:Fo.opacity)||1)*100}%, #e5e7eb ${(((Go=(Ho=ee())==null?void 0:Ho.style)==null?void 0:Go.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),Q==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(dt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[c.length," total"]})]})}),qe&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[qe.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${qe.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:qe.message||`Página: ${qe.pageId||"actual"}`})]}),c.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando páginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[ie.cover.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),ie.cover.map((t,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${h===c.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Nt(c.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(_t,{pageId:t.id,thumbnail:te[t.id],altText:"Cover",type:"cover"}),N instanceof Map&&N.has&&N.has(c.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:ie.content.map((t,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${h===c.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>Nt(c.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(_t,{pageId:t.id,thumbnail:te[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),N instanceof Map&&N.has&&N.has(c.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),ie.final.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),ie.final.map((t,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${h===c.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Nt(c.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(_t,{pageId:t.id,thumbnail:te[t.id],altText:"Back Cover",type:"final"}),N instanceof Map&&N.has&&N.has(c.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"•"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),Q==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Ca,{pages:c,currentPage:h,selectedCell:V,selectedElement:z,onSelectCell:he,onSelectElement:Z,onUpdateElement:(t,n,a)=>{ce(t,n,a)},onDeleteElement:(t,n)=>{ot(t,n)},onMoveElement:(t,n,a)=>{Gn(t,n,a)}})}),Q==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(en,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=ee();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ze,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Sa,{selectedMask:t.mask||"none",onSelect:n=>{ce(V,z,{mask:n})},availableMasks:gn.map(n=>n.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(ea,{filters:t.filters||{},onFilterChange:n=>{console.log("🔥 [FILTER-CHANGE-IMMEDIATE] APLICANDO FILTROS Y REGENERANDO AHORA!"),ce(V,z,{filters:n}),setTimeout(()=>{console.log("🔥 [IMMEDIATE-REGEN] Intento 1 de regeneración..."),me(!0)},50),setTimeout(()=>{console.log("🔥 [IMMEDIATE-REGEN] Intento 2 de regeneración..."),me(!0)},200),setTimeout(()=>{console.log("🔥 [IMMEDIATE-REGEN] Intento 3 de regeneración..."),me(!0)},500)},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(ze,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:ee()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>xe("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(At,{className:"h-4 w-4"}),"Diseño de página"]}),e.jsxs("button",{onClick:()=>xe("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(gt,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(st,{variant:"ghost",tooltip:"Añadir Imagen",onClick:()=>yt.current&&yt.current.click(),children:e.jsx(ze,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:yt,onChange:Un,className:"hidden",accept:"image/*"})]}),z&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(st,{variant:"ghost",size:"sm",onClick:()=>{if(z&&V){const t=ee();if(t){const n={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};Ye(V,n)}}},className:"h-8 px-2",icon:e.jsx(ga,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(st,{variant:"ghost",size:"sm",onClick:()=>{z&&V&&ot(V,z)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(mn,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:`editor-workspace flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100 ${Rt?"preview-mode":""}`,children:Rt?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:q.width,height:q.height},children:e.jsx("div",{id:`page-${c[h].id}`,className:`grid ${Re().template} gap-6`,style:{width:"100%",height:"100%"},children:c[h].cells.map((t,n)=>{var a;return e.jsx(Yo,{id:t.id,elements:t.elements.filter(l=>!l.locked),workspaceSize:q,cellStyle:(a=Re().cellStyles)==null?void 0:a[c[h].cells.indexOf(t)],selectedElement:V===t.id?z:null,onSelectElement:Zt,onAddElement:(l,d)=>Ye(d,l),onUpdateElement:(l,d,b)=>ce(t.id,l,d,b),onDeleteElement:l=>ot(t.id,l),availableMasks:Re().maskCategories.flatMap(l=>l.masks),projectData:o},t.id)})})})}):e.jsxs("div",{id:`page-${c[h].id}`,className:" shadow-xl overflow-hidden",style:{width:q.width,height:q.height,position:"relative",backgroundColor:((Vo=c[h])==null?void 0:Vo.backgroundColor)||"#ffffff",backgroundImage:(Wo=c[h])!=null&&Wo.backgroundImage?`url(${c[h].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=c[h];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${Re().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((qo=Re().style)==null?void 0:qo.gap)||"16px",padding:((Qo=Re().style)==null?void 0:Qo.padding)||"16px"},children:c[h].cells.map(t=>{var n;return e.jsx(Yo,{id:t.id,elements:t.elements.filter(a=>!a.locked),workspaceSize:q,cellStyle:(n=Re().cellStyles)==null?void 0:n[c[h].cells.indexOf(t)],selectedElement:V===t.id?z:null,onSelectElement:Zt,onAddElement:(a,l)=>Ye(l,a),onUpdateElement:(a,l,d)=>ce(t.id,a,l,d),onDeleteElement:a=>ot(t.id,a),availableMasks:Re().maskCategories.flatMap(a=>a.masks),projectData:o},t.id)})})]})})]})]})]}),e.jsx(ra,{})]})}export{is as default};
