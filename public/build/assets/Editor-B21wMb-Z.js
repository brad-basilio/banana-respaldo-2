const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-D3plwuQr.js","assets/index-BH53Isel.js","assets/index-yBjzXJbu.js","assets/preload-helper-BfFHrpNk.js","assets/typeof-QjJsDpFa.js"])))=>i.map(i=>d[i]);
import{_ as En}from"./preload-helper-BfFHrpNk.js";import{j as e}from"./AboutSimple-Cf8x2fCZ.js";import{r as f,R as Gt}from"./index-BH53Isel.js";import{T as Cn,l as ae,i as Nn,D as so,H as io,U as lo,R as co,B as mt,F as uo,E as un}from"./EditableCell-upyYeQZg.js";import{h as Vt}from"./thumbnailGenerator-B4goYG9Y.js";import"./dom-to-image-more.min-BtE-uU7c.js";import{L as vt}from"./layers-6oegOx-p.js";import{C as mo}from"./chevron-down-DS-mdh9v.js";import{C as go}from"./chevron-right-Ckt5D2ka.js";import{E as po}from"./eye-CKCH9ORv.js";import{c as ke}from"./createLucideIcon-Cy5Ya80P.js";import{T as Sn}from"./trash-2-DK1wnsDn.js";import{S as ho}from"./star-wPQTHY_n.js";import{I as Ge}from"./image-BEA0kkBS.js";import"./EditorLayout-CkCvwqGw.js";import"./jspdf.es.min-D3plwuQr.js";import{t as re,T as fo}from"./index-BZYhE2TF.js";import{m as mn}from"./main-6DCdASTx.js";import{B as bo}from"./V1Edit-CK-6qWWx.js";import{G as gn}from"./Global-D6eBBAMK.js";import{S as Tn}from"./save-BvSyoVHO.js";import{C as xo}from"./clock-BTrEpQej.js";import{T as wo}from"./triangle-alert-vFMqKi4t.js";import{C as vo}from"./check-DQ7QoS0v.js";import{L as yo}from"./loader-circle-CrvBvIt1.js";import{C as Eo}from"./chevron-left-B2s3ZsB7.js";import{B as xt}from"./book-BuHIVa2d.js";import{P as wt}from"./plus-Bot15Khs.js";import{F as Co}from"./filter-Ci9tsc_e.js";import{C as No}from"./copy-6OEekgvq.js";import{C as So}from"./circle-check-big-D6DM3vPb.js";import{u as To}from"./useDrag-BaORhKlM.js";import"./index-yBjzXJbu.js";import"./sparkles-DeLUn6av.js";import"./sliders-vertical-C5ts4taK.js";import"./palette-DV_Vpyg9.js";import"./settings-BSPs3Zt8.js";import"./chevron-up-D78jyEhP.js";import"./TextElement-_pvTHO57.js";import"./upload-qgEr5bIl.js";import"./typeof-QjJsDpFa.js";import"./index-rimy3MAc.js";import"./index-fNjTmf9T.js";import"./___vite-browser-external_commonjs-proxy-0zb4Agf2.js";import"./PaymentModal-BB1JXzaZ.js";import"./index-Chjiymov.js";import"./x-DBMwyD6F.js";import"./index-BSWw-p5k.js";/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jo=ke("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ko=ke("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ao=ke("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _o=ke("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Io=ke("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Po=ke("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=ke("PanelsTopLeft",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oo=ke("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ro=ke("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pn=ke("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.445.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lo=ke("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Mo={preview:{scale:.5,width:200,height:150,quality:.8},high_quality:{scale:2,width:800,height:600,quality:1},pdf:{scale:3,width:1200,height:900,quality:1}},$o=(r,i=2e3)=>new Promise(a=>{const g=Date.now(),s=()=>{const E=getComputedStyle(r).gridTemplateColumns!=="none",C=r.children.length>0,v=r.offsetWidth>0&&r.offsetHeight>0;(E||C)&&v?requestAnimationFrame(()=>a(!0)):Date.now()-g>i?(console.warn("‚ö†Ô∏è Timeout esperando renderizado completo"),a(!1)):requestAnimationFrame(s)};s()}),Bo=(r,i)=>{var g,s;const a={};return a.position=r.style.position,a.transform=r.style.transform,a.zIndex=r.style.zIndex,r.style.position="relative",r.style.transform="translateZ(0)",r.style.zIndex="1",i&&i.template&&(r.style.display="grid",r.style.gridTemplateColumns=i.template.includes("grid-cols-1")?"1fr":i.template.includes("grid-cols-2")?"1fr 1fr":i.template.includes("grid-cols-3")?"1fr 1fr 1fr":i.template.includes("grid-cols-4")?"1fr 1fr 1fr 1fr":i.template.includes("grid-cols-5")?"1fr 1fr 1fr 1fr 1fr":"1fr",r.style.gridTemplateRows=i.template.includes("grid-rows-1")?"1fr":i.template.includes("grid-rows-2")?"1fr 1fr":i.template.includes("grid-rows-3")?"1fr 1fr 1fr":"1fr",(g=i.style)!=null&&g.gap&&(r.style.gap=i.style.gap),(s=i.style)!=null&&s.padding&&(r.style.padding=i.style.padding)),a},zo=(r,i)=>{Object.keys(i).forEach(a=>{i[a]?r.style[a]=i[a]:r.style.removeProperty(a)})},Kt=async(r,i,a={})=>{const g=Mo[a.type||"preview"];try{const s=document.querySelector(`#page-${r}`);if(!s)return console.error(`‚ùå No se encontr√≥ el elemento de p√°gina: #page-${r}`),null;console.log(`üì∏ Generando thumbnail para p√°gina ${r} con layout:`,i==null?void 0:i.id);const b=Bo(s,i);await $o(s);const E={allowTaint:!0,useCORS:!0,scale:g.scale,width:s.offsetWidth,height:s.offsetHeight,backgroundColor:null,logging:!1,imageTimeout:15e3,removeContainer:!0,onclone:A=>{const F=A.querySelector(`#page-${r}`);if(F&&i&&(F.className=`${F.className} grid ${i.template}`,i.style&&Object.keys(i.style).forEach(N=>{F.style[N]=i.style[N]}),i.cellStyles)){const N=F.children;Object.keys(i.cellStyles).forEach(L=>{N[L]&&(N[L].className+=` ${i.cellStyles[L]}`)})}A.querySelectorAll("script, iframe, video, audio").forEach(N=>N.remove()),A.querySelectorAll("img").forEach(N=>{N.style.imageRendering="optimizeQuality",N.style.objectFit=N.style.objectFit||"cover"})}},C=await Vt(s,E);if(zo(s,b),!C||C.width===0||C.height===0)throw new Error("Canvas inv√°lido generado");let v=C;if(g.width&&g.height&&(C.width!==g.width||C.height!==g.height)){v=document.createElement("canvas"),v.width=g.width,v.height=g.height;const A=v.getContext("2d");A.imageSmoothingEnabled=!0,A.imageSmoothingQuality="high";const F=C.width/C.height,j=g.width/g.height;let k,N,L=0,_=0;F>j?(k=g.width,N=g.width/F,_=(g.height-N)/2):(N=g.height,k=g.height*F,L=(g.width-k)/2),A.fillStyle="#ffffff",A.fillRect(0,0,g.width,g.height),A.drawImage(C,L,_,k,N)}const y=v.toDataURL("image/png",g.quality);return console.log(`‚úÖ Thumbnail generado exitosamente para p√°gina ${r}`),y}catch(s){return console.error(`‚ùå Error generando thumbnail para p√°gina ${r}:`,s),null}},zt=(r,i,a={width:200,height:150})=>{const g=document.createElement("canvas");g.width=a.width,g.height=a.height;const s=g.getContext("2d"),b={cover:"#8B5CF6",content:"#3B82F6",final:"#10B981"};return s.fillStyle=b[i]||"#6B7280",s.fillRect(0,0,a.width,a.height),s.fillStyle="#FFFFFF",s.font="14px Arial",s.textAlign="center",s.fillText(i==="cover"?"Portada":i==="final"?"Contraportada":"P√°gina",a.width/2,a.height/2),g.toDataURL("image/png",.8)},Uo=async(r,i={width:800,height:600})=>{const a={};console.log(`üì∏ [COMPAT] Generando ${r.length} thumbnails con nueva API...`);try{for(const g of r)try{const s={id:g.layout||"layout-1",template:"grid-cols-1 grid-rows-1",cells:1,style:{gap:"0px",padding:"0px"}},b=await Kt(g.id,s,{type:"preview",workspaceDimensions:i});if(b)a[g.id]=b,console.log(`‚úÖ [COMPAT] Thumbnail generado para p√°gina ${g.id}`);else{const E=zt(g.id,g.type||"content");a[g.id]=E,console.log(`üîÑ [COMPAT] Fallback generado para p√°gina ${g.id}`)}}catch(s){console.error(`‚ùå [COMPAT] Error en p√°gina ${g.id}:`,s);const b=zt(g.id,g.type||"content");a[g.id]=b}return console.log(`‚úÖ [COMPAT] Proceso completado. ${Object.keys(a).length}/${r.length} thumbnails generados`),a}catch(g){console.error("‚ùå [COMPAT] Error general en generateAccurateThumbnails:",g);for(const s of r)a[s.id]||(a[s.id]=zt(s.id,s.type||"content"));return a}},hn=async(r,i)=>(console.log("üîÑ [STUB] generateFastThumbnails llamada, redirigiendo a generateAccurateThumbnails"),Uo(r,i)),Wt=async(r,i,a={})=>(console.log(`üîÑ [STUB] generateSingleThumbnail llamada para p√°gina ${r}`),Kt(r,i,a)),Ut=()=>{console.log("üßπ [STUB] clearThumbnailCaches llamada")},gt=async(r,i,a={})=>(console.log(`üé® [STUB] generateThumbnailWithGuaranteedFilters llamada para p√°gina ${r}`),Kt(r,i,{...a,type:"high_quality"})),Fo=({pages:r,currentPage:i,selectedCell:a,selectedElement:g,onSelectCell:s,onSelectElement:b,onUpdateElement:E,onDeleteElement:C,onMoveElement:v})=>{var D;if(!r||!r[i])return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(vt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No page data available"})]});const y=r[i],A=((D=y==null?void 0:y.cells)==null?void 0:D.filter(R=>R.elements&&R.elements.length>0))||[],[F,j]=f.useState(()=>{const R={};return A.forEach(H=>{R[H.id]=!0}),R}),k=R=>{j(H=>({...H,[R]:!H[R]}))},N=R=>{switch(R){case"image":return e.jsx(Ge,{className:"h-4 w-4"});case"text":return e.jsx(Cn,{className:"h-4 w-4"});case"shape":return e.jsx(Ro,{className:"h-4 w-4"});case"sticker":return e.jsx(ho,{className:"h-4 w-4"});default:return e.jsx(_o,{className:"h-4 w-4"})}},L=(R,H)=>{switch(R.type){case"text":return R.content?R.content.substring(0,20)+"...":"Text Layer";case"image":return`Image ${H+1}`;case"shape":return R.shape||"Shape";case"sticker":return`Sticker ${H+1}`;default:return`Element ${H+1}`}},_=(R,H,ee)=>{E(R,H,{visible:ee})},W=(R,H)=>{s(R),b(H)};return e.jsx("div",{className:"space-y-2",children:A.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(vt,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"No elements yet"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add elements to see them here"})]}):A.map(R=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:`flex items-center p-3 cursor-pointer transition-colors ${a===R.id?"bg-purple-50 border-purple-200":"hover:bg-gray-50"}`,onClick:()=>{k(R.id),s(R.id)},children:[e.jsx("button",{className:"mr-2 text-gray-500 hover:text-gray-700",children:F[R.id]?e.jsx(mo,{className:"h-4 w-4"}):e.jsx(go,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-sm text-gray-800",children:["Cell ",R.id]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[R.elements.length," element",R.elements.length!==1?"s":""]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[R.x,", ",R.y]})]}),F[R.id]&&e.jsx("div",{className:"border-t border-gray-100",children:R.elements.map((H,ee)=>e.jsxs("div",{className:`flex items-center p-2 mx-2 mb-2 rounded cursor-pointer transition-colors ${g===H.id?"bg-purple-100 border border-purple-200":"hover:bg-gray-50"}`,onClick:()=>W(R.id,H.id),children:[e.jsx("div",{className:"mr-2 text-gray-500",children:N(H.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:L(H,ee)}),e.jsxs("div",{className:"text-xs text-gray-500",children:[H.type," ‚Ä¢ Layer ",ee+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:J=>{J.stopPropagation(),_(R.id,H.id,!H.visible)},className:"p-1 hover:bg-gray-200 rounded",title:H.visible?"Hide element":"Show element",children:H.visible!==!1?e.jsx(po,{className:"h-3 w-3 text-gray-500"}):e.jsx(Po,{className:"h-3 w-3 text-gray-400"})}),e.jsx("button",{onClick:J=>{J.stopPropagation(),v(R.id,H.id,"up")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer up",disabled:ee===R.elements.length-1,children:e.jsx(ko,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:J=>{J.stopPropagation(),v(R.id,H.id,"down")},className:"p-1 hover:bg-gray-200 rounded",title:"Move layer down",disabled:ee===0,children:e.jsx(jo,{className:"h-3 w-3 text-gray-500"})}),e.jsx("button",{onClick:J=>{J.stopPropagation(),C(R.id,H.id)},className:"p-1 hover:bg-red-100 rounded text-red-500",title:"Delete element",children:e.jsx(Sn,{className:"h-3 w-3"})})]})]},H.id))})]},R.id))})};function Ho({currentLayoutId:r,onLayoutChange:i}){const[a,g]=f.useState("all"),s={all:{name:"Todos",layouts:ae},hero:{name:"Hero",layouts:ae.filter(b=>b.category==="hero")},editorial:{name:"Editorial",layouts:ae.filter(b=>b.category==="editorial")},storytelling:{name:"Historia",layouts:ae.filter(b=>b.category==="storytelling")},minimal:{name:"Minimal",layouts:ae.filter(b=>b.category==="minimal")},creative:{name:"Creativo",layouts:ae.filter(b=>b.category==="creative")},classic:{name:"Cl√°sico",layouts:ae.filter(b=>b.category==="classic")}};return Object.keys(s).filter(b=>b==="all"||s[b].layouts.length>0),e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"grid grid-cols-2  gap-3 overflow-x-hidden custom-scroll",children:s[a].layouts.map(b=>e.jsxs("div",{className:`relative group cursor-pointer transition-all duration-200 
                                 hover:shadow-md hover:scale-102
                        `,onClick:()=>i(b.id),children:[e.jsxs("div",{className:"aspect-square relative bg-white rounded-lg p-2 border border-gray-200",children:[e.jsx("div",{className:`w-full h-full grid ${b.template}`,style:{gap:"2px",padding:"4px"},children:Array.from({length:b.cells}).map((E,C)=>{var v,y;return e.jsx("div",{className:`bg-gradient-to-br from-purple-100 to-purple-200 ${(y=(v=b.cellStyles)==null?void 0:v[C])!=null&&y.includes("rounded")?"rounded":"rounded-sm"}`,style:{minHeight:"8px"}},C)})}),r===b.id&&e.jsx("div",{className:"absolute top-1/2 right-1/2 translate-x-1/2 -translate-y-1/2 w-5 h-5 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 truncate",children:b.name}),b.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:b.description}),e.jsx("div",{className:"flex items-center justify-center mt-1 space-x-2",children:e.jsxs("span",{className:"text-xs text-gray-400",children:[b.cells," ",b.cells===1?"celda":"celdas"]})})]})]},b.id))}),s[a].layouts.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No hay layouts disponibles en esta categor√≠a."})})]})}const Go=({selectedMask:r,onSelect:i,availableMasks:a=[],selectedImage:g})=>{var C,v;const[s,b]=f.useState("B√°sicas"),E={};return Nn.forEach(y=>{E[y.category]||(E[y.category]=[]),(a.includes(y.id)||y.id==="none")&&E[y.category].push(y)}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-1 bg-gray-100 p-1 rounded-lg",children:Object.keys(E).slice(0,2).map(y=>E[y].length>0&&e.jsx("button",{onClick:()=>b(y),className:`py-1.5 px-2 text-xs rounded-md transition font-medium ${s===y?"bg-white text-purple-700 shadow-sm":"text-gray-600 hover:text-purple-600"}`,children:y},y))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:(C=E[s])==null?void 0:C.slice(0,6).map(y=>e.jsxs("div",{onClick:()=>i(y.id),className:`cursor-pointer border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all ${r===y.id?"ring-2 ring-purple-500 border-purple-300":"border-gray-200"}`,children:[e.jsx("div",{className:"aspect-square bg-white flex items-center justify-center p-1 relative overflow-hidden",children:g!=null&&g.content?e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",clipPath:y.id==="circle"?"circle(50%)":y.id==="rounded"||y.id==="rounded-sm"?"inset(0 round 8%)":y.id==="rounded-lg"?"inset(0 round 16%)":y.id==="rounded-rect"?"inset(0 round 12%)":y.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":y.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":y.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":y.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":y.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":y.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":y.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":y.id==="frame"?"inset(10% round 10%)":y.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':y.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':y.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"},children:e.jsx("img",{src:g.content,alt:y.name,className:"w-full h-full object-cover"})}):e.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",background:"#d1d5db",clipPath:y.id==="circle"?"circle(50%)":y.id==="rounded"||y.id==="rounded-sm"?"inset(0 round 8%)":y.id==="rounded-lg"?"inset(0 round 16%)":y.id==="rounded-rect"?"inset(0 round 12%)":y.id==="star"?"polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)":y.id==="hexagon"?"polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)":y.id==="triangle"?"polygon(50% 0%, 0% 100%, 100% 100%)":y.id==="diamond"?"polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)":y.id==="polaroid"?"inset(5% 5% 15% 5% round 2%)":y.id==="vintage"?"inset(5% round 5% 5% 10% 5%)":y.id==="diagonal"?"polygon(0 0, 100% 0, 100% 80%, 0 100%)":y.id==="frame"?"inset(10% round 10%)":y.id==="blob1"?'path("M10,0 C15,0 20,5 20,10 C20,15 15,20 10,20 C5,20 0,15 0,10 C0,5 5,0 10,0 Z")':y.id==="blob2"?'path("M10,0 C15,5 20,10 15,15 C10,20 5,15 0,10 C5,5 5,5 10,0 Z")':y.id==="blob3"?'path("M10,0 C15,0 20,5 15,10 C20,15 15,20 10,15 C5,20 0,15 5,10 C0,5 5,0 10,0 Z")':"none"}})}),e.jsx("p",{className:"text-center text-[10px] text-gray-700 p-1 truncate",children:y.name})]},y.id))}),((v=E[s])==null?void 0:v.length)>6&&e.jsxs("button",{className:"w-full py-2 text-xs text-purple-600 hover:text-purple-700 border border-purple-200 rounded-lg hover:bg-purple-50 transition",children:["Ver m√°s m√°scaras (",E[s].length-6," m√°s)"]})]})};let qt={},jn;function Ft(r={}){qt={animate:!0,allowClose:!0,overlayClickBehavior:"close",overlayOpacity:.7,smoothScroll:!1,disableActiveInteraction:!1,showProgress:!1,stagePadding:10,stageRadius:5,popoverOffset:10,showButtons:["next","previous","close"],disableButtons:[],overlayColor:"#000",...r}}function z(r){return r?qt[r]:qt}function Vo(r){jn=r}function Ne(){return jn}let yt={};function pt(r,i){yt[r]=i}function Ve(r){var i;(i=yt[r])==null||i.call(yt)}function Wo(){yt={}}function ht(r,i,a,g){return(r/=g/2)<1?a/2*r*r+i:-a/2*(--r*(r-2)-1)+i}function kn(r){const i='a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])';return r.flatMap(a=>{const g=a.matches(i),s=Array.from(a.querySelectorAll(i));return[...g?[a]:[],...s]}).filter(a=>getComputedStyle(a).pointerEvents!=="none"&&Do(a))}function An(r){if(!r||Ko(r))return;const i=z("smoothScroll"),a=r.offsetHeight>window.innerHeight;r.scrollIntoView({behavior:!i||qo(r)?"auto":"smooth",inline:"center",block:a?"start":"center"})}function qo(r){if(!r||!r.parentElement)return;const i=r.parentElement;return i.scrollHeight>i.clientHeight}function Ko(r){const i=r.getBoundingClientRect();return i.top>=0&&i.left>=0&&i.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&i.right<=(window.innerWidth||document.documentElement.clientWidth)}function Do(r){return!!(r.offsetWidth||r.offsetHeight||r.getClientRects().length)}let Et={};function me(r,i){Et[r]=i}function V(r){return r?Et[r]:Et}function fn(){Et={}}function Jo(r,i,a,g){let s=V("__activeStagePosition");const b=s||a.getBoundingClientRect(),E=g.getBoundingClientRect(),C=ht(r,b.x,E.x-b.x,i),v=ht(r,b.y,E.y-b.y,i),y=ht(r,b.width,E.width-b.width,i),A=ht(r,b.height,E.height-b.height,i);s={x:C,y:v,width:y,height:A},In(s),me("__activeStagePosition",s)}function _n(r){if(!r)return;const i=r.getBoundingClientRect(),a={x:i.x,y:i.y,width:i.width,height:i.height};me("__activeStagePosition",a),In(a)}function Qo(){const r=V("__activeStagePosition"),i=V("__overlaySvg");if(!r)return;if(!i){console.warn("No stage svg found.");return}const a=window.innerWidth,g=window.innerHeight;i.setAttribute("viewBox",`0 0 ${a} ${g}`)}function Yo(r){const i=Xo(r);document.body.appendChild(i),Rn(i,a=>{a.target.tagName==="path"&&Ve("overlayClick")}),me("__overlaySvg",i)}function In(r){const i=V("__overlaySvg");if(!i){Yo(r);return}const a=i.firstElementChild;if((a==null?void 0:a.tagName)!=="path")throw new Error("no path element found in stage svg");a.setAttribute("d",Pn(r))}function Xo(r){const i=window.innerWidth,a=window.innerHeight,g=document.createElementNS("http://www.w3.org/2000/svg","svg");g.classList.add("driver-overlay","driver-overlay-animated"),g.setAttribute("viewBox",`0 0 ${i} ${a}`),g.setAttribute("xmlSpace","preserve"),g.setAttribute("xmlnsXlink","http://www.w3.org/1999/xlink"),g.setAttribute("version","1.1"),g.setAttribute("preserveAspectRatio","xMinYMin slice"),g.style.fillRule="evenodd",g.style.clipRule="evenodd",g.style.strokeLinejoin="round",g.style.strokeMiterlimit="2",g.style.zIndex="10000",g.style.position="fixed",g.style.top="0",g.style.left="0",g.style.width="100%",g.style.height="100%";const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d",Pn(r)),s.style.fill=z("overlayColor")||"rgb(0,0,0)",s.style.opacity=`${z("overlayOpacity")}`,s.style.pointerEvents="auto",s.style.cursor="auto",g.appendChild(s),g}function Pn(r){const i=window.innerWidth,a=window.innerHeight,g=z("stagePadding")||0,s=z("stageRadius")||0,b=r.width+g*2,E=r.height+g*2,C=Math.min(s,b/2,E/2),v=Math.floor(Math.max(C,0)),y=r.x-g+v,A=r.y-g,F=b-v*2,j=E-v*2;return`M${i},0L0,0L0,${a}L${i},${a}L${i},0Z
    M${y},${A} h${F} a${v},${v} 0 0 1 ${v},${v} v${j} a${v},${v} 0 0 1 -${v},${v} h-${F} a${v},${v} 0 0 1 -${v},-${v} v-${j} a${v},${v} 0 0 1 ${v},-${v} z`}function Zo(){const r=V("__overlaySvg");r&&r.remove()}function ea(){const r=document.getElementById("driver-dummy-element");if(r)return r;let i=document.createElement("div");return i.id="driver-dummy-element",i.style.width="0",i.style.height="0",i.style.pointerEvents="none",i.style.opacity="0",i.style.position="fixed",i.style.top="50%",i.style.left="50%",document.body.appendChild(i),i}function bn(r){const{element:i}=r;let a=typeof i=="function"?i():typeof i=="string"?document.querySelector(i):i;a||(a=ea()),ra(a,r)}function ta(){const r=V("__activeElement"),i=V("__activeStep");r&&(_n(r),Qo(),Mn(r,i))}function ra(r,i){var a;const g=Date.now(),s=V("__activeStep"),b=V("__activeElement")||r,E=!b||b===r,C=r.id==="driver-dummy-element",v=b.id==="driver-dummy-element",y=z("animate"),A=i.onHighlightStarted||z("onHighlightStarted"),F=(i==null?void 0:i.onHighlighted)||z("onHighlighted"),j=(s==null?void 0:s.onDeselected)||z("onDeselected"),k=z(),N=V();!E&&j&&j(v?void 0:b,s,{config:k,state:N,driver:Ne()}),A&&A(C?void 0:r,i,{config:k,state:N,driver:Ne()});const L=!E&&y;let _=!1;ia(),me("previousStep",s),me("previousElement",b),me("activeStep",i),me("activeElement",r);const W=()=>{if(V("__transitionCallback")!==W)return;const D=Date.now()-g,R=400-D<=400/2;i.popover&&R&&!_&&L&&(xn(r,i),_=!0),z("animate")&&D<400?Jo(D,400,b,r):(_n(r),F&&F(C?void 0:r,i,{config:z(),state:V(),driver:Ne()}),me("__transitionCallback",void 0),me("__previousStep",s),me("__previousElement",b),me("__activeStep",i),me("__activeElement",r)),window.requestAnimationFrame(W)};me("__transitionCallback",W),window.requestAnimationFrame(W),An(r),!L&&i.popover&&xn(r,i),b.classList.remove("driver-active-element","driver-no-interaction"),b.removeAttribute("aria-haspopup"),b.removeAttribute("aria-expanded"),b.removeAttribute("aria-controls"),((a=i.disableActiveInteraction)!=null?a:z("disableActiveInteraction"))&&r.classList.add("driver-no-interaction"),r.classList.add("driver-active-element"),r.setAttribute("aria-haspopup","dialog"),r.setAttribute("aria-expanded","true"),r.setAttribute("aria-controls","driver-popover-content")}function na(){var r;(r=document.getElementById("driver-dummy-element"))==null||r.remove(),document.querySelectorAll(".driver-active-element").forEach(i=>{i.classList.remove("driver-active-element","driver-no-interaction"),i.removeAttribute("aria-haspopup"),i.removeAttribute("aria-expanded"),i.removeAttribute("aria-controls")})}function nt(){const r=V("__resizeTimeout");r&&window.cancelAnimationFrame(r),me("__resizeTimeout",window.requestAnimationFrame(ta))}function oa(r){var i;if(!V("isInitialized")||!(r.key==="Tab"||r.keyCode===9))return;const a=V("__activeElement"),g=(i=V("popover"))==null?void 0:i.wrapper,s=kn([...g?[g]:[],...a?[a]:[]]),b=s[0],E=s[s.length-1];if(r.preventDefault(),r.shiftKey){const C=s[s.indexOf(document.activeElement)-1]||E;C==null||C.focus()}else{const C=s[s.indexOf(document.activeElement)+1]||b;C==null||C.focus()}}function On(r){var i;((i=z("allowKeyboardControl"))==null||i)&&(r.key==="Escape"?Ve("escapePress"):r.key==="ArrowRight"?Ve("arrowRightPress"):r.key==="ArrowLeft"&&Ve("arrowLeftPress"))}function Rn(r,i,a){const g=(s,b)=>{const E=s.target;r.contains(E)&&((!a||a(E))&&(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation()),b==null||b(s))};document.addEventListener("pointerdown",g,!0),document.addEventListener("mousedown",g,!0),document.addEventListener("pointerup",g,!0),document.addEventListener("mouseup",g,!0),document.addEventListener("click",s=>{g(s,i)},!0)}function aa(){window.addEventListener("keyup",On,!1),window.addEventListener("keydown",oa,!1),window.addEventListener("resize",nt),window.addEventListener("scroll",nt)}function sa(){window.removeEventListener("keyup",On),window.removeEventListener("resize",nt),window.removeEventListener("scroll",nt)}function ia(){const r=V("popover");r&&(r.wrapper.style.display="none")}function xn(r,i){var a,g;let s=V("popover");s&&document.body.removeChild(s.wrapper),s=ca(),document.body.appendChild(s.wrapper);const{title:b,description:E,showButtons:C,disableButtons:v,showProgress:y,nextBtnText:A=z("nextBtnText")||"Next &rarr;",prevBtnText:F=z("prevBtnText")||"&larr; Previous",progressText:j=z("progressText")||"{current} of {total}"}=i.popover||{};s.nextButton.innerHTML=A,s.previousButton.innerHTML=F,s.progress.innerHTML=j,b?(s.title.innerHTML=b,s.title.style.display="block"):s.title.style.display="none",E?(s.description.innerHTML=E,s.description.style.display="block"):s.description.style.display="none";const k=C||z("showButtons"),N=y||z("showProgress")||!1,L=(k==null?void 0:k.includes("next"))||(k==null?void 0:k.includes("previous"))||N;s.closeButton.style.display=k.includes("close")?"block":"none",L?(s.footer.style.display="flex",s.progress.style.display=N?"block":"none",s.nextButton.style.display=k.includes("next")?"block":"none",s.previousButton.style.display=k.includes("previous")?"block":"none"):s.footer.style.display="none";const _=v||z("disableButtons")||[];_!=null&&_.includes("next")&&(s.nextButton.disabled=!0,s.nextButton.classList.add("driver-popover-btn-disabled")),_!=null&&_.includes("previous")&&(s.previousButton.disabled=!0,s.previousButton.classList.add("driver-popover-btn-disabled")),_!=null&&_.includes("close")&&(s.closeButton.disabled=!0,s.closeButton.classList.add("driver-popover-btn-disabled"));const W=s.wrapper;W.style.display="block",W.style.left="",W.style.top="",W.style.bottom="",W.style.right="",W.id="driver-popover-content",W.setAttribute("role","dialog"),W.setAttribute("aria-labelledby","driver-popover-title"),W.setAttribute("aria-describedby","driver-popover-description");const D=s.arrow;D.className="driver-popover-arrow";const R=((a=i.popover)==null?void 0:a.popoverClass)||z("popoverClass")||"";W.className=`driver-popover ${R}`.trim(),Rn(s.wrapper,ue=>{var Se,Me,m;const ie=ue.target,x=((Se=i.popover)==null?void 0:Se.onNextClick)||z("onNextClick"),se=((Me=i.popover)==null?void 0:Me.onPrevClick)||z("onPrevClick"),ce=((m=i.popover)==null?void 0:m.onCloseClick)||z("onCloseClick");if(ie.closest(".driver-popover-next-btn"))return x?x(r,i,{config:z(),state:V(),driver:Ne()}):Ve("nextClick");if(ie.closest(".driver-popover-prev-btn"))return se?se(r,i,{config:z(),state:V(),driver:Ne()}):Ve("prevClick");if(ie.closest(".driver-popover-close-btn"))return ce?ce(r,i,{config:z(),state:V(),driver:Ne()}):Ve("closeClick")},ue=>!(s!=null&&s.description.contains(ue))&&!(s!=null&&s.title.contains(ue))&&typeof ue.className=="string"&&ue.className.includes("driver-popover")),me("popover",s);const H=((g=i.popover)==null?void 0:g.onPopoverRender)||z("onPopoverRender");H&&H(s,{config:z(),state:V(),driver:Ne()}),Mn(r,i),An(W);const ee=r.classList.contains("driver-dummy-element"),J=kn([W,...ee?[]:[r]]);J.length>0&&J[0].focus()}function Ln(){const r=V("popover");if(!(r!=null&&r.wrapper))return;const i=r.wrapper.getBoundingClientRect(),a=z("stagePadding")||0,g=z("popoverOffset")||0;return{width:i.width+a+g,height:i.height+a+g,realWidth:i.width,realHeight:i.height}}function wn(r,i){const{elementDimensions:a,popoverDimensions:g,popoverPadding:s,popoverArrowDimensions:b}=i;return r==="start"?Math.max(Math.min(a.top-s,window.innerHeight-g.realHeight-b.width),b.width):r==="end"?Math.max(Math.min(a.top-(g==null?void 0:g.realHeight)+a.height+s,window.innerHeight-(g==null?void 0:g.realHeight)-b.width),b.width):r==="center"?Math.max(Math.min(a.top+a.height/2-(g==null?void 0:g.realHeight)/2,window.innerHeight-(g==null?void 0:g.realHeight)-b.width),b.width):0}function vn(r,i){const{elementDimensions:a,popoverDimensions:g,popoverPadding:s,popoverArrowDimensions:b}=i;return r==="start"?Math.max(Math.min(a.left-s,window.innerWidth-g.realWidth-b.width),b.width):r==="end"?Math.max(Math.min(a.left-(g==null?void 0:g.realWidth)+a.width+s,window.innerWidth-(g==null?void 0:g.realWidth)-b.width),b.width):r==="center"?Math.max(Math.min(a.left+a.width/2-(g==null?void 0:g.realWidth)/2,window.innerWidth-(g==null?void 0:g.realWidth)-b.width),b.width):0}function Mn(r,i){const a=V("popover");if(!a)return;const{align:g="start",side:s="left"}=(i==null?void 0:i.popover)||{},b=g,E=r.id==="driver-dummy-element"?"over":s,C=z("stagePadding")||0,v=Ln(),y=a.arrow.getBoundingClientRect(),A=r.getBoundingClientRect(),F=A.top-v.height;let j=F>=0;const k=window.innerHeight-(A.bottom+v.height);let N=k>=0;const L=A.left-v.width;let _=L>=0;const W=window.innerWidth-(A.right+v.width);let D=W>=0;const R=!j&&!N&&!_&&!D;let H=E;if(E==="top"&&j?D=_=N=!1:E==="bottom"&&N?D=_=j=!1:E==="left"&&_?D=j=N=!1:E==="right"&&D&&(_=j=N=!1),E==="over"){const ee=window.innerWidth/2-v.realWidth/2,J=window.innerHeight/2-v.realHeight/2;a.wrapper.style.left=`${ee}px`,a.wrapper.style.right="auto",a.wrapper.style.top=`${J}px`,a.wrapper.style.bottom="auto"}else if(R){const ee=window.innerWidth/2-(v==null?void 0:v.realWidth)/2,J=10;a.wrapper.style.left=`${ee}px`,a.wrapper.style.right="auto",a.wrapper.style.bottom=`${J}px`,a.wrapper.style.top="auto"}else if(_){const ee=Math.min(L,window.innerWidth-(v==null?void 0:v.realWidth)-y.width),J=wn(b,{elementDimensions:A,popoverDimensions:v,popoverPadding:C,popoverArrowDimensions:y});a.wrapper.style.left=`${ee}px`,a.wrapper.style.top=`${J}px`,a.wrapper.style.bottom="auto",a.wrapper.style.right="auto",H="left"}else if(D){const ee=Math.min(W,window.innerWidth-(v==null?void 0:v.realWidth)-y.width),J=wn(b,{elementDimensions:A,popoverDimensions:v,popoverPadding:C,popoverArrowDimensions:y});a.wrapper.style.right=`${ee}px`,a.wrapper.style.top=`${J}px`,a.wrapper.style.bottom="auto",a.wrapper.style.left="auto",H="right"}else if(j){const ee=Math.min(F,window.innerHeight-v.realHeight-y.width);let J=vn(b,{elementDimensions:A,popoverDimensions:v,popoverPadding:C,popoverArrowDimensions:y});a.wrapper.style.top=`${ee}px`,a.wrapper.style.left=`${J}px`,a.wrapper.style.bottom="auto",a.wrapper.style.right="auto",H="top"}else if(N){const ee=Math.min(k,window.innerHeight-(v==null?void 0:v.realHeight)-y.width);let J=vn(b,{elementDimensions:A,popoverDimensions:v,popoverPadding:C,popoverArrowDimensions:y});a.wrapper.style.left=`${J}px`,a.wrapper.style.bottom=`${ee}px`,a.wrapper.style.top="auto",a.wrapper.style.right="auto",H="bottom"}R?a.arrow.classList.add("driver-popover-arrow-none"):la(b,H,r)}function la(r,i,a){const g=V("popover");if(!g)return;const s=a.getBoundingClientRect(),b=Ln(),E=g.arrow,C=b.width,v=window.innerWidth,y=s.width,A=s.left,F=b.height,j=window.innerHeight,k=s.top,N=s.height;E.className="driver-popover-arrow";let L=i,_=r;if(i==="top"?(A+y<=0?(L="right",_="end"):A+y-C<=0&&(L="top",_="start"),A>=v?(L="left",_="end"):A+C>=v&&(L="top",_="end")):i==="bottom"?(A+y<=0?(L="right",_="start"):A+y-C<=0&&(L="bottom",_="start"),A>=v?(L="left",_="start"):A+C>=v&&(L="bottom",_="end")):i==="left"?(k+N<=0?(L="bottom",_="end"):k+N-F<=0&&(L="left",_="start"),k>=j?(L="top",_="end"):k+F>=j&&(L="left",_="end")):i==="right"&&(k+N<=0?(L="bottom",_="start"):k+N-F<=0&&(L="right",_="start"),k>=j?(L="top",_="start"):k+F>=j&&(L="right",_="end")),!L)E.classList.add("driver-popover-arrow-none");else{E.classList.add(`driver-popover-arrow-side-${L}`),E.classList.add(`driver-popover-arrow-align-${_}`);const W=a.getBoundingClientRect(),D=E.getBoundingClientRect(),R=z("stagePadding")||0,H=W.left-R<window.innerWidth&&W.right+R>0&&W.top-R<window.innerHeight&&W.bottom+R>0;i==="bottom"&&H&&(D.x>W.x&&D.x+D.width<W.x+W.width?g.wrapper.style.transform="translateY(0)":(E.classList.remove(`driver-popover-arrow-align-${_}`),E.classList.add("driver-popover-arrow-none"),g.wrapper.style.transform=`translateY(-${R/2}px)`))}}function ca(){const r=document.createElement("div");r.classList.add("driver-popover");const i=document.createElement("div");i.classList.add("driver-popover-arrow");const a=document.createElement("header");a.id="driver-popover-title",a.classList.add("driver-popover-title"),a.style.display="none",a.innerText="Popover Title";const g=document.createElement("div");g.id="driver-popover-description",g.classList.add("driver-popover-description"),g.style.display="none",g.innerText="Popover description is here";const s=document.createElement("button");s.type="button",s.classList.add("driver-popover-close-btn"),s.setAttribute("aria-label","Close"),s.innerHTML="&times;";const b=document.createElement("footer");b.classList.add("driver-popover-footer");const E=document.createElement("span");E.classList.add("driver-popover-progress-text"),E.innerText="";const C=document.createElement("span");C.classList.add("driver-popover-navigation-btns");const v=document.createElement("button");v.type="button",v.classList.add("driver-popover-prev-btn"),v.innerHTML="&larr; Previous";const y=document.createElement("button");return y.type="button",y.classList.add("driver-popover-next-btn"),y.innerHTML="Next &rarr;",C.appendChild(v),C.appendChild(y),b.appendChild(E),b.appendChild(C),r.appendChild(s),r.appendChild(i),r.appendChild(a),r.appendChild(g),r.appendChild(b),{wrapper:r,arrow:i,title:a,description:g,footer:b,previousButton:v,nextButton:y,closeButton:s,footerButtons:C,progress:E}}function da(){var r;const i=V("popover");i&&((r=i.wrapper.parentElement)==null||r.removeChild(i.wrapper))}function ua(r={}){Ft(r);function i(){z("allowClose")&&A()}function a(){const j=z("overlayClickBehavior");if(z("allowClose")&&j==="close"){A();return}j==="nextStep"&&g()}function g(){const j=V("activeIndex"),k=z("steps")||[];if(typeof j>"u")return;const N=j+1;k[N]?y(N):A()}function s(){const j=V("activeIndex"),k=z("steps")||[];if(typeof j>"u")return;const N=j-1;k[N]?y(N):A()}function b(j){(z("steps")||[])[j]?y(j):A()}function E(){var j;if(V("__transitionCallback"))return;const k=V("activeIndex"),N=V("__activeStep"),L=V("__activeElement");if(typeof k>"u"||typeof N>"u"||typeof V("activeIndex")>"u")return;const _=((j=N.popover)==null?void 0:j.onPrevClick)||z("onPrevClick");if(_)return _(L,N,{config:z(),state:V(),driver:Ne()});s()}function C(){var j;if(V("__transitionCallback"))return;const k=V("activeIndex"),N=V("__activeStep"),L=V("__activeElement");if(typeof k>"u"||typeof N>"u")return;const _=((j=N.popover)==null?void 0:j.onNextClick)||z("onNextClick");if(_)return _(L,N,{config:z(),state:V(),driver:Ne()});g()}function v(){V("isInitialized")||(me("isInitialized",!0),document.body.classList.add("driver-active",z("animate")?"driver-fade":"driver-simple"),aa(),pt("overlayClick",a),pt("escapePress",i),pt("arrowLeftPress",E),pt("arrowRightPress",C))}function y(j=0){var k,N,L,_,W,D,R,H;const ee=z("steps");if(!ee){console.error("No steps to drive through"),A();return}if(!ee[j]){A();return}me("__activeOnDestroyed",document.activeElement),me("activeIndex",j);const J=ee[j],ue=ee[j+1],Se=ee[j-1],Me=((k=J.popover)==null?void 0:k.doneBtnText)||z("doneBtnText")||"Done",m=z("allowClose"),ie=typeof((N=J.popover)==null?void 0:N.showProgress)<"u"?(L=J.popover)==null?void 0:L.showProgress:z("showProgress"),x=(((_=J.popover)==null?void 0:_.progressText)||z("progressText")||"{{current}} of {{total}}").replace("{{current}}",`${j+1}`).replace("{{total}}",`${ee.length}`),se=((W=J.popover)==null?void 0:W.showButtons)||z("showButtons"),ce=["next","previous",...m?["close"]:[]].filter(q=>!(se!=null&&se.length)||se.includes(q)),We=((D=J.popover)==null?void 0:D.onNextClick)||z("onNextClick"),U=((R=J.popover)==null?void 0:R.onPrevClick)||z("onPrevClick"),Y=((H=J.popover)==null?void 0:H.onCloseClick)||z("onCloseClick");bn({...J,popover:{showButtons:ce,nextBtnText:ue?void 0:Me,disableButtons:[...Se?[]:["previous"]],showProgress:ie,progressText:x,onNextClick:We||(()=>{ue?y(j+1):A()}),onPrevClick:U||(()=>{y(j-1)}),onCloseClick:Y||(()=>{A()}),...(J==null?void 0:J.popover)||{}}})}function A(j=!0){const k=V("__activeElement"),N=V("__activeStep"),L=V("__activeOnDestroyed"),_=z("onDestroyStarted");if(j&&_){const R=!k||(k==null?void 0:k.id)==="driver-dummy-element";_(R?void 0:k,N,{config:z(),state:V(),driver:Ne()});return}const W=(N==null?void 0:N.onDeselected)||z("onDeselected"),D=z("onDestroyed");if(document.body.classList.remove("driver-active","driver-fade","driver-simple"),sa(),da(),na(),Zo(),Wo(),fn(),k&&N){const R=k.id==="driver-dummy-element";W&&W(R?void 0:k,N,{config:z(),state:V(),driver:Ne()}),D&&D(R?void 0:k,N,{config:z(),state:V(),driver:Ne()})}L&&L.focus()}const F={isActive:()=>V("isInitialized")||!1,refresh:nt,drive:(j=0)=>{v(),y(j)},setConfig:Ft,setSteps:j=>{fn(),Ft({...z(),steps:j})},getConfig:z,getState:V,getActiveIndex:()=>V("activeIndex"),isFirstStep:()=>V("activeIndex")===0,isLastStep:()=>{const j=z("steps")||[],k=V("activeIndex");return k!==void 0&&k===j.length-1},getActiveStep:()=>V("activeStep"),getActiveElement:()=>V("activeElement"),getPreviousElement:()=>V("previousElement"),getPreviousStep:()=>V("previousStep"),moveNext:g,movePrevious:s,moveTo:b,hasNextStep:()=>{const j=z("steps")||[],k=V("activeIndex");return k!==void 0&&!!j[k+1]},hasPreviousStep:()=>{const j=z("steps")||[],k=V("activeIndex");return k!==void 0&&!!j[k-1]},highlight:j=>{v(),bn({...j,popover:j.popover?{showButtons:[],showProgress:!1,progressText:"",...j.popover}:void 0})},destroy:()=>{A(!1)}};return Vo(F),F}const ma=async(r,i,a)=>{var g;try{console.log("üì§ [SAVE] Subiendo imagen al backend:",i);const[s,b]=r.split(","),E=((g=s.match(/data:image\/(\w+)/))==null?void 0:g[1])||"png",C=new FormData,v=atob(b),y=new Array(v.length);for(let N=0;N<v.length;N++)y[N]=v.charCodeAt(N);const A=new Uint8Array(y),F=new Blob([A],{type:`image/${E}`});C.append("image",F,`element_${i}.${E}`),C.append("project_id",a),C.append("element_id",i);const j=await fetch("/api/canvas/projects/upload-image",{method:"POST",headers:{Accept:"application/json"},credentials:"include",body:C});if(!j.ok)throw new Error("Error al subir imagen al servidor");const k=await j.json();return console.log("‚úÖ [SAVE] Imagen subida exitosamente:",k.url),k.url}catch(s){throw console.error("‚ùå [SAVE] Error subiendo imagen:",s),s}},ga=async(r,i)=>{var b,E;console.log("üîÑ [SAVE] Procesando im√°genes para guardado...");const a=[];let g=0,s=0;for(const C of r)for(const v of C.cells||[])for(const y of v.elements||[])y.type==="image"&&((b=y.content)!=null&&b.startsWith("data:image/"))&&g++;console.log(`üìä [SAVE] Total de im√°genes base64 a procesar: ${g}`);for(const C of r){const v={...C};v.cells=[];for(const y of C.cells||[]){const A={...y};A.elements=[];for(const F of y.elements||[]){const j={...F};if(F.type==="image"&&((E=F.content)!=null&&E.startsWith("data:image/")))try{const k=await ma(F.content,F.id,i);j.content=k,j.isUploaded=!0,s++,console.log(`‚úÖ [SAVE] Imagen ${s}/${g} procesada`)}catch(k){console.error("‚ùå [SAVE] Error procesando imagen:",F.id,k),j.uploadError=k.message}A.elements.push(j)}v.cells.push(A)}a.push(v)}return console.log(`‚úÖ [SAVE] Procesamiento completado: ${s}/${g} im√°genes subidas`),a},pa=async(r,i)=>{var a;try{console.log("üîç [DEBUG] saveThumbnailsAsFiles llamada con:",{projectId:r,thumbnailsCount:Object.keys(i).length});const g=[];for(const[E,C]of Object.entries(i))console.log(`üîç [DEBUG] Procesando thumbnail para p√°gina ${E}:`,{hasData:!!C,isBase64:C&&C.startsWith("data:image/"),dataLength:C?C.length:0}),C&&C.startsWith("data:image/")&&g.push({page_id:E,thumbnail_data:C});if(g.length===0){console.log("‚ÑπÔ∏è [THUMBNAILS] No hay thumbnails base64 para guardar");return}console.log(`üñºÔ∏è [THUMBNAILS] Guardando ${g.length} thumbnails como archivos...`),console.log(`üîç [DEBUG] URL del endpoint: /api/thumbnails/${r}/save-as-files`);const s=await fetch(`/api/thumbnails/${r}/save-as-files`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content)||""},credentials:"include",body:JSON.stringify({thumbnails:g})});if(console.log("üîç [DEBUG] Respuesta del servidor:",{status:s.status,statusText:s.statusText,ok:s.ok}),!s.ok){const E=await s.text();throw console.error("‚ùå [THUMBNAILS] Error respuesta del servidor:",E),new Error(`Error al guardar thumbnails: ${s.status} ${s.statusText}`)}const b=await s.json();return console.log("‚úÖ [THUMBNAILS] Thumbnails guardados como archivos:",b),b}catch(g){throw console.error("‚ùå [THUMBNAILS] Error guardando thumbnails:",g),g}},yn=async(r,i,a,g,s,b,E=!1)=>{try{if(!(i!=null&&i.id))throw new Error("No se encontr√≥ el ID del proyecto");console.log(`üíæ [SAVE] Iniciando ${E?"auto-guardado":"guardado manual"}...`);let C=r;E||(C=await ga(r,i.id));const v={pages:C,projectInfo:{id:i.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:g==null?void 0:g.id},workspace:{width:s.width,height:s.height,scale:s.scale},meta:{savedAt:new Date().toISOString(),version:"2.0",isAutoSave:E,totalPages:r.length}},y=E?"save-progress":"save",A=await fetch(`/api/canvas/projects/${i.id}/${y}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({design_data:v,thumbnails:b})});if(!A.ok){const j=await A.json().catch(()=>({}));throw new Error(j.message||"Error al guardar el proyecto")}const F=await A.json();if(console.log(`‚úÖ [SAVE] ${E?"Auto-guardado":"Guardado"} exitoso:`,F),!E&&b&&Object.keys(b).length>0){console.log("üñºÔ∏è [SAVE] Guardando thumbnails como archivos...");try{await pa(i.id,b),console.log("‚úÖ [SAVE] Thumbnails guardados como archivos")}catch(j){console.warn("‚ö†Ô∏è [SAVE] Error guardando thumbnails como archivos:",j)}}return{success:!0,data:F}}catch(C){return console.error(`‚ùå [SAVE] Error en ${E?"auto-guardado":"guardado"}:`,C),{success:!1,error:C.message}}},ha=(r,i,a,g,s,b)=>{const[E,C]=f.useState("saved"),[v,y]=f.useState(null),[A,F]=f.useState(null),[j,k]=f.useState(null),[N,L]=f.useState(!1),[_,W]=f.useState(navigator.onLine),D=f.useRef(null),R=f.useRef(null),H=f.useRef(null),ee=f.useRef(!1),J=f.useRef(null),ue=15e3,Se=2e3,Me=5e3,m=f.useCallback((U,Y)=>{try{const q={pages:U.map(ge=>{var Q;return{id:ge.id,layout:ge.layout,cells:((Q=ge.cells)==null?void 0:Q.map(be=>{var Ct;return{id:be.id,elements:((Ct=be.elements)==null?void 0:Ct.map(Ce=>{var Ae;return{id:Ce.id,type:Ce.type,content:Ce.type==="image"&&((Ae=Ce.content)!=null&&Ae.startsWith("data:image/"))?`[IMAGE_${Ce.content.length}]`:Ce.content,position:Ce.position,size:Ce.size,style:Ce.style,filters:Ce.filters,rotation:Ce.rotation}}))||[]}}))||[]}})||[],workspace:{width:Y==null?void 0:Y.width,height:Y==null?void 0:Y.height}};return btoa(JSON.stringify(q)).substring(0,32)}catch(q){return console.warn("‚ö†Ô∏è [AUTO-SAVE] Error generando hash:",q),Date.now().toString()}},[]),ie=f.useCallback(()=>`album_editor_autosave_${(i==null?void 0:i.id)||"draft"}`,[i==null?void 0:i.id]),x=f.useCallback(U=>{try{const Y=ie(),q={...U,savedAt:Date.now(),version:"2.1"};return localStorage.setItem(Y,JSON.stringify(q)),console.log("üíæ [AUTO-SAVE] Guardado en localStorage"),!0}catch(Y){return console.error("‚ùå [AUTO-SAVE] Error guardando en localStorage:",Y),!1}},[ie]),se=f.useCallback(()=>{var U;try{const Y=ie(),q=localStorage.getItem(Y);if(q){const ge=JSON.parse(q);return console.log("üìÇ [AUTO-SAVE] Datos encontrados en localStorage:",{pages:(U=ge.pages)==null?void 0:U.length,savedAt:new Date(ge.savedAt).toLocaleString()}),ge}}catch(Y){console.error("‚ùå [AUTO-SAVE] Error cargando desde localStorage:",Y)}return null},[ie]),ce=f.useCallback(async(U=!1)=>{if(ee.current&&!U){console.log("‚è≥ [AUTO-SAVE] Guardado en progreso, saltando...");return}if(!(i!=null&&i.id)||!r||r.length===0){console.log("‚ö†Ô∏è [AUTO-SAVE] Datos insuficientes para guardar");return}const Y=m(r,s);if(!U&&Y===H.current){console.log("üìä [AUTO-SAVE] Sin cambios detectados, saltando guardado");return}try{ee.current=!0,C("saving"),k(null);const q={pages:r,projectInfo:{id:i.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:g==null?void 0:g.id},workspace:s,meta:{savedAt:new Date().toISOString(),version:"2.1",contentHash:Y}};if(x(q),_){const ge=await yn(r,i,a,g,s,b,!0);if(ge.success)H.current=Y,F(new Date),C("saved"),L(!1),console.log("‚úÖ [AUTO-SAVE] Guardado exitoso en base de datos");else throw new Error(ge.error)}else console.log("ÔøΩ [AUTO-SAVE] Sin conexi√≥n, solo guardado en localStorage"),C("pending"),L(!0)}catch(q){console.error("‚ùå [AUTO-SAVE] Error:",q),k(q.message),C("error"),_&&(J.current=setTimeout(()=>{console.log("üîÑ [AUTO-SAVE] Reintentando guardado..."),ce(!0)},Me))}finally{ee.current=!1}},[r,i,a,g,s,b,m,x,_]),We=f.useCallback(async()=>{try{C("saving");const U=await yn(r,i,a,g,s,b,!1);if(U.success){const Y=m(r,s);H.current=Y,y(new Date),C("saved"),L(!1),re.success("üíæ Proyecto guardado exitosamente"),console.log("‚úÖ [MANUAL-SAVE] Guardado manual exitoso")}else k(U.error),C("error"),re.error(`‚ùå Error al guardar: ${U.error}`);return U.success}catch(U){return console.error("‚ùå [MANUAL-SAVE] Error:",U),k(U.message),C("error"),re.error(`‚ùå Error inesperado: ${U.message}`),!1}},[r,i,a,g,s,b,m]);return f.useEffect(()=>{if(!(i!=null&&i.id)||!r||r.length===0)return;const U=m(r,s);return H.current&&U!==H.current?(console.log("üîÑ [AUTO-SAVE] Cambios detectados, programando guardado..."),L(!0),C("pending"),R.current&&clearTimeout(R.current),R.current=setTimeout(()=>{ce()},Se)):H.current||(H.current=U),()=>{R.current&&clearTimeout(R.current)}},[r,s,i==null?void 0:i.id,m,ce]),f.useEffect(()=>{if(i!=null&&i.id)return D.current&&clearInterval(D.current),D.current=setInterval(()=>{N&&(console.log("‚è∞ [AUTO-SAVE] Auto-save peri√≥dico activado"),ce())},ue),()=>{D.current&&clearInterval(D.current)}},[i==null?void 0:i.id,N,ce]),f.useEffect(()=>{const U=()=>{console.log("üåê [AUTO-SAVE] Conexi√≥n restaurada"),W(!0),N&&setTimeout(()=>ce(!0),1e3)},Y=()=>{console.log("üì¥ [AUTO-SAVE] Conexi√≥n perdida"),W(!1)};return window.addEventListener("online",U),window.addEventListener("offline",Y),()=>{window.removeEventListener("online",U),window.removeEventListener("offline",Y)}},[N,ce]),f.useEffect(()=>{const U=Y=>{if(N){const q={pages:r,projectInfo:{id:i.id},workspace:s,meta:{savedAt:new Date().toISOString()}};return x(q),Y.preventDefault(),Y.returnValue="¬øEst√°s seguro de salir? Hay cambios sin guardar.","¬øEst√°s seguro de salir? Hay cambios sin guardar."}};return window.addEventListener("beforeunload",U),()=>window.removeEventListener("beforeunload",U)},[N,r,i==null?void 0:i.id,s,x]),f.useEffect(()=>()=>{R.current&&clearTimeout(R.current),D.current&&clearInterval(D.current),J.current&&clearTimeout(J.current)},[]),f.useEffect(()=>{j&&(j.includes("max_allowed_packet")||j.includes("data_too_large")?re.error("‚ùå El proyecto es demasiado grande para guardar autom√°ticamente. Reduce el n√∫mero o tama√±o de im√°genes."):re.error(`‚ùå Error de auto-guardado: ${j}`))},[j]),{saveStatus:E,lastSaved:v,lastAutoSaved:A,saveError:j,hasUnsavedChanges:N,isOnline:_,saveManually:We,performAutoSave:()=>ce(!0),loadFromLocalStorage:se,getStorageKey:ie,autoSaveInterval:ue,debounceDelay:Se}},fa=({saveStatus:r,lastSaved:i,lastAutoSaved:a,hasUnsavedChanges:g,isOnline:s,saveError:b,onManualSave:E,className:C=""})=>{const v=F=>{if(!F)return null;const k=new Date-F,N=Math.floor(k/(1e3*60)),L=Math.floor(k/1e3);if(L<30)return"hace unos segundos";if(N<1)return`hace ${L}s`;if(N<60)return`hace ${N}m`;const _=Math.floor(N/60);return _<24?`hace ${_}h`:F.toLocaleDateString()},A=(()=>{if(!s)return{icon:e.jsx(pn,{className:"w-4 h-4"}),color:"text-orange-500",bg:"bg-orange-50 border-orange-200",text:"Sin conexi√≥n",detail:"Guardado local activo"};switch(r){case"saving":return{icon:e.jsx(yo,{className:"w-4 h-4 animate-spin"}),color:"text-blue-500",bg:"bg-blue-50 border-blue-200",text:"Guardando...",detail:"Sincronizando cambios"};case"saved":return{icon:e.jsx(vo,{className:"w-4 h-4"}),color:"text-green-500",bg:"bg-green-50 border-green-200",text:"Guardado",detail:a?`Auto-guardado ${v(a)}`:"Todo sincronizado"};case"error":return{icon:e.jsx(wo,{className:"w-4 h-4"}),color:"text-red-500",bg:"bg-red-50 border-red-200",text:"Error al guardar",detail:b||"Error desconocido"};case"pending":return{icon:e.jsx(xo,{className:"w-4 h-4"}),color:"text-yellow-600",bg:"bg-yellow-50 border-yellow-200",text:g?"Cambios pendientes":"Pendiente",detail:"Esperando a guardar..."};default:return{icon:e.jsx(Tn,{className:"w-4 h-4"}),color:"text-gray-500",bg:"bg-gray-50 border-gray-200",text:"Listo",detail:"Sistema de guardado activo"}}})();return e.jsxs("div",{className:`relative group ${C}`,children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-2 px-3 py-2 rounded-lg border-2 
                    transition-all duration-200 cursor-pointer
                    ${A.bg} ${A.color}
                    hover:shadow-md
                `,onClick:()=>r!=="saving"&&(E==null?void 0:E()),children:[A.icon,e.jsx("span",{className:"text-sm font-medium",children:A.text}),e.jsx("div",{className:"flex items-center",children:s?e.jsx(Lo,{className:"w-3 h-3 text-green-500"}):e.jsx(pn,{className:"w-3 h-3 text-orange-500"})})]}),r==="saving"&&e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1 bg-blue-200 rounded-b-lg overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 animate-pulse"})})]})},Le=typeof window>"u",ft=()=>{},ba=()=>{},Ke=console.error,Ee=console.log,xa=`
    .driver-popover-banana {
        background: linear-gradient(135deg, #ffffff 0%, #faf7fb 100%);
        border: 2px solid #af5cb8;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(175, 92, 184, 0.15);
        max-width: 420px !important;
        min-width: 380px !important;
        padding: 20px !important;
    }
    
    .driver-popover-banana .driver-popover-title {
        color: #af5cb8;
        font-weight: 700;
        font-size: 20px !important;
        margin-bottom: 12px !important;
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3 !important;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .driver-popover-banana .driver-popover-description {
        color: #4a5568;
        font-size: 16px !important;
        line-height: 1.6 !important;
        margin-bottom: 20px !important;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
    }
    
    .driver-popover-banana .driver-popover-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-top: 20px !important;
        flex-wrap: wrap;
    }
    
    .driver-popover-banana .driver-popover-progress-text {
        color: #af5cb8;
        font-size: 13px !important;
        font-weight: 600;
        background: rgba(175, 92, 184, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        white-space: nowrap;
    }
    
    .driver-popover-banana .driver-popover-next-btn,
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #af5cb8 0%, #9333ea 100%);
        color: white;
        border: none;
        padding: 12px 20px !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(175, 92, 184, 0.3);
        white-space: nowrap;
        min-width: 120px;
    }
    
    .driver-popover-banana .driver-popover-next-btn:hover,
    .driver-popover-banana .driver-popover-prev-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(175, 92, 184, 0.4);
    }
    
    .driver-popover-banana .driver-popover-prev-btn {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }
    
    .driver-popover-banana .driver-popover-prev-btn:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
    }
    
    .driver-popover-banana .driver-popover-close-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .driver-popover-banana .driver-popover-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.05);
    }
    
    .driver-overlay {
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    
    .driver-highlighted-element {
        border-radius: 12px !important;
        box-shadow: 0 0 0 6px rgba(175, 92, 184, 0.8) !important, 
                    0 0 30px rgba(175, 92, 184, 0.6) !important,
                    0 0 60px rgba(175, 92, 184, 0.4) !important;
        position: relative !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .driver-highlighted-element::before {
        content: '';
        position: absolute;
        inset: -6px;
        border-radius: 12px;
        padding: 2px;
        background: linear-gradient(45deg, #af5cb8, #9333ea, #af5cb8);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask-composite: xor;
        animation: borderGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
        .driver-popover-banana {
            max-width: 95vw !important;
            min-width: 300px !important;
            margin: 10px !important;
        }
        
        .driver-popover-banana .driver-popover-title {
            font-size: 18px !important;
        }
        
        .driver-popover-banana .driver-popover-description {
            font-size: 14px !important;
        }
        
        .driver-popover-banana .driver-popover-footer {
            flex-direction: column;
            gap: 12px;
        }
        
        .driver-popover-banana .driver-popover-next-btn,
        .driver-popover-banana .driver-popover-prev-btn {
            width: 100%;
            min-width: auto;
        }
    }
`;if(typeof document<"u"){const r=document.createElement("style");r.textContent=xa,document.head.appendChild(r)}function bt(r,i){let a;return function(...s){const b=()=>{clearTimeout(a),r(...s)};clearTimeout(a),a=setTimeout(b,i)}}const wa=async(r,i,a)=>{try{const g=document.querySelector(`#page-${r.id}`);if(!g)return console.warn(`‚ùå [COMPLEX-LAYOUT] No se encontr√≥ elemento para p√°gina: ${r.id}`),null;if(!(a.cellStyles&&Object.values(a.cellStyles).some(C=>C.includes("col-span-")||C.includes("row-span-"))))return await Wt({page:r,workspaceDimensions:i,preserveFilters:!0});const{default:b}=await En(async()=>{const{default:C}=await import("./thumbnailGenerator-B4goYG9Y.js").then(v=>v.a);return{default:C}},[]),E=await b(g,{scale:2,useCORS:!0,allowTaint:!1,backgroundColor:r.backgroundColor||"#ffffff",width:i.width,height:i.height,logging:!1,onclone:C=>{var y,A,F;const v=C.querySelector(`#page-${r.id}`);if(v){v.style.display="grid",v.style.gridTemplateColumns=((y=a.template.match(/grid-cols-(\d+)/))==null?void 0:y[0])||"repeat(1, 1fr)",v.style.gridTemplateRows=((A=a.template.match(/grid-rows-(\d+)/))==null?void 0:A[0])||"repeat(1, 1fr)";const j=a.template.match(/gap-(\d+)/);j?v.style.gap=`${parseInt(j[1])*4}px`:(F=a.style)!=null&&F.gap&&(v.style.gap=a.style.gap),v.querySelectorAll("[data-cell-id]").forEach((N,L)=>{if(a.cellStyles&&a.cellStyles[L]){const _=a.cellStyles[L],W=_.match(/col-span-(\d+)/),D=_.match(/row-span-(\d+)/);W&&(N.style.gridColumn=`span ${W[1]}`),D&&(N.style.gridRow=`span ${D[1]}`)}})}}});return E?E.toDataURL("image/png",.9):null}catch(g){return console.error("‚ùå [COMPLEX-LAYOUT] Error generando thumbnail:",g),null}},va=(r,i,a)=>{var L,_;if(!r||!r.template)return a;const g=r.template;let s=1,b=1;const E=g.match(/grid-cols-(\d+)/),C=g.match(/grid-rows-(\d+)/);E&&(s=parseInt(E[1])),C&&(b=parseInt(C[1]));let v=16;const y=g.match(/gap-(\d+)/);y?v=parseInt(y[1])*4:(L=r.style)!=null&&L.gap&&(v=parseInt(r.style.gap));let A=0;(_=r.style)!=null&&_.padding&&(A=parseInt(r.style.padding)*2);const F=a.width-A-v*(s-1),j=a.height-A-v*(b-1);let k=Math.floor(F/s),N=Math.floor(j/b);if(r.cellStyles&&r.cellStyles[i]){const W=r.cellStyles[i],D=W.match(/col-span-(\d+)/),R=W.match(/row-span-(\d+)/);if(D){const H=parseInt(D[1]);k=Math.floor((F+v*(H-1))/s*H)}if(R){const H=parseInt(R[1]);N=Math.floor((j+v*(H-1))/b*H)}}return Ee(`üîß [CELL-DIMENSIONS] Layout: ${r.id}, Celda: ${i}, Grid: ${s}x${b}, Gap: ${v}px, Dims: ${k}x${N}`),{width:k,height:N}},Ht=Gt.memo(({pageId:r,thumbnail:i,altText:a,type:g})=>{const[s,b]=f.useState(!1),[E,C]=f.useState(!1);if(i&&!E)return e.jsxs("div",{className:"relative w-full h-full",children:[!s&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded"})}),e.jsx("img",{src:i,alt:a,className:`w-full h-full object-contain transition-opacity duration-200 ${s?"opacity-100":"opacity-0"}`,onLoad:()=>b(!0),onError:()=>C(!0),loading:"lazy",decoding:"async",style:{imageRendering:"optimizeQuality"}})]});const v=g==="cover"||g==="final"?xt:()=>e.jsx("div",{className:"grid grid-cols-2 gap-0.5 w-8 h-8",children:Array.from({length:4}).map((y,A)=>e.jsx("div",{className:"bg-gray-300 rounded-sm"},A))});return e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(v,{className:"w-8 h-8 mx-auto mb-1"}),e.jsx("span",{className:"text-xs",children:"Generando..."})]})})},(r,i)=>r.pageId===i.pageId&&r.thumbnail===i.thumbnail&&r.altText===i.altText&&r.type===i.type),ya=Gt.memo(({images:r,onImageSelect:i,isLoading:a})=>{const g=Gt.memo(({image:s})=>{const[b,E]=f.useState(!1),[C,v]=f.useState(!1),[y,A]=f.useState(!1),[{isDragging:F},j]=To(()=>({type:"PROJECT_IMAGE",item:{type:"PROJECT_IMAGE",imageUrl:s.url},collect:W=>({isDragging:!!W.isDragging()}),end:()=>{setTimeout(()=>A(!1),100)}})),k=s.thumbnail_url||s.url,N=s.url,L=W=>{A(!0),setTimeout(()=>A(!1),500)},_=W=>{if(y||F)return W.preventDefault(),W.stopPropagation(),!1;i(N)};return e.jsxs("div",{ref:j,className:`relative group cursor-pointer bg-gray-50 rounded-lg overflow-hidden border-2 border-transparent hover:border-[#af5cb8] transition-all duration-200 ${F?"opacity-50 scale-95":""}`,onMouseDown:L,onClick:_,children:[e.jsxs("div",{className:"aspect-square relative",children:[!b&&!C&&e.jsx("div",{className:"absolute inset-0 bg-gray-100 animate-pulse flex items-center justify-center",children:e.jsx("div",{className:"w-6 h-6 border-2 border-[#af5cb8] border-t-transparent rounded-full animate-spin"})}),C?e.jsx("div",{className:"absolute inset-0 bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Ge,{className:"h-6 w-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"Error al cargar"})]})}):e.jsx("img",{src:k,alt:s.filename||"Project image",className:`w-full h-full object-cover transition-opacity duration-300 ${b?"opacity-100":"opacity-0"}`,loading:"lazy",onLoad:()=>E(!0),onError:()=>v(!0)})]}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center",children:e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:e.jsx("div",{className:"bg-white rounded-full p-2 shadow-md",children:e.jsx(wt,{className:"h-4 w-4 text-[#af5cb8]"})})})}),e.jsx("div",{className:"absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:s.has_thumbnail?"Optimizada":"Arrastra o haz clic"}),s.has_thumbnail&&e.jsx("div",{className:"absolute top-2 left-2 bg-green-500 rounded-full w-2 h-2"})]})});return a?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((s,b)=>e.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg animate-pulse"},b))}):r.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ge,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"No hay im√°genes en este proyecto"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Sube una imagen para empezar"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:r.map((s,b)=>e.jsx(g,{image:s},`${s.id||s.url}-${b}`))}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-xs text-gray-500",children:[r.filter(s=>s.has_thumbnail).length," de ",r.length," im√°genes optimizadas"]})})]})});function Ts(){var yr,Er,Cr,Nr,Sr,Tr,jr,kr,Ar,_r,Ir,Pr,Or,Rr,Lr,Mr,$r,Br,zr,Ur,Fr,Hr,Gr,Vr,Wr,qr,Kr,Dr,Jr,Qr,Yr,Xr,Zr,en,tn,rn,nn,on,an,sn,ln;const[r,i]=f.useState(null),[a,g]=f.useState(null),[s,b]=f.useState(null),[E,C]=f.useState(null),[v,y]=f.useState(!0),[A,F]=f.useState(null),[j,k]=f.useState({hasUnsavedChanges:!1,lastEditTime:null,isSaving:!1}),[N,L]=f.useState(new Map),[_,W]=f.useState([]),[D,R]=f.useState(!1),H=f.useRef(_),ee=f.useRef(N);f.useRef(null);const J=f.useRef(null),ue=f.useRef(null);f.useEffect(()=>{H.current=_},[_]),f.useEffect(()=>{ee.current=N},[N]),f.useEffect(()=>{(async()=>{var n;try{const l=new URLSearchParams(window.location.search).get("project");if(!l){F("No se encontr√≥ el ID del proyecto en la URL"),y(!1);return}const d=await fetch(`/api/canvas/projects/${l}`,{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.content)||"","X-Requested-With":"XMLHttpRequest"}});if(!d.ok)throw new Error("Error al cargar el proyecto");const c=await d.json();i(c.project),g(c.item),b(c.canvasPreset),C(c.initialProject),y(!1)}catch(o){console.error("‚ùå Error cargando proyecto:",o),F(o.message),y(!1)}})()},[]);const[Se,Me]=f.useState(mn.Local.get(`${gn.APP_CORRELATIVE}_cart`)??[]);f.useEffect(()=>{mn.Local.set(`${gn.APP_CORRELATIVE}_cart`,Se)},[Se]);const[m,ie]=f.useState([]),[x,se]=f.useState(0),[ce,We]=f.useState("preset"),[U,Y]=f.useState(null),[q,ge]=f.useState(null),[Q,be]=f.useState("pages"),[Ct,Ce]=f.useState("basic"),[Ae,De]=f.useState([JSON.stringify(m)]),[Te,ze]=f.useState(0),[Dt,Ea]=f.useState(!1),[Ca,Jt]=f.useState(null),[te,ne]=f.useState({}),[Na,Sa]=f.useState(!1),[_e,Ue]=f.useState([]),[Nt,Qt]=f.useState(!1),[ot,$n]=f.useState(new Map),[Je,Bn]=f.useState(()=>new Map),[Qe,Yt]=f.useState(null),[Xt,Zt]=f.useState(!1);f.useEffect(()=>{Ee("‚úÖ [FILTERS] Tab actual:",Q)},[Q]),f.useCallback((t,n="manual")=>{if(Ee(`üîÑ [ACTIVE_TAB] Cambiando de "${Q}" a "${t}" - Raz√≥n: ${n}`),t==="filters"&&n!=="manual"){console.warn("üö® [ACTIVE_TAB] Cambio autom√°tico a filters bloqueado!");return}be(t)},[Q]),Le||(window.FORCE_THUMBNAIL_REGENERATION=!0,window.PREVENT_THUMBNAIL_RESET=!1,window._protectedThumbnailIds=[],window.THUMBNAIL_PROTECTED=!1,window.PRESERVE_FILTERS=!0),f.useEffect(()=>{Le||(window.forceRegenerateAllThumbnails=()=>{Ee("üí£ [EMERGENCIA-GLOBAL] Forzando regeneraci√≥n de TODOS los thumbnails"),window.thumbnailCache={},L(t=>{const n=new Map(t);return m.forEach((o,l)=>{n.set(l,Date.now())}),n}),Ee("1Ô∏è‚É£ Regenerando p√°gina actual"),oe(!0).then(()=>{Ee("‚úÖ Primera regeneraci√≥n completa"),window.BLOCK_AUTO_REGENERATION=!0,setTimeout(()=>{Ee("2Ô∏è‚É£ Ejecutando segunda regeneraci√≥n forzada"),window.forceRegenerateThumbnail&&window.forceRegenerateThumbnail(),window.THUMBNAIL_PROTECTED=!0,setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1,Ee("üîì Regeneraci√≥n autom√°tica desbloqueada")},5e3)},200)}).catch(t=>{console.error("‚ùå Error en regeneraci√≥n de emergencia:",t)})})},[m]),f.useEffect(()=>{window._protectedThumbnails||(window._protectedThumbnails=new Set),window.protectThumbnail=t=>{window._protectedThumbnails.add(t),Ee(`üõ°Ô∏è [PROTECT] Thumbnail ${t} marcado como protegido`)},window.unprotectThumbnail=t=>{window._protectedThumbnails.delete(t),Ee(`üîì [UNPROTECT] Thumbnail ${t} desprotegido`)},window.isThumbnailProtected=t=>{var n;return((n=window._protectedThumbnails)==null?void 0:n.has(t))||!1},window.blockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!0,Ee("üö´ [BLOCK AUTO] Regeneraciones autom√°ticas BLOQUEADAS")},window.unblockAutomaticRegeneration=()=>{window._blockAutoRegeneration=!1,Ee("‚úÖ [UNBLOCK AUTO] Regeneraciones autom√°ticas DESBLOQUEADAS")},window.isAutoRegenerationBlocked=()=>window._blockAutoRegeneration||!1,window._thumbnailWatchdog||(window._thumbnailWatchdog=setInterval(()=>{window._protectedThumbnailData&&window._protectedThumbnails&&Array.from(window._protectedThumbnails).forEach(n=>{const o=window._protectedThumbnailData[n];o&&ne(l=>l[n]&&l[n]!==o?(console.error(`üö® [WATCHDOG] ¬°SOBRESCRITURA DETECTADA! Restaurando ${n}`),{...l,[n]:o}):l)})},100)),window._interceptorInstalled||(window._interceptorInstalled=!0)},[]);const[at,Ye]=f.useState(!1),er=f.useRef(),[B,tr]=f.useState({width:800,height:600}),zn=f.useCallback((t,n,o="unknown")=>{var l;return(l=window.isThumbnailProtected)!=null&&l.call(window,t)?(console.error(`ÔøΩ [PROTECTION BLOCK] ¬°BLOQUEADO! Intento de sobrescribir thumbnail protegido ${t} desde: ${o}`),console.error("üö® [PROTECTION BLOCK] Stack trace:",new Error().stack),!1):(ne(d=>(d[t],{...d,[t]:n})),!0)},[]),rr=f.useMemo(()=>ua({showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,steps:[{element:"#editor-workspace",popover:{title:"¬°Bienvenido al Editor de BananaLab! üçå",description:"Este es tu lienzo de trabajo donde crear√°s dise√±os incre√≠bles. Aqu√≠ puedes ver y editar la p√°gina actual de tu proyecto.",side:"left",align:"start"}},{popover:{title:"üéØ Navegaci√≥n Principal",description:"En la barra lateral izquierda encontrar√°s todas las herramientas organizadas por categor√≠as. Cada √≠cono te lleva a una secci√≥n espec√≠fica.",side:"right",align:"center"}},{element:'[data-tab="pages"]',popover:{title:"üìÑ Secci√≥n P√°ginas",description:"Gestiona todas las p√°ginas de tu proyecto: portada, p√°ginas de contenido y contraportada. Haz clic en cualquier p√°gina para editarla.",side:"right",align:"start"}},{element:'[data-tab="templates"]',popover:{title:"üé® Secci√≥n Dise√±os",description:"Elige entre diferentes layouts y plantillas para organizar el contenido de tu p√°gina. Cada dise√±o tiene una distribuci√≥n √∫nica.",side:"right",align:"center"}},{element:'[data-tab="panel"]',popover:{title:"üìö Secci√≥n Capas",description:"Organiza y controla la superposici√≥n de elementos. Cambia el orden de las capas, oculta elementos o ajusta su posici√≥n.",side:"right",align:"center"}},{element:'[data-tab="text"]',popover:{title:"‚úçÔ∏è Secci√≥n Textos",description:"Agrega y personaliza textos: t√≠tulos, subt√≠tulos y p√°rrafos. Cambia fuentes, colores, tama√±os y efectos de texto.",side:"right",align:"center"}},{element:'[data-tab="filters"]',popover:{title:"üé≠ Secci√≥n Filtros",description:"Aplica efectos visuales a tus im√°genes: brillo, contraste, saturaci√≥n, m√°scaras y m√°s filtros profesionales.",side:"right",align:"center"}},{element:"#quick-actions-bar",popover:{title:"‚ö° Acciones R√°pidas",description:"Herramientas de acceso r√°pido: cambiar dise√±o de p√°gina, gestionar capas, agregar im√°genes y duplicar elementos.",side:"bottom",align:"center"}},{element:"#toolbar-actions",popover:{title:"üíæ Controles de Proyecto",description:"Deshacer/rehacer cambios, guardar progreso autom√°ticamente y acceder a la vista previa de tu √°lbum.",side:"bottom",align:"center"}},{element:"#preview-button",popover:{title:"üëÅÔ∏è Vista de √Ålbum",description:"Visualiza tu proyecto completo como un √°lbum real. Perfecto para revisar el resultado final antes de completar.",side:"bottom",align:"center"}},{popover:{title:"üéâ ¬°Listo para crear!",description:"Ya conoces todas las herramientas principales. Comienza seleccionando una p√°gina y agregando elementos. ¬°Divi√©rtete creando!",side:"center",align:"center"}}],nextBtnText:"Siguiente ‚Üí",prevBtnText:"‚Üê Anterior",doneBtnText:"¬°Empezar a crear! üöÄ",closeBtnText:"‚úï",progressText:"Paso {{current}} de {{total}}",overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"driver-popover-banana",onHighlightStarted:(t,n)=>{var l;const o=(l=t==null?void 0:t.getAttribute)==null?void 0:l.call(t,"data-tab");o&&Q!==o&&be(o)},onDeselected:()=>{re.success("¬°Gu√≠a completada! Ya puedes empezar a crear tu dise√±o.",{duration:3e3})}}),[Q,be]),Un=f.useCallback(()=>{rr.drive()},[rr]),St=f.useCallback(async()=>{if(r!=null&&r.id)try{const t=await fetch(`/api/thumbnails/${r.id}`);if(t.ok){const n=await t.json();if(n.success&&n.thumbnails&&n.thumbnails.length>0){const o={};n.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(o[l.page_id]=l.thumbnail_url)}),Object.keys(o).length>0&&ne(l=>{var c;console.warn("üö® [STORAGE LOAD] ¬°ALERTA! Cargando thumbnails desde storage - POSIBLE CULPABLE DE SOBRESCRITURA"),console.warn("üö® [STORAGE LOAD] Thumbnails protegidos:",Array.from(window._protectedThumbnails||[])),console.warn("üö® [STORAGE LOAD] Stack trace:",new Error().stack);const d={};for(const[h,u]of Object.entries(o))(c=window.isThumbnailProtected)!=null&&c.call(window,h)?console.warn(`üõ°Ô∏è [STORAGE PROTECTION] NO sobrescribiendo thumbnail protegido: ${h}`):d[h]=u;return{...l,...d}})}}}catch(t){console.warn("‚ö†Ô∏è Error cargando thumbnails guardados (usando locales):",t)}},[r==null?void 0:r.id]),st=f.useRef(new Map),$e=f.useRef(new Map),Tt=f.useRef(null);f.useEffect(()=>(Tt.current=setInterval(()=>{const t=Date.now(),n=10*60*1e3;for(const[o,l]of $e.current.entries())t-l.timestamp>n&&$e.current.delete(o);if(window.thumbnailCache&&typeof window.thumbnailCache=="object"){const o=Object.keys(window.thumbnailCache);if(o.length>100){const l=o.sort().slice(-60),d={};l.forEach(c=>{d[c]=window.thumbnailCache[c]}),window.thumbnailCache=d}}},3e5),()=>{Tt.current&&clearInterval(Tt.current)}),[]);const nr=f.useMemo(()=>JSON.stringify(B),[B]),oe=f.useCallback(async(t=!1)=>{var c,h,u;if(window.BLOCK_AUTO_REGENERATION&&!t)return;const n=m[x];if(!n||!B)return;console.log("pagina current actual",n);const o=n.id;if(!t){st.current.has(o)&&clearTimeout(st.current.get(o));const p=setTimeout(()=>{st.current.delete(o),oe(!0)},300);st.current.set(o,p);return}const l=`${o}-${nr}`;if(!t&&$e.current.has(l)){const p=$e.current.get(l);if(p&&Date.now()-p.timestamp<6e4)return}let d=!1;if(n.cells&&n.cells.forEach(p=>{p.elements&&p.elements.forEach(w=>{w.filters&&(w.filters.brightness!==void 0&&w.filters.brightness!==100&&w.filters.brightness!==1||w.filters.contrast!==void 0&&w.filters.contrast!==100&&w.filters.contrast!==1||w.filters.saturation!==void 0&&w.filters.saturation!==100&&w.filters.saturation!==1||w.filters.tint!==void 0&&w.filters.tint!==0||w.filters.hue!==void 0&&w.filters.hue!==0||w.filters.blur!==void 0&&w.filters.blur>0||w.filters.opacity!==void 0&&w.filters.opacity!==100&&w.filters.opacity!==1||w.filters.scale!==void 0&&w.filters.scale!==1||w.filters.rotate!==void 0&&w.filters.rotate!==0||w.filters.flipHorizontal||w.filters.flipVertical)&&(d=!0,w._hasRealFilters=!0)})}),!t&&!d&&te[o]){const p=((c=window._thumbnailGenTimes)==null?void 0:c[o])||0;if(Date.now()-p<3e5)return}if(!Ie.current){Ie.current=!0;try{window._currentPageData=n,window._workspaceDimensions=B,window._updateThumbnailInUI=(I,M)=>{var T;if((T=window.isThumbnailProtected)!=null&&T.call(window,I)){console.error(`üö® [UPDATE BLOCKED] ¬°BLOQUEADO! Intento de actualizar thumbnail protegido ${I} via _updateThumbnailInUI`),console.error("üö® [UPDATE BLOCKED] Stack trace:",new Error().stack);return}ne($=>({...$,[I]:M}))},window._thumbnailGenTimes||(window._thumbnailGenTimes={}),window._thumbnailGenTimes[o]=Date.now();let p=null;const w=ae.find(I=>I.id===n.layout)||ae[0];if(w.cellStyles&&Object.values(w.cellStyles).some(I=>I.includes("col-span-")||I.includes("row-span-"))){console.log("üèóÔ∏è [LAYOUT COMPLEJO] Usando generador especializado para layout:",w.id);try{p=await wa(n,B,w),console.log("‚úÖ [LAYOUT COMPLEJO] Thumbnail generado exitosamente")}catch(I){console.error("‚ùå [LAYOUT COMPLEJO] Error, usando fallback:",I),p=await gt(n,B)}}else if(d||t)try{p=await gt(n,B)}catch(I){console.error("‚ùå [M√âTODO RADICAL] Error, usando fallback:",I),p=await Wt({page:n,workspaceDimensions:B,preserveFilters:!0})}else p=await Wt({page:n,workspaceDimensions:B,preserveFilters:!1});if(p){if(d){(h=window.protectThumbnail)==null||h.call(window,o),(u=window.blockAutomaticRegeneration)==null||u.call(window),ne(T=>({...T,[o]:p})),setTimeout(()=>{ne(T=>T[o]!==p?(ba(`üö® [PROTECTION RESTORE] Restaurando thumbnail protegido para ${o}`),{...T,[o]:p}):T)},100);const M=()=>{ne(T=>T[o]!==p?(Ke(`üö® [EMERGENCY RESTORE] ¬°PARPADEO DETECTADO! Restaurando thumbnail para ${o}`),{...T,[o]:p}):T)};setTimeout(M,200),setTimeout(M,500),setTimeout(M,1e3),setTimeout(M,2e3),window._protectedThumbnailData||(window._protectedThumbnailData={}),window._protectedThumbnailData[o]=p}else zn(o,p,"generateCurrentPageThumbnail");d&&!t&&(window._filterVerificationDone||(window._filterVerificationDone=new Set),window._filterVerificationDone.has(o)||(window._filterVerificationDone.add(o),setTimeout(async()=>{var M;try{const T=await gt(n,B);T&&((M=window.protectThumbnail)==null||M.call(window,o),ne($=>({...$,[o]:T})))}catch(T){console.warn("‚ö†Ô∏è [RADICAL FALLBACK] Error en m√©todo radical:",T)}},1e3))),d&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(o)||window._protectedThumbnailIds.push(o));const I=`${o}-${nr}`;if($e.current.set(I,{data:p,timestamp:Date.now(),hasFilters:d}),$e.current.size>50){const M=$e.current.keys().next().value;$e.current.delete(M)}}else console.error(`‚ùå [ERROR] No se pudo generar thumbnail para p√°gina: ${o}`)}catch(p){console.error(`‚ùå [CRITICAL ERROR] Error generando thumbnail para p√°gina ${o}:`,p)}finally{Ie.current=!1}}},[m,x,B,te]),jt=f.useCallback(bt(async()=>{var t;if(!window.BLOCK_AUTO_REGENERATION&&!window.THUMBNAIL_PROTECTED&&!(!(m!=null&&m.length)||!B)&&!Ie.current){Ie.current=!0;try{const n=m.filter(l=>!te[l.id]);if(n.length===0)return;if((t=window.isAutoRegenerationBlocked)!=null&&t.call(window)){console.warn("üö´ [BLOCKED] Regeneraci√≥n autom√°tica bloqueada, saltando generateFastThumbnails");return}const o=await hn({pages:n,workspaceDimensions:B,onProgress:l=>{Yt(l)}});o&&Object.keys(o).length>0&&ne(l=>{var c;console.warn("üö® [FAST THUMBNAILS] ¬°ALERTA! generateFastThumbnails sobrescribiendo thumbnails - POSIBLE CULPABLE"),console.warn("üö® [FAST THUMBNAILS] Stack trace:",new Error().stack);const d={};for(const[h,u]of Object.entries(o))(c=window.isThumbnailProtected)!=null&&c.call(window,h)?console.warn(`üõ°Ô∏è [FAST PROTECTION] NO sobrescribiendo thumbnail protegido: ${h}`):d[h]=u;return{...l,...d}})}catch(n){console.warn("‚ö†Ô∏è Error generando thumbnails r√°pidos:",n)}finally{Ie.current=!1,Yt(null)}}},300),[m,B,te]),Ie=f.useRef(!1);f.useCallback(async(t=[])=>{var n;if(!Ie.current)try{if(Ie.current=!0,t.length>0){const o=m.filter(l=>t.includes(l.id));if(o.length>0)if((n=window.isAutoRegenerationBlocked)!=null&&n.call(window))console.warn("üö´ [BLOCKED] Regeneraci√≥n de prioridad bloqueada, saltando generateFastThumbnails");else{const l=await hn({pages:o,workspaceDimensions:B});l&&Object.keys(l).length>0&&ne(d=>{var h;console.warn("üö® [PRIORITY THUMBNAILS] ¬°ALERTA! generateFastThumbnails de prioridad sobrescribiendo - POSIBLE CULPABLE"),console.warn("üö® [PRIORITY THUMBNAILS] Stack trace:",new Error().stack);const c={};for(const[u,p]of Object.entries(l))(h=window.isThumbnailProtected)!=null&&h.call(window,u)?console.warn(`üõ°Ô∏è [PRIORITY PROTECTION] NO sobrescribiendo thumbnail protegido: ${u}`):c[u]=p;return{...d,...c}})}}}catch(o){console.warn("‚ö†Ô∏è Error en generaci√≥n prioritaria:",o)}finally{Ie.current=!1}},[m,B,jt]);const or=f.useCallback(t=>{if(Je.has&&Je.has(t))return;const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{if(n.width>1200||n.height>1200){const l=document.createElement("canvas"),d=l.getContext("2d"),c=1200,h=Math.min(c/n.width,c/n.height),u=n.width*h,p=n.height*h;l.width=u,l.height=p,d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.drawImage(n,0,0,u,p),l.toBlob(w=>{if(w){const P=URL.createObjectURL(w);Bn(I=>{const M=new Map(I);if(M.set(t,P),M.size>15){const T=M.keys().next().value,$=M.get(T);URL.revokeObjectURL($),M.delete(T)}return M})}},"image/webp",.85)}},n.onerror=()=>{console.warn("‚ùå Error pre-cargando imagen:",t)},n.src=t},[]);f.useEffect(()=>{_e.length>0&&_e.slice(0,10).forEach((n,o)=>{setTimeout(()=>{or(n.url)},o*100)})},[_e,or]),f.useEffect(()=>()=>{Je&&Je.forEach&&Je.forEach(t=>URL.revokeObjectURL(t))},[]),f.useEffect(()=>()=>{Ut()},[]);const ar=f.useCallback(async()=>{var t;if(!(!(r!=null&&r.id)||!(m!=null&&m.length))&&!Xt)try{Zt(!0);const n=await fetch(`/api/thumbnails/${r.id}/existing`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({pages:m})});if(n.ok){const o=await n.json();o&&Object.keys(o).length>0?ne(l=>({...l,...o})):setTimeout(()=>oe(),200)}}catch(n){console.warn("‚ö†Ô∏è Error cargando thumbnails existentes:",n),setTimeout(()=>oe(),200)}finally{Zt(!1)}},[r==null?void 0:r.id,m,oe,Xt]);f.useCallback(async()=>{if(!(!(r!=null&&r.id)||!(m!=null&&m.length)))try{const t=m[x];if(!t)return;const n=await fetch(`/api/thumbnails/${r.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:[t],width:B.width,height:B.height,quality:95,scale:4,dpi:300})});if(n.ok){const o=await n.json();if(o.success&&o.thumbnails){const l={};o.thumbnails.forEach(d=>{d.page_id&&d.thumbnail_url&&(l[d.page_id]=d.thumbnail_url)}),ne(d=>({...d,...l}))}}}catch(t){console.warn("‚ö†Ô∏è Error generando thumbnail:",t)}},[r==null?void 0:r.id,m,x,B]),f.useCallback(async()=>{if(!(!(r!=null&&r.id)||!(m!=null&&m.length)))try{const t=await fetch(`/api/thumbnails/${r.id}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({pages:m,width:B.width,height:B.height,quality:95,scale:4,dpi:300})});if(t.ok){const n=await t.json();if(n.success&&n.thumbnails){const o={};n.thumbnails.forEach(l=>{l.page_id&&l.thumbnail_url&&(o[l.page_id]=l.thumbnail_url)}),ne(l=>({...l,...o}))}}}catch(t){console.warn("‚ö†Ô∏è Error generando todos los thumbnails:",t)}},[r==null?void 0:r.id,m,B]);const Fn=f.useCallback(async(t=null)=>{if(!(r!=null&&r.id)||!(m!=null&&m.length))return{};try{const n={},o={};let l=0;const d=async(h,u)=>new Promise(p=>{const w=new Image;w.onload=()=>{o[u]=h,l++,t==null||t(l,m.length),p(!0)},w.onerror=()=>{console.warn(`‚ö†Ô∏è [ALBUM-MODAL] Thumbnail no encontrado: ${h}`),l++,t==null||t(l,m.length),p(!1)},w.src=h}),c=m.map(async(h,u)=>{let p;const w=a&&(a.has_cover_image===!0||a.has_cover_image===1),P=a&&(a.has_back_cover_image===!0||a.has_back_cover_image===1),I=w&&m.some(S=>S.type==="cover"),M=P&&m.some(S=>S.type==="final");if(h.type==="cover")p=0;else if(h.type==="content")I?p=m.filter(O=>O.type==="content").findIndex(O=>O.id===h.id)+1:p=m.filter(O=>O.type==="content").findIndex(O=>O.id===h.id)+1;else if(h.type==="final"){const S=m.filter(O=>O.type==="content");p=S.length+1}else p=u;const T=`/storage/images/thumbnails/${r.id}/page-${p}-pdf.png`,$=h.id||`page-${u}`;return n[$]=T,d(T,$)});return await Promise.all(c),n}catch(n){return console.warn("‚ö†Ô∏è [ALBUM-MODAL] Error cargando thumbnails PDF:",n),{}}},[r==null?void 0:r.id,m,a]);f.useEffect(()=>{if(E&&a&&s){if(E.pages&&Array.isArray(E.pages)){const t=E.pages.map(n=>{let o=null,l=s.background_color||"#ffffff";return n.type==="cover"&&(a.has_cover_image===!0||a.has_cover_image===1)?a.cover_image&&(o=`/storage/images/item/${a.cover_image}`):n.type==="content"?a.content_image&&(o=`/storage/images/item/${a.content_image}`):(n.type==="final"||n.type==="contraportada")&&(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&a.back_cover_image&&(o=`/storage/images/item/${a.back_cover_image}`),{...n,backgroundImage:o,backgroundColor:l}}).filter(n=>!(n.type==="cover"&&(a.has_cover_image===!1||a.has_cover_image===0)||(n.type==="final"||n.type==="contraportada")&&(a.has_back_cover_image===!1||a.has_back_cover_image===0)));ie(n=>n.length>0?n.map((o,l)=>{const d=t[l];return d?{...o,backgroundImage:o.backgroundImage||d.backgroundImage,backgroundColor:o.backgroundColor||d.backgroundColor}:o}):t),De(n=>n.length<=1?[JSON.stringify(t)]:n),ze(n=>n===0&&Ae.length<=1?0:n),setTimeout(()=>{St()},100)}else{const t=hr(s,a);ie(t),De([JSON.stringify(t)]),ze(0),setTimeout(()=>{St()},100)}typeof E.currentPage=="number"&&se(E.currentPage),E.workspaceSize&&We(E.workspaceSize)}},[E,a,s,St]);const Pe=ha(m,r,a,s,B,te),sr=()=>{if(s!=null&&s.width&&(s!=null&&s.height)){let u=s.width,p=s.height,w=u*37.8,P=p*37.8;if(w&&P){const I=window.innerWidth*.6,M=window.innerHeight*.7,T=I/w,$=M/P,S=Math.min(T,$,1);return{width:Math.round(w*S),height:Math.round(P*S),originalWidth:u,originalHeight:p,scale:S,unit:"cm",originalWidthPx:Math.round(w),originalHeightPx:Math.round(P)}}}if(s!=null&&s.extra_settings)try{const u=typeof s.extra_settings=="string"?JSON.parse(s.extra_settings):s.extra_settings;if(u!=null&&u.canvas_config){const p=u.canvas_config;let w=p.width,P=p.height,I=w*37.8,M=P*37.8;if(I&&M){const T=window.innerWidth*.6,$=window.innerHeight*.7,S=T/I,G=$/M,O=Math.min(S,G,1);return{width:Math.round(I*O),height:Math.round(M*O),originalWidth:w,originalHeight:P,scale:O,unit:"cm",originalWidthPx:Math.round(I),originalHeightPx:Math.round(M)}}}}catch(u){console.warn("Error parsing extra_settings:",u)}const t={square:{width:600,height:600},landscape:{width:1280,height:720},portrait:{width:600,height:800},wide:{width:1200,height:600},tall:{width:540,height:960},preset:{width:800,height:600}},n=t[ce]||t.preset,o=Le?1200:window.innerWidth*.6,l=Le?800:window.innerHeight*.7,d=o/n.width,c=l/n.height,h=Math.min(d,c,1);return{width:Math.round(n.width*h),height:Math.round(n.height*h),originalWidth:n.width,originalHeight:n.height,scale:h,unit:"px"}},Oe=f.useCallback(async(t={type:"thumbnail"})=>{var n;if(Le)return Ke("üö´ [VPS-PROTECTION] captureCurrentWorkspace bloqueado en servidor"),null;if(!m[x])return null;try{let o=document.querySelector(`#page-${m[x].id}`);if(!o)return console.warn("‚ùå THUMBNAIL: No se encontr√≥ el elemento de p√°gina espec√≠fico"),null;const l=m[x],c=(l==null?void 0:l.cells)&&l.cells.length>0&&o.classList.contains("grid");Ee(`üîß [CAPTURE-MODE] P√°gina ${x}: ${c?"LAYOUT":"LIBRE"}, Celdas: ${((n=l==null?void 0:l.cells)==null?void 0:n.length)||0}`),c&&await new Promise(G=>{requestAnimationFrame(()=>{const O=o.querySelectorAll("[data-cell-id]");G()})});const h=t.type==="pdf",u=!0,p=h?11.81:u?2:3,w=1,P=getComputedStyle(o);let I=(l==null?void 0:l.backgroundColor)||"#ffffff";P.backgroundColor&&P.backgroundColor!=="rgba(0, 0, 0, 0)"&&(I=P.backgroundColor);const M={scale:p,useCORS:!0,allowTaint:!1,backgroundColor:I,width:B.width,height:B.height,x:0,y:0,scrollX:0,scrollY:0,...c&&{windowWidth:B.width,windowHeight:B.height,ignoreElements:S=>{var G;return S.style&&S.style.filter&&t.preserveFilters?!1:(G=S.classList)==null?void 0:G.contains("exclude-from-capture")}},...!c&&{ignoreElements:S=>{var G;return S.style&&S.style.filter&&t.preserveFilters?!1:(G=S.classList)==null?void 0:G.contains("exclude-from-capture")}},foreignObjectRendering:!!(h||c),removeContainer:!1,logging:!!(c&&!u),imageTimeout:h?6e4:c?u?15e3:3e4:15e3,pixelRatio:h?3:u||Le?1:window.devicePixelRatio||1,...c&&{allowTaint:!0,useCORS:!0,letterRendering:!u,ignoreElements:S=>{var G,O;return((G=S.classList)==null?void 0:G.contains("exclude-from-capture"))||((O=S.classList)==null?void 0:O.contains("ui-element"))}},canvas:h?document.createElement("canvas"):null,windowWidth:h?B.width*p:null,windowHeight:h?B.height*p:null,onclone:async S=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(O=>{try{S.querySelectorAll(O).forEach(we=>we.remove())}catch(K){console.warn("Error removing selector:",O,K)}});try{const O=S.querySelector(`#page-${m[x].id}`);if(O){if(O.style.width=B.width+"px",O.style.height=B.height+"px",c||(O.style.position="relative"),O.style.overflow="hidden",l!=null&&l.backgroundImage&&(O.style.backgroundImage=`url(${l.backgroundImage})`,O.style.backgroundSize="cover",O.style.backgroundPosition="center",O.style.backgroundRepeat="no-repeat"),O.querySelectorAll('[style*="filter"]').forEach(we=>{}),c){const we=O.className,Fe=getComputedStyle(o);O.style.display="grid",O.style.gridTemplateColumns=Fe.gridTemplateColumns,O.style.gridTemplateRows=Fe.gridTemplateRows,O.style.gap=Fe.gap,O.querySelectorAll("[data-cell-id]").forEach((ve,Z)=>{const ye=o.querySelector(`[data-cell-id="${ve.getAttribute("data-cell-id")}"]`);if(ye){const he=getComputedStyle(ye);ve.style.gridColumn=he.gridColumn,ve.style.gridRow=he.gridRow,ve.style.position="relative"}ve.querySelectorAll('img, [data-element-type="image"]').forEach(he=>{he.style.position==="absolute"&&(he.style.position="absolute")})})}l!=null&&l.backgroundColor&&(O.style.backgroundColor=l.backgroundColor)}}catch(O){console.error("‚ùå [THUMBNAIL-FIX] Error configurando elemento de p√°gina:",O)}try{const O=new Map;o.querySelectorAll('[data-element-type="image"] img, .workspace-image, img').forEach((Z,ye)=>{if(Z.complete&&Z.naturalWidth>0){const he=(Z.closest('[data-element-type="image"]')||Z.parentElement).getBoundingClientRect(),He=Z.getBoundingClientRect();O.set(Z.src,{src:Z.src,naturalWidth:Z.naturalWidth,naturalHeight:Z.naturalHeight,containerWidth:he.width,containerHeight:he.height,objectFit:getComputedStyle(Z).objectFit||"cover",objectPosition:getComputedStyle(Z).objectPosition||"center",crossOrigin:Z.crossOrigin})}});const we=async(Z,ye,fe,he,He)=>new Promise(lt=>{try{const tt=ye/fe,Rt=he/He;let ct,dt,Lt,Mt,cn,dn;Rt>tt?(dn=fe,cn=fe*Rt,dt=He,ct=He*tt,Lt=(he-ct)/2,Mt=0):(cn=ye,dn=ye/Rt,ct=he,dt=he/tt,Lt=0,Mt=(He-dt)/2);const ut=S.createElement("canvas");ut.width=ye,ut.height=fe;const ao=ut.getContext("2d"),rt=new Image;rt.crossOrigin="anonymous",rt.onload=()=>{try{ao.drawImage(rt,Lt,Mt,ct,dt,0,0,ye,fe);const $t=ut.toDataURL("image/png",1);Z.src=$t,Z.style.objectFit="fill",Z.style.objectPosition="center",Z.style.width="100%",Z.style.height="100%",lt()}catch($t){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en canvas processing:",$t),lt()}},rt.onerror=()=>{console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error cargando imagen temporal"),lt()},rt.src=Z.src}catch(tt){console.warn("‚ö†Ô∏è [ADVANCED-THUMBNAIL] Error en simulateObjectFitCover:",tt),lt()}}),Fe=S.querySelectorAll('[data-element-type="image"] img, .workspace-image, img'),Re=[];Fe.forEach((Z,ye)=>{if(Z.src&&O.has(Z.src)){const fe=O.get(Z.src),he=Z.closest('[data-element-type="image"]')||Z.parentElement;if(he&&(he.style.overflow="hidden",he.style.position="relative"),fe.objectFit==="cover"||Z.classList.contains("object-cover")||Z.classList.contains("workspace-image")){const He=we(Z,fe.containerWidth,fe.containerHeight,fe.naturalWidth,fe.naturalHeight);Re.push(He)}else Z.style.width="100%",Z.style.height="100%",Z.style.objectFit="fill"}}),Re.length>0&&await Promise.all(Re);const ve=S.createElement("style");ve.textContent=`
                            /* CORRECCI√ìN THUMBNAIL: Estructura del elemento de p√°gina */
                            #page-${m[x].id} {
                                width: ${B.width}px !important;
                                height: ${B.height}px !important;
                                position: relative !important;
                                overflow: hidden !important;
                                box-sizing: border-box !important;
                            }
                            
                            /* üñ®Ô∏è IM√ÅGENES PROFESIONALES: Optimizada para PDF vs Thumbnails */
                            img {
                                width: 100% !important;
                                height: 100% !important;
                                object-fit: fill !important; /* fill porque ya est√°n recortadas */
                                object-position: center !important;
                                display: block !important;
                                ${h?`
                                /* üñ®Ô∏è IMPRESI√ìN PROFESIONAL 300 DPI */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: -webkit-crisp-edges !important;
                                image-rendering: -moz-crisp-edges !important;
                                image-rendering: pixelated !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: optimizeQuality !important;
                                backface-visibility: hidden !important;
                                transform: translateZ(0) scale(1) !important;
                                will-change: transform !important;
                                filter: contrast(1.02) saturate(1.05) !important;
                                `:`
                                /* Thumbnails optimizados */
                                image-rendering: -webkit-optimize-contrast !important;
                                image-rendering: crisp-edges !important;
                                image-rendering: high-quality !important;
                                `}
                            }
                            
                            /* Contenedores de imagen */
                            [data-element-type="image"] {
                                overflow: hidden !important;
                                position: relative !important;
                            }
                            
                            [data-element-type="image"] > div {
                                width: 100% !important;
                                height: 100% !important;
                                overflow: hidden !important;
                            }
                            
                            /* Backgrounds de p√°gina */
                            #page-${m[x].id} {
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                            
                            /* üñ®Ô∏è OPTIMIZACIONES GENERALES PARA PDF DE IMPRESI√ìN */
                            ${h?`
                            * {
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                text-rendering: optimizeLegibility !important;
                                -webkit-backface-visibility: hidden !important;
                                backface-visibility: hidden !important;
                                -webkit-transform: translateZ(0) !important;
                                transform: translateZ(0) !important;
                            }
                            
                            /* Elementos de texto de alta calidad */
                            p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable] {
                                text-rendering: optimizeLegibility !important;
                                -webkit-font-smoothing: antialiased !important;
                                -moz-osx-font-smoothing: grayscale !important;
                                font-smooth: always !important;
                            }
                            
                            /* Elementos vectoriales de alta calidad */
                            svg, path, circle, rect, line {
                                shape-rendering: geometricPrecision !important;
                                vector-effect: non-scaling-stroke !important;
                            }
                            `:""}
                            
                            /* Resetear estilos que puedan interferir */
                            img {
                                max-width: none !important;
                                max-height: none !important;
                                border: none !important;
                                outline: none !important;
                            }
                        `,S.head.appendChild(ve)}catch(O){console.error("‚ùå [ADVANCED-THUMBNAIL] Error en pre-procesamiento avanzado:",O);const K=S.createElement("style");K.textContent=`
                            img { object-fit: cover !important; object-position: center !important; }
                            [data-element-type="image"] { overflow: hidden !important; }
                        `,S.head.appendChild(K)}}};let T=null,$="";try{if(T=await Vt(o,M),h&&T){const S=T.getContext("2d");if(S){S.imageSmoothingEnabled=!1,S.imageSmoothingQuality="high";const G=S.getImageData(0,0,T.width,T.height),O=G.data;for(let K=0;K<O.length;K+=4)O[K]=Math.min(255,O[K]*1.05),O[K+1]=Math.min(255,O[K+1]*1.05),O[K+2]=Math.min(255,O[K+2]*1.05);S.putImageData(G,0,0)}}if(!T)throw new Error("html2canvas no devolvi√≥ un canvas v√°lido para el elemento de p√°gina");if(T.width===0||T.height===0)throw new Error("Canvas del elemento de p√°gina tiene dimensiones inv√°lidas");$=T.toDataURL("image/png",w)}catch(S){throw console.error("‚ùå [ERROR-CAPTURA]:",S),S}finally{if(T){const S=T.getContext("2d");S&&S.clearRect(0,0,T.width,T.height),T.width=0,T.height=0,T=null}if(u&&window.gc)try{window.gc()}catch{}}if(!$||$==="data:,")throw new Error("No se pudo generar dataURL del elemento de p√°gina");return h?T:$}catch(o){console.error("‚ùå [THUMBNAIL-FIX] Error capturando elemento de p√°gina:",o);try{const l=document.createElement("canvas"),d=t.type==="pdf"?11.81:1;l.width=B.width*d,l.height=B.height*d;const c=l.getContext("2d"),h=workspaceBackground||(currentPageData==null?void 0:currentPageData.backgroundColor)||"#ffffff";return c.fillStyle=h,c.fillRect(0,0,l.width,l.height),c.fillStyle=h==="#ffffff"||h.includes("white")?"#374151":"#666666",c.font=`${14*d}px Arial`,c.textAlign="center",c.fillText("P√°gina "+(x+1),l.width/2,l.height/2),t.type==="pdf"?l:l.toDataURL("image/png",1)}catch{return null}}},[x,m]);f.useCallback(async()=>{if(!m[x])return;const t=await Oe({type:"thumbnail"});t&&ne(n=>({...n,[m[x].id]:t}))},[Oe,x,m]),f.useCallback(()=>{clearTimeout(er.current),er.current=setTimeout(()=>{m[x]&&(ne(t=>{const n={...t};return delete n[m[x].id],n}),setTimeout(()=>{oe()},200))},1e3)},[m,x,oe]);const Hn=f.useCallback(()=>{m[x]&&(ne(t=>{const n={...t};return delete n[m[x].id],n}),setTimeout(()=>{oe()},300))},[m,x,oe]),Gn=f.useCallback(async(t=x,n={width:800,height:600})=>{var o,l;if(!m[t])return null;try{const d=x;t!==x&&(se(t),await new Promise(p=>setTimeout(p,100)));const c=document.querySelector(`#page-${m[t].id}`);if(!c)return console.warn("Workspace element not found for page:",m[t].id),null;const h={scale:4,useCORS:!0,allowTaint:!1,backgroundColor:((o=m[t])==null?void 0:o.backgroundColor)||"#ffffff",width:c.offsetWidth,height:c.offsetHeight,removeContainer:!0,logging:!1,onclone:p=>{[".toolbar",".ui-element",".floating",".overlay",".modal",".popover",".text-toolbar",".element-selector",".element-controls",".resize-handle",".resize-control-handle",".resize-manipulation-indicator",".sidebar",".panel",".btn",".button",".control",".menu",".dropdown",".tooltip",".pointer-events-none",'[data-exclude-thumbnail="true"]'].forEach(T=>{p.querySelectorAll(T).forEach(S=>S.remove())});const P=p.querySelector(`#page-${m[t].id}`);if(P){const T=m[t];T!=null&&T.backgroundImage&&(P.style.backgroundImage=`url(${T.backgroundImage})`,P.style.backgroundSize="cover",P.style.backgroundPosition="center",P.style.backgroundRepeat="no-repeat"),T!=null&&T.backgroundColor&&(P.style.backgroundColor=T.backgroundColor)}try{const T=c.querySelectorAll("img"),$=new Map;T.forEach((G,O)=>{const K=getComputedStyle(G);$.set(O,{objectFit:K.objectFit,objectPosition:K.objectPosition,width:K.width,height:K.height,borderRadius:K.borderRadius,transform:K.transform})}),p.querySelectorAll("img").forEach((G,O)=>{const K=$.get(O);K&&(G.style.objectFit=K.objectFit||"cover",G.style.objectPosition=K.objectPosition||"center",G.style.width=K.width,G.style.height=K.height,G.style.borderRadius=K.borderRadius,G.style.transform=K.transform)})}catch(T){console.warn("Error preservando estilos de im√°genes:",T),p.querySelectorAll("img").forEach(S=>{S.style.objectFit="cover",S.style.objectPosition="center",S.style.width||(S.style.width="100%"),S.style.height||(S.style.height="100%")})}p.querySelectorAll('[class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6, [contenteditable]').forEach(T=>{const $=T.className;$&&(T.className=$);const S=getComputedStyle?getComputedStyle(T):null;S&&(S.fontFamily&&S.fontFamily!=="Arial"&&(T.style.fontFamily=S.fontFamily),S.fontSize&&(T.style.fontSize=S.fontSize),S.fontWeight&&(T.style.fontWeight=S.fontWeight),S.fontStyle&&(T.style.fontStyle=S.fontStyle))});const M=p.createElement("style");M.textContent=`
                        /* Preservar fuentes originales y NO forzar Arial */
                        * { 
                            -webkit-font-smoothing: antialiased !important;
                            -moz-osx-font-smoothing: grayscale !important;
                        }
                        
                        /* CR√çTICO: Asegurar que las im√°genes mantengan cover + CALIDAD HD */
                        img {
                            object-fit: cover !important;
                            object-position: center !important;
                            image-rendering: -webkit-optimize-contrast !important;
                            image-rendering: crisp-edges !important;
                            image-rendering: high-quality !important;
                        }
                        
                        /* CR√çTICO: Asegurar que los backgrounds de p√°gina se mantengan en cover */
                        [id^="page-"] {
                            background-size: cover !important;
                            background-position: center !important;
                            background-repeat: no-repeat !important;
                        }
                        
                        /* Asegurar que los elementos de texto mantengan sus fuentes */
                        [class*="text-"], p, span, div, h1, h2, h3, h4, h5, h6 {
                            font-family: inherit !important;
                        }
                    `,p.head.appendChild(M)}},u=await Vt(c,h);if(n.width!==u.width||n.height!==u.height){const p=document.createElement("canvas");p.width=n.width,p.height=n.height;const w=p.getContext("2d"),P=u.width/u.height,I=n.width/n.height;let M,T,$=0,S=0;P>I?(M=n.width,T=n.width/P,S=(n.height-T)/2):(T=n.height,M=n.height*P,$=(n.width-M)/2),w.fillStyle=((l=m[t])==null?void 0:l.backgroundColor)||"#ffffff",w.fillRect(0,0,n.width,n.height),w.drawImage(u,$,S,M,T);const G=p.toDataURL("image/png",1);return t!==d&&se(d),G}return t!==d&&se(d),u.toDataURL("image/png",1)}catch(d){return console.error("‚ùå Error generando thumbnail de alta calidad:",d),null}},[m,x,se]);f.useEffect(()=>{const t=sr();tr(t)},[s,ce]),f.useEffect(()=>{const t=()=>{const n=sr();tr(n)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s,ce]),f.useEffect(()=>{if(!Le&&m[x]&&!te[m[x].id]){const t=setTimeout(()=>{oe()},500);return()=>clearTimeout(t)}},[x,m,te,oe]),f.useEffect(()=>{const t=m[x];t!=null&&t.backgroundImage&&fetch(t.backgroundImage,{method:"HEAD"}).then(n=>{n.ok||console.error("‚ùå [WORKSPACE] Imagen NO existe en el servidor. Status:",n.status)}).catch(n=>{console.error("‚ùå [WORKSPACE] Error verificando imagen:",n)})},[x,(yr=m[x])==null?void 0:yr.backgroundImage]),f.useEffect(()=>{const t=`${B.width}x${B.height}`,n=sessionStorage.getItem("lastWorkspaceDimensions");n&&n!==t&&m.length>0&&(ne({}),setTimeout(()=>{m[x]&&Hn()},800)),sessionStorage.setItem("lastWorkspaceDimensions",t)},[B.width,B.height]),f.useEffect(()=>{if(!(r!=null&&r.id)||m.length===0)return;let t,n=Date.now(),o=!1;const l=()=>{o=!0,n=Date.now()},d=async()=>{if(o)try{setAutoSave(p=>({...p,saveStatus:"saving"}));const h=await fetch(`/api/projects/${r.id}/save`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({pages:m,force:!1})}),u=await h.json();if(h.ok&&u.success)o=!1,k(p=>({...p,saveStatus:"saved",lastAutoSaved:new Date,hasUnsavedChanges:!1}));else throw new Error("Guardado fall√≥")}catch(h){console.error("‚ùå [AUTO-SAVE] Error en guardado silencioso:",h),k(u=>({...u,saveStatus:"error",saveError:h.message}))}},c=()=>{t=setInterval(()=>{const h=Date.now()-n;o&&h>6e4&&d()},3*60*1e3)};return JSON.stringify(m),m[x],l(),c(),()=>{t&&clearInterval(t)}},[m,x,r==null?void 0:r.id]),f.useEffect(()=>{var n;if(!m[x])return;const t=((n=m[x].cells)==null?void 0:n.flatMap(o=>o.elements))||[];JSON.stringify(t),k(o=>({...o,hasUnsavedChanges:!0}))},[(Er=m[x])==null?void 0:Er.cells,x]);const[Ta,kt]=f.useState(!1),[ja,Vn]=f.useState({elementId:null,cellId:null}),[Wn,ir]=f.useState(!1),[ka,qn]=f.useState(!1),[Aa,_a]=f.useState(null),[Kn,Dn]=f.useState({isLoading:!1,loadedImages:0,totalImages:0,message:""}),[Be,xe]=f.useState({isOpen:!1,phase:"preparing",progress:0,message:"Iniciando experiencia de √°lbum...",subMessage:"Preparando tu vista previa personalizada"}),At=f.useRef(null),lr=t=>{var l,d,c,h;const n=q||((d=(l=m[x])==null?void 0:l.cells[0])==null?void 0:d.id);if(!n)return;const o={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((h=(c=m[x].cells.find(u=>u.id===n))==null?void 0:c.elements)==null?void 0:h.length)||0)+1};et(n,o),re.success("Imagen a√±adida correctamente")},_t=f.useCallback(bt(async(t=!1)=>{if(!(r!=null&&r.id))return;const n=ot.get(r.id);if(!t&&n&&n.length>0){_e.length===0&&Ue(n);return}if(J.current&&clearTimeout(J.current),!(Nt&&!t)){Qt(!0);try{const o=new AbortController,l=setTimeout(()=>o.abort(),1e4),d=await fetch(`/api/canvas/projects/${r.id}/images`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"},signal:o.signal});if(clearTimeout(l),!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const c=await d.json();if(c.success){const h=c.images||[],u=JSON.stringify(_e),p=JSON.stringify(h);u!==p&&(Ue(h),$n(w=>{const P=new Map(w);if(P.set(r.id,h),P.size>5){const I=P.keys().next().value;P.delete(I)}return P}))}else console.error("Error cargando im√°genes:",c.message),re.error("Error cargando galer√≠a de im√°genes")}catch(o){o.name==="AbortError"?console.warn("‚ö†Ô∏è Carga de im√°genes cancelada por timeout"):(console.error("Error cargando im√°genes del proyecto:",o),re.error("Error de conexi√≥n al cargar im√°genes"))}finally{Qt(!1)}}},200),[r==null?void 0:r.id,ot,_e,Nt]),Jn=f.useCallback(async t=>{const n=t.target.files[0];if(!n||!(r!=null&&r.id))return;const o=re.loading("Subiendo imagen...",{description:"Procesando imagen, esto puede tomar unos segundos"}),l=URL.createObjectURL(n),d={id:`temp-${Date.now()}`,filename:n.name,url:l,thumbnail_url:l,has_thumbnail:!1,size:n.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString(),isTemporary:!0};Ue(h=>[d,...h]),lr(l);const c=new FormData;c.append("image",n),c.append("projectId",r.id);try{const u=await(await fetch("/api/canvas/editor/upload-image",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:c})).json();if(u.success){const p={id:u.id||Date.now(),filename:n.name,url:u.url,thumbnail_url:u.thumbnail_url||u.url,has_thumbnail:u.has_thumbnail||!1,size:n.size,last_modified:Date.now()/1e3,created_at:new Date().toISOString()};Ue(w=>[p,...w.filter(P=>P.id!==d.id)]),setTimeout(()=>{ie(w=>{const P=[...w];return P[x].cells.forEach(M=>{M.elements.forEach(T=>{T.type==="image"&&T.content===l&&(T.content=u.url)})}),P})},100),re.dismiss(o),re.success(u.has_thumbnail?"Imagen subida y optimizada correctamente":"Imagen subida correctamente"),setTimeout(()=>{_t(!0)},2e3)}else Ue(p=>p.filter(w=>w.id!==d.id)),URL.revokeObjectURL(l),re.dismiss(o),re.error(u.message||"Error al subir la imagen")}catch(h){console.error("Error subiendo la imagen:",h),Ue(u=>u.filter(p=>p.id!==d.id)),URL.revokeObjectURL(l),re.dismiss(o),re.error("Error de red al subir la imagen")}},[r==null?void 0:r.id,x,lr,_t]);f.useEffect(()=>{if(r!=null&&r.id){const t=ot.get(r.id);if(t&&t.length>0){Ue(t);return}return J.current=setTimeout(()=>{_t(!1)},150),()=>{J.current&&clearTimeout(J.current)}}},[r==null?void 0:r.id,ot]),f.useEffect(()=>()=>{J.current&&clearTimeout(J.current)},[]);const cr=(t,n)=>{if(!m||m.length===0||!m[x]){console.error("‚ùå [ADD-IMAGE] No hay p√°ginas v√°lidas para agregar imagen");return}const o=JSON.parse(JSON.stringify(m));let l=!1;for(let d=0;d<o[x].cells.length;d++)if(o[x].cells[d].id===t){o[x].cells[d].elements.push(n),l=!0;break}if(!l){console.error("‚ùå [ADD-IMAGE] Celda no encontrada:",t);return}setTimeout(()=>{Ze(o)},0)},Qn=f.useCallback(t=>{var h,u,p,w;const n=at;Ye(!0);const o=Q==="images",l=q||((u=(h=m[x])==null?void 0:h.cells[0])==null?void 0:u.id);if(!l){console.error("‚ùå [ADD-FROM-GALLERY] No hay celda disponible"),re.error("No hay celda disponible para agregar la imagen"),Ye(n);return}if(!t||typeof t!="string"){console.error("‚ùå [ADD-FROM-GALLERY] URL de imagen inv√°lida"),re.error("URL de imagen no v√°lida"),Ye(n);return}const d=JSON.parse(JSON.stringify(m)),c={id:`image-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"image",content:t,position:{x:.1,y:.1},size:{width:.3,height:.3},filters:{brightness:100,contrast:100,saturation:100,tint:0,hue:0,blur:0,scale:1,rotate:0,opacity:100,blendMode:"normal"},mask:"none",zIndex:(((w=(p=d[x].cells.find(P=>P.id===l))==null?void 0:p.elements)==null?void 0:w.length)||0)+1};setTimeout(()=>{cr(l,c),setTimeout(()=>{o&&be("images"),setTimeout(()=>{Ye(n),re.success("‚úÖ Imagen a√±adida desde la galer√≠a")},50)},50)},50)},[Q,q,m,x,at,cr]),dr=f.useCallback(async(t,n)=>{var d,c;const o=[],l=[];for(const h of t){const u={...h};if(h.cells){u.cells=[];for(const p of h.cells){const w={...p};if(p.elements){w.elements=[];for(const P of p.elements)if(P.type==="image"&&((d=P.content)!=null&&d.startsWith("data:image/"))){const I=`${P.id}_${Date.now()}`,M=P.content.match(/^data:image\/([^;]+);base64,(.+)$/);if(M){const T=M[1],$=M[2],G=`${I}.${T==="jpeg"?"jpg":T}`;l.push({filename:G,data:$,type:T,elementId:P.id}),w.elements.push({...P,content:P.content,_wasBase64:!0,_originalSize:P.content.length,_elementId:P.id})}else w.elements.push(P)}else w.elements.push(P)}u.cells.push(w)}}o.push(u)}if(l.length>0)try{const h=await fetch(`/api/canvas/projects/${n}/upload-images`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((c=document.querySelector('meta[name="csrf-token"]'))==null?void 0:c.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({images:l})});if(h.ok){const u=await h.json();if(u.uploadedImages){const p=new Map;u.uploadedImages.forEach(w=>{p.set(w.elementId,w.url)});for(const w of o)if(w.cells){for(const P of w.cells)if(P.elements)for(const I of P.elements)I._wasBase64&&I._elementId&&p.has(I._elementId)&&(I.content=p.get(I._elementId),delete I._elementId)}}}else{const u=await h.json().catch(()=>({message:"Error desconocido en upload"}));return console.error("‚ùå [IMAGE-UPLOAD] Error subiendo im√°genes:",u),t}}catch(h){return console.error("‚ùå [IMAGE-UPLOAD] Error de red subiendo im√°genes:",h),t}return o},[]),Xe=f.useCallback(async(t=m,n=!1)=>{var o;if(!(!(r!=null&&r.id)||!n&&t.length===0))try{const c={design_data:{pages:await dr(t,r.id),currentPage:x,workspaceDimensions:B,workspaceSize:ce,selectedElement:U,selectedCell:q,history:Ae.slice(-5),historyIndex:Math.min(Te,4),timestamp:new Date().toISOString(),version:"2.0",project:{id:r.id,name:(a==null?void 0:a.name)||"√Ålbum Personalizado",item_id:a==null?void 0:a.id,preset_id:s==null?void 0:s.id}},thumbnails:te},u=JSON.stringify(c).length/(1024*1024),p=await fetch(`/api/canvas/projects/${r.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(c)});if(p.ok){const w=await p.json(),P=`editor_progress_project_${r.id}`;return localStorage.removeItem(P),L(I=>{const M=new Map(I);return n?M.clear():M.delete(x),M}),m&&m.length>0&&setTimeout(()=>{oe().catch(I=>{console.warn("‚ö†Ô∏è Error regenerando thumbnail de p√°gina actual:",I)})},300),!0}else{const w=await p.json().catch(()=>({message:"Error desconocido"}));return console.error("‚ùå [AUTO-SAVE] Error guardando en BD:",w),!1}}catch(l){return console.error("‚ùå [AUTO-SAVE] Error en auto-save con procesamiento de im√°genes:",l),!1}},[m,x,B,ce,r==null?void 0:r.id,a==null?void 0:a.name,a==null?void 0:a.id,s==null?void 0:s.id,dr,jt]);f.useEffect(()=>{if(!(r!=null&&r.id))return;const t=setInterval(()=>{m.length>0&&Xe(m,!1)},10*60*1e3);return()=>clearInterval(t)},[Xe,m,r==null?void 0:r.id]),f.useCallback(async()=>{if(!m.length)return{};const t={},n=x;try{for(let o=0;o<m.length;o++){const l=m[o];if(l!=null&&l.id)try{o!==x&&(se(o),await new Promise(c=>setTimeout(c,300)));const d=await Oe({type:"thumbnail"});d&&(t[l.id]=d)}catch(d){console.warn(`‚ö†Ô∏è [THUMBNAILS] Error capturando thumbnail para p√°gina ${l.id}:`,d),te[l.id]&&(t[l.id]=te[l.id])}}return n!==x&&se(n),t}catch(o){return console.error("‚ùå [THUMBNAILS] Error capturando thumbnails:",o),n!==x&&se(n),te}},[m,x,se,Oe,te]);const ur=f.useCallback(async()=>{if(!(r!=null&&r.id)||m.length===0)return re.error("No hay datos para guardar"),!1;try{return await oe(),await ar(),await Xe(m,!0)?(re.success("Progreso guardado exitosamente"),!0):(re.error("Error al guardar el progreso"),!1)}catch(t){return console.error("‚ùå [SAVE] Error al guardar el progreso:",t),re.error("Error al guardar el progreso"),!1}},[Xe,m,r==null?void 0:r.id,B,s,jt]),mr=f.useCallback(async t=>{var n;if(!(r!=null&&r.id))return Ke("‚ùå [QUEUE-SAVE] No hay project ID"),!1;if(!t||t.length===0)return Ke("‚ùå [QUEUE-SAVE] No hay p√°ginas para guardar"),!1;try{const l={design_data:{pages:t,currentPage:x,workspaceDimensions:B,timestamp:new Date().toISOString(),version:"2.0"},thumbnails:te};ft("üì§ [QUEUE-SAVE] Enviando petici√≥n al servidor...");const d=await fetch(`/api/canvas/projects/${r.id}/save-progress`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""},credentials:"include",body:JSON.stringify(l)});if(ft("üì• [QUEUE-SAVE] Respuesta del servidor:",d.status,d.statusText),d.ok){const c=await d.json();return ft("‚úÖ [QUEUE-SAVE] Guardado exitoso desde cola:",c),!0}else{const c=await d.text();return Ke("‚ùå [QUEUE-SAVE] Error en respuesta del servidor:",d.status,c),!1}}catch(o){return o("‚ùå [QUEUE-SAVE] Error guardando desde cola:",o),!1}},[r==null?void 0:r.id,x,B,te]),It=f.useCallback(async()=>{if(!D&&_.length!==0){R(!0);try{const t=_.slice();W([]);for(const n of t)await mr(n.pages)?L(l=>{const d=new Map(l);return d.delete(n.pageIndex),d}):(console.error("‚ùå [SAVE-QUEUE] Error guardando p√°gina:",n.pageIndex),W(l=>[...l,n]))}catch(t){console.error("‚ùå [SAVE-QUEUE] Error procesando cola:",t)}finally{R(!1)}}},[D,_,mr]);f.useEffect(()=>{_.length>0&&!D&&setTimeout(()=>{It()},100)},[_.length,D,It]),f.useEffect(()=>{},[_,D]);const gr=f.useCallback((t,n)=>{L(o=>(Array.from(o.keys()),o.has(t)&&W(l=>{const d=l.findIndex(c=>c.pageIndex===t);if(d!==-1){const c=[...l];return c[d]={pageIndex:t,pages:n,timestamp:Date.now()},c}else return[...l,{pageIndex:t,pages:n,timestamp:Date.now()}]}),o))},[]),Pt=f.useCallback(async t=>{t!==x&&(L(n=>{const o=Array.from(n.keys());return ft("üîç [PAGE-CHANGE] P√°ginas con cambios:",o.join(", ")||"ninguna"),n.has(x)&&gr(x,m),n}),se(t))},[x,m,gr]),qe=()=>`editor_progress_project_${r==null?void 0:r.id}`,pr=f.useCallback(async()=>{var n,o,l,d;if(!(!(r!=null&&r.id)||m.some(c=>{var h;return(h=c.cells)==null?void 0:h.some(u=>{var p;return((p=u.elements)==null?void 0:p.length)>0})})))try{const c=Pe.loadFromLocalStorage(),h=await fetch(`/api/canvas/projects/${r.id}/load-progress`,{headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});let u=null;if(h.ok){const w=await h.json();w.success&&((n=w.data)!=null&&n.design_data)&&(u=w.data)}let p=null;if(c&&u){const w=new Date(c.savedAt).getTime(),P=new Date(u.saved_at).getTime();p=w>P?c:u}else c?p=c:u&&(p=u);if(p&&(((o=p.pages)==null?void 0:o.length)>0||((d=(l=p.design_data)==null?void 0:l.pages)==null?void 0:d.length)>0)){const w=new Date(p.savedAt||p.saved_at).getTime();Date.now()-w<30*60*1e3&&(re.info("üîÑ Cargando progreso guardado autom√°ticamente..."),Yn(p))}}catch(c){console.error("‚ùå [RECOVERY] Error verificando progreso guardado:",c)}},[r==null?void 0:r.id,Pe,m]),Yn=f.useCallback(async t=>{var n;try{let o=[];if(t.pages?o=t.pages:(n=t.design_data)!=null&&n.pages&&(o=t.design_data.pages),o.length>0){ie(o);const l=[JSON.stringify(o)];De(l),ze(0),setTimeout(()=>{ne({})},100),re.success("‚úÖ Progreso cargado exitosamente"),qn(!1)}}catch(o){console.error("‚ùå [RECOVERY] Error cargando progreso:",o),re.error("Error al cargar el progreso guardado")}},[ie,De,ze,ne]);f.useCallback(async()=>{try{const t=Pe.getStorageKey();localStorage.removeItem(t),re.success("Progreso anterior eliminado")}catch(t){console.error("‚ùå [RECOVERY] Error descartando progreso:",t)}},[Pe]),f.useEffect(()=>{r&&a&&s&&(!(E!=null&&E.pages)||E.pages.length===0)&&hr(s,a)},[r,a,s,E]),f.useEffect(()=>{r!=null&&r.id&&!v&&m.length===0&&!at&&(Ye(!0),setTimeout(()=>{pr()},500))},[r==null?void 0:r.id,v,m.length,pr,at]),f.useEffect(()=>(ue.current&&clearTimeout(ue.current),r!=null&&r.id&&m.length>0&&(ue.current=setTimeout(()=>{ar()},500)),()=>{ue.current&&clearTimeout(ue.current)}),[r==null?void 0:r.id,m.length]);const hr=(t,n)=>{try{const o=[],l=n.pages||t.pages||20;if(n.has_cover_image===!0||n.has_cover_image===1){const h=n.cover_image?`/storage/images/item/${n.cover_image}`:null,u=n.cover_image?null:t.background_color||"#ffffff",p={id:"page-cover",type:"cover",layout:"layout-1",backgroundImage:h,backgroundColor:u,cells:[{id:"cell-cover-1",elements:[]}]};o.push(p)}const d=n.content_image?`/storage/images/item/${n.content_image}`:null,c=n.content_image?null:t.background_color||"#ffffff";for(let h=1;h<=l;h++){const u={id:`page-content-${h}`,type:"content",pageNumber:h,layout:"layout-1",backgroundImage:d,backgroundColor:c,cells:[{id:`cell-content-${h}-1`,elements:[]}]};o.push(u)}if(n.has_back_cover_image===!0||n.has_back_cover_image===1){const h=n.back_cover_image?`/storage/images/item/${n.back_cover_image}`:null,u=n.back_cover_image?null:t.background_color||"#ffffff",p={id:"page-final",type:"final",layout:"layout-1",backgroundImage:h,backgroundColor:u,cells:[{id:"cell-final-1",elements:[{id:"final-text",type:"text",content:" ",position:{x:30,y:45},size:{width:40,height:10},style:{fontSize:"20px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",textAlign:"center"},zIndex:1}]}]};o.push(p)}ie(o),se(0),t.width&&t.height&&We("preset")}catch(o){console.error("‚ùå Error creating pages:",o),F(o.message)}},fr=f.useCallback(t=>{var c,h;if(!t||t.length===0)return[];const n=t.filter(u=>u.type==="cover"),o=t.filter(u=>u.type==="content"),l=t.filter(u=>u.type==="final");if(n.length===0&&l.length===0)return t;const d=[];return n.length>0&&(d.push(...n),d.push({id:`blank-page-cover-back-${Date.now()}`,type:"blank",isBlankPage:!0,hasLogo:!0,logoUrl:"/assets/resources/logo.png",cells:[],backgroundColor:"#ffffff",layout:((c=ae[0])==null?void 0:c.id)||"layout1"})),o.length>0&&d.push(...o),l.length>0&&(d.length%2===1&&d.push({id:`blank-page-before-back-${Date.now()}`,type:"blank",isBlankPage:!0,cells:[],backgroundColor:"#ffffff",layout:((h=ae[0])==null?void 0:h.id)||"layout1"}),d.push(...l)),d},[ae]),de=f.useMemo(()=>a?{cover:m.filter(t=>t.type==="cover"&&(a.has_cover_image===!0||a.has_cover_image===1)),content:m.filter(t=>t.type==="content"),final:m.filter(t=>t.type==="final"&&(a.has_back_cover_image===!0||a.has_back_cover_image===1))}:{cover:m.filter(t=>t.type==="cover"),content:m.filter(t=>t.type==="content"),final:m.filter(t=>t.type==="final")},[m,a]),pe=f.useCallback(()=>{if(!a)return console.warn("‚ö†Ô∏è [CONTENT-TYPE] itemData no disponible, usando tipo por defecto"),{type:"album",name:"√Ålbum",description:"Vista de √Ålbum",icon:"üìñ",experience:"book"};const t=a.has_cover_image===!0||a.has_cover_image===1,n=a.has_back_cover_image===!0||a.has_back_cover_image===1,o=t&&de.cover.length>0,l=n&&de.final.length>0,d=de.content.length;return o&&l?{type:"album",name:"√Ålbum",description:"Vista de √Ålbum",icon:"üìñ",experience:"book"}:o||l?{type:"booklet",name:"Folleto",description:"Vista de Folleto",icon:"üìã",experience:"booklet"}:d>1?{type:"catalog",name:"Cat√°logo",description:"Vista de Cat√°logo",icon:"üìë",experience:"catalog"}:{type:"card",name:"Dise√±o",description:"Vista Previa",icon:"üé®",experience:"single"}},[de,a])(),X=f.useCallback(()=>{if(!U||!q||m.length===0)return null;const t=m[x];if(!t)return null;const n=t.cells.find(o=>o.id===q);return n?n.elements.find(o=>o.id===U):null},[U,q,m,x]),br=(t,n)=>{if(n){const o=m[x].cells.find(d=>d.id===n),l=o==null?void 0:o.elements.find(d=>d.id===t);if(l!=null&&l.locked){const d=document.createElement("div");d.className="fixed top-4 right-4 bg-amber-100 border border-amber-400 text-amber-700 px-4 py-2 rounded-lg z-50",d.textContent="Este elemento es parte del dise√±o base y no se puede editar",document.body.appendChild(d),setTimeout(()=>{document.body.contains(d)&&document.body.removeChild(d)},3e3);return}}if(n&&ge(n),Y(t),t){const o=m[x].cells.find(d=>d.id===(n||q)),l=o==null?void 0:o.elements.find(d=>d.id===t);(l==null?void 0:l.type)==="image"?Jt(l):(l==null?void 0:l.type)==="text"?(kt(!0),Vn({elementId:t,cellId:n||q}),Q!=="filters"&&Q!=="images"&&be("text")):kt(!1)}else kt(!1),Jt(null)},je=()=>{if(m.length===0)return ae[0];const t=m[x];if(!t)return ae[0];const n=ae.find(l=>l.id===t.layout)||ae[0],o=n.cellStyles&&Object.values(n.cellStyles).some(l=>l.includes("col-span-")||l.includes("row-span-"));return{...n,isComplex:o,pageId:t.id}},xr=f.useCallback(bt(t=>{try{const n=qe(),o={pages:t,currentPage:x,savedAt:Date.now()},l=JSON.stringify(o),d=Math.round(l.length/1024);d<2048?localStorage.setItem(n,l):(console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${d} KB)`),localStorage.removeItem(n))}catch(n){if(console.error("‚ùå Error guardando en localStorage:",n),n.name==="QuotaExceededError")try{localStorage.removeItem(qe())}catch(o){console.error("Error limpiando localStorage:",o)}}},300),[x,qe]),Ze=f.useCallback(t=>{ie(n=>{if(n===t)return n;const o=JSON.stringify(n),l=JSON.stringify(t);return o===l?n:(requestAnimationFrame(()=>{if(L(d=>{const c=new Map(d);return c.set(x,Date.now()),c}),t[x]){const d=t[x].id;ne(c=>{if(c[d]){const h={...c};return delete h[d],h}return c})}}),setTimeout(()=>{De(d=>{const c=[...d.slice(0,Te+1),l];return c.length>50?c.slice(-50):c}),ze(d=>{const c=d+1;return c>50?49:c})},0),t)}),xr(t)},[x,Te,xr]);f.useEffect(()=>{try{const t=qe(),n={pages:m,currentPage:x,savedAt:Date.now()},o=JSON.stringify(n),l=Math.round(o.length/1024);l<2048?localStorage.setItem(t,o):console.warn(`‚ö†Ô∏è Datos demasiado grandes para localStorage (${l} KB), saltando guardado`)}catch(t){if(console.error("‚ùå Error guardando currentPage en localStorage:",t),t.name==="QuotaExceededError")try{const n=qe();localStorage.removeItem(n)}catch(n){console.error("Error limpiando localStorage:",n)}}},[x,m,qe]);const Xn=t=>{const n=ae.find(c=>c.id===t);if(!n)return;const o=[...m],l=o[x],d=Array.from({length:n.cells}).map((c,h)=>l.cells[h]||{id:`cell-${l.id}-${h+1}`,elements:[]});o[x]={...l,layout:t,cells:d},Ze(o),Y(null),ge(null)},et=(t,n)=>{const o=[...m];for(let l=0;l<o[x].cells.length;l++)o[x].cells[l].id===t&&o[x].cells[l].elements.push(n);Ze(o),Y(n.id),ge(t)},wr=f.useCallback(bt(()=>{L(t=>{const n=new Map(t);return n.set(x,Date.now()),n})},100),[x]),le=f.useCallback((t,n,o,l=!1)=>{ie(d=>{const c=[...d],h=c[x].cells.findIndex(u=>u.id===t);if(h===-1)return d;if(l){const u=c[x].cells[h].elements.find(p=>p.id===n);if(!u)return d;c[x].cells[h].elements.push({...u,...o})}else{const u=c[x].cells[h].elements.findIndex(I=>I.id===n);if(u===-1)return d;const p=c[x].cells[h].elements[u];if(!Object.keys(o).some(I=>{const M=p[I],T=o[I];return typeof T=="object"&&typeof M=="object"?JSON.stringify(M)!==JSON.stringify(T):M!==T}))return d;const P={...p,...o};c[x].cells[h].elements[u]=P,(o.filters||o.mask)&&(window.FORCE_THUMBNAIL_REGENERATION&&(window.thumbnailCache={}),oe(!0).then(()=>{window.FORCE_THUMBNAIL_REGENERATION&&window.forceRegenerateThumbnail&&setTimeout(()=>{try{window.forceRegenerateThumbnail()}catch(I){console.error("‚ùå [FORZADO-EMERGENCIA] Error en regeneraci√≥n secundaria:",I)}},150)}).catch(I=>{console.error("‚ùå [AUTO-REGEN] Error regenerando thumbnail:",I)}))}return c}),o.position||o.size?requestAnimationFrame(()=>{L(d=>{if(d.has(x))return d;const c=new Map(d);return c.set(x,Date.now()),c})}):wr()},[x,wr]),Zn=f.useCallback(()=>{const t=je();return console.log("üß™ [TEST] Layout actual:",t),console.log("üß™ [TEST] Es complejo:",t.isComplex),console.log("üß™ [TEST] CellStyles:",t.cellStyles),oe(!0),`‚úÖ Test ejecutado para layout: ${t.id} (complejo: ${t.isComplex})`},[je,oe]);window.testComplexLayoutThumbnail=Zn,f.useCallback(()=>{var n;if(Le){Ke("üö´ [VPS-PROTECTION] forceRegenerateThumbnail bloqueado en servidor");return}window.thumbnailCache&&(window.thumbnailCache={}),window.THUMBNAIL_PROTECTED=!0,window._protectedThumbnailIds||(window._protectedThumbnailIds=[]);const t=(n=m[x])==null?void 0:n.id;t&&!window._protectedThumbnailIds.includes(t)&&window._protectedThumbnailIds.push(t),window.BLOCK_AUTO_REGENERATION=!0,oe(!0),setTimeout(()=>{window.BLOCK_AUTO_REGENERATION=!1},1e4)},[oe]),f.useCallback(()=>{U&&q&&le(q,U,{filters:{brightness:100,contrast:100,saturation:0,opacity:100}})},[U,q,le]),f.useCallback(()=>{window.THUMBNAIL_PROTECTED=!0,window.PERMANENT_THUMBNAIL_LOCK=!0,window.BLOCK_AUTO_REGENERATION=!1,window._protectedThumbnailIds=Object.keys(te);const t=window.forceRegenerateThumbnail;window.forceRegenerateThumbnail=(...n)=>window._userInitiated?(window._userInitiated=!1,t(...n)):!1,window._allowNextRegeneration=()=>{window._userInitiated=!0},window.safeRegenerateThumbnail=()=>{window._allowNextRegeneration(),window.forceRegenerateThumbnail()},window._thumbnailBackup={...te},alert(`üîí Miniaturas protegidas exitosamente!

Si necesitas regenerar una miniatura espec√≠fica, usa window.safeRegenerateThumbnail() en la consola.`)},[te]),f.useCallback(()=>{window.FORCE_FILTER_APPLICATION=!0,window.ENABLE_ADVANCED_FILTER_RENDERING=!0,window.thumbnailCache&&window.thumbnailCache.clear(),Ut&&Ut();const t=m[x];t&&t.cells&&t.cells.forEach(n=>{n.elements&&n.elements.forEach(o=>{o.filters&&(o._hasRealFilters=!0,o.pageId=t.id)})}),oe(!0)},[m,x,oe]);const it=(t,n)=>{const o=[...m],l=o[x].cells.findIndex(d=>d.id===t);l!==-1&&(o[x].cells[l].elements=o[x].cells[l].elements.filter(d=>d.id!==n),Ze(o),U===n&&Y(null))},eo=(t,n,o)=>{const l=[...m],d=l[x].cells.findIndex(c=>c.id===t);if(d!==-1){const c=l[x].cells[d].elements,h=c.findIndex(u=>u.id===n);if(h!==-1){const u=o==="up"?h+1:h-1;if(u>=0&&u<c.length){const p=c[h];c[h]=c[u],c[u]=p,Ze(l)}}}},to=()=>{Te>0&&(ze(Te-1),ie(JSON.parse(Ae[Te-1])),Y(null),ge(null))},ro=()=>{Te<Ae.length-1&&(ze(Te+1),ie(JSON.parse(Ae[Te+1])),Y(null),ge(null))},Ot=(t="body")=>{const n=`text-${Date.now()}`,o={heading:{fontSize:"32px",fontFamily:"Arial",color:"#000000",fontWeight:"bold",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"12px",borderRadius:"0px",border:"none",opacity:1},subheading:{fontSize:"24px",fontFamily:"Arial",color:"#333333",fontWeight:"600",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"10px",borderRadius:"0px",border:"none",opacity:1},body:{fontSize:"16px",fontFamily:"Arial",color:"#000000",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",textAlign:"left",backgroundColor:"transparent",padding:"8px",borderRadius:"0px",border:"none",opacity:1}},l={heading:"T√≠tulo Principal",subheading:"Subt√≠tulo",body:"Haz clic para editar"},d={heading:{width:.8,height:.2},subheading:{width:.6,height:.15},body:{width:.4,height:.15}},c={id:n,type:"text",content:l[t],position:{x:.05,y:.05},size:d[t],style:o[t]};q&&et(q,c)},vr=f.useMemo(()=>{var d;const t=m[x];if(!t)return null;const n=((d=t.cells)==null?void 0:d.flatMap(c=>c.elements||[]))||[],o=n.map(c=>({id:c.id,type:c.type,position:c.position,size:c.size}));return{pageId:t.id,elementsCount:n.length,contentHash:JSON.stringify(o).substring(0,100),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,layout:t.layout}},[m,x]);f.useEffect(()=>{var h;if(Le)return;const t=m[x];if(!t)return;const n=t.id;if(((h=t==null?void 0:t.cells)==null?void 0:h.some(u=>{var p;return(p=u.elements)==null?void 0:p.some(w=>w.filters&&(w.filters.brightness!==100||w.filters.contrast!==100||w.filters.saturation!==100||w.filters.tint!==0||w.filters.hue!==0))}))&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(n)||window._protectedThumbnailIds.push(n)),m.length===0||v||!vr)return;let l=!1;const d=async()=>{var u;if(!(window.PREVENT_THUMBNAIL_RESET||window.THUMBNAIL_PROTECTED))try{const p=m[x];if(!p||!p.id)return;const w=p.id;if(!window.PREVENT_THUMBNAIL_RESET&&!window.THUMBNAIL_PROTECTED&&ne(T=>{const $={...T};return delete $[w],$}),await new Promise(T=>setTimeout(T,100)),l)return;const P=(u=p==null?void 0:p.cells)==null?void 0:u.some(T=>{var $;return($=T.elements)==null?void 0:$.some(S=>S.filters&&(S.filters.brightness!==100||S.filters.contrast!==100||S.filters.saturation!==100||S.filters.tint!==0||S.filters.hue!==0))}),M=await Oe(P?{type:"thumbnail",preserveFilters:!0}:{type:"thumbnail"});M&&!l?(ne(T=>({...T,[w]:M})),P&&(window._protectedThumbnailIds||(window._protectedThumbnailIds=[]),window._protectedThumbnailIds.includes(w)||window._protectedThumbnailIds.push(w))):console.warn("‚ö†Ô∏è [DEBUG] No se pudo generar miniatura para:",w)}catch(p){l||console.error("‚ùå [DEBUG] Error regenerando miniatura:",p)}},c=setTimeout(()=>{d()},500);return()=>{l=!0,clearTimeout(c)}},[x,vr,v,Oe]),f.useEffect(()=>{if(window.BLOCK_AUTO_REGENERATION||m.length===0||v)return;const t=async()=>{if(window.BLOCK_AUTO_REGENERATION)return;const o=m.filter(l=>!te[l.id]);if(o.length!==0)for(const l of o)try{const d=document.createElement("canvas");d.width=200,d.height=150;const c=d.getContext("2d");if(c.fillStyle=l.backgroundColor||"#ffffff",c.fillRect(0,0,200,150),l.backgroundImage)try{const u=new Image;u.crossOrigin="anonymous",await new Promise((p,w)=>{u.onload=p,u.onerror=w,u.src=l.backgroundImage}),c.drawImage(u,0,0,200,150)}catch(u){console.warn("No se pudo cargar imagen de fondo para miniatura:",u)}l.cells&&l.cells.forEach(u=>{u.elements&&u.elements.forEach(p=>{var w;p.type==="text"&&p.content&&(c.fillStyle=((w=p.style)==null?void 0:w.color)||"#000000",c.font="12px Arial",c.fillText(p.content.substring(0,20)+(p.content.length>20?"...":""),10,30))})});const h=d.toDataURL("image/jpeg",.7);ne(u=>({...u,[l.id]:h})),await new Promise(u=>setTimeout(u,300))}catch(d){console.error("‚ùå Error generando miniatura de fondo para:",l.id,d)}},n=setTimeout(()=>{t()},2e3);return()=>clearTimeout(n)},[m,te,v]),f.useEffect(()=>{const t=n=>{const o=H.current,l=ee.current;if(o.length>0||l.size>0)return n.preventDefault(),n.returnValue="Hay cambios sin guardar. ¬øEst√°s seguro de que quieres salir?",n.returnValue};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[]),f.useEffect(()=>()=>{},[]);const no=async()=>{var t;try{if(!a||!s||!(r!=null&&r.id))return!1;await Xe(m,!0)||console.warn("‚ö†Ô∏è No se pudo guardar el progreso, pero continuando...");const o={design_data:{id:r.id,title:(a==null?void 0:a.name)||"√Ålbum Personalizado",pages:m,workspace_dimensions:B,created_at:new Date().toISOString()},item_data:{id:a==null?void 0:a.id,name:(a==null?void 0:a.name)||(a==null?void 0:a.title),price:a==null?void 0:a.price,user_id:a==null?void 0:a.user_id,width:a==null?void 0:a.width,height:a==null?void 0:a.height},preset_data:{id:s==null?void 0:s.id,width:s==null?void 0:s.width,height:s==null?void 0:s.height,cover_image:s==null?void 0:s.cover_image,content_layer_image:s==null?void 0:s.content_layer_image,final_layer_image:s==null?void 0:s.final_layer_image},dimensions:{width_mm:(s==null?void 0:s.width)||(a==null?void 0:a.width)||210,height_mm:(s==null?void 0:s.height)||(a==null?void 0:a.height)||297,workspace_width:(B==null?void 0:B.width)||800,workspace_height:(B==null?void 0:B.height)||600}};try{const P=await fetch("/api/canvas-projects/save",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},credentials:"include",body:JSON.stringify({id:r.id,status:"ready_for_pdf",pdf_data:o,completed_at:new Date().toISOString()})});if(P.ok){const I=await P.json()}else console.warn("‚ö†Ô∏è Error marcando proyecto como completado")}catch(P){console.warn("‚ö†Ô∏è Error en marcado de completado:",P)}const l=Date.now(),d=r.id;window.currentProjectId=d,window.albumProjectId=d;let c=s.cover_image;te&&te["page-cover"]&&(c=te["page-cover"]);let h=c;c&&c.startsWith("data:image/")&&c.length>1e5&&(h=s.cover_image||"/assets/img/default-album.jpg");const u={...a,project_id:d,canvas_project_id:r.id,quantity:1,type:"custom_album",pdf_metadata:{width_mm:s.width,height_mm:s.height,pages_count:m.length,workspace_dimensions:B,requires_pdf_generation:!0}},p=structuredClone(Se),w=p.findIndex(P=>P.id==u.id);return w==-1?p.push({...u,quantity:1}):p[w].quantity++,Me(p),re.success("√Ålbum agregado al carrito",{description:`${u.name} se ha a√±adido al carrito. El PDF se generar√° en el backend.`,icon:e.jsx(So,{className:"h-5 w-5 text-green-500"}),duration:4e3,position:"bottom-center"}),window.dispatchEvent(new CustomEvent("cartUpdated",{detail:{cart:p,action:"add",product:u}})),!0}catch(n){return console.error("‚ùå === ERROR EN addAlbumToCart ==="),console.error("Error completo:",n),console.error("Stack trace:",n.stack),console.error("Mensaje del error:",n.message),re.error("Error al agregar al carrito",{description:`Error espec√≠fico: ${n.message}`,duration:5e3,position:"bottom-center"}),!1}};window.finalizeAlbumDesign=async()=>{try{if(!m||m.length===0)throw new Error("No hay p√°ginas para finalizar");const o={design_data:{pages:(I=>I.map(M=>({id:M.id,type:M.type,pageNumber:M.pageNumber,layout:M.layout,cells:M.cells.map(T=>({id:T.id,elements:T.elements.map($=>{const S={id:$.id,type:$.type,position:$.position,zIndex:$.zIndex||1};if($.type==="image"){if($.content.startsWith("data:image/")){const G=btoa($.content.substring(0,100)).substring(0,20);S.content=`[BASE64_IMAGE_${G}]`,S.contentType=$.content.split(";")[0].split(":")[1],S.originalSize=$.content.length}else S.content=$.content;if($.filters){const G=Object.entries($.filters).filter(([O,K])=>K!==0&&K!==!1&&K!==null).reduce((O,[K,we])=>(O[K]=we,O),{});Object.keys(G).length>0&&(S.filters=G)}$.mask&&$.mask!=="none"&&(S.mask=$.mask),$.size&&(S.size=$.size),$.locked&&(S.locked=$.locked)}else if($.type==="text"&&(S.content=$.content,$.style)){const G=Object.entries($.style).filter(([O,K])=>!(O==="fontSize"&&K==="16px"||O==="color"&&K==="#000000"||O==="fontFamily"&&K==="Arial")).reduce((O,[K,we])=>(O[K]=we,O),{});Object.keys(G).length>0&&(S.style=G)}return S})}))})))(m),projectInfo:{id:r==null?void 0:r.id,item_id:a==null?void 0:a.id,title:a==null?void 0:a.title,preset_id:s==null?void 0:s.id},presetInfo:{id:s==null?void 0:s.id,name:s==null?void 0:s.name,cover_image:s==null?void 0:s.cover_image,content_image:s==null?void 0:s.content_image,back_cover_image:s==null?void 0:s.back_cover_image},workspace:{width:B.width,height:B.height,scale:B.scale},meta:{finalizedAt:new Date().toISOString(),version:"1.3"}},thumbnails:Object.fromEntries(Object.entries(te).map(([I,M])=>[I,M]))},l=JSON.stringify(o),d=Math.round(l.length/1024),c=Math.round(d/1024*100)/100;let h=0,u=0;m.forEach(I=>{var M;(M=I.cells)==null||M.forEach(T=>{var $;($=T.elements)==null||$.forEach(S=>{S.type==="image"&&S.content&&S.content.startsWith("data:image/")&&(h++,u+=S.content.length)})})});const p=Math.round(u/(1024*1024)*100)/100;if(d>1024&&!confirm(`El dise√±o contiene ${h} im√°genes (${p} MB en im√°genes). Payload completo: ${c} MB. Esto podr√≠a causar problemas al guardarlo. ¬øDesea continuar de todos modos?`))return!1;const w=await fetch(`/api/canvas/projects/${r.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:l});if(!w.ok){let I="Error al finalizar el dise√±o";try{I=(await w.json()).message||I}catch{w.status===413?I="El dise√±o es demasiado grande para ser guardado. Intente simplificar las im√°genes.":w.status>=500&&(I="Error del servidor. Intente nuevamente m√°s tarde.")}throw new Error(I)}const P=await w.json();return!0}catch(t){console.error("Error al finalizar dise√±o:",t);let n=t.message;return t.message.includes("Failed to fetch")?n="Error de conexi√≥n. Verifique su conexi√≥n a internet e intente nuevamente.":(t.message.includes("NetworkError")||t.message.includes("net::"))&&(n="Error de red. Intente nuevamente m√°s tarde."),alert("Error al finalizar el dise√±o: "+n),!1}};const oo=f.useCallback(async()=>{try{const{jsPDF:t}=await En(async()=>{const{jsPDF:G}=await import("./jspdf.es.min-D3plwuQr.js").then(O=>O.j);return{jsPDF:G}},__vite__mapDeps([0,1,2,3,4]));let n=(s==null?void 0:s.width)||21,o=(s==null?void 0:s.height)||29.7;const l=.3,d=n+l*2,c=o+l*2,h=d*28.35,u=c*28.35,p=new t({orientation:h>u?"landscape":"portrait",unit:"pt",format:[h,u],compress:!1}),w=m.length;let P=0;const I=document.createElement("div");I.id="pdf-progress",I.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",I.innerHTML=`
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Generando PDF de alta calidad...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="pdf-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="current-page">0</span> de ${w} p√°ginas procesadas
                    </p>
                </div>
            `,document.body.appendChild(I);const M=G=>{const O=G/w*100;document.getElementById("pdf-progress-bar").style.width=`${O}%`,document.getElementById("current-page").textContent=G},T=x;for(let G=0;G<m.length;G++){const O=m[G];se(G),await new Promise(K=>setTimeout(K,500));try{const K=await Oe({type:"pdf"});if(K){const we=K.width/K.height,Fe=h/u;let Re,ve,Z=0,ye=0;we>Fe?(Re=h,ve=h/we,ye=(u-ve)/2):(ve=u,Re=u*we,Z=(h-Re)/2);const fe=K.toDataURL("image/png",1);G>0&&p.addPage([h,u]),p.addImage(fe,"PNG",Z,ye,Re,ve)}else console.warn(`‚ö†Ô∏è No se pudo capturar la p√°gina ${G+1}`),G>0&&p.addPage([h,u]),p.setFontSize(12),p.text(`Error al renderizar p√°gina ${G+1}`,h/2,u/2,{align:"center"})}catch(K){console.error(`‚ùå Error procesando p√°gina ${G+1}:`,K),G>0&&p.addPage([h,u]),p.setFontSize(12),p.text(`Error al procesar p√°gina ${G+1}`,h/2,u/2,{align:"center"})}P++,M(P),await new Promise(K=>setTimeout(K,200))}se(T);const $=`${(a==null?void 0:a.name)||"album"}_${new Date().toISOString().split("T")[0]}.pdf`;p.save($),document.body.removeChild(I);const S=document.createElement("div");return S.className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg z-50",S.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>PDF de alta calidad generado: ${$}</span>
                </div>
            `,document.body.appendChild(S),setTimeout(()=>{document.body.contains(S)&&document.body.removeChild(S)},5e3),$}catch(t){console.error("‚ùå Error generando PDF:",t);const n=document.getElementById("pdf-progress");n&&document.body.removeChild(n);const o=document.createElement("div");throw o.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50",o.innerHTML=`
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Error al generar PDF: ${t.message}</span>
                </div>
            `,document.body.appendChild(o),setTimeout(()=>{document.body.contains(o)&&document.body.removeChild(o)},7e3),t}},[m,x,se,Oe,s,a]);return window.generateAlbumPDF=oo,window.generateHighQualityThumbnail=Gn,window.captureCurrentWorkspace=Oe,window.regenerateCurrentThumbnailNow=()=>{var n;const t=(n=m[x])==null?void 0:n.id;if(t){const o=m[x];let l=!1;o&&o.cells&&o.cells.forEach(d=>{d.elements&&d.elements.forEach(c=>{c.filters&&(c.filters.brightness!==100||c.filters.contrast!==100||c.filters.saturation!==100||c.filters.tint!==0||c.filters.hue!==0||c.filters.blur>0||c.filters.opacity!==100||c.filters.scale!==1||c.filters.rotate!==0||c.filters.flipHorizontal||c.filters.flipVertical)&&(l=!0,c._hasRealFilters=!0)})}),l&&(window.PRESERVE_FILTERS_FOR_PAGE=t,window.FORCE_FILTER_APPLICATION=!0),ne(d=>{const c={...d};return delete c[t],c})}return setTimeout(()=>{oe(!0),setTimeout(()=>{window.PRESERVE_FILTERS_FOR_PAGE=null},1e3)},100),"‚úÖ Miniatura regenerada con √©xito!"},window.generateThumbnailWithFilters=()=>{window.FORCE_FILTER_APPLICATION=!0;const t=Date.now();return window._filterCacheBreaker=t,window.regenerateCurrentThumbnailNow(),setTimeout(()=>{window.FORCE_FILTER_APPLICATION=!1},1e3),"‚úÖ Miniatura con filtros regenerada exitosamente"},window.forceRegenerateWithGuaranteedFilters=async()=>{var n,o;const t=m[x];if(!t||!B)return console.error("‚ùå [RADICAL] Datos no disponibles"),!1;try{window._filterVerificationDone&&window._filterVerificationDone.clear(),window._currentPageData=t,window._workspaceDimensions=B,window._updateThumbnailInUI=(d,c)=>{ne(h=>({...h,[d]:c}))};const l=await gt(t,B);return l?(((n=t.elements)==null?void 0:n.some(c=>c.filters?Object.keys(c.filters).some(h=>h==="flipHorizontal"||h==="flipVertical"?c.filters[h]:h==="brightness"||h==="contrast"||h==="saturation"||h==="opacity"||h==="scale"?c.filters[h]!==1:h==="tint"||h==="hue"||h==="blur"||h==="rotate"?c.filters[h]!==0:!1):!1))&&((o=window.protectThumbnail)==null||o.call(window,t.id)),ne(c=>({...c,[t.id]:l})),!0):!1}catch(l){return console.error("‚ùå [RADICAL] Error:",l),!1}},window.safeRegenerateThumbnail=()=>(window._filterVerificationDone&&window._filterVerificationDone.clear(),oe(!0),"‚úÖ Regeneraci√≥n segura completada"),e.jsxs(so,{backend:io,className:"!h-screen !w-screen overflow-hidden",children:[v?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Cargando Editor"}),e.jsx("p",{className:"customtext-neutral-dark",children:"Preparando tu √°lbum personalizado..."})]})}):A?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-600 mb-2",children:"Error"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:A}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700",children:"Reintentar"}),e.jsx("button",{onClick:()=>window.history.back(),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600",children:"Volver"})]})]})}):m.length===0?e.jsx("div",{className:"h-screen bg-gray-100 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg text-center max-w-md",children:[e.jsx("h2",{className:"text-xl font-semibold customtext-neutral-dark mb-2",children:"Inicializando Editor"}),e.jsx("p",{className:"customtext-neutral-dark mb-4",children:"Generando p√°ginas del √°lbum..."}),e.jsx("div",{className:"animate-pulse flex space-x-4",children:e.jsxs("div",{className:"flex-1 space-y-2 py-1",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-5/6"})]})]})})]})}):e.jsxs("div",{className:"h-screen w-screen overflow-hidden bg-[#141b34] font-sans",children:[e.jsx("style",{children:`
                        /* Solo aplicar overflow visible en modo edici√≥n (no en preview ni captura) */
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] {
                            overflow: visible !important;
                        }
                        
                        .editor-workspace:not(.preview-mode) [data-element-type="image"] > div {
                            overflow: visible !important;
                        }
                        
                        /* Mantener overflow hidden solo para el contenedor principal para evitar scroll */
                        .editor-workspace:not(.preview-mode) #page-${(Cr=m[x])==null?void 0:Cr.id} {
                            overflow: visible !important;
                        }
                        
                        /* En preview mode y captura, mantener overflow hidden para el resultado final */
                        .preview-mode [data-element-type="image"],
                        .capture-mode [data-element-type="image"] {
                            overflow: hidden !important;
                        }
                    `}),e.jsx(bo,{isOpen:Wn,onRequestClose:()=>{ir(!1),Dn({isLoading:!1,loadedImages:0,totalImages:0,message:""}),xe({isOpen:!1,phase:"preparing",progress:0,message:"",subMessage:""})},pages:(()=>{if(!a){console.warn("‚ö†Ô∏è [EDITOR-TO-MODAL] itemData no disponible, enviando todas las p√°ginas");const o=de.cover.concat(de.content,de.final).map(l=>({...l,layout:ae.find(d=>d.id===l.layout)||ae[0]}));return fr(o)}let t=[];(a.has_cover_image===!0||a.has_cover_image===1)&&(t=t.concat(de.cover)),t=t.concat(de.content),(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&(t=t.concat(de.final));const n=t.map(o=>({...o,layout:ae.find(l=>l.id===o.layout)||ae[0]}));return fr(n)})(),pageThumbnails:(()=>{if(!a)return console.warn("‚ö†Ô∏è [EDITOR-TO-MODAL] itemData no disponible para filtrar thumbnails"),te;const t={};let n=[];return(a.has_cover_image===!0||a.has_cover_image===1)&&(n=n.concat(de.cover.map(o=>o.id))),n=n.concat(de.content.map(o=>o.id)),(a.has_back_cover_image===!0||a.has_back_cover_image===1)&&(n=n.concat(de.final.map(o=>o.id))),n.forEach(o=>{te[o]&&(t[o]=te[o])}),t})(),workspaceDimensions:B,getCurrentLayout:t=>t?ae.find(n=>n.id===t.layout)||ae[0]:ae[0],presetData:s,addAlbumToCart:no,projectData:r,itemData:a,contentType:pe,categorizedPages:de,albumLoadingState:Kn}),Be.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] animate-in fade-in duration-500",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 min-w-96 max-w-96 mx-4 text-center relative overflow-hidden animate-in zoom-in duration-500",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 opacity-60"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-4 left-4 w-2 h-2 bg-purple-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0s"}}),e.jsx("div",{className:"absolute top-8 right-6 w-1 h-1 bg-blue-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-8 left-8 w-1.5 h-1.5 bg-pink-300 rounded-full animate-bounce opacity-60",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1 h-1 bg-purple-400 rounded-full animate-bounce opacity-60",style:{animationDelay:"1.5s"}})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-2xl relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full animate-ping opacity-20"}),e.jsx("div",{className:"absolute inset-2 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full animate-pulse"}),e.jsx("svg",{className:"w-12 h-12 text-white relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})]}),e.jsx("div",{className:"absolute inset-0 w-24 h-24 mx-auto",children:e.jsxs("svg",{className:"w-24 h-24 transform -rotate-90",viewBox:"0 0 96 96",children:[e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),e.jsx("circle",{cx:"48",cy:"48",r:"44",stroke:"url(#progressGradient)",strokeWidth:"4",fill:"none",strokeLinecap:"round",strokeDasharray:`${2*Math.PI*44}`,strokeDashoffset:`${2*Math.PI*44*(1-Be.progress/100)}`,style:{transition:"stroke-dashoffset 0.5s ease-in-out"}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"progressGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",style:{stopColor:"#8b5cf6",stopOpacity:1}}),e.jsx("stop",{offset:"100%",style:{stopColor:"#ec4899",stopOpacity:1}})]})})]})})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 animate-pulse",children:Be.message}),e.jsx("p",{className:"text-gray-600 mb-6 text-base leading-relaxed",children:Be.subMessage}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500 ease-out relative",style:{width:`${Be.progress}%`},children:[e.jsx("div",{className:"absolute inset-0 bg-white/30 animate-pulse rounded-full"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer"})]})}),e.jsxs("p",{className:"text-lg font-bold text-purple-600 mb-4",children:[Be.progress,"%"]})]}),e.jsx("style",{jsx:!0,children:`
                                    @keyframes shimmer {
                                        0% { transform: translateX(-100%) skewX(-12deg); }
                                        100% { transform: translateX(200%) skewX(-12deg); }
                                    }
                                    .animate-shimmer {
                                        animation: shimmer 2s infinite;
                                    }
                                `})]})}),e.jsx("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white shadow-lg flex items-center px-6 z-20 border-b border-gray-200",children:e.jsxs("div",{className:"w-full flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404]",children:[e.jsx(Eo,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:to,disabled:Te<=0,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(lo,{className:"h-4 w-4 text-[#040404]"})}),e.jsx("button",{onClick:ro,disabled:Te>=Ae.length-1,className:"p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(co,{className:"h-4 w-4 text-[#040404]"})})]})]}),e.jsx("div",{className:"flex-1 max-w-md mx-8",children:e.jsx("input",{type:"text",value:(r==null?void 0:r.name)||"√Ålbum Sin T√≠tulo",onChange:t=>i({...r,name:t.target.value}),className:"w-full text-center text-lg font-bold text-[#040404] bg-transparent border-0 focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:bg-white rounded-lg px-4 py-2 transition-all",placeholder:"Nombre del dise√±o"})}),e.jsxs("div",{id:"toolbar-actions",className:"flex items-center gap-4",children:[(_.length>0||D)&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600 bg-blue-50 px-3 py-1.5 rounded-lg",children:D?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"}),e.jsx("span",{children:"Guardando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-2 w-2 bg-blue-600 rounded-full"}),e.jsxs("span",{children:["Cola: ",_.length]})]})}),e.jsx(fa,{saveStatus:Pe.saveStatus,lastSaved:Pe.lastSaved,lastAutoSaved:Pe.lastAutoSaved,hasUnsavedChanges:j.hasUnsavedChanges||!!(N instanceof Map&&N.has(x)),isOnline:Pe.isOnline,saveError:Pe.saveError,onManualSave:ur,saveQueueSize:_.length,isProcessingQueue:D,pageChangesCount:N instanceof Map?N.size:0}),_.length>0&&e.jsxs("button",{onClick:()=>{It()},className:"flex items-center gap-2 text-xs text-white bg-orange-500 hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors",children:[e.jsx(Tn,{className:"h-3 w-3"}),"Procesar Cola"]}),e.jsx(mt,{id:"preview-button",variant:"secondary",size:"sm",onClick:async t=>{t.preventDefault(),t.stopPropagation();try{xe({isOpen:!0,phase:"saving",progress:0,message:"üíæ Guardando cambios",subMessage:"Asegurando que todo est√© actualizado..."});try{await ur(),xe(u=>({...u,progress:15,message:"‚úÖ Cambios guardados",subMessage:"Preparando vista previa..."})),await new Promise(u=>setTimeout(u,500))}catch(u){console.error("‚ùå [AUTO-SAVE] Error al guardar:",u),xe(p=>({...p,progress:10,message:"‚ö†Ô∏è Guardado parcial",subMessage:"Continuando con vista previa..."})),await new Promise(p=>setTimeout(p,300))}xe(u=>({...u,phase:"preparing",progress:15,message:`${pe.icon} Creando tu ${pe.name.toLowerCase()}`,subMessage:pe.type==="album"?"Preparando la experiencia completa de tu √°lbum...":pe.type==="catalog"?"Organizando tu cat√°logo de contenido...":pe.type==="booklet"?"Preparando tu folleto personalizado...":"Optimizando tu dise√±o √∫nico..."}));const n=pe.type==="album"?["üîß Encuadernando p√°ginas","üìñ Ajustando tapas","‚ú® Puliendo detalles"]:pe.type==="catalog"?["üìë Organizando contenido","üé® Optimizando dise√±o","‚ö° Finalizando cat√°logo"]:pe.type==="booklet"?["üìã Preparando folleto","üñºÔ∏è Ajustando formato","‚ú® Aplicando estilo"]:["üé® Procesando dise√±o","‚ö° Optimizando calidad","‚ú® Finalizando vista"];for(let u=15;u<=30;u+=3){await new Promise(w=>setTimeout(w,pe.type==="card"?50:100));const p=Math.floor((u-15)/15*n.length);xe(w=>({...w,progress:u,message:n[Math.min(p,n.length-1)],subMessage:`Progreso: ${u}% - Optimizando para mejor experiencia...`}))}xe(u=>({...u,phase:"processing",message:`üì∑ Procesando ${pe.name.toLowerCase()}`,subMessage:"Generando vistas de alta calidad..."}));const o=await Fn((u,p)=>{const w=30+u/p*50;xe(P=>({...P,progress:Math.round(w),subMessage:`Procesando imagen ${u} de ${p}...`}))}),d={album:{message:"üìñ Encuadernando √°lbum",sub:"Creando experiencia premium de lectura..."},catalog:{message:"üìë Organizando cat√°logo",sub:"Preparando navegaci√≥n fluida..."},booklet:{message:"üìã Finalizando folleto",sub:"Ajustando formato profesional..."},card:{message:"üé® Puliendo dise√±o",sub:"Aplicando toques finales..."}}[pe.type];xe(u=>({...u,phase:"finalizing",message:d.message,subMessage:d.sub}));for(let u=80;u<=100;u+=4)await new Promise(p=>setTimeout(p,pe.type==="card"?40:80)),xe(p=>({...p,progress:u}));const h={album:{message:"üìñ ¬°Tu √°lbum est√° listo!",sub:"Experiencia completa de lectura preparada"},catalog:{message:"üìë ¬°Tu cat√°logo est√° listo!",sub:"Navegaci√≥n profesional activada"},booklet:{message:"üìã ¬°Tu folleto est√° listo!",sub:"Formato profesional completado"},card:{message:"üé® ¬°Tu dise√±o est√° listo!",sub:"Vista previa perfecta creada"}}[pe.type];xe(u=>({...u,phase:"ready",progress:100,message:h.message,subMessage:h.sub})),await new Promise(u=>setTimeout(u,1e3)),xe(u=>({...u,isOpen:!1})),ne(u=>({...u,...o})),setTimeout(()=>{ir(!0)},300)}catch(n){console.error(`‚ùå [${pe.type.toUpperCase()}-EXPERIENCE] Error en experiencia:`,n),xe(o=>({...o,message:"‚ö†Ô∏è Ups, algo sali√≥ mal",subMessage:"Intentando nuevamente...",progress:0})),setTimeout(()=>{xe(o=>({...o,isOpen:!1}))},2e3)}},disabled:Be.isOpen,icon:e.jsx(xt,{className:"h-4 w-4"}),children:Be.isOpen?`Creando ${pe.name.toLowerCase()}...`:pe.description}),e.jsxs("button",{onClick:Un,className:"flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-[#040404] border border-gray-200",title:"Inicia la gu√≠a paso a paso",children:[e.jsx(Ao,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Ayuda"})]})]})]})}),e.jsxs("div",{className:`flex h-full ${U?"pt-[60px]":"pt-16"}`,children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-20 bg-[#f7edfa] border-r border-gray-200 flex flex-col items-center py-6 space-y-2",children:[e.jsxs("button",{"data-tab":"pages",onClick:()=>be("pages"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="pages"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(xt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"P√°ginas"})]}),e.jsxs("button",{"data-tab":"templates",onClick:()=>be("templates"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="templates"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Bt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Dise√±os"})]}),e.jsxs("button",{"data-tab":"panel",onClick:()=>be("panel"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="panel"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(vt,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Capas"})]}),e.jsxs("button",{"data-tab":"text",onClick:()=>be("text"),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all w-16 h-16 ${Q==="text"?"bg-[#af5cb8] text-white shadow-md":"text-[#040404] hover:bg-white hover:shadow-sm"}`,children:[e.jsx(Cn,{className:"h-6 w-6"}),e.jsx("span",{className:"text-xs font-medium",children:"Textos"})]})]}),e.jsxs("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-[#040404] capitalize",children:[Q==="templates"&&"Templates",Q==="images"&&"Images",Q==="text"&&"Text",Q==="shapes"&&"Shapes",Q==="stickers"&&"Stickers",Q==="pages"&&"Pages",Q==="panel"&&"Layers Panel",Q==="filters"&&"Filtros"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Q==="templates"&&"Choose a template to get started",Q==="images"&&"Search for images",Q==="text"&&"Add and edit text",Q==="shapes"&&"Add shapes and graphics",Q==="stickers"&&"Add fun stickers",Q==="pages"&&"Manage your pages",Q==="panel"&&"Organize layers and z-index",Q==="filters"&&"Aplicar efectos y filtros a elementos"]})]}),e.jsx("button",{className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(Io,{className:"h-4 w-4 text-gray-500"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[Q==="templates"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Bt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Page Layouts"})]}),e.jsx(Ho,{currentLayoutId:(Nr=m[x])==null?void 0:Nr.layout,onLayoutChange:Xn})]}),Q==="images"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ge,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Im√°genes del Proyecto"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[_e.length," imagen",_e.length!==1?"s":""]})]}),e.jsx(ya,{images:_e,onImageSelect:Qn,isLoading:Nt})]}),Q==="text"&&e.jsxs("div",{id:"elements-panel",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>Ot("heading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-gray-900 text-2xl leading-tight",children:"T√≠tulo Principal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"32px, Bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(wt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Ot("subheading"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-800 text-lg leading-tight",children:"Subt√≠tulo"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"24px, Semi-bold"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(wt,{className:"h-4 w-4"})})]})}),e.jsx("button",{onClick:()=>Ot("body"),className:"w-full p-3 bg-white border border-gray-200 rounded-lg hover:border-[#af5cb8] hover:bg-gray-50 transition-all duration-200 text-left group",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-normal text-gray-900 text-base leading-tight",children:"Texto Normal"}),e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:"16px, Normal"})]}),e.jsx("div",{className:"text-gray-400 group-hover:text-[#af5cb8] transition-colors",children:e.jsx(wt,{className:"h-4 w-4"})})]})})]}),Q==="text"&&U&&((Sr=X())==null?void 0:Sr.type)==="text"&&e.jsxs("div",{className:"mt-6 p-4 bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"h-10 w-10 bg-[#af5cb8] rounded-xl flex items-center justify-center",children:e.jsx(Oo,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-[#040404] text-lg",children:"Editar Texto"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Personaliza el formato y estilo"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 mr-2",children:"Formato:"}),e.jsx("button",{onClick:()=>{const t=X();le(q,U,{style:{...t.style,fontWeight:t.style.fontWeight==="bold"?"normal":"bold"}})},className:`px-3 py-1.5 rounded-md text-sm font-bold transition-colors ${((jr=(Tr=X())==null?void 0:Tr.style)==null?void 0:jr.fontWeight)==="bold"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"B"}),e.jsx("button",{onClick:()=>{const t=X();le(q,U,{style:{...t.style,fontStyle:t.style.fontStyle==="italic"?"normal":"italic"}})},className:`px-3 py-1.5 rounded-md text-sm italic transition-colors ${((Ar=(kr=X())==null?void 0:kr.style)==null?void 0:Ar.fontStyle)==="italic"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"I"}),e.jsx("button",{onClick:()=>{const t=X();le(q,U,{style:{...t.style,textDecoration:t.style.textDecoration==="underline"?"none":"underline"}})},className:`px-3 py-1.5 rounded-md text-sm underline transition-colors ${((Ir=(_r=X())==null?void 0:_r.style)==null?void 0:Ir.textDecoration)==="underline"?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:"U"})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tipograf√≠a:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Or=(Pr=X())==null?void 0:Pr.style)==null?void 0:Or.fontFamily)||"Arial",onChange:t=>{const n=X();le(q,U,{style:{...n.style,fontFamily:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Impact",children:"Impact"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Trebuchet MS",children:"Trebuchet MS"}),e.jsx("option",{value:"Tahoma",children:"Tahoma"}),e.jsx("option",{value:"Palatino",children:"Palatino"}),e.jsx("option",{value:"Garamond",children:"Garamond"}),e.jsx("option",{value:"Bookman",children:"Bookman"}),e.jsx("option",{value:"Avant Garde",children:"Avant Garde"}),e.jsx("option",{value:"Calibri",children:"Calibri"}),e.jsx("option",{value:"Cambria",children:"Cambria"}),e.jsx("option",{value:"Candara",children:"Candara"}),e.jsx("option",{value:"Century Gothic",children:"Century Gothic"}),e.jsx("option",{value:"Franklin Gothic",children:"Franklin Gothic"}),e.jsx("option",{value:"Futura",children:"Futura"}),e.jsx("option",{value:"Gill Sans",children:"Gill Sans"}),e.jsx("option",{value:"Lucida Grande",children:"Lucida Grande"}),e.jsx("option",{value:"Optima",children:"Optima"}),e.jsx("option",{value:"Segoe UI",children:"Segoe UI"}),e.jsx("option",{value:"Roboto",children:"Roboto"}),e.jsx("option",{value:"Open Sans",children:"Open Sans"}),e.jsx("option",{value:"Lato",children:"Lato"}),e.jsx("option",{value:"Montserrat",children:"Montserrat"}),e.jsx("option",{value:"Poppins",children:"Poppins"}),e.jsx("option",{value:"Nunito",children:"Nunito"}),e.jsx("option",{value:"Inter",children:"Inter"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Tama√±o:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Lr=(Rr=X())==null?void 0:Rr.style)==null?void 0:Lr.fontSize)||"16px",onChange:t=>{const n=X();le(q,U,{style:{...n.style,fontSize:t.target.value}})},className:"w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"8px",children:"8px"}),e.jsx("option",{value:"10px",children:"10px"}),e.jsx("option",{value:"12px",children:"12px"}),e.jsx("option",{value:"14px",children:"14px"}),e.jsx("option",{value:"16px",children:"16px"}),e.jsx("option",{value:"18px",children:"18px"}),e.jsx("option",{value:"20px",children:"20px"}),e.jsx("option",{value:"22px",children:"22px"}),e.jsx("option",{value:"24px",children:"24px"}),e.jsx("option",{value:"28px",children:"28px"}),e.jsx("option",{value:"32px",children:"32px"}),e.jsx("option",{value:"36px",children:"36px"}),e.jsx("option",{value:"40px",children:"40px"}),e.jsx("option",{value:"44px",children:"44px"}),e.jsx("option",{value:"48px",children:"48px"}),e.jsx("option",{value:"56px",children:"56px"}),e.jsx("option",{value:"64px",children:"64px"}),e.jsx("option",{value:"72px",children:"72px"}),e.jsx("option",{value:"80px",children:"80px"}),e.jsx("option",{value:"96px",children:"96px"})]}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Color:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:(($r=(Mr=X())==null?void 0:Mr.style)==null?void 0:$r.color)||"#000000",onChange:t=>{const n=X();le(q,U,{style:{...n.style,color:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("span",{className:"text-xs text-gray-600 font-mono",children:((zr=(Br=X())==null?void 0:Br.style)==null?void 0:zr.color)||"#000000"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Fondo:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"color",value:((Fr=(Ur=X())==null?void 0:Ur.style)==null?void 0:Fr.backgroundColor)||"#ffffff",onChange:t=>{const n=X();le(q,U,{style:{...n.style,backgroundColor:t.target.value}})},className:"w-10 h-10 border border-gray-300 rounded-lg cursor-pointer hover:border-[#af5cb8] transition-colors"}),e.jsx("button",{onClick:()=>{const t=X();le(q,U,{style:{...t.style,backgroundColor:"transparent"}})},className:"px-2 py-1 text-xs bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors",children:"üö´"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 w-20",children:"Alinear:"}),e.jsx("div",{className:"flex gap-1",children:["left","center","right","justify"].map(t=>{var n,o;return e.jsxs("button",{onClick:()=>{const l=X();le(q,U,{style:{...l.style,textAlign:t}})},className:`px-3 py-1.5 rounded-md text-sm transition-colors ${((o=(n=X())==null?void 0:n.style)==null?void 0:o.textAlign)===t?"bg-[#af5cb8] text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,children:[t==="left"&&"‚¨Ö",t==="center"&&"‚¨å",t==="right"&&"‚û°",t==="justify"&&"‚¨ç"]},t)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Espaciado:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Gr=(Hr=X())==null?void 0:Hr.style)==null?void 0:Gr.lineHeight)||"1.5",onChange:t=>{const n=X();le(q,U,{style:{...n.style,lineHeight:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"1",children:"1.0"}),e.jsx("option",{value:"1.1",children:"1.1"}),e.jsx("option",{value:"1.2",children:"1.2"}),e.jsx("option",{value:"1.3",children:"1.3"}),e.jsx("option",{value:"1.4",children:"1.4"}),e.jsx("option",{value:"1.5",children:"1.5"}),e.jsx("option",{value:"1.6",children:"1.6"}),e.jsx("option",{value:"1.8",children:"1.8"}),e.jsx("option",{value:"2",children:"2.0"}),e.jsx("option",{value:"2.2",children:"2.2"}),e.jsx("option",{value:"2.5",children:"2.5"}),e.jsx("option",{value:"3",children:"3.0"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Letras:"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:((Wr=(Vr=X())==null?void 0:Vr.style)==null?void 0:Wr.letterSpacing)||"normal",onChange:t=>{const n=X();le(q,U,{style:{...n.style,letterSpacing:t.target.value}})},className:"w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#af5cb8] focus:border-transparent appearance-none cursor-pointer hover:border-[#af5cb8] transition-colors",children:[e.jsx("option",{value:"-3px",children:"-3px"}),e.jsx("option",{value:"-2px",children:"-2px"}),e.jsx("option",{value:"-1px",children:"-1px"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"0.5px",children:"0.5px"}),e.jsx("option",{value:"1px",children:"1px"}),e.jsx("option",{value:"1.5px",children:"1.5px"}),e.jsx("option",{value:"2px",children:"2px"}),e.jsx("option",{value:"3px",children:"3px"}),e.jsx("option",{value:"4px",children:"4px"}),e.jsx("option",{value:"5px",children:"5px"})]}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsx("svg",{className:"w-3 h-3 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Efectos:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{const t=X();le(q,U,{style:{...t.style,textTransform:t.style.textTransform==="uppercase"?"none":"uppercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Kr=(qr=X())==null?void 0:qr.style)==null?void 0:Kr.textTransform)==="uppercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-black",children:"AA"}),"MAY√öS"]}),e.jsxs("button",{onClick:()=>{const t=X();le(q,U,{style:{...t.style,textTransform:t.style.textTransform==="lowercase"?"none":"lowercase"}})},className:`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${((Jr=(Dr=X())==null?void 0:Dr.style)==null?void 0:Jr.textTransform)==="lowercase"?"bg-[#af5cb8] text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-[#af5cb8]"}`,children:[e.jsx("span",{className:"text-xs font-normal",children:"aa"}),"min√∫s"]})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Opacidad:"}),e.jsxs("span",{className:"text-sm font-bold text-[#af5cb8]",children:[Math.round((((Yr=(Qr=X())==null?void 0:Qr.style)==null?void 0:Yr.opacity)||1)*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:((Zr=(Xr=X())==null?void 0:Xr.style)==null?void 0:Zr.opacity)||"1",onChange:t=>{const n=X();le(q,U,{style:{...n.style,opacity:t.target.value}})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#af5cb8] slider",style:{background:`linear-gradient(to right, #af5cb8 0%, #af5cb8 ${(((tn=(en=X())==null?void 0:en.style)==null?void 0:tn.opacity)||1)*100}%, #e5e7eb ${(((nn=(rn=X())==null?void 0:rn.style)==null?void 0:nn.opacity)||1)*100}%, #e5e7eb 100%)`}})]})]})]})]}),Q==="pages"&&e.jsxs("div",{id:"pages-panel",className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Pages"}),e.jsxs("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:[m.length," total"]})]})}),Qe&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Generando thumbnail..."}),e.jsxs("span",{className:"text-xs text-blue-600",children:[Qe.percentage,"%"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${Qe.percentage}%`}})}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:Qe.message||`P√°gina: ${Qe.pageId||"actual"}`})]}),m.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cargando p√°ginas..."})]})}):e.jsxs("div",{className:"space-y-4",children:[de.cover.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 mr-1.5"}),"Cover"]}),de.cover.map((t,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===m.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Pt(m.indexOf(t)),children:e.jsxs("div",{className:"relative bg-purple-50 overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Ht,{pageId:t.id,thumbnail:te[t.id],altText:"Cover",type:"cover"}),N instanceof Map&&N.has&&N.has(m.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Cover"})})]})},t.id))]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400 mr-1.5"}),"Content Pages"]}),e.jsx("div",{className:"space-y-2",children:de.content.map((t,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===m.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-1`,onClick:()=>Pt(m.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border aspect-[4/3] rounded-lg",children:[e.jsx(Ht,{pageId:t.id,thumbnail:te[t.id],altText:`Page ${t.pageNumber}`,type:"content"}),e.jsx("div",{className:"absolute top-1 left-1 bg-white/90 rounded-full h-5 w-5 flex items-center justify-center text-[10px] font-bold shadow-sm",children:t.pageNumber}),N instanceof Map&&N.has&&N.has(m.indexOf(t))?e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"Sin guardar"}):e.jsx("div",{className:"absolute top-1 right-1 bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full opacity-80 group-hover:opacity-100",children:"Editable"})]})},t.id))})]}),de.final.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-gray-500 mb-2 flex items-center",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"}),"Back Cover"]}),de.final.map((t,n)=>e.jsx("div",{className:`relative group flex flex-col cursor-pointer transition-all duration-200 transform 
                                                                    ${x===m.indexOf(t)?"ring-2 ring-purple-400 scale-[1.02] shadow-md":"hover:bg-gray-50 border border-transparent hover:border-gray-200"}
                                                                    mb-2`,onClick:()=>Pt(m.indexOf(t)),children:e.jsxs("div",{className:"relative overflow-hidden border mb-1 aspect-[4/3] rounded-lg",children:[e.jsx(Ht,{pageId:t.id,thumbnail:te[t.id],altText:"Back Cover",type:"final"}),N instanceof Map&&N.has&&N.has(m.indexOf(t))&&e.jsx("div",{className:"absolute top-1 right-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full shadow-sm",children:"‚Ä¢"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6 group-hover:opacity-100 opacity-80 transition-opacity",children:e.jsx("span",{className:"text-[10px] text-white font-medium block",children:"Back Cover"})})]})},t.id))]})]})]}),Q==="panel"&&e.jsx("div",{className:"space-y-4",children:e.jsx(Fo,{pages:m,currentPage:x,selectedCell:q,selectedElement:U,onSelectCell:ge,onSelectElement:Y,onUpdateElement:(t,n,o)=>{le(t,n,o)},onDeleteElement:(t,n)=>{it(t,n)},onMoveElement:(t,n,o)=>{eo(t,n,o)}})}),Q==="filters"&&e.jsxs("div",{id:"properties-panel",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Co,{className:"h-5 w-5 text-[#af5cb8]"}),e.jsx("h3",{className:"font-semibold text-[#040404]",children:"Filters"})]}),(()=>{const t=X();return t&&t.type==="image"?e.jsxs(e.Fragment,{children:[t.type==="image"&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ge,{className:"h-4 w-4 text-[#af5cb8]"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected Image"})]}),e.jsx("div",{className:"w-full h-16 rounded-md overflow-hidden bg-gray-200",children:e.jsx("img",{src:t.content,alt:"",className:"w-full h-full object-cover"})})]}),t.type==="image"&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Masks"}),e.jsx(Go,{selectedMask:t.mask||"none",onSelect:n=>{le(q,U,{mask:n})},availableMasks:Nn.map(n=>n.id),selectedImage:t})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("h4",{className:"font-medium text-[#040404] mb-3",children:"Filters & Effects"}),e.jsx(uo,{filters:t.filters||{},onFilterChange:n=>{le(q,U,{filters:n}),setTimeout(()=>{oe(!0)},50),setTimeout(()=>{oe(!0)},200),setTimeout(()=>{oe(!0)},500)},selectedElement:t})]})]}):e.jsxs("div",{className:"text-center py-8 px-4 bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-lg mb-3 inline-block",children:e.jsx(Ge,{className:"h-6 w-6 text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-[#040404] mb-2",children:"Select an image to apply filters"}),e.jsx("p",{className:"text-xs text-gray-600",children:X()?"Filters are only available for image elements":"Click on an image element in your canvas to access filters and effects"})]})})()]})]})]})]}),e.jsxs("main",{className:"flex-1 flex flex-col h-full",children:[e.jsx("div",{id:"quick-actions-bar",className:"bg-white border-b px-4 py-2 flex items-center justify-between",children:e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>be("templates"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(Bt,{className:"h-4 w-4"}),"Dise√±o de p√°gina"]}),e.jsxs("button",{onClick:()=>be("panel"),className:"bg-white/90 hover:bg-white text-gray-700 px-3 py-1.5 rounded-lg shadow-md text-sm font-medium flex items-center gap-1.5 transition-all duration-200 hover:shadow-lg",children:[e.jsx(vt,{className:"h-4 w-4"}),"Superponer objetos"]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-2"}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(mt,{variant:"ghost",tooltip:"A√±adir Imagen",onClick:()=>At.current&&At.current.click(),children:e.jsx(Ge,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:At,onChange:Jn,className:"hidden",accept:"image/*"})]}),U&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx(mt,{variant:"ghost",size:"sm",onClick:()=>{if(U&&q){const t=X();if(t){const n={...t,id:`${t.type}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,position:{x:t.position.x+.05,y:t.position.y+.05}};et(q,n)}}},className:"h-8 px-2",icon:e.jsx(No,{className:"h-4 w-4"}),children:"Duplicar"}),e.jsx(mt,{variant:"ghost",size:"sm",onClick:()=>{U&&q&&it(q,U)},className:"h-8 px-2 text-red-600 hover:text-white",icon:e.jsx(Sn,{className:"h-4 w-4"}),children:"Eliminar"})]})]})})}),e.jsx("div",{id:"editor-workspace",className:`editor-workspace flex-1 relative flex items-center justify-center p-6 overflow-hidden bg-gray-100 ${Dt?"preview-mode":""}`,children:Dt?e.jsx("div",{className:"bg-white rounded-lg shadow-lg",children:e.jsx("div",{className:"overflow-hidden",style:{width:B.width,height:B.height},children:e.jsx("div",{id:`page-${m[x].id}`,className:`grid ${je().template} gap-6`,style:{width:"100%",height:"100%"},children:m[x].cells.map((t,n)=>{var d;const o=je(),l=va(o,n,B);return e.jsx(un,{id:t.id,elements:t.elements.filter(c=>!c.locked),workspaceSize:l,cellStyle:(d=je().cellStyles)==null?void 0:d[m[x].cells.indexOf(t)],selectedElement:q===t.id?U:null,onSelectElement:br,onAddElement:(c,h)=>et(h,c),onUpdateElement:(c,h,u)=>le(t.id,c,h,u),onDeleteElement:c=>it(t.id,c),availableMasks:je().maskCategories.flatMap(c=>c.masks),projectData:r},t.id)})})})}):e.jsxs("div",{id:`page-${m[x].id}`,className:" shadow-xl overflow-hidden",style:{width:B.width,height:B.height,position:"relative",backgroundColor:((on=m[x])==null?void 0:on.backgroundColor)||"#ffffff",backgroundImage:(an=m[x])!=null&&an.backgroundImage?`url(${m[x].backgroundImage})`:"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[(()=>{const t=m[x];return t!=null&&t.backgroundImage?e.jsx("img",{src:t.backgroundImage,alt:"background",className:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{zIndex:1}}):t!=null&&t.backgroundColor?e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{backgroundColor:t.backgroundColor,zIndex:1}}):null})(),e.jsx("div",{className:`grid ${je().template}`,style:{position:"relative",zIndex:10,width:"100%",height:"100%",boxSizing:"border-box",gap:((sn=je().style)==null?void 0:sn.gap)||"16px",padding:((ln=je().style)==null?void 0:ln.padding)||"16px"},children:m[x].cells.map(t=>{var n;return e.jsx(un,{id:t.id,elements:t.elements.filter(o=>!o.locked),workspaceSize:B,cellStyle:(n=je().cellStyles)==null?void 0:n[m[x].cells.indexOf(t)],selectedElement:q===t.id?U:null,onSelectElement:br,onAddElement:(o,l)=>et(l,o),onUpdateElement:(o,l,d)=>le(t.id,o,l,d),onDeleteElement:o=>it(t.id,o),availableMasks:je().maskCategories.flatMap(o=>o.masks),projectData:r},t.id)})})]})})]})]})]}),e.jsx(fo,{})]})}export{Ts as default};
